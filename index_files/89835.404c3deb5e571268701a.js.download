(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[89835],{220350:e=>{e.exports={screen:"screen-otjoFNF2",fade:"fade-otjoFNF2",screenfade:"screenfade-otjoFNF2"}},126572:e=>{e.exports={}},98714:e=>{e.exports={css_value_currency_label_radius:"4",css_wrapper_margin:"4",css_row_left_right_padding:"3",css_fade_height:"10","price-axis-currency-label-wrapper":"price-axis-currency-label-wrapper-y5H41VPj",hidden:"hidden-y5H41VPj","price-axis-currency-label":"price-axis-currency-label-y5H41VPj",row:"row-y5H41VPj",expanded:"expanded-y5H41VPj","price-axis-currency-label-arrow-down":"price-axis-currency-label-arrow-down-y5H41VPj","price-axis-currency-label-text":"price-axis-currency-label-text-y5H41VPj"}},82815:e=>{e.exports={}},660070:e=>{e.exports={}},99647:e=>{e.exports={"css-value-chart-controls-bar-height-with-border":"39px","css-value-chart-controls-bar-border":"1px"}},443882:e=>{e.exports={}},796416:(e,t,i)=>{"use strict";i.d(t,{TOAST_ANIMATION_DURATION:()=>s});const s=500},775726:(e,t,i)=>{"use strict";i.d(t,{createToastManager:()=>o});var s=i(796416);function o(){const e=new Set,t=new Map;const i={groups:new Map};function o(e){const t=i.groups.get(e);if(t)return t;const s={id:e,list:new Map,added:new Set,removed:new Set};return i.groups.set(e,s),s}function r(e,s){t.delete(e),s.list.delete(e),s.removed.delete(e),0===s.list.size?i.groups.delete(s.id):i.groups.set(s.id,{...s}),n({type:"Remove",toastId:e,groupId:s.id})}function n(t){i.groups=new Map(i.groups),e.forEach((e=>{e(t)}));const s=a.get(t.toastId);s&&s.forEach((e=>{e(t)}))}const a=new Map;return{addToast:function(e,s,r,a,l){if(t.get(e))return;const c=o(s);c.added.add(e);const d={id:e,...r,manualAnimationStart:l};c.list.set(e,d),t.set(e,s),i.groups.set(s,{...c}),n({type:"Add",toastId:e,groupId:s,data:r,details:a})},removeToast:function(e,o){const a=t.get(e);if(!a)return;const l=i.groups.get(a);l&&(l.removed.has(e)||(l.removed.add(e),i.groups.set(a,{...l}),n({type:"RemoveAnimationStart",toastId:e,groupId:a,details:o}),setTimeout((()=>{r(e,l)}),s.TOAST_ANIMATION_DURATION)))},removeGroup:function(e,t){const o=i.groups.get(e);if(!o)return;const a=[];o.list.forEach((i=>{const s=i.id;o.removed.has(s)||(a.push(s),o.removed.add(s),n({type:"RemoveAnimationStart",toastId:s,groupId:e,details:t}))})),i.groups.set(e,{...o}),setTimeout((()=>{a.forEach((e=>{r(e,o)}))}),s.TOAST_ANIMATION_DURATION)},startAddAnimation:function(e){const s=t.get(e);if(!s)return;const o=i.groups.get(s);o&&o.added.delete(e)&&(i.groups.set(s,{...o}),n({type:"AddAnimationStart",toastId:e,groupId:s}))},subscribeOnToast:function(e,t){const i=function(e){const t=a.get(e);if(t)return t;const i=new Set;return a.set(e,i),i}(e);return i.add(t),()=>{i.delete(t),0===i.size&&a.delete(e)}},state:i,subscribe:function(t){return e.add(t),()=>{e.delete(t)}}}}},584112:(e,t,i)=>{"use strict";function s(){const e=new Set,t=new Set;const i={update:function(s,o){s?t.add(o):t.delete(o);const r=t.size>0;i.value!==r&&(i.value=r,e.forEach((e=>{e(s)})))},value:!1,subscribe:function(t){return e.add(t),()=>{
e.delete(t)}}};return i}i.d(t,{createNotificationsUserInteractionStatus:()=>s})},30931:(e,t,i)=>{"use strict";i.d(t,{ActivityStatus:()=>o});var s=i(375397);class o{constructor(e){this._unsetActive=()=>{this._isUserActive.setValue(!1)},this._resetActivity=()=>{this._setActive(),clearTimeout(this._timeout),this._timeout=setTimeout(this._unsetActive,this._timeoutDuration)},this._updateActivityFromVisibilityStatus=()=>{"hidden"===document.visibilityState?this._unsetActive():this._resetActivity()},this._isUserActive=new s.WatchedValue("hidden"!==document.visibilityState),this._timeoutDuration=e,this._timeout=setTimeout(this._unsetActive,e),document.addEventListener("click",this._resetActivity,{passive:!0}),document.addEventListener("mousemove",this._resetActivity,{passive:!0}),document.addEventListener("keydown",this._resetActivity,{passive:!0}),document.addEventListener("touchstart",this._resetActivity,{passive:!0}),document.addEventListener("wheel",this._resetActivity,{passive:!0}),document.addEventListener("visibilitychange",this._updateActivityFromVisibilityStatus,{passive:!0})}value(){return this._isUserActive.value()}subscribe(e){this._isUserActive.subscribe(e)}unsubscribe(e){this._isUserActive.unsubscribe(e)}destroy(){document.removeEventListener("click",this._resetActivity),document.removeEventListener("mousemove",this._resetActivity),document.removeEventListener("keydown",this._resetActivity),document.removeEventListener("touchstart",this._resetActivity),document.removeEventListener("wheel",this._resetActivity),document.removeEventListener("visibilitychange",this._updateActivityFromVisibilityStatus),clearTimeout(this._timeout)}_setActive(){this._isUserActive.setValue(!0)}}},223124:(e,t,i)=>{"use strict";i.d(t,{isCancelled:()=>r,makeCancelable:()=>o});class s extends Error{constructor(){super("CancelToken")}}function o(e){let t=!1;return{promise:new Promise(((i,o)=>{e.then((e=>t?o(new s):i(e))),e.catch((e=>o(t?new s:e)))})),cancel(){t=!0}}}function r(e){return e instanceof s}},581996:(e,t,i)=>{"use strict";i.d(t,{ResizerDetacherState:()=>r});var s=i(650151),o=i(375397);class r{constructor(e){this._alive=new o.WatchedValue,this._container=new o.WatchedValue,this._width=new o.WatchedValue,this._height=new o.WatchedValue,this._fullscreen=new o.WatchedValue,this._detachable=new o.WatchedValue,this._fullscreenable=new o.WatchedValue,this._visible=new o.WatchedValue,this._availWidth=new o.WatchedValue,this._availHeight=new o.WatchedValue,this._owner=new o.WatchedValue,this._ownersStack=[],this.owner=this._owner.readonly(),this._bridge={alive:this._alive.readonly(),container:this._container.readonly(),width:this._width.readonly(),height:this._height.readonly(),fullscreen:this._fullscreen.readonly(),detachable:this._detachable.readonly(),fullscreenable:this._fullscreenable.readonly(),visible:this._visible.readonly(),availWidth:this._availWidth.readonly(),availHeight:this._availHeight.readonly(),remove:()=>{const e=this._owner.value();e&&e.remove&&e.remove()},negotiateWidth:e=>{const t=this._owner.value()
;t&&t.negotiateWidth&&t.negotiateWidth(e)},negotiateHeight:e=>{const t=this._owner.value();t&&t.negotiateHeight&&t.negotiateHeight(e)},requestFullscreen:()=>{const e=this._owner.value();e&&e.requestFullscreen&&e.requestFullscreen()},exitFullscreen:()=>{const e=this._owner.value();e&&e.exitFullscreen&&e.exitFullscreen()},detach:e=>{const t=this._owner.value();t&&t.detach&&t.detach(e)},attach:()=>{const e=this._owner.value();e&&e.attach&&e.attach()}},e&&this.pushOwner(e)}bridge(){return this._bridge}pushOwner(e){if(!e.alive.value())return;for(const e of this._ownersStack)this._unsubscribeOwner(e);const t={owner:e};this._ownersStack.push(t),this._subscribeOwner(t)}_subscribeOwner(e){const t=e.owner;if(e.deathWatcher||(this._alive.setValue(!0),e.deathWatcher=t.alive.spawn(),e.deathWatcher.subscribe((t=>{t||this._deadHandler(e)}))),this._owner.setValue(t),!e.subscriptions){const i=e.subscriptions=[];this._visible.setValue(!1);const s=(e,t)=>{if(e){const s=e.spawn();i.push(s),s.subscribe((e=>{t.setValue(e)}),{callWithLast:!0})}else t.deleteValue()};s(t.container,this._container),s(t.width,this._width),s(t.height,this._height),s(t.fullscreen,this._fullscreen),s(t.detachable,this._detachable),s(t.fullscreenable,this._fullscreenable),s(t.availWidth,this._availWidth),s(t.availHeight,this._availHeight),s(t.visible,this._visible)}}_unsubscribeOwner(e,t){if(e.subscriptions){for(const t of e.subscriptions)t.unsubscribe();e.subscriptions=null}t&&e.deathWatcher&&(e.deathWatcher.unsubscribe(),e.deathWatcher=null)}_deadHandler(e){const t=this._ownersStack.indexOf(e);(0,s.assert)(-1!==t,"sanitized owner should be in stack");for(let e=this._ownersStack.length-1;e>=t;e--)this._unsubscribeOwner(this._ownersStack[e],!0);this._ownersStack.length=t,t>0?this._subscribeOwner(this._ownersStack[t-1]):(this._alive.setValue(!1),this._owner.deleteValue())}}},554433:(e,t,i)=>{"use strict";i.d(t,{VisibilityApi:()=>o});var s=i(375397);class o{constructor(e){let t;this.isVisible=new s.WatchedValue(!0);let i=null;for(const s of["","moz","ms","webkit"]){const o=s?`${s}Hidden`:"hidden";if(o in e){t=`${s}visibilitychange`,i=()=>{this.isVisible.setValue(!e[o])},i(),e.addEventListener(t,i,!1);break}}this.destroy=()=>{i&&(e.removeEventListener(t,i,!1),i=null)}}}},936442:(e,t,i)=>{"use strict";i.d(t,{CHART_WARNINIG_GROUP_ID:()=>n,showChartWarningNotification:()=>a});var s=i(148255),o=i(699411),r=i(610057);const n="chart_warning";function a(e,t){return new Promise((i=>{o.toastManager.addToast(e,n,t),(0,r.setToastUserActivityBasedRemovalTimeout)(e,1e4);const a=(0,s.subscribeOnToast)(e,(e=>{"Remove"!==e.type&&e.details!==r.CLOSE_DUE_TO_INACTIVITY_EVENT_DETAILS||(i(),a())}))}))}},148255:(e,t,i)=>{"use strict";i.d(t,{subscribeOnToast:()=>s});const s=i(699411).toastManager.subscribeOnToast},175637:(e,t,i)=>{"use strict";i.d(t,{getSetToastUserActivityBasedRemovalTimeout:()=>o});var s=i(30931);function o(e,t,i,o){let r=null;const n=new Set;return function(a,l=2e4){const{start:c,reset:d}=function(e,t){let i;return{start:()=>{i=setTimeout(e,t)},reset:()=>{
clearTimeout(i),i=void 0}}}((()=>{e.removeToast(a,o)}),l),h=()=>{const e=u.value(),i=t.value;e&&!i?c():d()},u=(p=a,n.add(p),r||(r=new s.ActivityStatus(i)),r);var p;h(),u.subscribe(h);const _=t.subscribe(h),m=e.subscribeOnToast(a,(e=>{"RemoveAnimationStart"===e.type&&(d(),m(),u.unsubscribe(h),function(e){n.delete(e),0===n.size&&r&&(r.destroy(),r=null)}(a),_())}))}}},610057:(e,t,i)=>{"use strict";i.d(t,{CLOSE_DUE_TO_INACTIVITY_EVENT_DETAILS:()=>r,setToastUserActivityBasedRemovalTimeout:()=>n});var s=i(699411),o=i(175637);const r="userActivityTimeout",n=(0,o.getSetToastUserActivityBasedRemovalTimeout)(s.toastManager,s.toastUserInteractionStatus,15e3,r)},113610:(e,t,i)=>{"use strict";i.d(t,{getChartStorage:()=>m});var s=i(702598),o=i(895370),r=i(175203),n=i(652171),a=i(198303),l=i(622864),c=i(474759);function d(){const e=document.querySelector('link[rel~="chart-storage"]'),t=new URL((null==e?void 0:e.href)||"/charts-storage/",location.href);return t.pathname.endsWith("/")||(t.pathname+="/"),t}function h(e){const{charts:t={},countSourcesTotal:i=0,limitBytesTotal:s=0,sizeBytesTotal:o=0}=e,r=new Map;for(const e in t){const i=t[e].symbols,s=new Map;for(const e in i||{}){const t=i[e];s.set(e,{countSources:t.countSources,sizeBytes:t.sizeBytes,ids:t.ids})}r.set(e,s)}return{charts:r,countSourcesTotal:i,limitBytesTotal:s,sizeBytesTotal:o}}const u={sources:new Map,groups:new Map};class p{constructor(){this._lastSaveRequest=Promise.resolve(),this._requestsCounter=0,this._lastSharedToolsLoadingRequest=Promise.resolve(u)}async saveLineToolsAndGroups(e,t,i,h,u){if(""===e||void 0===e)return Promise.reject("Unnamed chart cannot be saved");const p=`${e}.${t}.${this._requestsCounter++}`,_=`ChartStorage.Save.TotallyProcessing.${p}`,m=(0,o.perfMeasureOperation)(_,(()=>this._lastSaveRequest.then((async()=>{if(null==u?void 0:u.aborted)throw(0,l.createAbortError)();const _=`ChartStorage.Save.GettingToken.${p}`,m=await(0,o.perfMeasureOperation)(_,(()=>(0,n.getStorageTarget)(e,t,h,u))),g=new URL(m.path,d());m.chartId&&g.searchParams.append("chart_id",m.chartId),g.searchParams.append("jwt",m.token);const S=(0,c.stringifyLineToolsAndGroupsDTO)(i),v=`ChartStorage.Save.GettingResponse.${p}`;return(0,o.perfMeasureOperation)(v,(()=>(0,s.fetch)(g.toString(),{signal:u,method:"PUT",headers:{"Content-Type":"application/json","X-BUILD-TIME":window.BUILD_TIME},credentials:"include",body:S}).then((e=>{if(!e.ok){const t=429===e.status;throw new a.SavingLineToolsError(t,`Response status is not success: ${e.status}`)}const t=e.json();return r.telemetry.sendLineToolsStorageReport("line_tools_save_success"),t})).then((s=>({content:s,savedDto:i,layoutId:e,chartId:t,sharingMode:h})))))}))));return this._lastSaveRequest=m.catch((e=>{r.telemetry.sendLineToolsStorageReport("line_tools_save_error")})),m}async loadLineToolsAndGroups(e,t,i){if(""===e||void 0===e)return u;const a=`${e}.${t}.${i.requestType}.${this._requestsCounter++}`,l=`ChartStorage.Load.GettingToken.${a}`,h=await(0,o.perfMeasureOperation)(l,(()=>(0,
n.getStorageTarget)(e,t,i.sharingMode))),p=`get/${h.path}`,_=new URL(p,d());switch(h.chartId&&_.searchParams.append("chart_id",h.chartId),window.user.is_superuser&&2===i.sharingMode&&_.searchParams.append("layout_id",e),_.searchParams.append("jwt",h.token),i.requestType){case"mainSeriesLineTools":_.searchParams.append("symbol",i.symbol),0===i.sharingMode&&_.searchParams.append("includeOwnerSource",i.seriesSourceId),_.searchParams.append("brokerName",i.brokerName);break;case"studiesLineTools":_.searchParams.append("excludeOwnerSource",i.seriesSourceId);break;case"lineToolsWithoutSymbol":_.searchParams.append("symbol",""),0===i.sharingMode&&_.searchParams.append("includeOwnerSource",i.seriesSourceId)}const m=`ChartStorage.Load.GettingResponse.${a}`,g=()=>(0,s.fetch)(_.toString(),{method:"GET",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("Response status is not success");const t=e.headers.get("X-Request-Id");return e.json().then((e=>{if(null===e)throw new Error("Body is null");if(!e.success)throw new Error("Response is not success");const i=(0,c.parseLineToolsAndGroupsDTO)(e.payload||{},t);return r.telemetry.sendLineToolsStorageReport("line_tools_load_success"),i}))})),S=0===i.sharingMode?g:()=>this._lastSharedToolsLoadingRequest.then(g),v=(0,o.perfMeasureOperation)(m,S).catch((e=>{throw r.telemetry.sendLineToolsStorageReport("line_tools_load_error"),e}));return 0!==i.sharingMode&&(this._lastSharedToolsLoadingRequest=v.catch((()=>u))),v}async removeLineTools(e,t,i,a){if(""===e||void 0===e)return!1;const l=`${e}.${t}.${this._requestsCounter++}`,c=`ChartStorage.Remove.GettingToken.${l}`,h=await(0,o.perfMeasureOperation)(c,(()=>(0,n.getStorageTarget)(e,t,i))),u=new URL(h.path,d());h.chartId&&u.searchParams.append("chart_id",h.chartId),u.searchParams.append("jwt",h.token),u.searchParams.append("symbol",a);const p=`ChartStorage.Remove.GettingResponse.${l}`;return(0,o.perfMeasureOperation)(p,(()=>(0,s.fetch)(u.toString(),{method:"DELETE",credentials:"include"}).then((e=>{if(!e.ok)throw new Error("Response status is not success");return e.json().then((e=>{if(null===e)throw new Error("Body is null");if(!e.success)throw new Error("Response is not success");return r.telemetry.sendLineToolsStorageReport("line_tools_remove_by_symbol_success"),!0}))})))).catch((e=>{throw r.telemetry.sendLineToolsStorageReport("line_tools_remove_by_symbol_error"),e}))}async getLayoutDrawingsSizeInfo(e,t){if(""===e||void 0===e)return{charts:new Map,countSourcesTotal:0,limitBytesTotal:0,sizeBytesTotal:0};const i=`${e}.${t}.${this._requestsCounter++}`,s=`ChartStorage.GetSizes.GettingToken.${i}`,a=await(0,o.perfMeasureOperation)(s,(()=>(0,n.getStorageTarget)(e,t,0))),l=new URL(`layout/${e}/sizes`,d());return l.searchParams.append("jwt",a.token),this._fetchData(`ChartStorage.GetSizes.GettingResponse.${i}`,l,{method:"GET",credentials:"include"}).then((e=>(r.telemetry.sendLineToolsStorageReport("line_tools_size_info_success"),h(e||{})))).catch((e=>{throw r.telemetry.sendLineToolsStorageReport("line_tools_size_info_error"),e}))}
async getUserGlobalDrawingsSizeInfo(e){if(""===e||void 0===e)return{charts:new Map,countSourcesTotal:0,limitBytesTotal:0,sizeBytesTotal:0};const t=this._requestsCounter++,i=await(0,o.perfMeasureOperation)(`ChartStorage.GetGlobalSizes.GettingToken.${t}`,(()=>(0,n.getStorageTarget)(e,"",2))),s=new URL("user/sizes",d());return s.searchParams.append("jwt",i.token),this._fetchData(`ChartStorage.GetGlobalSizes.GettingResponse.${t}`,s,{credentials:"include"}).then((e=>(r.telemetry.sendLineToolsStorageReport("global_line_tools_size_info_success"),h(e||{})))).catch((e=>{throw r.telemetry.sendLineToolsStorageReport("global_line_tools_size_info_error"),e}))}async _fetchData(e,t,i){const r=await(0,o.perfMeasureOperation)(e,(()=>(0,s.fetch)(t.toString(),i)));if(!r.ok)throw new Error("Response status is not success");const n=await r.json();if(null===n)throw new Error("Body is null");if(!n.success)throw new Error("Response is not success");return n.payload}}let _=null;async function m(){return null===_&&(_=new p),_}},474759:(e,t,i)=>{"use strict";function s(e){const t={};return e.sources&&(t.sources={},e.sources.forEach(((e,i)=>{t.sources[i]=e}))),t.drawing_groups={},e.groups.forEach(((e,i)=>{t.drawing_groups[i]=e})),t.clientId=e.clientId,JSON.stringify(t)}function o(e,t){const i={sources:null,groups:new Map};if(null!==e.sources){i.sources=new Map;for(const t in e.sources||{}){const s=e.sources[t];i.sources.set(t,s)}}for(const t in e.drawing_groups||{}){const s=e.drawing_groups[t];i.groups.set(t,s)}return null!==t&&(i.serverRequestId=t),i.clientId=e.clientId,i.symbol=e.symbol,i}i.d(t,{parseLineToolsAndGroupsDTO:()=>o,stringifyLineToolsAndGroupsDTO:()=>s})},198303:(e,t,i)=>{"use strict";i.d(t,{SavingLineToolsError:()=>s});class s extends Error{constructor(e,t){super(t),this.shouldBeCooled=e}}Error},652171:(e,t,i)=>{"use strict";i.d(t,{getStorageTarget:()=>a,globallySharedChartId:()=>n,sharedChartId:()=>r});var s=i(175203),o=i(622864);const r="_shared",n="UserSync";async function a(e,t,i,n){try{const a=new URL("/chart-token/",location.href);a.searchParams.append("image_url",e);const l=window.user.id||-1;a.searchParams.append("user_id",""+l);const c=await fetch(a.toString(),{signal:n});if(!c.ok)throw new Error(`Http response is not ok: ${c.status}}`);const d=await c.json();if(s.telemetry.sendLineToolsStorageReport("line_tools_token_request_success"),null==n?void 0:n.aborted)throw(0,o.createAbortError)();let h=t;return 2===i?h=void 0:1===i&&(h=r),{token:d.token,chartId:h,path:2===i?"user/sources":`layout/${e}/sources`}}catch(e){throw(0,o.isAbortError)(e)||s.telemetry.sendLineToolsStorageReport("line_tools_token_request_error"),e}}},347402:(e,t,i)=>{"use strict";i.d(t,{desktopVersionIsLess:()=>n,lessThan:()=>r});var s=i(638456);function o(e){const t=e.match(/^(\d+).(\d+).(\d+)/);if(!t)return null;const[,i,s,o]=t;return[parseInt(i),parseInt(s),parseInt(o)]}function r(e,t){const i=o(e),s=o(t);if(!i||!s)return!1;const[r,n,a]=i,[l,c,d]=s;return r!==l?r<l:n!==c?n<c:a!==d&&a<d}function n(e){const t=(0,s.desktopAppVersion)();return!!t&&r(t,e)}
},709404:(e,t,i)=>{"use strict";i.d(t,{getExchanges:()=>o});var s=i(294740);function o(){return s}},515312:(e,t,i)=>{"use strict";i.d(t,{isNativeUIInteraction:()=>s.isNativeUIInteraction,isTextEditingField:()=>s.isTextEditingField});var s=i(607423)},542682:(e,t,i)=>{"use strict";i.d(t,{isTouchEvent:()=>o});var s=i(778785);function o(e){const t=e.sourceCapabilities;let i=t&&t.firesTouchEvents;return void 0===i&&(i=s.touch),i}},207678:(e,t,i)=>{"use strict";i.d(t,{breakpoints:()=>s,mobileFirstBreakpoints:()=>o,mobileFirstLegacyBreakpoints:()=>r});const s={desktop:1/0,desktopHd:1919,phone:767,"phone-vertical":479,tablet:1019},o={base:0,"media-mf-phone-vertical":320,"media-mf-phone-landscape":568,"media-mf-tablet-vertical":768,"media-mf-tablet-landscape":1024,"media-mf-laptop":1280,"media-mf-desktop-medium":1440,"media-mf-desktop-large":1920,"media-mf-desktop-extra-large":2560},r={"media-mf-legacy-phone-vertical":330,"media-mf-legacy-phone":480,"media-mf-legacy-notebook":1020,"media-mf-legacy-desktop-medium":1480,"media-mf-legacy-desktop":1531}},912445:(e,t,i)=>{"use strict";let s;function o(e,t){null==s||s(e,t)}function r(e){s=e}i.d(t,{muteLinkingGroup:()=>o,setMuteLinkingGroup:()=>r})},895370:(e,t,i)=>{"use strict";i.d(t,{addPerfMark:()=>c,perfMeasureOperation:()=>d});var s=i(79342);function o(){}const r=console.timeStamp?console.timeStamp.bind(console):o,n=window.performance&&performance.mark?performance.mark.bind(performance):o,a=window.performance&&performance.measure?performance.measure.bind(performance):o,l=window.performance&&performance.clearMarks?performance.clearMarks.bind(performance):o;function c(e){r(e),n(e)}async function d(e,t){const i=`measure-${e}-${(0,s.randomHash)()}`;n(i);try{return await t()}finally{a(e,i),l(i)}}},887357:(e,t,i)=>{"use strict";var s;i.d(t,{NewsWidgetPlacement:()=>s}),function(e){e.WidgetBar="widgetbar",e.Main="main",e.Chart="chart",e.Screener="screener"}(s||(s={}))},67302:(e,t,i)=>{"use strict";i.d(t,{showThemeAction:()=>n,showThemeSwitcher:()=>r});var s=i(638456),o=i(347402);function r(){return!(0,s.isDesktopApp)()||(0,o.desktopVersionIsLess)("1.0.10")}function n(){return(0,s.isDesktopApp)()&&!(0,o.desktopVersionIsLess)("1.0.11")}},247001:(e,t,i)=>{"use strict";i.d(t,{trackStudies:()=>r});var s=i(776734),o=i(637761);function r(e,t){const i=e.metaInfo(),r=!e.isPine()||e.isStandardPine()?i.description:i.scriptIdPart,n=i.productId,a=o.StudyMetaInfo.isScriptStrategy(i),l=window.user&&window.user.pro_plan||"";(0,s.getTracker)().then((e=>{e&&e.trackStudiesAnalytics(r,n,t,a,l)}))}},484400:(e,t,i)=>{"use strict";i.d(t,{DEFAULT_THEME:()=>s});const s="light"},994123:(e,t,i)=>{"use strict";i.d(t,{themes:()=>l});var s=i(919346),o=i(444372)
;const r=JSON.parse('{"color-header-bg":"color-black","color-body-bg":"color-black","color-body-secondary-bg":"color-cold-gray-900","color-bg-primary":"color-cold-gray-850","color-bg-primary-hover":"color-cold-gray-800","color-bg-secondary":"color-cold-gray-900","color-bg-highlight":"color-cold-gray-900","color-bg-scroll-buttons":"color-cold-gray-800","color-legacy-bg-scroll-buttons":"color-cold-gray-550","color-legacy-bg-widget":"color-cold-gray-900","color-text-primary":"color-cold-gray-200","color-text-secondary":"color-cold-gray-450","color-text-tertiary":"color-cold-gray-400","color-text-disabled":"color-cold-gray-650","color-accent-content":"color-white","color-divider":"color-cold-gray-700","color-divider-hover":"color-cold-gray-800","color-divider-secondary":"color-cold-gray-800","color-box-shadow":"color-cold-gray-900","color-active-hover-text":"color-cold-gray-200","color-alert-text":"color-cold-gray-200","color-border":"color-cold-gray-750","color-border-chat-fields":"color-cold-gray-750","color-border-hover":"color-cold-gray-650","color-border-table":"color-cold-gray-800","color-brand":"color-tv-blue-500","color-brand-hover":"color-tv-blue-600","color-brand-active":"color-tv-blue-700","color-button-hover-bg":"color-cold-gray-850","color-chart-page-bg":"color-cold-gray-800","color-common-tooltip-bg":"color-cold-gray-750","color-danger":"color-ripe-red-600","color-danger-hover":"color-ripe-red-500","color-danger-active":"color-ripe-red-400","color-depthrenderer-fill-style":"color-cold-gray-150","color-depthrenderer-stroke-style":"color-cold-gray-650","color-disabled-border-and-color":"color-cold-gray-800","color-disabled-input":"color-cold-gray-750","color-empty-container-message":"color-cold-gray-450","color-halal":"color-iguana-green-400","color-continuous":"color-cold-gray-500","color-highlight-new":"color-tv-blue-a800","color-icons":"color-cold-gray-450","color-input-bg":"color-cold-gray-800","color-input-textarea-readonly":"color-cold-gray-650","color-input-placeholder-text":"color-cold-gray-700","color-input-publish-bg":"color-cold-gray-900","color-item-active-blue":"color-tv-blue-a900","color-item-hover-active-bg":"color-cold-gray-800","color-item-hover-bg":"color-cold-gray-800","color-item-hover-blue":"color-tv-blue-a800","color-item-selected-blue":"color-tv-blue-a800","color-item-active-text":"color-cold-gray-200","color-item-active-bg":"color-tv-blue-500","color-link":"color-tv-blue-500","color-link-hover":"color-tv-blue-600","color-link-active":"color-tv-blue-700","color-list-item":"color-cold-gray-450","color-list-nth-child-bg":"color-cold-gray-850","color-news-highlight":"color-cold-gray-800","color-pane-bg":"color-cold-gray-900","color-pane-secondary-bg":"color-cold-gray-850","color-placeholder":"color-cold-gray-650","color-popup-menu-item-hover-bg":"color-cold-gray-800","color-popup-menu-separator":"color-cold-gray-700","color-primary-symbol":"color-sky-blue-500","color-row-hover-active-bg":"color-cold-gray-800","color-sb-scrollbar-body-bg":"color-cold-gray-650","color-screener-description":"color-cold-gray-200","color-section-separator-border":"color-cold-gray-750","color-search-button-hover":"color-cold-gray-700","color-separator-table-chat":"color-cold-gray-750","color-success":"color-minty-green-700","color-success-hover":"color-minty-green-600","color-success-active":"color-minty-green-500","color-tag-active-bg":"color-cold-gray-750","color-tag-hover-bg":"color-cold-gray-800","color-text-regular":"color-cold-gray-200","color-toolbar-button-text":"color-cold-gray-200","color-toolbar-button-text-hover":"color-cold-gray-200","color-toolbar-button-text-active":"color-tv-blue-500","color-toolbar-button-text-active-hover":"color-tv-blue-600","color-toolbar-button-background-hover":"color-cold-gray-800","color-toolbar-button-background-secondary-hover":"color-cold-gray-750","color-toolbar-button-background-active":"color-tv-blue-a900","color-toolbar-button-background-active-hover":"color-tv-blue-a800","color-toolbar-toggle-button-background-active":"color-tv-blue-500","color-toolbar-toggle-button-background-active-hover":"color-tv-blue-600","color-toolbar-toggle-button-icon":"color-cold-gray-650","color-toolbar-interactive-element-text-normal":"color-cold-gray-200","color-toolbar-opened-element-bg":"color-cold-gray-800","color-toolbar-divider-background":"color-cold-gray-700","color-popup-background":"color-cold-gray-850","color-popup-element-text":"color-cold-gray-200","color-popup-element-text-hover":"color-cold-gray-250","color-popup-element-background-hover":"color-cold-gray-800","color-popup-element-secondary-text":"color-cold-gray-500","color-popup-element-hint-text":"color-cold-gray-600","color-popup-element-text-active":"color-cold-gray-200","color-popup-element-background-active":"color-tv-blue-500","color-popup-element-toolbox-text":"color-cold-gray-500","color-popup-element-toolbox-text-hover":"color-cold-gray-200","color-popup-element-toolbox-text-active-hover":"color-tv-blue-200","color-popup-element-toolbox-background-hover":"color-cold-gray-750","color-popup-element-toolbox-background-active-hover":"color-tv-blue-700","color-tooltip-bg":"color-cold-gray-750","color-tv-button-checked":"color-cold-gray-450","color-tv-dialog-caption":"color-cold-gray-50","color-tv-dropdown-item-hover-bg":"color-cold-gray-800","color-underlined-text":"color-cold-gray-450","color-widget-pages-bg":"color-cold-gray-900","color-warning":"color-tan-orange-700","color-forex-icon":"color-white","color-list-item-active-bg":"color-tv-blue-500","color-list-item-hover-bg":"color-cold-gray-800","color-list-item-text":"color-cold-gray-200","color-price-axis-label-back":"color-cold-gray-800","color-price-axis-label-text":"color-cold-gray-500","color-price-axis-gear":"color-cold-gray-200","color-price-axis-gear-hover":"color-cold-gray-400","color-price-axis-highlight":"color-cold-gray-800","color-bid":"color-tv-blue-500","color-scroll-bg":"color-cold-gray-750","color-scroll-border":"color-cold-gray-850","color-widget-border":"color-cold-gray-800","color-scroll-buttons-arrow":"color-white","color-control-intent-default":"color-cold-gray-650","color-control-intent-success":"color-minty-green-500","color-control-intent-primary":"color-tv-blue-500","color-control-intent-warning":"color-tan-orange-500","color-control-intent-danger":"color-ripe-red-500","color-growing":"color-minty-green-500","color-falling":"color-ripe-red-500","color-goto-label-background":"color-cold-gray-650","color-pre-market":"color-tan-orange-600","color-pre-market-bg":"color-tan-orange-400","color-post-market":"color-tv-blue-500","color-post-market-bg":"color-tv-blue-400","color-market-open":"color-minty-green-500","color-market-open-bg":"color-minty-green-400","color-market-closed":"color-cold-gray-400","color-market-holiday":"color-cold-gray-400","color-market-expired":"color-ripe-red-500","color-invalid-symbol":"color-ripe-red-400","color-invalid-symbol-hover":"color-ripe-red-500","color-delisted-symbol":"color-ripe-red-600","color-delisted-symbol-hover":"color-ripe-red-800","color-replay-mode":"color-tv-blue-500","color-replay-mode-point-select":"color-cold-gray-250","color-replay-mode-icon":"color-tv-blue-50","color-replay-mode-hover":"color-tv-blue-600","color-notaccurate-mode":"color-berry-pink-600","color-delay-mode":"color-tan-orange-700","color-delay-mode-bg":"color-tan-orange-400","color-eod-mode":"color-grapes-purple-700","color-eod-mode-bg":"color-grapes-purple-400","color-data-problem":"color-ripe-red-600","color-data-problem-bg":"color-ripe-red-400","color-data-problem-hover":"color-ripe-red-500","color-list-item-bg-highlighted":"color-tv-blue-a900","color-list-item-bg-selected":"color-tv-blue-a800","color-list-item-bg-highlighted-hover":"color-tv-blue-a800","color-list-item-bg-selected-hover":"color-tv-blue-a700","color-screener-header-bg":"color-cold-gray-850","color-screener-header-bg-hover":"color-cold-gray-800","color-overlay":"color-cold-gray-950","color-boost-button-content-selected":"color-tv-blue-100","color-boost-button-content-hover":"color-white","color-boost-button-bg-hover":"color-cold-gray-750","color-boost-button-border-hover":"color-cold-gray-750","color-boost-button-border-default":"color-cold-gray-700","color-x-twitter-content":"color-white","color-card-border":"color-cold-gray-700","color-card-border-hover":"color-cold-gray-600","color-background-special-primary":"color-black","color-stroke-special-primary":"color-cold-gray-800","color-selection-bg":"color-tv-blue-a700","color-default-gray":"color-cold-gray-450","color-featured-broker-badge-bg":"color-white","color-featured-broker-badge-bg-hover":"color-cold-gray-100","color-featured-broker-badge-text":"color-cold-gray-900"}'),n=JSON.parse('{"color-toolbar-button-text-active":"color-seeking-alpha-brand"}')
;var a=i(960095);const l={[s.StdTheme.Light]:{name:s.StdTheme.Light,label:()=>o.t(null,{context:"colorThemeName"},i(696870)),order:2,getThemedColor:e=>(0,a.getHexColorByName)(e)},[s.StdTheme.Dark]:{name:s.StdTheme.Dark,label:()=>o.t(null,{context:"colorThemeName"},i(185119)),order:1,getThemedColor:e=>{const t=r[e]||e;return(0,a.getHexColorByName)(t)}}};l.sa={isPrivate:!0,noChartTheme:!0,name:"sa",getThemedColor:e=>{const t=n[e]||e;return(0,a.getHexColorByName)(t)}}},560420:(e,t,i)=>{"use strict";i.d(t,{activateKeyPressHandler:()=>u,showDialog:()=>p});var s=i(576119),o=i(826312),r=i(764829),n=i(214372),a=i(533679),l=i(506672),c=i(345848);let d=null;function h(e){if(!(0,o.globalKeypressMatches)(e))return!1;e.preventDefault();const t=String.fromCharCode(e.charCode);return r.enabled("show_interval_dialog_on_key_press")&&function(e){return/[1-9]/.test(e)}(t)?(0,n.showChangeIntervalDialogAsync)({initVal:t}):r.enabled("symbol_search_hot_key")&&(p({defaultValue:t,selectSearchOnInit:!1,source:"keyboard",trackResultsOptions:{trackResults:!r.enabled("widget"),emptySearchType:"empty_result__supercharts"}}),(0,c.trackEvent)("GUI","SS","hotkey")),!0}function u(){(0,a.loadChangeIntervalDialog)(),s.pushBackListener("symbolEdit",h)}function p(e){const t=d=(0,l.loadNewSymbolSearch)().then((i=>{t===d&&i.showDefaultSearchDialog(e)}));return t}},711496:(e,t,i)=>{"use strict";i.d(t,{hasFinancialsByAvailabilityFlags:()=>d,hasFinancialsByTypespecs:()=>c});var s=i(519073);const o=new Set(["stock","dr","right","warrant","structured","bond"]),r=new Set(["mutual","unit","trust","reit","closedend","etn"]),n=new Set(["etn"]),a=new Set(["convertible","corporate"]),l=new Set(["cfd"]);function c(e,t){return!(e&&t&&(0,s.isEtf)(e,t))&&("structured"===e&&(null==t?void 0:t.length)?t.filter((e=>n.has(e))).length>0:"fund"===e&&(null==t?void 0:t.length)?t.filter((e=>r.has(e))).length>0:"bond"===e&&(null==t?void 0:t.length)?t.filter((e=>a.has(e))).length>0:"stock"===e&&(null==t?void 0:t.length)?0===t.filter((e=>l.has(e))).length:Boolean(e&&o.has(e)))}function d(e,t,i){if(t&&i&&(0,s.isEtf)(t,i))return!1;const{dividendsAvailability:o,earningsAvailability:r,financialsAvailability:n}=e;return 1===n||1===o||1===r}},2606:(e,t,i)=>{"use strict";i.d(t,{isDetailsReady:()=>s});const s=new(i(375397).WatchedValue)(!1)},137674:(e,t,i)=>{"use strict";i.d(t,{createSymbolNote:()=>m,showMindsPage:()=>_,showSymbolIdeas:()=>p,showSymbolNews:()=>u,showSymbolNotes:()=>h});var s=i(2606),o=i(421219),r=i(777453);async function n(e){Promise.all([i.e(79706),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(49481),i.e(53799),i.e(75826),i.e(82421),i.e(59258),i.e(58985),i.e(67158),i.e(29296),i.e(16356),i.e(97384),i.e(3782),i.e(49162),i.e(30358),i.e(17175),i.e(39967),i.e(81354),i.e(71938),i.e(27272),i.e(71553),i.e(44500),i.e(82321),i.e(16388),i.e(82311),i.e(27353),i.e(14742),i.e(73294),i.e(50996)]).then(i.bind(i,768175)).then((t=>{t.renderNotesDialog(e)}))}var a=i(881607);var l=i(515828);let c=null;function d(e,t){if(c&&s.isDetailsReady.unsubscribe(c),
c=()=>{var i,s,o;(null===(o=null===(s=null===(i=null===window||void 0===window?void 0:window.widgetbar)||void 0===i?void 0:i.layout)||void 0===s?void 0:s.getWidgetByType("detail"))||void 0===o?void 0:o.widgetObject).navigate(e,t)},s.isDetailsReady.value())return c(),void(c=null);s.isDetailsReady.subscribe(c,{once:!0})}function h(e=null,t){const i=(0,o.pathToGroup)(null!=e?e:"");t?n(i):d(i)}function u(e,t){const s=(0,r.newsPathToGroup)(null!=e?e:"");t?async function(e){(await Promise.all([i.e(4212),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(58985),i.e(67158),i.e(22164),i.e(49742),i.e(16190),i.e(97384),i.e(49325),i.e(3782),i.e(49162),i.e(85758),i.e(17175),i.e(7462),i.e(70125),i.e(18488),i.e(46879),i.e(52753),i.e(53791),i.e(4673),i.e(81029),i.e(82321),i.e(11875),i.e(16792),i.e(39233),i.e(84482)]).then(i.bind(i,23154))).renderNewsDialog(e)}(s):d(s)}function p(e,t){const s=(0,a.ideasPathToGroup)(null!=e?e:"");t?async function(e){(await Promise.all([i.e(71918),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(62564),i.e(82421),i.e(59258),i.e(58985),i.e(67158),i.e(22164),i.e(16190),i.e(77280),i.e(97384),i.e(3782),i.e(49162),i.e(85758),i.e(52017),i.e(17175),i.e(7462),i.e(56261),i.e(52753),i.e(49180),i.e(95645),i.e(82627),i.e(27272),i.e(71030),i.e(82321),i.e(24951),i.e(85036),i.e(7187),i.e(69647),i.e(94673)]).then(i.bind(i,790348))).renderIdeasDialog(e)}(s):d(s)}function _(e,t,i){d((0,l.createMindsPath)(null!=e?e:"",t,i))}function m(e=null,t){const i=(0,o.pathToGroup)(null!=e?e:"")+"?new="+performance.now();t&&n(i),d(i)}},881607:(e,t,i)=>{"use strict";i.d(t,{IDEAS_GROUP_PATH_PATTERN:()=>s,ideasPathToGroup:()=>o});const s="/ideas/groups/:symbol/";function o(e){return s.replace(":symbol",encodeURIComponent(e))}},777453:(e,t,i)=>{"use strict";i.d(t,{NEWS_GROUP_PATH_PATTERN:()=>s,newsPathToGroup:()=>o});const s="/news/groups/:symbol/";function o(e){return s.replace(":symbol",encodeURIComponent(e))}},421219:(e,t,i)=>{"use strict";i.d(t,{GROUP_PATH_PATTERN:()=>o,NOTES_PATH_PATTERN:()=>s,UNATTENDED_PATH_PATTERN:()=>r,pathToGroup:()=>n});const s="/notes/",o="/notes/groups/:symbol/",r="/notes/unattended/";function n(e){return e?o.replace(":symbol",encodeURIComponent(e)):r}},834698:(e,t,i)=>{"use strict";i.d(t,{CompareDialogRenderer:()=>r});var s=i(999138);var o=i(251954);class r extends s.DialogRenderer{constructor(e){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)},this._chartWidgetCollection=e}show(e){this._load().then((t=>{var i,s;null===(i=this._dialog)||void 0===i||i.hide(),null===(s=this._dialog)||void 0===s||s.visible().unsubscribe(this._subscribe),this._dialog=t,t.visible().subscribe(this._subscribe),t.show(e),o.emit("compare_add")}))}hide(){var e;null===(e=this._dialog)||void 0===e||e.hide()}_load(){
return Promise.all([Promise.all([i.e(88312),i.e(57271)]).then(i.bind(i,910261)),Promise.all([i.e(11567),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(23141),i.e(72197),i.e(88015),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(79412),i.e(42513),i.e(16182),i.e(55206),i.e(98858),i.e(2610),i.e(82321),i.e(87473),i.e(16388),i.e(83147),i.e(75560),i.e(66144),i.e(59490),i.e(30731)]).then(i.bind(i,635647))]).then((([e,t])=>{const i=new e.CompareModel(this._chartWidgetCollection);return t.getCompareDialogRenderer(i)}))}}},105580:(e,t,i)=>{"use strict";i.d(t,{showDetailsDialog:()=>n});var s=i(999138);let o;class r extends s.DialogRenderer{constructor(){super(...arguments),this._dialog=null,this._promise=null,this._subscribe=e=>{this._setVisibility(e)}}show(e){const t=this._promise=Promise.all([i.e(99507),i.e(53499),i.e(33532),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(58985),i.e(67158),i.e(65857),i.e(22164),i.e(36010),i.e(16190),i.e(97384),i.e(49325),i.e(3782),i.e(92115),i.e(49162),i.e(85758),i.e(6633),i.e(89259),i.e(7462),i.e(70125),i.e(18488),i.e(46879),i.e(52753),i.e(13427),i.e(36770),i.e(71938),i.e(53791),i.e(96589),i.e(87445),i.e(29145),i.e(96312),i.e(55773),i.e(42624),i.e(4673),i.e(86873),i.e(6752),i.e(59253),i.e(82574),i.e(82321),i.e(16388),i.e(31057),i.e(82311),i.e(69576),i.e(65373),i.e(97525),i.e(29508),i.e(31154),i.e(61975),i.e(75278),i.e(39233),i.e(10151),i.e(26720)]).then(i.bind(i,863308)).then((i=>{this._promise===t&&(this._dialog&&(this._dialog.hide(),this._dialog.visible().unsubscribe(this._subscribe)),this._dialog=new i.DetailsDialogRenderer,this._dialog.visible().subscribe(this._subscribe),this._dialog.show(e))}))}hide(){var e,t;null===(e=this._dialog)||void 0===e||e.hide(),null===(t=this._dialog)||void 0===t||t.visible().unsubscribe(this._subscribe)}static getInstance(){return o||(o=new r),o}}function n(e){r.getInstance().show(e)}},597101:(e,t,i)=>{"use strict";i.d(t,{hideStateChange:()=>s});const s=new(i(942634).Delegate)},161590:(e,t,i)=>{"use strict";i.d(t,{GeneralChartPropertiesRenderer:()=>o});var s=i(999138);class o extends s.DialogRenderer{constructor(e){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)},this._chartWidgetCollection=e}show(e){const t=this._chartWidgetCollection,s=t.activeChartWidget.value()
;return s.generalPropertiesDefinitions().then((o=>Promise.all([i.e(72481),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(65857),i.e(23141),i.e(36010),i.e(95083),i.e(29296),i.e(62234),i.e(72197),i.e(43362),i.e(88015),i.e(22106),i.e(30422),i.e(16356),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(22602),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(44066),i.e(75364),i.e(8222),i.e(77414),i.e(84353),i.e(79412),i.e(80089),i.e(25983),i.e(42513),i.e(16182),i.e(31085),i.e(82440),i.e(90303),i.e(24474),i.e(89255),i.e(62319),i.e(2573),i.e(12400),i.e(78687),i.e(49745),i.e(48694),i.e(41682),i.e(38790),i.e(79184),i.e(779),i.e(91068),i.e(35288),i.e(82321),i.e(87473),i.e(16388),i.e(62107),i.e(83147),i.e(75560),i.e(66144),i.e(5428),i.e(59490),i.e(53418),i.e(89178),i.e(26904),i.e(44158),i.e(83635),i.e(55736),i.e(37078)]).then(i.bind(i,824306)).then((i=>{var r,n;const a=new i.GeneralChartPropertiesDialogRenderer({chartWidgetCollection:t,propertyPages:o,activePageId:this._activePageId,model:s.model()});return null===(r=this._dialog)||void 0===r||r.hide(),null===(n=this._dialog)||void 0===n||n.visible().unsubscribe(this._subscribe),this._dialog=a,a.visible().subscribe(this._subscribe),a.show(e),this._activePageId=void 0,a}))))}hide(){var e;null===(e=this._dialog)||void 0===e||e.hide()}isVisible(){return this.visible().value()}focusOnText(){}setActivePage(e){this._activePageId=e}}},826939:(e,t,i)=>{"use strict";i.d(t,{WATCHLIST_WIDGET_ID:()=>s});const s="watchlist-widget"},305514:(e,t,i)=>{"use strict";i.d(t,{showWatchListsDialog:()=>n});var s=i(999138);let o;class r extends s.DialogRenderer{constructor(){super(...arguments),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)}}show(e){this._load(e).then((e=>e.show()))}hide(){var e,t;null===(e=this._dialog)||void 0===e||e.hide(),null===(t=this._dialog)||void 0===t||t.visible().unsubscribe(this._subscribe)}static getInstance(){return o||(o=new r),o}_load(e){return Promise.all([i.e(41953),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(67158),i.e(29800),i.e(23141),i.e(95083),i.e(72197),i.e(88015),i.e(24125),i.e(49325),i.e(21251),i.e(93523),i.e(98734),i.e(32175),i.e(30614),i.e(39963),i.e(94106),i.e(63168),i.e(44066),i.e(15440),i.e(32736),i.e(65891),i.e(39967),i.e(43386),i.e(49745),i.e(49279),i.e(11858),i.e(12366),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(83147),i.e(75560),i.e(13520),i.e(17013),i.e(68087),i.e(90361),i.e(67464),i.e(26363),i.e(57945)]).then(i.bind(i,370006)).then((t=>{var i,s;return null===(i=this._dialog)||void 0===i||i.hide(),null===(s=this._dialog)||void 0===s||s.visible().unsubscribe(this._subscribe),this._dialog=new t.WatchListsDialogRenderer(e),
this._dialog.visible().subscribe(this._subscribe),this._dialog}))}}function n(e){r.getInstance().show(e)}},104436:(e,t,i)=>{"use strict";var s;i.d(t,{ToolboxType:()=>s}),function(e){e[e.Delete=0]="Delete"}(s||(s={}))},263844:e=>{e.exports={chartsSplitter:"chartsSplitter-L0xapso5",hovered:"hovered-L0xapso5","i-active":"i-active-L0xapso5"}},945982:e=>{e.exports={"css-value-pane-controls-padding-left":"1px","css-value-pane-controls-padding-right":"4px"}},656479:e=>{e.exports={paneSeparator:"paneSeparator-uqBaC1Ki",handle:"handle-uqBaC1Ki",hovered:"hovered-uqBaC1Ki",active:"active-uqBaC1Ki"}},858994:e=>{e.exports={"css-value-small-size":"18px","css-value-medium-size":"22px","css-value-large-size":"28px","css-value-border-radius-small-size":"9px","css-value-border-radius-medium-size":"11px","css-value-border-radius-large-size":"8px",statuses:"statuses-Lgtz1OtS",statusItem:"statusItem-Lgtz1OtS",statuses_hidden:"statuses_hidden-Lgtz1OtS",small:"small-Lgtz1OtS",medium:"medium-Lgtz1OtS",large:"large-Lgtz1OtS",blinking:"blinking-Lgtz1OtS","blinking-animation":"blinking-animation-Lgtz1OtS",marketStatusOpen:"marketStatusOpen-Lgtz1OtS",marketStatusClose:"marketStatusClose-Lgtz1OtS",marketStatusPre:"marketStatusPre-Lgtz1OtS",marketStatusPost:"marketStatusPost-Lgtz1OtS",marketStatusHoliday:"marketStatusHoliday-Lgtz1OtS",marketStatusDelisted:"marketStatusDelisted-Lgtz1OtS",marketStatusExpired:"marketStatusExpired-Lgtz1OtS",marketStatusCustom:"marketStatusCustom-Lgtz1OtS",invalidSymbol:"invalidSymbol-Lgtz1OtS",replayModeAutoPlay:"replayModeAutoPlay-Lgtz1OtS",replayModePause:"replayModePause-Lgtz1OtS",replayModePointSelect:"replayModePointSelect-Lgtz1OtS","blinking-animation-custom":"blinking-animation-custom-Lgtz1OtS",notAccurate:"notAccurate-Lgtz1OtS",openedInPineEditor:"openedInPineEditor-Lgtz1OtS",openedInDetachedPineEditor:"openedInDetachedPineEditor-Lgtz1OtS",delay:"delay-Lgtz1OtS",eod:"eod-Lgtz1OtS",tvCalculatedPair:"tvCalculatedPair-Lgtz1OtS",dataProblemHigh:"dataProblemHigh-Lgtz1OtS",dataProblemLow:"dataProblemLow-Lgtz1OtS",updateAvailable:"updateAvailable-Lgtz1OtS"}},246255:(e,t,i)=>{"use strict";i.d(t,{ChartSession:()=>l});var s=i(942634),o=i(650151),r=i(375397),n=i(79342);const a=(0,i(338619).getLogger)("ChartApi.AbstractSession");class l extends class{constructor(e,t,i){this._isConnected=new r.WatchedValue(!1),this._state=0,this._isConnectForbidden=!1,this._sessionId="",this._sessionIdChanged=new s.Delegate,this._chartApi=e,this._sessionPrefix=t,this._shouldReconnectAfterCriticalError=i}destroy(){this._logNormal("Destroying session"),this._isConnected.unsubscribe(),this.disconnect(),this._sessionIdChanged.destroy(),delete this._chartApi,this._logNormal("Session has been destroyed")}isConnected(){return this._isConnected}sessionId(){return this._sessionId}onSessionIdChanged(){return this._sessionIdChanged}connect(){0===this._state&&((0,o.assert)(!this._isConnectForbidden,"Cannot call connect because it is forbidden at this moment"),this._setSessionId(`${this._sessionPrefix}_${(0,n.randomHash)()}`),
this._logNormal("Connecting session - wait until transport stay connected"),this._state=1,this._chartApi.createSession(this._sessionId,this))}disconnect(){0!==this._state&&((0,o.assert)(""!==this._sessionId,"sessionId must not be invalid"),this._logNormal("Disconnecting session..."),this._forbidConnectWhile((()=>{this._chartApi.connected()&&this._sendRemoveSession(),this._processDestroyingOnServer()})))}onMessage(e){switch(e.method){case"connected":return void this._onChartApiConnected();case"disconnected":return void this._onChartApiDisconnected();case"critical_error":const t=String(e.params[0]),i=String(e.params[1]);return void this._onCriticalError(t,i)}this._onMessage(e)}serverTime(){return this._chartApi.serverTime()}_getChartApi(){return this._chartApi}_generateLogMessage(e){return`[${this._sessionId}] ${e}`}_onCriticalError(e,t){this._logError(`Critical error. Reason=${e}, info=${t}.`),this._forbidConnectWhile((()=>{this._processDestroyingOnServer()})),this._shouldReconnectAfterCriticalError?(this._logNormal("Reconnecting after critical error..."),this.connect()):this._logNormal("Reconnecting after critical error skipped")}_onChartApiConnected(){(0,o.assert)(1===this._state,"Session is not registered"),this._logNormal("Transport is connected. Creating session on the server"),this._sendCreateSession(),this._state=2,this._isConnected.setValue(!0)}_onChartApiDisconnected(){this._logNormal("Transport is disconnected. Reconnecting..."),this._forbidConnectWhile((()=>{this._processDestroyingOnServer()})),this.connect()}_setSessionId(e){const t=this._sessionId;this._logNormal(`Changing sessionId: old=${t}, new=${e}`),this._sessionId=e,this._sessionIdChanged.fire(e,t)}_logNormal(e){a.logNormal(this._generateLogMessage(e))}_logError(e){a.logError(this._generateLogMessage(e))}_processDestroyingOnServer(){this._state=0,this._isConnected.setValue(!1),this._chartApi.removeSession(this._sessionId),this._setSessionId("")}_forbidConnectWhile(e){this._isConnectForbidden=!0,e(),this._isConnectForbidden=!1}}{constructor(e,t=!1){super(e,"cs",!1),this._sessionDisabled=!1,this._handler=null,this._criticalError=new s.Delegate,this._symbolResolveMap=new Map,this._lastSymbolResolveInfoMap=new Map,this._disableStatistics=t}destroy(){this._criticalError.destroy(),this._handler=null,this._symbolResolveMap.clear(),super.destroy()}switchTimezone(e){return this._getChartApi().switchTimezone(this.sessionId(),e)}defaultResolutions(){return this._getChartApi().defaultResolutions()}availableCurrencies(){return this._getChartApi().availableCurrencies()}availableUnits(){return this._getChartApi().availableUnits()}availablePriceSources(e){return this._getChartApi().availablePriceSources(e)}resolveSymbol(e,t,i){if(this._symbolResolveMap.has(t)){const[e,s]=this._symbolResolveMap.get(t);return Array.isArray(s)?s.push(i):s.then(i),e}{const s=[i];return this._getChartApi().resolveSymbol(this.sessionId(),e,t,(i=>{if("symbol_error"===i.method)this._symbolResolveMap.delete(t);else{this._symbolResolveMap.set(t,[e,Promise.resolve(i)]);const[,s]=i.params,o={
pro_name:s.pro_name,ticker:s.ticker};this._lastSymbolResolveInfoMap.set(t,o),o.pro_name&&this._lastSymbolResolveInfoMap.set(o.pro_name,o),s.full_name&&this._lastSymbolResolveInfoMap.set(s.full_name,o),o.ticker&&this._lastSymbolResolveInfoMap.set(o.ticker,o)}s.forEach((e=>e(i)))})),this._symbolResolveMap.set(t,[e,s]),e}}requestFirstBarTime(e,t,i){return this._getChartApi().requestFirstBarTime(this.sessionId(),e,t,i)}lastSymbolResolveInfo(e){var t;return null!==(t=this._lastSymbolResolveInfoMap.get(e))&&void 0!==t?t:null}createSeries(e,t,i,s,o,r,n){return this._getChartApi().createSeries(this.sessionId(),e,t,i,s,o,r,n)}modifySeries(e,t,i,s,o,r,n){return this._getChartApi().modifySeries(this.sessionId(),e,t,i,s,o,r,n)}removeSeries(e){return!!this.isConnected().value()&&this._getChartApi().removeSeries(this.sessionId(),e)}requestMoreData(e,t,i){return"number"==typeof e?this._getChartApi().requestMoreData(this.sessionId(),e):this._getChartApi().requestMoreData(this.sessionId(),e,t,i)}requestMoreTickmarks(e,t,i){return this._getChartApi().requestMoreTickmarks(this.sessionId(),e,t,i)}setFutureTickmarksMode(e){return this._getChartApi().setFutureTickmarksMode(this.sessionId(),e)}canCreateStudy(e,t){return this._getChartApi().canCreateStudy(this.sessionId(),e,t)}getStudyCounter(){return this._getChartApi().getStudyCounter(this.sessionId())}getFundamentalCounter(){return this._getChartApi().getFundamentalCounter(this.sessionId())}createStudy(e,t,i,s,o,r,n){return this._getChartApi().createStudy(this.sessionId(),e,t,i,s,o,r,n)}modifyStudy(e,t,i,s,o){return this._getChartApi().modifyStudy(this.sessionId(),e,t,i,s,o)}notifyStudy(e,t,i){return this._getChartApi().notifyStudy(this.sessionId(),e,t,i)}removeStudy(e){return this._getChartApi().removeStudy(this.sessionId(),e)}createPointset(e,t,i,s,o,r){return this._getChartApi().createPointset(this.sessionId(),e,t,i,s,o,r)}modifyPointset(e,t,i,s){return this._getChartApi().modifyPointset(this.sessionId(),e,t,i,s)}removePointset(e){return this._getChartApi().removePointset(this.sessionId(),e)}setVisibleTimeRange(e,t,i,s,o,r){0}criticalError(){return this._criticalError}connect(e=null){null!==e&&(this._handler=e),this._symbolResolveMap.clear(),super.connect()}setHandler(e){this._handler=e}connected(){return this.isConnected().value()&&!this._sessionDisabled}disable(){this._sessionDisabled=!0}chartApi(){return this._getChartApi()}_sendCreateSession(){Object.keys(this).forEach((e=>{/^(s|st|symbol_)\d+$/.test(e)&&delete this[e]})),this._getChartApi().chartCreateSession(this.sessionId(),this._disableStatistics)}_sendRemoveSession(){this._getChartApi().chartDeleteSession(this.sessionId())}_onMessage(e){this._handler&&this._handler(e)}_onCriticalError(e,t){this._criticalError.fire(e,t),super._onCriticalError(e,t)}}},271868:(e,t,i)=>{"use strict";i.d(t,{reconnectChartApi:()=>s,setBroker:()=>o});i(668159);function s(e){const t=window.ChartApiInstance;window.is_authenticated&&(t.disconnect(),e&&t.authTokenManager().reset(),setTimeout((()=>t.connect()),500))}function o(e){
window.ChartApiInstance.setBroker(e)}},430777:(e,t,i)=>{"use strict";i.d(t,{availableTimezones:()=>r,timezoneIsAvailable:()=>l,timezoneTitle:()=>c});var s=i(601526),o=i(499625);const r=(0,o.getAvailableTimezones)(),n=new Map;r.forEach((e=>{n.set(e.id,!0)}));const a=new Map;o.specialTimezones.concat(o.customTimezones).forEach((e=>{a.set(e.id,!0)}));function l(e){return n.has(e)}function c(e){for(const{id:t,title:i}of o.customTimezones)if(t===e){return`${i} (${(0,s.parseTzOffset)(e).string})`}for(const{id:t,title:i}of r)if(t===e)return`${i}`;return e}},67326:(e,t,i)=>{"use strict";function s(e){return"economic"===e}i.d(t,{isNonTradableSymbolType:()=>s})},499625:(e,t,i)=>{"use strict";i.d(t,{customTimezones:()=>n,getAvailableTimezones:()=>l,specialTimezones:()=>r});var s=i(444372),o=i(601526);const r=[{id:"Etc/UTC",get title(){return s.t(null,void 0,i(901833))}},{id:"exchange",get title(){return s.t(null,void 0,i(786905))}}],n=[{id:"Africa/Cairo",get title(){return s.t(null,void 0,i(365736))},offset:0},{id:"Africa/Casablanca",get title(){return s.t(null,void 0,i(770409))},offset:0},{id:"Africa/Johannesburg",get title(){return s.t(null,void 0,i(239585))},offset:0},{id:"Africa/Lagos",get title(){return s.t(null,void 0,i(919931))},offset:0},{id:"Africa/Nairobi",get title(){return s.t(null,void 0,i(740977))},offset:0},{id:"Africa/Tunis",get title(){return s.t(null,void 0,i(21007))},offset:0},{id:"America/Anchorage",get title(){return s.t(null,void 0,i(942630))},offset:0},{id:"America/Argentina/Buenos_Aires",get title(){return s.t(null,void 0,i(325282))},offset:0},{id:"America/Bogota",get title(){return s.t(null,void 0,i(273905))},offset:0},{id:"America/Caracas",get title(){return s.t(null,void 0,i(930948))},offset:0},{id:"America/Chicago",get title(){return s.t(null,void 0,i(72452))},offset:0},{id:"America/El_Salvador",get title(){return s.t(null,void 0,i(255502))},offset:0},{id:"America/Juneau",get title(){return s.t(null,void 0,i(367560))},offset:0},{id:"America/Lima",get title(){return s.t(null,void 0,i(759444))},offset:0},{id:"America/Los_Angeles",get title(){return s.t(null,void 0,i(28733))},offset:0},{id:"America/Mexico_City",get title(){return s.t(null,void 0,i(773332))},offset:0},{id:"America/New_York",get title(){return s.t(null,void 0,i(940544))},offset:0},{id:"America/Phoenix",get title(){return s.t(null,void 0,i(114055))},offset:0},{id:"America/Santiago",get title(){return s.t(null,void 0,i(630231))},offset:0},{id:"America/Sao_Paulo",get title(){return s.t(null,void 0,i(991912))},offset:0},{id:"America/Toronto",get title(){return s.t(null,void 0,i(110095))},offset:0},{id:"America/Vancouver",get title(){return s.t(null,void 0,i(632838))},offset:0},{id:"US/Mountain",get title(){return s.t(null,void 0,i(327358))},offset:0},{id:"Asia/Almaty",get title(){return s.t(null,void 0,i(398128))},offset:0},{id:"Asia/Ashkhabad",get title(){return s.t(null,void 0,i(763627))},offset:0},{id:"Asia/Bahrain",get title(){return s.t(null,void 0,i(290594))},offset:0},{id:"Asia/Bangkok",get title(){return s.t(null,void 0,i(947045))},
offset:0},{id:"Asia/Chongqing",get title(){return s.t(null,void 0,i(850349))},offset:0},{id:"Asia/Colombo",get title(){return s.t(null,void 0,i(10871))},offset:0},{id:"Asia/Dhaka",get title(){return s.t(null,void 0,i(724959))},offset:0},{id:"Asia/Dubai",get title(){return s.t(null,void 0,i(523650))},offset:0},{id:"Asia/Ho_Chi_Minh",get title(){return s.t(null,void 0,i(334491))},offset:0},{id:"Asia/Hong_Kong",get title(){return s.t(null,void 0,i(248861))},offset:0},{id:"Asia/Jakarta",get title(){return s.t(null,void 0,i(414995))},offset:0},{id:"Asia/Jerusalem",get title(){return s.t(null,void 0,i(436057))},offset:0},{id:"Asia/Karachi",get title(){return s.t(null,void 0,i(70913))},offset:0},{id:"Asia/Kathmandu",get title(){return s.t(null,void 0,i(454533))},offset:0},{id:"Asia/Kolkata",get title(){return s.t(null,void 0,i(31561))},offset:0},{id:"Asia/Kuala_Lumpur",get title(){return s.t(null,void 0,i(538561))},offset:0},{id:"Asia/Kuwait",get title(){return s.t(null,void 0,i(76614))},offset:0},{id:"Asia/Manila",get title(){return s.t(null,void 0,i(348991))},offset:0},{id:"Asia/Muscat",get title(){return s.t(null,void 0,i(909865))},offset:0},{id:"Asia/Nicosia",get title(){return s.t(null,void 0,i(94600))},offset:0},{id:"Asia/Qatar",get title(){return s.t(null,void 0,i(328756))},offset:0},{id:"Asia/Riyadh",get title(){return s.t(null,void 0,i(837974))},offset:0},{id:"Asia/Seoul",get title(){return s.t(null,void 0,i(326820))},offset:0},{id:"Asia/Shanghai",get title(){return s.t(null,void 0,i(601852))},offset:0},{id:"Asia/Singapore",get title(){return s.t(null,void 0,i(977377))},offset:0},{id:"Asia/Taipei",get title(){return s.t(null,void 0,i(511034))},offset:0},{id:"Asia/Tehran",get title(){return s.t(null,void 0,i(806686))},offset:0},{id:"Asia/Tokyo",get title(){return s.t(null,void 0,i(769122))},offset:0},{id:"Asia/Yangon",get title(){return s.t(null,void 0,i(553168))},offset:0},{id:"Atlantic/Reykjavik",get title(){return s.t(null,void 0,i(813386))},offset:0},{id:"Australia/Adelaide",get title(){return s.t(null,void 0,i(437265))},offset:0},{id:"Australia/Brisbane",get title(){return s.t(null,void 0,i(579336))},offset:0},{id:"Australia/Perth",get title(){return s.t(null,void 0,i(724436))},offset:0},{id:"Australia/Sydney",get title(){return s.t(null,void 0,i(531622))},offset:0},{id:"Europe/Amsterdam",get title(){return s.t(null,void 0,i(936485))},offset:0},{id:"Europe/Athens",get title(){return s.t(null,void 0,i(373702))},offset:0},{id:"Europe/Belgrade",get title(){return s.t(null,void 0,i(271797))},offset:0},{id:"Europe/Berlin",get title(){return s.t(null,void 0,i(764313))},offset:0},{id:"Europe/Bratislava",get title(){return s.t(null,void 0,i(270876))},offset:0},{id:"Europe/Brussels",get title(){return s.t(null,void 0,i(991499))},offset:0},{id:"Europe/Bucharest",get title(){return s.t(null,void 0,i(633672))},offset:0},{id:"Europe/Budapest",get title(){return s.t(null,void 0,i(20313))},offset:0},{id:"Europe/Copenhagen",get title(){return s.t(null,void 0,i(538917))},offset:0},{id:"Europe/Dublin",get title(){
return s.t(null,void 0,i(479716))},offset:0},{id:"Europe/Helsinki",get title(){return s.t(null,void 0,i(348203))},offset:0},{id:"Europe/Istanbul",get title(){return s.t(null,void 0,i(478326))},offset:0},{id:"Europe/Lisbon",get title(){return s.t(null,void 0,i(53375))},offset:0},{id:"Europe/London",get title(){return s.t(null,void 0,i(119439))},offset:0},{id:"Europe/Luxembourg",get title(){return s.t(null,void 0,i(681038))},offset:0},{id:"Europe/Madrid",get title(){return s.t(null,void 0,i(52066))},offset:0},{id:"Europe/Malta",get title(){return s.t(null,void 0,i(638365))},offset:0},{id:"Europe/Moscow",get title(){return s.t(null,void 0,i(564039))},offset:0},{id:"Europe/Oslo",get title(){return s.t(null,void 0,i(375722))},offset:0},{id:"Europe/Paris",get title(){return s.t(null,void 0,i(161879))},offset:0},{id:"Europe/Prague",get title(){return s.t(null,void 0,i(81248))},offset:0},{id:"Europe/Riga",get title(){return s.t(null,void 0,i(594022))},offset:0},{id:"Europe/Rome",get title(){return s.t(null,void 0,i(152961))},offset:0},{id:"Europe/Stockholm",get title(){return s.t(null,void 0,i(86716))},offset:0},{id:"Europe/Tallinn",get title(){return s.t(null,void 0,i(779995))},offset:0},{id:"Europe/Vienna",get title(){return s.t(null,void 0,i(23160))},offset:0},{id:"Europe/Vilnius",get title(){return s.t(null,void 0,i(960534))},offset:0},{id:"Europe/Warsaw",get title(){return s.t(null,void 0,i(505959))},offset:0},{id:"Europe/Zurich",get title(){return s.t(null,void 0,i(362859))},offset:0},{id:"Pacific/Auckland",get title(){return s.t(null,void 0,i(866103))},offset:0},{id:"Pacific/Chatham",get title(){return s.t(null,void 0,i(36549))},offset:0},{id:"Pacific/Fakaofo",get title(){return s.t(null,void 0,i(298549))},offset:0},{id:"Pacific/Honolulu",get title(){return s.t(null,void 0,i(879668))},offset:0},{id:"Pacific/Norfolk",get title(){return s.t(null,void 0,i(467891))},offset:0}];function a(e,t,i){const s=function(e){return e.map((e=>{const{id:t}=e,{string:i,offset:s}=(0,o.parseTzOffset)(t);return{id:t,offset:s,get title(){return`(${i}) ${e.title}`}}}))}(e),r=i.filter((({alias:e})=>Boolean(e))).map((e=>{const{alias:t,id:i}=e,{string:s,offset:r}=(0,o.parseTzOffset)(t);return{id:i,offset:r,get title(){return`(${s}) ${e.title}`},alias:t}})),n=function(e){return e.sort(((e,t)=>{const i=e.offset-t.offset;return 0!==i?i:e.title.localeCompare(t.title)}))}(s.concat(r));return t.concat(n)}function l(){return a(n,r,[])}},314824:(e,t,i)=>{"use strict";i.d(t,{ActionWithStandardIcon:()=>r});var s=i(691371),o=i(18343);class r extends s.Action{constructor(e){var t,i;const{options:s,customActionOptions:r}=e;s.iconId&&(s.icon=null!==(t=s.icon)&&void 0!==t?t:o.icons.get(s.iconId)),r&&r.iconId&&(r.icon=null!==(i=r.icon)&&void 0!==i?i:o.icons.get(r.iconId)),super(e)}}},18343:(e,t,i)=>{"use strict";i.d(t,{icons:()=>E})
;var s=i(539706),o=i(472382),r=i(198083),n=i(80465),a=i(748040),l=i(324020),c=i(845437),d=i(428026),h=i(625923),u=i(270068),p=i(789795),_=i(439970),m=i(808757),g=i(133736),S=i(634369),v=i(139267),f=i(993544),b=i(484959),y=i(437924),C=i(677067),w=i(416911),T=i(225191),P=i(854190),M=i(706862),x=i(397874),I=i(902872),L=i(201457),A=i(593379);let k=[["Chart.Reset",v],["Chart.RemoveSelectedObject",f],["Settings",S],["Chart.Hide",b],["Chart.SymbolInfo",y],["Chart.VisualOrder",C],["Chart.ShowObject",w],["Chart.PriceScale",T],["Chart.Move",P],["Chart.ApplyIndicator",M],["Chart.UnlockObject",x],["Chart.LockObject",I],["Chart.Clone",L],["Chart.AddHorzLine",A]];k=k.concat([["TextNote.Add",l],["Watchlist.AddSymbol",c],["Watchlist.CreateNew",c],["Chart.Financials",d],["Alert.Add",h],["Alert.Edit",u],["Alert.Restart",p],["Alert.Stop",_],["Alert.EventsExport",m],["Alert.Clear",g]]),k=k.concat([["Chart.ShowDataWindow",s],["Trading.Sell",o],["Trading.Buy",r],["ObjectsTree.CreateGroup",n],["ObjectsTree.RenameItem",a]]);const E=new Map(k)},100716:(e,t,i)=>{"use strict";var s;i.d(t,{AlertEditorAbortReason:()=>s}),function(e){e.AlertIsInvalid="alert-is-invalid",e.AlertsMaintenance="alerts-maintenance",e.ChartModelNotFound="chart-model-not-found",e.IsAlreadyPresent="is-already-present",e.MainSeriesIsATR="main-series-is-atr",e.MainSeriesIsPercentageLTP="main-series-is-percentage-ltp",e.MainSeriesIsInReplay="main-series-is-in-replay",e.MainSeriesIsOffline="main-series-is-offline",e.SourceIsDangerous="source-is-dangerous",e.SymbolInfoTimeout="symbol-info-timeout",e.SymbolIsInvalid="symbol-is-invalid",e.SymbolCurrencyConverted="symbol-currency-converted",e.SymbolUnitConverted="symbol-unit-converted",e.SymbolCurrencyAndUnitConverted="symbol-currency-and-unit-converted",e.SymbolIsEconomics="symbol-is-economics",e.UnsupportedResolution="unsupported-resolution",e.ManualAbort="manual-abort",e.MisleadingPriceScale="misleading-price-scale",e.ResolutionIsTicks="resolution-is-ticks"}(s||(s={}))},848891:(e,t,i)=>{"use strict";i.d(t,{Animation:()=>n});var s=i(930203),o=i(939656);const r={duration:250,easing:s.easingFunc.easeOutCubic};class n{constructor(e){this._onFinishCalled=!1,this._options={...r,...e},this._startTime=performance.now()}getStartPosition(){return this._options.from}getPosition(e){const t=this._calculateProgress(e);return 1===t?(this._options.onFinish&&!this._onFinishCalled&&(this._options.onFinish(!0),this._onFinishCalled=!0),this._options.to):(0,o.lerp)(this._options.from,this._options.to,this._options.easing(t))}finished(e){return 1===this._calculateProgress(e)}onFinish(e){var t,i;this._onFinishCalled||(null===(i=(t=this._options).onFinish)||void 0===i||i.call(t,e),this._onFinishCalled=!0)}_calculateProgress(e){const t=e-this._startTime;return t>=this._options.duration?1:t/this._options.duration}}},898192:(e,t,i)=>{"use strict";i.d(t,{clipboardDataForSources:()=>l,isLineToolClipboardData:()=>a});var s=i(650151),o=i(287741),r=i(434396),n=i(465836);function a(e){return"drawing"===e.type}function l(e,t){if(1===t.length&&(0,
r.isStudy)(t[0])){const e=t[0];return{title:e.title(o.TitleDisplayTarget.StatusLine),sources:[{source:(0,s.ensureNotNull)(e.state()),type:"study"}]}}const i={sources:[],title:""};return i.sources=t.filter((e=>e.copiable()&&(0,n.isLineTool)(e))).map((t=>{const i={type:"drawing",geometry:t.geometry(),source:{...t.state(!1),points:t.normalizedPoints()},modelId:e};return delete i.source.alertId,i})),i.sources.length>0?(1===i.sources.length?i.title=t[0].title(o.TitleDisplayTarget.StatusLine):i.title="Drawings",i):null}},895366:(e,t,i)=>{"use strict";i.d(t,{ChartHotkeysListener:()=>v,globalEnvironmentState:()=>S,modifierPressed:()=>g,shiftPressed:()=>m});var s,o,r,n=i(799786),a=i(470316),l=i(515312),c=i(375397),d=i(970427);const h=new c.WatchedValue(Boolean((null!==(s=n.pressedKeys.value())&&void 0!==s?s:0)&a.Modifiers.Shift)),u=new c.WatchedValue(Boolean((null!==(o=n.pressedKeys.value())&&void 0!==o?o:0)&a.Modifiers.Mod)),p=new c.WatchedValue(Boolean((null!==(r=n.pressedKeys.value())&&void 0!==r?r:0)&a.Modifiers.Alt)),_=[a.Modifiers.None,a.Modifiers.Alt,a.Modifiers.Mod,a.Modifiers.Alt+a.Modifiers.Shift];function m(){return h}function g(){return u}function S(){return new d.EnvironmentState({altKey:p.value(),ctrlKey:g().value(),metaKey:g().value(),shiftKey:m().value()})}n.pressedKeys.subscribe(((e=0)=>{h.setValue(Boolean(e&a.Modifiers.Shift)),u.setValue(Boolean(e&a.Modifiers.Mod)),p.setValue(Boolean(e&a.Modifiers.Alt))}));class v{constructor(e,t){this._pressedKeyCode=null,this._boundKeydownHandler=null,this._boundKeyupHandler=null,this._chartWidget=e,this._parent=t,this._boundKeydownHandler=this._keydownHandler.bind(this),this._boundKeyupHandler=this._keyupHandler.bind(this),this._parent.ownerDocument.addEventListener("keydown",this._boundKeydownHandler),this._parent.ownerDocument.addEventListener("keyup",this._boundKeyupHandler)}destroy(){null!==this._boundKeydownHandler&&(this._parent.ownerDocument.removeEventListener("keydown",this._boundKeydownHandler),this._boundKeydownHandler=null),null!==this._boundKeyupHandler&&(this._parent.ownerDocument.removeEventListener("keyup",this._boundKeyupHandler),this._boundKeyupHandler=null)}_keydownHandler(e){this._chartWidget.hasModel()&&window.document.activeElement===window.document.body&&this._chartWidget.isActive().value()&&(e.defaultPrevented||(this._handleMoveDrawingsKeyDown(e)||this._handleScrollKeyDown(e)||this._handleZoomKeyDown(e))&&e.preventDefault())}_keyupHandler(e){this._chartWidget.hasModel()&&this._handleScrollKeyUp(e)}_handleMoveDrawingsKeyDown(e){const t=255&(0,a.hashFromEvent)(e),i=this._chartWidget.model();switch(t){case 37:return i.moveSelectedToolsLeft();case 39:return i.moveSelectedToolsRight();case 38:return i.moveSelectedToolsUp();case 40:return i.moveSelectedToolsDown()}return!1}_handleScrollKeyDown(e){if(null!==this._pressedKeyCode)return!1;const t=(0,a.hashFromEvent)(e),i=255&t,s=(0,a.modifiersFromEvent)(e);let o;if(37===i)o=1;else{if(39!==i)return!1;o=-1}return!(a.isMacKeyboard&&s===a.Modifiers.Mod||!_.includes(s))&&(!(0,
l.isNativeUIInteraction)(t,e.target)&&(this._pressedKeyCode=i,s===a.Modifiers.None?this._chartWidget.scrollHelper().moveByBar(o):s===a.Modifiers.Alt||s===a.Modifiers.Mod?this._chartWidget.scrollHelper().move(o):-1===o?this._chartWidget.model().timeScale().scrollToRealtime(!0):this._chartWidget.model().timeScale().scrollToFirstBar(),!0))}_handleScrollKeyUp(e){if(null===this._pressedKeyCode)return!1;const t=(0,a.hashFromEvent)(e);if((0,l.isNativeUIInteraction)(t,e.target))return!1;return(255&t)===this._pressedKeyCode&&(this._pressedKeyCode=null,this._chartWidget.scrollHelper().stopMove(),!0)}_handleZoomKeyDown(e){const t=(0,a.hashFromEvent)(e),i=255&t;if((0,a.modifiersFromEvent)(e)!==a.Modifiers.Mod||(0,l.isNativeUIInteraction)(t,e.target))return!1;const s=this._chartWidget.model();if(38===i)s.zoomIn();else{if(40!==i)return!1;s.zoomOut()}return!0}}},317612:(e,t,i)=>{"use strict";i.r(t),i.d(t,{activeLinkingGroupWV:()=>cu,allInitialModelsCreated:()=>Gh,allInitialSymbolsResolved:()=>Uh,allLinkingGroupsWV:()=>hu,applyIndicatorToAllChartsImpl:()=>$d,applyIndicatorsToAllChartsImpl:()=>Yd,applyLineToolUpdateNotificationImpl:()=>ih,applyStudiesOverrides:()=>xu,applyThemeImpl:()=>Kh,chartsSymbolsImpl:()=>nh,checkProFeatureImpl:()=>qh,combinedTrackTimeLock:()=>gu,computeContentBoxImpl:()=>Sh,copyScreenshotToClipboard:()=>uh,createBroadcastChannel:()=>Fh,createChartStorageSubscriptionsIfRequired:()=>ah,createChartWidgetCollectionNewsNotifier:()=>lh,createClipboardHandler:()=>oh,createLeftBottomChartWidgetWV:()=>_h,deserializedChartIds:()=>eh,destroyBroadcastChannel:()=>Hh,downloadScreenshot:()=>hh,generateNewChartId:()=>Mh,getAllLinkingGroups:()=>du,getChartWidgetsForIntervalLock:()=>nu,getClientSnapshot:()=>gh,getLinkingGroupCharts:()=>uu,getSnapshot:()=>mh,getStateForChartImpl:()=>Qd,getVisuallyAdjacentDefImpl:()=>Th,handleConnectionLimitReachedChanged:()=>_u,handleDateRangeLockChange:()=>Qh,handleInternalDateRangeLockChange:()=>Jh,handleInternalIntervalLockChange:()=>$h,handleInternalSymbolLockChange:()=>Zh,handleInternalTrackTimeLockChange:()=>eu,handleIntervalLockChange:()=>Xh,handleSymbolLockChange:()=>Yh,handleTrackTimeLockChange:()=>tu,hideChartImpl:()=>Ah,lineToolsAndGroupsDTOsImpl:()=>Jd,removeChartWidgetSubscriptionsImpl:()=>Eh,resetLayoutSizesImpl:()=>bh,resetLineToolsInvalidatedImpl:()=>th,setBrokerImpl:()=>rh,setChartLayoutWithUndoImpl:()=>jh,setChartStyleToWidget:()=>ou,setLayoutImpl:()=>Oh,setResolution:()=>au,setSymbol:()=>su,setSymbolAll:()=>iu,someOfWidgetsAreInSelectingReplayPointMode:()=>mu,stateImpl:()=>Pu,subscribeToCompletedEventForDateRangeUpdate:()=>Su,subscribeToEventsForDateRangeSync:()=>yu,syncChartsDateRangesWithActiveChartRange:()=>Tu,syncCrosshairImpl:()=>Wh,syncScrollImpl:()=>zh,takeScreenshot:()=>ch,takeServerScreenshot:()=>dh,unloadUnusedChartsImpl:()=>Dh,unsubscribeFromEventsForDateRangeSync:()=>Cu,updateLayoutImpl:()=>wh,updateLayoutPartialImpl:()=>Ch,updateLinkingGroupCharts:()=>pu});var s=i(650151),o=i(86441),r=i(338619),n=i(444372),a=i(912445),l=i(638456),c=i(370407),d=i(764829)
;function h(e){const t={};return{promise:new Promise(((i,s)=>{e.subscribe(t,i,!0)})),destroy:()=>{e.unsubscribeAll(t)}}}var u=i(375397),p=i(26829),_=i(669763);class m extends _.UndoCommand{constructor(e,t){super(null),this._chartModel=e,this._targetIndex=t}redo(){const e=this._chartModel.createPane(this._targetIndex,void 0,this._paneId);this._paneId=e.id()}undo(){const e=(0,s.ensureDefined)(this._paneId),t=this._chartModel.panes().find((t=>t.id()===e));void 0!==t&&this._chartModel.removePane(t)}createdPaneId(){return this._paneId}}class g extends _.UndoCommand{constructor(e,t,i,s){super(s),this._setter=e,this._oldValue=t,this._newValue=i}redo(){this._setter(this._newValue)}undo(){this._setter(this._oldValue)}}class S extends g{constructor(e,t,i,s){super((e=>this._vwState.setValue(e)),t,i,s),this._vwState=e}}var v=i(433524),f=i(963239),b=i(793993);const y=(0,r.getLogger)("Clipboard");class C{constructor(e){this._e=e}write(e){return(0,f.writeImpl)(this._toRaw(e),this._e)}_toRaw(e){const t={files:[]};t.text=e.text,void 0!==e.app?t.html=this._serializeAppData(e.app,e.text):e.html&&(t.html=e.html);for(const i of e.files||[])t.files.push(i);return t}_serializeAppData(e,t){return`<meta charset="utf-8"><span data-tradingview-clip="${(0,v.htmlEscape)(e)}">${t?(0,v.htmlEscape)(t.slice(0,256)):"&#128200;"}</span>`}}class w{constructor(e){this._e=e}async read(){this._e&&0===this._e.eventPhase&&(y.logWarn("Cannot use an already dispatched ClipboardEvent for reading"),this._e=null);const e=this._e?this._readUsingEvent(this._e):await this._readUsingApi();return this._fromRaw(e)}_readUsingEvent(e){const t=(0,s.ensure)(e.clipboardData);e.preventDefault();const i={files:[]};for(let e=0;e<t.files.length;e++)i.files.push(t.files[e]);for(let e=0;e<t.items.length;e++){const s=t.items[e];"string"===s.kind&&("text/plain"===s.type?i.text=t.getData(s.type):"text/html"===s.type?i.html=t.getData(s.type):i.files.push(new Blob([t.getData(s.type)],{type:s.type})))}return i}async _readUsingApi(){const e=(0,b.getClipboard)();if(!e||!e.read)throw new DOMException("ClipboardApi is not supported","NotSupportedError");let t,i;const s=[],o=await e.read();for(const e of o)for(const o of e.types)"text/html"===o?t=e.getType(o).then(this._readBlobAsText):"text/plain"===o?i=e.getType(o).then(this._readBlobAsText):s.push(e.getType(o));return{text:await i,html:await t,files:await Promise.all(s)}}_fromRaw(e){const t={};if(void 0!==e.text&&(t.text=e.text),void 0!==e.html){const i=this._parseAppData(e.html);i?t.app=i:t.html=e.html}return e.files.length>0&&(t.files=e.files),t}_parseAppData(e){if(-1===e.slice(0,1024).indexOf("data-tradingview-clip"))return;const t=(new DOMParser).parseFromString(e,"text/html").querySelector("[data-tradingview-clip]");return t?t.getAttribute("data-tradingview-clip")||"":void 0}_readBlobAsText(e){return new Promise(((t,i)=>{const s=new FileReader;s.onloadend=()=>{t(s.result)},s.onerror=()=>{i(s.error)},s.readAsText(e)}))}}var T=i(515312);function P(e){const t=e.target;return null!==t&&1===t.nodeType&&(0,T.isTextEditingField)(t)}
function M(e){const t=e.target;if(null===t)return!1;const i=(t.ownerDocument||t).getSelection();return null!==i&&!i.isCollapsed}class x extends class{constructor(e){this._callbacks=Object.assign({},e),this._boundOnCopy=this._onCopyEv.bind(this),this._boundOnCut=this._onCutEv.bind(this),this._boundOnPaste=this._onPasteEv.bind(this)}listen(){document.addEventListener("copy",this._boundOnCopy),document.addEventListener("cut",this._boundOnCut),document.addEventListener("paste",this._boundOnPaste)}async peek(){if("granted"!==(await navigator.permissions.query({name:"clipboard-read"})).state)throw new Error("clipboard-read is not granted");return new w(null).read()}uiRequestCopy(e){this._callbacks.copyRequested&&this._callbacks.copyRequested(new C(null),e)}uiRequestCut(e){this._callbacks.cutRequested&&this._callbacks.cutRequested(new C(null),e)}uiRequestPaste(e){this._callbacks.pasteRequested&&this._callbacks.pasteRequested(new w(null),e)}destroy(){document.removeEventListener("copy",this._boundOnCopy),document.removeEventListener("cut",this._boundOnCut),document.removeEventListener("paste",this._boundOnPaste)}_onCopyEv(e){e.defaultPrevented||this._callbacks.copyRequested&&this._callbacks.copyRequested(new C(e))}_onCutEv(e){e.defaultPrevented||this._callbacks.cutRequested&&this._callbacks.cutRequested(new C(e))}_onPasteEv(e){e.defaultPrevented||this._callbacks.pasteRequested&&this._callbacks.pasteRequested(new w(e))}}{_onCopyEv(e){if(!P(e)&&!M(e))return super._onCopyEv(e)}_onCutEv(e){if(!P(e)&&!M(e))return super._onCutEv(e)}_onPasteEv(e){if(!P(e))return super._onPasteEv(e)}}const I=()=>Promise.all([i.e(21630),i.e(54389)]).then(i.bind(i,29425));function L(e,t={}){return I().then((i=>i.copyToClipboardImageOfChart(e,t)))}function A(e,t={}){return I().then((i=>i.getImageOfChartSilently(e,t)))}var k=i(936442),E=i(470316),D=i(588948),B=i(219849);const N=(0,r.getLogger)("TimingsMeter.Service"),R=(0,r.getLogger)("TimingsMeter.Stats",{maxCount:160});function O(){return{[B.InvalidationLevel.None]:{count:0,lastTime:0,maxTime:0,totalTime:0},[B.InvalidationLevel.Cursor]:{count:0,lastTime:0,maxTime:0,totalTime:0},[B.InvalidationLevel.Light]:{count:0,lastTime:0,maxTime:0,totalTime:0},[B.InvalidationLevel.Full]:{count:0,lastTime:0,maxTime:0,totalTime:0}}}function V(e,t){e.lastTime=t,e.totalTime+=t,++e.count,t>e.maxTime&&(e.maxTime=t)}function W(e){return e.toFixed(2)}function F(e){const t=e.count;if(0===t)return"no events";const i=e.totalTime/t,s=W(e.maxTime);return`count=${t}, last=${W(e.lastTime)}, max=${s}, avg=${W(i)}`}class H{constructor(e){this._waitDrawStartTime=-1,this._startDrawTime=-1,this._currentDrawLevel=B.InvalidationLevel.Full,this._currentDrawItems=O(),this._currentWaitingItem={count:0,lastTime:0,maxTime:0,totalTime:0},this._dumpTimingsStatsInterval=0,this._logPrefix=`[${e}]`}destroy(){this.stopCollect()}startCollect(){0!==this._dumpTimingsStatsInterval&&(N.logWarn(`${this._logPrefix} Multiple start detected`),this.stopCollect()),this._clearCurrentState(),
this._dumpTimingsStatsInterval=setInterval(this._dumpTimingsStats.bind(this),15e3),N.logNormal(`${this._logPrefix} Collecting started`)}stopCollect(){0!==this._dumpTimingsStatsInterval&&(clearInterval(this._dumpTimingsStatsInterval),this._dumpTimingsStatsInterval=0,N.logNormal(`${this._logPrefix} Collecting stopped. Dumping last state...`),this._dumpTimingsStats())}startWaitingDraw(){this._waitDrawStartTime=window.performance.now()}startDraw(e){this._startDrawTime=window.performance.now(),this._currentDrawLevel=e}stopDraw(){const e=window.performance.now();if(-1===this._startDrawTime||-1===this._waitDrawStartTime)return;const t=this._startDrawTime-this._waitDrawStartTime;V(this._currentWaitingItem,t),this._waitDrawStartTime=-1;const i=e-this._startDrawTime;V(this._currentDrawItems[this._currentDrawLevel],i),this._startDrawTime=-1}_dumpTimingsStats(){const e=[this._logPrefix," awaiting:",F(this._currentWaitingItem),"; cursor:",F(this._currentDrawItems[B.InvalidationLevel.Cursor]),"; light:",F(this._currentDrawItems[B.InvalidationLevel.Light]),"; full:",F(this._currentDrawItems[B.InvalidationLevel.Full])].join("");R.logNormal(e),this._clearCurrentState()}_clearCurrentState(){this._currentDrawItems=O(),this._currentWaitingItem={count:0,lastTime:0,maxTime:0,totalTime:0}}}var z=i(622429),U=i(627620);function G(e){return{...e,panes:(t=e.panes,t.map((e=>{return{...e,sources:(t=e.sources,t.filter((e=>!(0,U.isLineToolName)(e.type))))};var t})))};var t}function q(e,t){var i;const s=e.find((e=>e.tools.includes(t)));return null!==(i=null==s?void 0:s.id)&&void 0!==i?i:null}function j(e){var t,i;const o=e.panes.map((e=>e.sources.filter((e=>(0,U.isLineToolName)(e.type))))).reduce(((e,t)=>t.concat(e)),[]),r=null!==(i=null===(t=e.lineToolsGroups)||void 0===t?void 0:t.groups)&&void 0!==i?i:[],n=new Map;o.forEach((e=>{const t=e.id;n.set(t,function(e,t){var i;return{id:e.id,symbol:e.state.symbol,ownerSource:(0,s.ensureDefined)(e.ownerSource),state:e,groupId:null!==(i=q(t,e.id))&&void 0!==i?i:void 0}}(e,r))}));const a=new Map;return r.forEach((e=>{const t=function(e,t){var i,s;if(0===e.tools.length)return null;const o=e.tools[0];return null!==(s=null===(i=t.get(o))||void 0===i?void 0:i.symbol)&&void 0!==s?s:null}(e,n);null!==t&&a.set(e.id,{id:e.id,name:e.name,symbol:t})})),{sources:n,groups:a}}var K=i(271868),Z=i(405117),Y=i(778016),$=i(590508),X=i(640146),J=i(907256),Q=i(585627),ee=i(613122),te=i(175203),ie=i(314802),se=i(5553),oe=i(652171),re=i(474759),ne=i(454576),ae=i(622864),le=i(454763);const ce=new class{constructor(){this._timerWorker=null,this._timerIdCounter=1,this._timersMap=new Map,this._rejectsToCall=new Set,this._processMessage=e=>{const t=this._timersMap.get(e.data.turnaround);switch(e.data.type){case"timerCreated":t&&(t.scheduledForRemoving?("interval"===t.type?this._getTimerWorker().postMessage({type:"clearInterval",id:e.data.id}):this._getTimerWorker().postMessage({type:"clearTimeout",id:e.data.id}),this._deleteTimerFromMap(e.data.turnaround)):t.workerTimerId=e.data.id);break;case"timerFired":t&&(t.callback(),
"timeout"===t.type&&this._deleteTimerFromMap(e.data.turnaround))}}}destroy(){var e;this._rejectsToCall.forEach((e=>e((0,ae.createAbortError)()))),null===(e=this._timerWorker)||void 0===e||e.terminate(),this._timerWorker=null,this._timersMap.clear()}setTimeout(e,t){return this._setTimeoutImpl(e,t,"timeout")}clearTimeout(e){const t=this._timersMap.get(e);t&&(t.workerTimerId?(this._getTimerWorker().postMessage({type:"clearTimeout",id:t.workerTimerId}),this._deleteTimerFromMap(e)):t.scheduledForRemoving=!0)}setInterval(e,t){const i=this._nextTimerId();return this._timersMap.set(i,{callback:e,type:"interval"}),this._getTimerWorker().postMessage({type:"setInterval",delay:t,turnaround:i}),i}clearInterval(e){const t=this._timersMap.get(e);t&&(t.workerTimerId?(this._getTimerWorker().postMessage({type:"clearInterval",id:t.workerTimerId}),this._deleteTimerFromMap(e)):t.scheduledForRemoving=!0)}async createTimeout(e,t){let i;return new Promise(((s,o)=>{var r;i=o,this._rejectsToCall.add(i);const n=this.setTimeout(s,e);null===(r=null==t?void 0:t.signal)||void 0===r||r.addEventListener("abort",(()=>{this.clearTimeout(n),o((0,ae.createAbortError)())}))})).finally((()=>{this._rejectsToCall.delete(i)}))}async*createInterval(e,t){let i=()=>{},s=e=>{};const o=this.setInterval((()=>{i()}),e);t.signal.addEventListener("abort",(()=>{this.clearInterval(o),s((0,ae.createAbortError)())}));try{for(;;)await new Promise(((e,t)=>{i=e,this._rejectsToCall.delete(s),s=t,this._rejectsToCall.add(s)})),yield}catch(e){if(!(0,ae.isAbortError)(e))throw e}}_getTimerWorker(){return null===this._timerWorker&&(this._timerWorker=new le.Worker(new URL(i.p+i.u(77050),i.b),{name:"Timer worker"}),this._timerWorker.onmessage=this._processMessage),this._timerWorker}_setTimeoutImpl(e,t,i){const s=this._nextTimerId();return this._timersMap.set(s,{callback:e,type:i}),this._getTimerWorker().postMessage({type:"setTimeout",delay:t,turnaround:s}),s}_deleteTimerFromMap(e){if(this._timersMap.delete(e),0===this._timersMap.size){const e=this._setTimeoutImpl((()=>{var t;1===this._timersMap.size&&this._timersMap.has(e)&&(this._timersMap.delete(e),null===(t=this._timerWorker)||void 0===t||t.terminate(),this._timerWorker=null)}),6e4,"terminal_timer")}}_nextTimerId(){return this._timerIdCounter++}};var de=i(942634),he=i(125226);const ue=new Set(["chart_storage_hibernation_delay_60min","chart_storage_hibernation_delay_10min","chart_storage_hibernation_delay_5min"]);const pe=new u.WatchedValue(_e());function _e(){return(0,he.isFeatureEnabled)("chart_storage_hibernation_delay_60min")?36e5:(0,he.isFeatureEnabled)("chart_storage_hibernation_delay_10min")?6e5:(0,he.isFeatureEnabled)("chart_storage_hibernation_delay_5min")?3e5:6e4}(0,he.onFeaturesStateChanged)().subscribe(null,(e=>{if(!function(e){return ue.has(e)}(e))return;const t=_e();pe.setValue(t,!1)}));const me=pe.readonly();function ge(e){const t=document.querySelector('link[rel~="chart-storage-notifications"]');return(null==t?void 0:t.href)?e?new URL(e,t.href):new URL(t.href):null}function Se(e,t){
return Boolean(e.metaInfo.uid.value())&&!t.containsData&&!t.onWidget&&function(){if(!(0,ie.isOnMobileAppPage)("new"))return!0;const e=/TradingView\/(\d+)\.(\d+)\.(\d+)\.?/.exec(navigator.userAgent);if(null===e)return!0;const t=Number(e[1])-1,i=Number(e[2])-15,s=Number(e[3])-0;if(t>0||0===t&&i>0||0===t&&0===i&&s>0)return!0;return!1}()&&null!==ge()}const ve=(0,r.getLogger)("ChartStorageChangesSubscription");class fe extends se.PersistentEventSourceTransport{constructor(e,t){super((e=>this._onMessage(e))),this._destroyed=!1,this._onChangeVisibilityBound=this._onChangeVisibility.bind(this),this._hibernateTimerId=null,this._hibernateDelay=me.spawn(),this._beforeUnhibernating=new de.Delegate,this._haveEverBeenHibernated=!1,this._chartWidgetsCollection=e,this._layoutVisibility=e.resizerBridge().visible.spawn(),this._layoutVisibility.subscribe(this._onChangeVisibilityBound,{callWithLast:!0}),te.telemetry.sendLineToolsStorageReport("line_tools_subscription_initial_connect"),this._connectionStatus.subscribe((e=>{e===ne.ConnectionStatus.Closed&&te.telemetry.sendLineToolsStorageReport("line_tools_subscription_disconnected")})),this._subscribeForSharingLayout=t,this.connect(),this._hibernateDelay.subscribe((e=>{null!==this._hibernateTimerId&&this._scheduleHibernation(e)}))}destroy(){this._layoutVisibility.destroy(),this._hibernateDelay.destroy(),this.disconnect(),this._destroyed=!0}beforeUnhibernating(){return this._beforeUnhibernating}async _prepareParamsForConnection(e){const t=this._chartWidgetsCollection.metaInfo.uid.value();if(this._destroyed)return Promise.reject("Subscription is being destroyed");const i=await(0,oe.getStorageTarget)(t,"",0),s=ge(`/charts-storage/layout/${t}/subscribe`);null!==s?(s.searchParams.delete("jwt"),s.searchParams.append("jwt",i.token),this._subscribeForSharingLayout&&window.user.id&&window.user.is_pro&&s.searchParams.append("id",""+window.user.id),this._url=s.toString()):this._url=""}_tryReconnectImpl(){super._tryReconnectImpl(),te.telemetry.sendLineToolsStorageReport("line_tools_subscription_reconnecting")}_onMessage(e){if("string"!=typeof e)throw new Error("Wrong message type, expected string");const t=JSON.parse(e);Object.entries(t).forEach((e=>{const t=(0,re.parseLineToolsAndGroupsDTO)(e[1],""),i=e[0];let s=0;i===oe.sharedChartId?s=1:i===oe.globallySharedChartId&&(s=2),this._chartWidgetsCollection.applyLineToolUpdateNotification(i,t,s)}))}_onChangeVisibility(){const e=this._layoutVisibility.value();e&&this.connectionStatus().value()===ne.ConnectionStatus.Closed?(this.connect(),this._beforeUnhibernating.fire(),this._haveEverBeenHibernated&&(ve.logNormal("Connect due to becoming visible"),te.telemetry.sendLineToolsStorageReport("line_tools_unhibenate_subscription"))):e||this._scheduleHibernation(me.value())}_scheduleHibernation(e){null!==this._hibernateTimerId&&ce.clearTimeout(this._hibernateTimerId),this._hibernateTimerId=ce.setTimeout((()=>this._disconnectIfInvisible()),e)}_disconnectIfInvisible(){this._hibernateTimerId=null,
this._layoutVisibility.value()||(ve.logNormal("Disconnect due to becoming invisible"),this.disconnect(),te.telemetry.sendLineToolsStorageReport("line_tools_hibenate_subscription"),this._haveEverBeenHibernated=!0)}}var be=i(850775),ye=i(430719),Ce=i(870045),we=i(975179),Te=i(429874),Pe=i(558150),Me=i(828473),xe=i(79342),Ie=i(442657),Le=i(251954),Ae=i(581996),ke=i(743068),Ee=i(895171),De=i(591800),Be=i(62802),Ne=i(345848),Re=i(799786),Oe=i(432059),Ve=i(956248),We=i(955273),Fe=i(125388),He=i(560420),ze=i(951713),Ue=i(999138);let Ge;class qe extends Ue.DialogRenderer{constructor(){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)}}show(){this._load().then((e=>e.show()))}hide(){var e;null===(e=this._dialog)||void 0===e||e.hide()}static getInstance(){return Ge||(Ge=new qe),Ge}_load(){return Promise.all([i.e(53796),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(67158),i.e(72197),i.e(16190),i.e(24125),i.e(97384),i.e(49325),i.e(17175),i.e(44066),i.e(84353),i.e(32736),i.e(17762),i.e(74510),i.e(20649),i.e(6333),i.e(82321),i.e(87473),i.e(5483),i.e(82311),i.e(39002),i.e(25910),i.e(17013),i.e(16242),i.e(87826),i.e(34862)]).then(i.bind(i,318406)).then((e=>{var t,i;return null===(t=this._dialog)||void 0===t||t.hide(),null===(i=this._dialog)||void 0===i||i.visible().unsubscribe(this._subscribe),this._dialog=new e.ObjectTreeDialogRenderer,this._dialog.visible().subscribe(this._subscribe),this._dialog}))}}var je=i(124829),Ke=i(218049),Ze=i(658843);async function Ye(e,t,s,o,r,a="default"){let l,c=[];const d=e.model().model(),h=(0,je.clone)(t),u=new Ze.Property({inputs:h}),p=function(e,t){return"symbol"===t?e.inputs.filter((t=>t.id===e.symbolInputId())):e.inputs.filter((e=>e.confirm))}(s,a),_=()=>{l&&d.removeCustomSource(l)},m=()=>{_(),r()},g=e=>{o({inputs:e,parentSources:c}),_()},S=p.filter(Ke.isTimeOrPriceNotHiddenInput);if(S.length>0)try{const t=await Promise.all([i.e(55073),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(65857),i.e(23141),i.e(36010),i.e(95083),i.e(29296),i.e(62234),i.e(72197),i.e(88015),i.e(22106),i.e(30422),i.e(16356),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(22602),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(8222),i.e(79412),i.e(80089),i.e(25983),i.e(42513),i.e(16182),i.e(31085),i.e(82440),i.e(90303),i.e(89255),i.e(2573),i.e(12400),i.e(79184),i.e(76810),i.e(82321),i.e(87473),i.e(16388),i.e(83147),i.e(75560),i.e(66144),i.e(5428),i.e(59490),i.e(89178),i.e(26904),i.e(53030)]).then(i.bind(i,204564)),o=await t.selectInputValuesOnChart(e,S,u,s.shortDescription,s.inputs);if(l=o.customSourceId,o.destPane){const e=o.destPane.mainDataSource();c=e===d.mainSeries()?[]:[e]}else c=[]}catch(e){return void m()}
S.length!==p.length?Promise.all([i.e(55073),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(65857),i.e(23141),i.e(36010),i.e(95083),i.e(29296),i.e(62234),i.e(72197),i.e(88015),i.e(22106),i.e(30422),i.e(16356),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(22602),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(8222),i.e(79412),i.e(80089),i.e(25983),i.e(42513),i.e(16182),i.e(31085),i.e(82440),i.e(90303),i.e(89255),i.e(2573),i.e(12400),i.e(79184),i.e(76810),i.e(82321),i.e(87473),i.e(16388),i.e(83147),i.e(75560),i.e(66144),i.e(5428),i.e(59490),i.e(89178),i.e(26904),i.e(53030)]).then(i.bind(i,49294)).then((t=>{const o=new t.ConfirmInputsDialogRenderer(function(e){if("symbol"===e)return n.t(null,void 0,i(346501));return n.t(null,void 0,i(648141))}(a),p,u,a,s,e.model(),g,m);return o.show(),o})):g(u.state().inputs||{})}let $e=null;var Xe=i(941285),Je=i(643322),Qe=i(430777);function et(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function tt(e){return e.reduce(((e,t)=>{for(const i in t)if(et(t,i)){const s=t[i],o=e[i];o?o.push(s):e[i]=[s]}return e}),{})}var it=i(631088),st=i(895366);const ot=new c.TranslatedString("move left",n.t(null,void 0,i(179209))),rt=new c.TranslatedString("move right",n.t(null,void 0,i(360114)));class nt{constructor(e){this._chartModel=null,this._animation=null,this._chart=e,this._chart.withModel(this,(()=>{this._chartModel=this._chart.model()}))}destroy(){var e;null===(e=this._animation)||void 0===e||e.stop()}move(e){if(null!==this._chartModel){if(this._chartModel.timeScale().isEmpty())return;const t=.003,i=1.1,s=Math.round(i/t);this._moveImpl(e,((o,r,n)=>{const a=Math.min(r,s),l=e*t*Math.pow(a,2)/2;if(r<=s)return o+l;const c=Number.isFinite(n)?Math.max(0,s-n):0;return o+l+e*(r-a-c)*i+e*(i*c-t*Math.pow(c,2)/2)}),(e=>Math.max(0,s-e)+s))}}moveByBar(e){if(null!==this._chartModel){const t=this._chartModel.timeScale(),i=t.visibleBarsStrictRange();if(t.isEmpty()||null===i)return;const s=300,o=i.lastBar();this._moveImpl(e,((i,r)=>{const n=Math.floor(Math.max(0,r-s)/100)+1,a=o+e*n,l=t.indexToCoordinate(o);return i+(t.indexToCoordinate(a)-l)}),(()=>0),!0)}}stopMove(){var e;null===(e=this._animation)||void 0===e||e.stop(),this._animation=null}scrollToRealtime(e){null!==this._chartModel&&this._chartModel.timeScale().scrollToRealtime(e)}_moveImpl(e,t,i,s){if(null===this._chartModel)return;const o=this._chartModel.timeScale();if(o.isEmpty())return;if(this._chartModel.changeTimeScale(1===e?ot:rt,!1),s&&null!==o.visibleBarsStrictRange()){const e=o.indexToCoordinate(o.visibleBarsStrictRange().lastBar())+o.barSpacing()/2;Math.abs(o.width()-e)>o.barSpacing()/6&&o.setRightOffset(Math.round(o.rightOffset()))}const r=performance.now();let n=1/0;this._animation={getStartPosition:()=>0,getPosition:e=>(e=Math.min(n,e),t(0,e-r,n-e)),finished:e=>e>=n,stop:()=>{const e=performance.now()-r
;n=performance.now()+i(e)}},this._chartModel.model().stopTimeScaleAnimation(),this._chartModel.model().setTimeScaleAnimation(this._animation)}}var at=i(33052);function lt(e,t,s,o,r){return Promise.all([i.e(31856),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(65857),i.e(23141),i.e(36010),i.e(95083),i.e(29296),i.e(62234),i.e(72197),i.e(43362),i.e(88015),i.e(22106),i.e(30422),i.e(16356),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(22602),i.e(32175),i.e(30614),i.e(7001),i.e(39963),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(44066),i.e(75364),i.e(8222),i.e(77414),i.e(33828),i.e(79412),i.e(80089),i.e(65891),i.e(25983),i.e(42513),i.e(16182),i.e(31085),i.e(82440),i.e(90303),i.e(24474),i.e(89255),i.e(62319),i.e(2573),i.e(12400),i.e(78687),i.e(48694),i.e(41682),i.e(38790),i.e(79184),i.e(91068),i.e(18973),i.e(94448),i.e(54786),i.e(32864),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(62107),i.e(83147),i.e(75560),i.e(66144),i.e(5428),i.e(59490),i.e(53418),i.e(89178),i.e(26904),i.e(44158),i.e(83635),i.e(55736),i.e(87637),i.e(46265)]).then(i.bind(i,441347)).then((i=>{const n=new(0,i.EditObjectDialogRenderer)(e,t,o,r);return n.show(s),n}))}var ct=i(434396);let dt=null;var ht=i(862954),ut=i(465836);const pt={[at.TabNames.symbol]:"symbol",[at.TabNames.legend]:"legend",[at.TabNames.scales]:"scales",[at.TabNames.trading]:"trading",[at.TabNames.events]:"events",[at.TabNames.eventsAndAlerts]:"events",[at.TabNames.timezoneSessions]:"canvas",[at.TabNames.text]:"text",[at.TabNames.style]:"style",[at.TabNames.visibility]:"visibility"},_t={[at.TabNames.style]:"style",[at.TabNames.visibility]:"visibilities"};async function mt(e,t,s={},o,r){const n=o.activeChartWidget.value(),{initialTab:a,tabName:l}=s;if(l&&!a&&(s.initialTab=_t[l]),(0,ut.isStudyLineTool)(e)&&function(e){if(!(0,ut.isStudyLineTool)(e))return!1;return["LineToolFixedRangeVolumeProfile","LineToolVbPFixed","LineToolAnchoredVolumeProfile"].filter(je.notNull).some((t=>e.toolname===t))}(e))return n.propertiesDefinitionsForSource(e).then((i=>null!==i?lt(e,t,s,r,i):null));if((0,ct.isStudy)(e)&&function(e){const{shortId:t}=e.metaInfo();return"Overlay"===t}(e)||(0,ut.isLineTool)(e))return n.propertiesDefinitionsForSource(e).then((o=>{if(null!==o){return function(e){
return Promise.all([i.e(3618),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(65857),i.e(23141),i.e(36010),i.e(95083),i.e(29296),i.e(62234),i.e(72197),i.e(43362),i.e(88015),i.e(22106),i.e(30422),i.e(16356),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(22602),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(44066),i.e(75364),i.e(8222),i.e(77414),i.e(33828),i.e(79412),i.e(80089),i.e(25983),i.e(42513),i.e(16182),i.e(31085),i.e(82440),i.e(90303),i.e(24474),i.e(89255),i.e(62319),i.e(2573),i.e(12400),i.e(78687),i.e(48694),i.e(41682),i.e(38790),i.e(79184),i.e(91068),i.e(18973),i.e(54786),i.e(1833),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(62107),i.e(83147),i.e(75560),i.e(66144),i.e(5428),i.e(59490),i.e(53418),i.e(89178),i.e(26904),i.e(44158),i.e(83635),i.e(55736),i.e(87637),i.e(46780)]).then(i.bind(i,757381)).then((t=>{const i=new(0,t.SourcePropertiesEditorRenderer)(e);return null!==dt&&dt.hide(),i.show({shouldReturnFocus:e.shouldReturnFocus}),dt=i,i}))}({propertyPages:o,model:t,source:e,activePageId:l&&pt[l],shouldReturnFocus:s.shouldReturnFocus})}return null}));if((0,ct.isStudy)(e)&&!(0,ht.isLollipopDataSource)(e))return lt(e,t,s,r);{const t=(0,ht.isLollipopDataSource)(e)?"events":l&&pt[l],i=o.getChartPropertiesDialogRenderer();return i.setActivePage(t),i.show(s)}}var gt=i(960095),St=i(331633),vt=i(61499),ft=i(100366),bt=i(342707),yt=i(468302);const Ct=(0,gt.getHexColorByName)("color-cold-gray-700"),wt=(0,gt.getHexColorByName)("color-cold-gray-400"),Tt=(0,gt.getHexColorByName)("color-cold-gray-900"),Pt=(0,gt.getHexColorByName)("color-white"),Mt=n.t(null,void 0,i(518905));function xt(e){return e?{...e,message:(0,bt.formatStudyError)(e.message),rawHtml:!0}:null}class It{constructor(e){this._container=null,this._errorCardRenderer=null,this._mainSeriesErrorMessage=null,this._banErrorMessage=new u.WatchedValue(null).spawn(),this._errorMessageHandler=e=>{e=xt(e),this._chartWidget.hasModel()?this._updatePaneWidgets(e):this._renderErrorWithoutModel(e)},this._chartWidget=e,this._subscribeToMainSeriesErrors()}destroy(){var e,t;null===(e=this._mainSeriesErrorMessage)||void 0===e||e.destroy(),this._banErrorMessage.destroy(),null===(t=this._errorCardRenderer)||void 0===t||t.then((e=>{e.container.remove(),e.destroy()}))}updatePaneWidgets(){this._updatePaneWidgets()}setContainer(e){var t;if(this._container!==e){this._container=e,null===(t=this._errorCardRenderer)||void 0===t||t.then((e=>e.container.remove()));const i=this._getErrorMessage();i&&this._errorMessageHandler(i)}}_updatePaneWidgets(e=this._getErrorMessage()){this._chartWidget.paneWidgets().forEach((t=>t.setErrorMessage(e)))}async _renderErrorWithoutModel(e){if(null===this._container||null===e&&null===this._errorCardRenderer)return;const t=await this._getErrorCardRenderer()
;this._container.contains(t.container)||this._container.appendChild(t.container),t.update(this._createErrorCardRendererState(e))}async _getErrorCardRenderer(){return this._errorCardRenderer||(this._errorCardRenderer=this._createErrorCardRenderer())}async _createErrorCardRenderer(){return new(await(0,ft.getErrorCardRenderer)())}_createErrorCardRendererState(e){return e?{message:e.message,icon:e.icon,textColor:St.watchedTheme.value()===vt.StdTheme.Dark?wt:Ct,backgroundColor:St.watchedTheme.value()===vt.StdTheme.Dark?Tt:Pt,solutionId:e.solutionId,rawHtml:e.rawHtml,buttons:e.buttons}:{message:null}}_subscribeToMainSeriesErrors(){const e=this._chartWidget;this._banErrorMessage=(0,Je.combine)((e=>{if(!e)return null;let t;if("banned by ip"===e.reason)t=n.t(null,void 0,i(743954));else t=n.t(null,void 0,i(39931));return{message:t,solutionId:Q.solutionIds.WHY_IS_MY_ACCOUNT_BANNED,icon:"stop-hand"}}),window.ChartApiInstance.connectionBanInfo().weakReference()),this._banErrorMessage.subscribe(this._errorMessageHandler,{callWithLast:!0}),e.withModel(this,(()=>{const t=e.model().model().mainSeries();this._mainSeriesErrorMessage=(0,Je.combine)(((t,s)=>{if(t)return t;if(null===s)return null;switch(s.type){case"invalid_symbol":return{message:n.t(null,void 0,i(652969)),icon:"ghost"};case"calculations_error":return{message:s.errorMessage,icon:"attention"};case"no_data":return{message:n.t(null,void 0,i(836252)),icon:"ghost"};case"unsupported_resolution":return this._createErrorParamsForUnsupportedResolution(e)}}),this._banErrorMessage.weakReference(),(0,we.getSeriesDisplayErrorWV)(t).ownership()),this._mainSeriesErrorMessage.subscribe(this._errorMessageHandler,{callWithLast:!0})}))}_createErrorParamsForUnsupportedResolution(e){const t=e.model(),i=t.mainSeries().unsupportedResolutionState().value();return null===i?null:{message:(0,yt.getErrorFromUnsupportedResolutionState)(i,!0),icon:"unsupported-resolution",rawHtml:!0,maxHeight:400,zeroHeight:200,buttons:[{name:Mt.format({resolution:i.applicableResolution}),onClick:()=>{t.setResolution(t.model().mainSeries(),i.applicableResolution)}}]}}_getErrorMessage(){var e;return xt(this._banErrorMessage.value()||(null===(e=this._mainSeriesErrorMessage)||void 0===e?void 0:e.value())||null)}}var Lt=i(18900),At=i(937713),kt=i(201871),Et=i(124066),Dt=i(540519),Bt=i(220350);class Nt{constructor(e,t){this._showed=!1,this._cw=e,this._element=document.createElement("div"),this._element.classList.add(Bt.screen),t.appendChild(this._element),this._cw.withModel(this,this._connectToModel)}show(e){if(e){const e=this._cw.model().mainSeries().status();if(1!==e&&2!==e)return}this._cw.setInLoadingState(!0),this._showed||(this._showed=!0,this._show())}hide(){this._cw.setInLoadingState(!1),this._showed&&this._hide()}isShown(){return this._showed}_connectToModel(){const e=this._cw.model().mainSeries(),t=e.dataEvents();t.symbolError().subscribe(this,(e=>{e!==Et.permissionDenied&&this.hide()})),t.seriesError().subscribe(this,(()=>{(0,d.enabled)("hide_loading_screen_on_series_error")&&this.hide()})),
e.statusWV().subscribe((e=>{(Dt.seriesReadyStatuses.has(e)||4===e||12===e||13===e||14===e)&&this.hide()}))}_show(){const e=this._cw.properties().childs().paneProperties.childs();let t;if(e.backgroundType.value()===kt.ColorType.Solid)t=e.background.value();else{t=`linear-gradient(${e.backgroundGradientStartColor.value()},${e.backgroundGradientEndColor.value()})`}this._element.style.background=t,this._element.classList.add(Bt.fade)}_hide(){this._showed=!1,this._element.classList.remove(Bt.fade)}}function Rt(e,t){let{deltaX:i,deltaY:s}=e;switch(i/=100,s/=100,t.deltaMode){case t.DOM_DELTA_PAGE:i*=120,s*=120;break;case t.DOM_DELTA_LINE:i*=32,s*=32}return{deltaX:i,deltaY:s}}class Ot{constructor(){this._totalDeltaX=0,this._totalDeltaY=0,this._prevWheelTime=0}processWheel(e){e.timeStamp-this._prevWheelTime>100&&this._reset();const t=!(0,l.isMac)()&&e.shiftKey,i=t?-e.deltaY:e.deltaX,s=t?e.deltaX:e.deltaY;this._totalDeltaX+=i,this._totalDeltaY+=s,this._prevWheelTime=e.timeStamp;const o={deltaX:i,deltaY:s};return 0===this._totalDeltaX||0===this._totalDeltaY||(Math.abs(this._totalDeltaX)>=Math.abs(3*this._totalDeltaY)&&(o.deltaY=0),Math.abs(this._totalDeltaY)>=Math.abs(3*this._totalDeltaX)&&(o.deltaX=0)),Rt(o,e)}_reset(){this._totalDeltaX=0,this._totalDeltaY=0}}var Vt=i(724377),Wt=i(750139),Ft=i(188035),Ht=i(656479);class zt{constructor(e,t,i){this._handleEl=null,this._resizeInfo=null,this._colorCache={lineColor:"",backgroundColor:"",color:""},this._chart=e,this._topPaneIndex=t,this._bottomPaneIndex=i,this._element=document.createElement("div"),this._element.classList.add(Ht.paneSeparator),this._element.style.background=this._color(),this.adjustSize(),this._element.addEventListener("click",(()=>{}));const s=document.createElement("div");s.classList.add(Ht.handle),this._element.appendChild(s),this._mouseEventHandler=new Ft.MouseEventHandler(s,this,{treatVertTouchDragAsPageScroll:!1,treatHorzTouchDragAsPageScroll:!0}),this._handleEl=s,this._element.setAttribute("aria-hidden","true")}destroy(){this._mouseEventHandler.destroy(),this._element.parentElement&&this._element.parentElement.removeChild(this._element)}getElement(){return this._element}hide(){this._element.classList.add("js-hidden")}show(){this._element.classList.remove("js-hidden")}adjustSize(){this._element.style.height=zt.height()+"px"}mouseEnterEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0);null!==t&&null!==i&&(0,s.ensureNotNull)(this._handleEl).classList.add(Ht.hovered)}mouseLeaveEvent(e){(0,s.ensureNotNull)(this._handleEl).classList.remove(Ht.hovered)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e)}update(){this._element.style.background=this._color().toString()}paint(){}image(){
const{topPane:e}=this._topBottomPane(!1),t=e.leftPriceAxisesContainer().getWidth(),i=e.width(),s=e.rightPriceAxisesContainer().getWidth(),o=this._color(),r=(0,it.createDisconnectedCanvas)(document,(0,ke.size)({width:t,height:1})),n=(0,it.getPrescaledContext2D)(r);n.fillStyle=o,n.fillRect(0,0,t,1);const a=(0,it.createDisconnectedCanvas)(document,(0,ke.size)({width:i,height:1})),l=(0,it.getPrescaledContext2D)(a);l.fillStyle=o,l.fillRect(0,0,i,1);const c=(0,it.createDisconnectedCanvas)(document,(0,ke.size)({width:s,height:1})),d=(0,it.getPrescaledContext2D)(c);return d.fillStyle=o,d.fillRect(0,0,s,1),{type:"separator",leftAxis:{content:r.toDataURL(),canvas:r,contentWidth:t,contentHeight:1},rightAxis:{content:c.toDataURL(),canvas:c,contentWidth:s,contentHeight:1},content:a.toDataURL(),canvas:a,contentWidth:i,contentHeight:1}}static height(){const e=window.devicePixelRatio||1;return e>=1?1:1/e}_mouseDownOrTouchStartEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0);if(null===t||null===i)return;const o=t.state().stretchFactor()+i.state().stretchFactor(),r=o/(t.height()+i.height()),n=30*r;o<=2*n||(this._resizeInfo={startY:e.pageY,prevStretchTopPane:t.state().stretchFactor(),maxPaneStretch:o-n,totalStretch:o,pixelStretchFactor:r,minPaneStretch:n},(0,s.ensureNotNull)(this._handleEl).classList.add(Ht.active))}_pressedMouseOrTouchMoveEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0),s=this._resizeInfo;if(null===s||null===t||null===i)return;const o=(e.pageY-s.startY)*s.pixelStretchFactor,r=(0,Wt.clamp)(s.prevStretchTopPane+o,s.minPaneStretch,s.maxPaneStretch);t.state().setStretchFactor(r),i.state().setStretchFactor(s.totalStretch-r),this._chart.model().model().fullUpdate()}_mouseUpOrTouchEndEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0),o=this._resizeInfo;null!==o&&null!==t&&null!==i&&(this._chart.model().addPaneStretchFactorUndoCommand(t.state(),i.state(),o.prevStretchTopPane,t.state().stretchFactor()),this._resizeInfo=null,(0,s.ensureNotNull)(this._handleEl).classList.remove(Ht.active))}_color(){const e=this._chart.properties().childs().paneProperties.childs().separatorColor.value(),t=this._chart.model().model().backgroundColor().value();if(this._colorCache.lineColor!==e||this._colorCache.backgroundColor!==t){const i=(0,Vt.parseRgba)(t),s=(0,Vt.parseRgba)(e),o=0===i[3]&&0===s[3]?"rgba(0,0,0,0)":(0,Vt.rgbaToString)((0,Vt.blendRgba)(i,s));this._colorCache={lineColor:e,backgroundColor:t,color:o}}return this._colorCache.color}_topBottomPane(e){const t=this._chart.paneWidgets();let i=null,s=null;for(let s=this._topPaneIndex;s>=0;--s){const o=t[s];if(!e||!o.state().collapsed().value()){i=o;break}}for(let i=this._bottomPaneIndex;i<t.length;++i){const o=t[i];if(!e||!o.state().collapsed().value()){s=o;break}}return{topPane:i,bottomPane:s}}}var Ut=i(316230),Gt=i(45003),qt=i(509078),jt=i(779732),Kt=i(970427),Zt=i(803279),Yt=i(419283),$t=i(571491),Xt=i(665798),Jt=i(694852),Qt=i(463548),ei=i(5486),ti=i(621452),ii=i(499994),si=i(511275),oi=i(507983);const ri=(0,
Jt.makeFont)(11,si.CHART_FONT_FAMILY),ni={enableTooltip:!0,showLabels:!0,enableMenu:!0,enableHighlight:!0};function ai(e,t){return Math.max(1,Math.floor(e.borderSize*t))}class li{constructor(e,t,i,s,o,r=null){this._invalidated=!0,this._size=(0,ke.size)({width:0,height:0}),this._offset=0,this._axisInfo=null,this._onLabelHovered=new de.Delegate,this._highlighted=!1,this._labelMode=2,this._fixedLabelMode=null,this._textWidthCache=new ei.TextWidthCache(5),this._gearRenderer=(0,Qt.svgRenderer)(oi),this._canvasConfiguredHandler=()=>{this.update(),this._textWidthCache.reset()},this._timeAxisWidget=r,this._isLeft="left"===e;const{rendererOptionsProvider:n,sourcesTitlesProvider:a,contextMenuItemsProvider:l,backgroundBasedTheme:c,onActiveOrHoveredChart:d=new u.WatchedValue(!1).ownership(),requestRepaint:h,getBackgroundTopColor:p,getBackgroundBottomColor:_,showHorizontalBorder:m}=s;this._rendererOptionsProvider=n,this._sourcesTitlesProvider=a,this._contextMenuItemsProvider=l,this._backgroundBasedTheme=c,this._onActiveOrHoveredChart=d,this._requestRepaint=h,this._getBackgroundTopColor=p,this._getBackgroundBottomColor=_,this._showHorizontalBorder=Boolean(m),this._properties=t,this._axisInfo=i,this._labelOptions={...ni,...o},this._properties.lineColor.subscribe(this,this._onPropertyChanged),this._cell=document.createElement("div"),this._labelOptions.enableTooltip&&this._cell.classList.add("apply-common-tooltip"),this._cell.style.width="25px",this._cell.style.height="100%",this._cell.style.position="absolute",this._cell.style.left="0",this._cell.style.overflow="hidden",this._labelOptions.showLabels&&(this._labelOptions.enableTooltip&&(0,ii.setTooltipData)(this._cell,"text",(e=>this._tooltipContent())),this._onActiveOrHoveredChart.subscribe(h)),this._mouseEventHandler=new Ft.MouseEventHandler(this._cell,this,{treatHorzTouchDragAsPageScroll:!0,treatVertTouchDragAsPageScroll:!0}),this._canvasBinding=(0,it.createBoundCanvas)(this._cell,(0,ke.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const g=this._canvasBinding.canvasElement;g.style.position="absolute",g.style.left="0",g.style.top="0",this._cell.setAttribute("aria-hidden","true")}destroy(){this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._properties.lineColor.unsubscribe(this,this._onPropertyChanged),this._mouseEventHandler.destroy(),this._backgroundBasedTheme.release(),this._onActiveOrHoveredChart.unsubscribe(this._requestRepaint),this._onActiveOrHoveredChart.release()}mouseEnterEvent(e){this._mouseOrTouchEnterEvent(e)}touchStartEvent(e){this._mouseOrTouchEnterEvent(e)}mouseLeaveEvent(e){this._mouseOrTouchLeaveEvent(e)}touchEndEvent(e){this._mouseOrTouchLeaveEvent(e)}mouseClickEvent(e){this._mouseClickOrTapEvent(e)}tapEvent(e){this._mouseClickOrTapEvent(e)}update(){}getElement(){return this._cell}onLabelHovered(){return this._onLabelHovered}setSizeAndOffset(e,t){(0,ke.equalSizes)(this._size,e)||(this._size=e,
this._canvasBinding.resizeCanvasElement(e),this._cell.style.width=`${e.width}px`,this._cell.style.minWidth=`${e.width}px`,this._cell.style.height=`${e.height}px`,this._invalidated=!0),this._offset!==t&&(this._offset=t,this._cell.style.left=`${t}px`)}paint(e){e<B.InvalidationLevel.Light&&!this._invalidated||0!==this._size.width&&0!==this._size.height&&(this._invalidated=!1,(0,it.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),this._paintImpl((0,it.getContext2D)(this._canvasBinding.canvasElement),(0,it.getBindingRenderingInfo)(this._canvasBinding)))}getWidth(){return this._size.width}getImage(){const e=(0,it.getBindingRenderingInfo)(this._canvasBinding),t=(0,it.createDisconnectedCanvasByRenderingInfo)(document,e);return this._paintImpl((0,it.getContext2D)(t),e,!0),t}setLabelMode(e){e!==this._labelMode&&(this._labelMode=e,this._cell.classList.toggle("apply-common-tooltip",1!==e&&this._labelOptions.enableTooltip))}_paintImpl(e,t,i){this._drawBackground(e,t),this._drawVerticalBorder(e,t),this._showHorizontalBorder&&this._drawHorizontalBorder(e,t),this._labelOptions.showLabels&&this._drawLabel(e,t,i)}_setHighlighted(e){this._labelOptions.enableHighlight&&(this._onLabelHovered.fire("stubButton",e),this._highlighted!==e&&(this._highlighted=e,this._invalidated=!0))}_onPropertyChanged(){this._invalidated=!0}_drawVerticalBorder(e,t){e.save(),e.fillStyle=this._vertBorderColor();const i=ai(this._rendererOptionsProvider.options(),t.horizontalPixelRatio),s=this._isLeft?t.bitmapSize.width-i:0;e.fillRect(s,0,i,t.bitmapSize.height),e.restore()}_drawHorizontalBorder(e,t){e.save(),e.fillStyle=this._horzBorderColor();const i=ai(this._rendererOptionsProvider.options(),t.verticalPixelRatio),s=this._isLeft?0:i;e.fillRect(s,0,t.bitmapSize.width-i,i),e.restore()}_drawBackground(e,t){const i=this._getBackgroundTopColor(),s=this._getBackgroundBottomColor(),{bitmapSize:o}=t;if(i===s?(0,it.clearRect)(e,0,0,o.width,o.height,i):(0,Xt.clearRectWithGradient)(e,0,0,o.width,o.height,i,s),this._highlighted){const t=Te.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight");(0,it.fillRect)(e,0,0,o.width,o.height,t),e.globalAlpha=1}}_drawLabel(e,t,i){const s=this._backgroundBasedTheme.value(),r=this._axisInfo;if(null===r||!i&&!this._onActiveOrHoveredChart.value())return;const{bitmapSize:n,horizontalPixelRatio:a,verticalPixelRatio:l}=t,c=ai(this._rendererOptionsProvider.options(),a),d=Math.round(n.width)-c,h=ai(this._rendererOptionsProvider.options(),l),u=Math.round(n.height)-h,p=(0,o.point)(c+d/2,h+u/2);if(1===this._labelMode||2===this._labelMode&&(!this._highlighted||i)){e.fillStyle=Te.themes[s].getThemedColor("color-price-axis-label-back"),e.globalAlpha=.5,e.beginPath(),e.arc(p.x,p.y,9.5*a,0,2*Math.PI,!0),e.fill(),e.globalAlpha=1,e.fillStyle=Te.themes[s].getThemedColor("color-price-axis-label-text"),e.font=ri,e.textAlign="center",e.textBaseline="middle";const t=this._textWidthCache.yMidCorrection(e,r.label);(0,it.drawScaled)(e,a,l,(()=>{e.fillText(r.label,p.x/a,p.y/l+t)}))
}else if(!i&&this._onActiveOrHoveredChart.value()){const t=this._gearRenderer.viewBox(),i=Math.round(p.x-t.width*a/2),o=Math.round(p.y-t.height*l/2);e.fillStyle=Te.themes[s].getThemedColor("color-text-primary"),e.imageSmoothingQuality="high",this._gearRenderer.render(e,{targetViewBox:{x:i,y:o,width:t.width*a,height:t.height*l},doNotApplyColors:!0})}}_vertBorderColor(){return this._properties.lineColor.value()}_horzBorderColor(){var e,t;return null!==(t=null===(e=this._timeAxisWidget)||void 0===e?void 0:e.lineColor())&&void 0!==t?t:this._vertBorderColor()}_tooltipContent(){return this._sourcesTitlesProvider().join("\n")}_mouseOrTouchEnterEvent(e){this._labelOptions.showLabels&&this._labelOptions.enableHighlight&&this._setHighlighted(!0)}_mouseOrTouchLeaveEvent(e){this._labelOptions.showLabels&&this._labelOptions.enableHighlight&&this._setHighlighted(!1)}_mouseClickOrTapEvent(e){if(e.preventDefault(),null!==this._fixedLabelMode||1===this._labelMode||!this._labelOptions.enableMenu||!this._labelOptions.showLabels)return void ti.ContextMenuManager.hideAll();this._fixedLabelMode=this._labelMode,this.setLabelMode(0);const t=this._cell.getBoundingClientRect();ti.ContextMenuManager.showMenu(this._contextMenuItemsProvider(),{clientX:this._isLeft?t.left:t.right,clientY:t.top,attachToXBy:this._isLeft?"left":"right",attachToYBy:"bottom"},{statName:"PriceScaleLabelContextMenu",doNotCloseOn:this.getElement()},{menuName:"PriceScaleLabelContextMenu"},(()=>{this.setLabelMode((0,s.ensureNotNull)(this._fixedLabelMode)),this._fixedLabelMode=null}))}}var ci=i(109436);class di{constructor(e,t,i,s,o,r=null){this._axises=[],this._stubs=[],this._size=(0,ke.size)({width:0,height:0}),this._onLabelHovered=new de.Delegate,this._scalesProperties=e,this._priceAxisWidgetFactory=i,this._timeAxisWidget=r,this._rendererOptionsProvider=s.rendererOptionsProvider,this._titlesProvider=s.titlesProvider,this._stubContextMenuProvider=s.stubContextMenuProvider,this._backgroundBasedTheme=s.backgroundBasedTheme,this._onActiveOrHoveredChart=s.onActiveOrHoveredChart,this._getBackgroundTopColor=s.getBackgroundTopColor,this._getBackgroundBottomColor=s.getBackgroundBottomColor,this._requestRepaint=s.requestRepaint,this._showHorisontalBorder=Boolean(s.showHorizontalBorder),this._labelsOptions={...ni,...o};const n=this._scalesProperties.childs();this._stubProperties={lineColor:n.lineColor,fontSize:n.fontSize},this._side=t,this._cell=document.createElement("div"),this._cell.classList.add("chart-markup-table","price-axis-container"),this._cell.style.width="25px",this._cell.style.position="relative"}destroy(){var e;this.setScales([],0,0,0),this._backgroundBasedTheme.release(),null===(e=this._onActiveOrHoveredChart)||void 0===e||e.release()}onLabelHovered(){return this._onLabelHovered}setScales(e,t,i,o){for(;e.length>this._axises.length&&this._axises.length<t;){const e=(0,ci.getPriceAxisNameInfo)(this._side,this._axises.length),t=this._priceAxisWidgetFactory(this._side,this._rendererOptionsProvider,this._scalesProperties,e,this._backgroundBasedTheme);this._axises.push(t),
this._cell.appendChild(t.getElement())}for(;e.length<this._axises.length;){const e=(0,s.ensureDefined)(this._axises.pop());this._cell.removeChild(e.getElement()),e.destroy()}for(let t=0;t<this._axises.length;++t)this._axises[t].setPriceScale(e[t]);const r=t-e.length,n=Math.max(0,r);for(;this._stubs.length>n;){const e=(0,s.ensureDefined)(this._stubs.pop());e.onLabelHovered().unsubscribeAll(this),this._cell.removeChild(e.getElement()),e.destroy()}for(;this._stubs.length<r;){const e=this._labelsOptions.showLabels?(0,ci.getPriceAxisNameInfo)(this._side,this._stubs.length):null,t=new li(this._side,this._stubProperties,e,this._stubParams(this._stubs.length),this._labelsOptions,this._timeAxisWidget);t.onLabelHovered().subscribe(this,((t,i)=>{this._labelsOptions.showLabels&&this._labelsOptions.enableHighlight&&this._onLabelHovered.fire({owner:t,axis:(0,s.ensureNotNull)(e)},i)})),this._stubs.push(t),this._cell.appendChild(t.getElement())}const a=this._labelsOptions.enableMenu;1===o?this._stubs.forEach(((e,t)=>e.setLabelMode(a?0:1))):this._stubs.forEach(((e,t)=>e.setLabelMode(t<i&&a?2:1)))}getElement(){return this._cell}updateCurrencyLabels(){return this._axises.forEach((e=>e.updateCurrencyLabel()))}optimalWidths(){return this._axises.map((e=>e.optimalWidth()))}setSizes(e,t){this._size=(0,ke.size)({width:t.reduce(((e,t)=>e+t),0),height:e}),this._cell.style.width=this._size.width+"px",this._cell.style.minWidth=this._size.width+"px",this._cell.style.height=this._size.height+"px",t.length!==this._axises.length+this._stubs.length&&(0,s.assert)(t.length===this._axises.length+this._stubs.length,"Widgets count should be the same as widths one");let i=0;this._forEachWidgetFromLeft(((s,o)=>{const r=t[o];s.setSizeAndOffset((0,ke.size)({width:r,height:e}),i),i+=r}))}update(){this._axises.forEach((e=>e.update())),this._stubs.forEach((e=>e.update()))}paint(e){this._axises.forEach(((t,i)=>t.paint(e(i)))),this._stubs.forEach(((t,i)=>t.paint(e(i))))}paintStubs(e){this._stubs.forEach((t=>t.paint(e)))}restoreDefaultCursor(){this._axises.forEach((e=>e.restoreDefaultCursor()))}getWidth(){return this._size.width}findAxisWidgetForScale(e){const t=this._axises.find((t=>t.priceScale()===e));return void 0===t?null:t}getScreenshotData(){const e=this._getImage();return{canvas:e,content:e.toDataURL(),contentHeight:this._size.height,contentWidth:this._size.width}}getImage(){return this._getImage()}slotsCount(){return this._axises.length+this._stubs.length}highlightPriceAxisByLabel(e){this._axises.forEach((t=>{const i=t.axisInfo();t.setHighlighted(null!==i&&i.equals(e))}))}axes(){return this._axises}_stubParams(e){var t;return{rendererOptionsProvider:this._rendererOptionsProvider,backgroundBasedTheme:this._backgroundBasedTheme.spawnOwnership(),onActiveOrHoveredChart:null===(t=this._onActiveOrHoveredChart)||void 0===t?void 0:t.spawnOwnership(),sourcesTitlesProvider:()=>this._titlesProvider(this._side,e),contextMenuItemsProvider:()=>this._stubContextMenuProvider(this._side,e),getBackgroundTopColor:this._getBackgroundTopColor,
getBackgroundBottomColor:this._getBackgroundBottomColor,requestRepaint:this._requestRepaint,showHorizontalBorder:this._showHorisontalBorder}}_getImage(){const e=(0,it.createDisconnectedCanvas)(document,this._size),t=(0,it.getPrescaledContext2D)(e);let i=0;return this._forEachWidgetFromLeft(((e,s)=>{const o=e.getWidth();0!==o&&0!==this._size.height&&(t.drawImage(e.getImage(),i,0,o,this._size.height),i+=o)})),e}_forEachWidgetFromLeft(e){const t=[...this._axises,...this._stubs],i="left"===this._side,s=i?-1:t.length,o=i?-1:1;for(let r=i?t.length-1:0;r!==s;r+=o)e(t[r],r,t)}}var hi=i(938614),ui=i(855824),pi=i(98714);class _i{constructor(){this._width=null,this._labelBottom=null,this._currencyInfo=null,this._unitInfo=null,this._measureUnitIdInfo=null,this._fontSize=0,this._currencyAndUnitLabelsWrapper=document.createElement("div"),this._currencyAndUnitLabelsWrapper.className=pi["price-axis-currency-label-wrapper"],this._currencyAndUnitLabelsWrapper.setAttribute("data-name","currency-unit-label-wrapper"),this._controlsContainer=document.createElement("div"),this._controlsContainer.className=pi["price-axis-currency-label"],this._currencyAndUnitLabelsWrapper.appendChild(this._controlsContainer),this._currencyLabelDiv=document.createElement("div"),this._currencyLabelDiv.classList.add(pi.row,"apply-common-tooltip"),this._currencyLabelDiv.dataset.name="currency-label-selector",(0,ii.setTooltipData)(this._currencyLabelDiv,"text",(e=>this._currencyTooltipContent())),this._currencyText=document.createElement("div"),this._currencyText.className=pi["price-axis-currency-label-text"],this._currencyLabelDiv.appendChild(this._currencyText),this._currencyArrowDown=document.createElement("div"),this._currencyArrowDown.className=pi["price-axis-currency-label-arrow-down"],this._currencyArrowDown.innerHTML=ui,this._currencyLabelDiv.appendChild(this._currencyArrowDown),this._measureUnitIdLabelDiv=document.createElement("div"),this._measureUnitIdLabelDiv.className=pi.row,this._measureUnitIdLabelDiv.classList.add("apply-common-tooltip"),this._measureUnitIdLabelDiv.classList.add("readonly"),(0,ii.setTooltipData)(this._measureUnitIdLabelDiv,"text",(e=>this._measureUnitIdTooltipContent())),this._measureUnitIdText=document.createElement("div"),this._measureUnitIdText.className=pi["price-axis-currency-label-text"],this._measureUnitIdLabelDiv.appendChild(this._measureUnitIdText),this._unitLabelDiv=document.createElement("div"),this._unitLabelDiv.classList.add(pi.row,"apply-common-tooltip"),this._unitLabelDiv.dataset.name="unit-label-selector",(0,ii.setTooltipData)(this._unitLabelDiv,"text",(e=>this._unitTooltipContent())),this._unitText=document.createElement("div"),this._unitText.className=pi["price-axis-currency-label-text"],this._unitLabelDiv.appendChild(this._unitText),this._unitArrowDown=document.createElement("div"),this._unitArrowDown.className=pi["price-axis-currency-label-arrow-down"],this._unitArrowDown.innerHTML=ui,this._unitLabelDiv.appendChild(this._unitArrowDown),this._controlsContainer.appendChild(this._currencyLabelDiv),
this._controlsContainer.appendChild(this._measureUnitIdLabelDiv),this._controlsContainer.appendChild(this._unitLabelDiv),this.disableCurrency(),this.disableUnit()}element(){return this._currencyAndUnitLabelsWrapper}currencyLabelElement(){return this._currencyLabelDiv}unitLabelElement(){return this._unitLabelDiv}isEnabled(){return this.currencyLabelEnabled()||this.unitLabelEnabled()||this.measureUnitIdLableEnabled()}isHidden(){return this._currencyAndUnitLabelsWrapper.classList.contains(pi.hidden)}setCurrencyExpanded(e){this._currencyLabelDiv.classList.toggle(pi.expanded,e)}setUnitExpanded(e){this._unitLabelDiv.classList.toggle(pi.expanded,e)}width(){if(null!==this._width)return this._width;let e=0;if(this.currencyLabelEnabled()){const t=this._currencyText.getBoundingClientRect(),i=this._currencyArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}if(this.measureUnitIdLableEnabled()){const t=this._measureUnitIdText.getBoundingClientRect();e=Math.max(e,t.width+2*this._textMarginAndPadding())}if(this.unitLabelEnabled()){const t=this._unitText.getBoundingClientRect(),i=this._unitArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}return this._width=e}drawLabel(e,t,i){var s,o,r;if(!this.isEnabled())return;const n=Math.round(Number(pi.css_wrapper_margin)*i),a=(0,Wt.ceiledEven)(t*i)-2*n,l=Math.round(this.labelBottom()*i),c=l-2*n,d=Math.round(Number(pi.css_value_currency_label_radius)*i);e.fillStyle=getComputedStyle(this._currencyAndUnitLabelsWrapper).backgroundColor,e.fillRect(0,0,Math.ceil(t*i),l);const h=[];h.push(this.currencyLabelEnabled()&&null!==(s=this._currencyText.textContent)&&void 0!==s?s:""),h.push(this.measureUnitIdLableEnabled()&&null!==(o=this._measureUnitIdText.textContent)&&void 0!==o?o:""),h.push(this.unitLabelEnabled()&&null!==(r=this._unitText.textContent)&&void 0!==r?r:""),e.font=(0,Jt.makeFont)(this._fontSize,si.CHART_FONT_FAMILY);const u=new ei.TextWidthCache;let p=0;const _=[];h.forEach((t=>{let i=0;""!==t&&(i=u.yMidCorrection(e,t),p++),_.push(i)}));const m=c/p;e.beginPath();const g=getComputedStyle(this._controlsContainer);e.fillStyle=g.backgroundColor,e.strokeStyle=g.borderColor,(0,Xt.drawRoundRect)(e,n,n,a,c,d),e.fill(),e.stroke(),e.fillStyle=getComputedStyle(this._currencyLabelDiv).color,e.textBaseline="middle",e.textAlign="left";const S=Math.round(this._textMarginAndPadding()*i)+n,v=m/2;let f=n+v;h.forEach(((t,s)=>{""!==t&&((0,it.drawScaled)(e,i,i,(()=>{e.fillText(t,S/i,(f+_[s])/i)})),f=Math.ceil(f+2*v))}))}setHidden(e){this._currencyAndUnitLabelsWrapper.classList.toggle(pi.hidden,e)}enableCurrency(){this._currencyLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableCurrency(){this._currencyLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}enableUnit(){this._unitLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableUnit(){this._unitLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}enableMeasureUnitId(){
this._measureUnitIdLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableMeasureUnitId(){this._measureUnitIdLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}currencyLabelEnabled(){return!this._currencyLabelDiv.classList.contains("js-hidden")}unitLabelEnabled(){return!this._unitLabelDiv.classList.contains("js-hidden")}measureUnitIdLableEnabled(){return!this._measureUnitIdLabelDiv.classList.contains("js-hidden")}currencyConversionAvailable(){return!this._currencyLabelDiv.classList.contains("readonly")}unitConversionAvailable(){return!this._unitLabelDiv.classList.contains("readonly")}setCurrencyInfo(e){if(this._currencyInfo===e)return!1;this._currencyInfo=e;const t=null===e.selectedCurrency?n.t(null,void 0,i(454215)):(0,s.ensureDefined)(e.displayedValues.get(e.selectedCurrency));return this._currencyText.textContent!==t&&(this._currencyText.textContent=t,this._width=null),this._currencyArrowDown.classList.contains("js-hidden")!==e.readOnly&&(this._currencyArrowDown.classList.toggle("js-hidden",e.readOnly),this._currencyLabelDiv.classList.toggle("readonly",e.readOnly),this._width=null),!0}setUnitInfo(e){if(null!==this._unitInfo&&this._unitInfo.selectedUnit===e.selectedUnit&&0===this._unitInfo.availableGroups.size==(0===e.availableGroups.size)&&this._unitInfo.originalUnits.size===e.originalUnits.size)return this._unitInfo=e,!1;this._unitInfo=e;const t=null===e.selectedUnit?n.t(null,void 0,i(454215)):(0,s.ensureDefined)(e.names.get(e.selectedUnit));return this._unitText.textContent!==t&&(this._unitText.textContent=t,this._width=null),this._unitArrowDown.classList.contains("js-hidden")!==(0===e.availableGroups.size)&&(this._unitArrowDown.classList.toggle("js-hidden",0===e.availableGroups.size),this._unitLabelDiv.classList.toggle("readonly",0===e.availableGroups.size),this._width=null),!0}setMeasureUnitIdInfo(e){if(this._measureUnitIdInfo===e)return!1;this._measureUnitIdInfo=e;const t=null===e.selectedMeasureUnitId?n.t(null,void 0,i(454215)):(0,s.ensureDefined)(e.names.get(e.selectedMeasureUnitId));return this._measureUnitIdText.textContent!==t&&(this._measureUnitIdText.textContent=t,this._width=null),this._measureUnitIdLabelDiv.classList.contains("js-hidden")!==(0===e.names.size)&&(this._measureUnitIdLabelDiv.classList.toggle("js-hidden",0===e.names.size),this._width=null),!0}currencyInfo(){return this._currencyInfo}unitInfo(){return this._unitInfo}measureUnitIdInfo(){return this._measureUnitIdInfo}setFontSize(e){this._fontSize!==e&&(this._fontSize=e,this._currencyLabelDiv.style.fontSize=e+"px",this._measureUnitIdLabelDiv.style.fontSize=e+"px",this._unitLabelDiv.style.fontSize=e+"px",this._width=null,this._labelBottom=null)}labelBottom(){if(null!==this._labelBottom)return this._labelBottom;const e=this._controlsContainer.getBoundingClientRect(),t=this._currencyAndUnitLabelsWrapper.getBoundingClientRect(),i=e.y-t.y;return this._labelBottom=e.height+2*i}_resetSizesAndVisibility(){this._width=null,this._labelBottom=null,this._updateVisibility()}_textMarginAndPadding(){
return Number(pi.css_wrapper_margin)+Number(pi.css_row_left_right_padding)+2}_currencyTooltipContent(){const e=this._currencyInfo;return null===e?"":null===e.selectedCurrency?Array.from(e.currencies).map((t=>(0,s.ensureDefined)(e.displayedValues.get(t)))).join(", "):e.readOnly?n.t(null,void 0,i(243931)):n.t(null,void 0,i(548566))}_unitTooltipContent(){const e=this._unitInfo;return null===e?"":null===e.selectedUnit?Array.from(e.units).map((t=>(0,s.ensureDefined)(e.names.get(t)))).join(", "):0===e.availableGroups.size?n.t(null,void 0,i(540012)):n.t(null,void 0,i(185110))}_measureUnitIdTooltipContent(){const e=this._measureUnitIdInfo;return null===e?"":null===e.selectedMeasureUnitId?Array.from(e.measureUnitIds).map((t=>(0,s.ensureDefined)(e.names.get(t)))).join(", "):e.descriptions.get(e.selectedMeasureUnitId)||""}_updateVisibility(){const e=this.isEnabled();this._currencyAndUnitLabelsWrapper.classList.toggle("js-hidden",!e)}}async function mi(e,t,s,o,r,n){const{UnitConversionRenderer:a}=await Promise.all([i.e(88551),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(74600),i.e(82421),i.e(59258),i.e(67158),i.e(43362),i.e(93523),i.e(98734),i.e(32736),i.e(16164),i.e(38985),i.e(82321),i.e(62526),i.e(73788),i.e(32704)]).then(i.bind(i,300203));return new a(e,s,t,o,r,n)}var gi=i(691371);class Si{constructor(e){const{action:t,property:i,undoModel:s,undoText:o,callback:r=null}=e;this._property=i,this._undoModel=s,this._undoText=o,this._action=t,this.setValue(i.value()),i.subscribe(this,this._propertyChanged),null!==r?t.update({onExecute:r.bind(this)}):t.update({onExecute:this._onActionCallback.bind(this)})}destroy(){this._property.unsubscribe(this,this._propertyChanged)}value(){return this._action.isChecked()}setValue(e){this._action.update({checked:Boolean(e)})}_onActionCallback(){this._undoModel.setProperty(this._property,this.value(),this._undoText)}_propertyChanged(e){this.setValue(e.value())}}class vi extends gi.Action{constructor(e,t){super(e),this._binding=new Si({action:this,...t})}destroy(){this._binding.destroy(),super.destroy()}}var fi=i(832312),bi=i(394610),yi=i(546821),Ci=i(883188),wi=i(314824);i(82815);const Ti=new c.TranslatedString("change no overlapping labels",n.t(null,void 0,i(561557))),Pi=new c.TranslatedString("toggle auto scale",n.t(null,void 0,i(642240))),Mi=new c.TranslatedString("toggle log scale",n.t(null,void 0,i(149403))),xi=n.t(null,void 0,i(488314)),Ii=n.t(null,void 0,i(5119)),Li=n.t(null,void 0,i(259396)),Ai=n.t(null,void 0,i(715432)),ki=n.t(null,void 0,i(115332)),Ei=n.t(null,void 0,i(224157)),Di=n.t(null,{context:"scale_menu"},i(34954)),Bi=n.t(null,{context:"scale_menu"},i(235210)),Ni=n.t(null,{context:"scale_menu"},i(131340)),Ri=n.t(null,{context:"scale_menu"},i(655300)),Oi=n.t(null,{context:"scale_menu"},i(19405)),Vi=n.t(null,{context:"scale_menu"},i(775163));const Wi=function(e){const t=new fi.LimitedPrecisionNumericFormatter(e);return(e,i)=>(0,je.isNumber)(i)&&!e.isLog()?t.format(i):""
}(4),Fi=d.enabled("currency_menu_disabled"),Hi=d.enabled("unit_menu_disabled"),zi={contextMenuEnabled:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,countdownEnabled:!0,contextMenu:{general:!0,source:!0},pressedMouseMoveScale:!0,mouseWheelScale:!0,pinchScale:!0,croppedTickMarks:!0};class Ui{constructor(e,t,i,s,o,r,n,a,l){this._actions=null,this._priceScale=null,this._scaleModeButtons=null,this._widthCache=new ei.TextWidthCache(1e3),this._color=null,this._fontSize=null,this._currencyFontSize=0,this._currencyLabelWidth=null,this._isVisible=!0,this._currencyMenu=null,this._unitMenu=null,this._size=(0,ke.size)({width:0,height:0}),this._currentCursorClassName="",this._destroyed=!1,this._highlighted=!1,this._highlightColorCache=null,this._mouseWheelHelper=null,this._dragScaleActive=!1,this._offset=NaN,this._pinching=!1,this._lastHittestResult=null,this._isHovered=new u.WatchedValue(!1),this._selectedViaTap=new u.WatchedValue(!1),this._recalcCurrencyAndUnitVisibility=()=>{if(null===this._currencyLabel)return;let e=!0;switch((0,yi.actualCurrencyUnitVisibility)().value()){case"alwaysOff":e=!1;break;case"visibleOnMouseOver":const t=this._chart.anyPriceAxisHovered().value(),i=null!==this._currencyMenu&&this._currencyMenu.isOpened(),s=null!==this._unitMenu&&this._unitMenu.isOpened();e=t||i||s;break;case"visibleOnTapSelection":e=this._selectedViaTap.value()}this._currencyLabel.setHidden(!e)},this._handleActualAutoLogButtonsVisibility=async e=>{const t=e.value();"alwaysOff"===t?this._scaleModeButtons&&this._destroyScaleModeButtons():(this._scaleModeButtons||(this._scaleModeButtons=await this._createScaleModeButtons()),"alwaysOn"===t?(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._updatePriceScaleModeButtonsVisibility()):this._isHovered.subscribe(this._updatePriceScaleModeButtonsVisibility,{callWithLast:!0})),this.onOptimalWidthNeedToBeRecalculated()},this._updatePriceScaleModeButtonsVisibility=()=>{var e;const t=this._isHovered.value(),i=this._selectedViaTap.value();let s=!1;switch((0,Ci.actualAutoLogButtonsVisibility)().value()){case"visibleOnMouseOver":s=t;break;case"visibleOnTapSelection":s=i;break;case"alwaysOn":s=!0}null===(e=this._scaleModeButtons)||void 0===e||e.element().classList.toggle("price-axis__modeButtons_hidden",!s)},this._updateScaleModeButtons=()=>{var e;null===(e=this._scaleModeButtons)||void 0===e||e.update()},this._chart=e,this._pane=t,this._undoModel=i,this._properties=s,this._isLeft="left"===r,this._options=(0,je.merge)((0,je.clone)(zi),n),this._rendererOptionsProvider=o,this._backgroundBasedTheme=l,this._cell=document.createElement("div"),this._cell.className="price-axis",this._cell.style.width="25px",this._cell.style.left="0",this._canvasConfiguredHandler=()=>{this._undoModel.model().lightUpdate()},this._canvasBinding=(0,it.createBoundCanvas)(this._cell,(0,ke.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const c=this._canvasBinding.canvasElement;c.style.position="absolute",c.style.zIndex="1",
c.style.left="0",c.style.top="0",this._topCanvasBinding=(0,it.createBoundCanvas)(this._cell,(0,ke.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const d=this._topCanvasBinding.canvasElement;d.style.position="absolute",d.style.zIndex="2",d.style.left="0",d.style.top="0",this._cell.setAttribute("aria-hidden","true"),this._mouseEventHandler=new Ft.MouseEventHandler(this._cell,this,{treatVertTouchDragAsPageScroll:!1,treatHorzTouchDragAsPageScroll:!0}),this._options.currencyConversionEnabled||this._options.unitConversionEnabled?(this._currencyLabel=new _i,this._cell.appendChild(this._currencyLabel.element())):this._currencyLabel=null,this._properties.childs().fontSize.subscribe(this,this._onFontSizeChanged),this._options.mouseWheelScale&&(this._mouseWheelHelper=new Ot,this._cell.addEventListener("wheel",this._onMousewheel.bind(this),{passive:!1})),this._axisInfo=a,this._offset=0,this.restoreDefaultCursor(),(0,yi.actualCurrencyUnitVisibility)().subscribe(this,this._recalcCurrencyAndUnitVisibility),this._selectedViaTap.subscribe(this._recalcCurrencyAndUnitVisibility.bind(this)),(0,Ci.actualAutoLogButtonsVisibility)().subscribe(this,this._handleActualAutoLogButtonsVisibility),this._selectedViaTap.subscribe(this._updatePriceScaleModeButtonsVisibility.bind(this)),this._handleActualAutoLogButtonsVisibility((0,Ci.actualAutoLogButtonsVisibility)()).catch((()=>{})),this._chart.anyPriceAxisHovered().subscribe(this._recalcCurrencyAndUnitVisibility,{callWithLast:!0}),this.update()}getContextMenuActions(e){var t;this._initActions();const i=(0,s.ensureNotNull)(this._actions),o=this._chart.actions(),r=[];return(null===(t=this._priceScale)||void 0===t?void 0:t.resetScaleAvailable().value())&&r.push(i.reset,new gi.Separator),r.push(this._autoScaleAction()),this._isMainSeriesAxis()&&r.push(this._lockScaleAction()),r.push(o.scaleSeriesOnly,this._invertAction(),new gi.Separator,this._regularScaleAction(),this._percentageAction(),this._indexedTo100Action(),this._logAction(),new gi.Separator),l.CheckMobile.any()||(r.push(this._createMergeScalesAction()),r.push(new gi.Separator)),d.enabled("fundamental_widget")||r.push(new gi.Action({actionId:"Chart.PriceScale.Labels",options:{label:Ii,subItems:[o.showSymbolLabelsAction,o.showSeriesLastValue,o.showSeriesPrevCloseValue,o.showPrePostMarketPriceLabel,o.showHighLowPriceLabels,d.enabled("show_average_close_price_line_and_label")?o.showAverageClosePriceLabel:null,this._undoModel.model().hasCustomSource("bidask")&&o.showBidAskLabels,o.showStudyPlotNamesAction,o.showStudyLastValue,i.alignLabels].filter(Boolean)}})),r.push((0,bi.createLinesAction)(this._chart)),this._options.countdownEnabled&&r.push(o.showCountdown),this._undoModel.crossHairSource().isMenuEnabled()&&r.push(o.addPlusButton),e&&!this._chart.onWidget()&&d.enabled("show_chart_property_page")&&d.enabled("chart_property_page_scales")&&o.scalesProperties&&r.push(new gi.Separator,o.scalesProperties),r}getElement(){return this._cell}onOptimalWidthNeedToBeRecalculated(e){
(this._size.width<this.optimalWidth()||e)&&this._undoModel.model().fullUpdate()}optimalWidth(){var e,t,i;if(!this.isVisible())return 0;let o=0;const r=this.rendererOptions();if(this._pane.hasState()){const t=(0,it.getContext2D)(this._canvasBinding.canvasElement);t.font=this.baseFont();const i=this._views(2,this._groupedSources());for(let e=i.length;e--;){if(!i[e].isAxisLabelVisible())continue;const s=this._widthCache.measureText(t,i[e].text());o=Math.max(o,s);const r=i[e].secondLineText();r&&(o=Math.max(o,this._widthCache.measureText(t,r)));const n=i[e].thirdLineText();n&&(o=Math.max(o,this._widthCache.measureText(t,n)))}const s=this.priceScale();for(const e of s.marks())o=Math.max(o,this._widthCache.measureText(t,e.label));const r=(null===(e=s.mainSource())||void 0===e?void 0:e.firstValue())||null;if(null!==r){const e=s.coordinateToPrice(1,r),i=s.coordinateToPrice(this._size.height-2,r);if(Math.abs(e-i)>1e-14){const n=s.formatPrice(Math.floor(Math.min(e,i))+.11111111111111,r),a=s.formatPrice(Math.ceil(Math.max(e,i))-.11111111111111,r);o=Math.max(o,this._widthCache.measureText(t,n),this._widthCache.measureText(t,a))}}}let n=0;this._isCurrencyLabelEnabled()&&(null===this._currencyLabelWidth&&(this._currencyLabelWidth=(0,s.ensureNotNull)(this._currencyLabel).width()),n=Math.round(this._currencyLabelWidth));const a=o||34;let l=Math.max(n,null!==(i=null===(t=this._scaleModeButtons)||void 0===t?void 0:t.width())&&void 0!==i?i:0,Math.ceil(r.borderSize+r.additionalPaddingInner+r.paddingInner+r.paddingOuter+a+4));return l+=l%2,l}setSizeAndOffset(e,t){(0,ke.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._cell.style.width=e.width+"px",this._cell.style.height=e.height+"px",this._cell.style.minWidth=e.width+"px"),this._offset!==t&&(this._offset=t,this._cell.style.left=t+"px")}getWidth(){return this._size.width}getImage(){const e=this._size,t=(0,it.createDisconnectedCanvas)(document,e);return(0,it.getPrescaledContext2D)(t).drawImage(this._canvasBinding.canvasElement,0,0,e.width,e.height),null===this._currencyLabel||this._currencyLabel.isHidden()||this._currencyLabel.drawLabel((0,it.getContext2D)(t),e.width,(0,Lt.getCanvasDevicePixelRatio)(t)),t}update(){null!==this._priceScale&&(this._priceScale.marks(),this._updateCurrencyLabelFont(),this.rendererOptions())}paint(e){if(!this._isVisible||0===this._size.width||0===this._size.height)return;if(e===B.InvalidationLevel.None)return;const t=this._pane.state(),i=!t.maximized().value()&&t.collapsed().value(),o=this._pane.hasState();(0,it.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,it.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding);const r=this._groupedSources(),n=null!==this._currencyLabel&&!this._currencyLabel.isHidden(),a=(e,t,i)=>{if(n){e.save(),e.beginPath();const i=(0,s.ensureNotNull)(this._currencyLabel).labelBottom();e.rect(0,i*t.verticalPixelRatio,t.bitmapSize.width,t.bitmapSize.height),e.clip()}i(),n&&e.restore()};if(e>B.InvalidationLevel.Cursor){const e=(0,
it.getContext2D)(this._canvasBinding.canvasElement),t=(0,it.getBindingRenderingInfo)(this._canvasBinding);i||this._alignLabels(),o&&this.updateCurrencyLabel(),this._drawBackground(e,t),a(e,t,(()=>{this._drawDrawingsHighlight(e,t)})),this._drawBorder(e,t),o&&(this._scaleModeButtons&&(this._scaleModeButtons.element().style.background=this._highlighted?this._highlightColor():this.backgroundColor()),i||a(e,t,(()=>{this._drawTickMarks(e,t),this._drawLabels(this._views(0,r),e,t)})))}if(o&&!i){const e=(0,it.getContext2D)(this._topCanvasBinding.canvasElement),t=(0,it.getBindingRenderingInfo)(this._topCanvasBinding);e.clearRect(0,0,t.bitmapSize.width,t.bitmapSize.height),a(e,t,(()=>{this._drawLabels(this._views(1,r),e,t),this._drawCrossHairLabel(e,t)}))}}restoreDefaultCursor(){this._setCursor("")}priceScale(){return(0,s.ensureNotNull)(this._priceScale)}setPriceScale(e){this._priceScale!==e&&(null!==this._priceScale&&(this._priceScale.onMarksChanged().unsubscribe(this,this.onOptimalWidthNeedToBeRecalculated),this._priceScale.modeChanged().unsubscribeAll(this)),this._priceScale=e,null!==e&&(e.onMarksChanged().subscribe(this,this.onOptimalWidthNeedToBeRecalculated),e.modeChanged().subscribe(this,(()=>this.onOptimalWidthNeedToBeRecalculated(!0))),this.onOptimalWidthNeedToBeRecalculated(),this._scaleModeButtons&&(e.modeChanged().subscribe(this,this._updateScaleModeButtons),this._updateScaleModeButtons())))}isVisible(){return this._isVisible}setVisible(e){(e=!!e)!==this._isVisible&&(this._cell.style.display=e?"table-cell":"none",this._isVisible=e)}destroy(){null!==this._currencyMenu&&(this._currencyMenu.close(),this._currencyMenu=null),null!==this._unitMenu&&(this._unitMenu.close(),this._unitMenu=null),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),null!==this._priceScale&&(this._priceScale.onMarksChanged().unsubscribe(this,this.onOptimalWidthNeedToBeRecalculated),this._priceScale.modeChanged().unsubscribeAll(this)),this._priceScale=null,this._mouseEventHandler.destroy(),this._properties.childs().fontSize.unsubscribe(this,this._onFontSizeChanged),null!==this._actions&&(Object.values(this._actions).forEach((e=>{e.destroy()})),this._actions=null),(0,yi.actualCurrencyUnitVisibility)().unsubscribeAll(this),this._chart.anyPriceAxisHovered().unsubscribe(this._recalcCurrencyAndUnitVisibility),(0,Ci.actualAutoLogButtonsVisibility)().unsubscribeAll(this),this._chart.setPriceAxisHovered(this,!1),this._destroyScaleModeButtons(),this._destroyed=!0}axisInfo(){return this._axisInfo}setHighlighted(e){this._highlighted=e}backgroundColor(){return this._pane.state().model().backgroundColor().value()}backgroundTopColor(){return this._pane.state().model().backgroundTopColor().value()}lineColor(){return this._properties.childs().lineColor.value()}textColor(){return this._properties.childs().textColor.value()}fontSize(){
return this._properties.childs().fontSize.value()}baseFont(){return(0,Jt.makeFont)(this.fontSize(),si.CHART_FONT_FAMILY,"")}rendererOptions(){let e=this._rendererOptionsProvider.options();return this._color===e.color&&this._fontSize===e.fontSize||(this._color=e.color),this._fontSize!==e.fontSize&&(this._widthCache.reset(),this._fontSize=e.fontSize,this._currencyLabelWidth=null,this._currencyFontSize=0,this._updateCurrencyLabelFont(),this.onOptimalWidthNeedToBeRecalculated()),this._chart.onWidget()||(e=Object.assign({},e,{paddingInner:Math.max(e.paddingInner,hi.ALERT_LABEL_WIDTH)})),e}mouseEnterEvent(e){this._chart.setPriceAxisHovered(this,!0),this._isHovered.setValue(!0),this._applyLightUpdateIfRequired(),this._mouseEnterOrTouchStartEvent(e)}mouseMoveEvent(e){this._mouseOrTouchMoveEvent(e)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseOrTouchMoveEvent(e),this._mouseEnterOrTouchStartEvent(e),this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}pinchStartEvent(e,t,i,s){return s.bothPointsOnTargetElement}pinchEvent(e,t,i){if(this._zoomAvailable()&&this._options.pinchScale){if(this._dragScaleActive&&this._finishScale(),!this._pinching)return this._pinching=!0,void this._undoModel.startTwoPointsScalePrice(this._pane.state(),this.priceScale(),t.y,i.y);this._undoModel.twoPointsScalePriceTo(this._pane.state(),this.priceScale(),t.y,i.y)}}pinchEndEvent(){this._pinching=!1,this._undoModel.endTwoPointsScalePrice(this._pane.state(),this.priceScale())}mouseDownOutsideEvent(){this._finishScale()}touchStartOutsideEvent(){this._finishScale(),this._selectedViaTap.setValue(!1)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseLeaveOrTouchEndEvent(e),this._mouseUpOrTouchEndEvent(e)}mouseClickEvent(e){this._mouseClickOrTapEvent(e)}tapEvent(e){this._mouseClickOrTapEvent(e)}mouseLeaveEvent(e){this._chart.setPriceAxisHovered(this,!1),this._isHovered.setValue(!1),this._applyLightUpdateIfRequired(),this._mouseLeaveOrTouchEndEvent(e)}mouseDoubleClickEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}doubleTapEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}contextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}touchContextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}dataSourceAtPoint(e,t){const i=this._pane.state();if(!i.maximized().value()&&i.collapsed().value())return null;const s=this._groupedSources(),r=[...s.sources,...s.topLevelSources,...i.customSources(),...i.sourcesByGroup().multipaneSources()];let n=null,a=null;if(!this._priceScale)return null;const l=(e,t)=>{var i;const s=null!==(i=null==a?void 0:a.target())&&void 0!==i?i:0;e.target()>s&&(a=e,n=t)},c=new o.Point(e,t),d=(0,it.getBindingRenderingInfo)(this._canvasBinding);for(let e=r.length-1;e>=0;--e){const t=r[e],s=t.priceAxisViews(i,this._priceScale);if(s&&0!==s.length)for(let e=s.length-1;e>=0;--e){const i=s[e].renderer();if(void 0!==i.hitTest){const e=i.hitTest(c,d,this._isLeft?"left":"right")
;null!==e&&l(e,t)}}}return this._lastHittestResult=a,n}reset(){const e=this._pane.state(),t=this.priceScale();this._undoModel.resetPriceScale(e,t),this.onOptimalWidthNeedToBeRecalculated(!0)}updateCurrencyLabel(){if(null===this._currencyLabel)return;let e=!1;if(this._options.currencyConversionEnabled){const t=this.priceScale().currency(this._undoModel.model().availableCurrencies());null===t||"alwaysOff"===(0,yi.actualCurrencyUnitVisibility)().value()?(e=this._currencyLabel.currencyLabelEnabled(),this._currencyLabel.disableCurrency()):(e=!this._currencyLabel.currencyLabelEnabled(),this._currencyLabel.enableCurrency(),e=this._currencyLabel.setCurrencyInfo(t)||e)}else this._currencyLabel.disableCurrency();if(this._options.unitConversionEnabled){const t="alwaysOff"===(0,yi.actualCurrencyUnitVisibility)().value(),i=this._undoModel.model().availableUnits(),s=this.priceScale().unit(i);null===s||t?(e=e||this._currencyLabel.unitLabelEnabled(),this._currencyLabel.disableUnit()):(e=e||!this._currencyLabel.unitLabelEnabled(),this._currencyLabel.enableUnit(),e=this._currencyLabel.setUnitInfo(s)||e);const o=this.priceScale().measureUnitId(i);null===o||t?(e=e||this._currencyLabel.measureUnitIdLableEnabled(),this._currencyLabel.disableMeasureUnitId()):(e=e||!this._currencyLabel.measureUnitIdLableEnabled(),this._currencyLabel.enableMeasureUnitId(),e=this._currencyLabel.setMeasureUnitIdInfo(o)||e)}else this._currencyLabel.disableUnit(),this._currencyLabel.disableMeasureUnitId();this._updateCurrencyLabelFont(),e&&(this._currencyLabelWidth=null)}_groupedSources(){var e;const t=this._pane.state(),i=t.model(),s=this._pane.state().sourcesByGroup(),o=this._isLeft?s.leftPriceScalesSources():s.rightPriceScalesSources(),r=this._priceScale===t.defaultPriceScale(),n=new Set(t.customSources()),a=e=>!!n.has(e)||(e.priceScale()===this._priceScale||r&&t.isOverlay(e)),l={sources:[...o.filter(a),...t.customSources()],topLevelSources:new Set};if(r){const e=this._pane.state().dataSources();for(const i of e)t.isOverlay(i)&&l.sources.push(i)}const c=null!==(e=i.lineBeingEdited())&&void 0!==e?e:i.lineBeingCreated();c&&a(c)&&(l.topLevelSources.add(c),l.lineBeingEditedOrCreated=c);const d=i.customSourceBeingMoved();d&&a(d)&&(l.topLevelSources.add(d),l.customSourceBeingMoved=d);const h=i.sourcesBeingMoved().filter(a);h.length>0&&(i.sourcesBeingMoved().forEach((e=>l.topLevelSources.add(e))),l.sourcesBeingMoved=h);const u=i.selection().allSources().filter(a);u.length>0&&(u.forEach((e=>l.topLevelSources.add(e))),l.selectedSources=u);const p=i.hoveredSource();return p&&a(p)&&(l.topLevelSources.add(p),l.hoveredSource=p),l}_isCurrencyLabelEnabled(){return null!==this._currencyLabel&&this._currencyLabel.isEnabled()}_updateCurrencyLabelFont(){if(null===this._currencyLabel)return;const e=this.fontSize();e!==this._currencyFontSize&&(this._currencyLabel.setFontSize(e),this._currencyFontSize=e,this._currencyLabelWidth=null,this.onOptimalWidthNeedToBeRecalculated())}_alignLabels(){var e,t,i,s,o;const r=this._size.height;let n=r/2
;const a=[],l=this.priceScale(),c=l.orderedSources().slice(),d=this._pane.state(),h=this.rendererOptions();if(l===d.defaultPriceScale()){const e=d.priceDataSources();for(let t=0;t<e.length;t++)d.isOverlay(e[t])&&c.push(e[t])}const u=l.mainSource(),p=d.sourcesByGroup().multipaneSources();for(const s of[c,d.customSources(),p])for(let o=0;o<s.length;++o){const c=s[o],p=[...null!==(e=c.priceAxisViews(d,l))&&void 0!==e?e:[],...null!==(i=null===(t=c.topPriceAxisViews)||void 0===t?void 0:t.call(c,d,l))&&void 0!==i?i:[]];if(p){const e=p.filter((e=>{if(e.ignoreAlignment()||!e.isVisible())return!1;const{total:t}=e.topBottomTotalHeight(h),i=e.floatCoordinate();return i>-t&&i<r+t}));if(!e.length)continue;a.push(...e),u===c&&(n=e[0].floatCoordinate())}}const _=a.filter((e=>e.floatCoordinate()<=n)),m=a.filter((e=>e.floatCoordinate()>n));_.sort(((e,t)=>t.floatCoordinate()-e.floatCoordinate())),_.length>0&&m.length>0&&m.push(_[0]),m.sort(((e,t)=>e.floatCoordinate()-t.floatCoordinate()));for(const e of a)e.setFixedCoordinate(e.coordinate());if(l.properties().childs().alignLabels.value()){if(m.length>0||_.length>0){{const e=null!==(s=_[0])&&void 0!==s?s:m[0],t=e.getFixedCoordinate(),{top:i,bottom:o,total:n}=e.topBottomTotalHeight(h);n<r&&t-i<0&&t+o>0&&e.setFixedCoordinate(i)}{const e=null!==(o=m[0])&&void 0!==o?o:_[0],t=e.getFixedCoordinate(),{top:i,bottom:s,total:n}=e.topBottomTotalHeight(h);n<r&&t-i<r&&t+s>r&&e.setFixedCoordinate(r-s)}}for(let e=1;e<_.length;e++){const t=_[e],i=_[e-1],{top:s,bottom:o,total:r}=t.topBottomTotalHeight(h),n=t.getFixedCoordinate(),a=i.getFixedCoordinate();if(n>a-r)t.setFixedCoordinate(a-r);else if(a>0&&n-s<0&&n+o>0){const{top:e}=i.topBottomTotalHeight(h);t.setFixedCoordinate(Math.min(a-e-o,s))}}for(let e=1;e<m.length;e++){const t=m[e],i=m[e-1],{bottom:s,total:o}=i.topBottomTotalHeight(h),n=t.getFixedCoordinate(),a=i.getFixedCoordinate();if(n<a+o)t.setFixedCoordinate(a+o);else if(a<r){const{top:e,bottom:i}=t.topBottomTotalHeight(h);n-e<r&&n+i>r&&t.setFixedCoordinate(Math.max(a+s+e,r-i))}}}}_drawTickMarks(e,t){const i=this.priceScale().marks();e.save(),e.font=this.baseFont();const o=this.rendererOptions(),{horizontalPixelRatio:r,verticalPixelRatio:n}=t,a=this._isLeft?Math.floor((this._size.width-o.additionalPaddingInner)*r):0,l=this._isLeft?Math.round(a-o.paddingInner*r):Math.round(a+(o.additionalPaddingInner+o.paddingInner)*r),c=this.fontSize(),d=this._isCurrencyLabelEnabled()?(0,s.ensureNotNull)(this._currencyLabel).labelBottom():0,h=i.map((t=>{if(this._options.croppedTickMarks)return{visible:!0,yCorrection:this._widthCache.yMidCorrection(e,t.label)};const i=t.coord-c/2,s=t.coord+c/2,o=!(s>this._size.height||i<d);return{visible:!(s>this._size.height||i<d),yCorrection:o?this._widthCache.yMidCorrection(e,t.label):0}}));e.fillStyle=this.textColor(),e.textAlign=this._isLeft?"right":"left",e.textBaseline="middle",(0,it.drawScaled)(e,r,n,(()=>{for(let t=i.length;t--;){if(!h[t].visible)continue;const s=i[t];e.fillText(s.label,l/r,s.coord+h[t].yCorrection)}})),e.restore()}async _showCurrenciesContextMenu(){var e
;if(null!==this._currencyMenu&&this._currencyMenu.isOpened())return void this._currencyMenu.close();(0,Ne.trackEvent)("GUI","Currency conversion");const{currencyActions:t}=await Promise.all([i.e(88551),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(74600),i.e(82421),i.e(59258),i.e(67158),i.e(43362),i.e(93523),i.e(98734),i.e(32736),i.e(16164),i.e(38985),i.e(82321),i.e(62526),i.e(73788),i.e(32704)]).then(i.bind(i,639403)),o=await mi(Li,(()=>t(this._undoModel,(0,s.ensureNotNull)(this._currencyLabel).currencyInfo(),this.priceScale())),(0,s.ensureNotNull)(this._currencyLabel).currencyLabelElement(),Fi,(()=>["toggle_currency_menu_inner",this._undoModel.model().id(),this._pane.state().id(),this.priceScale().id()]),(()=>{var e;this._recalcCurrencyAndUnitVisibility(),null===(e=this._currencyLabel)||void 0===e||e.setCurrencyExpanded(!1)}));null===(e=this._currencyLabel)||void 0===e||e.setCurrencyExpanded(!0),this._destroyed?o.close():this._currencyMenu=o}async _showUnitsContextMenu(){var e;if(null!==this._unitMenu&&this._unitMenu.isOpened())return void this._unitMenu.close();(0,Ne.trackEvent)("GUI","Unit conversion");const{unitActions:t}=await Promise.all([i.e(88551),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(74600),i.e(82421),i.e(59258),i.e(67158),i.e(43362),i.e(93523),i.e(98734),i.e(32736),i.e(16164),i.e(38985),i.e(82321),i.e(62526),i.e(73788),i.e(32704)]).then(i.bind(i,748543)),o=await mi(Ai,(()=>t(this._undoModel,(0,s.ensureNotNull)(this._currencyLabel).unitInfo(),this.priceScale())),(0,s.ensureNotNull)(this._currencyLabel).unitLabelElement(),Hi,(()=>["toggle_unit_menu_inner",this._undoModel.model().id(),this._pane.state().id(),this.priceScale().id()]),(()=>{var e;this._recalcCurrencyAndUnitVisibility(),null===(e=this._currencyLabel)||void 0===e||e.setUnitExpanded(!1)}));null===(e=this._currencyLabel)||void 0===e||e.setUnitExpanded(!0),this._destroyed?o.close():this._unitMenu=o}_onFontSizeChanged(){this._currencyLabelWidth=null,this._currencyFontSize=0,this._updateCurrencyLabelFont(),this.onOptimalWidthNeedToBeRecalculated()}_mouseOrTouchMoveEvent(e){var t,i,s,o;if(!this._priceScale)return;if(e.localX<0||e.localY<0||e.localX>=this._size.width||e.localY>=this._size.height)return;let r=!0;const n=this.dataSourceAtPoint(e.localX,e.localY);n?(this._setCursorClassName("pointer"),(null===(i=null===(t=this._lastHittestResult)||void 0===t?void 0:t.data())||void 0===i?void 0:i.hoverModelFromAxis)&&(this._undoModel.model().setHoveredSource(n,null!==(o=null===(s=this._lastHittestResult)||void 0===s?void 0:s.data())&&void 0!==o?o:null,0),r=!1)):this._setResizeCursor(),r&&this._undoModel.model().setHoveredSource(null,null)}_mouseDownOrTouchStartEvent(e){this._zoomAvailable()&&this._options.pressedMouseMoveScale&&!this._pinching&&(this._dragScaleActive=!0,this._undoModel.startScalePrice(this._pane.state(),this.priceScale(),e.localY))}_mouseEnterOrTouchStartEvent(e){this._setResizeCursor()}_pressedMouseOrTouchMoveEvent(e){if(this._dragScaleActive){
const t=this.priceScale();this._undoModel.scalePriceTo(this._pane.state(),t,e.localY)}}_mouseUpOrTouchEndEvent(e){this._finishScale()}_finishScale(){this._dragScaleActive&&(this._undoModel.endScalePrice(this._pane.state(),this.priceScale()),this.restoreDefaultCursor(),this._dragScaleActive=!1)}_mouseClickOrTapEvent(e){if(this._currencyLabel){if(this._currencyLabel.currencyConversionAvailable()&&this._currencyLabel.currencyLabelElement().contains(e.target))return this._showCurrenciesContextMenu(),void e.preventDefault();if(this._currencyLabel.unitConversionAvailable()&&this._currencyLabel.unitLabelElement().contains(e.target))return this._showUnitsContextMenu(),void e.preventDefault()}e.isTouch&&this._selectedViaTap.setValue(!this._selectedViaTap.value());const t=this.dataSourceAtPoint(e.localX,e.localY);t&&this._undoModel.selectionMacro((e=>{var i,s,o;e.selection().isSelected(t)&&this._undoModel.model().lastSelectedHittestData()===(null===(i=this._lastHittestResult)||void 0===i?void 0:i.data())||(e.clearSelection(),e.addSourceToSelection(t,null!==(o=null===(s=this._lastHittestResult)||void 0===s?void 0:s.data())&&void 0!==o?o:null))}))}_mouseLeaveOrTouchEndEvent(e){this._setCursorClassName("")}_mouseDoubleClickOrDoubleTapEvent(e){var t,i,s;if((null===(t=this._currencyLabel)||void 0===t?void 0:t.currencyLabelElement().contains(e.target))||(null===(i=this._currencyLabel)||void 0===i?void 0:i.unitLabelElement().contains(e.target)))return;const o=this.dataSourceAtPoint(e.localX,e.localY);o?this._pane.processDoubleClickOnSource(o,null!==(s=this._lastHittestResult)&&void 0!==s?s:void 0,{origin:"price_scale"}):(this.reset(),(0,Ne.trackEvent)("GUI","Double click price scale"))}_contextMenuOrTouchContextMenuEvent(e){if(this._options.contextMenuEnabled){const t=this.dataSourceAtPoint(e.localX,e.localY);if(null!==t&&this._options.contextMenu.source){return void this._undoModel.model().selectionMacro((i=>{i.selection().isSelected(t)||(i.clearSelection(),i.addSourceToSelection(t)),this._pane.showContextMenuForSelection(e,{origin:"price_scale"})}))}this._options.contextMenu.general&&ti.ContextMenuManager.showMenu(this.getContextMenuActions(!0),e,{statName:"PriceScaleContextMenu"},{menuName:"PriceScaleContextMenu"})}}_setResizeCursor(){const e=this.priceScale();e.isPercentage()||e.isIndexedTo100()?this._setCursorClassName(""):this._zoomAvailable()&&(this._options.pressedMouseMoveScale||this._options.mouseWheelScale)&&this._setCursorClassName("ns-resize")}_setCursorClassName(e){let t="";e&&(t="price-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t)}_zoomAvailable(){return!this.priceScale().isEmpty()&&this.priceScale().hasCalculatedPriceRange()&&this._undoModel.model().zoomEnabled()}_onMousewheel(e){if(!this._zoomAvailable()||!this._options.mouseWheelScale)return;const t=(0,s.ensureNotNull)(this._mouseWheelHelper).processWheel(e).deltaY;if(0===t)return
;e.cancelable&&e.preventDefault();const i=this._undoModel,o=this._pane.state(),r=this.priceScale(),n=this._cell.getBoundingClientRect(),a=e.clientY-n.top,l=a+15*t;i.startScalePrice(o,this.priceScale(),a,!0),i.scalePriceTo(o,r,l),i.endScalePrice(o,r),e.stopPropagation()}_drawCrossHairLabel(e,t){const i=this._pane.state(),s=i.model(),o=this.priceScale(),r=s.crossHairSource().priceAxisViews(i,o);r&&r.length>0&&this._drawLabels(r,e,t)}_drawBackground(e,t){const i=this.backgroundTopColor(),s=this.backgroundColor(),{bitmapSize:o}=t;if(i===s?(0,it.clearRect)(e,0,0,o.width,o.height,this.backgroundColor()):(0,Xt.clearRectWithGradient)(e,0,0,o.width,o.height,i,s),this._highlighted){e.globalAlpha=.5;const t=Te.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight");(0,it.fillRect)(e,0,0,o.width,o.height,t),e.globalAlpha=1}}_drawDrawingsHighlight(e,t){const i=this._pane.state().model(),s=this.priceScale(),o=i.selection().lineDataSources().filter((e=>e.priceScale()===s)).reduce(((e,t)=>{const i=t.priceAxisPoints();return 0===i.length?e:e.concat(i)}),[]);o.length>0&&this._hightlightBackground(e,o,this.priceScale().mainSource(),t);const r=i.crossHairSource();r.startMeasurePoint()&&this._hightlightBackground(e,r.measurePoints(),this.priceScale().mainSource(),t)}_drawBorder(e,t){e.save(),e.fillStyle=this.lineColor();const{horizontalPixelRatio:i}=t,s=Math.max(1,Math.floor(this.rendererOptions().borderSize*i)),o=this._isLeft?t.bitmapSize.width-s:0;e.fillRect(o,0,s,t.bitmapSize.height),e.restore()}_drawLabels(e,t,i){const s=this.rendererOptions(),o=this._isLeft?"right":"left";for(const r of e)r.isAxisLabelVisible()&&(t.save(),r.renderer().draw(t,i,s,this._widthCache,o),t.restore())}_hightlightBackground(e,t,i,s){if(!i)return;const o=i.firstValue();if(null===o)return;let r=t[0].price,n=t[0].price;for(let e=1;e<t.length;e++)r=Math.min(r,t[e].price),n=Math.max(n,t[e].price);const{horizontalPixelRatio:a,verticalPixelRatio:l}=s,c=this.priceScale(),d=Math.floor(c.priceToCoordinate(r,o)*l),h=Math.ceil(c.priceToCoordinate(n,o)*l);(0,it.fillRect)(e,Math.floor(a),d,s.bitmapSize.width,h-d,this._properties.childs().axisHighlightColor.value())}_viewsOrMaxMinViews(e){var t,i;const s=this._pane.state(),o=this.priceScale();if(0===e.length)return[];if(1===e.length)return null!==(t=e[0].priceAxisViews(s,o))&&void 0!==t?t:[];{let t=1/0,r=-1/0,n=null,a=null;for(const l of e){const e=null!==(i=l.priceAxisViews(s,o))&&void 0!==i?i:[];for(const i of e){const e=i.coordinate();e>=r&&(r=e,a=i),e<=t&&(t=e,n=i)}}return a&&n?[a,n]:[]}}_views(e,t){var i,s;const o=this._pane.state(),r=this.priceScale(),n=[];if(1!==e)for(const e of t.sources)t.topLevelSources.has(e)||n.push(...null!==(i=e.priceAxisViews(o,r))&&void 0!==i?i:[]);if(0!==e){const e=new Set,i=t=>!e.has(t),a=t=>{const s=t.filter(i);n.push(...this._viewsOrMaxMinViews(s));for(const t of s)e.add(t)};t.customSourceBeingMoved&&a([t.customSourceBeingMoved]),t.sourcesBeingMoved&&a(t.sourcesBeingMoved),t.selectedSources&&a(t.selectedSources),t.hoveredSource&&a([t.hoveredSource]),
t.lineBeingEditedOrCreated&&a([t.lineBeingEditedOrCreated]);for(const e of[...t.sources,...o.customSources()])e.topPriceAxisViews&&n.push(...null!==(s=e.topPriceAxisViews(o,r))&&void 0!==s?s:[])}return n}_initActions(){if(!this._pane.hasState()||null!==this._actions)return;const e=this._undoModel,t=new wi.ActionWithStandardIcon({actionId:"Chart.PriceScale.Reset",options:{label:ki,iconId:"Chart.Reset",shortcutHint:(0,E.humanReadableHash)(E.Modifiers.Alt+82),statName:"ResetScale",onExecute:()=>this.reset()}}),i=new gi.Action({actionId:"Chart.PriceScale.ToggleAutoScale",options:{label:Ei,checkable:!0,checked:!0,statName:"ToggleAutoScale",onExecute:()=>{e.togglePriceScaleAutoScaleMode(this.priceScale()),this._updateScalesActions()}}}),s=new gi.Action({actionId:"Chart.PriceScale.TogglePercentage",options:{label:Di,checkable:!0,checked:this.priceScale().isPercentage(),statName:"TogglePercantage",onExecute:()=>{e.togglePriceScalePercentageScaleMode(this.priceScale()),this._updateScalesActions()}}}),o=new gi.Action({actionId:"Chart.PriceScale.ToggleIndexedTo100",options:{label:Bi,checkable:!0,checked:this.priceScale().isIndexedTo100(),statName:"ToggleIndexedTo100",onExecute:()=>{e.togglePriceScaleIndexedTo100ScaleMode(this.priceScale()),this._updateScalesActions()}}}),r=new gi.Action({actionId:"Chart.PriceScale.ToggleLogarithmic",options:{label:Ni,checkable:!0,checked:this.priceScale().isLog(),statName:"ToggleLogScale",onExecute:()=>{e.togglePriceScaleLogScaleMode(this.priceScale()),this._updateScalesActions()}}}),n=new gi.Action({actionId:"Chart.PriceScale.ToggleRegular",options:{label:Ri,checkable:!0,checked:this.priceScale().isRegular(),statName:"ToggleRegularScale",onExecute:()=>{e.setPriceScaleRegularScaleMode(this.priceScale()),this._updateScalesActions()}}}),a=new vi({actionId:"Chart.PriceScale.Labels.ToggleNoOverlappingLabelsVisibility",options:{label:Oi,checkable:!0,checked:this.priceScale().properties().childs().alignLabels.value(),statName:"TogglePreciseLabels"}},{property:this.priceScale().properties().childs().alignLabels,undoModel:e,undoText:Ti}),l=new gi.Action({actionId:"Chart.PriceScale.ToggleInvertScale",options:{label:Vi,checkable:!0,checked:this.priceScale().isInverted(),statName:"Invert Scale",onExecute:()=>{e.invertPriceScale(this.priceScale()),this._updateScalesActions()}}});this._actions={reset:t,setAutoScale:i,setPercentage:s,setIndexedTo100:o,setLog:r,setRegular:n,alignLabels:a,invertScale:l},this._updateScalesActions()}_logAction(){return this._isMainSeriesAxis()?this._chart.actions().logSeriesScale:(0,s.ensureNotNull)(this._actions).setLog}_percentageAction(){return this._isMainSeriesAxis()?this._chart.actions().percentSeriesScale:(0,s.ensureNotNull)(this._actions).setPercentage}_indexedTo100Action(){return this._isMainSeriesAxis()?this._chart.actions().indexedTo100SeriesScale:(0,s.ensureNotNull)(this._actions).setIndexedTo100}_autoScaleAction(){return this._isMainSeriesAxis()?this._chart.actions().autoSeriesScale:(0,s.ensureNotNull)(this._actions).setAutoScale}_regularScaleAction(){
return this._isMainSeriesAxis()?this._chart.actions().regularSeriesScale:(0,s.ensureNotNull)(this._actions).setRegular}_lockScaleAction(){const e=this._chart.actions().lockSeriesScale,t=Wi(this.priceScale(),this._undoModel.model().mainSeriesScaleRatio());return e.update({hint:t}),e}_invertAction(){return this._isMainSeriesAxis()?this._chart.actions().invertSeriesScale:(0,s.ensureNotNull)(this._actions).invertScale}_isMainSeriesAxis(){return this.priceScale().hasMainSeries()}_updateScalesActions(){const e=this.priceScale(),t=this._isMainSeriesAxis(),i=(0,s.ensureNotNull)(e.mainSource()).properties(),o=t&&e.isLockScale(),r=t&&6===i.style.value(),n=(0,s.ensureNotNull)(this._actions);n.setRegular.update({checked:e.isRegular(),disabled:o||r}),n.setPercentage.update({checked:e.isPercentage(),disabled:o||r}),n.setIndexedTo100.update({checked:e.isIndexedTo100(),disabled:o||r}),n.setLog.update({checked:e.isLog(),disabled:o||r}),n.setAutoScale.update({checked:e.isAutoScale(),disabled:e.properties().childs().autoScaleDisabled.value()})}_createMergeScalesAction(){const e=this._chart.actions(),t=this._undoModel.model().priceScaleSlotsCount();if(t.left+t.right===1)return 0===t.left?e.moveScaleToLeft:e.moveScaleToRight;const i=[];return i.push(e.mergeLeftScalesAction),i.push(e.mergeRightScalesAction),new gi.Action({actionId:"Chart.PriceScale.MergeAllScales",options:{label:xi,subItems:i}})}_setCursor(e){let t="";"grabbing"!==e&&"ns-resize"!==e||(t="price-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t,this._cell.style.cursor)}async _createScaleModeButtons(){var e;const{PriceScaleModeButtonsRenderer:t}=await Promise.all([i.e(98975),i.e(43848),i.e(64159),i.e(82321),i.e(23555)]).then(i.bind(i,347742)),s=new t({className:"price-axis__modeButtons",setMode:e=>{this._priceScale&&("log"===e?this._chart.model().setPriceScaleMode({log:!this._priceScale.isLog()},this._priceScale,Mi):this._chart.model().setPriceScaleMode({autoScale:!this._priceScale.isAutoScale()},this._priceScale,Pi))},getMode:()=>{var e;return null===(e=this._priceScale)||void 0===e?void 0:e.mode()}});return s.element().style.background=this.backgroundColor(),this._cell.appendChild(s.element()),null===(e=this._priceScale)||void 0===e||e.modeChanged().subscribe(this,this._updateScaleModeButtons),s}_destroyScaleModeButtons(){var e;this._scaleModeButtons&&(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),null===(e=this._priceScale)||void 0===e||e.modeChanged().unsubscribe(this,this._updateScaleModeButtons),this._scaleModeButtons.destroy(),this._scaleModeButtons=null)}_highlightColor(){const e=this.backgroundColor(),t=this._backgroundBasedTheme.value();if(null===this._highlightColorCache||this._highlightColorCache.backgroundColor!==e||this._highlightColorCache.theme!==t){const i=(0,Oe.applyTransparency)(Te.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight"),50),s=(0,
Vt.rgbaToString)((0,Vt.blendRgba)((0,Vt.parseRgba)(this.backgroundColor()),(0,Vt.parseRgba)(i)));this._highlightColorCache={theme:t,backgroundColor:e,resultColor:s}}return this._highlightColorCache.resultColor}_applyLightUpdateIfRequired(){"visibleOnMouseOver"===(0,yi.actualCurrencyUnitVisibility)().value()&&this._undoModel.model().lightUpdate()}}var Gi=i(689010);const qi=(0,r.getLogger)("Chart.ChartUndoModel");class ji extends _.UndoCommand{constructor(e,t,i,s=!0){super(i,!1,s),this._newRightOffsetAndBarSpacing=null,this._model=e,this._rightOffsetAndBarSpacing=t}undo(){if(null!==this._newRightOffsetAndBarSpacing)return void qi.logDebug("TimeScaleChangeUndoCommand.undo: Command is already undone");const e=this._model.timeScale();this._newRightOffsetAndBarSpacing={barSpacing:e.barSpacing(),rightOffset:e.rightOffset()},e.setBarSpacing(this._rightOffsetAndBarSpacing.barSpacing),e.setRightOffset(this._rightOffsetAndBarSpacing.rightOffset),this._model.lightUpdate()}redo(){if(null===this._newRightOffsetAndBarSpacing)return void qi.logDebug("TimeScaleChangeUndoCommand.redo: Command is not undone");const e=this._model.timeScale();e.setBarSpacing(this._newRightOffsetAndBarSpacing.barSpacing),e.setRightOffset(this._newRightOffsetAndBarSpacing.rightOffset),this._model.lightUpdate(),this._newRightOffsetAndBarSpacing=null}}const Ki=(0,r.getLogger)("Chart.ChartUndoModel"),Zi=new c.TranslatedString("scale price",n.t(null,void 0,i(394981)));class Yi extends _.UndoCommand{constructor(e,t,i,s,o,r=!0){super(Zi,!1,r),this._newPriceScaleState=null,this._model=e,this._paneIndex=e.panes().indexOf(t),this._priceScaleId=i.id(),this._state=s,this._timestamp=o?performance.now():null}undo(){if(null!==this._newPriceScaleState)return void Ki.logDebug("PriceScaleChangeUndoCommand.undo: Command is already undone");const[e,t]=this._paneAndScale();this._newPriceScaleState=t.state(),this._model.restorePriceScaleState(e,t,this._state)}redo(){if(null===this._newPriceScaleState)return void Ki.logDebug("PriceScaleChangeUndoCommand.redo: Command is not undone");const[e,t]=this._paneAndScale();this._model.restorePriceScaleState(e,t,this._newPriceScaleState),this._newPriceScaleState=null}canMerge(e){return e instanceof Yi&&null!==this._timestamp&&null!==e._timestamp&&null===this._newPriceScaleState&&e._model===this._model&&e._paneIndex===this._paneIndex&&e._priceScaleId===this._priceScaleId&&Math.abs(e._timestamp-this._timestamp)<1e3}merge(e){this._timestamp=e._timestamp}_paneAndScale(){const e=this._model.panes()[this._paneIndex],t=(0,s.ensureNotNull)(e.getPriceScaleById(this._priceScaleId));return[e,t]}}var $i=i(558634),Xi=i(475892),Ji=i(447935),Qi=i(55907),es=i(15144),ts=i(776734);function is(e,t){(0,ts.getTracker)().then((i=>{if(null!==i){const o=(0,s.ensureNotNull)(e.model().mainSeries().symbolInfo()),r=o.pro_name||o.name;i.trackDrawingsAnalytics(r,e.name(),t)}}))}function ss(e){is(e,"create")}function os(e){is(e,"paste")}var rs=i(86e3),ns=i(673747),as=i(195121);function ls(e){
return"startMoving"in e&&"move"in e&&"endMoving"in e&&"convertYCoordinateToPriceForMoving"in e}var cs=i(526910),ds=i(395394),hs=i(169532),us=i(945982);i(126572);const ps=parseInt(us["css-value-pane-controls-padding-left"]),_s=parseInt(us["css-value-pane-controls-padding-right"]),ms=(0,gt.getHexColorByName)("color-cold-gray-700"),gs=(0,gt.getHexColorByName)("color-cold-gray-400"),Ss=new c.TranslatedString("scroll",n.t(null,void 0,i(42070))),vs=n.t(null,void 0,i(566005)),fs=n.t(null,void 0,i(978972));function bs(e,t,i){e.drawBackground&&e.drawBackground(t,i)}function ys(e,t,i){e.draw(t,i)}function Cs(e,t){return e.paneViews(t)}function ws(e,t){var i,s;return null!==(s=null===(i=e.topPaneViews)||void 0===i?void 0:i.call(e,t))&&void 0!==s?s:[]}function Ts(e,t){return e.labelPaneViews(t)}function Ps(e,t){const i=e.strategyOrdersPaneView();return null===i?null:[i]}function Ms(e,t){return null===e||e.source!==t?null:e.hittest.data()}function xs(e,t,i,s,o){var r,n;const a=null!==(n=null===(r=e.result)||void 0===r?void 0:r.hittest.target())&&void 0!==n?n:0;t.target()>a&&(e.result={hittest:t,source:i,renderer:s,isCustom:o})}const Is={contextMenuEnabled:!0,contextMenu:bi.defaultContextMenuOptions,priceScaleContextMenuEnabled:!0,legendWidgetEnabled:!0,controlsEnabled:!0,propertyPagesEnabled:!0,sourceSelectionEnabled:!0,countdownEnabled:!0},Ls=new Map([[qt.AreaName.Text,"Text"],[qt.AreaName.Style,"Style"]]),As=!d.enabled("display_legend_on_all_charts");let ks=null;function Es(e,t){return!(0,qt.shouldDefaultActionBeExecuted)(e,t,"pressedMouseMoveHandler","touchMoveHandler")}class Ds{constructor(e,t,i,s){this._legendWidget=null,this._paneControls=null,this._isDestroyed=!1,this._trackCrosshairOnlyAfterLongTap=(0,At.lastMouseOrTouchEventInfo)().isTouch,this._startTrackPoint=null,this._exitTrackingModeOnNextTry=!1,this._startMoveSourceParams=null,this._startChangeLineToolParams=null,this._preventSourceChange=!1,this._preventScrollUntilNextMouseDownOrTouchStart=!1,this._clonningAtMoveLineTools=null,this._startCloningPoint=null,this._size=(0,ke.size)({width:0,height:0}),this._themedTopColor=null,this._initCrossHairPosition=null,this._firstZoomPoint=null,this._editDialog=null,this._processing=!1,this._pressedMoveStage=0,this._touchMove=!1,this._startTouchPoint=null,this._isSelecting=!1,this._prevHoveredHittest=null,this._contextMenuX=0,this._contextMenuY=0,this._startScrollingPos=null,this._isScrolling=!1,this._scrollPriceScale=null,this._scrollXAnimation=null,this._prevPinchScale=1,this._pinching=!1,this._wasPinched=!1,this._longTap=!1,this._contextMenuOpenedOnLastTap=!1,this._paneControlsResizeObserver=null,this._lastClickedSource=null,this._customLegendWidgetsFactoryMap=new Map,this._prevMoveEventPosition=null,this._onMagnetStateChangedListener=this._onMagnetStateChanged.bind(this),this._onShiftKeyStateChangedListener=this._onShiftKeyStateChanged.bind(this),this._currentCursorClassName="",this._lastFinishedToolId=null,this._needResetMeasureLater=!1,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null,
this._prevTooltipData=null,this._errorRenderer=null,this._highlightedPriceAxis=new u.WatchedValue({owner:"",axis:null}),this._visuallyCollapsed=new u.WatchedValue(!1),this._endOfSeriesDataBanner=null,this._selectionBeforeMouseDown=new WeakSet,this._canvasConfiguredHandler=()=>this._state&&this._chartModel().lightUpdate(),this._updateVisuallyCollapsed=()=>{this._visuallyCollapsed.setValue(!this.state().maximized().value()&&this.state().collapsed().value())},this._chart=e,this._state=t,this._options=(0,je.merge)((0,je.clone)(Is),i),this._paneWidgetsSharedState=s,this._state&&this._subscribeToState();const o={contextMenuEnabled:this._options.priceScaleContextMenuEnabled,pressedMouseMoveScale:this._options.handleScale.axisPressedMouseMove.price,mouseWheelScale:this._options.handleScale.mouseWheel,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,countdownEnabled:this._options.countdownEnabled,croppedTickMarks:this._options.croppedTickMarks};void 0!==this._options.priceScaleContextMenu&&(o.contextMenu=this._options.priceScaleContextMenu);const r=(e,t,i,s,r)=>new Ui(this._chart,this,this._chartUndoModel(),i,t,e,o,s,r),n=e.properties().childs().scalesProperties,a=this._chartModel().rendererOptionsProvider(),l={backgroundBasedTheme:e.backgroundBasedTheme().spawnOwnership(),stubContextMenuProvider:()=>[],titlesProvider:()=>[],rendererOptionsProvider:a,getBackgroundTopColor:()=>this._chartModel().backgroundTopColor().value(),getBackgroundBottomColor:()=>this._chartModel().backgroundColor().value(),requestRepaint:()=>this._chartModel().lightUpdate()},c={showLabels:!1};this._lhsPriceAxisesContainer=new di(n,"left",r,l,c),this._rhsPriceAxisesContainer=new di(n,"right",r,l,c),this._paneCell=document.createElement("div"),this._paneCell.classList.add("chart-markup-table","pane"),this._div=document.createElement("div"),this._div.classList.add("chart-gui-wrapper"),this._div.setAttribute("data-name","pane-widget-chart-gui-wrapper"),this._paneCell.appendChild(this._div),this._canvasBinding=(0,it.createBoundCanvas)(this._div,(0,ke.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const d=this._canvasBinding.canvasElement;d.style.position="absolute",d.style.left="0",d.style.top="0",this._topCanvasBinding=(0,it.createBoundCanvas)(this._div,(0,ke.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const h=this._topCanvasBinding.canvasElement;h.style.position="absolute",h.style.left="0",h.style.top="0",this._rowElement=document.createElement("div"),this._rowElement.style.display="flex",this._rowElement.appendChild(this._lhsPriceAxisesContainer.getElement()),this._rowElement.appendChild(this._paneCell),this._rowElement.appendChild(this._rhsPriceAxisesContainer.getElement()),d.setAttribute("aria-hidden","true");const p=this._chartModel().mainSeries();p.dataEvents().symbolResolved().subscribe(this,this._updateAccesibilityAttr),
p.onIntervalChanged().subscribe(this,this._updateAccesibilityAttr),this._updateAccesibilityAttr(),this._options.legendWidgetEnabled&&(this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._loadAndCreateLegendWidget()),this._state&&!this._chart.readOnly()&&this._options.controlsEnabled&&this._loadAndCreatePaneControlsWidget(),(0,as.magnetEnabled)().subscribe(this._onMagnetStateChangedListener),(0,st.shiftPressed)().subscribe(this._onShiftKeyStateChangedListener),this._paneCell.addEventListener("dragover",(e=>{e.dataTransfer&&Array.from(e.dataTransfer.files).some(Qi.blobImageFilter)&&e.preventDefault()})),this._paneCell.addEventListener("drop",(e=>{if(window.user.id&&e.dataTransfer&&this._state){const t=Array.from(e.dataTransfer.files).find(Qi.blobImageFilter);if(t){e.preventDefault();const i=(0,Qi.uploadImage)(t),s=URL.createObjectURL(t);this._chartUndoModel().pasteImageAsLineTool(i,s,this._state),i.catch((e=>{(0,k.showChartWarningNotification)("copy",{title:fs,text:e.message})}))}}})),this.setCursorForTool(),this._mouseEventHandler=new Ft.MouseEventHandler(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:!this._options.handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:!this._options.handleScroll.horzTouchDrag}),this._prevHoveredHittest=null,this._highlightedPriceAxis.subscribe((e=>this._highlightPriceAxisByLabel(e.axis))),this._prevPinchScale=0,this._isDestroyed=!1}destroy(){var e;this._chart.onPaneWidgetDestroyed(this);const t=this._chartModel().mainSeries();t.dataEvents().symbolResolved().unsubscribeAll(this),t.onIntervalChanged().unsubscribeAll(this),this._customLegendWidgetsFactoryMap.clear(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._legendWidget&&(this._legendWidget.destroy(),this._legendWidget=null),null!==this._paneControlsResizeObserver&&this._paneControlsResizeObserver.disconnect(),null!==this._paneControls&&(this._paneControls.destroy(),this._paneControls=null),this._lhsPriceAxisesContainer.destroy(),this._rhsPriceAxisesContainer.destroy(),this.hasState()&&this._unsubscribeFromState(),(0,as.magnetEnabled)().unsubscribe(this._onMagnetStateChangedListener),(0,st.shiftPressed)().unsubscribe(this._onShiftKeyStateChangedListener),this._paneWidgetsSharedState.onPaneDestroyed(this),this._errorRenderer&&this._errorRenderer.then((e=>{e.destroy(),this._errorRenderer=null})),this._prevHoveredHittest=null,this._mouseEventHandler.destroy(),null===(e=this._rowElement.parentElement)||void 0===e||e.removeChild(this._rowElement),this._isDestroyed=!0}size(){return this._size}setSize(e){(0,ke.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._paneCell.style.width=e.width+"px",this._paneCell.style.height=e.height+"px",
this._div.style.width=e.width+"px",this._div.style.height=e.height+"px",this._rowElement.classList.toggle("js-hidden",0===e.height),null!==this._legendWidget&&this._legendWidget.updateWidgetModeBySize(e),null!==this._paneControls&&this._paneControls.updateWidgetModeByWidth(e.width))}width(){return this._size.width}height(){return this._size.height}backgroundColor(){return this._chartModel().backgroundColor().value()}highlightedPriceAxis(){return this._highlightedPriceAxis}processDoubleClickOnSource(e,t,i){if((0,hi.isAlertLabel)(e)){const t=e.alert(),s=t.id().value();if(t.isNew()||!s)return;(0,Ji.getChartAlertsFacade)().then((e=>{var t;(0,Ne.trackEvent)("chart_alert","edit",`double_click_on_${null!==(t=null==i?void 0:i.origin)&&void 0!==t?t:"line"}`),e.openEditDialog(s,{actionSource:"alert_label_double_click",dataSourceHub:this._chartModel()})}))}else(0,Zt.isDataSource)(e)&&e.id()!==this._lastFinishedToolId&&this._showEditDialogForSource(e,t)}stretchFactor(){return this._state?this._state.stretchFactor():0}setStretchFactor(e){this.hasState()&&this.state().setStretchFactor(e)}setCursorForTool(e,t,i){if(t&&t.mod()&&e&&e!==this._chartModel().crossHairSource())return void this._setCursorClassName("pointer");if(void 0!==i){switch(i){case rs.PaneCursorType.VerticalResize:this._setCursorClassName("ns-resize");break;case rs.PaneCursorType.HorizontalResize:this._setCursorClassName("ew-resize");break;case rs.PaneCursorType.DiagonalNeSwResize:this._setCursorClassName("nesw-resize");break;case rs.PaneCursorType.DiagonalNwSeResize:this._setCursorClassName("nwse-resize");break;case rs.PaneCursorType.Default:this._setCursorClassName("default");break;case rs.PaneCursorType.Pointer:this._setCursorClassName("pointer");break;case rs.PaneCursorType.Grabbing:this._setCursorClassName("grabbing");break;case rs.PaneCursorType.Text:this._setCursorClassName("text")}return}const s=Yt.tool.value();if((0,Yt.toolIsCursor)(s)){if(null!==this._paneWidgetsSharedState.draggingSource()||this._isScrolling||this._chartUndoModel()&&this._chartUndoModel().model().sourcesBeingMoved().length)return void this._setCursorClassName("grabbing");if(e&&this._options.sourceSelectionEnabled)return void this._setCursorClassName("pointer")}if("eraser"===s)return void this._setCursorClassName("eraser");if("performance"===s)return void this._setCursorClassName("performance");if("zoom"===s)return void this._setCursorClassName("zoom-in");const o=Yt.cursorTool.value();"dot"!==o?"arrow"!==o?this._setCursorClassName(""):this._setCursorClassName("default"):this._setCursorClassName("dot")}showContextMenuForSelection(e,t,i){const s=this._chartUndoModel().selection();if(s.isEmpty())return;const o=s.dataSources().filter((e=>e.hasContextMenu()));this.showContextMenuForSources(o,e,void 0,t,i)}async showContextMenuForSources(e,t,i,s,o){var r,n,a,l,c;if(!e.length||!this._state)return Promise.resolve(null);const d=e[0],h=(0,je.merge)((0,je.clone)(this._options.contextMenu),i||{}),u=new bi.ActionsProvider(this._chart,h)
;if(d===this._chartUndoModel().crossHairSource())return d.handleContextMenuEvent(t),Promise.resolve(null);{const i=await u.contextMenuActionsForSources(e,this._state,t,null==s?void 0:s.origin,null===(r=null==o?void 0:o.data())||void 0===r?void 0:r.customActions);if(0===i.length)return Promise.resolve(null);{let e;return e=d instanceof cs.Series?{menuName:null!==(n=null==s?void 0:s.origin)&&void 0!==n?n:"ObjectTreeContextMenu",detail:{type:"series",id:d.instanceId()}}:(0,ut.isLineTool)(d)?{menuName:null!==(a=null==s?void 0:s.origin)&&void 0!==a?a:"ObjectTreeContextMenu",detail:{type:"shape",id:null!==(l=null==d?void 0:d.id())&&void 0!==l?l:null}}:{menuName:null!==(c=null==s?void 0:s.origin)&&void 0!==c?c:"ObjectTreeContextMenu",detail:{type:"study",id:(null==d?void 0:d.id())||null}},ti.ContextMenuManager.createMenu(i,{takeFocus:!0,returnFocus:!0,isKeyboardEvent:h.isKeyboardEvent},e).then((e=>(e.show(t),e)))}}}leftPriceAxisesContainer(){return this._lhsPriceAxisesContainer}rightPriceAxisesContainer(){return this._rhsPriceAxisesContainer}setPriceAxisSizes(e,t,i){this._priceAxisesContainer(e).setSizes(t,i)}state(){return(0,s.ensureNotNull)(this._state)}hasState(){return null!==this._state}setState(e){this._state!==e&&(this.hasState()&&this._unsubscribeFromState(),this._state=e,this.hasState()&&(this._subscribeToState(),this.updatePriceAxisWidgetsStates()))}getScreenshotData(e){var t,i,s,o;const r=[],n=[];let a,l=[];const c=this.state().sourcesByGroup().priceSources().slice().reverse(),h=this._chart.properties().childs().paneProperties.childs().legendProperties.childs();for(const u of c){const c=u.statusView();if((0,ct.isStudy)(u)&&(h.showLegend.value()||(null==e?void 0:e.showCollapsedStudies))){const s=h.showStudyTitles.value(),o=!0;if(u.properties().childs().visible.value()&&this._chartModel().paneForSource(u)===this.state()&&c&&o){r.push(s?u.statusProvider(null==e?void 0:e.status).text():"");const o=d.enabled("use_last_visible_bar_value_in_legend")&&null!==(i=null===(t=this._chartModel().timeScale().visibleBarsStrictRange())||void 0===t?void 0:t.lastBar())&&void 0!==i?i:null,a=u.legendValuesProvider().getValues(o);n.push(a)}}else if(u===this._chartModel().mainSeries()&&c&&h.showSeriesTitle.value()){a=u.statusProvider((null==e?void 0:e.status)||{}).text();const t=d.enabled("use_last_visible_bar_value_in_legend")&&null!==(o=null===(s=this._chartModel().timeScale().visibleBarsStrictRange())||void 0===s?void 0:s.lastBar())&&void 0!==o?o:null;l=u.legendValuesProvider().getValues(t)}}return{type:"pane",leftAxis:this._lhsPriceAxisesContainer.getScreenshotData(),rightAxis:this._rhsPriceAxisesContainer.getScreenshotData(),content:this._canvasBinding.canvasElement.toDataURL(),canvas:this._canvasBinding.canvasElement,contentWidth:this._size.width,contentHeight:this._size.height,studies:r,studiesValues:n,containsMainSeries:this.containsMainSeries(),mainSeriesText:a,mainSeriesValues:l}}updatePriceAxisWidgetsStates(){if(!this.hasState())return;const e=this._chartModel(),t=e.paneForSource(e.mainSeries());if(!t)return
;const i=e.priceScaleSlotsCount(),s=this.state(),o=s.visibleLeftPriceScales(),r=s.visibleRightPriceScales();this._lhsPriceAxisesContainer.setScales(o,i.left,t.leftPriceScales().length,i.left+i.right),this._rhsPriceAxisesContainer.setScales(r,i.right,t.rightPriceScales().length,i.left+i.right)}updatePriceAxisWidgets(){this._lhsPriceAxisesContainer.update(),this._rhsPriceAxisesContainer.update()}update(){this.hasState()&&(this.updatePriceAxisWidgets(),null!==this._legendWidget&&this._legendWidget.update(),this.updateControls())}updateStatusWidget(e){this.hasState()&&null!==this._legendWidget&&(e.legendWidgetLayoutInvalidated()?this._legendWidget.updateLayout():this._legendWidget.update())}updateControls(){this.hasState()&&null!==this._paneControls&&this._paneControls.update()}updateThemedColors(e){this._themedTopColor=e.topColor,this._updateByThemedColors()}statusWidget(){return this._legendWidget}getElement(){return this._rowElement}canvasElement(){return this._canvasBinding.canvasElement}hasCanvas(e){return this._canvasBinding.canvasElement===e||this._topCanvasBinding.canvasElement===e}pinchStartEvent(){return null===this._paneWidgetsSharedState.scrollingPane()&&null===this._paneWidgetsSharedState.pinchingPane()&&(this._onTouchEvent(),!!this._options.handleScale.pinch&&(this._chartModel().stopTimeScaleAnimation(),this._prevPinchScale=1,this._pinching=!0,this._wasPinched=!0,this._paneWidgetsSharedState.setPinchingPane(this),!0))}pinchEvent(e,t,i,s){if(null!==this._paneWidgetsSharedState.scrollingPane()||this._paneWidgetsSharedState.pinchingPane()!==this)return;if(this._onTouchEvent(),!this._options.handleScale.pinch)return;const o=10*(s-this._prevPinchScale);this._prevPinchScale=s,this._chartModel().zoomTime(e.x,o,!0),this._prevPinchScale=s}pinchEndEvent(){null===this._paneWidgetsSharedState.scrollingPane()&&this._paneWidgetsSharedState.pinchingPane()===this&&(this._onTouchEvent(),this._pinching=!1,this._paneWidgetsSharedState.setPinchingPane(null))}mouseClickEvent(e){this._onMouseEvent(),this._mouseClickOrTapEvent(e)}tapEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseClickOrTapEvent(e))}mouseDownEvent(e){this._onMouseEvent(),this.hasState()&&this._mouseDownOrTouchStartEvent(e,this._dataSourceAtPoint(e.localX,e.localY))}touchStartEvent(e){if(this._paneWidgetsSharedState.startTouch(this),this._preventTouchEventsExceptPinch())return;const t=!this._trackCrosshairOnlyAfterLongTap&&null!==ks&&ks.stateId===this.state().id()&&Math.abs(ks.x-e.localX)+Math.abs(ks.y-e.localY)<5;this._onTouchEvent(),this._chart.setActivePaneWidget(this);const i=this._dataSourceAtPoint(e.localX,e.localY);if(t){const t=this._chartModel().crossHairSource();null!==i&&i.source===t||t.selectPointMode().value()!==Yt.SelectPointMode.None?this.startTrackingMode(new o.Point(e.localX,e.localY),new o.Point(e.localX,e.localY)):!this._chart.readOnly()&&null!==i&&((0,ut.isLineTool)(i.source)&&i.source.userEditEnabled()||(0,hi.isAlertLabel)(i.source))&&this._chartUndoModel().selectionMacro((e=>{e.clearSelection(),
e.addSourceToSelection(i.source,i.hittest.data())}))}this._mouseDownOrTouchStartEvent(e,i),this._mouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._onMouseEvent(),this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._paneWidgetsSharedState.endTouch(this),this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseOrTouchLeaveEvent(e),this._mouseUpOrTouchEndEvent(e))}mouseMoveEvent(e){this._onMouseEvent(),this._mouseOrTouchMoveEvent(e)}pressedMouseMoveEvent(e){this._onMouseEvent(),this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._pressedMouseOrTouchMoveEvent(e))}mouseLeaveEvent(e){this._onMouseEvent(),this._updateHoveredSource(null,new Kt.EnvironmentState(e)),this._mouseOrTouchLeaveEvent(e)}mouseDoubleClickEvent(e){this._onMouseEvent(),this._mouseDoubleClickOrDoubleTapEvent(e)}wheelClickEvent(e){if(this._chart.readOnly())return;const t=this._dataSourceAtPoint(e.localX,e.localY);if(null===t||t.isCustom)return;if((t.hittest.target()||0)<=qt.HitTarget.MovePointBackground)return;const i=new Kt.EnvironmentState(e),o=t.hittest.eraseMarker();if(i.mod()&&void 0!==o&&t.source.processErase)return void t.source.processErase(this._chartUndoModel(),o);const r=this._chartUndoModel();r.selection().isSelected(t.source)||r.selectionMacro((e=>{e.clearSelection();const i=(0,s.ensureNotNull)(t.source);e.addSourceToSelection(i,Ms(t,i))})),this._chart.removeSelectedSources()}doubleTapEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseDoubleClickOrDoubleTapEvent(e))}longTapEvent(e){if(null===this._state||this._preventTouchEventsExceptPinch())return;if(this._onTouchEvent(),this._longTap=!0,null!==this._startTrackPoint||!this._trackingModeShouldBeActive())return;const t=this._chartModel().selection();if(!t.isEmpty()){const i=this._dataSourceAtPoint(e.localX,e.localY);if(null!==i&&t.isSelected(i.source))return}this.startTrackingMode(new o.Point(e.localX,e.localY),new o.Point(e.localX,e.localY),new Kt.EnvironmentState(e))}mouseEnterEvent(e){if(this._onMouseEvent(),!this.hasState())return;this._chart.setActivePaneWidget(this);const t=this._dataSourceAtPoint(e.localX,e.localY);this._updateHoveredSource(t,new Kt.EnvironmentState(e)),this.setCursorPosition(e.localX,e.localY,new Kt.EnvironmentState(e))}contextMenuEvent(e){this._onMouseEvent(),this._contextMenuEvent(e)}touchContextMenuEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._contextMenuEvent(e))}mouseDownOutsideEvent(e){this._processOutsideClick(null,e)}touchStartOutsideEvent(e){this._processOutsideClick(null,e)}cancelZoom(){this._chartModel().crossHairSource().clearSelection(),this._firstZoomPoint=null,this._preventCrossHairMove()&&this._clearCursorPosition()}startTrackingMode(e,t,i){this._startChangeLineToolParams=null,this._startMoveSourceParams=null,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null,this._chartUndoModel().selectionMacro((e=>e.clearSelection())),this._startTrackPoint=e,this._exitTrackingModeOnNextTry=!1,
this.setCursorPosition(t.x,t.y,i),this._initCrossHairPosition=this._chartModel().crossHairSource().currentPoint()}setDragToAnotherPaneCursor(){this._setCursorClassName("grabbing")}cloneLineTools(e,t){return this._chartUndoModel().cloneLineTools(e,t)}exitTrackingMode(){null!==this._state&&null!==this._startTrackPoint&&(this._exitTrackingModeOnNextTry=!0,this._tryExitTrackingMode())}trackingModeEnabled(){return null!==this._state&&null!==this._startTrackPoint}addCustomWidgetToLegend(e,t){this._options.legendWidgetEnabled&&(this._customLegendWidgetsFactoryMap.set(e,t),null!==this._legendWidget&&this._legendWidget.addCustomWidgetToLegend(e,t))}containsMainSeries(){return!!this.hasState()&&this.state().containsMainSeries()}paint(e){if(!this._chartUndoModel()||!this.hasState()||0===this._size.width||0===this._size.height)return;(0,it.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,it.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding),this._state&&(e.priceScaleSideMaxLevel("left")>B.InvalidationLevel.Cursor||e.priceScaleSideMaxLevel("right")>B.InvalidationLevel.Cursor)&&(this._recalculatePriceScales((0,hs.viewportChangeEvent)(this.state())),null!==ks&&ks.stateId===this.state().id()&&this.setCursorPosition(ks.x,ks.y,ks.envState));const t=e.fullInvalidation();if(t>B.InvalidationLevel.Cursor&&null!==ks&&ks.stateId===this.state().id()){const e=this._dataSourceAtPoint(ks.x,ks.y);this._updateHoveredSource(e,(0,st.globalEnvironmentState)())}if(this._lhsPriceAxisesContainer.paint(e.getterForPriceScaleInvalidationLevelBySide("left")),this._rhsPriceAxisesContainer.paint(e.getterForPriceScaleInvalidationLevelBySide("right")),t===B.InvalidationLevel.None)return;const i=this._state&&(this._state.maximized().value()||!this._state.collapsed().value());if(t>B.InvalidationLevel.Cursor){const e=(0,s.ensureNotNull)(this._canvasBinding.canvasElement.getContext("2d"));e.setTransform(1,0,0,1,0,0);const t=(0,it.getBindingRenderingInfo)(this._canvasBinding);this._makeSureIsUpdated(t),this._drawBackground(e,t),i&&this._drawSources(e,t)}if(null!==this._state){const e=(0,s.ensureNotNull)(this._topCanvasBinding.canvasElement.getContext("2d"));e.setTransform(1,0,0,1,0,0);const t=(0,it.getBindingRenderingInfo)(this._topCanvasBinding);e.clearRect(0,0,t.bitmapSize.width,t.bitmapSize.height),i&&this._drawTopViews(e,t),this._drawCrossHair(e,t),i&&this._drawActiveLineTools(e,t)}this._updateEndOfSeriesBanner()}cancelCreatingLineTool(){const e=this._chartUndoModel(),t=this._chartUndoModel().lineBeingCreated();if(t)if(t.pointsCount()<=0&&!(0,U.isLineDrawnWithPressedButton)(t.toolname)){const i=t.points();if(i.length>2){const s=i[i.length-2];e.continueCreatingLine(s),this._finishTool(t)}else e.cancelCreatingLine()}else e.cancelCreatingLine();null!==this._firstZoomPoint&&this.cancelZoom(),this._clearCursorPosition(),this.setCursorForTool()}drawRightThere(e){if((0,U.isLineToolName)(e)&&this.hasState()){const t=this._chartUndoModel(),i=t.crossHairSource(),s=t.model().magnet().align(i.price,i.index,this.state());t.createLineTool({
pane:this.state(),point:{index:i.index,price:s},linetool:e})}}cancelMeasuring(){this._chartUndoModel().crossHairSource().clearMeasure(),(0,Yt.resetToCursor)(),this.setCursorForTool()}async setErrorMessage(e){var t,i,s;e&&!this._errorRenderer&&(this._errorRenderer=this._createErrorBlock()),null===(t=await this._errorRenderer)||void 0===t||t.update({message:null==e?void 0:e.message,icon:(null===(i=this._state)||void 0===i?void 0:i.containsMainSeries())||(null===(s=this._state)||void 0===s?void 0:s.maximized().value())?null==e?void 0:e.icon:void 0,backgroundColor:`linear-gradient(${this._chartModel().backgroundTopColor().value()}, ${this._chartModel().backgroundColor().value()})`,textColor:this._chartModel().dark().value()?gs:ms,solutionId:null==e?void 0:e.solutionId,rawHtml:null==e?void 0:e.rawHtml,buttons:this.containsMainSeries()?null==e?void 0:e.buttons:void 0,maxWidth:null==e?void 0:e.maxWidth,maxHeight:null==e?void 0:e.maxHeight,zeroHeight:null==e?void 0:e.zeroHeight})}collapsedHeight(){var e,t;return Math.max(Math.ceil(null!==(t=null===(e=this._paneControls)||void 0===e?void 0:e.bottomWithMargin())&&void 0!==t?t:0),33)}setCursorPosition(e,t,i){this._updateLastCrosshairPosition(e,t,i),this._chartModel().setAndSaveCurrentPosition(this._correctXCoord(e),this._correctYCoord(t),this.state(),i)}_tryExitTrackingMode(e){this._exitTrackingModeOnNextTry&&(this._startTrackPoint=null,e||this._clearCursorPosition())}_tryStartMeasure(e,t,i,s,o){return!(!(0,Yt.toolIsMeasure)(Yt.tool.value())||t.startMeasurePoint())&&(e.isTouch||this._preventCrossHairMove()||this.setCursorPosition(e.localX,e.localY,i),s=this._chartModel().magnet().align(s,o,this.state()),t.startMeasuring({price:s,index:o},this.state()),!0)}_tryFinishMeasure(e,t){if(t.startMeasurePoint()&&!t.endMeasurePoint()){let i=t.price;const s=t.index;return i=this._chartModel().magnet().align(i,s,this.state()),t.finishMeasure({price:i,index:s}),e.isTouch?(0,Yt.resetToCursor)():this._needResetMeasureLater=!0,this._preventCrossHairMove()&&this._clearCursorPosition(),!0}return!1}_tryStartZoom(e,t,i,s){const o=this._chart.model().model().zoomEnabled();if("zoom"===Yt.tool.value()&&o){const o=this._chartUndoModel(),r=o.timeScale().indexToCoordinate(i)-.5*o.timeScale().barSpacing();return this._firstZoomPoint={price:t,index:i,x:r,y:e.localY},this._preventCrossHairMove()||this.setCursorPosition(e.localX,e.localY,s),this._chartModel().crossHairSource().startSelection(this.state()),!0}return!1}_finishZoom(e){const t=this.state(),i=t.defaultPriceScale(),o=(0,s.ensureNotNull)(t.mainDataSource()).firstValue(),r=i.coordinateToPrice(e.localY,(0,s.ensureNotNull)(o)),n=this._chartUndoModel(),a=Math.round(n.timeScale().coordinateToIndex(e.localX)),l=(0,s.ensureNotNull)(this._firstZoomPoint);a!==l.index&&n.zoomToViewport(l.index,a,l.price,r,t),this._chartModel().crossHairSource().clearSelection(),this._firstZoomPoint=null,(0,Yt.resetToCursor)(),this._preventCrossHairMove()&&this._clearCursorPosition()}_tryFinishZoom(e){return null!==this._firstZoomPoint&&(this._finishZoom(e),!0)}
_tryHandleEraserMouseDown(e,t){if(!("eraser"!==Yt.tool.value()||e.isCustom||(i=e.source,i&&i.customization&&i.customization.disableErasing))){const i=this._chartUndoModel();if((0,ut.isLineTool)(e.source)||(0,ct.isStudy)(e.source)){const s=e.hittest.eraseMarker();return t.mod()&&void 0!==s&&e.source.processErase?e.source.processErase(i,s):i.removeSource(e.source,!1),!0}}var i;return!1}_tryStartChangingLineTool(e,t,i,o){var r,n,a;if(e.isTouch&&null!==this._startTrackPoint)return!1;const l=t.hittest;if((!e.isTouch||!this._preventSourceChange)&&l&&(0,ut.isLineTool)(t.source)&&l.target()===qt.HitTarget.ChangePoint){const c=this._chartUndoModel(),d=(0,s.ensure)(null===(r=this.state().mainDataSource())||void 0===r?void 0:r.firstValue()),h=(0,s.ensureNotNull)(t.source.priceScale()).coordinateToPrice(e.localY,d);c.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(t.source,l.data())}));let u=h;t.source.priceScale()===c.mainSeries().priceScale()&&(u=c.model().magnet().align(h,o,this.state()));const p=null===(n=l.data())||void 0===n?void 0:n.nonDiscreteIndex;p&&(o=c.timeScale().coordinateToFloatIndex(e.localX));const _=null===(a=l.data())||void 0===a?void 0:a.pointIndex;return this._startChangeLineToolParams={source:t.source,startPoint:{index:o,price:u,nonDiscreteIndex:p},screenPoint:{x:e.localX,y:e.localY},pointIndex:_,envState:i},!0}return this._startChangeLineToolParams=null,!1}_tryStartCloning(e,t,i,s){if(i.mod()){const t=this._chartUndoModel().selection().dataSources().filter((e=>e.cloneable()));if(s&&s.cloneable()&&t.push(s),t.length>0)return this._clonningAtMoveLineTools=t.map((e=>e.id())),this._startCloningPoint=new o.Point(e.localX,e.localY),!0}return!1}_tryFinishClonning(e,t,i){const r=this._chartUndoModel(),n=this._chartModel();if(t.mod()&&this._clonningAtMoveLineTools){const a=new o.Point(e.localX,e.localY),l=(0,s.ensureNotNull)(this._startCloningPoint).subtract(a).length(),c=[];for(const e of this._clonningAtMoveLineTools){const t=n.dataSourceForId(e);null!==t&&c.push(t)}if(0===c.length)return!1;if(l>8){const n=this.cloneLineTools(c,!0).map((e=>(0,s.ensureNotNull)(r.model().dataSourceForId(e))));r.selectionMacro((e=>{e.clearSelection();let t=null;n.forEach((s=>{null===t&&(t=Ms(i,s)),e.addSourceToSelection(s,t)}))}));const a=new o.Point(e.localX,e.localY),l=(0,s.ensureNotNull)(n[0].priceScale()),d=(0,s.ensureNotNull)(this.state().mainDataSource()).firstValue(),h={index:r.timeScale().coordinateToIndex(e.localX),price:l.coordinateToPrice(e.localY,(0,s.ensureNotNull)(d))};r.startMovingSources(n,{logical:h,screen:a},null,t),this._clonningAtMoveLineTools=null,this._startCloningPoint=null}return!0}return!1}_mouseDownEventForLineTool(e,t,i,r){var n,a;const l=Yt.tool.value();if(!this.hasState()||(0,U.isLineToolDrawWithoutPoints)(l))return;const c=this._chartUndoModel();let d=!1,h=null;(0,Yt.hideAllDrawings)().value()&&(0,ze.toggleHideMode)(),(0,Yt.lockDrawings)().setValue(!1),e.isTouch&&!e.stylus&&((0,U.isLineToolName)(l)&&!(0,
U.isLineDrawnWithPressedButton)(l)||c.lineBeingCreated())&&this._initToolCreationModeParams(e);const u=c.lineBeingCreated();if(u&&!(0,U.isLineDrawnWithPressedButton)(u.toolname)){const l=(0,s.ensure)(null===(n=u.ownerSource())||void 0===n?void 0:n.firstValue());if(e.isTouch&&!e.stylus){if(!this._startTouchPoint){this._startTouchPoint=new o.Point(e.pageX,e.pageY);const t=u.points(),i=t[t.length-1],r=c.timeScale().indexToCoordinate(i.index),n=(0,s.ensureNotNull)(u.priceScale()).priceToCoordinate(i.price,l);return void(this._initCrossHairPosition=new o.Point(r,n))}}else if(!e.isTouch){h=u;const o=c.model().paneForSource(u);if(o!==this._state&&null!==o){const i=this._externalPaneXCoord(o,e.localX),r=this._externalPaneYCoord(o,e.localY);d=c.continueCreatingLine({index:Math.round(c.timeScale().coordinateToIndex(i)),price:(0,s.ensure)(null===(a=u.priceScale())||void 0===a?void 0:a.coordinateToPrice(r,l))},t)}else{const e=c.model().magnet().align(r,i,this.state());d=c.continueCreatingLine({index:i,price:e},t)}}}else{const t=(0,U.isLineDrawnWithPressedButton)(l);if(!e.isTouch||e.stylus||t){const e={index:i,price:t?r:c.model().magnet().align(r,i,this.state())};h=c.createLineTool({pane:this.state(),point:e,linetool:l}),c.lineBeingCreated()||(d=!0)}}const p=this._dataSourceAtPoint(e.localX,e.localY);h&&c.selectionMacro((e=>{e.addSourceToSelection((0,s.ensureNotNull)(h),null==p?void 0:p.hittest.data())})),d&&h&&(this._finishTool(h,p),e.preventDefault())}_handleSelectionMouseDownAndGetJustDeselectedSource(e,t,i){const s=this._chartUndoModel();let o=null;return(null===t||t.source.isSelectionEnabled())&&s.selectionMacro((s=>{!this._preventSourceChange&&null!==t&&(e.isTouch?t.hittest.target()>=qt.HitTarget.MovePointBackground:t.hittest.target()>qt.HitTarget.MovePointBackground)?(i.mod()||s.selection().isSelected(t.source)||s.clearSelection(),i.mod()&&s.selection().isSelected(t.source)?(o=t.source,s.removeSourceFromSelection(t.source)):s.addSourceToSelection(t.source,t.hittest.data()),s.selection().allSources().length>1&&(0,Ne.trackEvent)("GUI","Multiselect","Click Select")):i.mod()||s.clearSelection()})),o}_processMouseMoveWhileZoom(e,t){this._preventCrossHairMove()||this.setCursorPosition(e.localX,e.localY,t)}_updateCommonTooltip(e,t){let i=null;if(null!==e&&null!==e.hittest){const t=e.hittest.data();t&&(i=t.tooltip||null)}if(null===this._prevTooltipData&&null===i)return;if(null===i||""===i.text)return this._prevTooltipData=null,void(0,ns.hide)(t);if(this._prevTooltipData&&(0,Ut.default)(i,this._prevTooltipData))return;this._prevTooltipData=i;const s=(0,je.clone)(i);if(void 0!==s.rect){const e=this._paneCell.getBoundingClientRect();s.rect.x+=e.left,s.rect.y+=e.top}(0,ns.show)(s)}_setCursorPositionOnExternalPane(e,t,i,s){t=this._externalPaneXCoord(e,t),i=this._externalPaneYCoord(e,i);this._chart.paneByState(e).setCursorPosition(t,i,s)}_updateLastCrosshairPosition(e,t,i){const s=this.state().id();ks={x:e,y:t,envState:i,stateId:s}}_setCursorClassName(e){let t="";e&&(t="pane--cursor-"+e),
this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._paneCell.classList.remove(this._currentCursorClassName),t&&this._paneCell.classList.add(t),this._currentCursorClassName=t,this._paneCell.style.cursor)}_processMouseUpOrTouchEndHandler(e){const t=this._dataSourceAtPoint(e.localX,e.localY);if(null!==t){const i=this._sourceWasSelected(t);t.hittest.tryCallMouseUpOrTouchEndHandler(e,{sourceWasSelected:i})}}_crossHairShouldBeVisible(){const e=this._chartModel().crossHairSource();return(0,U.isLineToolName)(Yt.tool.value())||(0,Yt.toolIsMeasure)(Yt.tool.value())||e.startMeasurePoint()&&!e.endMeasurePoint()||null!==this._firstZoomPoint||null!==this._chartModel().lineBeingEdited()||null!==this._chartModel().lineBeingCreated()}_clearCursorPosition(){ks=null,this._chartModel().clearCurrentPosition()}_dataSourceAtPoint(e,t){var i,s;if(!this.hasState())return null;const r={result:null},n=this._chartUndoModel();if((0,U.isLineToolName)(Yt.tool.value())||null!==n.lineBeingCreated())return r.result;if(this._currentChangingLineToolHitTest)return this._currentChangingLineToolHitTest;const a=new Set;if(this._currentMovingHitTest&&this._currentMovingHitTest.sourceAtPoint.hittest.data()){if(!(null===(i=this._currentMovingHitTest.cancelledContainer)||void 0===i?void 0:i.cancelled))return this._currentMovingHitTest.sourceAtPoint;a.add(this._currentMovingHitTest.sourceAtPoint.source.id())}if(this._currentMovingHitTest&&this._currentMovingHitTest.sourceAtPoint.hittest.data()&&!(null===(s=this._currentMovingHitTest.cancelledContainer)||void 0===s?void 0:s.cancelled))return this._currentMovingHitTest.sourceAtPoint;const l=this.state(),c=(0,it.getBindingRenderingInfo)(this._canvasBinding);this._makeSureIsUpdated(c);const d=xs.bind(null,r),h=new o.Point(e,t);if(!l.maximized().value()&&l.collapsed().value()||(0,At.lastMouseOrTouchEventInfo)().isTouch&&(Yt.activePointSelectionMode.value()!==Yt.SelectPointMode.None||null!==this._startTrackPoint))return this._hitTestSources(c,[n.crossHairSource()],h,d,!1,a),r.result;const u=l.sourcesByGroup(),p=n.selection(),_=p.dataSources().filter((e=>e.isMultiPaneEnabled()||n.paneForSource(e)===l));this._hitTestSources(c,_,h,d,!1,a),this._hitTestSources(c,p.customSources(),h,d,!0,a),p.allSources().forEach((e=>a.add(e.id()))),this._hitTestSources(c,[n.crossHairSource()],h,d,!1,a),this._hitTestSources(c,l.customSources(jt.CustomSourceLayer.Topmost),h,d,!0,a),this._hitTestSources(c,u.tradingSources(),h,d,!1,a),this._hitTestSources(c,l.customSources(jt.CustomSourceLayer.Foreground),h,d,!0,a);const m=u.hitTestSources();if(this._hitTestSources(c,m,h,d,!1,a),this.containsMainSeries()){const e=n.activeStrategySource().value();if(null!==e&&!a.has(e.id())){const t=e.strategyOrdersPaneView();if(null!==t){const i=t.renderer(c);if(null!==i){const t=i.hitTest(h,c);t&&xs(r,t,e,i,!1)}}}}return null===r.result&&this._hitTestSources(c,l.customSources(jt.CustomSourceLayer.Background),h,d,!0,a),r.result}_sourceWasSelected(e){return!!e&&this._selectionBeforeMouseDown.has(e.source)}_hitTestSources(e,t,i,o,r,n){
const a=(0,s.ensureNotNull)(this._state);for(let s=t.length-1;s>=0;--s){const l=t[s];if(n.has(l.id()))continue;const c=l.paneViews(a);if(null!==c&&0!==c.length)for(let t=c.length-1;t>=0;--t){const s=c[t].renderer(e);if(s&&s.hitTest){const t=s.hitTest(i,e);null!==t&&o(t,l,s,r)}}}}_tryStartMovingLineTool(e,t,i,r){var n;if(null===t.source||!t.source.movable()||null!==this._startTrackPoint)return!1;if(!this._preventSourceChange){const a=this._chartUndoModel(),l=(0,s.ensureNotNull)((0,s.ensureNotNull)(this._state).mainDataSource()).firstValue(),c=(0,s.ensureNotNull)(t.source.priceScale()),d=null===l?NaN:c.coordinateToPrice(e.localY,l);let h=(t.source.isSelectionEnabled()?a.selection().allSources():[t.source]).filter(ls);const u=h.filter(ut.isLineTool);h=u.length>0?u:h.includes(t.source)?[t.source]:[h[0]];const p=new o.Point(e.localX,e.localY),_={index:r,price:d},m=null===(n=t.hittest.data())||void 0===n?void 0:n.activeItem;return this._startMoveSourceParams={source:h,startPoint:{logical:_,screen:p},activeItem:void 0===m?null:m,envState:i},!0}return this._startMoveSourceParams=null,!1}_chartModel(){return this._chart.model().model()}_chartUndoModel(){return this._chart.model()}_externalPaneXCoord(e,t){t+=this._div.getBoundingClientRect().left+document.body.scrollLeft;const i=(0,s.ensureNotNull)(this._chart.paneByState(e)),o=i._div.getBoundingClientRect().left+document.body.scrollLeft;return i._correctXCoord(t-o)}_externalPaneYCoord(e,t){t+=this._div.getBoundingClientRect().top+document.body.scrollTop;const i=(0,s.ensureNotNull)(this._chart.paneByState(e)),o=i._div.getBoundingClientRect().top+document.body.scrollTop;return i._correctYCoord(t-o)}_correctXCoord(e){return Math.max(0,Math.min(e,this._size.width-1))}_correctYCoord(e){return Math.max(0,Math.min(e,this._size.height-1))}_processScroll(e){if(!this._chart.model().model().scrollEnabled())return;const t=performance.now();this._startScrollingPos||this._preventScroll()||(this._startScrollingPos={x:e.clientX,y:e.clientY,timestamp:t,localX:e.localX,localY:e.localY});const i=this._chartUndoModel();let s=this.state().defaultPriceScale();if(this._startScrollingPos&&!this._isScrolling&&(this._startScrollingPos.x!==e.clientX||this._startScrollingPos.y!==e.clientY))return i.beginUndoMacro(Ss),null===this._scrollXAnimation&&this._options.useKineticScroll&&(this._scrollXAnimation=new Gi.KineticAnimation(.2,7,.997,15),this._scrollXAnimation.addPosition(e.clientX,this._startScrollingPos.timestamp)),i.selection().isEmpty()||(s=i.selection().allSources()[0].priceScale()),null===s||s.isEmpty()||(this._scrollPriceScale=s,i.startScrollPrice(this.state(),s,e.localY)),i.startScrollTime(e.localX),this._isScrolling=!0,this.setCursorForTool(),void this._paneWidgetsSharedState.setScrollingPane(this);this._isScrolling&&(null!==this._scrollPriceScale&&i.scrollPriceTo(this.state(),this._scrollPriceScale,e.localY),i.scrollTimeTo(e.localX),null!==this._scrollXAnimation&&this._scrollXAnimation.addPosition(e.clientX,t))}_finishScroll(){const e=this._chartUndoModel();e.endScrollTime(),
null!==this._scrollPriceScale&&e.endScrollPrice(this.state(),this._scrollPriceScale),e.endUndoMacro(),this._isScrolling=!1,this._startScrollingPos=null,this._scrollPriceScale=null,this.setCursorForTool(),this._paneWidgetsSharedState.setScrollingPane(null)}_endScroll(e){if(!this._isScrolling)return!1;this._finishScroll();const t=this._scrollUndoCommandInStack(),i=performance.now();return null!==this._scrollXAnimation&&(this._scrollXAnimation.start(e.clientX,i),this._scrollXAnimation.finished(i)||(this._chartModel().stopTimeScaleAnimation(),this._chartModel().setTimeScaleAnimation(this._scrollXAnimation),this._scrollXAnimation=null)),t}_preventScroll(){return this._trackCrosshairOnlyAfterLongTap&&this._longTap||this._contextMenuOpenedOnLastTap||(0,U.isLineToolName)(Yt.tool.value())||Boolean(this._chartUndoModel().lineBeingCreated())||null!==this._startTrackPoint||this._preventScrollUntilNextMouseDownOrTouchStart}_isSelectPointModeEnabled(){return this._chartUndoModel().crossHairSource().selectPointMode().value()!==Yt.SelectPointMode.None}_preventCrossHairMove(){return!!this._trackCrosshairOnlyAfterLongTap&&(null===this._chart.trackingModePaneWidget()&&(!!this._contextMenuOpenedOnLastTap||!this._crossHairShouldBeVisible()&&null===this._startTrackPoint))}_finishTool(e,t=null){const i=this._chartUndoModel(),s=e.toolname;if(s===Yt.tool.value()&&(0,Yt.resetToCursor)(),this._preventCrossHairMove()&&this._clearCursorPosition(),i.selectionMacro((i=>{i.addSourceToSelection(e,Ms(t,e))})),(0,ut.isEditableTextLineTool)(e)&&e.activateEditingOnCreation())e.activateTextEditingOn(this._div,!0);else if((0,U.isTextToolName)(s)){const t=i.createUndoCheckpoint();this._chart.showChartPropertiesForSource(e,at.TabNames.text,void 0,t)}this._lastFinishedToolId=e.id(),(0,Le.emit)("drawing_event",e.id(),"create"),ss(e)}_alignSourcesThatBeingMoved(e,t,i,s,r){const n=this._chartUndoModel(),a=2===r?NaN:n.timeScale().coordinateToIndex(t);n.model().sourcesBeingMoved().forEach((e=>{var l;let c=a,d=e.convertYCoordinateToPriceForMoving(i,this.state().mainDataSource());if(null===d){if(1!==r)return;d=NaN}if((0,ct.isStudy)(e)){const e=n.mainSeries(),t=e.bars().firstIndex(),i=e.bars().lastIndex();null!==t&&null!==i&&2!==r&&(c=Math.min(Math.max(a,t),i)),1!==r&&(d=this._chartModel().magnet().align(d,a,this.state()))}null!==this._currentMovingHitTest&&void 0!==(null===(l=this._currentMovingHitTest.sourceAtPoint.hittest.data())||void 0===l?void 0:l.cursorType)||this.setCursorForTool(),n.moveSources({screen:new o.Point(t,i),logical:{index:c,price:d}},s)}))}_resetMeasureIfRequired(){this._needResetMeasureLater&&((0,Yt.resetToCursor)(),this._needResetMeasureLater=!1)}_makeSureIsUpdated(e){var t;const i=this.state(),s=[...i.dataSources(),...i.customSources()];for(const o of s){const s=o.paneViews(i);if(null!==s)for(const i of s)null===(t=i.makeSureIsUpdated)||void 0===t||t.call(i,e)}}_drawBackground(e,t){const i=this._chartModel(),s=i.backgroundTopColor().value(),o=i.backgroundColor().value();s===o?(0,
it.clearRect)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,o):(0,Xt.clearRectWithGradient)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,s,o)}_drawWatermark(e,t){const i=this._chartModel().watermarkSource();if(null===i)return;if(!this.state().containsMainSeries())return;const s=i.paneViews();for(const i of s){e.save();const s=i.renderer(t);s&&s.draw(e,t),e.restore()}}_drawCrossHair(e,t){const i=this._chartUndoModel().crossHairSource();i.invalidateLockPosition(),i.visible||null===Yt.crosshairLock.value()||i.updateAllViews((0,hs.sourceChangeEvent)(i.id())),this._drawSourceImpl(e,t,Cs,ys,i)}_drawActiveLineTools(e,t){const i=this._chartModel(),s=[i.lineBeingCreated(),i.lineBeingEdited(),...i.sourcesBeingMoved(),i.customSourceBeingMoved()].filter((e=>!!e));for(const o of s){(i.paneForSource(o)===this.state()||(0,Zt.isDataSource)(o)&&o.isMultiPaneEnabled())&&this._drawSourceImpl(e,t,Cs,ys,o)}}_drawTopViews(e,t){for(const i of this.state().sourcesByGroup().all())i.topPaneViews&&this._drawSourceImpl(e,t,ws,ys,i)}_drawSources(e,t){const i=this.state(),s=i.model(),o=i.sourcesByGroup(),r=o.tradingSources(),n=o.generalSources(),a=o.phantomSources(),l=i.customSources(jt.CustomSourceLayer.Background).slice(),c=i.customSources(jt.CustomSourceLayer.Foreground).slice(),d=i.customSources(jt.CustomSourceLayer.Topmost).slice(),h=s.activeStrategySource().value(),u=s.replayStudyStrategy().value();this._drawSourceImpl(e,t,Cs,ys,s.gridSource()),this._drawWatermark(e,t);for(const i of l)this._drawSourceImpl(e,t,Cs,bs,i);for(const i of n)this._drawSourceImpl(e,t,Cs,bs,i);for(const i of c)this._drawSourceImpl(e,t,Cs,bs,i);for(const i of a)this._drawSourceImpl(e,t,Cs,bs,i);const p=new Set;[s.lineBeingCreated(),s.lineBeingEdited(),...s.sourcesBeingMoved(),s.customSourceBeingMoved()].filter(je.notNull).forEach((e=>p.add(e.id())));let _=s.hoveredSource();null!==_&&((0,Zt.isDataSource)(_)&&!_.showOnTopOnHovering()||p.has(_.id())||(0,Zt.isDataSource)(_)&&!n.includes(_)?_=null:p.add(_.id()));const m=s.selection().allSources().filter((e=>!((0,Zt.isDataSource)(e)&&!n.includes(e))&&!p.has(e.id())));m.forEach((e=>p.add(e.id())));for(const i of l)this._drawSourceImpl(e,t,Cs,ys,i,p);for(const i of n)this._drawSourceImpl(e,t,Cs,ys,i,p);for(const i of c)this._drawSourceImpl(e,t,Cs,ys,i,p);h&&this.containsMainSeries()&&this._drawSourceImpl(e,t,Ps,ys,h,p),u&&this._drawSourceImpl(e,t,Ps,ys,u,p);for(const i of r)this._drawSourceImpl(e,t,Cs,bs,i);for(const i of d)this._drawSourceImpl(e,t,Cs,bs,i);for(const i of n)this._drawSourceImpl(e,t,Ts,ys,i,p);for(const i of c)this._drawSourceImpl(e,t,Ts,ys,i,p);for(const i of r)this._drawSourceImpl(e,t,Cs,ys,i,p);for(const i of d)this._drawSourceImpl(e,t,Cs,ys,i,p);for(const i of m)this._drawSourceImpl(e,t,Cs,ys,i),i===h&&this.containsMainSeries()&&this._drawSourceImpl(e,t,Ps,ys,h);for(const i of m)this._drawSourceImpl(e,t,Ts,ys,i);_&&(this._drawSourceImpl(e,t,Cs,ys,_),_===h&&this.containsMainSeries()&&this._drawSourceImpl(e,t,Ps,ys,h),this._drawSourceImpl(e,t,Ts,ys,_));for(const i of a)this._drawSourceImpl(e,t,Cs,ys,i,p)}
_drawSourceImpl(e,t,i,s,o,r){if(r&&r.has(o.id()))return;const n=i(o,this.state());if(n)for(const i of n){const o=i.renderer(t);o&&(e.save(),s(o,e,t),e.restore())}}_updateByThemedColors(){null!==this._legendWidget&&this._legendWidget.updateThemedColors(this._themedTopColor),null!==this._paneControls&&this._paneControls.updateThemedColors(this._themedTopColor)}_scrollUndoCommandInStack(){const e=this._chartUndoModel().undoHistory().undoStack();if(e.isEmpty())return!1;const t=e.head();if(!(t instanceof $t.UndoMacroCommand))return!1;if(t.isEmpty())return!1;const i=t.commands()[0];return i instanceof Yi||i instanceof ji}_onStateDestroyed(){this.setState(null)}_onDataSourcesCollectionChanged(){this._startMoveSourceParams=null}_processMouseEnterLeaveMoveHandlers(e,t){var i,s,o,r;if(null!==this._prevHoveredHittest&&(this._prevHoveredHittest.renderer!==(null==e?void 0:e.renderer)||(null===(i=this._prevHoveredHittest.hittest.data())||void 0===i?void 0:i.activeItem)!==(null===(s=e.hittest.data())||void 0===s?void 0:s.activeItem))){const e=this._sourceWasSelected(this._prevHoveredHittest);(0,qt.tryCallHandler)(t,{sourceWasSelected:e},null===(o=this._prevHoveredHittest.hittest.data())||void 0===o?void 0:o.mouseLeaveHandler),this._prevHoveredHittest=null}if(!t.isTouch&&null!==e){const i=this._sourceWasSelected(e);(null===(r=this._prevHoveredHittest)||void 0===r?void 0:r.renderer)!==e.renderer&&(e.hittest.tryCallMouseEnterHandler(t,{sourceWasSelected:i}),this._prevHoveredHittest=e),e.hittest.tryCallMouseMoveHandler(t,{sourceWasSelected:i})}}_startChangeOrMoveLineToolIfNeeded(){if(null!==this._startChangeLineToolParams){const e=this._startChangeLineToolParams;this._chartUndoModel().startChangingLinetool(e.source,e.startPoint,e.pointIndex,e.envState)}if(null!==this._startMoveSourceParams){const e=this._startMoveSourceParams;this._chartUndoModel().startMovingSources(e.source,e.startPoint,e.activeItem,e.envState)}this._startMoveSourceParams=null,this._startChangeLineToolParams=null}_trackingModeShouldBeActive(){return!(!this._trackCrosshairOnlyAfterLongTap||this._contextMenuOpenedOnLastTap||this._crossHairShouldBeVisible())&&this._longTap}_processOutsideClick(e,t){var i;let s=null;const o=this._chartModel();if(null!==e&&(s=e.isCustom?o.customSourceName(e.source):e.source.id()),null!==this._lastClickedSource&&this._lastClickedSource.id!==s){const e=this._lastClickedSource.id;let i=this._lastClickedSource.isCustom?o.customSourceForName(e):o.dataSourceForId(e);null!==i||this._lastClickedSource.isCustom||(i=o.dataSourceForId(e)),null!==i&&i.onClickOutside&&(i.onClickOutside((0,it.getBindingRenderingInfo)(this._canvasBinding),t),this._chartModel().updateSource(i))}this._lastClickedSource=null!==s?{id:s,isCustom:null!==(i=null==e?void 0:e.isCustom)&&void 0!==i&&i}:null}async showConfetti(e,t){{const s=await i.e(6316).then(i.bind(i,485537));"performance"===Yt.tool.value()&&s.confetti(e,t)}}_mouseClickOrTapEvent(e){var t;if(!this.hasState())return;es.performanceTestMode&&"performance"===Yt.tool.value()&&this.showConfetti(e.pageX,e.pageY)
;const i=this._dataSourceAtPoint(e.localX,e.localY),o=i&&i.source,r=this._chartUndoModel(),n=Boolean(null===(t=null==i?void 0:i.hittest.data())||void 0===t?void 0:t.hideCrosshairLinesOnHover);this._processOutsideClick(i,e),!this._isSelectPointModeEnabled()||n||e.isTouch&&this.trackingModeEnabled()&&!this._exitTrackingModeOnNextTry||r.crossHairSource().trySelectCurrentPoint();const a=this._sourceWasSelected(i);null!==i&&i.hittest.tryCallClickOrTapHandler(e,{sourceWasSelected:a})&&r.model().updateSource((0,s.ensureNotNull)(o)),!e.isTouch||this._isSelectPointModeEnabled()||i&&i.source===r.crossHairSource()||this._tryExitTrackingMode(),o&&(0,ut.isLineTool)(o)&&this._lastFinishedToolId!==o.id()&&(0,Le.emit)("drawing_event",o.id(),"click"),this._resetMeasureIfRequired()}_mouseDownOrTouchStartEvent(e,t){var i,r,n,a,l,c,d;this._pressedMoveStage=1,this._preventScrollUntilNextMouseDownOrTouchStart=!1,this._selectionBeforeMouseDown=new Set(this._chartModel().selection().allSources()),e.isTouch&&(this._longTap=!1,this._exitTrackingModeOnNextTry=null!==this._startTrackPoint,this._paneWidgetsSharedState.clearDraggingSource()),this._contextMenuOpenedOnLastTap=!1,this._lastFinishedToolId=null;const h=this._chartModel();if(h.stopTimeScaleAnimation(),e.isTouch&&this._switchTrackingModeFromAnotherPaneIfNeeded(e),document.activeElement!==document.body&&document.activeElement!==document.documentElement)document.activeElement&&document.activeElement.blur?document.activeElement.blur():document.body.focus();else{const e=document.getSelection();null!==e&&e.removeAllRanges()}(0,Le.emit)("mouse_down",{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY}),this._updateCommonTooltip(null);const u=this._chartUndoModel(),p=new Kt.EnvironmentState(e);u.mainSeries().clearGotoDateResult();const _=this.state().defaultPriceScale();if(u.timeScale().isEmpty())return;const m=u.crossHairSource();if(!e.isTouch&&!(0,U.isLineDrawnWithPressedButton)(Yt.tool.value())){const t=u.lineBeingCreated(),i=null!==t?u.model().paneForSource(t):null;null!==i&&i!==this._state?this._setCursorPositionOnExternalPane(i,e.localX,e.localY,p):this.setCursorPosition(e.localX,e.localY,p)}e.isTouch&&(0,U.isLineToolName)(Yt.tool.value())&&((0,U.isLineDrawnWithPressedButton)(Yt.tool.value())||null!==m.pane?(0,U.isLineDrawnWithPressedButton)(Yt.tool.value())&&this._clearCursorPosition():this._chart.updateCrossHairPositionIfNeeded());const g=(0,s.ensureNotNull)(this.state().mainDataSource()).firstValue();let S=null==g?null:_.coordinateToPrice(e.localY,g),v=h.timeScale().coordinateToIndex(e.localX);if(m.startMeasurePoint()&&m.endMeasurePoint()&&m.clearMeasure(),p.shift()&&(null===t||!(null===(r=null===(i=t.hittest.data())||void 0===i?void 0:i.hasOwnShortcutsBehaviourFor)||void 0===r?void 0:r.shiftKey))&&(0,Yt.toolIsCursor)(Yt.tool.value())&&u.selection().isEmpty()&&Yt.tool.setValue("measure"),
(e.isTouch&&!e.stylus||null===S||!this._tryStartMeasure(e,m,p,S,v))&&(e.isTouch&&!e.stylus||!this._tryFinishMeasure(e,m))&&!(this._tryFinishZoom(e)||null!==S&&this._tryStartZoom(e,S,v,p))){if(e.isTouch&&(null!==this._startTrackPoint?(this._initCrossHairPosition=m.currentPoint(),this._startTrackPoint=new o.Point(e.localX,e.localY)):this._isSelectPointModeEnabled()&&null===this._chart.trackingModePaneWidget()&&this.startTrackingMode(new o.Point(e.localX,e.localY),new o.Point(e.localX,e.localY),new Kt.EnvironmentState(e))),e.isTouch&&(this._preventSourceChange=null===t||!u.selection().isSelected(t.source)),!this._isSelectPointModeEnabled()&&!this._isScrolling){if(e.isTouch&&!e.stylus&&((0,Yt.toolIsMeasure)(Yt.tool.value())||null!==m.measurePane().value()))return void this._initToolCreationModeParams(e);if(null!==S&&((0,U.isLineToolName)(Yt.tool.value())||u.lineBeingCreated()))return p.shift()||u.selectionMacro((e=>e.clearSelection())),void this._mouseDownEventForLineTool(e,p,v,S)}if(null!==t){const i=this._sourceWasSelected(t);t.hittest.tryCallMouseDownOrTouchStartHandler(e,{sourceWasSelected:i})}if(!this._chart.readOnly()){const i=this._handleSelectionMouseDownAndGetJustDeselectedSource(e,t,p);if(null!==t&&!this._preventSourceChange){const i=t.hittest.data();if(t.isCustom){if(t.hittest.hasPressedMoveHandler(e))return u.model().setMovingCustomSource(t.source,i),this._preventScrollUntilNextMouseDownOrTouchStart=!0,this._currentMovingHitTest={sourceAtPoint:t,cancelledContainer:null!==(n=u.model().customSourceMovingHitTestData())&&void 0!==n?n:void 0},void u.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection((0,s.ensureNotNull)(t.source),(0,s.ensureNotNull)(i))}))}else if((null==i?void 0:i.areaName)===qt.AreaName.SourceItemMove){const o=null==i?void 0:i.activeItem;if(void 0!==o)return u.startCustomMoving(t.source,o,e),this._currentMovingHitTest={sourceAtPoint:t},void u.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection((0,s.ensureNotNull)(t.source),(0,s.ensureNotNull)(i))}))}}if(null!==t&&this._tryHandleEraserMouseDown(t,p))return;const o=null!==t&&(0,ut.isLineTool)(t.source)&&t.source.isLocked&&t.source.isLocked();if(!((0,Yt.lockDrawings)().value()||o)&&null!==t&&!t.isCustom){if(!t.source.userEditEnabled())return;const o=null===(a=t.hittest.data())||void 0===a?void 0:a.snappingPrice,r=null===(l=t.hittest.data())||void 0===l?void 0:l.snappingIndex;let n=e.localY,d=e.localX;if(void 0!==o&&null!==g&&(n=(0,s.ensure)(null===(c=t.source)||void 0===c?void 0:c.priceScale()).priceToCoordinate(o,g),S=o),void 0!==r&&(d=h.timeScale().indexToCoordinate(r),v=r),n===e.localY&&d===e.localX||(e={...e,localY:n,localX:d},this.setCursorPosition(e.localX,e.localY,p)),this._tryStartChangingLineTool(e,t,p,v))return void(this._currentChangingLineToolHitTest=t);if(this._currentChangingLineToolHitTest=null,(f=t.hittest.target())===qt.HitTarget.MovePoint||f===qt.HitTarget.MovePointBackground&&(0,At.lastMouseOrTouchEventInfo)().isTouch){if(this._tryStartCloning(e,t,p,i))return
;if(this._tryStartMovingLineTool(e,t,p,v))return void(this._currentMovingHitTest={sourceAtPoint:t});this._currentMovingHitTest=null}}if(null!==t&&(0,Xi.isPriceDataSource)(t.source)&&t.source.isDraggable()&&(null===(d=this._state)||void 0===d?void 0:d.hasDataSource(t.source))&&this._paneWidgetsSharedState.trySetDraggingSource(t.source,this))return}var f;null!==t&&t.hittest.target()===qt.HitTarget.Regular||(this._processing=!0)}}_mouseUpOrTouchEndEvent(e){var t,i;if(!this.hasState())return;this._pressedMoveStage=0;const o=e.isTouch&&null!==this._startTrackPoint,r=e.isTouch&&this._wasPinched;e.isTouch&&(this._wasPinched=!1,this._longTap=!1),this._startMoveSourceParams=null,this._startChangeLineToolParams=null,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null;const n=this._chartUndoModel(),a=n.model().customSourceMovingHitTestData();null!==a||n.customMoveBeingProcessed()||this._processMouseUpOrTouchEndHandler(e),this._isSelecting=!1;const l=n.model(),c=l.crossHairSource(),d=this._dataSourceAtPoint(e.localX,e.localY);if(c.selection()&&null===this._firstZoomPoint){const e=this.state().lineToolsForArea(c.selection(),(0,it.getBindingRenderingInfo)(this._canvasBinding));n.selectionMacro((t=>{let i=null;e.forEach((e=>{null===i&&(i=Ms(d,e)),t.addSourceToSelection(e,i)}))})),c.clearSelection(),(0,Ne.trackEvent)("GUI","Multiselect","Area Select")}(0,Le.emit)("mouse_up",{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY});const h=e.isTouch&&this._touchMove;e.isTouch&&(this._touchMove=!1);const u=new Kt.EnvironmentState(e),p=Yt.tool.value();if(e.isTouch&&((0,Yt.toolIsMeasure)(p)||null!==c.measurePane().value())){if(!h&&!e.stylus&&null===c.measurePane().value()&&c.pane!==this._state)return void this.setCursorPosition(e.localX,e.localY);if(!h&&!e.stylus&&this._tryStartMeasure(e,c,u,c.price,c.index))return;if((!h||e.stylus)&&this._tryFinishMeasure(e,c))return}if(e.isTouch&&!h&&!(0,U.isLineDrawnWithPressedButton)(p)&&(0,U.isLineToolName)(p)&&!n.lineBeingCreated()){if(this._chart.justActivated())return;if(c.pane!==this._state)return void this.setCursorPosition(e.localX,e.localY,u);const i=c.currentPoint(),o=this.state().defaultPriceScale(),r=(0,s.ensure)(null===(t=this.state().mainDataSource())||void 0===t?void 0:t.firstValue()),a={index:Math.round(n.timeScale().coordinateToIndex(i.x)),price:o.coordinateToPrice(i.y,r)},l=(0,s.ensureNotNull)(n.createLineTool({pane:this.state(),point:a,linetool:p}));return n.selectionMacro((e=>{e.addSourceToSelection(l)})),n.lineBeingCreated()||(this._finishTool(l,d),e.preventDefault()),void(this._startTouchPoint=null)}const _=n.lineBeingCreated();if(_&&!(0,U.isLineDrawnWithPressedButton)(_.toolname)&&e.isTouch&&(this._startTouchPoint||e.stylus)){if(this._startTouchPoint=null,!h||e.stylus){const t=(0,s.ensureNotNull)(_.lastPoint()),i=n.continueCreatingLine({index:t.index,price:t.price},new Kt.EnvironmentState(e));this._initCrossHairPosition=null,i&&(this._finishTool(_,d),e.preventDefault())}return}
if(null!==this._firstZoomPoint&&this._firstZoomPoint.draggingMode)return void this._finishZoom(e);if(this._processing=!1,n.customMoveBeingProcessed())return void n.endCustomMoving();if(null!==a){if(a.beingMoved&&!a.cancelled){const t=this._sourceWasSelected(d);(0,qt.tryCallHandler)(e,{sourceWasSelected:t},a.mouseUpHandler,a.touchEndHandler),this.setCursorForTool()}if(l.setMovingCustomSource(null,null),Es(e,a))return}if(l.lineBeingEdited())return n.endChangingLinetool(!1),void(this._preventCrossHairMove()&&this._clearCursorPosition());if((0,U.isLineDrawnWithPressedButton)(p)&&!this._isSelectPointModeEnabled()){const t=n.lineBeingCreated();null!==t&&(ss(t),t.finish(),"LineToolBrush"===t.toolname&&(0,Le.emit)("drawing_event",t.id(),"create"));const o=this.state().defaultPriceScale();if(o.isEmpty())return;if(!t)return;const r=(0,s.ensure)(null===(i=t.ownerSource())||void 0===i?void 0:i.firstValue()),a=o.coordinateToPrice(e.localY,r),l={index:Math.round(n.timeScale().coordinateToIndex(e.localX)),price:a};return void n.continueCreatingLine(l)}if(l.sourcesBeingMoved().length)return n.endMovingSource(!1,!1),l.sourcesBeingMoved().filter(ut.isLineTool).forEach((e=>{this.setCursorForTool(e)})),void l.invalidate(B.InvalidationMask.cursor());if(!this._chart.readOnly()){const t=e.localX>=0&&e.localX<this._size.width;if((!d||d.source!==c)&&t){const t=n.timeScale().coordinateToIndex(e.localX);l.onSyncScrollNeeded(t)}}const m=this._isScrolling,g=this._endScroll(e),S=this._paneWidgetsSharedState.draggingSource();if(null!==S){const t=e.target,i=this._chart.paneByCanvas(t);i&&i!==this&&(g&&n.undoHistory().undo(),n.mergeToPane(S,i.state()));if(this._chart.timeAxisByCanvas(t))if(l.isUnmergeAvailableForSource(S))g&&n.undoHistory().undo(),n.unmergeToNewBottomPane(S);else{const e=l.panes(),t=(0,s.ensureNotNull)(l.paneForSource(S)),i=e.indexOf(t);i!==e.length-1&&(g&&n.undoHistory().undo(),t.maximized().value()&&this._chart.toggleMaximizePane(null),n.movePane(i,e.length-1))}this._paneWidgetsSharedState.clearDraggingSource();const o=this._chart.getTimeScale();o&&o.restoreDefaultCursor();const r=this._chart.paneWidgets();for(let e=0;e<r.length;e++){const t=r[e];t===this&&d&&!d.isCustom?t.setCursorForTool(d.source||void 0):t.setCursorForTool(),t.leftPriceAxisesContainer().restoreDefaultCursor(),t.rightPriceAxisesContainer().restoreDefaultCursor()}}this._chart.readOnly()||o||u.mod()||m||r||null!==this._lastFinishedToolId||null!==d&&(d.hittest.target()>qt.HitTarget.MovePointBackground||(0,At.lastMouseOrTouchEventInfo)().isTouch)&&n.selectionMacro((e=>{e.clearSelection();const t=(0,s.ensureNotNull)(d.source);e.addSourceToSelection(t,Ms(d,t))})),e.isTouch&&(this._touchMove=!1)}_mouseOrTouchMoveEvent(e){if(!this.hasState())return;this._resetMeasureIfRequired();const t=this._dataSourceAtPoint(e.localX,e.localY);this._processMouseEnterLeaveMoveHandlers(t,e);const i=this._chartUndoModel();if(!i)return;const s=e.localX,r=e.localY;this._prevMoveEventPosition=new o.Point(s,r);const n=new Kt.EnvironmentState(e);if(null===this._firstZoomPoint){
if(this._updateHoveredSource(t,n,e),!e.isTouch&&i.lineBeingCreated()){const e=i.lineBeingCreated(),t=null===e?null:i.model().paneForSource(e);if(null!==t&&t!==this._state)return void this._setCursorPositionOnExternalPane(t,s,r,n)}e.isTouch||this.setCursorPosition(s,r,n)}else this._processMouseMoveWhileZoom(e,n)}_pressedMouseOrTouchMoveEvent(e){var t,i;if(!this.hasState()||this._pinching||e.isTouch&&this._contextMenuOpenedOnLastTap)return;this._pressedMoveStage=2,this._resetMeasureIfRequired(),this._startChangeOrMoveLineToolIfNeeded(),e.isTouch&&(this._touchMove=!0,this._preventSourceChange=!1);const r=new Kt.EnvironmentState(e),n=this._chartUndoModel(),a=n.crossHairSource(),l=e.localX,c=e.localY;if(this._prevMoveEventPosition=new o.Point(l,c),null!==this._firstZoomPoint)return this._processMouseMoveWhileZoom(e),void(this._firstZoomPoint.draggingMode=!0);const d=Yt.tool.value();if(e.isTouch&&this._startTouchPoint&&(0,U.isLineToolName)(d)&&!(0,U.isLineDrawnWithPressedButton)(d)&&!n.lineBeingCreated()&&!this._isSelectPointModeEnabled())return void this._updateCrosshairPositionInToolCreationMode(e,this.state());const h=a.measurePane().value();if(e.isTouch&&(this._startTouchPoint||e.stylus)&&((0,Yt.toolIsMeasure)(d)||null!==h))return void(e.stylus?this.setCursorPosition(e.localX,e.localY,new Kt.EnvironmentState(e)):this._updateCrosshairPositionInToolCreationMode(e,h||this.state()));const u=n.lineBeingCreated();if(e.isTouch&&!e.stylus&&u&&!(0,U.isLineDrawnWithPressedButton)(u.toolname)){if(this._startTouchPoint){const t=(0,s.ensureNotNull)(n.lineBeingCreated()),i=(0,s.ensureNotNull)(n.model().paneForSource(t));this._updateCrosshairPositionInToolCreationMode(e,i)}return}if(e.isTouch&&null!==this._startTrackPoint){this._exitTrackingModeOnNextTry=!1;const e=(0,s.ensureNotNull)(this._initCrossHairPosition),t=new o.Point(l,c).subtract(this._startTrackPoint),i=e.add(t);this.setCursorPosition(i.x,i.y,r)}else e.isTouch&&this._preventCrossHairMove()||this.setCursorPosition(l,c,r);const p=this._isSelectPointModeEnabled();if((0,U.isLineToolName)(d)&&!(0,U.isLineDrawnWithPressedButton)(d)&&!p&&!r.mod())return;if((0,U.isLineDrawnWithPressedButton)(d)&&!p){const i=this.state().defaultPriceScale();if(i.isEmpty())return;const r=n.lineBeingCreated();if(!r)return;const a=new o.Point(e.localX,e.localY),l=(0,s.ensure)(null===(t=r.ownerSource())||void 0===t?void 0:t.firstValue());return a.price=i.coordinateToPrice(e.localY,l),a.index=Math.round(n.timeScale().coordinateToIndex(e.localX)),void n.continueCreatingLine(a)}if(null!==this._paneWidgetsSharedState.draggingSource()){const t=e.target,i=this._chart.paneByCanvas(t);i&&(i!==this?i.setDragToAnotherPaneCursor():i.setCursorForTool());const s=this._chart.timeAxisByCanvas(t);s&&s.setCursor("grabbing")}if(n.timeScale().isEmpty())return;const _=this._options.handleScroll;if((!_.pressedMouseMove||e.isTouch)&&(!_.horzTouchDrag&&!_.vertTouchDrag||!e.isTouch))return;if(n.customMoveBeingProcessed())return void n.processCustomMove(e);const m=n.model().customSourceMovingHitTestData()
;if(null!==m&&(this._updateCommonTooltip(null,!0),m.cancelled||(n.model().processingCustomSourceMove(),(0,qt.tryCallHandler)(e,{sourceWasSelected:this._selectionBeforeMouseDown.has(n.model().customSourceBeingMoved())},m.pressedMouseMoveHandler,m.touchMoveHandler)),Es(e,m)))return;if(n.model().lineBeingEdited())return void this.setCursorPosition(l,c,r);if(n.model().sourcesBeingMoved().length)return void this._alignSourcesThatBeingMoved(n.model().sourcesBeingMoved(),e.localX,e.localY,r,null===(i=n.model().lastHittestData())||void 0===i?void 0:i.possibleMovingDirections);const g=this._dataSourceAtPoint(e.localX,e.localY);if(this._tryFinishClonning(e,new Kt.EnvironmentState(e),g))return;const S=(0,Yt.toolIsMeasure)(d)||a.startMeasurePoint()&&a.endMeasurePoint();this._chart.readOnly()||!r.mod()||(0,U.isLineToolName)(d)||S||p?(this._processScroll(e),this._preventScroll()&&!this._preventCrossHairMove()&&null===this._startTrackPoint&&this.setCursorPosition(e.localX,e.localY,new Kt.EnvironmentState(e))):this._isSelecting||(a.startSelection(this.state()),this._isSelecting=!0)}_mouseOrTouchLeaveEvent(e){var t;if(!this.hasState())return;const i=this._chartUndoModel();if(!i)return;const s=i.crossHairSource();e.isTouch||null!==s.measurePane().value()&&null===s.endMeasurePoint()||this._clearCursorPosition();if(this._chartModel().setHoveredSource(null,null),null!==this._prevHoveredHittest){const i=this._sourceWasSelected(this._prevHoveredHittest);(0,qt.tryCallHandler)(e,{sourceWasSelected:i},null===(t=this._prevHoveredHittest.hittest.data())||void 0===t?void 0:t.mouseLeaveHandler),this._prevHoveredHittest=null}this._updateCommonTooltip(null),this._chart.unsetActivePaneWidget()}_mouseDoubleClickOrDoubleTapEvent(e){if(!this.hasState())return;const t=!this._chart.readOnly()&&!(0,U.isLineToolName)(Yt.tool.value())&&this._dataSourceAtPoint(e.localX,e.localY)||null,i=this._sourceWasSelected(t);if(null!==t&&t.isCustom)t.hittest.tryCallDblClickOrDblTapHandler(e,{sourceWasSelected:i});else if(null!==t&&(e.isTouch||t.hittest.target()>qt.HitTarget.MovePointBackground))t.hittest.tryCallDblClickOrDblTapHandler(e,{sourceWasSelected:i})&&!(0,qt.shouldDefaultActionBeExecuted)(e,(0,s.ensureNotNull)(t.hittest.data()),"doubleClickHandler","doubleTapHandler")||this.processDoubleClickOnSource(t.source,t.hittest?t.hittest:void 0);else if(!this._chart.readOnly()&&!(0,U.isLineToolName)(Yt.tool.value())&&!this._chartUndoModel().lineBeingCreated()&&this._chartUndoModel().selection().isEmpty()){const t=this.state();new Kt.EnvironmentState(e).mod()&&!t.maximized().value()?(t.collapsed().value()||this._chartModel().paneCollapsingAvailable().value())&&this._chartUndoModel().toggleCollapsedPane(this.state()):this._chart.toggleMaximizePane(this)}}_contextMenuEvent(e){const t=this._chartUndoModel();if(t.crossHairSource().startMeasurePoint()&&!this._trackCrosshairOnlyAfterLongTap)return t.crossHairSource().clearMeasure(),void(0,Yt.resetToCursor)(!0);if(this._pinching)return;if(null===this._firstZoomPoint||this._trackCrosshairOnlyAfterLongTap||this.cancelZoom(),!(0,
Yt.toolIsCursor)(Yt.tool.value())||this._isSelectPointModeEnabled()){if(e.isTouch)return;return(0,Yt.resetToCursor)(!0),this.setCursorForTool(),void(t.lineBeingCreated()&&t.cancelCreatingLine())}if(!this._options.contextMenuEnabled)return;const i=this._dataSourceAtPoint(e.localX,e.localY),s=i?i.source:null;if(e.isTouch&&null!==this._startTrackPoint){if(this._preventSourceChange)return;this._clearCursorPosition()}e.isTouch&&(this._contextMenuOpenedOnLastTap=!0,this._startTrackPoint=null),this._contextMenuX=e.localX,this._contextMenuY=e.localY;const o=i&&i.hittest?i.hittest.target():0,r=o>=qt.HitTarget.Regular||o>=qt.HitTarget.MovePointBackground&&e.isTouch;if(this._chart.updateActions(),t.selectionMacro((t=>{null!==s&&r?t.selection().isSelected(s)||(t.clearSelection(),t.addSourceToSelection(s,Ms(i,s))):(this._options.contextMenu.general&&this._showContextMenu(e),t.clearSelection())})),null!==i&&r&&null!==s)if((0,Zt.isDataSource)(s)&&s.hasContextMenu())s.isSelectionEnabled()?this.showContextMenuForSelection(e,void 0,i.hittest):this.showContextMenuForSources([s],e,void 0,void 0,i.hittest);else{const t=this._sourceWasSelected(i);i.hittest.tryCallContextMenuHandler(e,{sourceWasSelected:t})}}_onMouseEvent(){this._preventSourceChange=!1,this._startTrackPoint=null,this._trackCrosshairOnlyAfterLongTap=!1}_onTouchEvent(){this._trackCrosshairOnlyAfterLongTap=!0}_switchTrackingModeFromAnotherPaneIfNeeded(e){const t=this._chart.trackingModePaneWidget();if(null!==t&&t!==this){const i=this._chartModel().crossHairSource().currentPoint();t._exitTrackingModeOnNextTry=!0,t._tryExitTrackingMode(!0),this.startTrackingMode(new o.Point(e.localX,e.localY),new o.Point(i.x,e.localY),new Kt.EnvironmentState(e))}}async _showContextMenu(e){const t=e=>e instanceof gi.Separator,i=this._customActions(),s=(await this._initActions(e)).filter((e=>null!==e));i.remove.forEach((e=>{for(let t=0;t<s.length;t++){const i=s[t];if(i instanceof gi.Action&&i.getLabel()===e){s.splice(t,1);break}}}));const o=i.top.concat(s).concat(i.bottom);for(let e=o.length-1;e>0;e--)t(o[e])&&t(o[e-1])&&o.splice(e,1);o.length&&t(o[0])&&o.splice(0,1),o.length&&t(o[o.length-1])&&o.splice(o.length-1,1),ti.ContextMenuManager.showMenu(o,e,{statName:"ChartContextMenu"},{menuName:"ChartContextMenu"})}async _initActions(e){var t;const i=this._chart.actions(),o=[];if(this._chart.model().model().resetScalesAvailable().value()&&(o.push(i.chartReset),o.push(new gi.Separator)),!this.state().isEmpty()&&d.enabled("datasource_copypaste")){const t=(0,bi.createActionCopyPrice)(this.state(),e.localY),i=(0,bi.createPasteAction)(this._chart,this.state());(t||i)&&(t&&o.push(t),i&&o.push(i),o.push(new gi.Separator))}if(d.enabled("alerts")&&(o.length&&o.push(new gi.Separator),(0,s.ensureNotNull)(this.state().mainDataSource()).alertCreationAvailable().value())){const t=(await(0,$i.getAlertsChartActionCreators)()).createAlert(this._chart,{localY:e.localY,pane:this.state()});null!==t&&o.push(t)}if(this._options.contextMenu.mainSeriesTrade&&this.containsMainSeries()){const t=await(0,
bi.createActionTrade)(this._chart,this.state(),e);t&&o.push(t)}o[o.length-1]instanceof gi.Separator||o.push(new gi.Separator);return Boolean(null===(t=window.widgetbar)||void 0===t?void 0:t.widget("watchlist"))&&i.addToWatchlist&&o.push(i.addToWatchlist),d.enabled("text_notes")&&o.push(i.addToTextNotes),o[o.length-1]instanceof gi.Separator||o.push(new gi.Separator),i.moveChartAction&&!i.moveChartAction.isDisabled()&&o.push(i.moveChartAction,new gi.Separator),o.push(this._createLockTimeAxisAction(e)),o.push(new gi.Separator),i.paneObjectTree&&o.push(i.paneObjectTree),i.applyColorTheme&&o.push(i.applyColorTheme),o[o.length-1]instanceof gi.Separator||o.push(new gi.Separator),this._chart.applyIndicatorsToAllChartsAvailable()&&(o.push(i.applyStudiesToAllCharts),o.push(new gi.Separator)),o.push(i.paneRemoveAllDrawingTools),o.push(i.paneRemoveAllStudies),o.push(new gi.Separator),d.enabled("show_chart_property_page")&&o.push(i.chartProperties),o[o.length-1]instanceof gi.Separator&&o.pop(),o}_loadAndCreateLegendWidget(){Promise.all([i.e(65073),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(25480),i.e(58985),i.e(88015),i.e(30614),i.e(7001),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(79753),i.e(77183),i.e(10974),i.e(82321),i.e(16388),i.e(62526),i.e(83147),i.e(75560),i.e(1730),i.e(24102),i.e(5093)]).then(i.bind(i,449324)).then((e=>{if(this._isDestroyed)return;const t=e.LegendWidget,i=(0,Gt.deepExtend)({},this._options.legendWidget);i.canShowSourceCode=!this._chart.onWidget()&&!l.CheckMobile.any(),i.readOnlyMode=i.readOnlyMode||this._chart.readOnly(),i.statusesWidgets={sourceStatusesEnabled:this._options.sourceStatusesWidgetEnabled,sourceStatuses:this._options.sourceStatusesWidget||{},marketStatusEnabled:this._options.marketStatusWidgetEnabled,dataUpdateModeEnabled:this._options.chartWarningWidgetEnabled,dataUpdateMode:this._options.chartWarningWidget||{},dataProblemEnabled:this._options.dataProblemWidgetEnabled,pineSourceStatusEnabled:this._options.pineSourceStatusEnabled};const o=(0,Je.combine)(((e,t)=>As&&this._chart!==e&&!t),this._chart.chartWidgetCollection().activeChartWidget.weakReference(),this._chart.chartWidgetCollection().lock.crosshair.weakReference()),r=(0,Je.combine)(((e,t)=>null!==e?e===this._state:(0,Yt.toolIsMeasure)(t)),this._chartModel().crossHairSource().measurePane().weakReference(),Yt.tool.weakReference());this._legendWidget=new t(this._chartUndoModel(),this,this._chart.backgroundTopTheme().spawnOwnership(),o.ownership(),this._visuallyCollapsed.spawnOwnership(),r.ownership(),i,{showContextMenuForSelection:this.showContextMenuForSelection.bind(this),showContextMenuForSources:this.showContextMenuForSources.bind(this),updateActions:this._chart.updateActions.bind(this._chart),showChartPropertiesForSource:this._chart.showChartPropertiesForSource.bind(this._chart),showGeneralChartProperties:this._chart.showGeneralChartProperties.bind(this._chart),showObjectsTreeDialog:this._chart.showObjectsTreeDialog.bind(this._chart),
onLegendRowFocused:()=>{this._chart.chartWidgetCollection().activeChartWidget.setValue(this._chart)}}),this._div.appendChild(this._legendWidget.getElement()),this._legendWidget.updateLayout(),this._legendWidget.updateWidgetModeBySize(this._size),this._legendWidget.updateThemedColors(this._themedTopColor);for(const e of Array.from(this._customLegendWidgetsFactoryMap.keys()))this._legendWidget.addCustomWidgetToLegend(e,(0,s.ensureDefined)(this._customLegendWidgetsFactoryMap.get(e)))}))}_loadAndCreatePaneControlsWidget(){Promise.all([i.e(65073),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(25480),i.e(58985),i.e(88015),i.e(30614),i.e(7001),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(79753),i.e(77183),i.e(10974),i.e(82321),i.e(16388),i.e(62526),i.e(83147),i.e(75560),i.e(1730),i.e(24102),i.e(5093)]).then(i.bind(i,897672)).then((e=>{var t;if(this._isDestroyed)return;const i=e.PaneControlsWidget;this._paneControls=new i(this._chartUndoModel(),this,{backgroundThemeName:this._chart.backgroundTopTheme()},{toggleMaximizePane:this._chart.toggleMaximizePane.bind(this._chart)},this._div),this._paneControls.updateWidgetModeByWidth(this._size.width),this._paneControls.updateThemedColors(this._themedTopColor),this._paneControlsResizeObserver=new ResizeObserver(this._handleRestrictLegendWidth.bind(this)),this._paneControlsResizeObserver.observe(this._paneControls.getElement()),(null===(t=this._state)||void 0===t?void 0:t.collapsed().value())&&this._chartModel().fullUpdate()}))}_handleRestrictLegendWidth(e){if(null===this._legendWidget||null===this._paneControls)return;const t=e[e.length-1].contentRect.width,i=0===t?0:t+ps+_s;this._legendWidget.addMargin(i)}_onMagnetStateChanged(){this._chart.isActive().value()&&(this._isSelectPointModeEnabled()||this._isToolActionActiveOnPane(!0))&&this._chartModel().crossHairSource().visible&&this._updateLineToolUsingMagnetOrShift()}_onShiftKeyStateChanged(){this._chart.isActive().value()&&this._isToolActionActiveOnPane(!1)&&this._chartModel().crossHairSource().visible&&this._updateLineToolUsingMagnetOrShift(Kt.EnvironmentState.create((0,st.shiftPressed)().value()))}_isToolActionActiveOnPane(e){const t=this._chartModel(),i=t.lineBeingCreated()||t.lineBeingEdited()||t.sourcesBeingMoved().length>0&&t.sourcesBeingMoved()[0];return i?t.paneForSource(i)===this._state:e&&(0,U.isLineToolName)(Yt.tool.value())&&t.crossHairSource().pane===this._state}_updateLineToolUsingMagnetOrShift(e){if(null===this._prevMoveEventPosition)return;const{x:t,y:i}=this._prevMoveEventPosition,s=this._chartModel().sourcesBeingMoved();s.length>0?(Yt.isStudyEditingNow.value()&&this.setCursorPosition(t,i,e),this._alignSourcesThatBeingMoved(s,t,i,e)):this.setCursorPosition(t,i,e)}_showEditDialogForSource(e,t){if(this._options.propertyPagesEnabled&&e.userEditEnabled())if(e===this._chartUndoModel().mainSeries())this._chart.showGeneralChartProperties(at.TabNames.symbol);else if((0,ut.isLineTool)(e)||(0,ct.isStudy)(e)||(0,
ht.isLollipopDataSource)(e)){let i;const s=null==t?void 0:t.data();if(null!=s){const e=s.areaName;void 0!==e&&(i=Ls.get(e))}this._chart.showChartPropertiesForSource(e,i).then((e=>{this._editDialog=e}))}}_initToolCreationModeParams(e){this._startTouchPoint=new o.Point(e.pageX,e.pageY),this._initCrossHairPosition=this._chartModel().crossHairSource().currentPoint()}_updateCrosshairPositionInToolCreationMode(e,t){if(t!==this._state){const i=this._chart.paneByState(t);return i._startTouchPoint=this._startTouchPoint,i._initCrossHairPosition=this._initCrossHairPosition,void i._updateCrosshairPositionInToolCreationMode(e,t)}const i=this._chartModel().crossHairSource();this._chart.justActivated()&&(this._initCrossHairPosition=i.currentPoint());const r=e.pageX,n=e.pageY,a=(0,s.ensureNotNull)(this._initCrossHairPosition),l=new o.Point(r,n).subtract((0,s.ensureNotNull)(this._startTouchPoint)),c=a.add(l);this.setCursorPosition(c.x,c.y,new Kt.EnvironmentState(e))}_priceAxisesContainer(e){return"left"===e?this._lhsPriceAxisesContainer:this._rhsPriceAxisesContainer}_recalculatePriceScales(e){const t=this.state();for(const i of t.leftPriceScales())t.recalculatePriceScale(i,e);for(const i of t.rightPriceScales())t.recalculatePriceScale(i,e);for(const i of t.sourcesByGroup().overlayPriceScaleSources())(0,ut.isLineTool)(i)||t.recalculatePriceScale(i.priceScale(),e)}_createLockTimeAxisAction(e){var t;const i=0===(null===(t=Yt.crosshairLock.value())||void 0===t?void 0:t.type);return new gi.Action({actionId:"Chart.Crosshair.LockVerticalCursor",options:{label:vs,statName:"LockCursorInTime",checkable:!0,checked:i,onExecute:()=>this._toggleLockTimeAxis(e.localX,!i)}})}_toggleLockTimeAxis(e,t){if(t){const t=this._chartUndoModel().timeScale(),i=t.coordinateToIndex(e),s=t.points().roughTime(i);if(null!==s)return void Yt.crosshairLock.setValue({type:0,time:s})}Yt.crosshairLock.setValue(null)}_preventTouchEventsExceptPinch(){return this._paneWidgetsSharedState.hasTouchesOnOtherPanes(this)||null!==this._paneWidgetsSharedState.pinchingPane()}_updateHoveredSource(e,t,i){var s,o;const r=this._chartUndoModel(),n=r.model();let a=!1;const l=e&&e.source,c=this._chart.readOnly();if(n.crossHairSource().isReplaySelection())this._setCursorClassName("none");else if(!(!c||e&&(0,ut.isLineTool)(e.source))||this._editDialog&&this._editDialog.visible().value())c&&(n.setHoveredSource(null,null),this.setCursorForTool());else{const d=Yt.tool.value();let h=null;if(!this._processing&&((0,Yt.toolIsCursor)(d)||"eraser"===d&&!c||t.mod()||!r.lineBeingCreated())){const t=null==e?void 0:e.hittest;a=Boolean(null===(s=null==t?void 0:t.data())||void 0===s?void 0:s.hideCrosshairLinesOnHover),t&&t.target()>qt.HitTarget.MovePointBackground?(h=l,!(null==l?void 0:l.isHoveredEnabled())||"eraser"===d&&l===r.mainSeries()?n.setHoveredSource(null,null):n.setHoveredSource(l,t.data(),0)):n.setHoveredSource(null,null)}
c?this.setCursorForTool(h,t,rs.PaneCursorType.Default):this._options.sourceSelectionEnabled&&(this._isSelectPointModeEnabled()?this._setCursorClassName("pointer"):this.setCursorForTool(h,t,null===(o=null==e?void 0:e.hittest.data())||void 0===o?void 0:o.cursorType));const u=n.customSourceBeingMoved(),p=null!==u?[u]:n.sourcesBeingMoved();if((!p.length||null!==e&&-1===p.indexOf(e.source))&&this._updateCommonTooltip(e),!c&&null!==e&&i&&e.hittest.hasPressedMoveHandler(i)){switch((e.hittest.data()||{}).cursorType){case rs.PaneCursorType.VerticalResize:this._setCursorClassName("ns-resize");break;case rs.PaneCursorType.HorizontalResize:this._setCursorClassName("we-resize");break;case rs.PaneCursorType.DiagonalNeSwResize:this._setCursorClassName("nesw-resize");break;case rs.PaneCursorType.DiagonalNwSeResize:this._setCursorClassName("nwse-resize")}}}this._preventCrossHairMove()&&this._clearCursorPosition(),1!==this._pressedMoveStage&&n.crossHairSource().setLinesShouldBeHidden(a)}async _createErrorBlock(){const e=new(await(0,ft.getErrorCardRenderer)());return this._div.insertBefore(e.container,this._topCanvasBinding.canvasElement.nextSibling),e}_customActions(){const e={top:[],bottom:[],remove:[]},t=this._chartUndoModel().timeScale(),i=this._state&&this._state.defaultPriceScale();if(!d.enabled("custom_items_in_context_menu"))return e;const o=t.isEmpty()?void 0:t.indexToUserTime(t.coordinateToIndex(this._contextMenuX));let r;if(i&&!i.isEmpty()){const e=(0,s.ensureNotNull)(this.state().mainDataSource()).firstValue();r=i.coordinateToPrice(this._contextMenuY,(0,s.ensureNotNull)(e))}return(0,Le.emit)("onContextMenu",{unixtime:null!=o?o.getTime()/1e3:void 0,price:r,callback:t=>{[...t].forEach((t=>{if(t.text)if(t.text.length>1&&"-"===t.text[0])e.remove.push(t.text.slice(1));else{let i;i="-"===t.text?new gi.Separator:new gi.Action({actionId:"Chart.ExternalActionId",options:{label:t.text,onExecute:t.click}}),t.position&&"top"===t.position?e.top.push(i):e.bottom.push(i)}}))}}),e}_highlightPriceAxisByLabel(e){this._lhsPriceAxisesContainer.highlightPriceAxisByLabel(e),this._rhsPriceAxisesContainer.highlightPriceAxisByLabel(e)}_subscribeToState(){const e=this.state();e.onDestroyed().subscribe(this,this._onStateDestroyed,!0),e.dataSourcesCollectionChanged().subscribe(this,this._onDataSourcesCollectionChanged),e.maximized().subscribe(this._updateVisuallyCollapsed),e.collapsed().subscribe(this._updateVisuallyCollapsed)}_unsubscribeFromState(){const e=this.state();e.onDestroyed().unsubscribeAll(this),e.dataSourcesCollectionChanged().unsubscribeAll(this),e.maximized().unsubscribe(this._updateVisuallyCollapsed),e.collapsed().unsubscribe(this._updateVisuallyCollapsed)}_updateAccesibilityAttr(){if(this.state().isMainPane()){const e=this._chartModel().mainSeries(),t=e.symbol(),s=(0,ds.getTranslatedResolutionModel)(e.interval()).hint,o=n.t(null,{replace:{symbol:t,interval:s}},i(501136));this._topCanvasBinding.canvasElement.setAttribute("aria-label",o)}else this._topCanvasBinding.canvasElement.setAttribute("aria-hidden","true")}
async _updateEndOfSeriesBanner(){var e,t,o,r;{const n=()=>{var e,t;if(window.user.is_pro)return null;const i=this._state;if(!i)return null===(e=this._endOfSeriesDataBanner)||void 0===e||e.setVisible(!1),null;if(!this._chart.isActive().value())return null;const s=i.model().mainSeries();if(!s)return null;if(!i.isMainPane())return null;if(2===s.status()||s.requestMoreDataAvailable())return null===(t=this._endOfSeriesDataBanner)||void 0===t||t.setVisible(!1),null;const o=s.bars().firstIndex();return null===o?null:{state:i,series:s,firstIndex:o}},a=()=>{if(this._legendWidget){const e=this._legendWidget.getElement().getBoundingClientRect();return e.bottom-e.top}return 0};let l=n();if(!l||"end"===l.series.endOfDataType())return void(null===(e=this._endOfSeriesDataBanner)||void 0===e||e.setVisible(!1));l.series.doNotShowLastAvailableBar(!1);const c=l.series.endOfDataType(),h=(0,s.ensureNotNull)(this._state).model().timeScale().indexToCoordinate(l.firstIndex)-l.state.model().timeScale().barSpacing();if(!this._endOfSeriesDataBanner&&!d.enabled("widget")){const e=await Promise.all([i.e(66476),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(46489),i.e(88015),i.e(61443),i.e(82321),i.e(62526),i.e(66849)]).then(i.bind(i,73345));if(l=n(),!l)return;this._endOfSeriesDataBanner||(this._endOfSeriesDataBanner=new e.EndOfSeriesBanner,this._div.appendChild(this._endOfSeriesDataBanner.element()))}const u=a();null===(t=this._endOfSeriesDataBanner)||void 0===t||t.setVisible(!0),null===(o=this._endOfSeriesDataBanner)||void 0===o||o.update(l.state,u,h,c);const p=null===(r=this._endOfSeriesDataBanner)||void 0===r?void 0:r.currentSize();l.series.doNotShowLastAvailableBar(null!==p&&0!==p)}}}class Bs{constructor(){this._draggingSource=null,this._activeTouchPanes=new Set,this._scrollingPane=null,this._pinchingPane=null}onPaneDestroyed(e){this._activeTouchPanes.delete(e),this._scrollingPane===e&&(this._scrollingPane=null),this._pinchingPane===e&&(this._pinchingPane=null)}startTouch(e){this._activeTouchPanes.add(e)}endTouch(e){this._activeTouchPanes.delete(e)}hasTouchesOnOtherPanes(e){return this._activeTouchPanes.size>1||1===this._activeTouchPanes.size&&!this._activeTouchPanes.has(e)}trySetDraggingSource(e,t){return!this.hasTouchesOnOtherPanes(t)&&((0,s.assert)(null===this._draggingSource||this._draggingSource===e),this._draggingSource=e,!0)}clearDraggingSource(){null!==this._draggingSource&&(this._draggingSource=null)}draggingSource(){return this._draggingSource}setScrollingPane(e){(0,s.assert)(null===e||null===this._scrollingPane||this._scrollingPane===e),this._scrollingPane=e}scrollingPane(){return this._scrollingPane}setPinchingPane(e){(0,s.assert)(null===e||null===this._pinchingPane||this._pinchingPane===e),this._pinchingPane=e}pinchingPane(){return this._pinchingPane}}var Ns=i(596673),Rs=i(472051);i(660070);const Os={contextMenuEnabled:!0,timezoneMenuEnabled:!0,pressedMouseMoveScale:!0},Vs=new c.TranslatedString("change session",n.t(null,void 0,i(887041))),Ws=n.t(null,void 0,i(194031));class Fs{constructor(e,t,i,s,o){
this._rendererOptions=null,this._onLabelHovered=new de.Delegate,this._mousedown=!1,this._currentCursorClassName="invalid",this._options=(0,je.merge)((0,je.clone)(Os),t||{}),this.chart=e,this._properties=e.properties().childs().scalesProperties,this._element=document.createElement("div"),this._element.style.display="flex",this._backgroundBasedTheme=o;const r=e.model().model().rendererOptionsProvider(),n=()=>this.backgroundColor(),a=()=>{throw new Error("Time axis does not support real price scales")},l={titlesProvider:i,stubContextMenuProvider:(e,t)=>{const i=s(e,t),o=this.getContextMenuActions(!0);return 0===o.length?i:i.concat(new gi.Separator,o)},backgroundBasedTheme:o.spawnOwnership(),onActiveOrHoveredChart:(0,Je.combine)(((e,t)=>e||t),this.chart.isActive().weakReference(),this.chart.isHovered().weakReference()).ownership(),rendererOptionsProvider:r,getBackgroundTopColor:n,getBackgroundBottomColor:n,requestRepaint:()=>this.chart.model().model().lightUpdate(),showHorizontalBorder:!0};this._lhsStubContainer=new di(this._properties,"left",a,l,this._options.priceAxisLabelsOptions,this),this._lhsStubContainer.onLabelHovered().subscribe(this,((e,t)=>{this._onLabelHovered.fire(e,t)})),this._rhsStubContainer=new di(this._properties,"right",a,l,this._options.priceAxisLabelsOptions,this),this._rhsStubContainer.onLabelHovered().subscribe(this,((e,t)=>{this._onLabelHovered.fire(e,t)})),this._element.appendChild(this._lhsStubContainer.getElement()),this._cell=document.createElement("div"),this._element.appendChild(this._cell),this._cell.classList.add("chart-markup-table","time-axis"),this._cell.style.height="25px",this._dv=document.createElement("div"),this._dv.style.width="100%",this._dv.style.height="100%",this._dv.style.position="relative",this._dv.style.overflow="hidden",this._cell.appendChild(this._dv),this._canvasConfiguredHandler=()=>this.chart.model().model().lightUpdate(),this._canvasBinding=(0,it.createBoundCanvas)(this._dv,(0,ke.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const c=this._canvasBinding.canvasElement;c.style.position="absolute",c.style.zIndex="1",c.style.left="0",c.style.top="0",this._topCanvasBinding=(0,it.createBoundCanvas)(this._dv,(0,ke.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const d=this._topCanvasBinding.canvasElement;d.style.position="absolute",d.style.zIndex="2",d.style.left="0",d.style.top="0",this._dv.setAttribute("aria-hidden","true"),this._element.appendChild(this._rhsStubContainer.getElement()),this.restoreDefaultCursor(),this.update(),this._minVisibleSpan=Ns.MINUTE_SPAN,this._mouseEventHandler=new Ft.MouseEventHandler(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:!0,treatHorzTouchDragAsPageScroll:!1}),this.size=(0,ke.size)({width:0,height:0})}destroy(){this._mouseEventHandler.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),
this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._rhsStubContainer.onLabelHovered().unsubscribeAll(this),this._lhsStubContainer.onLabelHovered().unsubscribeAll(this),this._lhsStubContainer.destroy(),this._rhsStubContainer.destroy(),this.chart.properties().childs().paneProperties.childs().background.unsubscribeAll(this),this._backgroundBasedTheme.release()}setCursor(e){let t="";"grabbing"!==e&&"ew-resize"!==e||(t="time-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t,this._cell.style.cursor)}restoreDefaultCursor(){this.setCursor("")}getElement(){return this._element}optimalHeight(){const e=this.rendererOptions();return Math.ceil(e.borderSize+e.offsetSize+e.fontSize+e.paddingTop+e.paddingBottom+e.labelBottomOffset)}setSizes(e,t,i){this.size&&(0,ke.equalSizes)(this.size,e)||(this.size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._cell.style.width=e.width+"px",this._cell.style.height=e.height+"px"),this._lhsStubContainer.setSizes(e.height,t),this._rhsStubContainer.setSizes(e.height,i)}rendererOptions(){if(!this._rendererOptions||this._rendererOptions.fontSize!==this.fontSize()){const e=this.fontSize();this._rendererOptions={borderSize:1,offsetSize:5,fontSize:e,font:(0,Jt.makeFont)(e,si.CHART_FONT_FAMILY,""),widthCache:new ei.TextWidthCache,paddingTop:3*e/12,paddingBottom:3*e/12,paddingHorizontal:9*e/12,labelBottomOffset:4*e/12}}return this._rendererOptions}backgroundColor(){return this.chart.model().model().backgroundColor().value()}lineColor(){const e=this._properties.childs().lineColor.value();if(0===(0,Vt.parseRgba)(e)[3]){const e=this.chart.model().model().lastPane();if(e&&(e.collapsed().value()||e.isMainPane()&&this._areEventsEnabled()))return this.chart.properties().childs().paneProperties.childs().separatorColor.value()}return e}textColor(){return this._properties.childs().textColor.value()}fontSize(){return this._properties.childs().fontSize.value()}baseFont(){return(0,Jt.makeFont)(this.fontSize(),si.CHART_FONT_FAMILY)}baseBoldFont(){return(0,Jt.makeFont)(this.fontSize(),si.CHART_FONT_FAMILY,"","bold")}hasCanvas(e){return this._canvasBinding.canvasElement===e||this._topCanvasBinding.canvasElement===e}onLabelHovered(){return this._onLabelHovered}getScreenshotData(){return{content:this._canvasBinding.canvasElement.toDataURL(),canvas:this._canvasBinding.canvasElement,contentWidth:this.size.width,contentHeight:this.size.height,lhsStub:this._lhsStubContainer.getScreenshotData(),rhsStub:this._rhsStubContainer.getScreenshotData()}}getContextMenuActions(e){var t;const i=this.chart;i.updateActions();const s=i.actions(),o=[];if(e||(i.model().timeScale().resetAvailable().value()&&(o.push(s.timeScaleReset),o.push(new gi.Separator)),this._options.timezoneMenuEnabled&&o.push(s.applyTimeZone),o.push(s.sessionBreaks)),!i.model().mainSeries().isDWM()){
const e=null===(t=i.model())||void 0===t?void 0:t.mainSeries().symbolInfo();if(e){const t=i.model().mainSeries().properties().childs().sessionId,s=(e.subsessions||[]).filter((e=>!e.private));if(s.length>1){const e=s.map((e=>new gi.Action({actionId:"Chart.SetSession",options:{label:(0,Rs.translateSessionDescription)(e.description),checkable:!0,checked:t.value()===e.id,statName:"SetSession",onExecute:()=>{i.model().setProperty(t,e.id,Vs)}}}))),r=new gi.Action({actionId:"Chart.SetSession",options:{label:Ws,statName:"SetSession",subItems:e}});o.push(r)}}}return!i.onWidget()&&d.enabled("show_chart_property_page")&&d.enabled("chart_property_page_scales")&&s.scalesProperties&&(o.length&&o.push(new gi.Separator),o.push(s.scalesProperties)),o}update(){if(!this.chart.hasModel())return;const e=this.chart.model().timeScale().marks();if(e){this._minVisibleSpan=Ns.YEAR_SPAN;for(const t of e)this._minVisibleSpan=Math.min(t.span,this._minVisibleSpan)}}updatePriceAxisStubs(){const e=this.chart.model().model(),t=this.chart.isMaximizedPane()?(0,s.ensureNotNull)(this.chart.maximizedPaneWidget()).state():e.paneForSource(e.mainSeries());if(!t)return;const i=e.priceScaleSlotsCount();this._lhsStubContainer.setScales([],i.left,t.leftPriceScales().length,i.left+i.right),this._rhsStubContainer.setScales([],i.right,t.rightPriceScales().length,i.left+i.right)}paint(e){if(e===B.InvalidationLevel.None||0===this.size.width||0===this.size.height)return;(0,it.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,it.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding);const t=(0,it.getContext2D)(this._topCanvasBinding.canvasElement);if(e>B.InvalidationLevel.Cursor){const i=(0,it.getContext2D)(this._canvasBinding.canvasElement),s=(0,it.getBindingRenderingInfo)(this._canvasBinding);this.drawBackground(i,s),this.chart.hasModel()&&(this.drawBorder(i,s),this.drawTickMarks(i,s),this.drawBackLabels(i,s),this.drawCrossHairLabel(t,s)),this._lhsStubContainer.paintStubs(e),this._rhsStubContainer.paintStubs(e)}this.drawCrossHairLabel(t,(0,it.getBindingRenderingInfo)(this._topCanvasBinding))}drawBackground(e,t){if((0,it.clearRect)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,this.backgroundColor()),!this.chart.hasModel())return;const i=this.chart.model();if(!i.timeScale().isEmpty()){const s=i.model().selection().lineDataSources().reduce(((e,t)=>{const i=t.timeAxisPoints();return 0===i.length?e:e.concat(i)}),[]);s.length>0&&this._highlightBackground(e,s,t)}const s=i.model().crossHairSource();s.startMeasurePoint()&&this._highlightBackground(e,s.measurePoints(),t)}drawBorder(e,t){e.save(),e.fillStyle=this.lineColor();const i=Math.max(1,Math.floor(this.rendererOptions().borderSize*t.verticalPixelRatio)),s=t.bitmapSize.width;e.fillRect(0,0,s,i),e.restore()}drawTickMarks(e,t){const i=this.chart.model().timeScale().marks();if(!i||0===i.length)return;let s=i.reduce(((e,t)=>e.span>t.span?e:t),i[0]).span;s>30&&s<40&&(s=30),e.save(),e.strokeStyle=this.lineColor();const o=this.rendererOptions(),r=o.borderSize+o.offsetSize+o.paddingTop+o.fontSize/2
;e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.textColor(),(0,it.drawScaled)(e,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{e.font=this.baseFont();for(let t=0;t<i.length;t++){const o=i[t];o.span<s&&e.fillText(o.label,o.coord,r)}e.font=this.baseBoldFont();for(let t=0;t<i.length;t++){const o=i[t];o.span>=s&&e.fillText(o.label,o.coord,r)}})),e.restore()}drawBackLabels(e,t){var i;e.save();const s=new Set,o=this.chart.model().model();let r=o.dataSources();const n=o.selection().allSources();for(const e of n)s.add(e);o.hoveredSource()&&s.add(o.hoveredSource());for(const e of o.sourcesBeingMoved())s.add(e);const a=o.customSourceBeingMoved();null!==a&&s.add(a);const l=null!==(i=o.lineBeingEdited())&&void 0!==i?i:o.lineBeingCreated();l&&s.add(l),s.add(this.chart.model().crossHairSource()),r=r.concat(o.customSources());const c=this.rendererOptions();for(let i=0;i<r.length;i++){const o=r[i];if(!s.has(o)&&o.timeAxisViews){const i=o.timeAxisViews();if(i)for(let s=0;s<i.length;s++)i[s].renderer().draw(e,t,c)}}e.restore()}drawCrossHairLabel(e,t){var i;e.save(),e.clearRect(0,0,t.bitmapSize.width,t.bitmapSize.height);const s=this.chart.model().model(),o=[],r=null!==(i=s.lineBeingEdited())&&void 0!==i?i:s.lineBeingCreated();if(r&&r.timeAxisViews){const e=r.timeAxisViews();e&&e.length&&o.push(e)}const n=s.customSourceBeingMoved();this._addViewsOrMaxMin(null===n?[]:[n],o),this._addViewsOrMaxMin(s.sourcesBeingMoved(),o),this._addViewsOrMaxMin(s.selection().allSources(),o);const a=s.hoveredSource();if(a&&(0,Zt.isDataSource)(a)&&!s.selection().isSelected(a)&&a.timeAxisViews){const e=a.timeAxisViews();e&&e.length&&o.push(e)}const l=s.crossHairSource(),c=l.timeAxisViews&&l.timeAxisViews();c&&c.length&&o.push(c);const d=this.rendererOptions();for(const i of o)for(const s of i)e.save(),s.renderer().draw(e,t,d),e.restore();e.restore()}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseOrTouchEnterEvent(e),this._mouseDownOrTouchStartEvent(e)}mouseDownOutsideEvent(){this._outsideMouseDownOrTouchStartEvent()}touchStartOutsideEvent(){this._outsideMouseDownOrTouchStartEvent()}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e),this._mouseOrTouchLeaveEvent(e)}contextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}touchContextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}mouseEnterEvent(e){this._mouseOrTouchEnterEvent(e)}mouseLeaveEvent(e){this._mouseOrTouchLeaveEvent(e)}mouseDoubleClickEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}doubleTapEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}_outsideMouseDownOrTouchStartEvent(){this._zoomAvailable()&&this._mousedown&&(this._mousedown=!1,this.chart.model().endScaleTime(),this.restoreDefaultCursor())}_highlightBackground(e,t,i){const s=this.chart.model().timeScale();let o=t[0].index,r=t[0].index;for(let e=1;e<t.length;e++)o=Math.min(o,t[e].index),
r=Math.max(r,t[e].index);const{horizontalPixelRatio:n}=i,a=Math.floor(s.indexToCoordinate(o)*n),l=Math.ceil(s.indexToCoordinate(r)*n);(0,it.fillRect)(e,a,0,l-a,i.bitmapSize.height,this._properties.childs().axisHighlightColor.value())}_addViewsOrMaxMin(e,t){if(e.length<=1){for(const i of e)if(i.timeAxisViews){const e=i.timeAxisViews();e&&e.length&&t.push(e)}}else t.push(this._minMaxViews(e))}_minMaxViews(e){const t=[];let i=1/0,s=-1/0,o=null,r=null;for(const t of e)if(t.timeAxisViews){const e=t.timeAxisViews();if(e&&e.length)for(let t=0;t<e.length;++t){const n=e[t],a=n.coordinate();a>=s&&(s=a,r=n),a<=i&&(i=a,o=n)}}return r&&t.push(r),o&&t.push(o),t}_zoomAvailable(){return!this.chart.model().timeScale().isEmpty()&&this.chart.model().model().zoomEnabled()&&this._options.pressedMouseMoveScale}_mouseDownOrTouchStartEvent(e){if(this._mousedown||!this._zoomAvailable())return;this._mousedown=!0;const t=this.chart.model();t.timeScale().isEmpty()||t.startScaleTime(e.localX)}_pressedMouseOrTouchMoveEvent(e){this._zoomAvailable()&&this.chart.model().scaleTimeTo(e.localX)}_mouseUpOrTouchEndEvent(e){this._zoomAvailable()&&(this._mousedown=!1,this.chart.model().endScaleTime(),this.restoreDefaultCursor())}_contextMenuOrTouchContextMenuEvent(e){this._options.contextMenuEnabled&&ti.ContextMenuManager.showMenu(this.getContextMenuActions(),e,{statName:"TimeScaleContextMenu"},{menuName:"TimeScaleContextMenu"})}_mouseOrTouchEnterEvent(e){this._zoomAvailable()&&this.setCursor("ew-resize")}_mouseOrTouchLeaveEvent(e){this.restoreDefaultCursor()}_mouseDoubleClickOrDoubleTapEvent(e){(0,Ne.trackEvent)("GUI","Double click time scale"),this.chart.model().resetTimeScale()}_areEventsEnabled(){var e;{const t=this.chart.model().mainSeries();switch(null===(e=t.symbolInfo())||void 0===e?void 0:e.type){case"forex":case"cfd":return!d.enabled("widget")&&this.chart.model().model().properties().childs().chartEventsSourceProperties.childs().visible.value();case"stock":case"fund":if(!d.enabled("widget")||d.enabled("esdonwidget")){const{esdShowDividends:e,esdShowSplits:i,esdShowEarnings:s}=t.properties().childs();return e.value()||i.value()||s.value()}return!1;default:return!1}}}}var Hs=i(685459),zs=i.n(Hs),Us=i(930203),Gs=(i(545437),i(637761)),qs=i(570701),js=i(378975);function Ks(e,t){return!!js.Interval.isEqual(e.res,t.res)&&(0,qs.areEqualTimeFrames)(e.val,t.val)}var Zs=i(375727),Ys=i(848891),$s=i(898192),Xs=i(939656),Js=i(615914);const Qs=new c.TranslatedString("toggle collapsed pane state",n.t(null,void 0,i(846054)));class eo extends _.UndoCommand{constructor(e,t){super(Qs),this._chartModel=e,this._paneIndex=t}redo(){this._chartModel.toggleCollapsedPane(this._paneIndex)}undo(){this._chartModel.toggleCollapsedPane(this._paneIndex)}}var to=i(310681),io=i(287741);const so=n.t(null,void 0,i(515462));function oo(e,t){const i="pro_premium_expert"===window.user.pro_plan;switch(t.reason){case"child":(0,$.createGoProDialog)({feature:"studyOnStudy",actions:i?[{text:so,action:X.PredefinedAction.Close}]:void 0});break;case"fundamental":
const t=e.allStudies().filter(ct.isFundamentalStudy).map((e=>e.title(io.TitleDisplayTarget.StatusLine)));(0,$.createGoProDialog)({feature:"fundamentalsOnChart",actions:i?[{text:so,action:X.PredefinedAction.Close}]:void 0,customParams:t});break;default:(0,Z.trackGoProFeature)("studyLimit");const s=e.listUserStudies({dontCountVolume:!0,dontCountOverlay:!0,dontCountCompare:!0});(0,$.createGoProDialog)({feature:"studyLimit",customParams:s,actions:i?[{text:so,action:X.PredefinedAction.Close}]:void 0})}}const ro=new c.TranslatedString("move all scales to left",n.t(null,void 0,i(864077))),no=new c.TranslatedString("move all scales to right",n.t(null,void 0,i(519013))),ao=(0,r.getLogger)("Chart.MergeAllScales");class lo extends _.UndoCommand{constructor(e,t,i,s,o,r){super(r),this._model=e,this._paneIndex=e.panes().indexOf(t),this._targetPosition=s,this._targetIndex=o,this._scaleId=i.id(),this._sourcePosition=t.priceScalePosition(i),"overlay"!==this._sourcePosition&&(this._sourceIndex=t.priceScaleIndex(i,this._sourcePosition))}redo(){const e=this._model.panes()[this._paneIndex],t=(0,s.ensureNotNull)(e.getPriceScaleById(this._scaleId));e.movePriceScale(t,this._targetPosition,this._targetIndex),this._model.fullUpdate()}undo(){const e=this._model.panes()[this._paneIndex],t=(0,s.ensureNotNull)(e.getPriceScaleById(this._scaleId));e.movePriceScale(t,this._sourcePosition,this._sourceIndex),this._model.fullUpdate()}}var co=i(469805);class ho extends _.UndoCommand{constructor(e,t,i,s){super(s,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._createdIds=[],this._model=e,this._withoutShift=i,this._origStates=t.map((e=>e.state(!0)));const o=e.lineToolsGroupModel();this._origGroups=t.map((e=>{const t=o.groupForLineTool(e);return t&&t.id}))}redo(){const e=this._model.lineToolsGroupModel(),t=this._origStates.map(((t,i)=>{const o=(0,s.ensureNotNull)(this._model.dataSourceForId(t.id)),r=0===this._createdIds.length?void 0:(0,s.ensureDefined)(this._createdIds[i]),n=(0,ut.cloneLineTool)(this._model,o,!this._withoutShift,r);void 0!==t.sharingMode&&n.share(t.sharingMode);const a=(0,s.ensureNotNull)(o.priceScale());(0,s.ensureNotNull)(this._model.paneForSource(o)).addDataSource(n,a,!1);const l=this._origGroups[i];if(null!==l){const t=e.groupForId(l);t&&t.addLineTools([n])}return this._model.updateSource(n),n}));0===this._createdIds.length&&(this._createdIds=t.map((e=>e.id()))),this._model.selectionMacro((e=>{e.clearSelection(),t.forEach((t=>{e.addSourceToSelection(t)}))})),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){const e=this._model.lineToolsGroupModel();this._createdIds.forEach((t=>{const i=(0,s.ensureNotNull)(this._model.dataSourceForId(t)),o=e.groupForLineTool(i);null!==o&&o.excludeLineTool(i),this._model.removeSource(i)}))}newIds(){return this._createdIds}}var uo=i(661725),po=i(204425),_o=i(375308);class mo extends _.UndoCommand{constructor(e,t,i,s=!0){super(i,s,(0,_o.sourcesAffectState)(t)),this._newStates=[],this._model=e,this._savedStates=t.map((e=>e.state(!1)))}redo(){this._applyState(this._newStates)}undo(){
0===this._newStates.length&&this.saveNewState(),this._applyState(this._savedStates)}saveNewState(){const e=this._savedStates.filter(je.notNull).map((e=>(0,s.ensureNotNull)(this._model.dataSourceForId(e.id))));this._newStates=e.map((e=>e.state(!1)))}_applyState(e){for(const t of e)if(null!==t){const e=this._model.dataSourceForId(t.id);if(null!==e)if((0,ct.isStudy)(e)){const i=t.state.inputs,s=e.properties().childs().inputs.childs();for(const e in i)s[e]&&s[e].setValue(i[e])}else this._model.restoreLineToolState(e,t,!0)}}}var go=i(438266);class So extends go.MoveSourceUndoCommand{constructor(e,t,i){super(e,t,i)}redo(){const e=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),t=(0,s.ensureNotNull)(this._chartModel.paneForSource(e)),i=this._chartModel.children(e,!0);t.bulkActionMacro((()=>{i.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(e)}));const o=this._chartModel.createPane(this.targetPaneIndex()),r=o.findSuitableScale(e);o.bulkActionMacro((()=>{o.addDataSource(e,r,!1),i.forEach((e=>o.addDataSource(e,r,!1)))}));const n=(0,s.ensureNotNull)(e.priceScale());n.restoreState(this._newPriceScaleState(o.isOverlay(e))),n.setHeight(o.height()),this._chartModel.fullUpdate(),this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){const e=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),t=(0,s.ensureNotNull)(this._chartModel.paneForSource(e)),i=this._chartModel.children(e,!0);t.bulkActionMacro((()=>{i.forEach((e=>this._chartModel.detachSource(e)));const t=this._chartModel.detachSource(e);(0,s.assert)(t,"Undo of detaching must remove pane")}));const o=this._chartModel.panes()[this._initialPaneIndex];let r=o.getPriceScaleById(this._initialPriceScaleId);null===r&&(r=o.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),o.bulkActionMacro((()=>{o.addDataSource(e,r,!0),i.forEach((e=>o.addDataSource(e,r,!1)))}));const n=(0,s.ensureNotNull)(e.priceScale());n.restoreState(this._originalPriceScaleState()),n.setHeight(o.height()),this._chartModel.fullUpdate()}}class vo extends So{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._initialPaneIndex+1}}class fo extends So{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._initialPaneIndex}}class bo extends So{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._chartModel.panes().length}}var yo=i(479935),Co=i(343272),wo=i(903424),To=i(121760),Po=i(889301);const Mo=new c.TranslatedString("create {tool}",n.t(null,void 0,i(12898)));class xo extends To.LineToolSynchronizeUndoCommand{constructor({model:e,pane:t,lineTool:i,ownerSource:s,drawOnAllChartsMode:o=0,id:r}){super(e,Mo.format({tool:new c.TranslatedString(i,Po.lineToolsLocalizedNames[i])}),!1,!co.lineToolsDoNotAffectChartInvalidation),this._lineId=null,this._lineState=null,this._paneIndex=e.panes().indexOf(t),this._lineTool=i,this._ownerSourceId=s.id(),this._lineId=null!=r?r:null,this._drawOnAllChartsMode=o}startCreatingLine(e,t,i,s,o){var r
;const n=this._chartModel.panes()[this._paneIndex],a=this._chartModel.dataSourceForId(this._ownerSourceId)||void 0,l=this._chartModel.createLineTool({pane:n,point:e,linetool:this._lineTool,properties:t,linkKey:i,sharingMode:s,ownerSource:a,id:null!==(r=this._lineId)&&void 0!==r?r:void 0,fromExternalModel:o});return this._lineId=l.id(),this._fromExternalModel=o,!this._chartModel.lineBeingCreated()}continueCreatingLine(e,t,i,s){const o=this._chartModel.continueCreatingLine(e,t,i,s,this._fromExternalModel);return o&&this._chartModel.setShouldBeSavedEvenIfHidden(!0),o}line(){return null===this._lineId?null:this._chartModel.dataSourceForId(this._lineId)}drawOnAllCharts(){return 0!==this._drawOnAllChartsMode}_redo(){if(null===this._lineState)return;const e=this._chartModel.restoreSource(!1,this._paneIndex,null,(0,s.ensureNotNull)(this._lineState),null);null!==e&&(this._lineId=e.id(),this._lineState=null,e.share(this._drawOnAllChartsMode))}_undo(){const e=this.line();null!==e&&(this._lineState=e.state(!1),this._chartModel.removeSource(e),this._lineId=null)}}const Io=new c.TranslatedString("bring {title} to front",n.t(null,void 0,i(453159))),Lo=new c.TranslatedString("send {title} to back",n.t(null,void 0,i(105005))),Ao=new c.TranslatedString("insert {title} after {targetTitle}",n.t(null,void 0,i(956307))),ko=new c.TranslatedString("insert {title} before {targetTitle}",n.t(null,void 0,i(946229))),Eo=new c.TranslatedString("send {title} backward",n.t(null,void 0,i(540962))),Do=new c.TranslatedString("bring {title} forward",n.t(null,void 0,i(941966))),Bo=new c.TranslatedString("send group {title} backward",n.t(null,void 0,i(969546))),No=new c.TranslatedString("bring group {title} forward",n.t(null,void 0,i(601979)));function Ro(e){return new c.TranslatedString(e.name(),e.title(io.TitleDisplayTarget.StatusLine))}class Oo extends _.UndoCommand{constructor(e,t,i){super(i,void 0,(0,_o.sourcesAffectState)(t)),this._sourcesByPanes=new Map,this._originalState=new Map,this._model=e,t.forEach((t=>{const i=(0,s.ensureNotNull)(e.paneForSource(t)),o=e.panes().indexOf(i),r=this._sourcesByPanes.get(o)||[];r.push(t.id()),this._sourcesByPanes.set(o,r)})),Array.from(this._sourcesByPanes.keys()).forEach((t=>{const i=e.panes()[t],s=new Map,o=new Set(i.sourcesByGroup().multipaneSources());i.sourcesByGroup().allIncludingHidden().filter((e=>!o.has(e))).forEach((e=>{s.set(e.id(),e.zorder())})),this._originalState.set(t,s)}))}undo(){this._originalState.forEach(((e,t)=>{const i=this._model.panes()[t],o=new Map;e.forEach(((e,t)=>{const r=(0,s.ensureNotNull)(i.dataSourceForId(t));o.set(r,e)})),i.setZOrders(o)}))}redo(){this._sourcesByPanes.forEach(((e,t)=>{const i=this._model.panes()[t],o=e.map((e=>(0,s.ensureNotNull)(i.dataSourceForId(e))));this._paneOperation(i,o)}))}}class Vo extends Oo{constructor(e,t){super(e,t,Io.format({title:Ro(t[0])}))}_paneOperation(e,t){e.bringToFront(t)}}class Wo extends Oo{constructor(e,t){super(e,t,Lo.format({title:Ro(t[0])}))}_paneOperation(e,t){e.sendToBack(t)}}class Fo extends Oo{constructor(e,t,i,s){super(e,t,s),
this._targetSource=i}_paneOperation(e,t){e.insertAfter(t,this._targetSource)}}class Ho extends Fo{constructor(e,t,i){super(e,t,i,Ao.format({title:Ro(t[0]),targetTitle:Ro(i)}))}}class zo extends Oo{constructor(e,t,i,s){super(e,t,s),this._targetSource=i}_paneOperation(e,t){e.insertBefore(t,this._targetSource)}}class Uo extends zo{constructor(e,t,i){super(e,t,i,ko.format({title:Ro(t[0]),targetTitle:Ro(i)}))}}function Go(e,t){const i=t[0],s=e.sourcesByGroup().all().filter((e=>e.zorder()<i.zorder()));if(0===s.length)throw new Error("Cannot move backward source that alreadt on back");let o=s[s.length-1];if((0,ut.isLineTool)(o)){const t=e.model().lineToolsGroupModel().groupForLineTool(o);null!==t&&(o=t.lineTools()[0])}return o}class qo extends zo{constructor(e,t,i){super(e,i,Go(t,i),Eo.format({title:Ro(i[0])}))}}function jo(e,t){const i=t[t.length-1],s=e.sourcesByGroup().allExceptSpecialSources().filter((e=>e.zorder()>i.zorder()));if(0===s.length)throw new Error("Cannot bring forward source that alreadt on back");let o=s[0];if((0,ut.isLineTool)(o)){const t=e.model().lineToolsGroupModel().groupForLineTool(o);if(null!==t){const e=t.lineTools();o=e[e.length-1]}}return o}class Ko extends Fo{constructor(e,t,i){super(e,i,jo(t,i),Do.format({title:Ro(i[0])}))}}function Zo(e,t){return(0,s.ensureNotNull)(e.paneForSource(t.lineTools()[0]))}class Yo extends zo{constructor(e,t){super(e,t.lineTools(),Go(Zo(e,t),t.lineTools()),Bo.format({title:t.name().value()}))}}class $o extends Fo{constructor(e,t){super(e,t.lineTools(),jo(Zo(e,t),t.lineTools()),No.format({title:t.name().value()}))}}const Xo=new c.TranslatedString("rearrange panes",n.t(null,void 0,i(202618)));class Jo extends _.UndoCommand{constructor(e,t,i){super(Xo),this._chartModel=e,this._index=t,(0,je.isNumber)(i)?this._dstIndex=i:this._dstIndex="up"===i?t-1:t+1}redo(){this._checkIndices()&&this._chartModel.movePane(this._index,this._dstIndex)}undo(){this._checkIndices()&&this._chartModel.movePane(this._dstIndex,this._index)}_checkIndices(){const e=this._chartModel.panes().length;return this._index>=0&&this._index<e&&this._dstIndex>=0&&this._dstIndex<e}}var Qo=i(868594),er=i(583912);function tr(e){var t,i;return{val:e.value(),dependenValues:null!==(i=null===(t=e.dependents)||void 0===t?void 0:t.call(e).map(tr))&&void 0!==i?i:[]}}function ir(e){var t,i;return(null!==(i=null===(t=e.dependents)||void 0===t?void 0:t.call(e))&&void 0!==i?i:[]).map(tr)}function sr(e,t){var i,s;(null!==(s=null===(i=e.dependents)||void 0===i?void 0:i.call(e))&&void 0!==s?s:[]).forEach(((e,i)=>{var s,o;e.setValue(t[i].val),(null!==(o=null===(s=e.dependents)||void 0===s?void 0:s.call(e))&&void 0!==o?o:[]).forEach((e=>sr(e,t[i].dependenValues)))}))}class or extends _.UndoCommand{constructor(e,t,i,s,o=!0){super(i,void 0,o),this._targetObj=e,this._newValue=t,this._oldValue=this._targetObj.value(),this._dependentValues=ir(this._targetObj),this._model=s}redo(){(0,Qo.allowSavingDefaults)(!0),this._targetObj.setValue(this._newValue),(0,Qo.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,
hs.globalChangeEvent)()),this._model.lightUpdate()}undo(){(0,Qo.allowSavingDefaults)(!0),this._targetObj.setValue(this._oldValue),sr(this._targetObj,this._dependentValues),(0,Qo.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,hs.globalChangeEvent)()),this._model.lightUpdate()}}class rr extends _.UndoCommand{constructor(e,t,i,s,o,r){super(s),this._prevPriceAxisProps={},this._dependentValues=[],this._property=e,this._mainSeries=i,this._value=t,this._model=o,this._chartWidget=r}redo(){const e=this._mainSeries,t=e.properties().childs();this._dependentValues=ir(this._property),this._prevResolution=t.interval.value(),this._prevValue=this._property.value(),this._storePriceAxisProps(),(0,Qo.allowSavingDefaults)(!0);const i=t.interval.value(),s=this._model.defaultResolutions(),o=(0,ds.getResolutionByChartStyle)(this._value,i,s);er.linking.interval.setValue(o),e.setChartStyleWithIntervalIfNeeded(this._value,o),(0,we.setLastUsedStyle)(this._value,e.symbolInfo()),(0,we.preparePriceAxisProperties)(t),(0,Qo.allowSavingDefaults)(!1),this._invalidateModel(),this._chartWidget.screen.show(!0)}undo(){const e=this._mainSeries;(0,Qo.allowSavingDefaults)(!0),e.setChartStyleWithIntervalIfNeeded(this._prevValue,this._prevResolution),this._restorePriceAxisProps(),er.linking.interval.setValue(this._prevResolution),sr(this._property,this._dependentValues),(0,Qo.allowSavingDefaults)(!1),this._invalidateModel(),this._chartWidget.screen.show(!0)}_storePriceAxisProps(){const e=this._mainSeries.priceScale();this._prevPriceAxisProps=e.mode()}_restorePriceAxisProps(){this._mainSeries.priceScale().setMode(this._prevPriceAxisProps)}_invalidateModel(){this._model&&(this._model.recalculateAllPanes((0,hs.sourceChangeEvent)(this._model.mainSeries().id())),this._model.lightUpdate())}}const nr=new c.TranslatedString("change date range",n.t(null,void 0,i(316979)));class ar extends _.UndoCommand{constructor(e,t){super(nr),this._modelsData=[],this._rangeOptions=t,this._modelsData.push({model:e,prevResolution:e.mainSeries().properties().childs().interval.value(),barSpacing:e.timeScale().barSpacing(),rightOffset:e.timeScale().rightOffset(),rangeOptions:e.appliedTimeFrame().value()})}redo(){for(const e of this._modelsData){const t=e.model.mainSeries(),i=t.properties().childs().interval;js.Interval.isEqual(this._rangeOptions.res,i.value())?t.loadDataTo(this._rangeOptions.val):(t.setDefaultTimeframe(this._rangeOptions.val),t.setSymbolParams({interval:this._rangeOptions.res}))}}undo(){for(const e of this._modelsData){const t=e.model.mainSeries(),i=t.properties().childs().interval;e.prevResolution!==i.value()?(null!==e.rangeOptions&&t.setDefaultTimeframe(e.rangeOptions.val),t.setSymbolParams({interval:e.prevResolution})):null!==e.rangeOptions&&t.loadDataTo(e.rangeOptions.val);const s=e.model.timeScale();s.setBarSpacing(e.barSpacing),s.setRightOffset(e.rightOffset)}}canMerge(e){return e instanceof ar&&Ks(e._rangeOptions,this._rangeOptions)}merge(e){if(!(e instanceof ar))throw new Error("Invalid command to merge")
;this._modelsData=this._modelsData.concat(e._modelsData)}}var lr=i(684634);i(466281);class cr extends _.UndoCommand{constructor(e,t,i){super(i,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._groupName=t.name().value(),this._lineToolsIds=t.lineTools().map((e=>e.id()))}redo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId));this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=new lr.LineToolsGroup(e,this._groupName,this._groupId);this._model.lineToolsGroupModel().addGroup(t)}}const dr=new c.TranslatedString("create line tools group",n.t(null,void 0,i(746219)));class hr extends _.UndoCommand{constructor(e,t){super(dr,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._groupId=null,this._model=e,this._sourcesIds=t.map((e=>e.id()))}redo(){const e=this._sourcesIds.map((e=>this._model.dataSourceForId(e))),t=null===this._groupId?void 0:this._groupId;this._groupId=this._model.lineToolsGroupModel().createGroup(e,this._title,t).id}undo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId((0,s.ensureNotNull)(this._groupId)));this._model.lineToolsGroupModel().removeGroup(e)}createdGroupId(){return this._groupId}}const ur=new c.TranslatedString("add line tool(s) to group {group}",n.t(null,void 0,i(21162)));class pr extends _.UndoCommand{constructor(e,t,i){super(ur.format({group:t.name().value()}),void 0,!co.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e)));e.addLineTools(t)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e)));(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)).excludeLineTools(e)}}class _r extends _.UndoCommand{constructor(e,t,i,s){super(s,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._chartModel=e,this._groupId=t.id,this._oldName=t.name().value(),this._newName=i}redo(){(0,s.ensureNotNull)(this._chartModel.lineToolsGroupModel().groupForId(this._groupId)).setName(this._newName)}undo(){(0,s.ensureNotNull)(this._chartModel.lineToolsGroupModel().groupForId(this._groupId)).setName(this._oldName)}}class mr extends _.UndoCommand{constructor(e,t,i,s){super(s,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._model=i,this._id=e.id(),this._targetSharingMode=t,this._originSharingMode=e.sharingMode().value()}redo(){const e=this._model.dataSourceForId(this._id);e&&(e.share(this._targetSharingMode),0!==this._targetSharingMode&&0===this._originSharingMode&&(e.linkKey().setValue((0,xe.randomHash)()),this._model.copyToOtherCharts([e],!1)))}undo(){const e=this._model.dataSourceForId(this._id);e&&(e.share(this._originSharingMode),0===this._originSharingMode&&((0,Yt.removeLineTool)({withUndo:!1,model:this._model,symbol:e.symbol(),linkKey:(0,s.ensureNotNull)(e.linkKey().value()),
sourceTitle:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e),lineToolState:e.state(!1),unlink:!0}),e.linkKey().setValue(null)))}}const gr=new c.TranslatedString("create line tools group from selection",n.t(null,void 0,i(695394))),Sr=new c.TranslatedString("removing line tools group {name}",n.t(null,void 0,i(241430))),vr=new c.TranslatedString("add line tool {lineTool} to group {name}",n.t(null,void 0,i(612570))),fr=new c.TranslatedString("make group {group} visible",n.t(null,void 0,i(645987))),br=new c.TranslatedString("make group {group} invisible",n.t(null,void 0,i(576709))),yr=new c.TranslatedString("lock group {group}",n.t(null,void 0,i(720453))),Cr=new c.TranslatedString("unlock group {group}",n.t(null,void 0,i(974590))),wr=new c.TranslatedString("rename group {group} to {newName}",n.t(null,void 0,i(80491)));class Tr{constructor(e){this._environment=e}createGroupFromSelection(){const e=this._environment.model();(0,s.assert)(!e.selection().isEmpty(),"Cannot create group from empty selection");const t=(0,Co.sortSources)(e.selection().lineDataSources());(0,s.assert)(t.length===e.selection().allSources().length,"A group could contain line tools only");const i=t.length>1||null!==this._environment.model().lineToolsGroupModel().groupForLineTool(t[0]),o=t.reduce(((e,t)=>e.zorder()>t.zorder()?e:t),t[0]);let r=o;const n=e.lineToolsGroupModel().groupForLineTool(o);if(null!==n){const e=n.lineTools();r=e[e.length-1]}this._environment.beginUndoMacro(gr);const a=new Map,l=new Set;t.forEach((t=>{const i=this._groupForLineTool(t);if(null===i)return;const o=a.get(i)||[];o.push(t),a.set(i,o);const r=(0,s.ensureNotNull)(e.paneForSource(t));l.add(r)})),(0,s.assert)(l.size<=1,"All selected sources should be on the same pane"),a.forEach(((t,i)=>{const s=new po.ExcludeLineToolsFromGroupUndoCommand(e,i,t);this._environment.pushUndoCommand(s)}));const c=new hr(e,(0,Co.sortSources)(t));if(this._environment.pushUndoCommand(c),i){const i=new Ho(e,t,r);this._environment.pushUndoCommand(i)}this._environment.endUndoMacro();const d=(0,s.ensureNotNull)(c.createdGroupId());return(0,s.ensureNotNull)(e.lineToolsGroupModel().groupForId(d))}removeGroup(e){const t=this._environment.model(),i=e.lineTools();this._environment.beginUndoMacro(Sr.format({name:e.name().value()}));const o=new cr(t,e,null);this._environment.pushUndoCommand(o);const r=new uo.RemoveSourcesUndoCommand(t,i,null);this._environment.pushUndoCommand(r);const n=t.mainSeries().symbol();i.forEach((e=>{null!==e.linkKey().value()&&(0,Yt.removeLineTool)({withUndo:!0,model:t,symbol:n,sourceTitle:new c.TranslatedString(e.name(),e.title(io.TitleDisplayTarget.DataWindow)),lineToolState:e.state(!1),linkKey:(0,s.ensureNotNull)(e.linkKey().value())})})),this._environment.endUndoMacro()}groups(){return this._environment.model().lineToolsGroupModel().groups()}excludeLineToolFromGroup(e,t){const i=this._environment.model(),s=new po.ExcludeLineToolsFromGroupUndoCommand(i,e,[t]);this._environment.pushUndoCommand(s)}addLineToolToGroup(e,t){
const i=this._environment.model(),s=i.lineToolsGroupModel().groupForLineTool(t);if(s===e)return;const o=vr.format({lineTool:new c.TranslatedString(t.name(),t.title(io.TitleDisplayTarget.StatusLine)),name:e.name().value()});this._environment.beginUndoMacro(o),null!==s&&this._environment.pushUndoCommand(new po.ExcludeLineToolsFromGroupUndoCommand(i,s,[t]));{const s=e.sharingMode().value();t.sharingMode().value()!==s&&this._environment.pushUndoCommand(new mr(t,s,i,null))}this._environment.pushUndoCommand(new pr(i,e,[t])),this._environment.endUndoMacro()}bringToFront(e){const t=this._environment.model(),i=new Vo(t,e.lineTools());this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}sendToBack(e){const t=this._environment.model(),i=new Wo(t,e.lineTools());this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}bringForward(e){const t=this._environment.model(),i=new $o(t,e);this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}sendBackward(e){const t=this._environment.model(),i=new Yo(t,e);this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}insertAfter(e,t){const i=this._environment.model();let s;if(t instanceof lr.LineToolsGroup){const e=t.lineTools();s=e[e.length-1]}else s=t;const o=new Ho(i,e.lineTools(),s);this._environment.pushUndoCommand(o),this._environment.emitEvent("changeZOrder",[e.lineTools()])}insertBefore(e,t){const i=this._environment.model();let s;if(t instanceof lr.LineToolsGroup){s=t.lineTools()[0]}else s=t;const o=new Uo(i,e.lineTools(),s);this._environment.pushUndoCommand(o),this._environment.emitEvent("changeZOrder",[e.lineTools()])}availableZOrderOperations(e){const t=this._environment.model(),i=e.lineTools(),o=i[0],r=i[i.length-1],n=(0,s.ensureNotNull)(t.paneForSource(i[0])).sourcesByGroup().allExceptSpecialSources(),a=n[0],l=n[n.length-1];return{bringForwardEnabled:r!==l,bringToFrontEnabled:r!==l,sendBackwardEnabled:o!==a,sendToBackEnabled:o!==a}}setGroupVisibility(e,t){const i=(t?fr:br).format({group:e.name().value()}),s=this._environment.model();this._environment.beginUndoMacro(i),e.lineTools().forEach((e=>{const i=e.properties().visible,o=new or(i,t,null,s,!co.lineToolsDoNotAffectChartInvalidation);this._environment.pushUndoCommand(o)})),this._environment.endUndoMacro()}setGroupLock(e,t){const i=(t?yr:Cr).format({group:e.name().value()}),s=this._environment.model();this._environment.beginUndoMacro(i),e.lineTools().forEach((e=>{const i=e.properties().frozen,o=new or(i,t,null,s,!co.lineToolsDoNotAffectChartInvalidation);this._environment.pushUndoCommand(o)})),this._environment.endUndoMacro()}setGroupName(e,t){const i=this._environment.model(),s=wr.format({group:e.name().value(),newName:t}),o=new _r(i,e,t,s);this._environment.pushUndoCommand(o)}canBeGroupped(e){const t=this._environment.model();return new Set(e.map((e=>t.paneForSource(e)))).size<=1}_groupForLineTool(e){
return this._environment.model().lineToolsGroupModel().groups().find((t=>t.containsLineTool(e)))||null}}var Pr=i(852290),Mr=i(632911),xr=i(198930),Ir=i(691246);const Lr=new c.TranslatedString("apply study template {template}",n.t(null,void 0,i(69604)));function Ar(e){for(const t of e.panes)for(const e of t.sources)if((0,xr.isMainSeriesState)(e))return e.id;return null}class kr extends _.UndoCommand{constructor(e,t,i){var o,r;super(Lr.format({template:i})),this._newSymbolParams={},this._model=e,this._templateContent=function(e,t){const i=(0,Pr.default)({},e),o=(0,s.ensureNotNull)(Ar(i));for(const e of i.panes){e.mainSourceId===o&&(e.mainSourceId=t);for(const i of e.sources)if(i.id===o){i.id=t;const s=e=>{const i=e.indexOf(o);-1!==i&&e.splice(i,1,t)};if(e.leftAxisesState&&e.rightAxisesState?(e.leftAxisesState.forEach((e=>s(e.sources))),e.rightAxisesState.forEach((e=>s(e.sources)))):(s(e.leftAxisSources),s(e.rightAxisSources)),e.overlayPriceScales){const i=e.overlayPriceScales[o];i&&(delete e.overlayPriceScales[o],e.overlayPriceScales[t]=i)}}else i.ownerSource===o&&(i.ownerSource=t)}return i}(t,e.mainSeries().id()),this._initialState=e.studyTemplate(!0,!0,!0);const n=e.mainSeries();t.symbol&&(this._newSymbolParams={symbol:t.symbol,currency:null!==(o=t.currency)&&void 0!==o?o:null,unit:null!==(r=t.unit)&&void 0!==r?r:null}),t.interval&&(this._newSymbolParams.interval=t.interval,this._newSymbolParams.style=(0,we.getChartStyleByResolution)(t.interval,n.style())),this._initialSymbolParams={symbol:n.symbol(),currency:n.currency(),unit:n.unit(),interval:n.interval(),style:n.style()},this._initialState=e.studyTemplate(),this._initialGroupsState=e.lineToolsGroupModel().state()}redo(){this._model.mainSeries().setSymbolParams(this._newSymbolParams);const e=this._merge(this._templateContent).filter(ut.isLineTool);this._model.lineToolsGroupModel().removeLineTools(e);const t=this._model.mainSeries().properties();(0,we.preparePriceAxisProperties)(t),this._model.recalcVisibleRangeStudies(jt.RecalcVisibleRangeStudiesReason.StudyCreation),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){this._model.mainSeries().setSymbolParams(this._initialSymbolParams),this._merge(this._initialState)}_merge(e){const t=e.version||0,i=this._model,o=i.mainSeries();(0,s.assert)(o.id()===Ar(e)),o.priceScale().properties().childs().lockScale.setValue(!1);const r=i.panes(),n=[];for(let e=r.length;e--;){const t=r[e],i=t.containsMainSeries(),s=t.dataSources();for(let e=s.length;e--;){const t=s[e];(!i||((0,ct.isStudy)(t)||(0,ct.isStudyStub)(t))&&t.isRemovedByStudyTemplates())&&n.push(t)}}i.resetDeferredStudies();const a=(0,Mr.closeSourcesSet)(i,n);for(let e=0;e<a.length;++e)i.removeSource(a[e]);const l=e.panes;for(let e=0;e<l.length;e++){let o=-1;const n=(0,je.clone)(l[e]);n.sources.sort(((e,t)=>e.zorder-t.zorder));for(let e=0;e<n.sources.length;e++){const t=n.sources[e];if((0,xr.isMainSeriesState)(t)){delete t.state,o=e;break}}const a=o>-1,c=a?r[e]:i.createPane(e);if(a&&t<3&&(0,Ir.reorderDataSourcesStateZOrder)(n.sources),c.restoreState({state:n,withData:!1,
version:t}),null!==c.mainDataSource()){const e=(0,s.ensureNotNull)(this._model.alertsWatcher());for(const t of c.dataSources())e.syncSourceAlertLabels(t)}else i.removePane(c)}return i.syncLollipopSources(),o.priceScale().setMode({autoScale:!0}),i.startNotStartedStudies(),i.recalculateAllPanes((0,hs.globalChangeEvent)()),i.fullUpdate(),a}}var Er=i(487945);const Dr=(0,r.getLogger)("Chart.ChartUndoModel"),Br=new c.TranslatedString("paste drawing",n.t(null,void 0,i(862192)));class Nr extends _.UndoCommand{constructor(e,t,i,o,r){super(Br,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._needCopyToOtherCharts=!1,this._sourceState=null,this._model=e,this._clipboardData=t,this._paneIndex=this._model.panes().indexOf(i||(0,s.ensureNotNull)(this._model.paneForSource(this._model.mainSeries()))),this._pasteWithData=!!o,this._keepZIndex=!!r}redo(){const e=this._model.panes()[this._paneIndex],t=(0,s.ensureNotNull)(e.clipboardLineToolOwnerSource(this._clipboardData.source.id)),i=t===this._model.mainSeries();null===this._sourceState&&(this._sourceState=this._getSourceState(t,i));const o=(0,s.ensureNotNull)(e.restoreLineTool(this._sourceState,this._pasteWithData,this._keepZIndex,void 0,t));(0,s.ensureNotNull)(t.priceScale()).addDataSource(o),this._clipboardData.centeredOnChart&&o.centerPosition&&o.centerPosition(),o.restoreFixedPoint(),o.createServerPoints(),this._needCopyToOtherCharts=Boolean(i&&o.isSynchronizable()&&0!==o.sharingMode().value()),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){if(!this._sourceState)return void Dr.logError("This command was never executed - nothing to undo");const e=this.source();this._clipboardData.centeredOnChart&&(this._clipboardData.centeredOnChart=!1,this._sourceState.points=e.normalizedPoints()),this._model.removeSource(e)}source(){return(0,s.ensureNotNull)(this._model.dataSourceForId((0,s.ensureNotNull)(this._sourceState).id))}needCopyToOtherCharts(){return this._needCopyToOtherCharts}_getSourceState(e,t){const i=(0,je.clone)(this._clipboardData.source);delete i.state.symbol,t?(null!=i.linkKey||void 0!==i.sharingMode&&0!==i.sharingMode)&&(i.linkKey=(0,xe.randomHash)()):(i.linkKey=null,i.sharingMode=0);const r=(0,s.ensureNotNull)(e.priceScale()),n=this._model,{symbol:a,currencyId:l,unitId:c}=this._clipboardData.source.state,d=(0,s.ensureNotNull)(e.symbolSource());let h=!1;!d.symbolSameAsCurrent(a)||(null!==l?l!==(0,we.symbolCurrency)(d.symbolInfo(),void 0,!0):d.isConvertedToOtherCurrency())||(null!==c?c!==(0,we.symbolUnit)(d.symbolInfo(),this._model.unitConversionEnabled()):d.isConvertedToOtherUnit())||((0,Er.isActingAsSymbolSource)(e)?h=!0:(0,ct.isStudy)(e)&&(h=Boolean(e.metaInfo().is_price_study))),i.state.currencyId=n.currencyConversionEnabled()&&d.isConvertedToOtherCurrency()?d.currency():null,i.state.unitId=n.unitConversionEnabled()&&d.isConvertedToOtherUnit()?d.unit():null;const u=e=>{const t=e.x*n.timeScale().width(),i=e.y*r.height()-40;return new o.Point(t,i)},p=(0,s.ensureNotNull)(e.firstValue());if(this._model.id()===this._clipboardData.modelId||!h){
for(let e=0;e<this._clipboardData.geometry.length;++e){const t=u(this._clipboardData.geometry[e]),s=n.timeScale().coordinateToIndex(t.x),o=n.timeScale().normalizeBarIndex(s);if(h){const t=r.priceToCoordinate(i.points[e].price,p)+-40;o.price=r.coordinateToPrice(t,p)}else o.price=r.coordinateToPrice(t.y,p);i.points[e]=o}i.state.interval=n.mainSeries().interval()}return i.id=(0,xe.randomHashN)(6),i}}class Rr extends _.UndoCommand{constructor(e,t,i,o){super(o),this._newSourcesCurrencies=new Map,this._oldSourcesCurrencies=new Map,this._showFade=!1,this._chartModel=e;const r=e.mainSeries();for(const e of t.seriesLikeSources()){if(!e.isVisible()||!e.isActingAsSymbolSource().value())continue;const t=i||(0,we.symbolOriginalCurrency)((0,s.ensureNotNull)(e.symbolInfo()));this._newSourcesCurrencies.set(e.id(),t),this._oldSourcesCurrencies.set(e.id(),e.currency()),this._showFade=this._showFade||e===r&&e.currency()!==t}}redo(){this._applyCurrencies(this._newSourcesCurrencies)}undo(){this._applyCurrencies(this._oldSourcesCurrencies)}_applyCurrencies(e){e.forEach(((e,t)=>{(0,s.ensureNotNull)(this._chartModel.dataSourceForId(t)).setCurrency(e)})),this._chartModel.selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartModel.undoModel().loadingScreen().show(!0)}}class Or extends _.UndoCommand{constructor(e,t,i,o){super(o),this._newSourcesUnits=new Map,this._oldSourcesUnits=new Map,this._showFade=!1,this._chartModel=e;const r=e.mainSeries();for(const e of t.seriesLikeSources()){if(!e.isVisible()||!e.isActingAsSymbolSource().value())continue;const t=i||(0,we.symbolOriginalUnit)((0,s.ensureNotNull)(e.symbolInfo()),this._chartModel.unitConversionEnabled());this._newSourcesUnits.set(e.id(),t),this._oldSourcesUnits.set(e.id(),e.unit()),this._showFade=this._showFade||e===r&&e.unit()!==t}}redo(){this._applyUnits(this._newSourcesUnits)}undo(){this._applyUnits(this._oldSourcesUnits)}_applyUnits(e){e.forEach(((e,t)=>{(0,s.ensureNotNull)(this._chartModel.dataSourceForId(t)).setUnit(e)})),this._chartModel.selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartModel.undoModel().loadingScreen().show(!0)}}var Vr=i(995625);class Wr extends _.UndoCommand{constructor(e,t,i,s){super(e),this._charts=new Map,this._firstRedo=!0,this._creationTime=performance.now(),this._linkingGroupIndex=s.linkingGroupIndex().value(),this._charts.set(s,{sourceId:t.id(),newSymbolParams:i,prevSymbolParams:t.symbolParams(),showFade:this._showFade(t,s),chartWidget:s})}redo(){this._firstRedo||(0,a.muteLinkingGroup)(this._linkingGroupIndex,!0),this._charts.forEach((e=>{this._symbolSource(e).setSymbolParams(e.newSymbolParams),e.showFade&&e.chartWidget.screen.show(!0)})),this._firstRedo||(0,a.muteLinkingGroup)(this._linkingGroupIndex,!1),this._firstRedo=!1}undo(){(0,a.muteLinkingGroup)(this._linkingGroupIndex,!0),this._charts.forEach((e=>{this._symbolSource(e).setSymbolParams(e.prevSymbolParams),e.showFade&&e.chartWidget.screen.show(!0)})),(0,a.muteLinkingGroup)(this._linkingGroupIndex,!1)}canMerge(e){
if(!(e instanceof Wr)||e._linkingGroupIndex!==this._linkingGroupIndex||!this._containsMainSeriesOnly()||!e._containsMainSeriesOnly()||e._creationTime-this._creationTime>500)return!1;for(const[t]of e._charts)if(this._charts.has(t))return!1;return!0}merge(e){if(e instanceof Wr)for(const[t,i]of e._charts)this._charts.set(t,i)}_showFade(e,t){return e===t.model().mainSeries()}_symbolSource(e){return(0,s.ensureNotNull)(e.chartWidget.model().model().dataSourceForId(e.sourceId))}_containsMainSeriesOnly(){for(const[e,t]of this._charts)if(t.sourceId!==e.model().mainSeries().id())return!1;return!0}}const Fr=new c.TranslatedString("change symbol",n.t(null,void 0,i(435400)));class Hr extends Wr{constructor(e,t,i){super(Fr,e,{symbol:t,currency:null,unit:null},i),this._symbol=t}canMerge(e){return e instanceof Hr&&e._symbol===this._symbol&&super.canMerge(e)}}const zr=(0,r.getLogger)("Chart.ChartUndoModel"),Ur=new c.TranslatedString("paste indicator",n.t(null,void 0,i(901064)));class Gr extends _.UndoCommand{constructor(e,t,i){super(Ur),this._sourceState=null,this._model=e,this._clipboardData=t,this._paneId=i}redo(){if(!this._sourceState){const e=(0,je.clone)(this._clipboardData.source);e.id=(0,xe.randomHashN)(6),this._sourceState=e}let e,t;e=this._paneId?(0,s.ensureNotNull)(this._model.paneForId(this._paneId)):this._sourceState.metaInfo.is_price_study?(0,s.ensureNotNull)(this._model.paneForSource(this._model.mainSeries())):this._model.createPane();const i=!e.mainDataSource();this._sourceState.zorder=e.newStudyZOrder();const o=(0,s.ensureNotNull)(e.restoreStudy(this._sourceState,!1));i||(t=this._sourceState.metaInfo.is_price_study?t=this._model.mainSeries().priceScale():this._paneId?e.findSuitableScale(o):e.defaultPriceScale(),t!==o.priceScale()&&e.move(o,t)),(0,ct.isStudy)(o)&&o.start()}undo(){if(null===this._sourceState)return void zr.logError("This command was never executed - nothing to undo");const e=(0,s.ensureNotNull)(this._model.dataSourceForId(this._sourceState.id));this._model.removeSource(e)}state(){return this._sourceState}}class qr extends _.UndoCommand{constructor(e,t,i,s,o){super(null,!1),this._model=e,this._paneA=t,this._paneB=i,this._prevStretchA=s,this._currStretchA=o}redo(){const e=this._paneA.stretchFactor()+this._paneB.stretchFactor();this._paneA.setStretchFactor(this._currStretchA),this._paneB.setStretchFactor(e-this._currStretchA),this._model.fullUpdate()}undo(){const e=this._paneA.stretchFactor()+this._paneB.stretchFactor();this._paneA.setStretchFactor(this._prevStretchA),this._paneB.setStretchFactor(e-this._prevStretchA),this._model.fullUpdate()}}const jr=new c.TranslatedString("move",n.t(null,void 0,i(398277)));class Kr extends _.UndoCommand{constructor(e,t,i,s){super(jr,!1),this._endEvent=null,this._model=e,this._sourceId=t.id(),this._itemIndex=i,this._startEvent=s}move(e){this._endEvent=e,this._move(e)}hasChanges(){return null!==this._endEvent}undo(){this._move(this._startEvent)}redo(){this._move((0,s.ensureNotNull)(this._endEvent))}_move(e){const t=(0,
s.ensureNotNull)(this._model.dataSourceForId(this._sourceId));(0,s.assert)(void 0!==t.moveItem,'The method "moveItem" is not defined'),t.moveItem&&t.moveItem(new o.Point(e.localX,e.localY),this._itemIndex,new Kt.EnvironmentState(e))}}var Zr=i(414358);class Yr extends _.UndoCommand{constructor(e,t,i,s){super(i),this._newMode=e,this._priceScaleId=t.id(),this._model=s,this._oldMode=t.mode()}redo(){this._applyMode(this._newMode)}undo(){this._applyMode(this._oldMode)}_applyMode(e){const t=this._findPriceScaleById();null!==t&&((0,Qo.allowSavingDefaults)(!0),t.setMode(e),(0,Qo.allowSavingDefaults)(!1),this._model&&(this._model.recalculateAllPanes((0,hs.viewportChangeEvent)()),this._model.lightUpdate()))}_findPriceScaleById(){const e=this._model.panes();for(let t=0;t<e.length;t++){const i=e[t].getPriceScaleById(this._priceScaleId);if(null!==i)return i}return null}}var $r=i(7462),Xr=i.n($r),Jr=i(674720),Qr=i(393747),en=i(63171);var tn=i(163130),sn=i(296842),on=i(967805),rn=i(552279);const nn=new c.TranslatedString("zoom",n.t(null,void 0,i(991084)));class an extends _.UndoCommand{constructor(e,t,i,s,o,r){super(nn),this._barSpacing=null,this._rightBarsOffset=null,this._leftBarsOffset=null,this._priceMode=null,this._model=e,this._startBar=t,this._endBar=i,this._startPrice=s,this._endPrice=o,this._pane=r}redo(){const e=(0,s.ensureNotNull)(this._model.timeScale().visibleBarsStrictRange());this._leftBarsOffset=e.firstBar()-this._startBar,this._rightBarsOffset=e.lastBar()-this._endBar,this._barSpacing=this._model.timeScale().barSpacing(),this._priceMode=this._pane.defaultPriceScale().mode(),this._model.zoomToViewport(this._startBar,this._endBar,this._startPrice,this._endPrice,this._pane)}undo(){const e=this._model.timeScale(),t=this._pane.defaultPriceScale(),i=(0,s.ensureNotNull)(e.visibleBarsStrictRange());e.setBarSpacing((0,s.ensureNotNull)(this._barSpacing)),e.zoomToBarsRange(i.firstBar()+(0,s.ensureNotNull)(this._leftBarsOffset),i.lastBar()+(0,s.ensureNotNull)(this._rightBarsOffset)),t.setMode((0,s.ensureNotNull)(this._priceMode)),t.recalculatePriceRange((0,s.ensureNotNull)(e.visibleBarsStrictRange())),this._model.recalculateAllPanes((0,hs.viewportChangeEvent)()),this._model.lightUpdate()}}const ln=(0,r.getLogger)("Chart.ChartUndoModel"),cn=new c.TranslatedString("zoom",n.t(null,void 0,i(991084)));class dn extends _.UndoCommand{constructor(e,t,i){super(cn),this._baseCmd=e,this._zoomStack=t,this._inOut=i}undo(){if(this._inOut){if(this._baseCmd!==this._zoomStack.head())return void ln.logDebug("zoom stack inconsistency");this._baseCmd.undo(),this._zoomStack.pop()}else this._baseCmd.redo(),this._zoomStack.push(this._baseCmd)}redo(){if(this._inOut)this._baseCmd.redo(),this._zoomStack.push(this._baseCmd);else{if(this._baseCmd!==this._zoomStack.head())return void ln.logDebug("zoom stack inconsistency");this._baseCmd.undo(),this._zoomStack.pop()}}}const hn=new c.TranslatedString("stop syncing drawing",n.t(null,void 0,i(703350)));class un extends _.UndoCommand{constructor(e,t){super(hn,void 0,!co.lineToolsDoNotAffectChartInvalidation),
this._model=e,this._sourceId=t.id(),this._linkKey=t.linkKey().value()}redo(){(0,s.ensureNotNull)(this._model.dataSourceForId(this._sourceId)).linkKey().setValue(null)}undo(){(0,s.ensureNotNull)(this._model.dataSourceForId(this._sourceId)).linkKey().setValue(this._linkKey)}}var pn=i(985429);const _n=new c.TranslatedString("restore defaults",n.t(null,void 0,i(985815)));class mn extends _.UndoCommand{constructor(e,t,i=_n,s=!0){super(i,void 0,s),this._chartModel=e,this._defaultProperty=t,this._state=t.state()}redo(){this._chartModel.restoreFactoryDefaults(this._defaultProperty)}undo(){this._defaultProperty.mergeAndFire(this._state),this._chartModel.mainSeries().onChartStyleChanged()}}class gn extends mn{constructor(e,t,i,s){super(e,t,i,null!=s?s:!co.lineToolsDoNotAffectChartInvalidation)}redo(){this._defaultProperty.hasChild("intervalsVisibilities")&&this._defaultProperty.childs().intervalsVisibilities.mergeAndFire(pn.intervalsVisibilitiesDefaults),super.redo()}}var Sn=i(923451);const vn=new c.TranslatedString("restore study defaults",n.t(null,void 0,i(796881)));class fn extends gn{constructor(e,t,i=vn){super(e,t.properties(),i,!0),this._study=t}redo(){super.redo(),this._chartModel.recalcColorStudies(!0),this._patchProperties()}undo(){super.undo(),this._chartModel.recalcColorStudies(!0),this._patchProperties()}_patchProperties(){{const e=this._study.inputs();Object.keys(e).some((e=>(0,Ke.isStudyInputDependsOnChart)({id:e})))&&(0,Sn.patchPropertiesAsync)(this._study.properties(),this._study.metaInfo(),e)}}}var bn=i(412788),yn=i(211183);function Cn(e){return(0,Fe.pickFields)(e,["bidLineColor","askLineColor"])}function wn(e){return(0,Fe.pickFields)(e,["preMarketColor","postMarketColor"])}function Tn(e){return(0,Fe.pickFields)(e,["highLowPriceLinesColor","averagePriceLineColor"])}function Pn(e){return(0,Fe.pickFields)(e,["upColor","downColor","borderColor","borderUpColor","borderDownColor","wickDownColor","wickUpColor","wickColor"])}function Mn(e){return(0,Fe.pickFields)(e,["upColor","downColor","borderColor","borderUpColor","borderDownColor","wickDownColor","wickUpColor","wickColor"])}function xn(e){return(0,Fe.pickFields)(e,["upColor","downColor","borderColor","borderUpColor","borderDownColor","wickDownColor","wickUpColor","wickColor"])}function In(e){return(0,Fe.pickFields)(e,["upColor","downColor"])}function Ln(e){return(0,Fe.pickFields)(e,["color","borderColor","labelColor"])}function An(e){return(0,Fe.pickFields)(e,["color"])}function kn(e){return(0,Fe.pickFields)(e,["transparency","color1","color2","linecolor"])}function En(e){const{inputs:t,...i}=e;return i}function Dn(e){const{inputs:t,...i}=e;return i}function Bn(e){const{inputs:t,...i}=e;return i}function Nn(e){const{inputs:t,...i}=e;return i}function Rn(e){const{topLineWidth:t,bottomLineWidth:i,baseLevelPercentage:s,priceSource:o,...r}=e;return r}function On(e){const{thinBars:t,inputs:i,barStyle:s,...o}=e;return o}function Vn(e){const{sellColor:t,buyColor:i}=e.imbalanceHighlight;return{bgColors:e.bgColors,imbalanceHighlight:{sellColor:t,buyColor:i}}}
function Wn(e){const{color:t,tpo:{colors:i},volumeProfile:{valuesColor:s,volumeColor:o,valueAreaColor:r,vah:n,val:a,poc:l}}=e;return{color:t,tpo:{colors:i},volumeProfile:{valuesColor:s,volumeColor:o,valueAreaColor:r,vah:{color:n.color},val:{color:a.color},poc:{color:l.color}}}}function Fn(e){const{volumeProfile:{valuesColor:t,volumeColorUp:i,volumeColorDown:s,valueAreaColorUp:o,valueAreaColorDown:r,histogramBoxColor:n}}=e;return{volumeProfile:{valuesColor:t,volumeColorUp:i,volumeColorDown:s,valueAreaColorUp:o,valueAreaColorDown:r,histogramBoxColor:n},vah:{color:e.vah.color},val:{color:e.val.color},poc:{color:e.poc.color},developingPoc:{color:e.developingPoc.color},developingVA:{color:e.developingVA.color}}}function Hn(e){const{baseLineColor:t,priceLineColor:i,prevClosePriceLineColor:s,highLowAvgPrice:o,bidAsk:r,prePostMarket:n,hlcAreaStyle:a,candleStyle:l,volCandlesStyle:c,hollowCandleStyle:d,haStyle:h,barStyle:u,hiloStyle:p,lineStyle:_,lineWithMarkersStyle:m,steplineStyle:g,areaStyle:S,renkoStyle:v,pbStyle:f,kagiStyle:b,pnfStyle:y,baselineStyle:C,rangeStyle:w,volFootprintStyle:T,tpoStyle:P,svpStyle:M}=e;return{baseLineColor:t,priceLineColor:i,prevClosePriceLineColor:s,hlcAreaStyle:(x=a,(0,Fe.pickFields)(x,["highLineColor","lowLineColor","closeLineColor","highCloseFillColor","closeLowFillColor"])),bidAsk:Cn(r),prePostMarket:wn(n),candleStyle:Pn(l),hollowCandleStyle:Mn(d),haStyle:xn(h),barStyle:In(u),hiloStyle:Ln(p),lineStyle:An(_),lineWithMarkersStyle:An(m),steplineStyle:An(g),areaStyle:kn(S),renkoStyle:En(v),pbStyle:Dn(f),kagiStyle:Bn(b),pnfStyle:Nn(y),baselineStyle:Rn(C),rangeStyle:On(w),volFootprintStyle:Vn(T),tpoStyle:Wn(P),svpStyle:Fn(M),volCandlesStyle:Pn(c),highLowAvgPrice:Tn(o)};var x}function zn(e){return(0,Fe.pickFields)(e,["backgroundColor","lineColor","textColor","axisHighlightColor","axisLineToolLabelBackgroundColorCommon","axisLineToolLabelBackgroundColorActive","crosshairLabelBgColorLight","crosshairLabelBgColorDark"])}function Un(e){const{separatorColor:t,background:i,backgroundGradientEndColor:s,backgroundGradientStartColor:o,backgroundType:r,horzGridProperties:n,vertGridProperties:a,crossHairProperties:l}=e;return{separatorColor:t,background:i,backgroundGradientEndColor:s,backgroundGradientStartColor:o,backgroundType:r,horzGridProperties:{color:n.color},vertGridProperties:{color:a.color},crossHairProperties:{color:l.color,transparency:l.transparency}}}function Gn(e){const{graphics:{backgrounds:{outOfSession:t,preMarket:i,postMarket:s},vertlines:{sessBreaks:o}}}=e;return{graphics:{backgrounds:{outOfSession:{color:t.color,transparency:t.transparency},preMarket:{color:i.color,transparency:i.transparency},postMarket:{color:s.color,transparency:s.transparency}},vertlines:{sessBreaks:{color:o.color}}}}}function qn(e){var t,i;e.wickUpColor=null!==(t=e.wickUpColor)&&void 0!==t?t:e.wickColor,e.wickDownColor=null!==(i=e.wickDownColor)&&void 0!==i?i:e.wickColor,delete e.wickColor}const jn=new c.TranslatedString("apply chart theme",n.t(null,void 0,i(368231)));class Kn extends _.UndoCommand{constructor(e,t,i){
var s,o,r,n;super(jn),this._model=e,this._newSessionProps=t.sessions?{properties:i?t.sessions:Gn(t.sessions)}:void 0,qn(t.mainSourceProperties.candleStyle),qn(t.mainSourceProperties.hollowCandleStyle),qn(t.mainSourceProperties.haStyle);const a=t;a.chartProperties=null!==(s=a.chartProperties)&&void 0!==s?s:{paneProperties:{},scalesProperties:void 0};const l=a.chartProperties.paneProperties.gridProperties;a.chartProperties.paneProperties.vertGridProperties=null!==(o=a.chartProperties.paneProperties.vertGridProperties)&&void 0!==o?o:l,a.chartProperties.paneProperties.horzGridProperties=null!==(r=a.chartProperties.paneProperties.horzGridProperties)&&void 0!==r?r:l;const c=this._model.properties().state().paneProperties.legendProperties;delete c.backgroundTransparency;const d=a.chartProperties.paneProperties;i?d.legendProperties={...d.legendProperties,...c}:delete d.legendProperties;const h=(0,yn.factoryDefaults)("chartproperties"),u=(0,Gt.deepExtend)({},h,t.chartProperties),p=i?u.paneProperties:Un(u.paneProperties),_=i?u.scalesProperties:zn(u.scalesProperties);this._newChartProps={paneProperties:p,scalesProperties:_},e.timeScale().preserveBarSpacing()&&delete this._newChartProps.scalesProperties.barSpacing;const m=(0,yn.factoryDefaults)("chartproperties.mainSeriesProperties"),g=(0,Gt.deepExtend)({},m,t.mainSourceProperties);this._newSeriesProps=i?g:Hn(g);const S=e.properties().state();this._oldChartProps={paneProperties:Un(S.paneProperties),scalesProperties:zn(S.scalesProperties)};const v=e.mainSeries().properties().state();this._oldSeriesProps=i?v:Hn(v),this._oldSessionProps=null!==(n=this._model.sessions().state())&&void 0!==n?n:void 0}undo(){this._merge(this._oldChartProps,this._oldSeriesProps,this._oldSessionProps),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales(),this._model.chartThemeLoaded()}redo(){this._merge(this._newChartProps,this._newSeriesProps,this._newSessionProps),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales(),this._model.chartThemeLoaded()}_merge(e,t,i){var s,o,r,n;const a=this._model;(0,Qo.allowSavingDefaults)(!0),e&&(a.properties().childs().paneProperties.mergeAndFire(e.paneProperties),a.properties().childs().scalesProperties.mergeAndFire(e.scalesProperties)),"priceAxisProperties"in t&&a.mainSeries().priceScale().setMode({autoScale:null===(s=t.priceAxisProperties)||void 0===s?void 0:s.autoScale,percentage:null===(o=t.priceAxisProperties)||void 0===o?void 0:o.percentage,log:null===(r=t.priceAxisProperties)||void 0===r?void 0:r.log,lockScale:null===(n=t.priceAxisProperties)||void 0===n?void 0:n.lockScale}),a.mainSeries().properties().mergeAndFire(t),a.mainSeries().properties().updateThemedColors(),a.mainSeries().properties().saveDefaults(),a.mainSeries().createPaneView(),a.mainSeries().invalidateBarStylesCache(),a.recalculateAllPanes((0,hs.globalChangeEvent)()),a.fullUpdate(),a.properties().saveDefaults(),i&&a.sessions().restoreState(i,!1),(0,Qo.allowSavingDefaults)(!1)}}const Zn=new c.TranslatedString("change resolution",n.t(null,void 0,i(932829)))
;class Yn extends Wr{constructor(e,t,i){super(Zn,e,function(e,t){let i;const s=(0,we.isRangeStyle)(e.style()),o=js.Interval.isRange(t);return!s&&o?i=11:s&&!o&&(i=(0,we.getLastUsedStyle)()),{interval:t,style:i}}(e,t),i),this._resolution=t}canMerge(e){return e instanceof Yn&&e._resolution===this._resolution&&super.canMerge(e)}_showFade(e,t){return!0}}var $n=i(109117);class Xn extends $n.SetWatchedValueCommand{constructor(){super(...arguments),this._firstRedo=!0}redo(){this._firstRedo||(0,a.muteLinkingGroup)(this._newValue,!0),(0,a.muteLinkingGroup)(this._oldValue,!0),super.redo(),this._firstRedo||(0,a.muteLinkingGroup)(this._newValue,!1),(0,a.muteLinkingGroup)(this._oldValue,!1),this._firstRedo=!1}undo(){(0,a.muteLinkingGroup)(this._newValue,!0),(0,a.muteLinkingGroup)(this._oldValue,!0),super.undo(),(0,a.muteLinkingGroup)(this._newValue,!1),(0,a.muteLinkingGroup)(this._oldValue,!1)}}var Jn=i(348065),Qn=i(850986);class ea extends _.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._stubDescriptor=(0,s.ensureNotNull)(t.getDescriptor())}redo(){this._chartModel.dataSourceForId(this._stubDescriptor.id)||this._chartModel.restoreStudyStub(this._stubDescriptor)}undo(){this._chartModel.removeStudyStub(this._stubDescriptor.id)}}class ta extends _.UndoCommand{constructor(e,t,i){super(i,void 0,!co.lineToolsDoNotAffectChartInvalidation),this._source=e,this._newState=t,this._oldState=e.properties().state()}redo(){this._source.applyTemplate(this._newState)}undo(){this._source.applyTemplate(this._oldState)}}var ia=i(496416),sa=i(590250),oa=i(220003),ra=i(875678),na=i(235853),aa=i(836861),la=i(373313),ca=i(893556),da=i(376036),ha=i(79908),ua=i(995152),pa=i(84281),_a=i(344158);const ma=new c.TranslatedString("apply all chart properties",n.t(null,void 0,i(299551)));class ga extends _.UndoCommand{constructor(e){super(ma),this._trading=null,this._oldShowSellBuyButtons=null,this._oldNoConfirmEnabled=null,this._oldShowOnlyRejectionNotifications=null,this._oldShowPricesWithZeroVolume=null,this._oldShowPricesWithSpread=null,this._oldOrderExecutedSoundEnabled=null,this._prevWatermarkPreferences=null,this._prevAlertPreferences=null,this._model=e,this._trading=(0,pa.tradingService)(),null!==this._trading&&(this._oldShowSellBuyButtons=this._trading.showSellBuyButtons.value(),this._oldNoConfirmEnabled=this._trading.noConfirmEnabled.value(),this._oldShowOnlyRejectionNotifications=this._trading.showOnlyRejectionNotifications.value(),this._oldShowPricesWithZeroVolume=this._trading.showPricesWith().zeroVolume.value(),this._oldShowPricesWithSpread=this._trading.showPricesWith().spread.value(),this._oldOrderExecutedSoundEnabled=this._trading.orderExecutedSoundParams.enabled.value()),this._defaultsPreferences=(0,ia.defaultsPreferencesByWhiteList)(this._model,this._model.mainSeries()),this._oldPreferences=e.preferences(),this._prevDateFormat=sa.dateFormatProperty.value(),this._prevAlertPreferences=(0,ua.getSettingsProperty)().state(),this._model.onWidget()||(this._prevWithWeekday=ca.withWeekdayProperty.value()),
this._prevTimeHoursFormat=oa.timeHoursFormatProperty.value(),this._prevAddPlusButton=_a.addPlusButtonProperty.value(),this._prevShowOpenMarkerStatus=ra.showMarketOpenStatusProperty.value(),this._prevCurrencyUnitVisibility=(0,yi.currencyUnitVisibilityProperty)().value(),this._prevAutoLogButtonsVisibility=(0,Ci.autoLogButtonsVisibilityProperty)().value(),this._prevNavigationButtonsVisibility=(0,na.property)().value(),this._prevPaneButtonsVisibility=(0,aa.property)().value();const t=this._model.watermarkSource();null!==t&&(this._prevWatermarkPreferences=t.properties().state())}redo(){var e,t,i;null!==this._trading&&(this._trading.showSellBuyButtons.setValue(!0),this._trading.noConfirmEnabled.setValue(!1),this._trading.showOnlyRejectionNotifications.setValue(!1),this._trading.showPricesWith().zeroVolume.setValue(!0),this._trading.showPricesWith().spread.setValue(!0),this._trading.orderExecutedSoundParams.enabled.setValue(!1)),(0,Pr.default)(this._defaultsPreferences,{mainSeries:{volFootprintStyle:{bgColors:(0,ha.getBgColorsDefaults)()}}}),"Auto"===(null===(i=null===(t=null===(e=this._defaultsPreferences.mainSeries)||void 0===e?void 0:e.tpoStyle)||void 0===t?void 0:t.inputs)||void 0===i?void 0:i.rowSize)&&delete this._defaultsPreferences.mainSeries.tpoStyle.inputs.ticksPerRow,this._model.applyPreferences(this._defaultsPreferences),this._model.updateScales(),(0,sa.restoreDateFormatSettingsValue)(),(0,oa.restoreTimeHoursFormatSettingsValue)(),(0,_a.restoreAddPlusButtonSettingsValue)(),(0,ra.restoreShowMarketOpenStatusProperty)(),(0,yi.restoreCurrencyUnitVisibilitySettingsValue)(),(0,Ci.restoreAutoLogButtonsVisibilitySettingsValue)(),(0,na.restoreNavigationButtonsVisibilitySettingsValue)(),(0,aa.restorePaneButtonsVisibilitySettingsValue)(),(0,ca.restoreWithWeekdaySettingsValue)(),(0,da.restoreShowOnScreenshotSettingsValue)(),(0,la.restoreShowNewsNotificationSettingsValue)(),(0,ua.restoreSettingsProperty)();const s=this._model.watermarkSource();null!==s&&s.restorePropertiesDefaults()}undo(){null!==this._trading&&(this._trading.showSellBuyButtons.setValue((0,s.ensureNotNull)(this._oldShowSellBuyButtons)),this._trading.noConfirmEnabled.setValue((0,s.ensureNotNull)(this._oldNoConfirmEnabled)),this._trading.showOnlyRejectionNotifications.setValue((0,s.ensureNotNull)(this._oldShowOnlyRejectionNotifications)),this._trading.showPricesWith().zeroVolume.setValue((0,s.ensureNotNull)(this._oldShowPricesWithZeroVolume)),this._trading.showPricesWith().spread.setValue((0,s.ensureNotNull)(this._oldShowPricesWithSpread)),this._trading.orderExecutedSoundParams.enabled.setValue((0,s.ensureNotNull)(this._oldOrderExecutedSoundEnabled))),this._model.applyPreferences(this._oldPreferences),this._model.updateScales(),sa.dateFormatProperty.setValue(this._prevDateFormat),oa.timeHoursFormatProperty.setValue(this._prevTimeHoursFormat),ra.showMarketOpenStatusProperty.setValue(this._prevShowOpenMarkerStatus),_a.addPlusButtonProperty.setValue(this._prevAddPlusButton),(0,yi.currencyUnitVisibilityProperty)().setValue(this._prevCurrencyUnitVisibility),(0,
Ci.autoLogButtonsVisibilityProperty)().setValue(this._prevAutoLogButtonsVisibility),(0,na.property)().setValue(this._prevNavigationButtonsVisibility),(0,aa.property)().setValue(this._prevPaneButtonsVisibility),null!==this._prevAlertPreferences&&(0,ua.getSettingsProperty)().mergeAndFire(this._prevAlertPreferences),this._model.onWidget()||ca.withWeekdayProperty.setValue(this._prevWithWeekday);const e=this._model.watermarkSource();null!==e&&null!==this._prevWatermarkPreferences&&e.properties().mergeAndFire(this._prevWatermarkPreferences)}}class Sa extends _.UndoCommand{constructor(e,t,i,s){super(i),this._property=e,this._newValue=t,this._model=s,this._priceScale=this._model.mainSeries().priceScale(),this._oldValue=this._property.value(),this._oldMode=this._priceScale.mode()}redo(){this._oldValue=this._property.value(),this._oldMode=this._priceScale.mode(),(0,Qo.allowSavingDefaults)(!0),this._priceScale.setMode({autoScale:!1,percentage:!1,log:!1}),this._property.setValue(this._newValue),(0,Qo.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,hs.viewportChangeEvent)()),this._model.lightUpdate()}undo(){(0,Qo.allowSavingDefaults)(!0),this._property.setValue(this._oldValue),this._priceScale.setMode(this._oldMode),(0,Qo.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,hs.viewportChangeEvent)()),this._model.lightUpdate()}}var va=i(116193);class fa extends _.UndoCommand{constructor(e,t){var o,r;super(new c.TranslatedString("apply all chart properties",n.t(null,void 0,i(299551)))),this._model=e,this._newProperties=t,o=(0,s.ensureDefined)(this._newProperties.mainSeries),r=(0,s.ensureDefined)(this._newProperties.paneProperties),["candleStyle","hollowCandleStyle","haStyle"].forEach((e=>{const t=o[e];void 0!==t&&(t.wickUpColor=t.wickUpColor||t.wickColor,t.wickDownColor=t.wickDownColor||t.wickColor)})),r.vertGridProperties=r.vertGridProperties||(0,va.default)(r.gridProperties),r.horzGridProperties=r.horzGridProperties||(0,va.default)(r.gridProperties),void 0===o.hollowCandleStyle&&(o.hollowCandleStyle=(0,va.default)(o.candleStyle)),this._oldProperties=(0,ia.preferencesByWhiteList)(e,e.mainSeries())}redo(){this._merge(this._newProperties),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales()}undo(){this._merge(this._oldProperties),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales()}_merge(e){(0,Qo.allowSavingDefaults)(!0),this._model.applyPreferences(e),(0,Qo.allowSavingDefaults)(!1)}}var ba=i(128011);class ya{constructor(e){this._leftScales=e.leftPriceScales().map((e=>e.id())),this._rightScales=e.rightPriceScales().map((e=>e.id()))}restorePane(e){this._leftScales.reverse().map((t=>(0,s.ensureNotNull)(e.getPriceScaleById(t)))).forEach((t=>e.movePriceScale(t,"left"))),this._rightScales.reverse().map((t=>(0,s.ensureNotNull)(e.getPriceScaleById(t)))).forEach((t=>e.movePriceScale(t,"right")))}}class Ca extends _.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._targetStrategy=(0,ba.createPriceScaleSelectionStrategy)(t),
this._initialState=e.panes().map((e=>new ya(e)))}redo(){this._chartModel.panes().forEach((e=>e.setPriceScaleSelectionStrategy(this._targetStrategy))),this._chartModel.fullUpdate()}undo(){const e=this._chartModel.panes();for(let t=0;t<e.length;t++)this._initialState[t].restorePane(e[t]);this._chartModel.fullUpdate()}}
const wa=new c.TranslatedString("send {title} backward",n.t(null,void 0,i(540962))),Ta=new c.TranslatedString("bring {title} forward",n.t(null,void 0,i(941966))),Pa=new c.TranslatedString("insert {title} after {target}",n.t(null,void 0,i(432960))),Ma=new c.TranslatedString("insert {title} before {target}",n.t(null,void 0,i(557106))),xa=new c.TranslatedString("cut {title}",n.t(null,void 0,i(411500))),Ia=new c.TranslatedString("cut sources",n.t(null,void 0,i(194227))),La=new c.TranslatedString("remove {title}",n.t(null,void 0,i(94543))),Aa=new c.TranslatedString("remove drawings group",n.t(null,void 0,i(501193))),ka=new c.TranslatedString("move scale",n.t(null,void 0,i(444854))),Ea=new c.TranslatedString("stop syncing line tool(s)",n.t(null,void 0,i(922))),Da=new c.TranslatedString("zoom out",n.t(null,void 0,i(673638))),Ba=new c.TranslatedString("zoom in",n.t(null,void 0,i(49856))),Na=new c.TranslatedString("move drawing(s)",n.t(null,void 0,i(752510))),Ra=new c.TranslatedString("load default drawing template",n.t(null,void 0,i(743364))),Oa=new c.TranslatedString("apply factory defaults to selected sources",n.t(null,void 0,i(727851))),Va=new c.TranslatedString("change currency",n.t(null,void 0,i(832302))),Wa=new c.TranslatedString("change unit",n.t(null,void 0,i(185975))),Fa=new c.TranslatedString("clone line tools",n.t(null,void 0,i(132943))),Ha=new c.TranslatedString("merge up",n.t(null,void 0,i(452458))),za=new c.TranslatedString("merge down",n.t(null,void 0,i(778055))),Ua=new c.TranslatedString("merge to pane",n.t(null,void 0,i(341866))),Ga=new c.TranslatedString("unmerge up",n.t(null,void 0,i(379443))),qa=new c.TranslatedString("unmerge down",n.t(null,void 0,i(246453))),ja=new c.TranslatedString("unmerge to new bottom pane",n.t(null,void 0,i(981576))),Ka=new c.TranslatedString("move {title} to new right scale",n.t(null,void 0,i(177482))),Za=new c.TranslatedString("move {title} to new left scale",n.t(null,void 0,i(158228))),Ya=new c.TranslatedString("make {title} no scale (Full screen)",n.t(null,void 0,i(910625))),$a=new c.TranslatedString("scroll time",n.t(null,void 0,i(787840))),Xa=new c.TranslatedString("scale time",n.t(null,void 0,i(470771))),Ja=new c.TranslatedString("reset time scale",n.t(null,void 0,i(17336))),Qa=new c.TranslatedString("reset scales",n.t(null,void 0,i(703323))),el=new c.TranslatedString("create {tool}",n.t(null,void 0,i(12898))),tl=new c.TranslatedString("change {pointIndex} point",n.t(null,void 0,i(763058))),il=new c.TranslatedString("paste {title}",n.t(null,void 0,i(657010))),sl=new c.TranslatedString("insert {title}",n.t(null,void 0,i(848818))),ol=new c.TranslatedString("remove pane",n.t(null,void 0,i(693333))),rl=new c.TranslatedString("invert scale",n.t(null,void 0,i(6830))),nl=new c.TranslatedString("toggle auto scale",n.t(null,void 0,i(642240))),al=new c.TranslatedString("toggle lock scale",n.t(null,void 0,i(949695))),ll=new c.TranslatedString("toggle regular scale",n.t(null,void 0,i(680688))),cl=new c.TranslatedString("toggle indexed to 100 scale",n.t(null,void 0,i(824736))),dl=new c.TranslatedString("toggle percentage scale",n.t(null,void 0,i(398994))),hl=new c.TranslatedString("toggle log scale",n.t(null,void 0,i(149403))),ul=new c.TranslatedString("move left",n.t(null,void 0,i(179209))),pl=new c.TranslatedString("move right",n.t(null,void 0,i(360114))),_l=new c.TranslatedString("align to 45 degrees",n.t(null,void 0,i(4128))),ml=new c.TranslatedString("set price scale selection strategy to {title}",n.t(null,void 0,i(782241))),gl=new c.TranslatedString("remove all studies",n.t(null,void 0,i(643172))),Sl=new c.TranslatedString("remove drawings",n.t(null,void 0,i(530538))),vl=new c.TranslatedString("remove all studies and drawing tools",n.t(null,void 0,i(556253))),fl=new c.TranslatedString("turn line tools sharing off",n.t(null,void 0,i(508040))),bl=new c.TranslatedString("share line tools in layout",n.t(null,void 0,i(90221))),yl=new c.TranslatedString("share line tools globally",n.t(null,void 0,i(263934))),Cl=new c.TranslatedString("change linking group",n.t(null,void 0,i(688849))),wl=(0,
r.getLogger)("Chart.ChartUndoModel"),Tl=(0,he.isFeatureEnabled)("hide_tweet_drawingtool");function Pl(e,t){return{bringForwardEnabled:e.bringForwardEnabled||t.bringForwardEnabled,bringToFrontEnabled:e.bringToFrontEnabled||t.bringToFrontEnabled,sendBackwardEnabled:e.sendBackwardEnabled||t.sendBackwardEnabled,sendToBackEnabled:e.sendToBackEnabled||t.sendToBackEnabled}}function Ml(){return(0,Yt.drawOnAllCharts)().value()?1===(0,Yt.drawOnAllChartsMode)().value()?1:2:0}function xl(e,t){(0,l.onWidget)()?(0,to.showGoToTradingViewReferralDialog)({feature:"indicators"}):oo(e,t)}class Il extends(zs()){constructor(e,t,i,s,o,r,n,a,l,c,d){super(),this._createLineCommand=null,this._initialTimeScrollState=null,this._initialTimeScrollPos=null,this._initialTimeScaleState=null,this._scalePriceInfo=null,this._currentSourceMoveCommand=null,this._currentLineChangeCommand=null,this._currentCustomMoveCommand=null,this._zoomStack=new Zs.UndoStack,this._initialPriceScrollState=null,this._initialPriceScrollPos=null,this._chartWidget=o,this.m_model=new(Xr())(e,t,i,s,this,n,a,l,c,d),this._undoHistory=r,this._lineToolsGroupController=new Tr({model:this._model.bind(this),pushUndoCommand:this._pushUndoCommand.bind(this),beginUndoMacro:e=>{this._undoHistory.beginUndoMacro(e)},endUndoMacro:this._undoHistory.endUndoMacro.bind(this._undoHistory),emitEvent:this.emitEvent.bind(this)})}id(){return this._model().id()}undoHistory(){return this._undoHistory}setWatchedValue(e,t,i){this._undoHistory.setWatchedValue(e,t,i)}lineToolsGroupController(){return this._lineToolsGroupController}mergeAllScales(e){!function(e,t){e.beginUndoMacro("left"===t?ro:no),e.model().panes().forEach((i=>{const s="left"===t?i.rightPriceScales():i.leftPriceScales(),o=("left"===t?i.leftPriceScales():i.rightPriceScales()).concat(s),r="overlay"===i.priceScalePosition(i.defaultPriceScale())?o[0]:i.defaultPriceScale();e.movePriceScale(i,r,t,0),o.forEach((t=>{if(t===r)return;let s=t.mainSource();for(;null!==s;){e.moveToScale(s,i,r,null,!0);const o=t.mainSource();if(o===s){ao.logError("Loop detected while trying to merge scales");break}s=o}}))})),e.endUndoMacro(),e.model().fullUpdate()}(this,e)}movePriceScale(e,t,i,s){const o=new lo(this._model(),e,t,i,s,ka);this._pushUndoCommand(o)}createLineTool({pane:e,point:t,linetool:i,properties:o,linkKey:r,ownerSource:n,disableSynchronization:a,sharingMode:l=Ml(),id:d}){const h=Qn.lineToolsStudyIds[i];if((0,s.assert)(!(0,U.isStudyLineToolName)(h)||!!h),h){const e=this.canCreateStudy({id:h});if(!e.success)return xl(this.model(),e),(0,U.isStudyLineToolName)(Yt.tool.value())&&(0,Yt.resetToCursor)(),null}const u=el.format({tool:new c.TranslatedString(i,Po.lineToolsLocalizedNames[i])});this.beginUndoMacro(u);const p=!a;this._createLineCommand=new xo({model:this._model(),pane:e,lineTool:i,ownerSource:n||(0,s.ensureNotNull)(e.mainDataSource()),drawOnAllChartsMode:l,id:d});const _=this._createLineCommand.startCreatingLine(t,o,r||null,l,a),m=(0,s.ensureNotNull)(this._createLineCommand.line());let g=null;if(_&&(p&&this.finishLineTool(m),
this._pushUndoCommand(this._createLineCommand),this._createLineCommand=null,g={points:m.normalizedPoints(),interval:this.mainSeries().interval()}),p&&void 0===r&&(0,Yt.drawOnAllCharts)().value()&&m.isSynchronizable()){const e=(0,s.ensureNotNull)(this.model().externalTimeStamp(t.index)),o={point:{price:t.price,timeStamp:e},linetool:i,properties:m.properties(),symbol:this.mainSeries().symbol(),model:this.model(),linkKey:(0,s.ensureNotNull)(m.linkKey().value()),finalState:g,id:m.id(),sharingMode:m.sharingMode().value()};m.isFixed()&&(o.pointPositionPercents=m.calcPositionPercents()),(0,Yt.createLineTool)(o)}return this.endUndoMacro(),m}continueCreatingLine(e,t,i,o){const r=(0,s.ensureNotNull)(this._createLineCommand);this.beginUndoMacro(r.text());const n=(0,s.ensureNotNull)(this._model().lineBeingCreated()),a=r.continueCreatingLine(e,t,i,o);let l=null;if(a&&(this.finishLineTool(n),this._pushUndoCommand(r),this._createLineCommand=null,l={points:n.normalizedPoints(),interval:this.mainSeries().interval()}),r.drawOnAllCharts()&&n.isSynchronizable()){const i=(0,s.ensureNotNull)(this._model().externalTimeStamp(e.index));(0,Yt.continueLineTool)({point:{price:e.price,timeStamp:i},envState:t,finalState:l,model:this._model()})}return this.endUndoMacro(),a}continueExternalLine(e,t,i){const o=(0,s.ensureNotNull)(this._createLineCommand),r=o.continueCreatingLine(e,t,i);return r&&(this._pushUndoCommand(o),this._createLineCommand=null),r}finishLineTool(e){this._model().finishLineTool(e)}cancelCreatingLine(){this.m_model.cancelCreatingLine()}lineBeingCreated(){return this.m_model.lineBeingCreated()}pasteImageAsLineTool(e,t,i,o){const r=this._model().timeScale(),n=r.width(),a=i.height(),l=i.defaultPriceScale(),d=(0,s.ensureNotNull)((0,s.ensureNotNull)(l.mainSource()).firstValue()),h={price:l.coordinateToPrice(a/2,d),index:r.coordinateToIndex(n/2)},u=(0,ut.createLineToolProperties)("LineToolImage",void 0,this.model());void 0!==o&&u.childs().transparency.setValue(o);const p=(0,s.ensureNotNull)(l.mainSource());(0,ut.prepareLineToolPropertiesByOwnerSource)(u,p);const _=this.createLineTool({pane:i,point:h,linetool:"LineToolImage",properties:u});return _&&(_.setBlobImageUrl(t),this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(_,null)})),e.then((e=>{_.properties().childs().url.setValue(e)})).catch((e=>{const t=_.linkKey().value(),i=this.model();null!==t&&(0,Yt.removeLineTool)({withUndo:!1,model:i,linkKey:t,symbol:_.symbol(),sourceTitle:new c.TranslatedString(_.name(),_.translatedType()),lineToolState:_.state(!1)}),i.removeSource(_)}))),_}loadRange(e){const t=this._model(),i=t.appliedTimeFrame().value();return(null===i||!Ks(i,e))&&(this._pushUndoCommand(new ar(t,e)),!0)}mainSeries(){return this.m_model.mainSeries()}model(){return this.m_model}publishedChartsTimelineSource(){return this.m_model.publishedChartsTimelineSource()}unlinkLines(e){const t=this.model();this.beginUndoMacro(Ea);for(const i of e)null!==i.linkKey().value()&&(0,Yt.removeLineTool)({withUndo:!0,model:this.model(),symbol:i.symbol(),linkKey:(0,
s.ensureNotNull)(i.linkKey().value()),sourceTitle:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,i),lineToolState:i.state(!1),unlink:!0}),this._pushUndoCommand(new un(t,i));this.endUndoMacro()}zoomFromViewport(){const e=new dn((0,s.ensureDefined)(this._zoomStack.head()),this._zoomStack,!1);this._pushUndoCommand(e)}zoomToViewport(e,t,i,s,o){const r=new an(this.m_model,e,t,i,s,o),n=new dn(r,this._zoomStack,!0);this._pushUndoCommand(n)}zoomStack(){return this._zoomStack}timeScale(){return this.m_model.timeScale()}selection(){return this.m_model.selection()}selectionMacro(e,t){return this.m_model.selectionMacro(e,t)}onSelectedSourceChanged(){return this.m_model.onSelectedSourceChanged()}onTagsChanged(){return this.m_model.onTagsChanged()}lineCancelled(){return this.m_model.lineCancelled()}hoveredSource(){return this.m_model.hoveredSource()}crossHairSource(){return this.m_model.crossHairSource()}activeStrategySource(){return this.m_model.activeStrategySource()}setProperty(e,t,i,s){if(e&&e.value()!==t){this.beginUndoMacro(i);const o=new or(e,t,i,this.m_model,!s);this._pushUndoCommand(o),this.endUndoMacro(),this.emitEvent("setProperty")}}setProperties(e,t,i,s=!0){this.beginUndoMacro(i),this.m_model.selectionMacro((()=>{for(let o=0;o<e.length;o++)this.setProperty(e[o],t[o],i,!s)})),this.endUndoMacro()}beginUndoMacro(e){return this._undoHistory.beginUndoMacro(e)}endUndoMacro(){this._undoHistory.endUndoMacro()}invertPriceScale(e){const t=e.properties().childs().isInverted;this.setProperty(t,!t.value(),rl)}togglePriceScaleAutoScaleMode(e){const t={autoScale:!e.isAutoScale()};this.setPriceScaleMode(t,e,nl)}togglePriceScaleLockScaleMode(e){const t={lockScale:!e.isLockScale()};this.setPriceScaleMode(t,e,al)}togglePriceScalePercentageScaleMode(e){const t={percentage:!e.isPercentage()};this.setPriceScaleMode(t,e,dl)}togglePriceScaleIndexedTo100ScaleMode(e){const t={indexedTo100:!e.isIndexedTo100()};this.setPriceScaleMode(t,e,cl)}togglePriceScaleLogScaleMode(e){const t={log:!e.isLog()};this.setPriceScaleMode(t,e,hl)}setPriceScaleRegularScaleMode(e){this.setPriceScaleMode({log:!1,percentage:!1,indexedTo100:!1},e,ll)}withMacro(e,t){const i=this.beginUndoMacro(e);try{t()}finally{this.endUndoMacro()}return i}dataSources(){return this.m_model.dataSources()}orderedDataSources(e){return this.m_model.orderedDataSources(e)}barsMarksSources(){return this.m_model.barsMarksSources()}removeAllDrawingTools(){this.beginUndoMacro(Sl),this._removeAllDrawingToolsImpl(),this.endUndoMacro()}removeAllStudiesAndDrawingTools(){this.beginUndoMacro(vl),this._removeAllDrawingToolsImpl(),this._removeAllStudiesImpl(),this.endUndoMacro()}removeAllStudies(){this.beginUndoMacro(gl),this._removeAllStudiesImpl(),this.endUndoMacro()}scrollChartByBar(e){if(!this.m_model.scrollEnabled())return;const t=e*this.m_model.timeScale().barSpacing();this.startScrollTime(0),this.scrollTimeTo(t),this.endScrollTime()}canZoomIn(){return this.model().canZoomIn()}canZoomOut(){return this.model().canZoomOut()}zoomOut(){const e=this.timeScale().width()
;this.canZoomOut()&&(this.changeTimeScale(Da),(0,Xs.doAnimate)({to:e/5,onStep:e=>{this.startScaleTime(0),this.scaleTimeTo(e),this.endScaleTime()}}))}zoomIn(){const e=this.timeScale().width();this.canZoomIn()&&(this.changeTimeScale(Ba),(0,Xs.doAnimate)({to:e/5,onStep:e=>{this.startScaleTime(e),this.scaleTimeTo(0),this.endScaleTime()}}))}scrollChart(e){this.m_model.scrollEnabled()&&(this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime())}startMovingSources(e,t,i,s){e.filter((e=>e.doesMovingAffectsUndo())).length&&(this._currentSourceMoveCommand=new mo(this.model(),e,Na,!1)),this.model().startMovingSources(e,t,i,new Map,s)}moveSources(e,t){this.model().moveSources(e,new Map,t)}endMovingSource(e,t){this.model().endMovingSources(e,void 0,t),null!==this._currentSourceMoveCommand&&(this._currentSourceMoveCommand.saveNewState(),this._pushUndoCommand(this._currentSourceMoveCommand)),this._currentSourceMoveCommand=null}startChangingLinetool(e,t,i,s,o){this._currentLineChangeCommand=new mo(this.model(),[e],tl.format({pointIndex:i}),!1),this.model().startChangingLinetool(e,t,i,s,o)}changeLinePoint(e,t){this.model().changeLinePoint(e,t)}alignToolTo45Degrees(e){const t=e.alignTo45DegreesPoints();t&&(this._pushUndoCommand(new mo(this.model(),[e],_l,!1)),this.model().alignTo45Degrees(e,t))}endChangingLinetool(e){this.model().endChangingLinetool(e),null!==this._currentLineChangeCommand&&(this._currentLineChangeCommand.saveNewState(),this._pushUndoCommand(this._currentLineChangeCommand)),this._currentLineChangeCommand=null}setChartStyleProperty(e,t,i){if(e.value()!==t){const s=on.chartStylePermissions.get(t),o=()=>{this.beginUndoMacro(i);const s=new rr(e,t,this.mainSeries(),i,this.model(),this._chartWidget);var o;this._pushUndoCommand(s),this.emitEvent("setChartStyleProperty"),o=e.value(),(0,ts.getTracker)().then((e=>{if(null!==e){const t=Dt.STYLE_SHORT_NAMES[o];e.trackChartStyle(t)}})),this.endUndoMacro()};s?(0,rn.runOrGoPro)(o,s.feature,{feature:s.featureName}):o()}}setPriceAutoScale(e,t,i){this._pushUndoCommand(new Yi(this.m_model,e,t,t.state())),this.m_model.setPriceAutoScale(e,t,i)}setPriceScaleMode(e,t,i){if(!(0,Ut.default)(t.mode(),e)){const s=new Yr(e,t,i,this.m_model);this._pushUndoCommand(s)}}setPriceScaleSelectionStrategy(e){if(this.m_model.properties().priceScaleSelectionStrategyName.value()===e)return;(0,Ne.trackEvent)("Chart","Change PriceScale Selection Strategy");const t=ml.format({title:e});this.beginUndoMacro(t),this.setProperty(this.m_model.properties().priceScaleSelectionStrategyName,e,t);const i=new Ca(this.m_model,e,t);this._pushUndoCommand(i),this.endUndoMacro()}setScaleRatioProperty(e,t,i){if(e.value()!==t){const s=new Sa(e,t,i,this.m_model);this._pushUndoCommand(s)}}createUndoCheckpoint(){return this._undoHistory.createUndoCheckpoint()}undoToCheckpoint(e){this._undoHistory.undoToCheckpoint(e)}restorePropertiesForSource(e){(0,ut.isLineTool)(e)?this._restoreLineToolFactoryDefaults(e):this._restoreStudyFactoryDefaults(e)}restoreLineToolsFactoryDefaults(e){
1===e.length?this._restoreLineToolFactoryDefaults(e[0]):(this.beginUndoMacro(Oa),e.forEach((e=>this._restoreLineToolFactoryDefaults(e))),this.endUndoMacro())}restorePreferences(){const e=new ga(this.model());this._pushUndoCommand(e)}restoreState(e,t,i){return this.m_model.restoreState(e,t,i)}async clipboardCopy(e,t=this.selection().dataSources()){if(!(0,d.enabled)("datasource_copypaste"))return;const i=t.filter((e=>e.copiable()));if(0===i.length)return;for(const e of i)if((0,ct.isStudy)(e)&&e.isChildStudy())throw new Error("Can not copy child study");const s=(0,$s.clipboardDataForSources)(this._model().id(),i);return null!==s?e.write({app:JSON.stringify(s),text:s.title}):void 0}async clipboardCut(e,t=this.selection().dataSources()){if(!(0,d.enabled)("datasource_copypaste"))return;const i=t.filter((e=>e.copiable()));if(0===i.length)return;await this.clipboardCopy(e,i);const s=i.filter((e=>e.isUserDeletable()));if(0===s.length)return;const o=(1===s.length?xa:Ia).format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,s[0])});this.beginUndoMacro(o),this.m_model.selectionMacro((()=>this.removeSources(s,!1,o)),!0),this.endUndoMacro()}async clipboardPaste(e,t){let i=null;if((0,d.enabled)("datasource_copypaste")&&(i=i||await e.read(),i.app)){const e=JSON.parse(i.app);if(null!==await this.pasteSourceFromClip(t,e))return}await this._processSpecialLineToolsContents(e,i,t)}applyStudyTemplate(e,t){const i=new kr(this._model(),e,t);this._pushUndoCommand(i),(0,Le.emit)("load_study_template")}createStudyInserter(e,t,i={}){const{stubTitle:s,isOverlay:o}=i,r={createStudy:(e,t,i,s,o,r,n,a,l,c,d,h)=>{if(!this.checkIfFeatureAvailable(e,n))return wl.logNormal("Cannot insert study "+e.id),null;(0,Ne.trackEvent)("studies","Study_"+e.id),"Compare@tv-basicstudies"===e.id&&(0,Ne.trackEvent)("compare","symbol:"+t.symbol),s&&this.m_model.removeSource(s);const u=this._insertStudy(e,t,o,r,n,a,l,c,d,null,h);return u.study.then((e=>(0,Le.emit)("study_event",e.id(),"create"))),u},storeFailedStub:e=>{this._storeFailedStub(e)}};void 0!==s&&(r.createStub=()=>this.m_model.insertStudyStub(s,o).id(),r.removeStub=e=>this.m_model.removeStudyStub(e));const n=new Jn.StudyInserter(e,r);return n.setParentSources(t),n}applyLineToolTemplate(e,t,i){this.beginUndoMacro(i),this.saveLineToolState(e,i);const s=new ta(e,t,i);this._pushUndoCommand(s),this.saveLineToolState(e,i),this.endUndoMacro(),this.model().updateSource(e)}replayStatus(){return this.m_model.replayStatus()}setReplayStatus(e){return this.m_model.setReplayStatus(e)}isInReplay(){return this.m_model.isInReplay()}getSymbolString(){return this.m_model.getSymbolString()}interval(){return this.m_model.interval()}onInReplayStateChanged(){return this.m_model.onInReplayStateChanged()}switchToReplay(e,t){this._undoHistory.clearStack(),this.m_model.switchToReplay(e,t)}switchToRealtime(){this._undoHistory.clearStack(),this.m_model.switchToRealtime()}canChangeResolution(e){return this.model().canChangeResolution(e)}canChangeSymbol(e){return this.model().canChangeSymbol(e)}
startCustomMoving(e,t,i){this._currentCustomMoveCommand=new Kr(this.model(),e,t,i)}customMoveBeingProcessed(){return null!==this._currentCustomMoveCommand}processCustomMove(e){(0,s.ensureNotNull)(this._currentCustomMoveCommand).move(e)}endCustomMoving(){null!==this._currentCustomMoveCommand&&this._currentCustomMoveCommand.hasChanges()&&(this._pushUndoCommand(this._currentCustomMoveCommand),this._currentCustomMoveCommand=null)}state(e,t,i,s){return this.m_model.state(e,t,i,s)}panes(){return this.m_model.panes()}cloneLineTools(e,t){for(let t=0;t<Math.min(5,e.length);++t)is(e[t],"clone");this.beginUndoMacro(Fa);const i=new ho(this._model(),e,t,Fa);this._pushUndoCommand(i);const o=i.newIds().map((e=>(0,s.ensureNotNull)(this.model().dataSourceForId(e)))).filter((e=>0!==e.sharingMode().value()));return o.length&&this._model().copyToOtherCharts(o,!0),this.endUndoMacro(),this.emitEvent("cloneLineTools"),i.newIds()}removeSource(e,t,i){this.lineBeingCreated()!==e?this.removeSources([e],t,La.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e)}),i):this.cancelCreatingLine()}removeSelectedSources(){const e=this._model().selection().dataSources();if(!e.length)return;const t=(e.length>1?Aa:La).format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e[0])});this.removeSources(e,!1,t)}removeSources(e,t,i,o){o||(e=e.filter((e=>e.isUserDeletable())));const r=this._model(),n=r.lineToolsGroupModel();this.beginUndoMacro(i),r.selectionMacro((o=>{const a=new Map;e.forEach((e=>{if((0,ut.isLineTool)(e)){const t=n.groupForLineTool(e);if(null!==t){const i=a.get(t)||[];i.push(e),a.set(t,i)}null!==e.linkKey().value()&&(0,Yt.removeLineTool)({withUndo:!0,model:this.model(),linkKey:(0,s.ensureNotNull)(e.linkKey().value()),symbol:this.model().mainSeries().symbol(),lineToolState:e.state(!1),sourceTitle:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e)})}}));const l=new uo.RemoveSourcesUndoCommand(r,e,i),c=l.removedIds();this._pushUndoCommand(l),!t&&c.length>0&&(1===c.length?this.emitEvent("removeSource",[c[0]]):this.emitEvent("removeSources",[c]))}),!0),this.endUndoMacro()}async scrollToLineTool(e){const t=this.timeScale().logicalRange();if(null===t)return;const i=e.points().map((e=>e.index)),o=this.timeScale().points().range().value();if(null===o)return;let r=o.firstIndex;const n=o.lastIndex,a=t.length()/2;if(0===i.length||i.some((e=>t.contains(e))))return;const l=()=>{const t=e.points().map((e=>e.index)),i=t.filter((e=>e<=n)).reduce(((e,t)=>null===e?t:Math.max(e,t)),null);return null!==i?i:t.reduce(((e,t)=>Math.min(e,t)))};let c=l();if(r-a>c){const t=e.points().map((e=>e.time)).filter(je.notUndefined).map((e=>1e3*e));if(0===t.length)return;const i=t.reduce(((e,t)=>Math.min(e,t)),t[0]);await this.model().gotoTime(i),c=l();if((0,s.ensureNotNull)(this.timeScale().logicalRange()).contains(c))return;r=(0,s.ensureNotNull)(this.timeScale().points().range().value()).firstIndex}r-a>c&&this.mainSeries().setGotoDateResult({timestamp:(0,
s.ensureNotNull)(this.timeScale().points().valueAt(r)),eod:!0});const d=this.timeScale().width()/2,h=this.timeScale().indexToCoordinate(c);this.model().stopTimeScaleAnimation(),this.model().setTimeScaleAnimation(new Ys.Animation({from:0,to:d-h,duration:Us.dur,easing:Us.easingFunc.easeInOutCubic}))}mergeSourceUp(e){const t=new yo.MergeUpUndoCommand(this._model(),e,Ha);this._mergeUnmergeSource(e,t)}mergeSourceDown(e){const t=new yo.MergeDownUndoCommand(this._model(),e,za);this._mergeUnmergeSource(e,t)}mergeToPane(e,t,i){const s=this._model().panes().indexOf(t),o=new yo.MergeToTargetPane(this._model(),e,s,Ua,i);this._mergeUnmergeSource(e,o)}unmergeSourceUp(e){const t=new fo(this._model(),e,Ga);this._mergeUnmergeSource(e,t)}unmergeSourceDown(e){const t=new vo(this._model(),e,qa);this._mergeUnmergeSource(e,t)}unmergeToNewBottomPane(e){const t=new bo(this._model(),e,ja);this._mergeUnmergeSource(e,t)}moveLeft(){this.beginUndoMacro(ul),(0,Xs.doAnimate)({to:this.m_model.timeScale().width()/5,onStep:e=>{this.startScrollTime(e),this.scrollTimeTo(0),this.endScrollTime()},onComplete:()=>{this.endUndoMacro()}})}moveRight(){this.beginUndoMacro(pl),(0,Xs.doAnimate)({to:this.m_model.timeScale().width()/5,onStep:e=>{this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime()},onComplete:()=>{this.endUndoMacro()}})}availableZOrderOperations(e){const t=this._model().lineToolsGroupModel(),i=e.filter(ut.isLineTool),o=i.map((e=>t.groupForLineTool(e)));(0,s.assert)(new Set(o).size<=1,"Cannot move line tools from different group");const r=0===o.length?null:o[0];let n={bringForwardEnabled:!1,bringToFrontEnabled:!1,sendBackwardEnabled:!1,sendToBackEnabled:!1};const a=new Set(i);for(const t of(0,Co.sortSources)(e)){if((0,ut.isLineTool)(t)&&null!==r){const e=(0,Co.sortSources)(r.lineTools().filter((e=>!a.has(e)||e===t)));n=Pl(n,{bringForwardEnabled:t!==e[e.length-1],bringToFrontEnabled:t!==e[e.length-1],sendBackwardEnabled:t!==e[0],sendToBackEnabled:t!==e[0]});continue}const e=(0,s.ensureNotNull)(this._model().paneForSource(t)).sourcesByGroup().allExceptSpecialSources();if(0===e.length)continue;const i=t.zorder(),o=e[0].zorder(),l=e[e.length-1].zorder();n=Pl(n,{bringForwardEnabled:i!==l,bringToFrontEnabled:i!==l,sendBackwardEnabled:i!==o,sendToBackEnabled:i!==o})}return n}sendToBack(e){if(!this.availableZOrderOperations(e).sendToBackEnabled)throw new Error("Send to back operation is unavailable");let t=null;const i=e[0];if((0,ut.isLineTool)(i)){const s=this._model().lineToolsGroupModel().groupForLineTool(i);if(null!==s){const i=s.lineTools();t=new Uo(this.model(),(0,Co.sortSources)(e),i[0])}}null===t&&(t=new Wo(this.model(),(0,Co.sortSources)(e))),this._pushUndoCommand(t),this.emitEvent("changeZOrder",[e])}bringToFront(e){if(!this.availableZOrderOperations(e).bringToFrontEnabled)throw new Error("Bring to front operation is unavailable");let t=null;const i=e[0];if((0,ut.isLineTool)(i)){const s=this._model().lineToolsGroupModel().groupForLineTool(i);if(null!==s){const i=s.lineTools();t=new Ho(this.model(),(0,Co.sortSources)(e),i[i.length-1])
}}null===t&&(t=new Vo(this.model(),(0,Co.sortSources)(e))),this._pushUndoCommand(t),this.emitEvent("changeZOrder",[e])}sendBackward(e){if(!this.availableZOrderOperations(e).sendBackwardEnabled)throw new Error("Send backward operation is unavailable");const t=wa.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e[0])});this._sendBackOrBringForward(t,(0,Co.sortSources)(e),((e,t)=>new qo(this.model(),e,t)))}bringForward(e){if(!this.availableZOrderOperations(e).bringForwardEnabled)throw new Error("Bring forward operation is unavailable");const t=Ta.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e[0])});this._sendBackOrBringForward(t,(0,Co.sortSources)(e),((e,t)=>new Ko(this.model(),e,t)))}insertAfter(e,t){e=(0,Co.sortSources)(e);const i=Pa.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e[0]),target:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,t)});this._insertAfterOrBefore(i,e,t,(()=>new Ho(this.model(),e,t)))}insertBefore(e,t){e=(0,Co.sortSources)(e);const i=Ma.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e[0]),target:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,t)});this._insertAfterOrBefore(i,e,t,(()=>new Uo(this.model(),e,t)))}detachToRight(e,t){(0,Ne.trackEvent)("Chart","Move to new right scale");const i=Ka.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e)}),s=new Vr.MoveToNewPriceScaleUndoCommand(this.model(),e,t,"right",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}detachToLeft(e,t){(0,Ne.trackEvent)("Chart","Move to new left scale");const i=Za.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e)}),s=new Vr.MoveToNewPriceScaleUndoCommand(this.model(),e,t,"left",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}detachNoScale(e,t){(0,Ne.trackEvent)("Chart","Make source no scale");const i=Ya.format({title:(0,wo.getTranslatedStringForSource)(io.TitleDisplayTarget.StatusLine,e)}),s=new Vr.MoveToNewPriceScaleUndoCommand(this.model(),e,t,"overlay",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}moveToScale(e,t,i,s,o){(0,Ne.trackEvent)("Chart","Move source to target scale"),this.beginUndoMacro(s);const r=new Vr.MoveToExistingPriceScaleUndoCommand(this.model(),e,t,i,s),n=o?null:(0,Js.sourceNewCurrencyOnPinningToPriceScale)(e,i,this._model()),a=o?null:(0,Jr.sourceNewUnitOnPinningToPriceScale)(e,i,this._model());this._pushUndoCommand(r),null!==n&&this.setPriceScaleCurrency(i,n),null!==a&&this.setPriceScaleUnit(i,a),this.endUndoMacro(),this.emitEvent("moveSource",[e])}setLinkingGroupIndex(e){this._undoHistory.beginUndoMacro(Cl),this._pushUndoCommand(new Xn(this.model().linkingGroupIndex(),e,Cl)),this._model().setShouldBeSavedEvenIfHidden(!0),this._undoHistory.endUndoMacro()}startScrollPrice(e,t,i){t.isAutoScale()||(this._initialPriceScrollState=t.state(),this._initialPriceScrollPos=i,this._model().startScrollPrice(e,t,i))}
scrollPriceTo(e,t,i){t.isAutoScale()||(this._initialPriceScrollState&&this._initialPriceScrollPos&&Math.abs(this._initialPriceScrollPos-i)>20&&(this._pushUndoCommand(new Yi(this.m_model,e,t,this._initialPriceScrollState,void 0,!1)),this._initialPriceScrollState=null,this._initialPriceScrollPos=null),this._model().scrollPriceTo(e,t,i))}endScrollPrice(e,t){t.isAutoScale()||(this._initialPriceScrollState=null,this._initialPriceScrollPos=null,this._model().endScrollPrice(e,t))}startScrollTime(e){const t=this.timeScale();this._initialTimeScrollState={rightOffset:t.rightOffset(),barSpacing:t.barSpacing()},this._initialTimeScrollPos=e,this.model().startScrollTime(e)}scrollTimeTo(e){null!==this._initialTimeScrollPos&&null!==this._initialTimeScrollState&&Math.abs(e-this._initialTimeScrollPos)>20&&(this._pushUndoCommand(new ji(this.model(),this._initialTimeScrollState,$a,!1)),this._initialTimeScrollPos=null,this._initialTimeScrollState=null),this.model().scrollTimeTo(e)}endScrollTime(){this.model().endScrollTime(),this._initialTimeScrollPos=null,this._initialTimeScrollState=null}startScaleTime(e){const t=this.timeScale();this._initialTimeScaleState={rightOffset:t.rightOffset(),barSpacing:t.barSpacing()},this.model().startScaleTime(e)}scaleTimeTo(e){null!==this._initialTimeScaleState&&this._initialTimeScaleState.barSpacing!==this.timeScale().barSpacing()&&(this._pushUndoCommand(new ji(this.model(),this._initialTimeScaleState,Xa,!0)),this._initialTimeScaleState=null),this.model().scaleTimeTo(e)}endScaleTime(){this.model().endScaleTime()}resetTimeScale(){this.changeTimeScale(Ja,this.timeScale().resetAvailable().value()),this.model().resetTimeScale()}changeTimeScale(e,t=!0){const i=this.timeScale(),s={rightOffset:i.rightOffset(),barSpacing:i.barSpacing()};this._pushUndoCommand(new ji(this.model(),s,e,t))}startScalePrice(e,t,i,s){this._scalePriceInfo={priceScaleState:t.state(),tryMergeConsecutiveScales:s},this.model().startScalePrice(e,t,i)}scalePriceTo(e,t,i){this.model().scalePriceTo(e,t,i)}endScalePrice(e,t){this.model().endScalePrice(e,t);const i=(0,s.ensureNotNull)(this._scalePriceInfo);(0,Ut.default)(i.priceScaleState,t.state())||this._pushUndoCommand(new Yi(this.model(),e,t,i.priceScaleState,i.tryMergeConsecutiveScales)),this._scalePriceInfo=null}startTwoPointsScalePrice(e,t,i,s,o){this._scalePriceInfo={priceScaleState:t.state(),tryMergeConsecutiveScales:o},this.model().startTwoPointsScalePrice(e,t,i,s)}twoPointsScalePriceTo(e,t,i,s){this.model().twoPointsScalePriceTo(e,t,i,s)}endTwoPointsScalePrice(e,t){this.model().endTwoPointsScalePrice(e,t);const i=(0,s.ensureNotNull)(this._scalePriceInfo);(0,Ut.default)(i.priceScaleState,t.state())||this._pushUndoCommand(new Yi(this.model(),e,t,i.priceScaleState,i.tryMergeConsecutiveScales)),this._scalePriceInfo=null}resetPriceScale(e,t){const i=t.state();this.model().resetPriceScale(e,t),(0,Ut.default)(i,t.state())||this._pushUndoCommand(new Yi(this.m_model,e,t,i))}rearrangePanes(e,t){const i=new Jo(this._model(),e,t);this._pushUndoCommand(i)}movePane(e,t){
const i=new Jo(this._model(),e,t);this._pushUndoCommand(i)}toggleCollapsedPane(e){const t=this.panes().findIndex((t=>t===e));t<0||this._pushUndoCommand(new eo(this._model(),t))}readOnly(){return this.m_model.readOnly()}checkIfFeatureAvailable(e,t){const i=t.length>0,s=(0,sn.isFundamentalStudyMetaInfo)(e),o=this.canCreateStudy({id:e.id,child:i,fundamental:s});return!!o.success||(xl(this.model(),o),!1)}async pasteSourceFromClip(e,t,i){const o=t;if(!o||0===o.sources.length)return null;const r=e||(0,s.ensureNotNull)(this.model().paneForSource(this.mainSeries()));if(!o.sources.some((e=>"drawing"!==e.type||null!==r.clipboardLineToolOwnerSource(e.source.id))))return null;const n=Array.from(new Set(o.sources.filter($s.isLineToolClipboardData).map((e=>e.source.type))));await Promise.all(n.map((e=>(0,ut.initLineTool)(e)))),this.beginUndoMacro(il.format({title:o.title}));let a=0;const l=[],c=[];for(const t of o.sources)if("drawing"===t.type&&null!==r.clipboardLineToolOwnerSource(t.source.id)){const e=this.pasteLineTool(r,t);a<5&&(os(e),a+=1),c.push(e),l.push(e)}else"study"===t.type&&t.source&&t.source.metaInfo&&this.checkIfFeatureAvailable(new Gs.StudyMetaInfo(t.source.metaInfo),[])&&l.push(this.pasteStudy(t,i?e:void 0));return c.length&&this.selectionMacro((e=>{e.clearSelection(),c.forEach((t=>{e.addSourceToSelection(t,null)}))})),this.endUndoMacro(),l}pasteLineTool(e,t,i,s){t.source.state.intervalsVisibilities=(0,bn.mergeIntervalVisibilitiesDefaults)(t.source.state.intervalsVisibilities),(0,bn.makeIntervalsVisibilitiesVisibleAtInterval)(t.source.state.intervalsVisibilities,this.model().mainSeries().intervalObj());const o=new Nr(this.model(),t,e,i,s);this._pushUndoCommand(o);const r=o.source();return o.needCopyToOtherCharts()&&this._model().copyToOtherCharts([r],!0),this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(r,null)})),r}pasteStudy(e,t){const i=new Gr(this.model(),e,null==t?void 0:t.id());this._pushUndoCommand(i);const o=(0,s.ensureNotNull)(i.state()).id;return(0,Le.emit)("study_event",o,"paste_study"),(0,s.ensureNotNull)(this._model().dataSourceForId(o))}removePane(e){const t=this.m_model.panes()[e].dataSources().slice();this.removeSources(t,!1,ol)}createPane(e){return this.m_model.createPane(e)}setPriceScaleCurrency(e,t){const i=new Rr(this.m_model,e,t,Va);this._pushUndoCommand(i)}setPriceScaleUnit(e,t){const i=new Or(this.m_model,e,t,Wa);this._pushUndoCommand(i)}setSymbol(e,t){e.symbolSameAsResolved(t)||this._pushUndoCommand(new Hr(e,t,this._chartWidget))}setResolution(e,t){js.Interval.isEqual(e.interval(),t)||this._pushUndoCommand(new Yn(e,t,this._chartWidget))}hideMaximizedPaneIfRequired(){this._chartWidget.isMaximizedPane()&&this._chartWidget.toggleMaximizePane(null)}syncCrosshair(e,t,i){this._chartWidget.chartWidgetCollection().syncCrosshair(e,this._chartWidget.id(),t,i)}loadingScreen(){return this._chartWidget.screen}chartLoadTheme(e,t,i){const s=new Kn(this.model(),e,t);i?s.redo():this._pushUndoCommand(s)}isJustClonedChart(){return this._chartWidget.isJustClonedChart()}isMultipleLayout(){
return this._chartWidget.isMultipleLayout()}addPaneStretchFactorUndoCommand(e,t,i,s){const o=new qr(this.model(),e,t,i,s);this._pushUndoCommand(o)}applyPreferences(e){{const t=new fa(this.m_model,e);this._pushUndoCommand(t)}}paneForSource(e){return this.m_model.paneForSource(e)}destroy(){this.m_model.destroy()}moveSelectedToolsLeft(){return this._moveSelectedTools(2)}moveSelectedToolsUp(){return this._moveSelectedTools(0)}moveSelectedToolsRight(){return this._moveSelectedTools(3)}moveSelectedToolsDown(){return this._moveSelectedTools(1)}insertStudyWithoutCheck(e,t,i,s){return this._insertStudy(e,t,{},!1,[],void 0,void 0,void 0,void 0,null!=i?i:null,void 0,s)}saveLineToolState(e,t){this._pushUndoCommand(new mo(this.m_model,[e],t))}resetScales(){this._model().stopTimeScaleAnimation(),this.beginUndoMacro(Qa),this.resetTimeScale();for(const e of this.m_model.panes()){for(const t of e.leftPriceScales())this.resetPriceScale(e,t);for(const t of e.rightPriceScales())this.resetPriceScale(e,t)}this.endUndoMacro(),this.m_model.recalculateAllPanes((0,hs.viewportChangeEvent)())}shareLineTools(e,t){const i=0===t?fl:1===t?bl:yl;this.withMacro(i,(()=>{0===t&&this.unlinkLines(e),e.forEach((i=>{const s=this.model().lineToolsGroupModel().groupForLineTool(i);if(s){s.lineTools().every((t=>e.includes(t)))||this.lineToolsGroupController().excludeLineToolFromGroup(s,i)}this._pushUndoCommand(new mr(i,t,this.model(),null))}))}))}canCreateStudy(e,t){return this.model().chartApi().canCreateStudy(e,t)}chartWidgetCollectionLock(){return this._chartWidget.chartWidgetCollection().lock}onSymbolIntervalChanged(){return this.m_model.onSymbolIntervalChanged()}paneBeingCreatedLineOn(){return this.m_model.paneBeingCreatedLineOn()}invalidate(e){this.m_model.invalidate(e)}setWidth(e){this.m_model.setWidth(e)}setPaneHeight(e,t){this.m_model.setPaneHeight(e,t)}dataSourceForId(e){return this.m_model.dataSourceForId(e)}lineBeingEdited(){return this.m_model.lineBeingEdited()}sourcesBeingMoved(){return this.m_model.sourcesBeingMoved()}gridSource(){return this.m_model.gridSource()}watermarkSource(){return this.m_model.watermarkSource()}mainSeriesScaleRatioProperty(){return this.m_model.mainSeriesScaleRatioProperty()}setHoveredSource(e,t){this.m_model.setHoveredSource(e,t)}setCurrentPosition(e,t,i,s){this.m_model.setCurrentPosition(e,t,i,s)}setAndSaveCurrentPosition(e,t,i,s){this.m_model.setAndSaveCurrentPosition(e,t,i,s)}version(){return this.m_model.version()}restart(){this.m_model.restart()}disconnect(){this.m_model.disconnect()}calculateDefaultTags(){return this.m_model.calculateDefaultTags()}_model(){return this.m_model}_pushUndoCommand(e){this._undoHistory.pushUndoCommand(e)}_mergeUnmergeSource(e,t){this.beginUndoMacro(t.text());const i=(0,s.ensureNotNull)(this._model().paneForSource(e)),o=new Set(i.sourcesByGroup().lineSources().filter((t=>t.ownerSource()===e)));this._model().lineToolsGroupModel().groups().filter((e=>{const t=e.lineTools().some((e=>o.has(e))),i=e.lineTools().some((e=>!o.has(e)));return t&&i})).forEach((e=>{
this._pushUndoCommand(new po.ExcludeLineToolsFromGroupUndoCommand(this._model(),e,e.lineTools()))})),this._pushUndoCommand(t),this.endUndoMacro()}_insertStudy(e,t,i,s,o,r,n,a,l,c,d,h){const u=sl.format({title:e.description}),p=new Zr.InsertStudyCommand({chartModel:this.model(),studyMetaInfo:e,inputs:t,props:i,addAsOverlay:s,parentSources:o,preferredPriceScale:r,allowChangeCurrency:n,allowChangeUnit:a,paneSize:l,targetZOrder:null!=c?c:null,targetScaleMode:d,studyId:h,undoText:u});return this._pushUndoCommand(p),p.insertedStudy()}_storeFailedStub(e){const t=sl.format({title:e.title()});this.beginUndoMacro(t);const i=new ea(this.model(),e,t);this._pushUndoCommand(i),this.endUndoMacro()}async _processSpecialLineToolsContents(e,t,i){if(t=t||await e.read(),window.user.id&&t.files){const e=Array.from(t.files).find(Qi.blobImageFilter);if(e){const t=URL.createObjectURL(e),o=(0,Qi.uploadImage)(e);return void 0===i&&(i=(0,s.ensureNotNull)(this._model().paneForSource(this.mainSeries()))),this.pasteImageAsLineTool(o,t,i),void await o}}t.text&&(window.user.id&&!Tl&&(0,Qr.isTwitterUrl)(t.text)?(0,Qr.createTweetLineToolByUrl)(t.text,this,!0):window.user.id&&(0,tn.isIdeaUrl)(t.text)?(0,tn.createIdeaLineToolByUrl)(t.text,this,!0):function(e,t){if(null===t.timeScale().logicalRange())return null;const i=t.mainSeries(),o=i.priceScale(),r=t.timeScale(),n=(0,s.ensureNotNull)(t.model().paneForSource(i)),a=(0,s.ensureNotNull)((0,s.ensureNotNull)(o.mainSource()).firstValue()),l=r.coordinateToIndex(t.timeScale().width()/2),c=n.height()/2,d={price:o.coordinateToPrice(c,a),time_t:(0,s.ensureNotNull)(r.indexToTimePoint(l)),offset:0},h=n.newLineToolZOrder(!0),u=en.LineToolText.createProperties().state();u.text=e,u.interval=i.interval();const p={type:"drawing",source:{id:(0,xe.randomHashN)(6),zorder:h,type:"LineToolText",state:u,symbol:i.symbol(),ownerSource:i.id(),points:[d]},geometry:[],modelId:t.model().id(),centeredOnChart:!0},_=t.pasteLineTool(n,p,!1,!1);Be.setValue("hint.pasteText",!0,{forceFlush:!0})}(t.text,this))}_insertAfterOrBefore(e,t,i,o){const r=(0,s.ensureNotNull)(this._model().paneForSource(i));if(t.some((e=>(0,ut.isLineTool)(e)&&this._model().paneForSource(e)!==r)))throw new Error("Cannot insert line tool after target on another pane");this.beginUndoMacro(e),t.forEach((e=>{(0,s.ensureNotNull)(this.model().paneForSource(e))!==r&&this.mergeToPane(e,r)}));const n=o();this._pushUndoCommand(n),this.emitEvent("changeZOrder",[t]),this.endUndoMacro()}_sendBackOrBringForward(e,t,i){const o=new Map;t.forEach((e=>{const t=(0,s.ensureNotNull)(this._model().paneForSource(e)),i=o.get(t)||[];i.push(e),o.set(t,i)})),this.beginUndoMacro(e),o.forEach(((e,t)=>{this._pushUndoCommand(i(t,e))})),this.endUndoMacro(),this.emitEvent("changeZOrder",[t])}_moveSelectedTools(e){const t=this.model().selection().lineDataSources();if(0===t.length)return!1;if((0,Yt.lockDrawings)().value())return!0;const i=this.timeScale().visibleBarsStrictRange();if(null===i)return!1;const s=function(e){const t=new Map;for(const i of e){const e=i.ownerSource();if(null===e)continue
;let s=t.get(e);if(void 0===s){const o=e.priceScale(),r=e.priceStep(),n=e.firstValue();if(null===o||null===r||null===n)continue;if(null===o.priceRange())continue;s={sources:[],priceScale:o,priceStep:r,startPrice:i.points()[0].price,firstValue:n},t.set(e,s)}s.sources.push(i)}return t}(t);if(0===s.size)return!1;this.beginUndoMacro(Na);const r=i.firstBar(),n=this.timeScale().indexToCoordinate(r),a=r+(3===e?1:2===e?-1:0),l=this.timeScale().indexToCoordinate(a);return Yt.isDirectionalMovementActive.setValue(!0),s.forEach((t=>{const{startPrice:i,priceStep:s,priceScale:c,firstValue:d}=t,h=i+(0===e?s:1===e?-s:0),u=c.priceToCoordinate(i,d),p=c.priceToCoordinate(h,d),_={logical:{index:r,price:i},screen:new o.Point(n,u)},m={logical:{index:a,price:h},screen:new o.Point(l,p)};this.startMovingSources(t.sources,_,null),this.moveSources(m),this.endMovingSource(!1,!0)})),Yt.isDirectionalMovementActive.setValue(!1),this.endUndoMacro(),!0}_restoreStudyFactoryDefaults(e){const t=new fn(this.m_model,e);this._pushUndoCommand(t)}_restoreLineToolFactoryDefaults(e){this.beginUndoMacro(Ra),this.saveLineToolState(e,Ra);const t=new gn(this.m_model,e.properties(),Ra);this._pushUndoCommand(t),this.saveLineToolState(e,Ra),this.endUndoMacro(),this.model().updateSource(e)}_removeAllDrawingToolsImpl(e){this.selectionMacro((()=>{this.lineBeingCreated()&&this.cancelCreatingLine();this.dataSources().filter(ut.isLineTool).filter((e=>e.isActualSymbol()&&e.isUserDeletable())).filter((t=>!e||e===t.toolname)).forEach((e=>this.removeSource(e,!1)))}),!0)}_removeAllStudiesImpl(){const e=this.dataSources(),t=e.filter(ct.isStudy).filter((e=>!e.isChildStudy()&&e.removeByRemoveAllStudies())),i=e.filter(ct.isStudyStub);t.concat(i).forEach((e=>this.removeSource(e,!1)))}}var Ll=i(850723),Al=i(359663),kl=i(709404),El=i(79200);class Dl{constructor(){this._session={startDate:(new Date).toISOString(),url:window.location.href,entries:[]}}addPersistentLogEntry(e,t,i){this._session.entries.push({date:(new Date).toISOString(),level:t,message:e,category:i})}async getLastSessions(e){return[this._session]}pendingEntries(){return this._session.entries}}var Bl=i(927094),Nl=i(779923),Rl=i(525714),Ol=i(786559);const Vl=n.t(null,void 0,i(22112));function Wl(e){if("replaced_to_exchange"===e.type)return{text:Vl,warningIcon:Ol,warningType:"notaccurate",solutionId:Q.solutionIds.WHAT_IS_CBOE_BZX_EXCHANGE}}class Fl{constructor(e){this._activeHint=null,this._deferredPromise=null,this._chart=e;e.model().mainSeries().dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved)}destroy(){this._destroyActiveHint();this._chart.model().mainSeries().dataEvents().symbolResolved().unsubscribe(this,this._onSymbolResolved)}_destroyActiveHint(){null!==this._activeHint&&(this._activeHint.destroy(),this._activeHint=null),this._deferredPromise=null}async _createHint(){if(null===this._deferredPromise){const e=(0,We.createDeferredPromise)();this._deferredPromise=e,Promise.all([i.e(29328),i.e(44524),i.e(3062),i.e(2190),i.e(82321),i.e(83129)]).then(i.bind(i,629981)).then((t=>{
e.resolve(new t.ChartWarningHintRenderer(this._chart))}))}return this._deferredPromise.promise}_onSymbolResolved(e){const t=function(e){const t=(0,Rl.firstReplacedByBatsExchange)(e);return null!==t?{type:"replaced_to_exchange",exchange:t}:null}(e),i=t&&function(e){return`warning.noSubsc_${e.exchange}`}(t);if(null===t||null===i||Boolean(Be.getBool(i)))return void this._destroyActiveHint();const s={...Wl(t),onClose:()=>{Be.setValue(i,!0,{forceFlush:!0}),this._destroyActiveHint()}};null!==this._activeHint?this._activeHint.show(s):this._createHint().then((e=>{this._activeHint=e,this._activeHint.show(s)}))}}var Hl=i(475365),zl=i(716004),Ul=i(547777),Gl=i(104436);var ql=i(67302);var jl=i(390675);const Kl=n.t(null,void 0,i(747773));class Zl extends class{constructor(e){this._lastResolvedSymbol=null,this._chart=e,this._chart.withModel(this,this._connectToModel)}_getPopupContent(){const e=this._getProSymbol(),t=new URL("https://www.tradingview.com/chart/");t.searchParams.append("symbol",e),t.searchParams.append("utm_source","www.tradingview.com"),t.searchParams.append("utm_medium","widget"),t.searchParams.append("utm_campaign","chart"),t.searchParams.append("utm_term",e);return Kl.format({linkStart:`<a target="_blank" href="${t.toString()}">`,linkEnd:"</a>"})}_onPopupClosed(){const e=this._chart.defaultSymbol(),t=this._getSymbol();let i;i=this._lastResolvedSymbol?this._lastResolvedSymbol:e!==t?e:"AAPL",this._chart.setSymbol(i)}_getProSymbol(){return this._chart.model().mainSeries().proSymbol()}_getSymbol(){return this._chart.model().mainSeries().actualSymbol()}_connectToModel(){const e=this._chart.model().mainSeries();e.dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved),e.dataEvents().symbolGroupNotPermitted().subscribe(this,this._onSymbolGroupNotPermitted),e.dataEvents().symbolNotPermitted().subscribe(this,this.show)}_onSymbolResolved(){this._lastResolvedSymbol=this._getSymbol()}_onSymbolGroupNotPermitted(){this.show()}}{show(){(0,Bl.createNoticeDialog)({content:this._getPopupContent()}).then((e=>{e.on("destroy",this._onPopupClosed.bind(this)),e.open()}))}}var Yl=i(246255),$l=i(866554);var Xl=i(438036),Jl=(i(518439),i(12481)),Ql=i(833713),ec=i(895370),tc=i(198303),ic=i(113610);const sc=(0,r.getLogger)("Chart.LinkKeyResolver");class oc{constructor(e,t,i){this._pendingRequests=new Map,this._startRequestingDebounced=(0,Jl.default)((()=>this._startNextRequest()),500),this._layoutId=e,this._chartId=t,this._ownerSourceId=i}resolveLinkKey(e,t,i){var s;const o=function(e,t){return JSON.stringify([e,t])}(e,i),r=null!==(s=this._pendingRequests.get(o))&&void 0!==s?s:new Map;if(r.has(t))return r.get(t).promise;const n=(0,We.createDeferredPromise)();return r.set(t,n),this._pendingRequests.set(o,r),this._startRequestingDebounced(),n.promise}async _startNextRequest(){if(0===this._pendingRequests.size)return;const e=await(0,ic.getChartStorage)(),t=this._pendingRequests.entries().next().value,{symbol:i,brokerName:s}=function(e){const t=JSON.parse(e);return{symbol:t[0],brokerName:t[1]}}(t[0]),o=t[1],r={
requestType:"mainSeriesLineTools",seriesSourceId:this._ownerSourceId,symbol:i,brokerName:s,sharingMode:0};try{const t=await e.loadLineToolsAndGroups(this._layoutId,this._chartId,r,i);null!==t&&null!==t.sources&&(t.sources.forEach(((e,t)=>{if(null===e)return;const i=e.state.linkKey;if(!i)return;const s=o.get(i);null==s||s.resolve(e.id),o.delete(i)})),t.serverRequestId&&console.log(`PROCESSED:${t.serverRequestId}`))}catch(e){sc.logError(`Error requesting line tools: ${e}`)}o.forEach((e=>{e.resolve(null)})),this._pendingRequests.delete(t[0]),await this._startNextRequest()}}var rc=i(283323);const nc=[0,1,2],ac=(0,r.getLogger)("LineToolsSynchronizer");function lc(e,t){return{id:e.id,name:e.name().value(),symbol:e.symbol(),currencyId:e.currencyId(),unitId:e.unitId()}}function cc(e,t,i){const s=new Map,o=new Set(null==i?void 0:i.keys());return e.forEach(((e,r)=>{const n=!i||i.has(r);(e.timestamp>t||!n)&&(s.set(r,e),o.delete(r))})),{stillInvalidated:s,validated:Array.from(o)}}function dc(e){return(0,ut.isLineTool)(e)||(0,rc.isStudyLineToolStub)(e)}const hc=/(\w+)\/(\w+)\/(\w+)/;class uc{constructor(e,t,i){this._invalidatedLineToolsAndStudyStubs=new Map,this._allLineToolsAndStudyStubs=new Map,this._originalLineToolSharingMode=new Map,this._invalidatedLineToolGroups=new Map,this._originalLineToolGroupsSharingMode=new Map,this._ignoreInvalidatingEventsDepth=0,this._saveChartService=null,this._debouncedSave=(0,Jl.default)((()=>this._saveInvalidatedIfRequired(!1)),500),this._currentlyLoadedSymbol=new Map,this._linkKeyResolver=null,this._brokerName="",this._hasChanges=new u.WatchedValue(!1),this._lastBanTime=null,this._invalidateViaSync=0,this._savingAbortControllersBySharingMode=new Map,this._onChangeAutosave=e=>{e&&this._debouncedSave()},this._origin=e,this._chartModel=t,this._options=i,this._assignAllLineTools(this._chartModel.panes()),this._chartModel.panesCollectionChanged().subscribe(this,this._processPanesCollectionChanged.bind(this)),this._chartModel.dataSourceCollectionChanged().subscribe(this,this._processDataSourceCollectionChanged.bind(this)),this._chartModel.lineToolsGroupModel().onChanged().subscribe(this,this._processLineToolsGroupModelChanged.bind(this)),this._chartModel.mainSeries().dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved.bind(this)),this._chartModel.sourcePropertiesChanged().subscribe(this,this._processPropertiesChanged.bind(this)),this._chartModel.sourceZOrderChanged().subscribe(this,this._processPropertiesChanged.bind(this)),this._linkKeyResolver=new oc(e.layoutId,e.chartId,t.mainSeries().id()),this._brokerIdSession=new Al.FeatureToggleWatchedValue("broker_id_session",!1),nc.forEach((e=>{0===e&&this._loadAndMergeLineToolsOnStudies(e,!1),this._loadAndMergeLineToolsWithoutSymbol(e,!1)})),(0,l.onWidget)()||window.loginStateChange.subscribe(this,(()=>{window.is_authenticated&&this.reloadAllLineTools()}))}destroy(){(0,l.onWidget)()||window.loginStateChange.unsubscribeAll(this),this._brokerIdSession.destroy(),this._chartModel.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this),
this._chartModel.sourcePropertiesChanged().unsubscribeAll(this),this._chartModel.sourceZOrderChanged().unsubscribeAll(this),this._chartModel.panesCollectionChanged().unsubscribeAll(this),this._chartModel.dataSourceCollectionChanged().unsubscribeAll(this),this._chartModel.lineToolsGroupModel().onChanged().unsubscribeAll(this)}reloadAllLineTools(){this._currentlyLoadedSymbol.clear(),nc.forEach((e=>{0===e&&this._loadAndMergeLineToolsOnStudies(e,!0),this._loadAndMergeLineToolsWithoutSymbol(e,!0)}));const e=this._chartModel.mainSeries().symbolInfo();e&&this._onSymbolResolved(e)}hasChanges(){return this._hasChanges}setSaveChartService(e){this._saveChartService&&this._saveChartService.autoSaveEnabled().unsubscribe(this._onChangeAutosave),this._saveChartService=e,this._saveChartService.autoSaveEnabled().subscribe(this._onChangeAutosave)}prepareDTO(e=!1){const t=new Map;return nc.forEach((i=>{t.set(i,this._prepareDTOItem(e,i))})),t}getDTO(e=0,t=!1,i=!1){return i&&this.invalidateAll(),this._prepareDTOItem(t,e)}async applyDTO(e,t=0){this.resetInvalidated(Date.now().valueOf(),e,t),await this._applyLineToolsAndGroupsDTO(e,t)}markAsValidatedBecauseOfSavingToContent(e){this._invalidatedLineToolsAndStudyStubs.forEach((t=>{t.savedToChartContent=e})),this._invalidatedLineToolGroups.forEach((t=>{t.savedToChartContent=e})),this._recalculateHasChanges()}resetInvalidated(e,t,i){const s=(e,t,s,o)=>{if(!s.has(o)||s.get(o))s.has(o)&&t(o,i);else{const s=e.get(o);s&&(s===i?t(o,null):0===i&&t(o,s))}};if(null===t.sources)return;const{groups:o,sources:r,lineToolsToValidate:n,groupsToValidate:a}=t,l=cc(this._invalidatedLineToolsAndStudyStubs,e,new Set(null!=n?n:r.keys()));this._invalidatedLineToolsAndStudyStubs=l.stillInvalidated,l.validated.forEach(s.bind(this,this._originalLineToolSharingMode,this._setOriginalLineToolSharingMode.bind(this),r));const c=cc(this._invalidatedLineToolGroups,e,new Set(null!=a?a:o.keys()));l.validated.forEach(s.bind(this,this._originalLineToolGroupsSharingMode,this._setOriginalLineToolGroupsSharingMode.bind(this),o)),this._invalidatedLineToolGroups=c.stillInvalidated,Array.from(r.keys()).forEach((e=>{const t=this._chartModel.dataSourceForId(e);t&&null===t.serverUpdateTime()&&t.setServerUpdateTime((new Date).valueOf())})),this._recalculateHasChanges()}applyLineToolUpdateNotification(e,t){var i;const s=function(e){const t=hc.exec(e);return 4===(null==t?void 0:t.length)?{layoutId:t[1],chartId:t[2],clientId:t[3]}:{layoutId:"",chartId:"",clientId:e}}(null!==(i=e.clientId)&&void 0!==i?i:"");s.clientId===this._origin.clientId&&s.chartId===this._origin.chartId||(void 0!==e.symbol&&null===e.sources?this._withoutInvalidating((()=>{const i=this._chartModel.dataSources().filter(ut.isLineTool).filter((i=>i.sharingMode().value()===t&&i.symbol()===e.symbol));i.length>0&&this._chartModel.undoModel().removeSources(i,!0,null)})):this._applyLineToolsAndGroupsDTO(e,t,s))}startApplyingLineToolUpdateNotification(){this._ignoreInvalidatingEventsDepth++}endApplyingLineToolUpdateNotification(){this._ignoreInvalidatingEventsDepth--,
this._ignoreInvalidatingEventsDepth<0&&(ac.logError("Logic error, startApplyingLineToolUpdateNotification/endApplyingLineToolUpdateNotification mismatch, autofixing"),this._ignoreInvalidatingEventsDepth=0)}applyAlertIdByExternalSource(e,t){this._withoutInvalidating((()=>{const i=this._chartModel.dataSourceForId(e);i&&(0,ut.isLineTool)(i)&&i.setAlert(t)}))}deleteAlertByExternalSource(e){this._withoutInvalidating((()=>{const t=this._chartModel.dataSourceForId(e);t&&(0,ut.isLineTool)(t)&&t.removeAlert()}))}async markSyncedLineToolAsDeleted(e,t){if(this._linkKeyResolver){const i=await this._linkKeyResolver.resolveLinkKey(t,e,this._brokerName);if(null!==i){const t=(0,ut.lineToolByLinkKey)(this._chartModel,e);null===t?this._invalidateLineToolOrStudyStub(i,performance.now()):this._withoutInvalidating((()=>{const e=(0,s.ensureNotNull)(this._chartModel.paneForSource(t)),i=this._allLineToolsAndStudyStubs.get(e.id())||new Map;t.detachAlert(),this._chartModel.removeSource(t),i.delete(t.id())})),this._debouncedSave()}return i}return null}invalidateAll(){const e=performance.now();this._allLineToolsAndStudyStubs.forEach((t=>{t.forEach(((t,i)=>{this._invalidateLineToolOrStudyStub(i,e)}))})),this._chartModel.lineToolsGroupModel().groupsForAllSymbols().forEach((t=>{this._invalidateLineToolGroup(t.id,e)})),this.markAsValidatedBecauseOfSavingToContent(!0)}executeSyncedAction(e){this._invalidateViaSync+=1;try{e()}finally{this._invalidateViaSync-=1}}invalidateViaSync(){return this._invalidateViaSync>0}flushPendingSavings(){return this._invalidatedLineToolGroups.size||this._invalidatedLineToolsAndStudyStubs.size?this._saveInvalidatedIfRequired(!1,!0):null}_assignAllLineTools(e){e.forEach((e=>{const t=e.dataSources().filter(dc).map((e=>[e.id(),e.linkKey().value()])),i=new Map(t);this._allLineToolsAndStudyStubs.set(e.id(),i)}))}_processPropertiesChanged(e,t){dc(t)&&this._invalidateLineToolOrStudyStub(t.id(),performance.now())}_processLineToolsGroupModelChanged(e,t){const i=performance.now();this._invalidateLineToolGroup(e,i),t&&(t.affectedLineTools||[]).forEach((e=>this._invalidateLineToolOrStudyStub(e,i)))}_processPanesCollectionChanged(e){const t=e.map((e=>e.id())),i=new Set(t),o=performance.now();Array.from(this._allLineToolsAndStudyStubs.keys()).filter((e=>!i.has(e))).forEach((e=>{Array.from((0,s.ensureDefined)(this._allLineToolsAndStudyStubs.get(e)).keys()).forEach((e=>{this._invalidateLineToolOrStudyStub(e,o)}))})),e.filter((e=>!this._allLineToolsAndStudyStubs.has(e.id()))).forEach((e=>{e.dataSources().filter(dc).forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),o)))})),this._assignAllLineTools(e)}_processDataSourceCollectionChanged(e){const t=e.dataSources().filter(dc),i=t.map((e=>[e.id(),e.linkKey().value()])),o=new Map(i);let r;const n=performance.now();if(this._allLineToolsAndStudyStubs.has(e.id())){const i=(0,s.ensureDefined)(this._allLineToolsAndStudyStubs.get(e.id()));r=t.filter((e=>!i.has(e.id()))),r.forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),n))),Array.from(i.entries()).filter((e=>!o.has(e[0]))).forEach((e=>{
null!==e[1]&&this._debouncedSave(),this._invalidateLineToolOrStudyStub(e[0],n)}))}else r=t,t.forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),n)));r.forEach((e=>{if((0,ut.isLineTool)(e)){this._setOriginalLineToolSharingMode(e.id(),e.sharingMode().value());const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);t&&this._setOriginalLineToolGroupsSharingMode(t.id,e.sharingMode().value())}})),this._allLineToolsAndStudyStubs.set(e.id(),o)}_unloadLineTools(e,t,i){const o=e.filter((e=>!this._invalidatedLineToolsAndStudyStubs.has(e))).map((e=>this._chartModel.dataSourceForId(e))).filter(ut.isLineTool).filter(je.notNull).filter((e=>e.sharingMode().value()===i)).filter(t).filter((e=>{const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);return null===t||!this._invalidatedLineToolGroups.has(t.id)}));this._withoutInvalidating((()=>{o.forEach((e=>{var t;e.hasAlert().value()&&e.detachAlert();const i=(0,s.ensureNotNull)(this._chartModel.paneForSource(e));this._chartModel.removeSource(e);(null!==(t=this._allLineToolsAndStudyStubs.get(i.id()))&&void 0!==t?t:new Map).delete(e.id())})),this._chartModel.lineToolsGroupModel().removeLineTools(o)}))}_unloadLinesOnSeries(e,t,i){const s=this._chartModel.mainSeries();if(!(null==i?void 0:i.size))return;const o=Array.from(i.keys()).filter((t=>!e(t)));this._unloadLineTools(o,(e=>e.boundToSymbol()&&e.ownerSource()===s),t)}_isAutosaveEnabled(){return Boolean(this._saveChartService&&this._saveChartService.autoSaveEnabled().value())}async _saveInvalidatedIfRequired(e,t){if(null!==this._lastBanTime){if(!(performance.now()-this._lastBanTime>=3e5))return Promise.resolve();this._lastBanTime=null}if(!this._isAutosaveEnabled()&&!t||this._options.readOnlyMode||!window.is_authenticated||""===this._origin.layoutId)return;const i=this.prepareDTO(e),o=nc.map((e=>{var t,o;const r=i.get(e);if(!r||null===r.sources)return null;const n=null!==(t=r.lineToolsToValidate)&&void 0!==t?t:Array.from(r.sources.keys()),a=null!==(o=r.groupsToValidate)&&void 0!==o?o:Array.from(r.groups.keys());if(0===n.length&&0===a.length)return null;const l=performance.now();if(r.sources.size||r.groups.size){const t=this._savingAbortControllersBySharingMode.get(e);t&&t.abort();const i=new AbortController;return this._savingAbortControllersBySharingMode.set(e,i),r.sources.forEach(((t,i)=>{t&&this._setOriginalLineToolSharingMode(i,e)})),(0,s.ensureNotNull)(this._saveChartService).saveChartLineTools(this._origin.chartId,r,e,i.signal).then((()=>{this.resetInvalidated(l,r,e)})).catch((async t=>{if(t instanceof tc.SavingLineToolsError&&t.shouldBeCooled&&(this._lastBanTime=performance.now()),!(0,ae.isAbortError)(t))throw t;ac.logDebug(`Save request has been aborted. ChartId: ${this._origin.chartId} sharingMode: ${e}`)}))}return this.resetInvalidated(l,r,e),null})).filter(je.notNull);return o.length?Promise.all(o).then((()=>{})):void 0}async _savePromise(e,t){var i,s
;return this._isAutosaveEnabled()?null!==(s=null===(i=this._debouncedSave)||void 0===i?void 0:i.flush())&&void 0!==s?s:Promise.resolve():this._saveInvalidatedIfRequired(e,t)}_seriesLineToolsUnloader(e,t,i){const s=this._chartModel.mainSeries();"mainSeriesLineTools"===e.requestType&&s.symbolSameAsCurrent(e.symbol)&&(this._unloadLinesOnSeries(i,e.sharingMode,t),this._currentlyLoadedSymbol.set(e.sharingMode,e.symbol))}_mainPaneLineToolsAndStubs(){const e=this._chartModel.mainSeries(),t=(0,s.ensureNotNull)(this._chartModel.paneForSource(e));return new Map(this._allLineToolsAndStudyStubs.get(t.id()))}_onSymbolResolved(e){const t=nc.map((t=>{const i={requestType:"mainSeriesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),symbol:e.pro_name,brokerName:"",sharingMode:t},s=this._seriesLineToolsUnloader.bind(this,i,this._mainPaneLineToolsAndStubs());return this._makeLoadRequestAndMerge(i,s,e.pro_name||e.ticker||e.full_name)}));Promise.all(t).then((()=>{this._withoutInvalidating((()=>{this._chartModel.dataSources().filter(ut.isLineTool).filter((e=>0===e.sharingMode().value()&&e.linkKey().value())).forEach((e=>{if(e.share(1),this._options.migrateSyncedLineTools){this._invalidateLineToolOrStudyStub(e.id(),performance.now(),!0);const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);t&&this._invalidateLineToolGroup(t.id,performance.now(),!0)}}))}))}))}async _makeLoadRequestAndMerge(e,t,i){var s;const o=this._chartModel.mainSeries(),r=null!==(s=this._currentlyLoadedSymbol.get(e.sharingMode))&&void 0!==s?s:"";if(!!o.symbolSameAsCurrent(r))return;this._currentlyLoadedSymbol.delete(e.sharingMode);const n=await(0,ic.getChartStorage)();return this._savePromise("mainSeriesLineTools"===e.requestType).catch((()=>{})).then((()=>n.loadLineToolsAndGroups(this._origin.layoutId,this._origin.chartId,e,i))).catch((()=>null)).then((async i=>{if(null!==i&&null!==i.sources){const s=i.sources;t((e=>s.has(e))),await this._applyLineToolsAndGroupsDTO(i,e.sharingMode),i.serverRequestId&&console.log(`PROCESSED:${i.serverRequestId}`)}}))}_restoreGroups(e,t,i,o){const r=new Map;return(t.groups||new Map).forEach(((t,n)=>{const a=this._chartModel.lineToolsGroupModel().groupForId(n);if(null===t){if(a){const e=o&&o.layoutId===this._origin.layoutId&&o.chartId===this._origin.chartId;a.lineTools()[0].sharingMode().value()===i&&(e&&0!==i||(new po.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,a,a.lineTools()).redo(),this._setOriginalLineToolGroupsSharingMode(n,null)))}}else{if(a&&t.serverUpdateTime){const i=(0,s.ensureDefined)(t.serverUpdateTime);if(null!==e&&e>=i)return;a.setName(t.name)}else r.set(n,t);this._setOriginalLineToolGroupsSharingMode(n,i)}})),r}_createNewLineTool(e){const t=this._chartModel.dataSourceForId(e.ownerSource);if(null===t)return null;const i=(0,s.ensureNotNull)(this._chartModel.paneForSource(t)),o=this._chartModel.panes().indexOf(i),r=this._chartModel.restoreSource(!1,o,null,e.state,null);if(null!==r){const e=this._allLineToolsAndStudyStubs.get(i.id())||new Map;e.set(r.id(),r.linkKey().value()),
this._allLineToolsAndStudyStubs.set(i.id(),e)}return r}_migrateStateFromMetainfo(e){const t=void 0!==e.symbol&&e.symbol!==e.state.state.symbol;t&&(e.state.state.symbol=e.symbol);const i=void 0!==e.currencyId&&e.currencyId!==e.state.state.currencyId;i&&(e.state.state.currencyId=e.currencyId);const s=void 0!==e.unitId&&e.unitId!==e.state.state.unitId;return s&&(e.state.state.unitId=e.unitId),t||i||s}_restoreLineTool(e,t,i,s){var o;if((null!==(o=t.state.points)&&void 0!==o?o:[]).some((e=>!(0,je.isNumber)(e.time_t))))return null;let r=this._chartModel.dataSourceForId(t.id);if(null===r&&t.state.linkKey&&(r=(0,ut.lineToolByLinkKey)(this._chartModel,t.state.linkKey)),null!==r&&!(0,ut.isLineTool)(r))return null;if(this._origin.clientId===(null==s?void 0:s.clientId)&&!r)return null;if(r&&t.serverUpdateTime){const o=t.serverUpdateTime,n=r.serverUpdateTime();if(null!==e&&e>=o||null!==n&&n>=o)return 0!==i&&(r.share(i),this._setOriginalLineToolSharingMode(r.id(),i)),this._restoreLineToolAlert(r,t.state.alertId),null;this._origin.clientId!==(null==s?void 0:s.clientId)&&(this._chartModel.restoreLineToolState(r,t.state,!1),r.sharingMode().value()!==i&&(r.share(i),this._setOriginalLineToolSharingMode(r.id(),i)),r.calcIsActualSymbol())}0!==i&&(t.ownerSource=this._chartModel.mainSeries().id(),t.state.ownerSource=this._chartModel.mainSeries().id());const n=this._migrateStateFromMetainfo(t);let a=r||this._createNewLineTool(t);if(a&&(n&&this._invalidateLineToolOrStudyStub(t.id,performance.now(),!0),t.serverUpdateTime&&a.setServerUpdateTime(t.serverUpdateTime),this._restoreLineToolAlert(a,t.state.alertId),0!==i&&a.share(i),void 0===s&&(0,ut.isEditableTextLineTool)(a))){this._removeTextLineToolIfEmpty(a)&&(a=null)}return a}_restoreLineToolAlert(e,t){t?e.restoreAlert(+t,{syncFocusFromAlert:!0}).catch((e=>{ac.logError(`Failed to restore lineTool alert: ${Error,e}`)})):e.detachAlert()}_removeLineTool(e){const t=this._chartModel.dataSourceForId(e);null!==t&&new uo.RemoveSourcesUndoCommand(this._chartModel,[t],null).redo()}_removeTextLineToolIfEmpty(e){return!(!e.removeIfEditableTextIsEmpty()||0!==e.editableTextProperties().text.value().length)&&(this._chartModel.removeSource(e),this._invalidateLineToolOrStudyStub(e.id(),performance.now(),!0),!0)}_restoreLineDTO(e,t,i,o,r,n){if(!this._invalidatedLineToolsAndStudyStubs.get(t))if(null===e){const e=this._chartModel.dataSourceForId(t);if(!e)return;if(!(0,ut.isLineTool)(e))return;e.sharingMode().value()===r&&this._origin.clientId!==(null==n?void 0:n.clientId)&&(this._removeLineTool(t),this._setOriginalLineToolSharingMode(t,null))}else{const a=this._restoreLineTool(o,e,r,n);if(a){if(e.groupId){const t=this._chartModel.lineToolsGroupModel().groupForLineTool(a),o=this._chartModel.lineToolsGroupModel().groupForId(e.groupId);if(null!==t&&o===t)return;if(null!==t&&(t.excludeLineTool(a),0===t.lineTools().length&&this._chartModel.lineToolsGroupModel().removeGroup(t)),o&&!o.containsLineTool(a))o.addLineTools([a]);else if(!o&&i.has(e.groupId)){const t=(0,s.ensureDefined)(i.get(e.groupId))
;this._chartModel.lineToolsGroupModel().createGroup([a],t.name,t.id)}}else{this._chartModel.lineToolsGroupModel().removeLineTools([a]).forEach((e=>{this._invalidateLineToolGroup(e,performance.now(),!0)}))}void 0===this._originalLineToolSharingMode.get(t)&&this._setOriginalLineToolSharingMode(t,r),this._setOriginalLineToolSharingMode(t,r)}}}async _applyLineToolsAndGroupsDTO(e,t,i){const s=this._chartModel.chartSaveTime(),o=this._withoutInvalidating((()=>this._restoreGroups(s,e,t,i))),r=`ChartStorage.Synchronizer.ApplyingDTO.${`${this._origin.layoutId}.${this._origin.chartId}`}`,n=new Set;(e.sources||new Map).forEach((e=>{e&&n.add(e.state.type)})),await Promise.all(Array.from(n).map((e=>(0,ut.initLineTool)(e)))),(0,ec.perfMeasureOperation)(r,(()=>this._withoutInvalidating((()=>{(e.sources||new Map).forEach(((e,r)=>{try{if(e&&(0,U.isMtpPredictorToolName)(e.state.type))return void ac.logWarn(`No longer supported tool ${e.state.type} is skipped while restoring state`);this._restoreLineDTO(e,r,o,s,t,i)}catch(e){ac.logError(`Error restoring line tool ${r}: ${e}`)}})),(e.groups||new Map).forEach(((e,t)=>{this._invalidatedLineToolGroups.delete(t)})),this._recalculateHasChanges()}))))}_withoutInvalidating(e){try{return this._ignoreInvalidatingEventsDepth++,e()}finally{this._ignoreInvalidatingEventsDepth--}}_invalidateLineToolOrStudyStub(e,t,i){var s;if(this._ignoreInvalidatingEventsDepth>0&&!i)return;const o=null===(s=this._invalidatedLineToolsAndStudyStubs.get(e))||void 0===s?void 0:s.invalidatedViaSyncOnly,r=(void 0===o||o)&&this.invalidateViaSync();this._invalidatedLineToolsAndStudyStubs.set(e,{timestamp:t,invalidatedViaSyncOnly:r}),this._hasChanges.setValue(!0),this._debouncedSave()}_invalidateLineToolGroup(e,t,i){this._ignoreInvalidatingEventsDepth>0&&!i||(this._invalidatedLineToolGroups.set(e,{timestamp:t,invalidatedViaSyncOnly:this.invalidateViaSync()}),this._hasChanges.setValue(!0),this._debouncedSave())}_prepareDTOItem(e,t){const i=new Map,o=new Map,r=[],n=[];return this._invalidatedLineToolsAndStudyStubs.forEach(((n,a)=>{if(0!==t&&n.invalidatedViaSyncOnly)return void r.push(a);const l=this._chartModel.dataSourceForId(a);if(!(0,rc.isStudyLineToolStub)(l))if(null===l){this._originalLineToolSharingMode.get(a)===t&&i.set(a,null)}else{if(l===this._chartModel.lineBeingCreated()||l===this._chartModel.lineBeingEdited()||!l.isSavedInChart())return;const r=l.ownerSource()===this._chartModel.mainSeries(),n=!e||r,c=l.sharingMode().value()===t;if(n){const e=this._chartModel.lineToolsGroupModel().groupForLineTool(l);if(c)i.set(a,function(e,t){const i=t.lineToolsGroupModel().groupForLineTool(e),o={id:e.id(),ownerSource:(0,s.ensureNotNull)(e.ownerSource()).id(),state:e.state(!1)};return e.boundToSymbol()&&(o.symbol=e.symbol()),o.currencyId=e.properties().childs().currencyId.value(),o.unitId=e.properties().childs().unitId.value(),null!==i&&(o.groupId=i.id),o}(l,this._chartModel)),null!==e&&o.set(e.id,lc(e,this._chartModel));else{const s=this._originalLineToolSharingMode.get(a);s===t&&i.set(a,null),null!==e&&s===t&&o.set(e.id,null)}}}
})),this._invalidatedLineToolGroups.forEach(((e,i)=>{if(0!==t&&e.invalidatedViaSyncOnly)n.push(i);else if(!o.has(i)){const e=this._chartModel.lineToolsGroupModel().groupForId(i);if(null===e){this._originalLineToolGroupsSharingMode.get(i)===t&&o.set(i,null)}else e.sharingMode().value()===t&&o.set(i,lc(e,this._chartModel))}})),{sources:i,groups:o,clientId:this._generateOrigin(),lineToolsToValidate:Array.from(i.keys()).concat(r),groupsToValidate:Array.from(o.keys()).concat(n)}}_setOriginalLineToolSharingMode(e,t){null!==t?this._originalLineToolSharingMode.set(e,t):this._originalLineToolSharingMode.delete(e)}_setOriginalLineToolGroupsSharingMode(e,t){null!==t?this._originalLineToolGroupsSharingMode.set(e,t):this._originalLineToolGroupsSharingMode.delete(e)}_loadAndMergeLineToolsOnStudies(e,t){const i={requestType:"studiesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),sharingMode:e},s=this._chartModel.mainSeries();this._makeLoadRequestAndMerge(i,(i=>{const o=t?(0,Ql.default)(Array.from(this._allLineToolsAndStudyStubs.values()).map((e=>Array.from(e.keys())))).filter((e=>!i(e))):[];this._unloadLineTools(o,(e=>e.ownerSource()!==s),e)}))}_loadAndMergeLineToolsWithoutSymbol(e,t){const i={requestType:"lineToolsWithoutSymbol",seriesSourceId:this._chartModel.mainSeries().id(),sharingMode:e},o=this._chartModel.mainSeries(),r=(0,s.ensureNotNull)(this._chartModel.paneForSource(o)),n=this._allLineToolsAndStudyStubs.get(r.id());this._makeLoadRequestAndMerge(i,(i=>{const s=t&&n?Array.from(n.keys()).filter((e=>!i(e))):[];this._unloadLineTools(s,(e=>!e.boundToSymbol()&&e.ownerSource()===o),e)}))}_recalculateHasChanges(){const e=Array.from(this._invalidatedLineToolsAndStudyStubs.values()).some((e=>!e.savedToChartContent)),t=Array.from(this._invalidatedLineToolGroups.values()).some((e=>!e.savedToChartContent));this._hasChanges.setValue(e||t)}_generateOrigin(){return`${this._origin.layoutId}/${this._origin.chartId}/${this._origin.clientId}`}}var pc=i(195619),_c=i(232650),mc=i(700134),gc=i(72368),Sc=i(105580),vc=i(306060),fc=i(137674),bc=i(18343);var yc=i(676962);function Cc(e){return e.hasModel()?e.model().mainSeries().proSymbol():e.symbolWV().value()}var wc=i(457965);const Tc={};function Pc(e,t){return{...t,iconId:"Watchlist.AddSymbol",icon:bc.icons.get("Watchlist.AddSymbol"),statName:"AddToWatchlist",hotkeyHash:E.Modifiers.Alt+87,onExecute:()=>{(0,wc.runOrSigninWithFeature)((()=>{!function(e){if(!window.widgetbar)return;const t=(0,s.ensureNotNull)(window.widgetbar.setPage("base")).widget("watchlist");t&&(t.widgetObject?e(t.widgetObject):(t.widgetStarted().unsubscribeAll(Tc),t.widgetStarted().subscribe(Tc,(t=>e(t.widgetObject)),!0)))}((t=>{null==t||t.addSymbols([Cc(e)])}))}),{feature:"watchList",source:"add symbol to watchlist"})}}}var Mc=i(306388),xc=i(826939),Ic=i(440498);class Lc extends gi.Action{constructor(e,t){super({actionId:"Chart.AddSymbolToWatchList",options:{...Pc(e,t),subItems:[new gi.Loader("Loading")]}}),this._hadSymbolOnInit=!1,this._isMobile=(0,gc.isMobile)(),this._onRequest=null,this._unsubscribe=null,
this._chart=e,this._load()}updateLabel(e){this.update({label:n.t(null,void 0,i(991580)).format({symbol:e})})}request(){var e;this._hadSymbolOnInit=!1,this._isMobile=(0,gc.isMobile)(),this.update({subItems:[new gi.Loader("Loading")]}),null===(e=this._onRequest)||void 0===e||e.call(this)}destroy(){var e;super.destroy(),null===(e=this._unsubscribe)||void 0===e||e.call(this),this._chart=null,this._onRequest=null}async _load(){const[e,t,s,o,r,a,l]=await Promise.all([i.e(75514).then(i.t.bind(i,50959,19)),(0,
Mc.initSymbolListService)(),Promise.all([i.e(56316),i.e(64592),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(53799),i.e(46489),i.e(74600),i.e(25480),i.e(88015),i.e(30614),i.e(82321),i.e(16388),i.e(5483),i.e(62526),i.e(83147),i.e(75560),i.e(1867),i.e(13520),i.e(90361),i.e(44692),i.e(1026)]).then(i.bind(i,38506)),Promise.all([i.e(56316),i.e(64592),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(53799),i.e(46489),i.e(74600),i.e(25480),i.e(88015),i.e(30614),i.e(82321),i.e(16388),i.e(5483),i.e(62526),i.e(83147),i.e(75560),i.e(1867),i.e(13520),i.e(90361),i.e(44692),i.e(1026)]).then(i.bind(i,244692)),Promise.all([i.e(20018),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(46489),i.e(74600),i.e(75826),i.e(25480),i.e(58985),i.e(29800),i.e(22164),i.e(23141),i.e(95083),i.e(72197),i.e(43362),i.e(88015),i.e(16190),i.e(97384),i.e(49325),i.e(3782),i.e(92115),i.e(22602),i.e(32175),i.e(30614),i.e(7001),i.e(39963),i.e(67661),i.e(71329),i.e(63168),i.e(17175),i.e(51488),i.e(44066),i.e(75364),i.e(61135),i.e(77414),i.e(79412),i.e(65891),i.e(17762),i.e(55206),i.e(46190),i.e(19234),i.e(74510),i.e(88115),i.e(93871),i.e(49279),i.e(14418),i.e(17341),i.e(36299),i.e(95968),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(39002),i.e(83147),i.e(75560),i.e(66144),i.e(13520),i.e(68087),i.e(61975),i.e(90361),i.e(16242),i.e(67464),i.e(69140),i.e(91196)]).then(i.bind(i,291676)),Promise.all([i.e(20018),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(46489),i.e(74600),i.e(75826),i.e(25480),i.e(58985),i.e(29800),i.e(22164),i.e(23141),i.e(95083),i.e(72197),i.e(43362),i.e(88015),i.e(16190),i.e(97384),i.e(49325),i.e(3782),i.e(92115),i.e(22602),i.e(32175),i.e(30614),i.e(7001),i.e(39963),i.e(67661),i.e(71329),i.e(63168),i.e(17175),i.e(51488),i.e(44066),i.e(75364),i.e(61135),i.e(77414),i.e(79412),i.e(65891),i.e(17762),i.e(55206),i.e(46190),i.e(19234),i.e(74510),i.e(88115),i.e(93871),i.e(49279),i.e(14418),i.e(17341),i.e(36299),i.e(95968),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(39002),i.e(83147),i.e(75560),i.e(66144),i.e(13520),i.e(68087),i.e(61975),i.e(90361),i.e(16242),i.e(67464),i.e(69140),i.e(91196)]).then(i.bind(i,436779)),Promise.all([i.e(20018),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(46489),i.e(74600),i.e(75826),i.e(25480),i.e(58985),i.e(29800),i.e(22164),i.e(23141),i.e(95083),i.e(72197),i.e(43362),i.e(88015),i.e(16190),i.e(97384),i.e(49325),i.e(3782),i.e(92115),i.e(22602),i.e(32175),i.e(30614),i.e(7001),i.e(39963),i.e(67661),i.e(71329),i.e(63168),i.e(17175),i.e(51488),i.e(44066),i.e(75364),i.e(61135),i.e(77414),i.e(79412),i.e(65891),i.e(17762),i.e(55206),i.e(46190),i.e(19234),i.e(74510),i.e(88115),i.e(93871),i.e(49279),i.e(14418),i.e(17341),i.e(36299),i.e(95968),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(39002),i.e(83147),i.e(75560),i.e(66144),i.e(13520),i.e(68087),i.e(61975),i.e(90361),i.e(16242),i.e(67464),i.e(69140),i.e(91196)]).then(i.bind(i,631530))])
;if(this._destroyed)return;const{store:c}=t;this._onRequest=()=>c.dispatch(s.getCustomWatchlistsThunk(null)),this._unsubscribe=c.subscribe((()=>{if(!this._chart)return;const t=c.getState();if(null===r.getCustomListsState(t).timestamp)return;const s=Cc(this._chart),h=r.getCustomLists(t),{activeSymbolList:u}=t,p=h.find((e=>e.id===u));this._hadSymbolOnInit||(this._hadSymbolOnInit=!!p&&p.symbols.includes(s));const _=d.enabled("multiple_watchlists")?h.filter((e=>e.id!==u)).sort(a.sortComparator):[];let m=p?[p,..._]:_;m=m.filter((e=>!(0,Ic.isDeletedSymbolsList)(e.id)));const g=m.map((t=>{const i=t.symbols.includes(s),r={shortcutHint:t.id===u?(0,E.humanReadableHash)(E.Modifiers.Alt+87):void 0,invisibleHotkey:t.id===u?i:void 0,doNotCloseOnClick:!0,onExecute:()=>{const e=i?o.removeSymbolsThunk(xc.WATCHLIST_WIDGET_ID,[s],t.id,!0):o.addSymbolsToCustomListThunk(xc.WATCHLIST_WIDGET_ID,t.id,[s]);t.id!==u||window.is_authenticated||this._hadSymbolOnInit?c.dispatch(e):window.runOrSignIn((()=>{c.dispatch(e)}),{source:"Chart context menu"})}};return new gi.Action({actionId:"Watchlist.Actions",options:{...r,label:t.name,checkable:!0,checked:i},customActionOptions:{...r,jsxLabel:e.createElement(l.ContextMenuWatchlistItem,{title:t.name,isChecked:i,isSmallSize:this._isMobile})}})})),S=new gi.Action({actionId:"Watchlist.Create",options:{label:(0,Ul.appendEllipsis)(n.t(null,void 0,i(222556))),iconId:this._isMobile?"Watchlist.CreateNew":void 0,onExecute:()=>{(0,rn.runOrGoPro)((()=>{c.dispatch(o.userCreateWatchlistThunk(null,{symbols:[s]}))}),"MULTIPLE_WATCHLISTS",{feature:"multipleWatchLists",featureLocation:"moveSymbolsToNew"})}}});this.update({subItems:[...g,new gi.Separator,S]})}))}}var Ac=i(137685),kc=i(453995);function Ec(){const e=window.widgetbar;if(e){const t=(0,s.ensureNotNull)(e.setPage("object_tree")),i=(0,s.ensureNotNull)(t.widget("object_tree"));(0,s.ensureDefined)(i.properties).setValue({selectedPage:"data-window"})}else;}var Dc=i(440075),Bc=i(207195);var Nc=i(214372);function Rc(e){const t=e.options(),s={label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(102569))),statName:"ChangeInterval",onExecute:()=>(0,Nc.showChangeIntervalDialogAsync)({initVal:er.linking.interval.value(),selectOnInit:!0})};return!(0,d.enabled)("show_interval_dialog_on_key_press")||t.readOnly||t.hideSymbolSearch||(s.shortcutHint=",",s.hotkeyGroup=e.hotkeys(),s.hotkeyHash=188),new gi.Action({actionId:"Chart.Dialogs.ShowChangeInterval",options:s})}class Oc extends gi.Action{constructor(e,t=new u.WatchedValue(!1)){super({...e,options:{...e.options,checkable:!0,checked:t.value(),onExecute:()=>{this._wv.setValue(!this._wv.value())}}}),this._updateChecked=e=>{this.update({checked:e})},t.subscribe(this._updateChecked),this._wv=t}destroy(){this._wv.unsubscribe(this._updateChecked),super.destroy()}}var Vc=i(272933)
;const Wc=new c.TranslatedString("scale price chart only",pc.t(null,void 0,i(763796))),Fc=new c.TranslatedString("stay in drawing mode",pc.t(null,void 0,i(504114))),Hc=new c.TranslatedString("hide marks on bars",pc.t(null,void 0,i(62249))),zc=new c.TranslatedString("change symbol last value visibility",pc.t(null,void 0,i(467453))),Uc=new c.TranslatedString("change symbol previous close value visibility",pc.t(null,void 0,i(904729))),Gc=new c.TranslatedString("change previous close price line visibility",pc.t(null,void 0,i(958419))),qc=new c.TranslatedString("change symbol labels visibility",pc.t(null,void 0,i(147074))),jc=new c.TranslatedString("change indicators and financials value labels visibility",pc.t(null,void 0,i(171161))),Kc=new c.TranslatedString("change indicators and financials name labels visibility",pc.t(null,void 0,i(612411))),Zc=new c.TranslatedString("change bid and ask labels visibility",pc.t(null,void 0,i(669362))),Yc=new c.TranslatedString("change bid and ask lines visibility",pc.t(null,void 0,i(952919))),$c=new c.TranslatedString("change pre/post market price label visibility",pc.t(null,void 0,i(530870))),Xc=new c.TranslatedString("change pre/post market price line visibility",pc.t(null,void 0,i(511718))),Jc=new c.TranslatedString("change high and low price labels visibility",pc.t(null,void 0,i(524226))),Qc=new c.TranslatedString("change high and low price lines visibility",pc.t(null,void 0,i(180692))),ed=(new c.TranslatedString("change average close price label visibility",pc.t(null,void 0,i(876852))),new c.TranslatedString("change average close price line visibility",pc.t(null,void 0,i(1022))),new c.TranslatedString("change countdown to bar close visibility",pc.t(null,void 0,i(839383)))),td=new c.TranslatedString("change plus button visibility",pc.t(null,void 0,i(796379))),id=new c.TranslatedString("change session breaks visibility",pc.t(null,void 0,i(338413))),sd=new c.TranslatedString("change price line visibility",pc.t(null,void 0,i(108662)));function od(e){const t=e.hotkeys(),s=e.model(),o=e.options(),r=e.properties(),a=new gi.Action({actionId:"Chart.Series.PriceScale.ToggleInvertPriceScale",options:{label:pc.t(null,void 0,i(37189)),statName:"Invert Scale",checkable:!0,onExecute:()=>s.invertPriceScale(s.mainSeries().priceScale()),hotkeyGroup:t,hotkeyHash:De.Modifiers.Alt+73}}),c=new gi.Action({actionId:"Chart.Series.PriceScale.ToggleAutoScale",options:{label:pc.t(null,void 0,i(224157)),checkable:!0,onExecute:e=>{const t=s.mainSeries().priceScale();s.togglePriceScaleAutoScaleMode(t),e.update({checked:t.isAutoScale()})}}}),h=new gi.Action({actionId:"Chart.Scales.ToggleLockPriceToBarRatio",options:{label:pc.t(null,void 0,i(314017)),checkable:!0,statName:"ToggleLockScale",onExecute:()=>s.togglePriceScaleLockScaleMode(s.mainSeries().priceScale())}}),u=new gi.Action({actionId:"Chart.Series.PriceScale.ToggleRegular",options:{label:pc.t(null,{context:"scale_menu"},i(655300)),checkable:!0,statName:"ToggleRegularScale",onExecute:e=>{const t=s.mainSeries().priceScale()
;s.setPriceScaleRegularScaleMode(t),e.update({checked:t.isRegular()})}}}),p=new gi.Action({actionId:"Chart.Series.PriceScale.TogglePercentage",options:{label:pc.t(null,void 0,i(806919)),checkable:!0,statName:"TogglePercantage",onExecute:()=>s.togglePriceScalePercentageScaleMode(s.mainSeries().priceScale()),hotkeyGroup:t,hotkeyHash:De.Modifiers.Alt+80}}),_=new gi.Action({actionId:"Chart.Series.PriceScale.ToggleIndexedTo100",options:{label:pc.t(null,void 0,i(189999)),checkable:!0,statName:"ToggleIndexedTo100",onExecute:()=>s.togglePriceScaleIndexedTo100ScaleMode(s.mainSeries().priceScale())}}),m=new gi.Action({actionId:"Chart.Series.PriceScale.ToggleLogarithmic",options:{label:pc.t(null,void 0,i(116170)),statName:"ToggleLogScale",checkable:!0,onExecute:()=>s.togglePriceScaleLogScaleMode(s.mainSeries().priceScale()),hotkeyGroup:t,hotkeyHash:De.Modifiers.Alt+76}}),g=new gi.Action({actionId:"Chart.ChangeTimeZone",options:{label:pc.t(null,void 0,i(320909)),statName:"TimeZone"}}),S=new wi.ActionWithStandardIcon({actionId:"Chart.TimeScale.Reset",options:{label:pc.t(null,void 0,i(354170)),iconId:"Chart.Reset",statName:"ResetScale",onExecute:()=>s.resetTimeScale(),hotkeyGroup:e.hotkeys(),hotkeyHash:De.Modifiers.Mod+De.Modifiers.Alt+81}}),v=new gi.Action({actionId:"Chart.Dialogs.ShowInsertIndicators",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(287829))),statName:"InsertIndicator",onExecute:()=>e.showIndicators(),...o.indicatorsDialogShortcutEnabled?{hotkeyGroup:t,hotkeyHash:191}:void 0}}),f=new gi.Action({actionId:"Chart.Dialogs.ShowCompareOrAddSymbol",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(253942))),statName:"CompareOrAddSymbol",onExecute:()=>e.toggleCompareOrAdd()}}),b=new wi.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowGeneralSettings",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(232514))),iconId:"Settings",statName:"ChartProperties",onExecute:()=>e.showGeneralChartProperties()}}),y=new wi.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowGeneralSettings.SymbolTab",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(232514))),iconId:"Settings",statName:"MainSeriesProperties",onExecute:()=>e.showGeneralChartProperties(at.TabNames.symbol)}}),C=new wi.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowGeneralSettings.ScalesTab",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(793907))),iconId:"Settings",statName:"ScalesProperties",onExecute:()=>e.showGeneralChartProperties(at.TabNames.scales)}}),w=new gi.Action({actionId:"Chart.SelectedObject.ToggleLocked",options:{label:pc.t(null,void 0,i(279777)),statName:"ToggleLockSelectedObject",onExecute:()=>e.toggleLockSelectedObject()}}),T=new wi.ActionWithStandardIcon({actionId:"Chart.SelectedObject.Hide",options:{label:pc.t(null,void 0,i(327298)),iconId:"Chart.Hide",statName:"HideSelectedObject",onExecute:()=>e.hideSelectedObject()}}),P=new vi({actionId:"Chart.PriceScale.ToggleAutoScaleSeriesOnly",options:{label:pc.t(null,void 0,i(243758)),checkable:!0,statName:"ScalePriceChartOnly"}},{
property:r.childs().scalesProperties.childs().scaleSeriesOnly,undoModel:s,undoText:Wc}),M=new Oc({actionId:"Chart.DrawingToolbar.ToggleVisibility",options:{label:pc.t(null,void 0,i(993864)),statName:"ToggleDrawingToolbar"}},o.isDrawingToolbarVisible),x=new vi({actionId:"",options:{label:pc.t(null,void 0,i(704035)),checkable:!0,statName:"ToggleStayInDrawingMode"}},{property:Yt.properties().childs().stayInDrawingMode,undoModel:s,undoText:Fc}),I=new vi({actionId:"Chart.Marks.ToggleVisibility",options:{label:pc.t(null,void 0,i(328345)),checkable:!0,statName:"ToggleHideMarksOnBars"}},{property:Yt.hideMarksOnBars(),undoModel:s,undoText:Hc,callback:e=>Yt.hideMarksOnBars().setValue(e.isChecked())}),L=new vi({actionId:"Chart.PriceScale.Labels.ToggleSeriesLastValueVisibility",options:{label:pc.t(null,void 0,i(410127)),checkable:!0,checked:!1,statName:"ToggleSymbolLastValue"}},{property:r.childs().scalesProperties.childs().showSeriesLastValue,undoModel:s,undoText:zc}),A=new vi({actionId:"Chart.PriceScale.Labels.ToggleSymbolNameLabelsVisibility",options:{label:pc.t(null,void 0,i(832390)),checkable:!0,checked:!1,statName:"ToggleSymbolLabels"}},{property:r.childs().scalesProperties.childs().showSymbolLabels,undoModel:s,undoText:qc}),k=(0,Vc.combineProperty)(((e,t)=>e||t),r.childs().scalesProperties.childs().showStudyLastValue.weakReference(),r.childs().scalesProperties.childs().showFundamentalLastValue.weakReference()),D=new vi({actionId:"Chart.PriceScale.Labels.ToggleIndicatorsValueLabelsVisibility",options:{label:pc.t(null,void 0,i(454574)),checkable:!0,checked:!1,statName:"ToggleStudiesAndFundamentalsPriceLabels",onDestroy:()=>{k.destroy()}}},{property:k,undoModel:s,undoText:null,callback:()=>{const e=!k.value();s.beginUndoMacro(jc),s.setProperty(r.childs().scalesProperties.childs().showStudyLastValue,e,null),s.setProperty(r.childs().scalesProperties.childs().showFundamentalLastValue,e,null),s.endUndoMacro()}}),B=(0,Vc.combineProperty)(((e,t)=>e||t),r.childs().scalesProperties.childs().showStudyPlotLabels.weakReference(),r.childs().scalesProperties.childs().showFundamentalNameLabel.weakReference()),N=new vi({actionId:"Chart.PriceScale.Labels.ToggleIndicatorsNameLabelsVisibility",options:{label:pc.t(null,void 0,i(803061)),checkable:!0,checked:!1,statName:"ToggleStudiesAndFundamentalsNameLabels",onDestroy:()=>{B.destroy()}}},{property:B,undoModel:s,undoText:null,callback:()=>{const e=!B.value();s.beginUndoMacro(Kc),s.setProperty(r.childs().scalesProperties.childs().showStudyPlotLabels,e,null),s.setProperty(r.childs().scalesProperties.childs().showFundamentalNameLabel,e,null),s.endUndoMacro()}}),R=s.mainSeries().properties().childs().highLowAvgPrice.childs(),O=new vi({actionId:"Chart.PriceScale.Labels.ToggleHighLowPriceLabelsVisibility",options:{label:pc.t(null,void 0,i(399479)),checkable:!0,checked:!1,statName:"ToggleHighLowPriceLabels"}},{property:R.highLowPriceLabelsVisible,undoModel:s,undoText:Jc}),V=new vi({actionId:"Chart.Lines.ToggleHighLowLinesVisibility",options:{label:pc.t(null,void 0,i(433766)),checkable:!0,checked:!1,
statName:"ToggleHighLowPriceLine"}},{property:R.highLowPriceLinesVisible,undoModel:s,undoText:Qc}),W=new vi({actionId:"Chart.PriceScale.ToggleCountdownToBarCloseVisibility",options:{label:pc.t(null,void 0,i(583140)),checkable:!0,checked:!1,statName:"ToggleCountdown"}},{property:s.mainSeries().properties().childs().showCountdown,undoModel:s,undoText:ed}),F=new vi({actionId:"Chart.PriceScale.ToggleAddOrderPlusButtonVisibility",options:{label:pc.t(null,void 0,i(371566)),checkable:!0,checked:_a.addPlusButtonProperty.value(),statName:"ToggleAddOrderPlusButton"}},{property:_a.addPlusButtonProperty,undoModel:s,undoText:td}),H=new wi.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowSymbolInfo",options:{label:(0,Ul.appendEllipsis)((0,gc.isMobile)()?pc.t(null,void 0,i(655104)):pc.t(null,void 0,i(975594))),iconId:"Chart.SymbolInfo",checkable:!1,statName:"SymbolInfo",onExecute:()=>{if((0,gc.isMobile)())(0,d.enabled)("mobile_app_action_open_details_webview")&&o.onDetailsWebviewOpen?o.onDetailsWebviewOpen():(0,Sc.showDetailsDialog)(),(0,Ne.trackEvent)("ContextMenuClick","Mobile","SymbolInfo");else{const t=e.model().model(),i=t.mainSeries().symbolInfo();if(i){const e=t.availableUnits(),s=t.unitConversionEnabled();(0,Dc.showSymbolInfoDialog)({symbolInfo:i,showUnit:s,unitDescription:t=>t?e.description(t):"",dateFormatter:t.dateFormatter()})}}}}}),z=new gi.Action({actionId:"Chart.PriceScale.MergeAllScalesToLeft",options:{label:pc.t(null,void 0,i(562329)),statName:"MergeAllScalesToLeft",onExecute:()=>s.mergeAllScales("left")}}),U=new gi.Action({actionId:"Chart.PriceScale.MergeAllScalesToRight",options:{label:pc.t(null,void 0,i(755813)),statName:"MergeAllScalesToRight",onExecute:()=>s.mergeAllScales("right")}}),G=new gi.Action({actionId:"Chart.PriceScale.MoveToLeft",options:{label:pc.t(null,void 0,i(26493)),statName:"MoveScaleToLeft",onExecute:()=>s.mergeAllScales("left")}}),q=new gi.Action({actionId:"Chart.PriceScale.MoveToRight",options:{label:pc.t(null,void 0,i(140789)),statName:"MoveScaleToRight",onExecute:()=>s.mergeAllScales("right")}}),j=new wi.ActionWithStandardIcon({actionId:"Chart.Scales.Reset",options:{label:pc.t(null,void 0,i(575246)),iconId:"Chart.Reset",statName:"ResetChart",onExecute:()=>e.GUIResetScales(),hotkeyGroup:t,hotkeyHash:De.Modifiers.Alt+82}}),K=e.model().model().sessions();let Z;const Y=(0,Vc.createWVFromProperty)(e.model().mainSeries().isDWMProperty()),$=new gi.Action({actionId:"Chart.SessionBreaks.ToggleVisibility",options:{label:pc.t(null,void 0,i(366707)),checkable:!0,checked:!1,statName:"ToggleSessionBreaks",disabled:!0,onExecute:()=>{Z&&s.setProperty(Z,!Z.value(),id)},onDestroy:()=>Y.destroy()},optionsLoader:async()=>{const e=await K.promise();return Z=e.properties().childs().graphics.childs().vertlines.childs().sessBreaks.childs().visible,{checked:Z.value(),disabled:Y.value()}}});Y.subscribe((()=>$.update({disabled:Y.value()})));const X=new vi({actionId:"Chart.Lines.ToggleSeriesPriceLineVisibility",options:{label:pc.t(null,void 0,i(72926)),checkable:!0,statName:"TogglePriceLine"}},{
property:s.mainSeries().properties().childs().showPriceLine,undoModel:s,undoText:sd}),J=new gi.Action({actionId:"Chart.Undo",options:{label:pc.t(null,void 0,i(314804)),onExecute:()=>{(0,Ne.trackEvent)("GUI","Undo"),s.undoHistory().undo()},onDestroy:()=>{e.model().undoHistory().undoStack().onChange().unsubscribeAll(J)},disabled:!0,hotkeyGroup:t,hotkeyHash:De.Modifiers.Mod+90,isRepeatAccepted:!0}});e.model().undoHistory().undoStack().onChange().subscribe(J,(()=>J.update({disabled:e.model().undoHistory().undoStack().isEmpty()})));const Q=new gi.Action({actionId:"Chart.Redo",options:{label:pc.t(null,void 0,i(148236)),onExecute:()=>{(0,Ne.trackEvent)("GUI","Redo"),e.model().undoHistory().redo()},onDestroy:()=>{e.model().undoHistory().redoStack().onChange().unsubscribeAll(Q)},disabled:!0,hotkeyGroup:t,hotkeyHash:De.Modifiers.Mod+89,isRepeatAccepted:!0}});e.model().undoHistory().redoStack().onChange().subscribe(Q,(()=>Q.update({disabled:e.model().undoHistory().redoStack().isEmpty()})));const ee={invertSeriesScale:a,autoSeriesScale:c,lockSeriesScale:h,regularSeriesScale:u,percentSeriesScale:p,indexedTo100SeriesScale:_,logSeriesScale:m,applyTimeZone:g,symbolSearch:new gi.Action({actionId:"Chart.Dialogs.ShowChangeSymbol",options:{label:(0,Ul.appendEllipsis)(n.t(null,void 0,i(885124))),statName:"ChangeSymbol",onExecute:()=>{(0,He.showDialog)({defaultValue:"",trackResultsOptions:{trackResults:!d.enabled("widget"),emptySearchType:"empty_result__supercharts"}})}}}),changeInterval:Rc(e),timeScaleReset:S,insertIndicator:v,compareOrAdd:f,chartProperties:b,mainSeriesPropertiesAction:y,scalesProperties:C,lineToggleLock:w,seriesHide:T,studyHide:T,lineHide:T,scaleSeriesOnly:P,drawingToolbarAction:M,stayInDrawingModeAction:x,hideAllMarks:I,showSeriesLastValue:L,showSymbolLabelsAction:A,showStudyLastValue:D,showStudyPlotNamesAction:N,showHighLowPriceLabels:O,showHighLowPriceLines:V,showCountdown:W,addPlusButton:F,showSymbolInfoDialog:H,mergeLeftScalesAction:z,mergeRightScalesAction:U,moveScaleToLeft:G,moveScaleToRight:q,chartReset:j,sessionBreaks:$,showPriceLine:X,undo:J,redo:Q};o.goToDateEnabled&&(ee.gotoDate=new gi.Action({actionId:"Chart.Dialogs.ShowGoToDate",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(754280))),statName:"GoToDate",onExecute:()=>(0,Bc.showGoToDateDialog)(e.chartWidgetCollection().activeChartWidget.value()),hotkeyGroup:t,hotkeyHash:De.Modifiers.Alt+71}})),(0,d.enabled)("show_object_tree")&&(ee.paneObjectTree=new gi.Action({actionId:"Chart.ObjectTree.Show",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(251221))),statName:"ObjectsTree",onExecute:()=>e.showObjectsTreePanelOrDialog()}})),(0,d.enabled)("property_pages")&&(ee.format=new wi.ActionWithStandardIcon({actionId:"Chart.SelectedObject.ShowSettingsDialog",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(232514))),iconId:"Settings",statName:"EditSelectedObject",onExecute:()=>e.showSelectedSourcesProperties()}})),e.readOnly()||(ee.paneRemoveAllStudies=new gi.Action({actionId:"Chart.RemoveAllIndicators",options:{
label:pc.t(null,void 0,i(699984)),statName:"RemoveAllIndicators",onExecute:()=>e.removeAllStudies()}}),ee.paneRemoveAllDrawingTools=new gi.Action({actionId:"Chart.RemoveAllLineTools",options:{label:pc.t(null,void 0,i(396374)),statName:"RemoveAllDrawingTools",onExecute:()=>e.removeAllDrawingTools()}}),ee.paneRemoveAllStudiesDrawingTools=new gi.Action({actionId:"Chart.RemoveAllIndicatorsAndLineTools",options:{label:pc.t(null,void 0,i(481442)),statName:"RemoveAllIndicatorsAndDrawingTools",onExecute:()=>e.removeAllStudiesDrawingTools()}}),ee.applyStudiesToAllCharts=new gi.Action({actionId:"Chart.ApplyIndicatorsToAllCharts",options:{label:pc.t(null,void 0,i(222437)),statName:"ApplyIndicatorsToAllCharts",onExecute:()=>e.chartWidgetCollection().applyIndicatorsToAllCharts(e)}}),ee.studyRemove=ee.lineRemove=new wi.ActionWithStandardIcon({actionId:"Chart.SelectedObject.Remove",options:{label:pc.t(null,void 0,i(767410)),iconId:"Chart.RemoveSelectedObject",statName:"RemoveSelectedObject",onExecute:()=>{var t;(null!==(t=e.chartWidgetCollection().activeChartWidget.value())&&void 0!==t?t:e).removeSelectedSources()},hotkeyGroup:t,hotkeyHash:De.isMacKeyboard?8:46}})),(0,l.onWidget)()||(0,d.enabled)("text_notes")&&(ee.addToTextNotes=function(e){return new gi.Action({actionId:"Note.Create",options:{iconId:"TextNote.Add",icon:bc.icons.get("TextNote.Add"),label:n.t(null,void 0,i(784513)),statName:"AddToTextNotes",onExecute:()=>{window.runOrSignIn((()=>{var t;null===(t=window.widgetbar)||void 0===t||t.setPage("base"),(0,fc.createSymbolNote)(e.symbolWV().value(),(0,gc.isMobile)())}),{source:"Add text note in chart context menu"})},hotkeyHash:E.Modifiers.Alt+78,hotkeyGroup:e.hotkeys()}})}(e)),window.is_authenticated&&((0,ql.showThemeSwitcher)()||(0,ql.showThemeAction)())&&(ee.applyColorTheme=new gi.Action({actionId:"Chart.Theme.Apply",options:{name:"apply-color-theme",label:pc.t(null,void 0,i(453438)),subItems:[new gi.Action({actionId:"Loading",options:{label:pc.t(null,void 0,i(786726))}})],statName:"ColorTheme"}})),o.showFinancialsEnabled&&(ee.showFinancials=new wi.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowInsertFinancials",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(856135))),iconId:"Chart.Financials",statName:"Financials",onExecute:()=>{(0,d.enabled)("mobile_app_action_open_financials_webview")?(0,_c.openFinancialsWebview)(new URLSearchParams):(0,mc.showFinancialsDialog)(),window.matchMedia("screen and (max-width: 430px)").matches&&(0,Ne.trackEvent)("ContextMenuClick","","Financials"),(0,ts.getTracker)().then((e=>{null==e||e.trackFinancialsDialog(er.linking.ensuredProSymbol.value(),"contextMenu")}))}}})),(0,d.enabled)("show_source_code")&&(ee.viewSourceCode=new gi.Action({actionId:"Chart.Indicator.PineSource",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(787142))),statName:"OpenSelectedObjectSource",onExecute:()=>{if(!window.TradingView.bottomWidgetBar)return;const[e]=s.selection().dataSources();if(!(0,ct.isStudy)(e))return;const t=e.metaInfo();t&&t.scriptIdPart&&t.pine&&(0,
kc.getPineSourceCode)(t.scriptIdPart,t.pine.version).done((e=>{if(!e)return;const{bottomWidgetBar:i}=window.TradingView;if(!i)return;const{lastVersionMaj:s,scriptName:o,scriptTitle:r,version:n,source:a}=e,l=s?vc.Version.parse(s):new vc.Version(0,0);i.activateScriptEditorTab({scriptSource:a,scriptName:o,scriptTitle:r,version:n,scriptIdPart:t.scriptIdPart,isOld:!l.isZero()&&l.major()!==vc.Version.parse(n).major()})})).fail(Ac.showScriptInfoErrorNoticeDialog)}}}));{const e=ee.showPrePostMarketPriceLabel=new vi({actionId:"Chart.PriceScale.Labels.TogglePrePostMarketLabelsVisibility",options:{label:pc.t(null,void 0,i(578793)),checkable:!0,checked:!1,statName:"TogglePrePostMarketPriceLabel",onDestroy:()=>{s.mainSeries().isPrePostMarketPricesAvailableProperty().unsubscribeAll(e)}}},{property:r.childs().scalesProperties.childs().showPrePostMarketPriceLabel,undoModel:s,undoText:$c});s.mainSeries().isPrePostMarketPricesAvailableProperty().subscribe(e,(t=>{e.update({disabled:!t.value()})}))}{const e=ee.showPrePostMarketPriceLine=new vi({actionId:"Chart.Lines.TogglePrePostMarketPriceLineVisibility",options:{label:pc.t(null,void 0,i(597915)),checkable:!0,checked:!1,statName:"TogglePrePostMarketPriceLine",onDestroy:()=>{s.mainSeries().isPrePostMarketPricesAvailableProperty().unsubscribeAll(e)}}},{property:s.mainSeries().properties().childs().prePostMarket.childs().visible,undoModel:s,undoText:Xc});s.mainSeries().isPrePostMarketPricesAvailableProperty().subscribe(e,(t=>{e.update({disabled:!t.value()})}))}ee.hideAllLineTools=new vi({actionId:"Chart.ToggleVisibility.AllLineTools",options:{label:pc.t(null,void 0,i(616830)),checkable:!0,statName:"ToggleHideMarksOnBars",hotkeyGroup:e.hotkeys(),hotkeyHash:De.Modifiers.Mod+De.Modifiers.Alt+72}},{property:Yt.hideMarksOnBars(),undoModel:s,undoText:Hc,callback:()=>(0,ze.toggleHideMode)()});{const n=ee.showSeriesPrevCloseValue=new vi({actionId:"Chart.PriceScale.Labels.ToggleSymbolPrevCloseValueVisibility",options:{label:pc.t(null,void 0,i(522071)),checkable:!0,checked:!1,statName:"ToggleSymbolPrevCloseValue",onDestroy:()=>s.mainSeries().onRestarted().unsubscribeAll(n)}},{property:r.childs().scalesProperties.childs().showSeriesPrevCloseValue,undoModel:s,undoText:Uc});s.mainSeries().onRestarted().subscribe(n,(()=>{n.update({disabled:s.mainSeries().isDWM()})}));const a=ee.showSeriesPrevCloseLine=new vi({actionId:"Chart.Lines.ToggleSeriesPrevCloseLineVisibility",options:{label:pc.t(null,void 0,i(879366)),checkable:!0,checked:!1,statName:"ToggleSymbolPrevCloseLine",onDestroy:()=>s.mainSeries().onRestarted().unsubscribeAll(a)}},{property:s.mainSeries().properties().childs().showPrevClosePriceLine,undoModel:s,undoText:Gc});if(s.mainSeries().onRestarted().subscribe(a,(()=>{a.update({disabled:s.mainSeries().isDWM()})})),ee.showBidAskLabels=new vi({actionId:"Chart.PriceScale.Labels.ToggleBidAskLabelsVisibility",options:{label:pc.t(null,void 0,i(398810)),checkable:!0,checked:!1,statName:"ToggleBidAskLabels"}},{property:r.childs().scalesProperties.childs().showBidAskLabels,undoModel:s,undoText:Zc}),
ee.showBidAskLines=new vi({actionId:"Chart.Lines.ToggleBidAskLinesVisibility",options:{label:pc.t(null,void 0,i(292590)),checkable:!0,checked:!1,statName:"ToggleBidAskLines"}},{property:s.mainSeries().properties().childs().bidAsk.childs().visible,undoModel:s,undoText:Yc}),ee.moveChartAction=new gi.Action({actionId:"Chart.MoveChartInLayout",options:{label:pc.t(null,void 0,i(287849)),subItems:[new gi.Action({actionId:"Chart.MoveChartInLayout.Forward",options:{label:pc.t(null,void 0,i(797057)),statName:"MoveChartRight",onExecute:()=>e.chartWidgetCollection().moveActiveChartWithUndo(!1)}}),new gi.Action({actionId:"Chart.MoveChartInLayout.Back",options:{label:pc.t(null,void 0,i(139403)),statName:"MoveChartLeft",onExecute:()=>e.chartWidgetCollection().moveActiveChartWithUndo(!0)}})]}}),ee.showDataWindow=new wi.ActionWithStandardIcon({actionId:"Chart.DataWindow.Show",options:{label:(0,Ul.appendEllipsis)(pc.t(null,void 0,i(748741))),statName:"DataWindow",hotkeyGroup:t,hotkeyHash:De.Modifiers.Alt+68,iconId:"Chart.ShowDataWindow",onExecute:Ec}}),o.addToWatchlistEnabled){const i={hotkeyGroup:t};ee.addToWatchlist=new Lc(e,i),t.add({desc:"Add symbol to watchlist",hotkey:De.Modifiers.Mod+De.Modifiers.Alt+87,handler:()=>(0,yc.showAddSymbolDialog)([Cc(e)])})}}return ee}var rd=i(876610);i(443882);const nd=(0,r.getLogger)("ChartWidget",{color:"#606"}),ad=d.enabled("chart_content_overrides_by_defaults"),ld=d.enabled("symphony_embed"),cd=new c.TranslatedString("hide {title}",n.t(null,void 0,i(713017))),dd=new c.TranslatedString("change timezone",n.t(null,void 0,i(920137))),hd=new c.TranslatedString("unlock {title}",n.t(null,void 0,i(212525))),ud=new c.TranslatedString("lock {title}",n.t(null,void 0,i(576104)));let pd=null;if(location.search.toLowerCase().includes("logcanvassaverestoreleaks")){if(!l.isChrome)throw new Error("CanvasRenderingContext2D save/restore leak detection is available for now in Chrome only");i.e(15803).then(i.bind(i,567736)).then((e=>{e.enableCanvasRenderingContext2DSaveRestoreLeaksDetection(),pd=e.reportCanvasRenderingContext2DSaveRestoreLeaks}))}const _d={addToWatchlistEnabled:!0,showFinancialsEnabled:!1,sourceSelectionEnabled:!0,propertyPagesEnabled:!0,paneContextMenuEnabled:!0,priceScaleContextMenuEnabled:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,goToDateEnabled:!1,marketStatusWidgetEnabled:!0,chartWarningWidgetEnabled:!0,dataProblemWidgetEnabled:!0,paneControlsEnabled:!0,isSymbolAvailable:e=>Promise.resolve(!0),legendWidgetEnabled:!0,chartEventsEnabled:!0,newsNotificationsEnabled:!0,esdEnabled:!1,latestUpdatesEnabled:{news:!1,minds:!1},continuousContractSwitchesEnabled:!1,futuresContractExpirationEnabled:!1,croppedTickMarks:!0,countdownEnabled:!0,lastPriceAnimationEnabled:!0,useKineticScroll:l.CheckMobile.any(),indicatorsDialogShortcutEnabled:!0,handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!0}},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!0}};function md(e,t,i,s=0){const o=t.mainSeries().syncModel(),r=e.mainSeries().syncModel()
;let n=i;if(null!==o&&null!==r){const t=e.createSyncPoint(o.syncSourceTarget(),r.syncSourceTarget());0!==s&&(i=o.projectTime(i,s)),n=t.sourceTimeToTargetTime(i)}return e.timeScale().points().roughIndex(n,r&&r.distance.bind(r))}const gd=new Set(["Volume@tv-basicstudies","Compare@tv-basicstudies","Overlay@tv-basicstudies","Dividends@tv-basicstudies","Earnings@tv-basicstudies","Splits@tv-basicstudies","BarSetContinuousRollDates@tv-corestudies","Sessions@tv-basicstudies","VbPSessionsRough@tv-volumebyprice","AnchoredVWAP@tv-basicstudies","RegressionTrend@tv-basicstudies","VbPAnchored@tv-basicstudies","VbPFixed@tv-basicstudies","VbPFixed@tv-volumebyprice"]),Sd=(0,Ee.default)((()=>{window.ChartApiInstance.setIsNonCountedStudyFn((e=>gd.has(e)))}));class vd{constructor(e,t,o){var r;this.activePaneWidget=null,this._model=null,this._mainDiv=null,this._parent=null,this._elTooltipDiv=null,this._paneWidgets=[],this._maximizedPaneWidget=null,this._timeAxisWidget=null,this._paneSeparators=[],this._controlBarNavigation=null,this._lineToolsSynchronizer=null,this._modelCreated=new de.Delegate,this._isDestroyed=!1,this._customLegendWidgetsFactoryMap=new Map,this._backgroundTopTheme=new u.WatchedValue("light"),this._backgroundBasedTheme=new u.WatchedValue("light"),this._backgroundBottomTheme=new u.WatchedValue("light"),this._backgroundTopColorSpawn=null,this._backgroundBottomColorSpawn=null,this._lhsAxesWidth=0,this._rhsAxesWidth=0,this._lhsPriceAxisWidthChanged=new de.Delegate,this._rhsPriceAxisWidthChanged=new de.Delegate,this._hotkeysListener=null,this._mouseWheelHelper=null,this._onWheelBound=null,this._justActivated=!1,this._inited=!1,this._containsData=!1,this._initialLoading=!1,this._onWidget=!1,this._widgetCustomer=void 0,this._defInterval=null,this._defStyle=null,this._defTimeframe=null,this._removeMaximizeHotkey=null,this._invalidationMask=null,this._drawPlanned=!1,this._drawRafId=0,this._inLoadingState=!1,this._timingsMeter=null,this._tagsChanged=new de.Delegate,this._redraw=new de.Delegate,this._isVisible=new u.WatchedValue(!0),this._collapsed=new u.WatchedValue(!1),this._dataWindowWidget=null,this._resizeHandler=null,this._spinner=null,this._symbolWV=new u.WatchedValue,this._resolutionWV=new u.WatchedValue,this._actions=null,this._updateThemedColorBound=this._updateThemedColor.bind(this),this._disconnected=new de.Delegate,this._reconnectBailout=new de.Delegate,this._connected=new de.Delegate,this._chartWidgetInitialized=new de.Delegate,this._aboutToBeDestroyed=new de.Delegate,this._saveChartService=null,this._objectTreeDialogController=null,this._chartPaintedPromise=null,this._noExchangeSubscrptionWarning=null,this._paneWidgetsSharedState=new Bs,this._onZoom=new de.Delegate,this._onScroll=new de.Delegate,this._availableScreen=null,this._hoveredPriceAxes=new Set,this._anyAxisHovered=new u.WatchedValue(!1),this._linkingGroupIndex=new u.WatchedValue(null),this._isHovered=new u.WatchedValue(!1),this._activeHint=null,this._eventHintDeferredPromise=null,this._warningHintDeferredPromise=null,
this._setSymbolIntervalContentOverrides={},this._ariaPriceDescription=null,this._definitionsViewModel=null,this._barsButton=null,this._updateScalesActions=()=>{const e=this.actions(),t=this.model().mainSeries(),i=t.priceScale(),s=t.properties(),o=i.isLockScale(),r=6===s.childs().style.value();e.percentSeriesScale.update({disabled:o||r,checked:i.isPercentage()}),e.logSeriesScale.update({disabled:o||r,checked:i.isLog()}),e.regularSeriesScale.update({disabled:o||r,checked:i.isRegular()}),e.indexedTo100SeriesScale.update({disabled:o||r,checked:i.isIndexedTo100()}),e.invertSeriesScale.update({checked:i.isInverted()}),e.lockSeriesScale.update({checked:i.isLockScale()}),e.autoSeriesScale.update({checked:i.isAutoScale(),disabled:i.properties().childs().autoScaleDisabled.value()})},this._invalidationHandler=e=>{if(!(e instanceof B.InvalidationMask))throw new Error("Invalid mask");null!==this._invalidationMask?this._invalidationMask.merge(e):this._invalidationMask=e,this._drawPlanned||(this._drawPlanned=!0,this._options.visible.when((()=>{const e=!document.hidden,t=this.screen&&this.screen.isShown();null!==this._timingsMeter&&e&&!t&&this._timingsMeter.startWaitingDraw();const i=(0,s.ensureNotNull)((0,s.ensureNotNull)(this._parent).ownerDocument.defaultView);this._drawRafId=i.requestAnimationFrame(this._invalidationRAFCallback.bind(this))})))},this._onChartSessionIsConnectedChanged=e=>{e?this._onConnection():this._onDisconnect()},this._subscribeToBanInfo=e=>{var t,i;e?null===(t=this._spinner)||void 0===t||t.stop():null===(i=this._spinner)||void 0===i||i.spin()},this._id=t,this._layoutId=o,this._options=(0,je.merge)((0,je.clone)(_d),e),this._chartWidgetCollection=this._options.chartWidgetCollection,this._isActive=new u.WatchedValue(!!this._options.isActive),this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._subscribeToDrawingState(),this.withModel(this,(()=>{const e=this.model().model();e.backgroundTopColor().subscribe(this._updateThemedColorBound),e.backgroundColor().subscribe(this._updateThemedColorBound)})),this._errorRenderer=new It(this),this._scrollHelper=new nt(this),this._objectTreeDialogController=qe.getInstance(),this._properties=new Qo.DefaultProperty({defaultName:"chartproperties",useUserPreferences:this._options.useUserChartPreferences,excludedDefaultsKeys:["scalesProperties.axisHighlightColor","scalesProperties.axisLineToolLabelBackgroundColorActive","scalesProperties.axisLineToolLabelBackgroundColorCommon","scalesProperties.showPriceScaleCrosshairLabel","scalesProperties.showTimeScaleCrosshairLabel","scalesProperties.crosshairLabelBgColorLight","scalesProperties.crosshairLabelBgColorDark"]}),this._startSpinner(this._options.container.value()),window.ChartApiInstance.connectionBanInfo().subscribe(this._subscribeToBanInfo,{callWithLast:!0}),this._chartSession=new Yl.ChartSession(window.ChartApiInstance),Sd(),this._isMultipleLayout=(0,Je.combine)((e=>(0,Ie.isMultipleLayout)(e)),this._chartWidgetCollection.layout.weakReference()),
this._properties.childs().scalesProperties.childs().scaleSeriesOnly.subscribe(null,(()=>{const e=this.model().model();e.recalculateAllPanes((0,hs.viewportChangeEvent)()),e.invalidate(B.InvalidationMask.full())})),this._hotkeys=Re.createGroup({desc:"Chart actions",isDisabled:()=>!this.isActive().value()}),(0,l.onWidget)()||(this._persistentLogSwitcher=new Al.FeatureToggleWatchedValue("support_persistent_logs",!1),this._persistentLogSwitcher.subscribe((async e=>{var t;if(e){if((0,El.getPersistentLogger)())return;(0,El.setPersistentLogger)(new Dl);const{initPersistentLogger:e}=await i.e(94882).then(i.bind(i,286126));(null===(t=this._persistentLogSwitcher)||void 0===t?void 0:t.value())?e():(0,El.setPersistentLogger)(null)}else(0,El.setPersistentLogger)(null)}),{callWithLast:!0})),this._compareDialog=this._chartWidgetCollection.getCompareDialogRenderer(),this._options.timeScaleWidget&&(this._options.timeScaleWidget.pressedMouseMoveScale=this._options.handleScale.axisPressedMouseMove.time);const n=this._options.onCmeWidget;n&&nd.logWarn("[ChartWidget] 'onCmeWidget' option is depricated");const a=this._options.widgetCustomer,c=this._options.timezone;let d=null!==(r=this._options.defSymbol)&&void 0!==r?r:"",h=js.Interval.isValid(this._options.defInterval)?this._options.defInterval:null;const p=this._options.defStyle;let _=(0,we.isValidStyle)(p)?p:null;const m=this._options.defSessionId,g=void 0!==this._options.defTimeframe?"string"==typeof this._options.defTimeframe?{value:this._options.defTimeframe.toUpperCase(),type:"period-back"}:{...this._options.defTimeframe,type:"time-range"}:null;this._content=this._options.content,this._initialLoading=this._options.initialLoading,this._containsData=!!this._options.containsData,this._onWidget=!!this._options.onWidget,this._compareSymbols=this._options.compareSymbols,this._defSymbol=d,this._defInterval=h,this._defTimeframe=g,this._defStyle=_,this._onWidget&&(n?this._widgetCustomer="cme":a&&(this._widgetCustomer=a)),this._compareDialog=this._chartWidgetCollection.getCompareDialogRenderer();const S=this._contentSeriesProperties();S&&(d=S.symbol,h=S.interval),void 0===this._options.useUserChartPreferences&&(this._options.useUserChartPreferences=!0);const v="chartproperties.mainSeriesProperties",f=this._options.useUserChartPreferences?(0,yn.defaults)(v):(0,yn.factoryDefaults)(v),b=this._properties.childs().mainSeriesProperties;b.merge(f),b.hasChild("esdBreaksStyle")&&b.removeProperty("esdBreaksStyle");const y=h||f.interval||"D";null!==_&&(0,we.isValidStyle)(_)||(_=(0,we.isValidStyle)(f.style)?f.style:(0,we.getDefaultStyle)(js.Interval.isRange(y))),b.merge({visible:!0,symbol:d||window.DEFAULT_SYMBOL,shortName:"",timeframe:"",interval:y,currencyId:null,unitId:null,style:_,sessionId:m}),this._symbolWV.setValue(this.getSymbol()),this._resolutionWV.setValue(this.getResolution()),this._containsData&&this._properties.childs().mainSeriesProperties.merge({showCountdown:!1}),c&&(0,Qe.timezoneIsAvailable)(c)&&this._properties.childs().timezone.setValue(c),this._options.container.subscribe((e=>{
this._setElement(e)}),{callWithLast:!0});const C=()=>{this.resize()};this._options.width.subscribe(C),this._options.height.subscribe(C),this._options.visible.subscribe(this._updateTimingsMeterState.bind(this))}refreshMarks(){this.model().barsMarksSources().forEach((e=>e.refreshData()))}clearMarks(e){this.model().barsMarksSources().forEach((t=>t.clearMarks(e)))}setTimezone(e){const t=e;t&&(0,Qe.timezoneIsAvailable)(t)?this.properties().childs().timezone.setValue(t):console.warn("Incorrect timezone: "+JSON.stringify(t))}getTimezone(){return this.properties().childs().timezone.value()}destroy(){var e,t,i,s,o,r,n,a,l,c,d,h,u,p,_;this._unsetActions(),null===(e=this._hotkeys)||void 0===e||e.destroy(),null===(t=this._lineToolsSynchronizer)||void 0===t||t.destroy(),null===(i=this._noExchangeSubscrptionWarning)||void 0===i||i.destroy(),window.loginStateChange.unsubscribe(this,this._handleLoginStateChanged),null!==this._model&&(this._model.model().backgroundTopColor().unsubscribe(this._updateThemedColorBound),this._model.model().backgroundColor().unsubscribe(this._updateThemedColorBound),this._model.model().crossHairSource().moved().unsubscribe(this,this._updateAriaPriceDescription),this._model.destroy()),window.ChartApiInstance.connectionBanInfo().unsubscribe(this._subscribeToBanInfo),this._ariaPriceDescription=null,this._customLegendWidgetsFactoryMap.clear(),this._scrollHelper.destroy(),this._errorRenderer.destroy(),this._chartSession.criticalError().unsubscribe(this,this._onChartSessionCriticalError),this._chartSession.isConnected().unsubscribe(this._onChartSessionIsConnectedChanged),this._chartSession.destroy(),null===(s=this._persistentLogSwitcher)||void 0===s||s.destroy(),this._isDestroyed=!0,this._aboutToBeDestroyed.fire(),null===(o=this._removeMaximizeHotkey)||void 0===o||o.call(this),this._removeMaximizeHotkey=null,0!==this._drawRafId&&(null===(n=null===(r=this._parent)||void 0===r?void 0:r.ownerDocument.defaultView)||void 0===n||n.cancelAnimationFrame(this._drawRafId)),null===(a=this._backgroundTopColorSpawn)||void 0===a||a.destroy(),null===(l=this._backgroundBottomColorSpawn)||void 0===l||l.destroy(),null===(c=this._timingsMeter)||void 0===c||c.stopCollect(),this._timingsMeter=null;for(let e=0;e<this._paneWidgets.length;e++)this._paneWidgets[e].destroy();this._paneWidgets.length=0;for(let e=0;e<this._paneSeparators.length;e++)this._paneSeparators[e].destroy();this._paneSeparators.length=0,null===(d=this._hotkeysListener)||void 0===d||d.destroy(),null===(h=this._barsButton)||void 0===h||h.destroy(),null===(u=this._controlBarNavigation)||void 0===u||u.destroy(),this._controlBarNavigation=null,this._mainDiv&&(this._onWheelBound&&this._mainDiv.removeEventListener("wheel",this._onWheelBound),this._mainDiv.remove()),null===(p=this._timeAxisWidget)||void 0===p||p.destroy(),this._timeAxisWidget=null,null===(_=this._definitionsViewModel)||void 0===_||_.destroy()}title(){return n.t(null,void 0,i(639950))}emulateCriticalError(){this._chartSession.removeSeries("-1")}chartSession(){return this._chartSession}onDisconnected(){
return this._disconnected}onReconnectBailout(){return this._reconnectBailout}onConnected(){return this._connected}chartWidgetInitialized(){return this._chartWidgetInitialized}setBarsButton(e){this._barsButton=e}setVisibleTimeRange(e,t,i,s){throw new Error("Not implemented")}chartWidgetCollection(){return this._chartWidgetCollection}isInitialized(){return this._inited}lineToolsSynchronizer(){return this._lineToolsSynchronizer}actions(){return null===this._actions?this._setActions():this._actions}defaultSymbol(){return this._defSymbol}requestFullscreen(){this.getResizerDetacher().requestFullscreen()}exitFullscreen(){this.getResizerDetacher().exitFullscreen()}inFullscreen(){return this.getResizerDetacher().fullscreen.value()}modelCreated(){return this._modelCreated}containsStudyByPredicate(e){return!!this._model&&this._model.dataSources().some((t=>!!(0,ct.isStudy)(t)&&e(t.metaInfo())))}model(){return(0,s.ensureNotNull)(this._model)}id(){return this._id}layoutId(){return this._chartWidgetCollection.metaInfo.uid.value()}properties(){return this._properties}readOnly(){return Boolean(this._options.readOnly)}isActive(){return this._isActive.readonly()}isHovered(){return this._isHovered.readonly()}crossHairSyncEnabled(){return this._chartWidgetCollection.lock.crosshair.value()}isVisible(){return this._isVisible.value()}setVisible(e){this._isVisible.setValue(e)}visible(){return this._isVisible.readonly()}isCollapsed(){return this._collapsed.value()}setCollapsed(e){this._collapsed.setValue(e)}collapsed(){return this._collapsed.readonly()}isJustClonedChart(){return!!(this._options||{}).justCloned}removeAllDrawingTools(){this.model().removeAllDrawingTools()}removeAllStudies(){this.model().removeAllStudies()}removeAllStudiesDrawingTools(){this.model().removeAllStudiesAndDrawingTools()}removeSelectedSources(){this.removeDataSources(this.model().selection().dataSources())}removeDataSources(e){const t=this.model(),i=e.filter((e=>e!==t.mainSeries()&&e!==t.lineBeingCreated()&&e.isUserDeletable()));if(0===i.length)return;let o=null;(0,ct.isStudy)(i[0])&&((0,s.assert)(1===i.length,"Cannot remove several studies (no multi select for studies)"),o=i[0]);i.find((e=>e.hasAlert().value()))?(0,Hl.confirmDatasourceRemoving)().then((e=>{e&&t.removeSelectedSources()})):o&&o.hasChildren()?(0,Ve.showDeleteStudyTreeConfirm)((()=>{t.removeSelectedSources()})):t.removeSelectedSources()}getSymbol(e){var t,i,s,o;let r;return r=this._model?this._model.mainSeries().properties().childs():this.properties().childs().mainSeriesProperties.childs(),r?e&&r.shortName&&r.shortName.value()?null!==(i=null===(t=r.shortName)||void 0===t?void 0:t.value())&&void 0!==i?i:"":null!==(o=null===(s=r.symbol)||void 0===s?void 0:s.value())&&void 0!==o?o:"":""}setSymbol(e){this._model?(this._symbolWV.setValue(e),this._model.setSymbol(this._model.mainSeries(),e)):(this.properties().childs().mainSeriesProperties.merge({symbol:e}),this._symbolWV.setValue(e),this._setSymbolIntervalContentOverrides.symbol=e)}setResolution(e){this._model?(this._resolutionWV.setValue(e),
this._model.setResolution(this._model.mainSeries(),e)):(this.properties().childs().mainSeriesProperties.merge({interval:e}),this._resolutionWV.setValue(e),this._setSymbolIntervalContentOverrides.interval=e)}getResolution(){return this._model?this._model.mainSeries().properties().childs().interval.value():this.properties().childs().mainSeriesProperties.childs().interval.value()}symbolWV(){return this._symbolWV.readonly()}resolutionWV(){return this._resolutionWV.readonly()}loadRange(e){if(this._model){this.screen.show();this._model.loadRange(e)||this.screen.hide()}}async showGeneralChartProperties(e,t){if(!d.enabled("show_chart_property_page"))return Promise.resolve(null);const s=await this._showChartProperties(this.model().mainSeries(),e,{doNotCloseOnBgClick:!0,onResetToDefault:async()=>{this.model().restorePreferences();const e=await Promise.all([i.e(6113),i.e(83767)]).then(i.bind(i,429874)),t=e.getCurrentTheme().name;e.loadTheme(this.chartWidgetCollection(),{themeName:t,standardTheme:!0})},shouldReturnFocus:null==t?void 0:t.shouldReturnFocus});if(null===s)return null;const o=()=>{s.hide(),this._chartWidgetCollection.activeChartWidget.unsubscribe(o)};return this._chartWidgetCollection.activeChartWidget.subscribe(o),s}showChartPropertiesForSource(e,t,i,s){return d.enabled("property_pages")&&e.userEditEnabled()?e===this.model().model().mainSeries()?this.showGeneralChartProperties(t):((i=i||{}).onResetToDefault=()=>{((0,ut.isLineTool)(e)||(0,ct.isStudy)(e))&&this.model().restorePropertiesForSource.bind(this._model,e)},this._showChartProperties(e,t,i,s)):Promise.resolve(null)}toggleCompareOrAdd(){this._compareDialog.visible().value()?this._compareDialog.hide():this._compareDialog.show()}tags(){return this._model?this._model.calculateDefaultTags():[]}options(){return this._options}ownerDocument(){return(0,s.ensureNotNull)(this._parent).ownerDocument}async showChartPropertiesForSources(e){if(!d.enabled("property_pages"))return Promise.resolve(null);const{sources:t,title:o,tabName:r,renamable:a}=e,l=(0,s.ensureNotNull)(this._model),c=tt(t.map((e=>e.properties().childs()))),h=tt(t.map((e=>e.properties().childs().intervalsVisibilities))),[{createPropertyPage:u},{getSelectionStylePropertiesDefinitions:p},{getSelectionIntervalsVisibilitiesPropertiesDefinition:_},{getSelectionCoordinatesPropertyDefinition:m}]=await Promise.all([Promise.all([i.e(16119),i.e(10196),i.e(22093),i.e(96501),i.e(18537)]).then(i.bind(i,290590)),Promise.all([i.e(16119),i.e(10196),i.e(22093),i.e(96501),i.e(18537)]).then(i.bind(i,39634)),Promise.all([i.e(16119),i.e(10196),i.e(22093),i.e(96501),i.e(18537)]).then(i.bind(i,797822)),Promise.all([i.e(16119),i.e(10196),i.e(22093),i.e(96501),i.e(18537)]).then(i.bind(i,848071))]);return async function(e){
const{SourcesPropertiesEditorRenderer:t}=await Promise.all([i.e(3618),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(29800),i.e(65857),i.e(23141),i.e(36010),i.e(95083),i.e(29296),i.e(62234),i.e(72197),i.e(43362),i.e(88015),i.e(22106),i.e(30422),i.e(16356),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(22602),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(44066),i.e(75364),i.e(8222),i.e(77414),i.e(33828),i.e(79412),i.e(80089),i.e(25983),i.e(42513),i.e(16182),i.e(31085),i.e(82440),i.e(90303),i.e(24474),i.e(89255),i.e(62319),i.e(2573),i.e(12400),i.e(78687),i.e(48694),i.e(41682),i.e(38790),i.e(79184),i.e(91068),i.e(18973),i.e(54786),i.e(1833),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(82311),i.e(62107),i.e(83147),i.e(75560),i.e(66144),i.e(5428),i.e(59490),i.e(53418),i.e(89178),i.e(26904),i.e(44158),i.e(83635),i.e(55736),i.e(87637),i.e(46780)]).then(i.bind(i,578569)),s=new t(e);return null!==$e&&($e.hide(),$e=s),s.show(),s}({sources:t,propertyPages:[u(p(c,l),"style",n.t(null,void 0,i(492516))),u({definitions:[m(t,l)]},"displacement",n.t(null,void 0,i(970132))),u(_(h,l),"visibility",n.t(null,void 0,i(640091)))],undoModel:l,title:o,activeTabId:r,renamable:a})}getPriceAxisWidthChangedByName(e){return"left"===e?this._lhsPriceAxisWidthChanged:this._rhsPriceAxisWidthChanged}getPriceAxisMaxWidthByName(e){return"left"===e?this._lhsAxesWidth:this._rhsAxesWidth}timeAxisHeight(){return null!==this._timeAxisWidget?this._timeAxisWidget.size.height:0}withModel(e,t){null!==this._model?t.call(e):this.modelCreated().subscribe(e,t,!0)}hasModel(){return null!==this._model}updateActions(){const e=this.actions(),t=this.model().dataSources();let s=!1,o=!1;for(let e=0,i=t.length;e<i;e++){const i=t[e];(0,ut.isLineTool)(i)&&i.isUserDeletable()&&(s=!0),((0,ct.isStudy)(i)&&i.removeByRemoveAllStudies()||(0,ct.isStudyStub)(i))&&(o=!0)}this.readOnly()||(e.paneRemoveAllStudies&&e.paneRemoveAllStudies.update({disabled:!o}),e.paneRemoveAllDrawingTools&&e.paneRemoveAllDrawingTools.update({disabled:!s}),e.paneRemoveAllStudiesDrawingTools&&e.paneRemoveAllStudiesDrawingTools.update({disabled:!o&&!s}));!((0,ql.showThemeSwitcher)()||(0,ql.showThemeAction)()||window.is_authenticated)||async function(e){const[t,s]=await Promise.all([Promise.all([i.e(6113),i.e(83767)]).then(i.bind(i,429874)),Promise.all([i.e(6113),i.e(83767)]).then(i.bind(i,867432))]),o=async o=>{const r=[];if(window.is_authenticated){r.length&&r.push(new gi.Separator);const t=new gi.Action({actionId:"Chart.Theme.SaveAs",options:{name:"theme-save-as",label:(0,Ul.appendEllipsis)(n.t(null,void 0,i(276266))),onExecute:()=>s.showThemeSaveDialogAsync(e.model().model().theme())}});r.push(t)}o&&o.length&&window.is_authenticated&&(r.length&&r.push(new gi.Separator),o.forEach((i=>{const o=new gi.Action({actionId:"Chart.Theme.Apply.Custom",options:{label:(0,zl.clean)(t.translateStdThemeName(i)),
checkable:!1,onExecute:()=>{t.loadTheme(e.chartWidgetCollection(),{themeName:i,standardTheme:!1}).then((()=>{window.saver.saveChartSilently(),(0,Ne.trackEvent)("GUI","Switch to custom theme")}))},toolbox:{type:Gl.ToolboxType.Delete,action:()=>s.showRemoveThemeDialogAsync(i)},showToolboxOnHover:!0}});r.push(o)})));const a=e.actions();a.applyColorTheme&&a.applyColorTheme.update({subItems:r,disabled:0===r.length})};window.is_authenticated?t.getThemeNames().then(o):o()}(this);const r=[],a=Qe.availableTimezones,l=e=>e.id===this.model().model().properties().childs().timezone.value();if(a.forEach((e=>{const t=new gi.Action({actionId:"Chart.ChangeTimeZone",options:{label:e.title,checkable:!0,checked:l(e),statName:"SetTimeZone",onExecute:()=>{this.model().setProperty(this.model().model().properties().childs().timezone,e.id,dd)}}});r.push(t)})),e.applyTimeZone.update({subItems:r}),e.addToWatchlist||e.addToTextNotes){const[,t]=(0,rd.splitSymbolName)(this.symbolWV().value());if(e.addToWatchlist){const i=e.addToWatchlist;i.request(),i.updateLabel(t)}e.addToTextNotes&&e.addToTextNotes.update({label:n.t(null,void 0,i(339873)).format({symbol:t})})}e.moveChartAction&&e.moveChartAction.update({disabled:!this._chartWidgetCollection.activeChartCanBeMoved()})}onRedraw(){return this._redraw}copyLineToOtherCharts(){const e=(0,s.ensureNotNull)(this._model),t=e.selection().lineDataSources().filter((e=>e.isSynchronizable()));e.model().copyToOtherCharts(t,!0)}toggleLockSelectedObject(){const e=this.model();e.selection().lineDataSources().forEach((t=>{const i=t.properties().frozen.value();e.setProperty(t.properties().frozen,!i,(i?hd:ud).format({title:new c.TranslatedString(t.name(),t.title(io.TitleDisplayTarget.StatusLine))}),co.lineToolsDoNotAffectChartInvalidation)}))}hideDataSources(e){if(e.length){const t=e.map((e=>e.properties().visible)),i=e.map((()=>!1));this.model().setProperties(t,i,cd.format({title:new c.TranslatedString(e[0].name(),e[0].title(io.TitleDisplayTarget.StatusLine))}))}}hideSelectedObject(){this.hideDataSources(this.model().selection().dataSources().filter((e=>!(0,hi.isAlertLabel)(e))))}unlinkSelectedLine(){const e=(0,s.ensureNotNull)(this._model),t=e.selection().lineDataSources();e.unlinkLines(t)}paneWidgets(){return this._paneWidgets}paneByState(e){for(let t=0;t<this._paneWidgets.length;t++)if(this._paneWidgets[t].state()===e)return this._paneWidgets[t];return null}paneByCanvas(e){for(let t=0;t<this._paneWidgets.length;t++)if(this._paneWidgets[t].hasCanvas(e))return this._paneWidgets[t];return null}timeAxisByCanvas(e){var t;return(null===(t=this._timeAxisWidget)||void 0===t?void 0:t.hasCanvas(e))?this._timeAxisWidget:null}selectPointMode(){return(0,s.ensureNotNull)(this._model).model().selectPointMode()}cancelRequestSelectPoint(){const e=(0,s.ensureNotNull)(this._model).model();e.cancelRequestSelectPoint(),e.setReplayStatus(e.isInReplay().value()?3:0),e.clearCurrentPosition()}requestSelectPoint(e,t){const i=(0,s.ensureNotNull)(this._model)
;return e.selectPointMode===Yt.SelectPointMode.Replay&&i.model().setReplayStatus(1),new Promise(((s,o)=>{const r=()=>!!this.isVisible()||(o("Chartwidget must be visible"),this.cancelRequestSelectPoint(),!1);if(!r())return;(0,Yt.resetToCursor)(!0),i.lineBeingCreated()&&i.cancelCreatingLine();let n=!1;const a={};i.model().onPointSelected().subscribe(a,((e,t)=>{n=!0,this._isVisible.unsubscribe(r),this._hideHint(),s({point:e,pane:t})}),!0),i.model().requestSelectPoint(e),this.startTrackingMode(),void 0!==t&&this._showEventHint(t),this._isVisible.subscribe(r),this.selectPointMode().subscribe((()=>{setTimeout((()=>{n||(this.selectPointMode().value()===Yt.SelectPointMode.None&&this._hideHint(),i.model().onPointSelected().unsubscribeAll(a),this._isVisible.unsubscribe(r),o("cancelled"))}))}),{once:!0})}))}showReplayOrderConfirmationDialog(){return this.model().isInReplay().value()?new Promise(((e,t)=>{(0,Nl.showConfirm)({text:n.t(null,void 0,i(777017)),onConfirm:t=>{e(),t.dialogClose()},onClose:t})})):Promise.resolve()}showSourceProperties(e,t){e===this.model().mainSeries()&&(t=at.TabNames.symbol),this.showChartPropertiesForSource(e,t)}onScroll(){return this._onScroll}onZoom(){return this._onZoom}onTagsChanged(){return this._tagsChanged}onWidget(){return this._onWidget}containsVolume(){return this.model().dataSources().some((e=>(0,ct.isStudy)(e)&&"Volume"===e.metaInfo().shortId))}containsStudy(e){return this.containsStudyByPredicate((t=>t.id===e||t.fullId===e))}isSmall(){return this._width()<550||this._height()<300}onCmeWidget(){return"cme"===this._widgetCustomer}widgetCustomer(){return this._widgetCustomer}compareSymbols(){return this._compareSymbols}images(e){window.TradingView.printing=!0;const t=this.model().selection().allSources();this.model().selectionMacro((e=>e.clearSelection())),this.model().model().recalculateAllPanes((0,hs.globalChangeEvent)());const i=(t,i)=>{t.paint(i);const s={showCollapsedStudies:Boolean(null==e?void 0:e.showCollapsedStudies),status:null==e?void 0:e.status};return t.getScreenshotData(s)},s=[];if(null!==this._maximizedPaneWidget){const e=this._paneWidgets.indexOf(this._maximizedPaneWidget);s.push(i(this._maximizedPaneWidget,B.InvalidationMask.light().invalidateForPane(e)))}else for(let e=0;e<this._paneWidgets.length;++e){const t=this._paneWidgets[e];s.push(i(t,B.InvalidationMask.light().invalidateForPane(e))),e<this._paneWidgets.length-1&&s.push(this._paneSeparators[e].image())}let o;this._timeAxisWidget&&(this._timeAxisWidget.paint(B.InvalidationLevel.Light),o=this._timeAxisWidget.getScreenshotData()),window.TradingView.printing=!1,this.model().selectionMacro((e=>{t.forEach((t=>{e.addSourceToSelection(t)}))})),this.model().model().recalculateAllPanes((0,hs.globalChangeEvent)()),this.model().model().lightUpdate();const r=this.mainSeriesQuotesAndMetainfo();return{panes:s,timeAxis:o,colors:{text:this.properties().childs().scalesProperties.childs().textColor.value(),bg:this.properties().childs().paneProperties.childs().background.value(),
scales:this.properties().childs().scalesProperties.childs().lineColor.value()},meta:r.meta,ohlc:r.ohlc,quotes:r.quotes}}insertStudy(e,t,i,s,o){return this._insertStudyOrReplaceStub(e,t,void 0,i,s,o)}replaceStubByStudy(e,t,i,s,o,r){return e.updateDescriptor(t),this._insertStudyOrReplaceStub(t,i,e,s,o,r)}addOverlayStudy(e,t,i){const s=this.model();return this._options&&this._options.isSymbolAvailable?this._options.isSymbolAvailable(e).then((async o=>{if(!o)return null;await(0,Ll.studyMetaInfoRepository)().requestMetaInfo();const r=s.createStudyInserter({type:"java",studyId:"Overlay@tv-basicstudies"},[]),n={allowExtendTimeScale:i};if(d.enabled("use_overrides_for_overlay")){const e=(0,yn.factoryDefaults)("study_Overlay@tv-basicstudies.style");n.style=e}return r.setPropertiesState(n),r.setForceOverlay(t),r.insert((()=>Promise.resolve({inputs:{symbol:e},parentSources:[]})))})):Promise.resolve(null)}addCompareStudy(e){const t=this.model();return this._options&&this._options.isSymbolAvailable?this._options.isSymbolAvailable(e).then((async i=>i?(await(0,Ll.studyMetaInfoRepository)().requestMetaInfo(),t.createStudyInserter({type:"java",studyId:"Compare@tv-basicstudies"},[]).insert((()=>Promise.resolve({inputs:{symbol:e},parentSources:[]})))):null)):Promise.resolve(null)}showIndicators(e,t){if(window.studyMarket)return window.studyMarket.visible().value()?void window.studyMarket.hide():(window.studyMarket.show(e,t),window.studyMarket)}setSaveChartService(e){this._saveChartService=e,null!==this._lineToolsSynchronizer&&this._lineToolsSynchronizer.setSaveChartService(e)}getSaveChartService(){return this._saveChartService}mainSeriesQuotesAndMetainfo(){let e,t,i;const s=this._model&&this._model.mainSeries();if(s){const o=e=>null==e?"":s.formatter().format(e,{signNegative:!0,useRtlFormat:!1}),r=e=>null==e?"":e+"";e={resolution:s.interval(),symbol:s.symbol(),values:s.legendValuesProvider().getValues(null)};const n=s.symbolInfo();n&&(e.symbol=n.full_name,e.description=n.description,e.exchange=n.exchange);const a=s.bars().last();null!==a&&(t=a.value.slice(1,5).map(o));const l=s.quotes();l&&(i={change:o(l.change),changePercent:r(l.change_percent),last:o(l.last_price)})}return{meta:e,ohlc:t,quotes:i}}isMultipleLayout(){return this._isMultipleLayout}updateCrossHairPositionIfNeeded(){if(this._model){const e=Yt.tool.value();this._model.model().setCurrentTool(e);const t=(0,At.lastMouseOrTouchEventInfo)();if(t.isTouch){const e=this._maximizedPaneWidget||this._paneWidgets[0];if(e.hasState()&&(!t.stylus&&(this._isLineToolModeExceptBrush()||(0,Yt.toolIsMeasure)(Yt.tool.value()))||this.selectPointMode().value()!==Yt.SelectPointMode.None)){const t=.5*this._model.model().timeScale().width(),i=.5*e.state().defaultPriceScale().height();e.setCursorPosition(t,i)}const i=this._model.model().crossHairSource();i.updateAllViews((0,hs.sourceChangeEvent)(i.id()))}}}trackingModePaneWidget(){if(!(0,At.lastMouseOrTouchEventInfo)().isTouch)return null;for(const e of this.paneWidgets())if(e.trackingModeEnabled())return e;return null}startTrackingMode(){if((0,
At.lastMouseOrTouchEventInfo)().isTouch){this.exitTrackingMode(),this.updateCrossHairPositionIfNeeded();const e=this._maximizedPaneWidget||this._paneWidgets[0],t=this.model().model().crossHairSource().currentPoint();e.startTrackingMode(t,t)}}exitTrackingMode(){(0,At.lastMouseOrTouchEventInfo)().isTouch&&this.paneWidgets().some((e=>e.trackingModeEnabled()))&&(this.paneWidgets().forEach((e=>e.exitTrackingMode())),this.model().model().clearCurrentPosition())}onToolChanged(){const e=this.model().model();e.lineBeingCreated()&&!e.lineBeingCreateFromExternal()&&this._cancelCreatingLine(),this.selectPointMode().value()!==Yt.SelectPointMode.None&&this.cancelRequestSelectPoint(),this.exitTrackingMode()}setInLoadingState(e){this._inLoadingState=e}paint(e){const t=null!=e?e:B.InvalidationMask.full();t.validationActions().forEach((e=>e())),this._paneWidgets.forEach(((e,i)=>{null!==this._maximizedPaneWidget&&this._maximizedPaneWidget!==e||e.paint(t.invalidateForPane(i))})),this._timeAxisWidget&&this._timeAxisWidget.paint(t.invalidateForTimeScale()),null==pd||pd(),this._redraw.fire()}GUIResetScales(){(0,Ne.trackEvent)("GUI","Reset Scales"),null!==this._model&&this._model.resetScales()}applyOverrides(e){const t={};for(const[i,s]of Object.entries(e))i.startsWith("mainSeriesProperties.priceAxisProperties")||(t[i]=s);if((0,yn.applyPropertiesOverrides)(this.properties(),void 0,!1,t,void 0),this._model){(0,yn.applyPropertiesOverrides)(this._model.model().properties(),void 0,!1,t),(0,yn.applyPropertiesOverrides)(this._model.mainSeries().properties(),void 0,!1,t,"mainSeriesProperties"),this._model.model().sessions().callFunction((e=>e.applyOverrides(t)));const e=this._model.model().watermarkSource();null!==e&&e.applyOverrides(t)}}showFundamentals(e){this.showIndicators(e?[e]:void 0,"financials")}toggleMaximizePane(e){var t;if(!(this._paneWidgets.length<2)){this._maximizedPaneWidget?(this._maximizedPaneWidget.state().maximized().setValue(!1),this._maximizedPaneWidget=null,this._paneSeparators.forEach((e=>e.show()))):(this._maximizedPaneWidget=e,this._maximizedPaneWidget.state().maximized().setValue(!0),this._paneSeparators.forEach((e=>e.hide())));for(let e=this._paneWidgets.length;e--;)this._paneWidgets[e].updateControls(),this._paneWidgets[e].updatePriceAxisWidgetsStates();this._errorRenderer.updatePaneWidgets(),null===(t=this._timeAxisWidget)||void 0===t||t.updatePriceAxisStubs(),this._adjustSize(),this.updateCrossHairPositionIfNeeded()}}maximizedPaneWidget(){return this._maximizedPaneWidget}isMaximizedPane(){return null!==this._maximizedPaneWidget}setActive(e){(0,At.lastMouseOrTouchEventInfo)().isTouch&&(e&&this.selectPointMode().value()!==Yt.SelectPointMode.None?this.startTrackingMode():this.exitTrackingMode());for(const e of this._paneWidgets)e.update();e||this.model().selectionMacro((e=>{e.clearSelection()})),this._isActive.setValue(e)}justActivated(){return this._justActivated}unsetActivePaneWidget(){this.activePaneWidget=null}setActivePaneWidget(e){this.activePaneWidget=e}onPaneWidgetDestroyed(e){
this.activePaneWidget===e&&(this.activePaneWidget=null)}getResizerDetacher(){return this._options}toggleFullscreen(){const e=this.getResizerDetacher();e.fullscreenable.value()&&(e.fullscreen.value()?e.exitFullscreen():e.requestFullscreen())}generalPropertiesDefinitions(){return this._getChartPropertyDefinitionsViewModel().then((e=>e.propertyPages()))}propertiesDefinitionsForSource(e){return(0,ut.isLineTool)(e)||(0,ct.isStudy)(e)||(0,ut.isStudyLineTool)(e)?e.getPropertyDefinitionsViewModel().then((e=>null===e?null:e.propertyPages())).catch((e=>(nd.logWarn(e),null))):Promise.resolve(null)}backgroundTopTheme(){return this._backgroundTopTheme.readonly()}backgroundBasedTheme(){return this._backgroundBasedTheme.readonly()}backgroundBottomTheme(){return this._backgroundBottomTheme.readonly()}state(e,t,i,s){if(this._model){const o=this._model.state(e,t,i,s);return o.chartId=this.id(),o}return this._content}lineToolsAndGroupsDTO(){return(0,s.ensureNotNull)(this._lineToolsSynchronizer).prepareDTO()}resetLineToolsInvalidated(e,t,i){(0,s.ensureNotNull)(this._lineToolsSynchronizer).resetInvalidated(e,t,i)}applyLineToolUpdateNotification(e,t){(0,s.ensureNotNull)(this._lineToolsSynchronizer).applyLineToolUpdateNotification(e,t)}reloadAllLineTools(){(0,s.ensureNotNull)(this._lineToolsSynchronizer).reloadAllLineTools()}startApplyingLineToolUpdateNotification(){var e;null===(e=this._lineToolsSynchronizer)||void 0===e||e.startApplyingLineToolUpdateNotification()}endApplyingLineToolUpdateNotification(){var e;null===(e=this._lineToolsSynchronizer)||void 0===e||e.endApplyingLineToolUpdateNotification()}applyAlertIdByExternalSource(e,t){var i;null===(i=this._lineToolsSynchronizer)||void 0===i||i.applyAlertIdByExternalSource(e,t)}deleteAlertByExternalSource(e,t){var i;null===(i=this._lineToolsSynchronizer)||void 0===i||i.deleteAlertByExternalSource(e)}shouldBeSavedEvenIfHidden(){return this._model?this.model().model().shouldBeSavedEvenIfHidden():!!this._options.content.shouldBeSavedEvenIfHidden}getTimeScale(){return this._timeAxisWidget}showObjectsTreePanelOrDialog(){let e=!1;const t=window.widgetbar;if(t&&t.isVisible()){const i=(0,s.ensureNotNull)(t.setPage("object_tree")),o=(0,s.ensureNotNull)(i.widget("object_tree"));(0,s.ensureDefined)(o.properties).setValue({selectedPage:"object_tree"}),e="object_tree"===i.name}e||this.showObjectsTreeDialog()}showObjectsTreeDialog(){var e;null===(e=this._objectTreeDialogController)||void 0===e||e.show()}addCustomWidgetToLegend(e,t){this._customLegendWidgetsFactoryMap.set(e,t);for(const i of this.paneWidgets())i.addCustomWidgetToLegend(e,t)}applyIndicatorsToAllChartsAvailable(){if(!this.chartWidgetCollection().applyIndicatorsToAllChartsAvailable())return!1;for(const e of this.model().model().panes()){if(e.sourcesByGroup().all().some((e=>(0,ct.isStudy)(e)&&!(0,ht.isLollipopDataSource)(e))))return!0}return!1}widget(){return(0,s.ensureNotNull)(this._mainDiv)}restoreState(e,t,o){this._adjustSize();const r=(0,
s.ensureNotNull)(this._model),n=r.restoreState(this._content,t,o),a=r.mainSeries().properties().childs();this._symbolWV.setValue(a.symbol.value()),this._resolutionWV.setValue(a.interval.value()),n&&n.lines_limit_exceeded&&!this.readOnly()&&Promise.all([i.e(68234),i.e(42810),i.e(96645),i.e(10417),i.e(91797),i.e(61135),i.e(59355),i.e(86021),i.e(25977),i.e(64133),i.e(46086),i.e(90609)]).then(i.bind(i,316800)).then((({showLinetoolsLimitExceededDialog:e})=>{e(this)}))}addCompareAsOverlay(e,t,i){const o=this.model();return(0,s.ensureDefined)(this._options.isSymbolAvailable)(e).then((async s=>{if(!s)return null;await(0,Ll.studyMetaInfoRepository)().requestMetaInfo();const r=o.createStudyInserter({type:"java",studyId:"Overlay@tv-basicstudies"},[]);return r.setForceOverlay(!0),r.setPreferredPriceScale("as-series"),!0!==i&&r.setTargetPriceScaleMode({percentage:!0}),void 0!==t&&r.setPropertiesState({allowExtendTimeScale:t}),r.insert((async()=>({inputs:{symbol:e},parentSources:[]})))}))}scrollHelper(){return this._scrollHelper}resize(){const e=this._height()+"px",t=this._width()+"px",i=(0,s.ensureNotNull)(this._mainDiv);i.style.height=e,i.style.width=t,this._elMainTable.style.height=e,this._elMainTable.style.width=t,this._resizeHandler&&this._mainDiv&&this._resizeHandler()}chartPainted(){return this._drawPlanned?(null===this._chartPaintedPromise&&(this._chartPaintedPromise=(0,We.createDeferredPromise)()),this._chartPaintedPromise.promise):Promise.resolve()}setDataWindowWidget(e){this._dataWindowWidget=e}removeDataWindowWidget(){this._dataWindowWidget=null}showSelectedSourcesProperties(e){const t=(0,s.ensureNotNull)(this._model).selection().dataSources();if(1===t.length)this.showSourceProperties(t[0],e);else{const i=t.filter(ut.isLineTool);i.length>0&&this.showChartPropertiesForSources({sources:i,tabName:e})}}setTimingsMeter(e){this._timingsMeter=e,this._updateTimingsMeterState()}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}executeActionById(e){if("takeScreenshot"===e)return console.warn('Action "takeScreenshot" is deprecated. Use method "takeScreenshot" instead'),void this._chartWidgetCollection.takeScreenshot();const t=this.actions()[e];t?t.execute():console.warn("Unknown action id: "+e)}getCheckableActionState(e){const t=this.actions()[e];if(t){if(t.isCheckable())return t.isChecked();console.warn("Action "+e+" has no state")}else console.warn("Unknown action id: "+e);return null}connect(){this._chartSession.isConnected().subscribe(this._onChartSessionIsConnectedChanged),this._chartSession.criticalError().subscribe(this,this._onChartSessionCriticalError),this._chartSession.connect(this._onData.bind(this))}finishInitWithoutConnect(){this._chartSession.disable(),this._init(),this._chartWidgetInitialized.fire()}reconnect(){this._chartSession.disconnect(),this._chartSession.connect()}update(){if(this.hasModel()){for(const e of this._paneWidgets)e.update();this._timeAxisWidget&&this._timeAxisWidget.update()}}setPriceAxisHovered(e,t){t?this._hoveredPriceAxes.add(e):this._hoveredPriceAxes.delete(e),
this._anyAxisHovered.setValue(this._hoveredPriceAxes.size>0)}anyPriceAxisHovered(){return this._anyAxisHovered.readonly()}linkingGroupIndex(){return this._linkingGroupIndex}offsetInDocument(e){const t=this._paneWidgets.find((t=>t.state()===e));if(void 0===t)return{left:NaN,top:NaN};const i=t.getElement().getBoundingClientRect();return{left:Math.round(i.left+document.body.scrollLeft),top:Math.round(i.top+document.body.scrollTop)}}showHint(e,...t){0===e?this._showEventHint(...t):1===e&&this._showWarningHint(...t)}hotkeys(){return this._hotkeys}loadContent(e,t){this.screen.show();const i=this.model();this.isMaximizedPane()&&this.toggleMaximizePane(null);const s=i.model().dataSources(),o=i.mainSeries(),r=i.crossHairSource();r.clearMeasure();for(let e=0;e<s.length;e++){const t=s[e];t!==o&&t!==r&&i.model().removeSource(t,!0)}let n,a;i.model().disconnect(),this.activePaneWidget=null,o.purgeSymbolInfo(),e.loading=!0,this._content=e,this._setSymbolIntervalContentOverrides={},this._initialLoading=t;const l=this._contentSeriesProperties();if(l&&(n=l,a=e.chartProperties.priceScaleSelectionStrategyName),!n)throw Error("An error occured while determining main series ion the chart");this._properties.childs().mainSeriesProperties.mergeAndFire({visible:!0,symbol:n.symbol,timeframe:"",interval:n.interval||"D",style:n.style}),void 0!==a&&this._properties.childs().priceScaleSelectionStrategyName.setValue(a),this._init(),i.undoHistory().clearStack()}resetDrawingState(){var e,t,i;(0,Yt.resetToCursor)(!0);const o=(0,s.ensureNotNull)(null!==(t=null===(e=this._model)||void 0===e?void 0:e.crossHairSource().pane)&&void 0!==t?t:null);(0,s.ensureNotNull)(this.paneByState(o)).cancelCreatingLineTool(),null===(i=this._model)||void 0===i||i.selectionMacro((e=>{e.clearSelection()}))}_clearSelectionHotkey(){return{desc:"Cancel selection",hotkey:27,handler:()=>{var e,t,i,s,o;if(this._checkIsTradedGroupSelected()&&(null===(e=(0,pa.tradingService)())||void 0===e||e.clearTradedContextLinking()),this.selectPointMode().value()!==Yt.SelectPointMode.None)return this.selectPointMode().value()===Yt.SelectPointMode.Replay&&this._chartWidgetCollection.getAll().forEach((e=>{e!==this&&e.selectPointMode().value()===Yt.SelectPointMode.Replay&&e.cancelRequestSelectPoint()})),void this.cancelRequestSelectPoint();null===(t=this._model)||void 0===t||t.selectionMacro((e=>{this._cancelCreatingLine(),e.clearSelection()}));const r=null===(i=this._model)||void 0===i?void 0:i.model().customSourceMovingHitTestData();r&&r.cancelMoveHandler&&r.cancelMoveHandler()&&(r.cancelled=!0,null===(s=this._model)||void 0===s||s.model().setMovingCustomSource(null,null),null===(o=this._model)||void 0===o||o.model().lightUpdate())},isDisabled:()=>{const e=this._model;if(!e)return!0;const t=0===e.selection().allSources().length,i=null===e.crossHairSource().measurePane().value(),s=this.selectPointMode().value()===Yt.SelectPointMode.None;return t&&i&&s}}}_insertStudyOrReplaceStub(e,t,i,s,o,r){{const o=this.model().model().chartApi().canCreateStudy({id:"java"===e.type?e.studyId:"",
child:t.length>0,fundamental:null==s?void 0:s.isFundamental});if(!o.success)return i&&this.model().model().removeSource(i,!0),oo(this.model().model(),o),Promise.resolve(null)}const n="java"===e.type;return new Promise((async a=>{if(0===t.length)return null==r||r(),n&&await(0,Ll.studyMetaInfoRepository)().requestMetaInfo(),void a(this._insertOrReplaceStubByStudyImpl(e,t,i,s,o));window.runOrSignIn((async()=>{null==r||r(),n&&await(0,Ll.studyMetaInfoRepository)().requestMetaInfo(),a(this._insertOrReplaceStubByStudyImpl(e,t,i,s,o))}),{source:"study on study"})})).catch((()=>null))}_insertOrReplaceStubByStudyImpl(e,t,o,r,a){const l=(0,s.ensureNotNull)(this._model).createStudyInserter(e,t,r);l.setForceOverlay("java"===e.type&&"Volume@tv-basicstudies"===e.studyId&&d.enabled("volume_force_overlay"));const c=l.insert(((e,i,s)=>new Promise(((o,r)=>{this.selectPointMode().value()!==Yt.SelectPointMode.None&&this.cancelRequestSelectPoint(),a?o(a(e,i,s)):(0,ct.isSymbolicStudy)(s)?((0,Ne.trackEvent)("GUI","Confirmation dialogs","Symbol confirmation dialog"),Ye(this,e,s,o,r,"symbol")):(0,ct.hasConfirmInputs)(i)?((0,Ne.trackEvent)("GUI","Confirmation dialogs","Inputs confirmation dialog"),Ye(this,e,s,o,r)):o({inputs:{},parentSources:t})}))),void 0,o);return c.then((()=>{(0,Yt.hideAllIndicators)().value()&&(0,ze.toggleHideMode)()})).catch((e=>{o||(e===Xl.InsertionErrorCode.StudyCannotBeChild&&(0,Bl.showNoticeDialog)({type:"modal",title:n.t(null,void 0,i(621064)),content:n.t(null,void 0,i(359519))}),e===Xl.InsertionErrorCode.CannotCompilePub&&(0,Bl.showNoticeDialog)({type:"modal",title:n.t(null,void 0,i(621064)),content:n.t(null,void 0,i(418260))}),e===Xl.InsertionErrorCode.CannotGetMetainfo&&(0,Bl.showNoticeDialog)({type:"modal",title:n.t(null,void 0,i(621064)),content:n.t(null,void 0,i(504509))}))})),c}async _showChartProperties(e,t,i,s){if(!this._model)return null;t&&((0,Be.setValue)("properties_dialog.active_tab.chart",t),i.tabName=t);const o=await mt(e,this._model,i,this._options.chartWidgetCollection,s);return(null==o?void 0:o.visible().value())?o:null}_createLineToolsSynchronizerIfNeeded(){var e;{const t={readOnlyMode:this.readOnly(),migrateSyncedLineTools:this===this._options.chartWidgetCollection.getAll()[0]},i=uc;this._lineToolsSynchronizer=new i({layoutId:this.layoutId(),chartId:this._id,clientId:this._chartWidgetCollection.clientId},this.model().model(),t),null!==this._saveChartService&&this._lineToolsSynchronizer.setSaveChartService(this._saveChartService),this._lineToolsSynchronizer.invalidateAll(),null===(e=this._model)||void 0===e||e.model().setLineToolsSynchronizer(this._lineToolsSynchronizer)}}_updateThemedColor(){const e=this.model().model(),t=e.backgroundColorAtYPercentFromTop(.5);let i=e.backgroundTopColor().value(),s=e.backgroundColor().value();const o=(0,Oe.isColorDark)(t),r=(0,Oe.isColorDark)(i),n=(0,Oe.isColorDark)(s);this.widget().classList.toggle("chart-widget--themed-dark",o),this.widget().classList.toggle("chart-widget--themed-light",!o),this.widget().classList.toggle("chart-widget__top--themed-dark",r),
this.widget().classList.toggle("chart-widget__top--themed-light",!r),this.widget().classList.toggle("chart-widget__bottom--themed-dark",n),this.widget().classList.toggle("chart-widget__bottom--themed-light",!n),this._backgroundTopTheme.setValue(r?"dark":"light"),this._backgroundBasedTheme.setValue(o?"dark":"light"),this._backgroundBottomTheme.setValue(n?"dark":"light"),i===s&&(0,Te.isStdThemedDefaultValue)("chartProperties.paneProperties.background",i,this._backgroundBasedTheme.value())&&(i=null,s=null);for(const e of this._paneWidgets)e.updateThemedColors({topColor:i,bottomColor:s})}_isLineToolModeExceptBrush(){const e=Yt.tool.value();return(0,U.isLineToolName)(e)&&!(0,U.isLineDrawnWithPressedButton)(e)&&this.selectPointMode().value()===Yt.SelectPointMode.None}_cancelCreatingLine(){const e=(0,s.ensureNotNull)(this._model).model(),t=e.lineBeingCreated();if(null!==t){const i=(0,s.ensureNotNull)(e.paneForSource(t));(0,s.ensureNotNull)(this.paneByState(i)).cancelCreatingLineTool(),t.toolname===Yt.tool.value()&&(0,Yt.resetToCursor)()}const i=e.crossHairSource().measurePane().value();if(null!==i){(0,s.ensureNotNull)(this.paneByState(i)).cancelMeasuring()}}_adjustSize(e){var t;let i=0;const s=null===this._model?null:this._model.model().priceScaleSlotsCount(),o=new Uint32Array(null===s?0:s.left),r=new Uint32Array(null===s?0:s.right),n=(0,Lt.getCanvasDevicePixelRatio)(document.body),a=(e,t)=>e+t,l=(e,t)=>{t.forEach(((t,i)=>{e[i]=Math.max(e[i],t)}))},c=this._width(),d=this._height(),h=this._paneSeparators.length,u=this.isMaximizedPane()?0:zt.height()*h,p=null!==this._timeAxisWidget?this._timeAxisWidget.optimalHeight():0;let _=d-p>=61?p:0;_%2&&(_+=1);const m=Math.max(1,Math.floor((d-u-_)/this._paneWidgets.length));let g=0,S=null;for(const e of this._paneWidgets)if(!this._maximizedPaneWidget||this._maximizedPaneWidget===e){e.leftPriceAxisesContainer().updateCurrencyLabels();const t=e.leftPriceAxisesContainer().optimalWidths();e.rightPriceAxisesContainer().updateCurrencyLabels();const s=e.rightPriceAxisesContainer().optimalWidths();l(o,t),l(r,s),this._maximizedPaneWidget!==e&&e.state().collapsed().value()?g+=Math.min(m,e.collapsedHeight()):(i+=e.stretchFactor(),S=e)}let v=o.reduce(a,0),f=r.reduce(a,0),b=Math.max(c-v-f,0);if(b<=102){v=0,f=0,b=c;for(let e=0;e<o.length;e++)o[e]=0;for(let e=0;e<r.length;e++)r[e]=0}for(const e of this._paneSeparators)e.adjustSize();const y=u+g+_,C=d<y?0:d-y,w=C/i;let T=0,P=!1;const M=null===(t=this._model)||void 0===t?void 0:t.model();for(let e=0;e<this._paneWidgets.length;++e){const t=this._paneWidgets[e];void 0!==M&&t.setState(M.panes()[e]);let i=0;if(this.isMaximizedPane())i=this._maximizedPaneWidget===t?C:0;else if(t.state().collapsed().value())i=Math.min(m,t.collapsedHeight());else{const e=t===S?Math.ceil((C-T)*n)/n:Math.round(t.stretchFactor()*w*n)/n;i=Math.max(e,2),T+=i}t.setPriceAxisSizes("left",i,o),t.setPriceAxisSizes("right",i,r),P=P||i!==t.height(),t.setSize((0,ke.size)({width:b,height:i})),M&&t.state()&&M.setPaneHeight(t.state(),i)}
null!==this._timeAxisWidget&&this._timeAxisWidget.setSizes((0,ke.size)({width:b,height:_}),o,r),M&&M.setWidth(b,e),this._controlBarNavigation&&this._controlBarNavigation.updatePosition(),this._lhsAxesWidth!==v&&(this._lhsAxesWidth=v,this._lhsPriceAxisWidthChanged.fire(v)),this._rhsAxesWidth!==f&&(this._rhsAxesWidth=f,this._rhsPriceAxisWidthChanged.fire(f)),P&&Le.emit("panes_height_changed")}_makePaneWidgetsAndSeparators(){const e=this.model().model().panes(),t=e.length,i=this._paneWidgets.length;for(let e=t;e<i;e++){(0,s.ensureDefined)(this._paneWidgets.pop()).destroy();const e=this._paneSeparators.pop();e&&e.destroy()}const o=this._options.containsData;for(let s=i;s<t;s++){const t={contextMenuEnabled:this._options.paneContextMenuEnabled,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,handleScale:this._options.handleScale,handleScroll:this._options.handleScroll,priceScaleContextMenuEnabled:this._options.priceScaleContextMenuEnabled,legendWidgetEnabled:this._options.legendWidgetEnabled,sourceStatusesWidgetEnabled:!o,sourceStatusesWidget:this._options.sourceStatusesWidget,marketStatusWidgetEnabled:this._options.marketStatusWidgetEnabled&&!o,chartWarningWidgetEnabled:this._options.chartWarningWidgetEnabled&&!o,chartWarningWidget:this._options.chartWarningWidget,dataProblemWidgetEnabled:this._options.dataProblemWidgetEnabled&&!o,legendWidget:this._options.legendWidget,propertyPagesEnabled:this._options.propertyPagesEnabled,sourceSelectionEnabled:this._options.sourceSelectionEnabled,controlsEnabled:this._options.paneControlsEnabled,croppedTickMarks:this._options.croppedTickMarks,countdownEnabled:this._options.countdownEnabled,customLegendWidgetFactories:new Map(this._customLegendWidgetsFactoryMap),useKineticScroll:this._options.useKineticScroll,pineSourceStatusEnabled:!this.readOnly()};void 0!==this._options.paneContextMenu&&(t.contextMenu=this._options.paneContextMenu),void 0!==this._options.priceScaleContextMenu&&(t.priceScaleContextMenu=this._options.priceScaleContextMenu);const i=new Ds(this,e[s],t,this._paneWidgetsSharedState);if(this._paneWidgets.push(i),s>0){const e=new zt(this,s-1,s);this._paneSeparators.push(e),this._timeAxisWidget?this._elMainTable.insertBefore(e.getElement(),this._timeAxisWidget.getElement()):this._elMainTable.appendChild(e.getElement())}this._timeAxisWidget?this._elMainTable.insertBefore(i.getElement(),this._timeAxisWidget.getElement()):this._elMainTable.appendChild(i.getElement())}for(let i=0;i<t;i++){const t=e[i],s=this._paneWidgets[i];s.hasState()&&s.state()===t?s.updatePriceAxisWidgetsStates():s.setState(t)}for(let e=t;e--;)this._paneWidgets[e].updateControls();this._errorRenderer.updatePaneWidgets(),this._updateThemedColor()}_width(){return this._options.width.value()}_height(){return this._options.height.value()}_update(e,t){var i,s;const o=e?e.fullInvalidation():B.InvalidationLevel.Full,r=!!e&&e.isVisibleTimeRangeLockedOnResize();if(null!==this._timingsMeter&&this._timingsMeter.startDraw(o),
o===B.InvalidationLevel.Full&&(this._model?this._updateGui(r):this._adjustSize(r)),o>B.InvalidationLevel.Cursor&&(null===(i=this._timeAxisWidget)||void 0===i||i.update(),this._paneWidgets.forEach((e=>{e.updatePriceAxisWidgets()})),this._applyTimeScaleInvalidations(e,t),(null===(s=this._invalidationMask)||void 0===s?void 0:s.fullInvalidation())===B.InvalidationLevel.Full&&(this._invalidationMask.merge(e),this._adjustSize(this._invalidationMask.isVisibleTimeRangeLockedOnResize()),this._applyTimeScaleInvalidations(this._invalidationMask,t),e=this._invalidationMask,this._invalidationMask=null)),this.paint(e),this._dataWindowWidget){const t=e.maxPaneInvalidation();t===B.InvalidationLevel.Full?this._dataWindowWidget.fullUpdate():t>B.InvalidationLevel.None&&this._dataWindowWidget.update()}for(let t=0;t<this._paneWidgets.length;t++)this._paneWidgets[t].updateStatusWidget(e.invalidateForPane(t));null!==this._timingsMeter&&this._timingsMeter.stopDraw(),e&&e.panesOrderInvalidated()&&Le.emit("panes_order_changed")}_initMaximizeHotkey(e){const t=e=>{if(e.defaultPrevented)return;(0,De.modifiersFromEvent)(e)===De.Modifiers.Alt&&e.stopPropagation()},i=e=>{if(e.defaultPrevented)return;(0,De.modifiersFromEvent)(e)===De.Modifiers.Alt&&(e.preventDefault(),e.stopPropagation(),this.toggleFullscreen())};return e.addEventListener("mousedown",t,!0),e.addEventListener("click",i,!0),()=>{e.removeEventListener("mousedown",t,!0),e.removeEventListener("click",i,!0)}}_onMousewheel(e){if(!this.model().model().zoomEnabled()||null===this._mouseWheelHelper)return;if(!(0,l.onWidget)()&&!ld&&parent&&parent!==window&&parent.IS_DEMO_PAGE)return;if(null===this._model)return;if(this.model().timeScale().isEmpty())return;const t=this._mouseWheelHelper.processWheel(e),i=t.deltaX,o=-t.deltaY;if(0!==i&&this._options.handleScroll.mouseWheel||0!==o&&this._options.handleScale.mouseWheel){if(e.cancelable&&e.preventDefault(),0!==o&&this._options.handleScale.mouseWheel){const t=Math.sign(o)*Math.min(1,Math.abs(o)),i=(0,s.ensureNotNull)(this._mainDiv).getBoundingClientRect(),r=e.clientX-this._lhsAxesWidth-i.left;if(!Number.isFinite(r)||!Number.isFinite(t))return void nd.logWarn("Incorrect mouse wheel processing: scrollPosition: "+r+", zoomScale: "+t);const n=new Kt.EnvironmentState(e).mod();this.model().model().zoomTime(r,t,!!n||void 0),this._onZoom.fire(n)}0!==i&&this._options.handleScroll.mouseWheel&&this.model().scrollChart(-80*i)}}_beginRequestActive(){const e=this._chartWidgetCollection.activeChartWidget.value()!==this;if(this._chartWidgetCollection.activeChartWidget.setValue(this),e){this._chartWidgetCollection.ariaDescribeChart(this._chartWidgetCollection.activeChartWidget.value());const e=(0,At.lastMouseOrTouchEventInfo)();e.isTouch&&!e.stylus&&this._isLineToolModeExceptBrush()&&this.updateCrossHairPositionIfNeeded(),this._justActivated=!0}}_endRequestActive(){this._justActivated&&setTimeout((()=>this._justActivated=!1),0)}_requestActive(){this._beginRequestActive(),this._endRequestActive()}_createSessions(e){
const t=this.showGeneralChartProperties.bind(this,at.TabNames.events);e.createSessions(t)}_createPrePostMarket(e){{const t=this.showGeneralChartProperties.bind(this,at.TabNames.scales);e.createPrePostMarket(t)}}_createVolumeIfNeeded(){const e=d.enabled("create_volume_indicator_by_default")&&this._options.addVolume,t=!this._content,i=d.enabled("create_volume_indicator_by_default_once");this._content&&this._content.loading;if(e&&t){const e=()=>{setTimeout((async()=>{const e=this.model().model(),t=e.mainSeries().symbolInfo();if(!t)return;const i=(0,we.hasVolume)(t);if(!this.containsVolume()&&i){const t=(0,yn.factoryDefaults)("chartproperties.volumePaneSize");await(0,Ll.studyMetaInfoRepository)().requestMetaInfo();const i=e.createStudyInserter({type:"java",studyId:"Volume@tv-basicstudies"});i.setForceOverlay(d.enabled("volume_force_overlay")),i.setPaneSize(t),d.enabled("hide_volume_ma")&&i.setPropertiesState({styles:{vol_ma:{display:0}}}),i.insert()}else if(!i&&this.containsVolume()){const t=this.model().dataSources().filter((e=>(0,ct.isStudy)(e)&&"Volume"===e.metaInfo().shortId))[0];e.removeSource(t)}}))};this.model().mainSeries().dataEvents().symbolResolved().subscribe(this,e,i)}}onModelTagsChanged(){this._tagsChanged.fire()}_initBackgroundColor(){null===this._backgroundTopColorSpawn&&(this._backgroundTopColorSpawn=this.model().model().backgroundTopColor().spawn(),this._backgroundTopColorSpawn.subscribe(this._onBackgroundColorChanged.bind(this))),null===this._backgroundBottomColorSpawn&&(this._backgroundBottomColorSpawn=this.model().model().backgroundColor().spawn(),this._backgroundBottomColorSpawn.subscribe(this._onBackgroundColorChanged.bind(this)))}_updateGui(e){this._model&&(this._makeTimeAxisWidget(),this._makePaneWidgetsAndSeparators(),this._elMainTable.style.userSelect="none",this._adjustSize(e))}_onChartStyleChanged(){(0,Ne.trackEvent)("Chart",`Chart Style ${this.model().mainSeries().getStyleShortName().toUpperCase()}`)}_addPerfMark(e){(0,ec.addPerfMark)(`ChartWidget.${this._id}.${e}`)}_setElement(e){if(!e)return;if(this._mainDiv){this._mainDiv.remove();const e=document.createRange();e.selectNodeContents((0,s.ensureNotNull)(this._parent)),e.deleteContents()}this._controlBarNavigation&&(this._controlBarNavigation.destroy(),this._controlBarNavigation=null),null!==this._removeMaximizeHotkey&&this._removeMaximizeHotkey(),this._removeMaximizeHotkey=this._initMaximizeHotkey(e);const t=e.ownerDocument,o=t.createElement("div");o.classList.add("chart-container-border"),e.insertBefore(o,e.firstChild),this._parent=o;const r=t.createElement("div");if(r.classList.add("chart-widget"),this._mainDiv=r,this._elTooltipDiv=t.createElement("div"),this._elTooltipDiv.className="tooltip-wrapper",this._mainDiv.appendChild(this._elTooltipDiv),this._elMainTable=t.createElement("div"),this._elMainTable.className="chart-markup-table",this._mainDiv.appendChild(this._elMainTable),r.setAttribute("role","region"),r.setAttribute("aria-label",n.t(null,{replace:{index:this.id()}},i(556275))),
this._hotkeysListener&&this._hotkeysListener.destroy(),this._errorRenderer.setContainer(this._parent),this._hotkeysListener=new st.ChartHotkeysListener(this,this._mainDiv),(this._options.controlBarEnabled||d.enabled("control_bar"))&&this._createControlBar(),this._options.handleScale.mouseWheel||this._options.handleScroll.mouseWheel){this._mouseWheelHelper=new Ot;const e=this._onMousewheel.bind(this);this._onWheelBound=e,this._mainDiv.addEventListener("wheel",e,{passive:!1})}this._mainDiv.addEventListener("mouseenter",(()=>this._isHovered.setValue(!0))),this._mainDiv.addEventListener("mouseleave",(()=>this._isHovered.setValue(!1))),this.resize(),this._justActivated=!1,this.withModel(this,(()=>{o.appendChild(r),r.addEventListener("mousedown",this._beginRequestActive.bind(this)),r.addEventListener("mouseup",this._endRequestActive.bind(this)),r.addEventListener("touchstart",this._beginRequestActive.bind(this)),r.addEventListener("touchmove",this._endRequestActive.bind(this)),r.addEventListener("touchend",this._endRequestActive.bind(this)),r.addEventListener("click",this._requestActive.bind(this))})),this._inited&&(null!==this._timeAxisWidget&&(this._timeAxisWidget.destroy(),this._timeAxisWidget=null),this._paneWidgets.forEach((e=>{e.destroy()})),this._paneWidgets.length=0,this._paneSeparators.forEach((e=>{e.destroy()})),this._paneSeparators.length=0,this._update(B.InvalidationMask.full(),performance.now()))}_init(){this.hasModel()&&this.model().mainSeries().clearData(),this._initColors(),this._makeDefaultGui();this._makeDefaultModel(),(()=>{this._checkObsoleteTimezone(),this._chartSession&&this._chartSession.connected()&&this.model().model().restart(),this._content&&(this._initColors(),this._updateGui(),this.update()),this._resizeHandler=()=>{this._invalidationHandler(B.InvalidationMask.full())},this._resizeHandler(),(0,s.ensureNotNull)(this._parent).appendChild((0,s.ensureNotNull)(this._mainDiv)),this._spinner&&(this._spinner.stop(),this._spinner=null),this._activateSymbolSearchHotkeys(),this.model().timeScale().onScroll().subscribe(this,(()=>this._onScroll.fire())),this._inited=!0})()}_makeDefaultModel(){var e,t;let i;if(this._content&&this._content.timeScale.points){const e=this._content.timeScale.points.items[0];i={startDate:e}}const o=()=>{var e,t;const s={readOnly:this.readOnly(),isSnapshot:!!this._containsData,...(0,Fe.pickFields)(this._options,["timeScale","crossHair","chartEventsEnabled","newsNotificationsEnabled","esdEnabled","latestUpdatesEnabled","continuousContractSwitchesEnabled","futuresContractExpirationEnabled","countdownEnabled","lastPriceAnimationEnabled","currencyConversionEnabled","unitConversionEnabled","watermarkEnabled","shiftVisibleRangeOnNewBar","hideIdeas","onWidget"])},o=function(e,t,i,s,o,r,n,a,l,c,d){const h=new Il(e,t,i,s,o,r,n,a,l,c,d);return h.model().fullUpdate(),h
}(this._chartSession,this._invalidationHandler,this.properties(),i,this,this._options.undoHistory,this._options.barsMarksContainersFactory,s,this._collapsed,this._linkingGroupIndex,null!==(t=null===(e=this._saveChartService)||void 0===e?void 0:e.autoSaveEnabled())&&void 0!==t?t:new u.WatchedValue(!0));return this._createSessions(o.model()),this._createPrePostMarket(o.model()),o};d.enabled("lean_chart_load")?this._model=this._model||o():this._model=o(),this._model.model().setChartSaveTime(1e3*this._chartWidgetCollection.metaInfo.lastModified.value()),this._createVolumeIfNeeded();if(this._content){let i=this._setSymbolIntervalContentOverrides;ad&&this._initialLoading&&(i={...i,symbol:this._defSymbol,interval:null!==(e=this._defInterval)&&void 0!==e?e:void 0,style:null!==(t=this._defStyle)&&void 0!==t?t:void 0},this._defInterval&&js.Interval.isRange(this._defInterval)&&(i.style=11)),this.restoreState(this._content,this._containsData,i),this._setSymbolIntervalContentOverrides={},ad&&this._defSymbol&&this.model().model().recalculatePriceRangeOnce()}this._setActions(),this._createLineToolsSynchronizerIfNeeded(),(()=>{const e=(0,s.ensureNotNull)(this._model);e.onTagsChanged().subscribe(this,(()=>this.onModelTagsChanged())),this._initBackgroundColor(),this._updateGui(),this._modelCreated.fire(e),this._tagsChanged.fire();const t=e.mainSeries(),i=t.properties().childs();this._defTimeframe&&t.setDefaultTimeframe(this._defTimeframe),t.dataEvents().symbolNotPermitted().subscribe(null,(e=>t.setSymbolParams({symbol:e}))),this._symbolWV.setValue(i.symbol.value()),i.symbol.subscribe(this,(e=>this._symbolWV.setValue(e.value()))),this._resolutionWV.setValue(i.interval.value()),i.interval.subscribe(this,(e=>this._resolutionWV.setValue(e.value()))),window.loginStateChange.subscribe(this,this._handleLoginStateChanged),this._handleLoginStateChanged(),t.dataEvents().symbolResolved().subscribe(this,(e=>{const i=e.pro_name,s=e.pro_perm;i&&this._options.isSymbolAvailable&&this._options.isSymbolAvailable(i,s).then((e=>{e||t.setSymbolParams({symbol:window.DEFAULT_SYMBOL})}))})),void 0!==this._options.requestFallbackSymbol&&t.dataEvents().symbolGroupNotPermitted().subscribe(this,(e=>{(0,s.ensureDefined)(this._options.requestFallbackSymbol)(i.symbol.value(),{type:"group_not_permitted",symbolGroup:e}).then((e=>{e&&t.setSymbolParams({symbol:e})}))})),(0,s.ensureDefined)(t.onInReplayStateChanged).bind(t)().subscribe(this.screen,this.screen.show),i.style.unsubscribe(this,this._onChartStyleChanged),i.style.subscribe(this,this._onChartStyleChanged),t.dataEvents().completed().subscribe(this,(()=>this._addPerfMark("SeriesCompleted")),!0),t.dataEvents().barReceived().subscribe(this,(()=>this._addPerfMark("SeriesFirstDataReceived")),!0);const o=this._options;t.dataEvents().chartTypeNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"D"}),o.muteSessionErrors||((0,Z.trackGoProFeature)("kagiRenko"),(0,rn.reloginOrGoPro)({feature:"kagiRenko"}))})),t.dataEvents().intradaySpreadNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"D"}),
o.muteSessionErrors||(0,rn.reloginOrGoPro)({feature:"intradaySpread"})})),t.dataEvents().customIntervalNotPermitted().subscribe(null,(i=>{const s=e.model().defaultResolutions(),r=s.find((e=>(0,ds.compareResolutions)(e,i)>=0)),n=null!=r?r:s[s.length-1];t.setSymbolParams({interval:n}),o.muteSessionErrors||(0,rn.reloginOrGoPro)({feature:"customIntervals"})})),t.dataEvents().secondsIntervalNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"1"}),o.muteSessionErrors||(0,rn.reloginOrGoPro)({feature:"secondsIntervals",forceUpgradeBtn:!0})})),t.dataEvents().ticksIntervalNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"1"}),o.muteSessionErrors||(0,rn.reloginOrGoPro)({feature:"tickIntervals",forceUpgradeBtn:!0,isTrialAvailable:!1})})),t.dataEvents().intradayExchangeNotPermitted().subscribe(null,(()=>{if(t.setSymbolParams({interval:"D"}),!o.muteSessionErrors){let e=(0,s.ensureNotNull)(t.symbolInfo()).listed_exchange;(0,kl.getExchanges)().forEach((t=>{t.value===e&&(e=t.name)})),(0,rn.reloginOrGoPro)({feature:"intradayExchange"})}})),t.requestingStyleIsNotSupported.subscribe(null,(()=>{const i=t.interval(),s=e.model().defaultResolutions(),o=(0,we.getLastUsedSingleValueBasedStyle)(),r=(0,ds.getResolutionByChartStyle)(o,i,s);t.setChartStyleWithIntervalIfNeeded(o,r)})),t.requestingStyleSupportRecovered.subscribe(null,(i=>{const s=t.interval(),o=e.model().defaultResolutions(),r=(0,ds.getResolutionByChartStyle)(i,s,o);t.setChartStyleWithIntervalIfNeeded(i,r)}))})()}_addHotkeys(){if(this._hotkeys.add({desc:"Maximize",hotkey:De.Modifiers.Alt+13,handler:()=>this.toggleFullscreen(),isDisabled:()=>!this.getResizerDetacher().fullscreenable.value()}),this._hotkeys.add(this._clearSelectionHotkey()),this._options.indicatorsDialogShortcutEnabled&&this._hotkeys.add({desc:"Show insert indicator dialog",hotkey:111,handler:()=>this.showIndicators()}),!this.readOnly()){this._hotkeys.add({desc:"Remove selected source",hotkey:De.isMacKeyboard?46:8,handler:()=>this.removeSelectedSources()});{const e=(e,t)=>{this.activePaneWidget&&("drawRightThere"===t.action?this.activePaneWidget.drawRightThere(e):Yt.tool.setValue(e))},t=(t,i)=>()=>e(t,i);Object.entries(jl.lineToolsSelectHotkeys).map((([e,i])=>({desc:i.description,hotkey:i.hash,handler:t(e,i)}))).forEach((e=>this._hotkeys.add(e)))}}this.withModel(null,(()=>{const e=()=>this._hotkeys.promote();this.model().onSelectedSourceChanged().subscribe(null,e),this.model().crossHairSource().measurePane().subscribe((t=>{null!==t&&e()}))}))}_startSpinner(e){this._spinner||e&&(this._spinner=(new Xe.Spinner).spin(e))}_handleLoginStateChanged(){d.enabled("popup_hints")&&window.user&&window.user.is_pro?this._noExchangeSubscrptionWarning=new Fl(this):null!==this._noExchangeSubscrptionWarning&&(this._noExchangeSubscrptionWarning.destroy(),this._noExchangeSubscrptionWarning=null)}_checkObsoleteTimezone(){const e=this.properties().childs().timezone.value();(0,Qe.timezoneIsAvailable)(e)||this.properties().childs().timezone.setValue({UTC:"Etc/UTC",EST:"America/New_York",CST:"America/Chicago",
PST:"America/Los_Angeles"}[e]||"exchange")}_initColors(){const e=this.properties().childs(),t=e.scalesProperties.childs();t.lineColor.listeners().subscribe(this,this._updateAndPaint),t.textColor.listeners().subscribe(this,this._updateAndPaint),e.paneProperties.childs().separatorColor.listeners().subscribe(this,this._setPaneSeparatorLineColor)}_setPaneSeparatorLineColor(){this._paneSeparators.forEach((e=>e.update())),this._updateAndPaint()}_updateAndPaint(){this.update(),this.paint()}_makeDefaultGui(){this._makeLoadingScreen(),this.onWidget()&&this._makeAvailableOnTVPopup(),this.hasModel()&&(this._makeTimeAxisWidget(),this._makePaneWidgetsAndSeparators(),this._updateScalesActions()),this._adjustSize(),(0,it.disableSelection)(this._elMainTable),this._updateAndPaint()}_makeLoadingScreen(){if(d.enabled("lean_chart_load")){if(this.screen)return;this.screen=new Nt(this,(0,s.ensureNotNull)(this._parent))}else this.screen=new Nt(this,(0,s.ensureNotNull)(this._mainDiv))}_makeAvailableOnTVPopup(){this._availableScreen||(this._availableScreen=new Zl(this))}_activateSymbolSearchHotkeys(){this.readOnly()||this._options.hideSymbolSearch||(0,He.activateKeyPressHandler)()}_makeTimeAxisWidget(){if(this._timeAxisWidget)return void this._timeAxisWidget.updatePriceAxisStubs();const e=this.model();this._timeAxisWidget=new Fs(this,this._options.timeScaleWidget,this._titlesProvider.bind(this),this._menuItemsProvider.bind(this),this._backgroundBasedTheme.spawnOwnership()),this._elMainTable.appendChild(this._timeAxisWidget.getElement()),this._timeAxisWidget.updatePriceAxisStubs(),this._timeAxisWidget.onLabelHovered().subscribe(this,((t,i)=>{const o=this._maximizedPaneWidget?this._maximizedPaneWidget.state():e.paneForSource(e.mainSeries()),r=(0,s.ensureNotNull)(this.paneByState((0,s.ensureNotNull)(o))).highlightedPriceAxis(),n=r.value();(i||n.owner===t.owner)&&(r.setValue({owner:t.owner,axis:i?t.axis:null}),this.model().model().lightUpdate())}))}_updateAriaPriceDescription(e){}_titlesProvider(e,t){const i=this.model(),o=(0,s.ensureNotNull)(this._maximizedPaneWidget?this._maximizedPaneWidget.state():i.paneForSource(i.mainSeries())),r="right"===e?o.rightPriceScales():o.leftPriceScales();if(r.length<t+1)return[];let n=r[t].orderedSources().filter((e=>e===i.mainSeries()||(0,ct.isStudy)(e)));return n.reverse(),n=(0,Me.moveToHead)(n,i.mainSeries()),n.map((e=>e.title(io.TitleDisplayTarget.StatusLine,!0,void 0,!1)))}_menuItemsProvider(e,t){const i=this.model(),o=(0,s.ensureNotNull)(this._maximizedPaneWidget?this._maximizedPaneWidget.state():i.paneForSource(i.mainSeries())),r="right"===e?o.visibleRightPriceScales():o.visibleLeftPriceScales();if(r.length<t+1)return[];const n=r[t],a=i.model().panes().indexOf(o),l=this._paneWidgets[a],c="right"===e?l.rightPriceAxisesContainer():l.leftPriceAxisesContainer();return(0,s.ensureNotNull)(c.findAxisWidgetForScale(n)).getContextMenuActions()}_invalidationRAFCallback(e){if(this._drawPlanned=!1,this._drawRafId=0,!this._inLoadingState){if(this._invalidationMask){const t=this._invalidationMask
;this._invalidationMask=null,this._update(t,e);for(const i of t.timeScaleInvalidations())if(0===i.type&&!i.value.finished(e)){this.model().model().setTimeScaleAnimation(i.value,i.rightOffsetPx);break}}null!==this._chartPaintedPromise&&(this._chartPaintedPromise.resolve(),this._chartPaintedPromise=null)}}_applyTimeScaleInvalidations(e,t){for(const i of e.timeScaleInvalidations())this._applyTimeScaleInvalidation(i,t)}_applyTimeScaleInvalidation(e,t){var i,s,o;const r=null===(i=this._model)||void 0===i?void 0:i.timeScale();if(r&&0===e.type){const i=e.value.getStartPosition()-e.value.getPosition(t),n=e.rightOffsetPx+i,a=r.width()-n,l=r.indexToCoordinate(r.baseIndex());r.startScroll(l),r.scrollTo(a),r.endScroll(),r.requestHistoryPointsIfNeeded(),e.value.finished(t)&&(null===(o=(s=e.value).onFinish)||void 0===o||o.call(s,!0))}}_onChartSessionCriticalError(e,t){this._disconnected.fire(!0)}_onData(e){if("reconnect_bailout"===e.method)this._reconnectBailout.fire();else this.model().model().onData(e)}_onConnection(){this._requestMetadataAndProcessModel(),this.hasModel()&&(this.model().model().restart(),this.model().model().fullUpdate(),this._connected.fire())}_onDisconnect(){this.hasModel()&&this.model().model().disconnect(),this._model&&this._model.model().fullUpdate(),this._disconnected.fire()}async _requestMetadataAndProcessModel(){this._inited||(await(0,ut.initAllLineToolsFromContent)(this._content),this._init(),this._chartWidgetInitialized.fire(),nd.logDebug("initialized"))}async _requestMetadata(){this._addPerfMark("RequestMetadataStart"),nd.logInfo("RequestMetadataStart"),await(0,Ll.studyMetaInfoRepository)().requestMetaInfo(),this._addPerfMark("RequestMetadataEnd"),nd.logInfo("RequestMetadataEnd, already initialized: "+Boolean(this._inited))}async _createControlBar(){const e=await Promise.all([i.e(65073),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(25480),i.e(58985),i.e(88015),i.e(30614),i.e(7001),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(79753),i.e(77183),i.e(10974),i.e(82321),i.e(16388),i.e(62526),i.e(83147),i.e(75560),i.e(1730),i.e(24102),i.e(5093)]).then(i.bind(i,956394));this._controlBarNavigation=new e.ControlBarNavigation(this,(0,s.ensureNotNull)(this._mainDiv),this._options.controlBar),this._model&&this._adjustSize()}_subscribeToDrawingState(){if(this.readOnly())return;(0,Yt.init)();const e=(e,t)=>{const i=this._model;if(null===i)return;const s=i.model();e.model!==s&&(this._lineToolsSynchronizer?this._lineToolsSynchronizer.executeSyncedAction((()=>t(s,i))):t(s,i))};Yt.createdLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const o=(0,s.ensureNotNull)(e.paneForSource(e.mainSeries()));let r,n=null;if(void 0===t.pointPositionPercents){if(n=md(e,t.model,t.point.timeStamp),null===n)return;r=t.point.price}else{const i=t.pointPositionPercents.x*e.timeScale().width(),s=e.mainSeries().priceScale(),o=t.pointPositionPercents.y*s.height(),a=e.mainSeries().firstValue();if(null===a)return;n=e.timeScale().coordinateToIndex(i),
r=s.coordinateToPrice(o,a)}const a={index:(0,s.ensureNotNull)(n),price:r},l=i.createLineTool({pane:o,point:a,linetool:t.linetool,properties:t.properties,linkKey:t.linkKey,ownerSource:e.mainSeries(),disableSynchronization:!0,id:t.id,sharingMode:t.sharingMode});null!==l&&!Boolean(this.model().lineBeingCreated())&&t.finalState&&l.restoreExternalPoints(t.finalState,{indexesChanged:!0,pricesChanged:!0})}))})),Yt.continuedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const o=md(e,t.model,t.point.timeStamp);if(null===o)return;const r={index:o,price:t.point.price},n=e.lineBeingCreated();if(null===n)return;i.continueExternalLine(r,null!==(s=t.envState)&&void 0!==s?s:void 0,!!t.finalState)&&t.finalState&&n.restoreExternalPoints(t.finalState,{indexesChanged:!0,pricesChanged:!0})}))})),Yt.cancelledLineTool.subscribe(null,(t=>{e(t,((e,t)=>{e.cancelCreatingLine()}))})),Yt.beenSetLineToolLastPoint.subscribe(null,(t=>{e(t,((e,i)=>{const s=e.lineBeingCreated();if(null===s||s.linkKey().value()!==t.linkKey)return;const o=md(e,t.model,t.point.timeStamp);if(null===o)return;const r={index:o,price:t.point.price};s.setLastPoint(r),s.updateAllViews((0,hs.sourceChangeEvent)(s.id())),e.lightUpdate()}))})),Yt.startedMovingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const o=t.linkKeys.map(ut.lineToolByLinkKey.bind(null,e)).filter(je.notNull);if(o.length){const i=md(e,t.model,t.point.timeStamp);if(null===i)return;const r={index:i,price:t.point.price},n=null!==(s=t.activeItem)&&void 0!==s?s:null,a=o[0].pointToScreenPoint(r);a&&e.startMovingSources(o,{logical:r,screen:a},n,t.pointPositionPercents,null===t.envState?void 0:t.envState,!0)}}))})),Yt.movedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const o=e.sourcesBeingMoved().filter(ut.isLineTool).filter((e=>(e=>t.linkKeys.some((t=>e.linkKey().value()===t)))(e)));if(!o.length)return;const r=md(e,t.model,t.point.timeStamp);if(null===r)return;const n={index:r,price:t.point.price},a=o[0].pointToScreenPoint(n);a&&e.moveSources({logical:n,screen:a},t.pointPositionPercents,null!==(s=t.envState)&&void 0!==s?s:void 0,!0)}))})),Yt.finishedMovingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=e.sourcesBeingMoved().filter(ut.isLineTool);if(0===s.length)return;s.forEach((i=>{const s=(e=>{for(let i=0;i<t.linkKeys.length;i++)if(t.linkKeys[i]===e.linkKey().value())return{state:t.finalStates[i],changes:t.changes[i]};return null})(i);e.endMovingSources(null!==s,!0),null!==s&&(i.restoreExternalPoints(s.state,s.changes),s.state.pointPositionPercents&&i.restorePositionPercents(s.state.pointPositionPercents))}))}))})),Yt.startedChangingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{var s;const o=(0,ut.lineToolByLinkKey)(e,t.linkKey);if(null!==o){const i=o.getPoint(t.pointIndex),r=i?i.index:md(e,t.model,t.point.timeStamp);if(null===r)return;if(o.isActualSymbol()&&o.isActualCurrency()&&o.isActualUnit()){const i={index:r,price:t.point.price};e.startChangingLinetool(o,i,t.pointIndex,null!==(s=t.envState)&&void 0!==s?s:void 0,!0)}}}))})),Yt.changedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const o=e.lineBeingEdited()
;if(null===o||o.linkKey().value()!==t.linkKey)return;let r=null;if(r=t.changes.indexesChanged?md(e,t.model,t.point.timeStamp):(0,s.ensureNotNull)(e.linePointBeingChanged()).index,null!==r&&o.isActualSymbol()&&o.isActualCurrency()&&o.isActualUnit()){const i={index:r,price:t.point.price};e.changeLinePoint(i,void 0,!0)}}))})),Yt.finishedChangingLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,ut.lineToolByLinkKey)(e,t.linkKey);null!==s&&s.isActualSymbol()&&s.isActualCurrency()&&s.isActualUnit()&&null!==e.lineBeingEdited()&&e.endChangingLinetool(!!t.finalState,!0),null!==s&&t.finalState&&s.restoreExternalPoints(t.finalState,t.changes)}))})),Yt.removedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const{withUndo:s,unlink:o,linkKey:r}=t,n=(0,ut.lineToolByLinkKey)(e,r);null!==n&&(o&&n.detachAlert(),s?i.removeSource(n,!1):(e.lineToolsGroupModel().removeLineTools([n]),e.removeSource(n)))}))})),Yt.finishedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,ut.lineToolByLinkKey)(e,t.linkKey);null!==s&&(0,U.isLineToolFinishRequiredWhenCreatedByApi)(s.toolname)&&s.finish()}))})),Yt.changedLineStyle.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,ut.lineToolByLinkKey)(e,t.linkKey);null!==s&&(s.restoreExternalState(t.state),s.propertiesChanged(!0),t.alertId&&s.syncAlert(t.alertId))}))})),Yt.restoredLineToolState.subscribe(null,(t=>{e(t,((e,i)=>{const s=(0,ut.lineToolByLinkKey)(e,t.linkKey);if(null!==s){const i={...t.state};i.indexes=t.state.points.map((i=>({index:md(e,t.model,i.time_t),price:i.price}))),e.restoreLineToolState(s,i,!1)}}))})),Yt.restoredLineTool.subscribe(null,(t=>{e(t,((e,i)=>{e.restoreSource(t.state.restorePane,t.state.paneIndex,t.state.paneState,t.state.sourceState,null)}))})),Yt.copiedLineTool.subscribe(null,(t=>{e(t,((e,i)=>{const o=(0,s.ensureNotNull)(e.paneForSource(e.mainSeries()));let r;const n={...t.state,intervalsVisibilities:(0,bn.mergeIntervalVisibilitiesDefaults)(t.state.intervalsVisibilities)},a=(0,ut.createLineToolProperties)(t.linetool,n,e),l=e.dataSourceForId(t.id);if(l){if(!(0,ut.isLineTool)(l))return void nd.logError(`Error sync creating line tool. Object with id ${t.id} is already in use and it is not a line tool`);if(l.toolname!==t.linetool)return void nd.logError(`Error sync creating line tool. Object with id ${t.id} is already in use and its type differs: ${l.toolname} and ${t.linetool}`)}if(l&&(l.linkKey().setValue(t.linkKey),l.share(t.sharingMode)),t.pointPositionPercents){const e={index:0,price:0};if(r=null!=l?l:i.createLineTool({pane:o,point:e,linetool:t.linetool,properties:a,linkKey:t.linkKey,disableSynchronization:!0,id:t.id}),null===r)return;r.restorePositionPercents((0,s.ensureDefined)(t.pointPositionPercents))}else{const n=i=>({index:(0,s.ensureNotNull)(md(e,t.model,i.timeStamp)),price:i.price}),c=t.points.map(n),d=t.pointsForCreating.map(n),h=c[0];if(l)r=l;else if(t.withUndo)r=i.createLineTool({pane:o,point:h,linetool:t.linetool,properties:a,linkKey:t.linkKey,sharingMode:t.sharingMode,disableSynchronization:!0,id:t.id});else{const e=new xo({model:i.model(),pane:o,lineTool:t.linetool,
ownerSource:(0,s.ensureNotNull)(o.mainDataSource()),drawOnAllChartsMode:t.sharingMode,id:t.id});e.redo(),e.startCreatingLine(h,a,t.linkKey||null,t.sharingMode,!0),r=(0,s.ensureNotNull)(e.line())}if(null===r)return;const u=(e,s)=>{t.withUndo?i.continueCreatingLine(e,new Kt.EnvironmentState(void 0,!0),s,!0):i.model().continueCreatingLine(e,new Kt.EnvironmentState(void 0,!0),s,!0)},p=(0,U.isLineToolFinishRequiredWhenCreatedByApi)(t.linetool);if(e.lineBeingCreated())if(d.length>1)for(let e=1;e<d.length;e++)u(d[e],e<d.length-1&&!p),e===d.length-1&&p&&(r.finish(),u(d[e],!0));else p&&(r.finish(),u(d[0],!0))}r.properties().interval.setValue(t.state.interval),r.restoreExternalState(t.state),r.restoreData&&r.restoreData(t),r.setZorder(t.zOrder),r.propertiesChanged(!0),t.finalState&&(r.calcIsActualSymbol(),r.restoreExternalPoints(t.finalState,{pricesChanged:!0,indexesChanged:!0},!0)),t.alertId&&r.syncAlert(t.alertId)}))}))}_setFirstRequestNumbarsUsingTimeframeAndInterval(e){const t=function(e){var t,i,s,o,r,n,a,l,c,d,h,u,p;const _=null!==(t=e.numberExtraBars)&&void 0!==t?t:0,m=e.barSpacing||6,g=Math.ceil(e.width/m)+_;if(e.timeFrame){if(!e.interval)return{barCount:g};const t=js.Interval.parse(e.interval);if("string"==typeof e.timeFrame){if("ALL"===e.timeFrame)return{barCount:g};let l=e.timeFrame;"YTD"===e.timeFrame&&(l=`${Math.floor(((new Date).valueOf()-new Date((new Date).getFullYear(),0,0).valueOf())/1e3/60/60/24)}D`);const c=js.Interval.parse(l),d=Date.now().valueOf(),h=d-c.inMilliseconds();return{barCount:(0,$l.getPeriodsBetweenDates)(null!==(s=null===(i=e.symbolInfo)||void 0===i?void 0:i.session)&&void 0!==s?s:"24x7",null!==(r=null===(o=e.symbolInfo)||void 0===o?void 0:o.session_holidays)&&void 0!==r?r:"",null!==(a=null===(n=e.symbolInfo)||void 0===n?void 0:n.corrections)&&void 0!==a?a:"",t.letter(),t.multiplier(),h,d)+_,message:`based on period of ${l}`,shouldAdjustBarSpacing:!0}}if("time-range"===e.timeFrame.type)return{barCount:(0,$l.getPeriodsBetweenDates)(null!==(c=null===(l=e.symbolInfo)||void 0===l?void 0:l.session)&&void 0!==c?c:"24x7",null!==(h=null===(d=e.symbolInfo)||void 0===d?void 0:d.session_holidays)&&void 0!==h?h:"",null!==(p=null===(u=e.symbolInfo)||void 0===u?void 0:u.corrections)&&void 0!==p?p:"",t.letter(),t.multiplier(),1e3*e.timeFrame.from,1e3*e.timeFrame.to)+_,message:`based on time range: ${e.timeFrame.from} ... ${e.timeFrame.to}`,shouldAdjustBarSpacing:!0}}return{barCount:g}}({width:e.timeScale().width(),barSpacing:e.timeScale().barSpacing(),timeFrame:this.options().defTimeframe,interval:this.options().defInterval});if(d.enabled("charting_library_debug_mode")&&console.log(`${(new Date).toISOString()} Setting initial data request count to ${t.barCount} bars${t.message?` (${t.message})`:""}`),e.mainSeries().seriesSource().setInitialRequestOptions({count:t.barCount}),t.shouldAdjustBarSpacing&&"number"==typeof t.barCount&&t.barCount>0){const i=Math.ceil(e.timeScale().width()/t.barCount);e.timeScale().setBarSpacing(i)}}_createEventHint(){if(null===this._eventHintDeferredPromise){const e=(0,
We.createDeferredPromise)();this._eventHintDeferredPromise=e,Promise.all([i.e(62093),i.e(32690),i.e(82321),i.e(26166)]).then(i.bind(i,410837)).then((t=>{e.resolve(new t.ChartEventHintRenderer(this._chartWidgetCollection.getContainer()))}))}return this._eventHintDeferredPromise.promise}async _createWarningHint(){if(null===this._warningHintDeferredPromise){const e=(0,We.createDeferredPromise)();this._warningHintDeferredPromise=e,Promise.all([i.e(29328),i.e(44524),i.e(3062),i.e(2190),i.e(82321),i.e(83129)]).then(i.bind(i,629981)).then((t=>{e.resolve(new t.ChartWarningHintRenderer(this))}))}return this._warningHintDeferredPromise.promise}_showEventHint(e){d.enabled("popup_hints")&&(null!==this._activeHint&&0===this._activeHint.type?this._activeHint.show(e):(this._hideHint(),this._createEventHint().then((t=>{this._activeHint=t,void 0!==e&&this._activeHint.show(e)}))))}_showWarningHint(e){d.enabled("popup_hints")&&(null!==this._activeHint&&1===this._activeHint.type?this._activeHint.show(e):(this._hideHint(),this._createWarningHint().then((t=>{if(null!==t){if(this._activeHint=t,void 0===e)return;this._activeHint.show(e)}}))))}_hideHint(){null!==this._activeHint&&this._activeHint.hide()}_checkIsTradedGroupSelected(){const e=this.model(),t=e.model();return e.selection().customSources().some((e=>{var i;return null===(i=t.customSourceName(e))||void 0===i?void 0:i.startsWith("tradedGroup:PlaceOrder")}))}_setActions(){return this._unsetActions(),this._addHotkeys(),this._actions=od(this),this.withModel(null,(()=>{const e=this.model().mainSeries(),t=e.properties();t.childs().priceAxisProperties.subscribe(this,this._updateScalesActions),e.priceScaleAboutToBeChanged().subscribe(this,(()=>{t.childs().priceAxisProperties.unsubscribeAll(this)})),e.priceScaleChanged().subscribe(this,(()=>{t.childs().priceAxisProperties.subscribe(this,this._updateScalesActions),this._updateScalesActions()}))})),this._updateScalesActions(),this._actions}_unsetActions(){this._actions&&(Object.values(this._actions).forEach((e=>{e.destroy()})),this._actions=null)}_updateTimingsMeterState(){const e=this._options.visible.value();null!==this._timingsMeter&&(e?this._timingsMeter.startCollect():this._timingsMeter.stopCollect())}_onBackgroundColorChanged(){for(let e=0;e<this._paneWidgets.length;e++)this._paneWidgets[e].setCursorForTool();this.update(),this.model().model().fullUpdate()}_contentSeriesProperties(){var e;if(this._content)for(let t=this._content.panes.length;t-- >0;){const i=this._content.panes[t].sources;for(let t=i.length;t-- >0;){const s=i[t];if((0,xr.isMainSeriesState)(s))return null!==(e=s.state)&&void 0!==e?e:null}}return null}async _getChartPropertyDefinitionsViewModel(){if(null===this._definitionsViewModel){const e=await Promise.all([i.e(18574),i.e(22093),i.e(28093),i.e(83596)]).then(i.bind(i,250077));if(this._isDestroyed)throw new Error("Chart widget already destroyed");await new Promise((e=>this.withModel(null,e))),
null===this._definitionsViewModel&&(this._definitionsViewModel=new e.ChartPropertyDefinitionsViewModel(this.model(),this.properties(),this._options))}return this._definitionsViewModel}}var fd=i(851063),bd=i(387964);const yd=new c.TranslatedString("change chart layout to {title}",n.t(null,void 0,i(768846)));class Cd extends _.UndoCommand{constructor(e,t){super(yd.format({title:Ie.layouts[t].title})),this._chartWidgetCollection=e,this._newLayoutType=t,this._oldLayoutType=e.layout.value()}redo(){this._chartWidgetCollection.setLayout(this._newLayoutType)}undo(){this._chartWidgetCollection.setLayout(this._oldLayoutType)}}const wd=new c.TranslatedString("apply toolbars theme",n.t(null,void 0,i(686708)));class Td extends _.UndoCommand{constructor(e,t,i=!0){super(wd),this._prevThemeName=e,this._themeName=t,this._syncState=i}undo(){(0,Te.isStdThemeName)(this._prevThemeName)&&((0,St.setTheme)(this._prevThemeName),this._syncState&&(0,Te.syncTheme)())}redo(){(0,Te.isStdThemeName)(this._themeName.toLowerCase())&&((0,St.setTheme)(this._themeName.toLowerCase()),this._syncState&&(0,Te.syncTheme)())}}var Pd=i(203918),Md=i(566238),xd=i(263844);i(99647);const Id=!l.CheckMobile.any(),Ld=(0,r.getLogger)("ChartWidgetCollectionBase"),Ad=new c.TranslatedString("apply indicators to entire layout",n.t(null,void 0,i(870507))),kd=new c.TranslatedString("sync time",n.t(null,void 0,i(591677))),Ed=new c.TranslatedString("resize layout",n.t(null,void 0,i(847418))),Dd=new c.TranslatedString("reset layout sizes",n.t(null,void 0,i(385366))),Bd=new c.TranslatedString("apply chart theme",n.t(null,void 0,i(368231))),Nd=new c.TranslatedString("symbol lock",n.t(null,void 0,i(253278))),Rd=new c.TranslatedString("interval lock",n.t(null,void 0,i(456558))),Od=new c.TranslatedString("date range lock",n.t(null,void 0,i(658850))),Vd=new c.TranslatedString("track time",n.t(null,void 0,i(946807))),Wd=new c.TranslatedString("change series style",n.t(null,void 0,i(549965))),Fd=n.t(null,void 0,i(328298)),Hd=n.t(null,void 0,i(978972)),zd=n.t(null,void 0,i(410615)),Ud=n.t(null,void 0,i(981518)),Gd=n.t(null,void 0,i(740947)),qd=n.t(null,void 0,i(955801)),jd=n.t(null,void 0,i(176651)),Kd=n.t(null,void 0,i(868054)),Zd=n.t(null,void 0,i(294656));function Yd(e,t){const i=t.model().model().studyTemplate();e.undoHistory.beginUndoMacro(Ad);for(let s=0;s<e.chartWidgetsDefs.length;s++){const o=e.chartWidgetsDefs[s].chartWidget;o!==t&&(o.hasModel()&&o.model().applyStudyTemplate(i,""))}e.undoHistory.endUndoMacro()}async function $d(e,t,i,o,r){e.undoHistory.beginUndoMacro(r);for(let n=0;n<e.chartWidgetsDefs.length;n++){const a=e.chartWidgetsDefs[n].chartWidget;if(a!==t&&a&&a.hasModel()){const t=a.model();let n;if(o.isOnMainPane)n=(0,s.ensureNotNull)(t.model().paneForSource(a.model().model().mainSeries()));else{const i=new m(t.model(),o.paneIndex);e.undoHistory.pushUndoCommand(i);const r=(0,s.ensureDefined)(i.createdPaneId());n=(0,s.ensureDefined)(t.model().panes().find((e=>e.id()===r)))}const l=await t.pasteSourceFromClip(n,i,!0);if(l&&1===l.length){const e=l[0];if(o.asCompare){
const i=(0,s.ensureNotNull)(t.mainSeries().priceScale());t.moveToScale(e,(0,s.ensureDefined)(n),i,r),t.setPriceScaleMode({percentage:!0},i,null)}}t.model().lightUpdate()}}e.undoHistory.endUndoMacro()}function Xd(e){let t=1;for(;e.has(""+t);)t++;return""+t}function Jd(e){const t=new Map,i=e.chartsCountToSave(),s=new Set;for(let o=0;o<i;o++)if(o<e.chartWidgetsDefs.length){const i=e.chartWidgetsDefs[o].chartWidget,r=i.id(),n=i.lineToolsAndGroupsDTO();t.set(r,n),s.add(r)}else{const i=e.savedChartWidgetOptions[o-e.chartWidgetsDefs.length].content;i.chartId||(i.chartId=Xd(s));const r=new Map;r.set(0,j(i)),t.set(i.chartId,r),s.add(i.chartId)}return t}function Qd(e,t){const i=this.innerState(),{withData:s,skipLineToolsFromOtherSymbols:o,wipeSensitiveData:r,skipLineTools:n}=t;if(e<i.chartWidgetsDefs.length){const t=i.chartWidgetsDefs[e].chartWidget;return e<i.actualLayoutCount()||t.shouldBeSavedEvenIfHidden()?t.state(s,o,r,n):null}return function(e,t=!1){return t?G(e):e}(i.savedChartWidgetOptions[e-i.chartWidgetsDefs.length].content,n)}function eh(e){return e.savedChartWidgetOptions.map((e=>(0,s.ensureDefined)(e.content.chartId)))}function th(e,t,i){const s=e.chartsCountToSave();i.forEach((i=>{const s=(o=i.chartId,null!==(n=null===(r=e.chartWidgetsDefs.find((e=>e.chartWidget.id()===o)))||void 0===r?void 0:r.chartWidget)&&void 0!==n?n:null);var o,r,n;null==s||s.resetLineToolsInvalidated(t,i.savedDto,i.sharingMode)}));for(let t=e.chartWidgetsDefs.length;t<s;t++){const i=G(e.savedChartWidgetOptions[t-e.chartWidgetsDefs.length].content);e.savedChartWidgetOptions[t-e.chartWidgetsDefs.length].content=i}}function ih(e,t,i,s){const o=e.map((e=>e.chartWidget)).filter((e=>e.hasModel())).filter((e=>e.id()===t||0!==s));try{o.forEach((e=>e.startApplyingLineToolUpdateNotification())),o.forEach((e=>e.applyLineToolUpdateNotification(i,s)))}finally{o.forEach((e=>e.endApplyingLineToolUpdateNotification()))}}function sh(e){return e instanceof Error?e.message:null}function oh(e){return new x({copyRequested:(t,i)=>{e.activeChartWidget.value().model().clipboardCopy(t,i).catch((e=>{var t;const i=null!==(t=sh(e))&&void 0!==t?t:Fd.format({keystroke:(0,E.humanReadableHash)(E.Modifiers.Mod+67)});(0,k.showChartWarningNotification)("copy",{title:Hd,text:i})}))},cutRequested:(t,i)=>{e.activeChartWidget.value().model().clipboardCut(t,i).catch((e=>{var t;const i=null!==(t=sh(e))&&void 0!==t?t:Fd.format({keystroke:(0,E.humanReadableHash)(E.Modifiers.Mod+88)});(0,k.showChartWarningNotification)("cut",{title:zd,text:i})}))},pasteRequested:(t,i)=>{(i?i.model().undoModel():e.activeChartWidget.value().model()).clipboardPaste(t,i).catch((e=>{var t;const i=null!==(t=sh(e))&&void 0!==t?t:Fd.format({keystroke:(0,E.humanReadableHash)(E.Modifiers.Mod+86)});(0,k.showChartWarningNotification)("paste",{title:Ud,text:i})}))}})}function rh(e,t){(0,K.setBroker)(t)}function nh(e){const t={};return e.chartWidgetsDefs.map((e=>e.chartWidget)).forEach((e=>t[e.id()]=function(e){var t,i,o,r,n;const a={};if(!e.hasModel()){const r=e.options().content;if(!r)return a;const n=(0,
s.ensureNotNull)(r.panes.reduce(((e,t)=>{var i;return null!==(i=null!=e?e:t.sources.find((e=>"MainSeries"===e.type)))&&void 0!==i?i:null}),null));return a.resolution=null===(t=n.state)||void 0===t?void 0:t.interval,a.symbol=null===(i=n.state)||void 0===i?void 0:i.symbol,a.short_name=null===(o=n.state)||void 0===o?void 0:o.shortName,a}const l=e.model().mainSeries(),c=l.properties().childs(),d=l.symbolInfo();a.resolution=c.interval.value(),a.symbol_type=null!==d&&d.type||"",a.exchange=null!==d&&d.exchange||"",a.listed_exchange=null!==d&&d.listed_exchange||"";const h=null!==(r=null==d?void 0:d.legs)&&void 0!==r?r:[];if(null!==d&&l.isSpread()){const e=h[0];let t=d.base_name[0];t=t.split(":")[1],a.symbol=e,a.short_name=t,a.expression=d.full_name}else a.symbol=null!==d&&d.ticker||c.symbol.value(),a.short_name=c.shortName.value();const u=null!==(n=null==d?void 0:d.base_name)&&void 0!==n?n:[];return a.legs=h.map(((e,t)=>({symbol:e,pro_symbol:u[t]}))),a}(e))),t}function ah(e,t){if(Se(e,t.widgetOptions)){const i=new fe(e,!e.readOnly());i.beforeUnhibernating().subscribe(e,(()=>{!function(e){e.chartWidgetsDefs.map((e=>e.chartWidget)).forEach((e=>e.reloadAllLineTools()))}(t)})),t.setChartStorageNotificationSubscription(i)}}async function lh(e,t){if(t.widgetOptions.newsNotificationsEnabled){return new((await i.e(56370).then(i.bind(i,595321))).ChartWidgetCollectionNewsNotifier)(e)}return null}function ch(e,t){const i={snapshotUrl:e};return i.asyncSave=!window.TVD,A(t,i).then((e=>((0,Le.emit)("onScreenshotReady",e),e)))}function dh(e,t){const i={snapshotUrl:e};i.asyncSave=!window.TVD;const s=(0,ie.isOnMobileAppPage)("any");return(s?A:L)(t,i).then((e=>((0,Le.emit)("onScreenshotReady",e),s||(0,Le.emit)("onServerScreenshotCopiedToClipboard"),e)))}function hh(e){return function(e){return I().then((t=>t.downloadClientScreenshot(e)))}(e)}function uh(e){return function(e){return I().then((t=>t.copyToClipboardClientScreenshot(e)))}(e).then((()=>{(0,Le.emit)("onClientScreenshotCopiedToClipboard")}))}const ph={s:0,"2h":0,"2v":1,"2-1":1,"3s":0,"3h":0,"3v":2,4:1,6:1,8:1,"1-2":1,"3r":1,"4h":0,"4v":3,"4s":0,"4s-l":0,"5h":0,"5v":0,"6h":0,"6v":0,"7h":0,"8h":0,"8v":0,"1-3":1,"2-2":3,"2-2-l":0,"2-3":2,"3-2":3,"1-4":1,"2-4":2,"5s":0,"6c":4,"8c":6,"9s":6,"9h":0,"9v":0,"10h":0,"10v":0,"10c5":1,"12c6":1,"12c4":3,"14c7":1,"16c8":1,"16c4":3};function _h(e,t,i,s){let o=0;const r=(0,Pd.createWVFromGetterAndSubscriptions)((()=>++o),[i,s]);return(0,Je.combine)((t=>{var i;return null!==(i=e()[ph[t]])&&void 0!==i?i:null}),t.weakReference(),r.ownership())}function mh(e,t,i,s){var o;const r=Math.max(1,window.devicePixelRatio||1),n=e.getAll();let a;{const s=t||"TradingView.com",r={timezone:null!==(o=e.activeChartWidget.value().model().model().timezoneExceptExchange().value())&&void 0!==o?o:"exchange",dateFormat:"MMM dd, yyyy"},n=new ye.DateTimeWithTzFormatter(r).format(window.ChartApiInstance.serverTime()/1e3),l=e.metaInfo.username.value(),c=!l||e.readOnly()||i?qd:Gd,d=[c.split(/{date}/)[0].format({userName:l,customer:s}).trim(),n],h=[c.format({userName:l,
customer:s,date:n}).trim()];a="phone-vertical"===be.mediaState.device?d:h}const l=e.maximizedChartWidget().value();if(s&&s.onlyActiveChart||l)return{layout:"s",hidpiRatio:r,theme:(0,Te.getCurrentTheme)().name,charts:[e.activeChartWidget.value().images(s)],publishedBy:a};const c=[],d=Ie.layouts[e.layout.value()].count,h={showCollapsedStudies:(s=s||{}).showCollapsedStudies,status:s.status};for(let e=0;e<n.length&&e<d;e++)c.push(n[e].images(h));return{layout:e.layout.value(),hidpiRatio:r,theme:(0,Te.getCurrentTheme)().name,charts:c,publishedBy:a}}function gh(e,t,i,s){const o=s||{},r={hideResolution:Boolean(o.hideResolution)};return(0,l.isSymphonyEmbed)()||(o.showHeaderPublishedBy=!0),(0,Pe.clientSnapshot)(mh(e,t,i,{showCollapsedStudies:!1,status:r}),o)}function Sh(e){var t,i,s,o,r,n;const a=(null!==(t=e.options.edge)&&void 0!==t?t:0)+(null!==(i=e.options.border)&&void 0!==i?i:0),l=null!==(o=null===(s=e.bottomToolbar.value())||void 0===s?void 0:s.offsetHeight)&&void 0!==o?o:0,c=null!==(n=null===(r=e.replayContainer)||void 0===r?void 0:r.offsetHeight)&&void 0!==n?n:0;return{width:e.widthWV.value()-2*a,height:e.heightWV.value()-l-c-a,top:0,left:a}}function vh(e){return`chart-widget-collection-border-${e}`}function fh(e,t){const i=(0,fd.layoutInitialSizingState)(e.layoutTemplate.value().expression),s=e.layoutTemplate.value().layoutType,o=t=>t?e.allLayoutSizesState.set(s,t):e.allLayoutSizesState.delete(s);if(t)return e.sizingState.setValue(i),void o(i);e.undoHistory.beginUndoMacro(Dd),e.undoHistory.pushUndoCommand(new S(e.sizingState,e.sizingState.value(),i,Dd)),e.undoHistory.pushUndoCommand(new g(o,e.allLayoutSizesState.get(e.layoutTemplate.value().layoutType),i,Dd)),e.undoHistory.endUndoMacro()}function bh(e,t){fh(e,t)}class yh{constructor(e,t,i){this._onShiftPressed=e=>{const t=this._state.currentLayoutResizeAction.value();t&&this._applyMouseMove(t.delta,e)},this._state=e,this._splitterElement=t,this._splitter=i,(0,st.shiftPressed)().subscribe(this._onShiftPressed)}destroy(){(0,st.shiftPressed)().unsubscribe(this._onShiftPressed)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e)}mouseEnterEvent(e){this._highlightSplitters(e.shiftKey)}mouseLeaveEvent(e){const t=vh(this._splitter.className);Array.from(this._state.parent.getElementsByClassName(t)).forEach((e=>e.classList.remove(xd.hovered)))}mouseDoubleClickEvent(e){fh(this._state)}_highlightSplitters(e){const t=vh(this._splitter.className);Array.from(this._state.parent.getElementsByClassName(t)).forEach((e=>e.classList.remove(xd.hovered)));(e?Array.from(this._state.parent.getElementsByClassName(t)):[this._splitterElement]).forEach((e=>e.classList.add(xd.hovered)))}_mouseDownOrTouchStartEvent(e){const t=new o.Point(e.localX+this._splitterElement.offsetLeft,e.localY+this._splitterElement.offsetTop),i=(0,
bd.deepCopy)(this._state.sizingState.value());this._state.currentLayoutResizeAction.setValue({point:t,splitter:this._splitter,initialState:i,alignedState:this._state.layoutTemplate.value().syncSublayoutsBySplitter(this._splitter,(0,bd.deepCopy)(i)),shiftState:e.shiftKey,delta:0}),this._splitterElement.classList.add(xd["i-active"]),this._highlightSplitters(e.shiftKey)}_pressedMouseOrTouchMoveEvent(e){const t=this._state.currentLayoutResizeAction.value();if(!t)return;t.shiftState!==e.shiftKey&&(this._highlightSplitters(e.shiftKey),t.shiftState=e.shiftKey);const i=new o.Point(e.localX+this._splitterElement.offsetLeft,e.localY+this._splitterElement.offsetTop);t.delta="v"===t.splitter.orientation?i.y-t.point.y:i.x-t.point.x,this._applyMouseMove(t.delta,e.shiftKey)}_mouseUpOrTouchEndEvent(e){const t=this._state.currentLayoutResizeAction.value();if(t&&(this._splitterElement.classList.remove(xd["i-active"]),this._state.currentLayoutResizeAction.setValue(null),t.currentState)){this._state.undoHistory.beginUndoMacro(Ed),this._state.undoHistory.pushUndoCommand(new S(this._state.sizingState,t.initialState,t.currentState,Ed));const e=this._state.layoutTemplate.value().layoutType;this._state.undoHistory.pushUndoCommand(new g((t=>t?this._state.allLayoutSizesState.set(e,t):this._state.allLayoutSizesState.delete(e)),this._state.allLayoutSizesState.get(this._state.layoutTemplate.value().layoutType),this._state.sizingState.value(),Dd)),this._state.undoHistory.endUndoMacro(),this._state.layoutSizesChanged.setValue(!0)}}_applyMouseMove(e,t){var i;const o=(0,s.ensureNotNull)(this._state.currentLayoutResizeAction.value()),r=t?o.alignedState:o.initialState,n=null!==(i=this._state.options.padding)&&void 0!==i?i:2,a=Sh(this._state);o.currentState=this._state.layoutTemplate.value().resizeApplier(a,n,e,o.splitter,(0,bd.deepCopy)(r),t),this._state.sizingState.setValue(o.currentState)}}function Ch(e,t,i,s,o){var r,n;const a=null!==(r=e.options.padding)&&void 0!==r?r:2,l=null!==(n=e.options.border)&&void 0!==n?n:0;o=null!=o?o:e.layoutTemplate.value();const c=Sh(e),d=o.sizer(c,i,s,a+l,Id?e.sizingState.value():void 0);d.width=Math.max(Math.round(d.width),0),d.height=Math.max(Math.round(d.height),0),d.top=Math.round(d.top),d.left=Math.round(d.left),t.metrics=d;const h=t.container.value();if(h){h.style.width=d.width+"px",h.style.height=d.height+"px",h.style.top=d.top+"px",h.style.left=d.left+"px";const e=1===s;h.classList.toggle("single-visible",e);const t=Math.round(c.width),i=0===d.top&&0===d.left,o=0===d.top&&d.left+d.width===t,r=0===d.top&&d.width===t;h.classList.toggle("top-left-chart",!e&&!r&&i),h.classList.toggle("top-right-chart",!e&&!r&&o),h.classList.toggle("top-full-width-chart",e||r)}t.width.setValue(d.width),t.height.setValue(d.height)}function wh(e){var t,i,s;let o;const r=e.layoutTemplate.value(),n=e.maximizedChartDef.value();if(o=n?[n]:e.chartWidgetsDefs.slice(0,r.count).filter((e=>!e.hiddenInLayout.value())),o.forEach(((t,i)=>Ch(e,t,i,o.length))),Id&&!e.maximizedChartDef.value()){
const o=Sh(e),n=null!==(t=e.options.padding)&&void 0!==t?t:2,a=null!==(i=e.options.border)&&void 0!==i?i:0,l=r.splitters(o,n+a,e.sizingState.value()),c=null!==(s=e.splitters.value())&&void 0!==s?s:[];c.forEach(((e,t)=>{t>=l.length&&(e.splitterElement.remove(),e.mouseHandler.destroy(),e.mouseListener.destroy())}));const d=l.map(((t,i)=>{const s=i<c.length?c[i].splitterElement:document.createElement("div");let o,r;i<c.length?(o=c[i].mouseListener,r=c[i].mouseHandler):(o=new yh(e,s,t),r=new Ft.MouseEventHandler(s,o));const n=t.metrics,a=s.classList.contains(xd.hovered),l=s.classList.contains(xd["i-active"]);return s.className="",s.classList.add(xd.chartsSplitter),s.classList.add(vh(t.className)),a&&s.classList.add(xd.hovered),l&&s.classList.add(xd["i-active"]),s.style.left=n.left+"px",s.style.top=n.top+"px",s.style.width=n.width+"px",s.style.height=n.height+"px",s.setAttribute("aria-hidden","true"),"v"===t.orientation?s.style.cursor="ns-resize":s.style.cursor="ew-resize",e.parent.insertBefore(s,e.bottomToolbar.value()),{splitter:t,splitterElement:s,mouseHandler:r,mouseListener:o}}));e.splitters.setValue(d)}}function Th(e,t,i){const s=e.chartWidgetsDefs.slice(0,e.layoutTemplate.value().count).map(((t,i,s)=>({def:t,metrics:e.layoutTemplate.value().sizer({top:0,left:0,width:256,height:256},i,s.length,0)}))).sort(((e,t)=>e.metrics.top-t.metrics.top||e.metrics.left-t.metrics.left)).map((e=>e.def));if(s.length<2)return null;let o=s.indexOf(t);return-1===o?null:(o=(o+(i?s.length-1:1))%s.length,s[o])}function Ph(e,t){return e.chartWidgetsDefs.some((e=>{var i;return(null===(i=e.chartWidget)||void 0===i?void 0:i.id())===t}))}function Mh(e){let t=1;for(;e(""+t);)t++;return""+t}function xh(e,t,i){const s=[];if(null==i?void 0:i.publishedChartsEnabled){const t=new z.PublishedChartsTimeline(e,(e=>function(e){(0,ee.openPublicationViewPopup)(e)}(e)));s.push(t)}return s}function Ih(e,t,i){var o,r;const{toastsFactory:n,chartWidgetsDefs:a,customLegendWidgetsFactoriesMap:c}=e;let d={chartWidgetCollection:t,isActive:0===a.length,barsMarksContainersFactory:t=>xh(t,0,e.options),undoHistory:e.undoHistory,readOnly:e.readOnly,initialLoading:e.initialLoading,getToasts:n?()=>n.getChartToasts():void 0,...null!=i?i:{}};void 0!==c&&(d.customLegendWidgetFactories=new Map(c));const h=document.createElement("div");h.classList.add("chart-container"),h.style.position="absolute",h.style.overflow="hidden",e.parent.insertBefore(h,e.bottomToolbar.value()),l.isEdge&&(h.style.touchAction="none",h.style.msTouchAction="none"),d.className&&h.classList.add(d.className);const p={alive:new u.WatchedValue(!0),container:new u.WatchedValue(h),width:new u.WatchedValue,height:new u.WatchedValue,collapsed:new u.WatchedValue(!1),hiddenInLayout:new u.WatchedValue(!1),visible:new u.WatchedValue,rdState:new Ae.ResizerDetacherState,requestFullscreen:()=>{e.globalDetachable.value()&&(e.setMaximized(p),e.activeChartWidget.setValue((0,s.ensureNotNull)(p.chartWidget)))},exitFullscreen:()=>{e.activeChartWidget.value()===p.chartWidget&&e.setMaximized(null)},
detachable:e.globalDetachable,fullscreenable:e.globalDetachable,fullscreen:new u.WatchedValue,chartWidget:null};p.rdState.pushOwner(p),a.push(p);const _=()=>{p.visible.setValue(!p.hiddenInLayout.value()&&e.options.resizerBridge.visible.value())};p.hiddenInLayout.subscribe((()=>{(0,s.ensureNotNull)(p.chartWidget).setVisible(!p.hiddenInLayout.value()),_()})),p.collapsed.subscribe((()=>(0,s.ensureNotNull)(p.chartWidget).setCollapsed(p.collapsed.value()))),e.options.resizerBridge.visible.subscribe(_),_(),function(e,t){let i=0,s=0;const o=t.layoutTemplate.value();for(let r=0;r<o.count;r++)t.chartWidgetsDefs[r]===e&&(s=i),i++;Ch(t,e,s,i,o)}(p,e),d={...d,...p.rdState.bridge()};const m=d.content?(0,s.ensureDefined)(d.content.chartId):Mh((t=>Ph(e,t))),g=p.chartWidget=new vd(d,m,t.metaInfo.uid.value());e.saveChartService&&g.setSaveChartService(e.saveChartService),e.readOnly||(p.timingsMeter=new H(String(a.length-1)),g.setTimingsMeter(p.timingsMeter)),d.containsData?g.finishInitWithoutConnect():g.connect(),g.withModel(null,(()=>{const t=g.model().model();e.customSources.forEach(((e,i)=>{t.addCustomSource(i,e.factory,e.layer)}))})),e.updateWatchedValue(),e.updateActivityView();const S=null!==(r=null===(o=null==d?void 0:d.content)||void 0===o?void 0:o.linkingGroup)&&void 0!==r?r:null;g.linkingGroupIndex().setValue(S),g.linkingGroupIndex().subscribe(e.updateLinkingGroupCharts);const v=uu(e,S).value();return v.length>0&&(e.symbolLock.value()&&g.setSymbol(v[0].symbolWV().value()),e.intervalLock.value()&&g.setResolution(v[0].resolutionWV().value())),e.updateLinkingGroupCharts(),e.chartWidgetCreatedDelegate.fire(g),p}function Lh(e,t,i,s){let o,r=e.savedChartWidgetOptions.shift();if(void 0!==r){const t=e.activeChartWidget.value();t&&t.lineToolsSynchronizer()&&(o=t.lineToolsAndGroupsDTO())}else r=function(e){const t=e.activeChartWidget.value();if(t){const i=t.state();return i.chartId=Mh((t=>Ph(e,t))),i.shouldBeSavedEvenIfHidden=!1,i.panes.forEach((e=>{e.sources.forEach((e=>{"alertId"in e&&(e.alertId=void 0)}))})),{content:i}}}(e);const n={...e.widgetOptions,...r,...0===i||e.symbolLock.value()?void 0:{defSymbol:null}},a=Ih(e,t,n),{chartWidget:l}=a;return l.modelCreated().subscribe(null,(()=>{s?s():e.checkAllPendingModelsAlreadyCreated(),e.dateRangeLock.value()&&l===e.activeChartWidget.value()&&e.subscribeToCompletedEventForDateRangeSync(l,!0);const t=l.lineToolsSynchronizer();void 0!==o&&t&&[...o.entries()].map((([e,i])=>{0!==e&&t.applyDTO(i,e).then((()=>{t.invalidateAll()}))}));const i=e.chartWidgetsDefs.filter((e=>e.chartWidget.hasModel())).map((e=>e.chartWidget.model()));e.chartModels.setValue(i)}),!0),a}function Ah(e){e.hiddenInLayout.setValue(!0);const t=e.container.value();t.parentNode&&t.parentNode.removeChild(t),e.fullscreen.setValue(!1)}function kh(e,t,i){const o=(0,s.ensureNotNull)(e.chartWidget);o.onZoom().unsubscribeAll(i),o.onScroll().unsubscribeAll(i),o.withModel(null,(()=>{const e=o.lineToolsSynchronizer();null!==e&&(e.hasChanges().unsubscribe(t.recalcHasChanges),t.recalcHasChanges())}))}function Eh(e,t){
e.chartWidgetsDefs.forEach((i=>{kh(i,e,t)}))}function Dh(e,t){const i=e.actualLayoutCount();for(let s=i;s<e.chartWidgetsDefs.length;s++)kh(e.chartWidgetsDefs[s],e,t);e.chartWidgetsDefs.splice(i,e.chartWidgetsDefs.length-i)}function Bh(e,t){e.chartWidgetsDefs.forEach((i=>{const o=(0,s.ensureNotNull)(i.chartWidget);o.onZoom().subscribe(t,(t=>e.onZoom.fire(t))),o.onScroll().subscribe(t,(()=>e.onScroll.fire())),o.withModel(null,(()=>{const t=o.lineToolsSynchronizer();null!==t&&(t.hasChanges().subscribe(e.recalcHasChanges),e.recalcHasChanges())}))}))}const Nh=["2-3","5h","6h","7h","8h"],Rh=["10c5","12c6","12c4","14c7","16c8","16c4"];async function Oh(e){var t,i;const o=this.innerState();(0,D.getInitData)().is_mobile_new&&(Nh.includes(e)&&!(0,d.enabled)("mobile_app_supports_new_layout_types")||Rh.includes(e)&&!(0,d.enabled)("mobile_app_supports_new_layout_types_2"))&&(e="s");{let e=!1;if(o.saveChartService&&(e=Boolean(o.saveChartService.autoSaveEnabled().value())),e)try{const e=o.chartWidgetsDefs.map((e=>{var t,i,s;return null!==(s=null===(i=null===(t=e.chartWidget)||void 0===t?void 0:t.lineToolsSynchronizer())||void 0===i?void 0:i.flushPendingSavings())&&void 0!==s?s:null})).filter(je.notNull);e.length&&await Promise.all(e)}catch(e){Ld.logError(`Error flushing line tools: ${e}`)}}(e=o.checkProFeature(e))in Ie.layouts||(e="s"),Eh(o,this);const r=o.layoutType,n=Ie.layouts[e].count;(0,Le.emit)("layout_about_to_be_changed",e),(null!==(t=o.splitters.value())&&void 0!==t?t:[]).forEach(((e,t)=>{e.splitterElement.remove(),e.mouseHandler.destroy()})),o.splitters.setValue([]);const a=Ie.layouts[e];o.layoutTemplate.setValue(a);const l=null!==(i=o.allLayoutSizesState.get(a.layoutType))&&void 0!==i?i:(0,fd.layoutInitialSizingState)(a.expression);o.allLayoutSizesState.set(a.layoutType,l),o.sizingState.setValue(l);const c=o.maximizedChartDef.value();if(o.isPhoneSize.value()&&o.viewMode.value()===p.CollectionViewMode.ForceFullscreen)if(c){const e=o.chartWidgetsDefs.indexOf(c);(e<0||e>=n)&&o.maximizedChartDef.setValue(o.chartWidgetsDefs[0])}else o.maximizedChartDef.setValue(o.chartWidgetsDefs[0]);else r!==e&&o.maximizedChartDef.value()&&o.maximizedChartDef.setValue(null);c&&o.activeChartWidget.setValue((0,s.ensureNotNull)(c.chartWidget));for(let e=0;e<n||e<o.chartWidgetsDefs.length;e++){let t,i=o.chartWidgetsDefs[e];const r=e>=n;if(t=o.maximizedChartDef.value()?o.maximizedChartDef.value()===i:e<n,t){if(i){if(o.parent.insertBefore(i.container.value(),o.bottomToolbar.value()),i.hiddenInLayout.setValue(!1),o.loadingContent){const e=o.savedChartWidgetOptions.shift();e&&(o.setLoadingContent(!0),(0,s.ensureNotNull)(i.chartWidget).loadContent(e.content,o.initialLoading),o.setLoadingContent(!1))}}else Lh(o,this,e,void 0),i=o.chartWidgetsDefs[e];i.container.value().classList.toggle("multiple",n>1),i.fullscreen.setValue(o.maximizedChartDef.value()===i),i.collapsed.setValue(r)}else i?(Ah(i),i.collapsed.setValue(r)):o.isPhoneSize.value()&&o.viewMode.value()===p.CollectionViewMode.ForceFullscreen&&(Lh(o,this,e,void 0),Ah(o.chartWidgetsDefs[e]),
o.chartWidgetsDefs[e].collapsed.setValue(r))}o.sizingState.setValue(l),wh(o),o.layoutWV.setValue(e),o.setLayoutType(e),o.updateWatchedValue(),function(e){const t=e.layoutTemplate.value().count;e.inlineChartsCount.setValue(t),e.globalDetachable.setValue(t>1)}(o),o.checkAllPendingModelsAlreadyCreated(),Bh(o,this),o.initialLoading||o.updateViewMode(),o.inlineChartsCount.value()<1&&n>0&&o.chartWidgetsDefs[n-1].rdState.bridge().attach()}function Vh(e,t,i,s,o){const r=e.actualLayoutCount();return e.chartWidgetsDefs.slice(0,r).filter((e=>e.rdState.bridge().visible.value())).map((e=>e.chartWidget)).filter((t=>t.id()!==i&&(!!t.hasModel()&&(t.selectPointMode().value()===Yt.SelectPointMode.Replay&&"AllCharts"===J.replayModeProperty.value()||(s||e.crosshairLockRaw))))).forEach((e=>e.model().model().setExternalPosition(t,o))),!0}function Wh(e,t,i,s,o){if(Vh(e,t,i,s,o)){const i=e.crossHairSyncBroadcast;if(i){const e={type:"crosshair",payload:{point:t,envState:o,sourceUniqueId:i.uniqueId}};i.channel.postMessage(e)}}}function Fh(e){const t=new BroadcastChannel("ChartWidgetsCollection");return t.onmessage=t=>{const i=t.data,s=e();if(s.crossHairSyncBroadcast&&"crosshair"===i.type)s.crossHairSyncBroadcast.uniqueId!==i.payload.sourceUniqueId&&Vh(s,i.payload.point,null,!1,i.payload.envState)},{channel:t,uniqueId:(0,xe.randomHashN)(6)}}function Hh(e){var t;null===(t=e.crossHairSyncBroadcast)||void 0===t||t.channel.close()}function zh(e,t,i){if(!e.combinedTrackTimeLock.value()||e.dateRangeLock.value())return;const s=e.layoutTemplate.value().count;e.undoHistory.beginUndoMacro(kd),e.chartWidgetsDefs.slice(0,s).filter((e=>e.chartWidget.hasModel()&&e.chartWidget.model().model()!==i)).forEach((e=>{const i=e.chartWidget.model().model(),s=i.mainSeries().syncModel();s&&i.syncTimeWithModel(s.syncSourceTarget(),t)})),e.undoHistory.endUndoMacro(),(0,Le.emit)("sync_time",t)}function Uh(e){return Promise.all(e.map((e=>{const t=e.model().mainSeries();return t.symbolResolvingActive().value()?h(t.dataEvents().symbolResolved()).promise:t.symbolInfo()})))}function Gh(e){return e.chartWidgetsDefs.every((e=>e.chartWidget.hasModel()))?Promise.resolve(e.chartWidgetsDefs.map((e=>e.chartWidget))):Promise.all(e.chartWidgetsDefs.map((e=>e.chartWidget.hasModel()||h(e.chartWidget.modelCreated()).promise))).then((()=>Gh(e)))}function qh(e,t){var i,o,r;if("s"===t||e.widgetOptions.containsData||e.readOnly||(0,Y.enabled)("MULTIPLE_CHARTS")&&(0,s.ensure)(null===(i=(0,Y.getConfig)("MULTIPLE_CHARTS"))||void 0===i?void 0:i.limit)>=Ie.layouts[t].count)return t;let n="s";{let i=1;const s=null!==(r=null===(o=(0,Y.getConfig)("MULTIPLE_CHARTS"))||void 0===o?void 0:o.limit)&&void 0!==r?r:0;for(const e of Object.keys(Ie.layouts)){const t=Ie.layouts[e].count;t<=s&&t>i&&(n=e,i=t)}Gh(e).then(Uh).then((()=>{(0,Z.trackGoProFeature)("multipleCharts"),(0,$.createGoProDialog)({feature:"multipleCharts",customParams:Ie.layouts[t].count})}))}return n}async function jh(e,t,i){if(i=qh(e,i),e.layoutWV.value()===i)return!1;{let t=!1
;if(e.saveChartService&&(t=Boolean(e.saveChartService.autoSaveEnabled().value())),t){const t=e.chartWidgetsDefs.map((e=>{var t,i,s;return null!==(s=null===(i=null===(t=e.chartWidget)||void 0===t?void 0:t.lineToolsSynchronizer())||void 0===i?void 0:i.flushPendingSavings())&&void 0!==s?s:null})).filter(je.notNull);if(t.length)try{await Promise.all(t)}catch(e){Ld.logError(`Error flushing line tools: ${e}`)}}}return e.undoHistory.pushUndoCommand(new Cd(t,i)),!0}async function Kh(e,t,i){const{theme:s,onlyActiveChart:o,restoreNonThemeDefaults:r,themeName:n,standardTheme:a,syncState:l=!0,noUndo:c}=i,d=(0,Te.getCurrentTheme)().name;let h;o?h=[e.activeChartWidget.value()]:(Eh(e,t),await Promise.all(e.savedChartWidgetOptions.map(((e,t)=>t)).map((i=>new Promise((s=>{Ah(Lh(e,t,i,s))}))))),h=e.chartWidgetsDefs.map((e=>e.chartWidget)),Bh(e,t)),c?(a&&new Td(d,n,l).redo(),h.forEach((e=>{e.model().model().restoreTheme(s,r,c)}))):(e.undoHistory.beginUndoMacro(Bd),a&&e.undoHistory.pushUndoCommand(new Td(d,n,l)),h.forEach((e=>{e.model().model().restoreTheme(s,r)})),e.undoHistory.endUndoMacro()),await Promise.all(h.map((e=>e.model().model().colorStudiesPropertiesReady())))}function Zh(e,t){e.symbolLock.setValue(t)}function Yh(e,t){const{internalSymbolLock:i,activeChartWidget:s,undoHistory:o,dateRangeLock:r,loadingContent:n,linkingGroupsCharts:l,chartWidgetsDefs:c}=e;if(t!==i.value())if(n)i.setValue(t);else{if(e.undoHistory.beginUndoMacro(Nd),t){const t=s.value(),i=c.map((e=>e.chartWidget));l.forEach(((s,o)=>{const n=t.linkingGroupIndex().value()===o?t:i.find((e=>e.linkingGroupIndex().value()===o));if(void 0!==n){(0,a.muteLinkingGroup)(o,!0);for(const t of s.value())t!==n&&t.symbolWV().value()!==n.symbolWV().value()&&(t.setSymbol(n.symbolWV().value()),r.value()&&e.subscribeToCompletedEventForDateRangeSync(t,!0));(0,a.muteLinkingGroup)(o,!1)}}))}o.setWatchedValue(i,t,Nd),o.endUndoMacro()}}function $h(e,t){e.intervalLock.setValue(t)}function Xh(e,t){const{internalIntervalLock:i,activeChartWidget:s,undoHistory:o,dateRangeLock:r,loadingContent:n,chartWidgetsDefs:l,linkingGroupsCharts:c}=e;if(t!==i.value())if(n)i.setValue(t);else{if(o.beginUndoMacro(Rd),t&&t){const t=s.value(),i=l.map((e=>e.chartWidget));c.forEach(((s,o)=>{const n=t.linkingGroupIndex().value()===o?t:i.find((e=>e.linkingGroupIndex().value()===o));if(void 0!==n){(0,a.muteLinkingGroup)(o,!0);for(const t of s.value())t!==n&&t.resolutionWV().value()!==n.resolutionWV().value()&&(t.setResolution(n.resolutionWV().value()),r.value()&&e.subscribeToCompletedEventForDateRangeSync(t,!0));(0,a.muteLinkingGroup)(o,!1)}}))}o.setWatchedValue(i,t,Rd),o.endUndoMacro()}}function Jh(e,t){const i=e.activeChartWidget.value();if(i&&i.hasModel()){const s=i.model();t?(e.subscribeToEventsForDateRangeSync(s),e.syncChartsDateRangesWithActiveChartRange()):e.unsubscribeFromEventsForDateRangeSync(s)}e.dateRangeLock.setValue(t)}function Qh(e,t){const{internalDateRangeLock:i,undoHistory:s,loadingContent:o}=e;o?i.setValue(t):s.setWatchedValue(i,t,Od)}function eu(e,t){e.trackTimeLock.setValue(t)}
function tu(e,t){const{internalTrackTimeLock:i,undoHistory:s,loadingContent:o}=e;o?i.setValue(t):s.setWatchedValue(i,t,Vd)}async function iu(e,t){const i=e.chartWidgetsDefs.map((e=>e.chartWidget));return su(e,t,void 0,void 0,i)}async function su(e,t,i,s,o){const r=null!=s?s:e.activeChartWidget.value();void 0===i&&(i=r.linkingGroupIndex().value());{const i=(o=null!=o?o:e.symbolLock.value()?e.chartWidgetsDefs.map((e=>e.chartWidget)):[r]).filter((e=>e.model().isInReplay().value()));if(i.length){if(!(await Promise.all(i.map((e=>e.model().canChangeSymbol(t))))).some(Boolean))return!1}}for(const e of o)(e.hasModel()?e.model().mainSeries().symbolSameAsResolved(t):e.symbolWV().value()===t)||void 0!==i&&e.linkingGroupIndex().value()!==i||e.setSymbol(t);return!0}async function ou(e,t=this.activeChartWidget.value()){if(!t)return!1;{if(js.Interval.isTicks(t.resolutionWV().value())&&(4===e||7===e||5===e||6===e))return t.showHint(1,{text:Zd.format({chartStyle:(0,we.getTranslatedChartStyleName)(e)}),solutionId:Q.solutionIds.WHY_RENKO_NOT_WORK,solutionText:n.t(null,void 0,i(744955))}),!1;let s=!1;const o=nu(this.innerState());for(const t of o){const i=t.model().model();if(i.isInReplay().value()&&!i.mainSeries().isStyleSupported(e)){s=!0;break}}const r=this.innerState().flags;return!s||r.isConfirmationAboutReplayLocked?(ru(t,e),!0):new Promise((i=>{(0,Nl.showConfirm)({text:jd,onConfirm:s=>{r.isConfirmationAboutReplayLocked=!0,ru(t,e),r.isConfirmationAboutReplayLocked=!1,s.dialogClose(),i(!0)},onClose:()=>i(!1),onCancel:e=>{e.dialogClose(),i(!1)}})}))}}function ru(e,t){const i=e.model(),s=i.mainSeries().properties().childs().style;i.setChartStyleProperty(s,t,Wd)}function nu(e){return(e.intervalLock.value()?e.chartWidgetsDefs.map((e=>e.chartWidget)):[e.activeChartWidget.value()]).filter((e=>e.hasModel()))}async function au(e,t,s,o){if(e.flags.loadingChart||e.flags.setTimeFrameActive||e.flags.setNewResolution)return!1;{const r=js.Interval.isTicks(t),a=nu(e);if(r)for(const e of a){const t=e.model().model().mainSeries().style();if(4===t||7===t||5===t||6===t)return e.showHint(1,{text:Zd.format({chartStyle:(0,we.getTranslatedChartStyleName)(t)}),solutionId:Q.solutionIds.WHY_RENKO_NOT_WORK,solutionText:n.t(null,void 0,i(744955))}),!1}let l="",c=!1;const d=js.Interval.isRange(t);if(d||r)for(const e of a){const t=e.model().model();if(t.isInReplay().value()){if(d&&11!==t.mainSeries().style()){c=!0,l=jd;break}r&&(c=!0,l=Kd)}}const h=a.filter((e=>e.model().isInReplay().value()));if(h.length){if(!(await Promise.all(h.map((e=>e.model().canChangeResolution(t))))).every(Boolean))return!1}return!c||e.flags.isConfirmationAboutReplayLocked?(lu(e,t,s,o),!0):new Promise((i=>{(0,Nl.showConfirm)({text:l,onConfirm:r=>{e.flags.isConfirmationAboutReplayLocked=!0,lu(e,t,s,o),e.flags.isConfirmationAboutReplayLocked=!1,r.dialogClose(),i(!0)},onClose:()=>i(!1),onCancel:e=>{e.dialogClose(),i(!1)}})}))}}function lu(e,t,i,s){if((0,ds.setLastUsedResolution)(t),e.flags.setNewResolution=!0,s=null!=s?s:e.activeChartWidget.value(),
void 0===i&&(i=s.linkingGroupIndex().value()),e.intervalLock.value())for(const s of e.chartWidgetsDefs){const e=s.chartWidget;e.resolutionWV().value()===t||void 0!==i&&e.linkingGroupIndex().value()!==i||e.setResolution(t)}else s.setResolution(t);e.flags.setNewResolution=!1}function cu(e){const t=new u.WatchedValue(null),i=()=>{t.setValue(e.value().linkingGroupIndex().value())};e.value()&&i();const s=e.spawn();let o;return s.subscribe((e=>{null==o||o.destroy(),o=e.linkingGroupIndex().spawn(),o.subscribe(i),i()})),t.spawn((()=>{s.destroy(),null==o||o.destroy()}))}function du(e){const t=new Set(e.map((e=>e.chartWidget.linkingGroupIndex().value())));return Array.from(t).sort(((e,t)=>(null!=e?e:-1)-(null!=t?t:-1)))}function hu(e){const t=new Md.WatchedObject(du(e.chartWidgetsDefs)),i=()=>{t.setValue(du(e.chartWidgetsDefs))};e.chartWidgetsDefs.forEach((e=>e.chartWidget.linkingGroupIndex().subscribe(i)));const s=e=>{e.linkingGroupIndex().subscribe(i),i()};return e.chartWidgetCreatedDelegate.subscribe(null,s),t.spawn((()=>{e.chartWidgetsDefs.forEach((e=>e.chartWidget.linkingGroupIndex().unsubscribe(i))),e.chartWidgetCreatedDelegate.unsubscribe(null,s)}))}function uu(e,t){let i=e.linkingGroupsCharts.get(t);return void 0===i&&(i=new Md.WatchedObject([],Me.compareTwoCollectionsByIds),e.linkingGroupsCharts.set(t,i)),i}function pu(e){var t;const i=new Map;for(const t of e.chartWidgetsDefs){const e=t.chartWidget.linkingGroupIndex().value();let s=i.get(e);void 0===s&&(s=[],i.set(e,s)),s.push(t.chartWidget)}for(const s of(0,Me.join)(new Set(e.linkingGroupsCharts.keys()),new Set(i.keys())))uu(e,s).setValue(null!==(t=i.get(s))&&void 0!==t?t:[])}function _u(e){if(e){const e=function(){var e,t,i,o;const r=null!==(t=null===(e=(0,Y.getConfig)("BACKEND_CONNECTIONS"))||void 0===e?void 0:e.limit)&&void 0!==t?t:0,n=(0,s.ensureDefined)(window.pro),a=n.getProductsByType(n.PRODUCT_TYPES.pro_plan);for(const e of a)if((null!==(o=null===(i=(0,Y.getConfig)("BACKEND_CONNECTIONS",(0,s.ensureDefined)(e.id)))||void 0===i?void 0:i.limit)&&void 0!==o?o:0)>r)return{connectionCount:r,moreConnectionsPlanAvailable:!0};return{connectionCount:r,moreConnectionsPlanAvailable:!1}}(),t=[{text:n.t(null,void 0,i(906186)),action:X.PredefinedAction.Close,variant:"secondary",color:"gray",compactMode:!0,onClick:()=>window.ChartApiInstance.connect()}];e.moreConnectionsPlanAvailable&&t.push({action:X.PredefinedAction.OpenGopro,text:n.t(null,void 0,i(987780)),compactMode:!0}),(0,$.createGoProDialog)({feature:"connectionsLimit",actionButtonsLayout:X.ActionButtonsLayout.Row,actions:t,customParams:e})}}function mu(e,t){let i=[];const s={},o=()=>{i.forEach((e=>e.unsubscribe(a))),i=t.filter((e=>e.chartWidget.hasModel())).map((e=>e.chartWidget.selectPointMode())),i.forEach((e=>e.subscribe(a))),t.forEach((e=>{e.chartWidget.hasModel()||e.chartWidget.withModel(s,(()=>{o(),a()}))}))};o();const r=()=>i.some((e=>e.value()===Yt.SelectPointMode.Replay))&&"AllCharts"===J.replayModeProperty.value(),n=new u.WatchedValue(r()),a=()=>n.setValue(r()),l=()=>{o(),a()};e.subscribe(l),
J.replayModeProperty.subscribe(n,a);return n.spawn((()=>{J.replayModeProperty.unsubscribe(n,a),e.unsubscribe(l),i.forEach((e=>e.subscribe(a)))}))}function gu(e,t,i){return(0,Je.combine)(((e,t)=>e||t),t.weakReference(),mu(e,i).ownership())}function Su(e,t,i){const s=t.id();if(e.chartWidgetIdToCompletedCallbackMap.has(s))return;const o=()=>{e.chartWidgetIdToCompletedCallbackMap.has(s)&&(e.chartWidgetIdToCompletedCallbackMap.delete(s),Tu(e,i?t:void 0))};t.model().mainSeries().dataEvents().completed().subscribe(null,o,!0),e.chartWidgetIdToCompletedCallbackMap.set(s,{cw:t,callback:o})}function vu(e){Tu(e)}const fu=new Map;function bu(e){var t;const i=null!==(t=fu.get(e.id()))&&void 0!==t?t:{};return fu.set(e.id(),i),i}function yu(e,t){t.timeScale().visibleBarsStrictRangeChanged().subscribe(bu(t),vu.bind(null,e))}function Cu(e,t){t.timeScale().visibleBarsStrictRangeChanged().unsubscribeAll(bu(t)),e.chartWidgetIdToCompletedCallbackMap.forEach((e=>{const t=e.cw,i=e.callback;t.model().mainSeries().dataEvents().completed().unsubscribe(null,i)})),e.chartWidgetIdToCompletedCallbackMap.clear()}function wu(e,t,i){e.model().model().gotoTimeRange(t,i),(0,Le.emit)("sync_date_range",t,i)}function Tu(e,t){if(!e.dateRangeLock.value()||null!==e.currentLayoutResizeAction.value())return;const i=e.activeChartWidget.value(),o=i.model().mainSeries();if(!(0,we.isTimeBasedStyle)(o.style()))return;const r=i.model().timeScale(),n=r.visibleBarsStrictRange();if(null===n)return;const a=(0,s.ensureNotNull)(r.points().range().value());let l=r.indexToTimePoint(n.firstBar());null===l&&o.endOfData()&&(l=r.indexToTimePoint(a.firstIndex));let c=r.indexToTimePoint(n.lastBar());if(null===c&&(c=r.indexToTimePoint(a.lastIndex)),null===l||null===c)return void Su(e,i,!1);e.chartWidgetIdToCompletedCallbackMap.delete(i.id());let d=1e3*l,h=1e3*c;if(o.isDWM()){const e=new Date(d),t=new Date(h);(0,Ce.set_hms)(e,0,0,0,0),(0,Ce.set_hms)(t,0,0,0,0),d=e.getTime(),h=t.getTime()}for(let s=0;s<e.chartWidgetsDefs.length;s++){const o=e.chartWidgetsDefs[s].chartWidget;o.hasModel()&&o!==i&&(void 0===t||o===t)&&(0,we.isTimeBasedStyle)(o.model().mainSeries().style())&&setTimeout(wu.bind(null,o,d,h))}}function Pu(e){const{addOnlyActiveChart:t,...i}=e,s=this.innerState();let o=t?this.getAll().indexOf(this.activeChartWidget.value()):0;const r=t?o+1:s.chartsCountToSave(),n=[];let a;for(;o<r;o++){const e=Qd.call(this,o,i);if(e){let t=e;{const e=e=>/^study_?.*$/gim.test(e.type);t={...t,panes:t.panes.map((t=>({...t,sources:t.sources.map((t=>{if(e(t)){const{metaInfo:e,metaInfo:{fullId:i,pine:s},...o}=t;a||(a={});const r=`${i}${s?`[v.${s.version}]`:""}`;return a[r]||(a[r]=e),{...o,metaInfo:r}}return t}))})))}}n.push(t)}}const l=t?void 0:Array.from(s.allLayoutSizesState.entries()).reduce(((e,[t,i])=>(e[t]=i,e)),{});return{name:this.metaInfo.name.value(),layout:t?"s":s.layoutType,charts:n,symbolLock:Mu(s.symbolLock),intervalLock:Mu(s.intervalLock),trackTimeLock:Mu(s.trackTimeLock),dateRangeLock:Mu(s.dateRangeLock),crosshairLock:Mu(s.crosshairLock),layoutsSizes:l,studyMetaInfoMap:a}}
function Mu(e){return e.value()?1:0}function xu(e){Gs.StudyMetaInfo.mergeDefaultsOverrides(e),(0,Ll.studyMetaInfoRepository)().isReady()&&Gs.StudyMetaInfo.overrideDefaults((0,Ll.studyMetaInfoRepository)().getInternalMetaInfoArray())}},475268:(e,t,i)=>{"use strict";const{clone:s}=i(124829);var o=i(650151).assert,r=i(442657).layouts,n=i(405338).createUndoHistory,a=i(419283),l=i(799786),c=i(470316),d=i(251954),h=i(764829),u=i(566238).WatchedObject,p=i(375397).WatchedValue,_=i(338619).getLogger("Chart.ChartWidgetCollection"),m=i(228609).preventDefaultForContextMenu,g=i(540519),S=i(161590).GeneralChartPropertiesRenderer,v=i(834698).CompareDialogRenderer,f=i(314802).isOnMobileAppPage,b=i(942634).Delegate;const{isSupportedLayout:y,tryGuessingTheMostSuitableLayout:C}=i(442657);var w=i(26829).CollectionViewMode,T=i(850775).mediaState,P=i(778660).SwapChartsUndoCommand,M=i(489935).ToastsFactory,x=i(271868).reconnectChartApi,I=i(516284).marketStatusText;const L=i(79342).randomHash;var A=i(317612),k=A.applyIndicatorsToAllChartsImpl,E=A.applyIndicatorToAllChartsImpl,D=A.lineToolsAndGroupsDTOsImpl,B=A.resetLineToolsInvalidatedImpl,N=A.applyLineToolUpdateNotificationImpl,R=A.createClipboardHandler,O=A.chartsSymbolsImpl,V=A.updateLayoutImpl,W=A.computeContentBoxImpl,F=A.getVisuallyAdjacentDefImpl,H=A.setLayoutImpl,z=A.removeChartWidgetSubscriptionsImpl,U=A.generateNewChartId,G=A.syncCrosshairImpl,q=A.createBroadcastChannel,j=A.destroyBroadcastChannel,K=A.syncScrollImpl,Z=A.allInitialModelsCreated,Y=A.allInitialSymbolsResolved,$=A.applyThemeImpl,X=A.handleDateRangeLockChange,J=A.handleInternalDateRangeLockChange,Q=A.handleTrackTimeLockChange,ee=A.handleInternalTrackTimeLockChange,te=A.handleIntervalLockChange,ie=A.handleInternalIntervalLockChange,se=A.handleSymbolLockChange,oe=A.handleInternalSymbolLockChange,re=A.handleConnectionLimitReachedChanged,ne=A.createLeftBottomChartWidgetWV,ae=A.subscribeToEventsForDateRangeSync,le=A.unsubscribeFromEventsForDateRangeSync,ce=A.syncChartsDateRangesWithActiveChartRange,de=A.subscribeToCompletedEventForDateRangeUpdate,he=A.resetLayoutSizesImpl,ue=A.unloadUnusedChartsImpl,pe=A.applyStudiesOverrides,_e=new Map,me=A.setBrokerImpl,ge={saveChartEnabled:!0,takeScreenshotEnabled:!0,publishedChartsEnabled:!0};e.exports=function(e){var t=this,Se=Object.assign({},ge,e),ve=new p,fe=Se.readOnly||!1,be=!1,ye=L(),Ce=[],we=0,Te=new p,Pe=new p,Me=new p,xe="s",Ie=new p(null),Le=new Map,Ae=new p([]),ke=new p;ke.setValue(w.ForceFullscreen);var Ee=[];const De={isConfirmationAboutReplayLocked:!1,loadingChart:!1,setTimeFrameActive:!1,setNewResolution:!1};var Be=!1,Ne=!1,Re=new p(!1),Oe=new p(null),Ve=new p(!1),We=new p(!1);We.subscribe((e=>se(Lt(),e)));var Fe=new p(We.value());Fe.subscribe((e=>oe(Lt(),e)));var He=new p(!1);He.subscribe((e=>te(Lt(),e)));var ze=new p(He.value());ze.subscribe((e=>ie(Lt(),e)));var Ue=new p(xe),Ge=new p(!1);Ge.subscribe((e=>Q(Lt(),e)));var qe=A.combinedTrackTimeLock(Ue,Ge,Ce);Ge.subscribe((e=>Q(Lt(),e)));var je=new p(qe.value());je.subscribe((e=>ee(Lt(),e)));var Ke=new p(!1)
;Ke.subscribe((e=>X(Lt(),e))),Ie.subscribe(oi);var Ze=new p(Ke.value());Ze.subscribe((e=>J(Lt(),e)));var Ye=new p(TVSettings.getBool("chart.syncCrosshair",!0)),$e=l.createGroup({desc:"Layout"}),Xe=null,Je=null,Qe=null,et=null,tt=null;if(window.TVD){var it=window.TVD.crosshairSyncEnabled;it?(it.value()&&(et=q(Lt)),tt=it.subscribe((e=>{e?et=q(Lt):(j(Lt()),et=null)}))):et=q(Lt)}var st=Ye.value();Ye.subscribe((function(e){st=e=!!e,TVSettings.setValue("chart.syncCrosshair",e);for(var t=0;t<Ce.length;++t){var i=Ce[t].chartWidget;i.hasModel()&&i.model().model().lightUpdate()}}));var ot=Se.resizerBridge.width,rt=Se.resizerBridge.height,nt=new p(null),at=new p(null);nt.subscribe((e=>{at.setValue(null===e?null:e.chartWidget)}));var lt=Se.widgetOptions||{},ct=Se.metaInfo||{},dt={id:new p(ct.id||null),name:new p(ct.name),description:new p(ct.description),username:new p(ct.username),uid:new p(ct.uid),lastModified:new p(ct.lastModified)},ht=n();ht.onChange().subscribe(null,(function(e){d.emit("undo_redo_state_changed",e)}));var ut=Se.resizerBridge.container.value();ut.addEventListener("contextmenu",m);var pt,_t=new b,mt=new b,gt=new b,St=new p(!1),vt=new p(null),ft=null,bt=null;Se.seriesControlBarEnabled&&(pt="0px",vt.setValue(document.createElement("div")),vt.value().style.left=pt,vt.value().style.right=pt,vt.value().style.bottom=pt,vt.value().classList.add("chart-toolbar","chart-controls-bar"),vt.value().setAttribute("data-is-chart-toolbar-component","true"),ut.appendChild(vt.value()),Promise.all([i.e(77586),i.e(93703),i.e(2520),i.e(53953),i.e(49481),i.e(46489),i.e(74600),i.e(75826),i.e(59258),i.e(72197),i.e(43362),i.e(97384),i.e(49325),i.e(7001),i.e(17175),i.e(84353),i.e(80532),i.e(84462),i.e(82321),i.e(17013),i.e(47260)]).then(i.bind(i,624527)).then((({BottomToolbarRenderer:e})=>{var i=Se.resizerBridge,s=[i.container.spawn(),i.width.spawn(),i.height.spawn()],o=i.container.value(),r=function(){var e=o.getBoundingClientRect(),t=W(Lt());return t.top=e.top+t.top,t.left=e.left+t.left,t},n=new b,a=function(){n.fire()};s.forEach((function(e){e.subscribe(a)}));var l=function(){s.forEach((function(e){e.destroy()})),n.destroy(),window.ChartApiInstance.connectionsLimitReached().unsubscribe(re)};ft=new e(vt.value(),n,r,t,ChartApiInstance,lt,Se.seriesControlBar),bt=function(){null!==ft&&(ft.destroy(),ft=null,vt.value().remove(),vt.setValue(null)),l()}})));var yt=new S(t),Ct=new v(t),wt=null;function Tt(){St.setValue(Ce.some((e=>{const t=e.chartWidget.lineToolsSynchronizer();return null!==t&&t.hasChanges().value()})))}function Pt(e){return A.checkProFeatureImpl(Lt(),e)}wt=new M(Se.resizerBridge,(function(){return vt.value()?vt.offsetHeight:0})),window.ChartApiInstance.connectionsLimitReached().subscribe(re,{callWithLast:!0}),Oe.subscribe((()=>Et()));const Mt=new Map,xt=()=>A.updateLinkingGroupCharts(Lt()),It=new u([]);function Lt(){return{undoHistory:ht,chartWidgetsDefs:Ce,chartsCountToSave:At,actualLayoutCount:kt,savedChartWidgetOptions:Ee,activeChartWidget:ve,options:Se,parent:ut,toastsFactory:wt,crosshairLockRaw:st,
crossHairSyncBroadcast:et,setChartStorageNotificationSubscription:e=>{Je=e},maximizedChartDef:nt,setMaximized:Ht,layoutTemplate:Me,widthWV:ot,heightWV:rt,checkProFeature:Pt,lineToolsSynchronizerHasChanges:St,recalcHasChanges:Tt,onZoom:mt,onScroll:gt,layoutType:xe,layoutWV:Ue,setLayoutType:e=>{xe=e},isPhoneSize:Re,viewMode:ke,updateViewMode:Ut,loadingContent:Be,setLoadingContent:e=>{Be=e},initialLoading:Ne,inlineChartsCount:Pe,updateWatchedValue:Gt,checkAllPendingModelsAlreadyCreated:zt,readOnly:fe,symbolLock:We,internalSymbolLock:Fe,intervalLock:He,internalIntervalLock:ze,dateRangeLock:Ze,internalDateRangeLock:Ze,trackTimeLock:Ge,internalTrackTimeLock:je,crosshairLock:Ye,customLegendWidgetsFactoriesMap:pi,globalDetachable:Te,saveChartService:Xe,customSources:hi,updateActivityView:qt,chartWidgetCreatedDelegate:_t,sizingState:Oe,currentLayoutResizeAction:Ie,allLayoutSizesState:Le,splitters:Ae,widgetOptions:lt,bottomToolbar:vt,replayContainer:ui,layoutSizesChanged:Ve,subscribeToCompletedEventForDateRangeSync:(e,t)=>de(Lt(),e,t),subscribeToEventsForDateRangeSync:e=>ae(Lt(),e),unsubscribeFromEventsForDateRangeSync:e=>le(Lt(),e),syncChartsDateRangesWithActiveChartRange:e=>ce(Lt(),e),combinedTrackTimeLock:qe,chartWidgetIdToCompletedCallbackMap:_e,flags:De,linkingGroupsCharts:Mt,chartModels:It,updateLinkingGroupCharts:xt}}function At(){return Ce.length+Ee.length}function kt(){return r[xe].count}function Et(){V(Lt())}ot.subscribe(Et),rt.subscribe(Et),this.updateLayout=Et;const Dt=A.activeLinkingGroupWV(ve),Bt=A.allLinkingGroupsWV(Lt());var Nt;Re.setValue(!1);var Rt=["phone","phone-vertical"];function Ot(e,t){Se.mobileForceChartMaximizeEnabled&&(!Rt.includes(T.device)||t&&Rt.includes(t)?Rt.includes(T.device)||t&&!Rt.includes(t)||Re.setValue(!1):Re.setValue(!0))}function Vt(){if(window.is_authenticated){var e=h.enabled("app_phone");!h.enabled("app_tablet")&&(e||Re.value())?ke.value()===w.ForceFullscreen&&(Nt=nt.value(),ve.value().requestFullscreen()):Nt||(Ht(null),Ut())}}function Wt(e){return e.rdState.owner.value()!==e}function Ft(e){return H.call(t,e)}function Ht(e){nt.value()!==e&&(nt.setValue(e),Ft(xe))}function zt(){Ce.every((e=>e.chartWidget.hasModel()))&&(Gt(),d.emit("layout_changed"))}function Ut(){"s"===xe||nt.value()?ke.setValue(w.ForceFullscreen):ke.setValue(w.Multichart)}function Gt(){var e=Math.min(Me.value().count,Ce.length)-1;if(e<0)ve.deleteValue();else{var t=we;t<0&&(t=0),t>e&&(t=e),ve.setValue(Ce[t].chartWidget)}}function qt(){for(var e=Ce.length;e--;){var t=e===we;Ce[e].container.value().classList.toggle("active",t),Ce[e].container.value().classList.toggle("inactive",!t)}}function jt(e){0}function Kt(e,t){return F(Lt(),e,t)}function Zt(e){var t=Kt(Ce[we],e);jt(t?t.chartWidget:ve.value()),t&&(ve.setValue(t.chartWidget),nt.value()&&Ft(xe))}const Yt=new b;function $t(e,t){var i=Ce.findIndex((function(t){return t.chartWidget===e})),s=Ce.findIndex((function(e){return e.chartWidget===t}));if(-1===i||-1===s)throw new Error("chart is not in the layout");var o=Ce[i],r=Ce[s];Ce[i]=r,Ce[s]=o,we===i?we=s:we===s&&(we=i),
Et(),Yt.fire()}var Xt=new b,Jt=new p,Qt=new p([]),ei=null;function ti(e){var t=e.mainSeries().properties();t.style.subscribe(null,ii),ii(t.style),e.model().onSelectedSourceChanged().subscribe(null,si),Ke.value()&&(ae(Lt(),e),ce(Lt())),si(e.selection().allSources())}function ii(e){Jt.setValue(e.value())}function si(){var e=ei.model();Qt.setValue(e.selection().allSources())}function oi(e){Ke.value()&&null===e&&ce(Lt())}ve.subscribe((function(e){if(e){for(var t,i=Ce.length;i--;)if(Ce[i].chartWidget===e){t=i;break}if(!isFinite(t))throw new Error("Cannot make detached ChartWidget active");if(we!==t){nt.value()&&(Wt(Ce[t])||nt.setValue(Ce[t])),we=t,qt();for(i=Ce.length;i--;)Ce[i].chartWidget!==e&&Ce[i].chartWidget.setActive(!1);wi(),e.setActive(!0),a.activePointSelectionMode.setValue(e.selectPointMode().value())}!function(e){if(ei!==e){if(ei&&(ei.modelCreated().unsubscribe(null,ti),ei.hasModel())){var t=ei.model();Ke.value()&&le(Lt(),t),t.mainSeries().properties().style.unsubscribe(null,ii),t.model().onSelectedSourceChanged().unsubscribe(null,si),ei=null}e&&(ei=e,e.hasModel()?ti(e.model()):e.modelCreated().subscribe(null,ti))}}(e)}}),{callWithLast:!0});var ri=new b;function ni(){Se.resizerBridge.requestFullscreen()}function ai(){Se.resizerBridge.exitFullscreen()}function li(){return Se.resizerBridge.fullscreenable}function ci(){return Se.resizerBridge.fullscreen}function di(e){if(0!==Ce.length){for(var t=Ce.length;t--;)Ce[t].chartWidget.setActive(!1);Ce[we].chartWidget.setActive(e)}}fe||($e.add({desc:"Switch active chart",hotkey:h.enabled("accessible_keyboard_shortcuts")?c.Modifiers.Shift+39:9,handler:function(){Zt(!1)}}),$e.add({desc:"Switch active chart",hotkey:h.enabled("accessible_keyboard_shortcuts")?c.Modifiers.Shift+37:c.Modifiers.Shift+9,handler:function(){Zt(!0)}})),$e.add({desc:"Fullscreen mode",hotkey:c.Modifiers.Shift+70,isDisabled:h.enabled("widget")||!li().value(),handler:function(){ci().value()?ai():ni()}}),Se.takeScreenshotEnabled&&($e.add({desc:"Screenshot server",hotkey:c.Modifiers.Alt+83,handler:A.takeServerScreenshot.bind(this,Se.snapshotUrl,t)}),f("any")||($e.add({desc:"Download client screenshot",hotkey:c.Modifiers.Mod+c.Modifiers.Alt+83,handler:A.downloadScreenshot.bind(this,t)}),$e.add({desc:"Copy client screenshot",hotkey:c.Modifiers.Mod+c.Modifiers.Shift+83,handler:A.copyScreenshotToClipboard.bind(this,t)}))),Se.saveChartEnabled&&$e.add({desc:"Save Chart Layout",hotkey:c.Modifiers.Mod+83,handler:function(){Xt.fire()}});var hi=new Map,ui=null,pi=new Map;const _i=R(Lt());Se.globalEvents&&_i.listen();const mi=We.spawn(),gi=He.spawn(),Si=Ke.spawn(),vi=Ge.spawn(),fi=Ye.spawn(),bi=()=>Ce.map((e=>e.chartWidget)),yi=ne(bi,Ue.readonly(),Yt,_t);function Ci(e,t){if(Be=!0,Ne=Boolean(t),Ee.splice(0),e){if(e.charts||(e={layout:"s",charts:[e]}),e.layoutsSizes)for(const t of Object.keys(e.layoutsSizes))Le.set(t,e.layoutsSizes[t]);var i=new Set;e.charts.forEach((function(e){e.chartId&&i.add(e.chartId)})),e.charts.forEach((function(e){if(!e.chartId){var t=U((function(e){return i.has(e)}));i.add(t),e.chartId=t}}))
;let t=e.layout;if(!y(t)){const e=C(t);_.logError(`Loading unsupported layout ${t}. Force migration to ${e}`),t=e}xe=Pt(t||"s");for(const t of e.charts)e.studyMetaInfoMap&&t.panes.forEach((t=>{t.sources.forEach((t=>{"string"==typeof t.metaInfo&&(t.metaInfo=s(e.studyMetaInfoMap[t.metaInfo]))}))})),Ee.push({content:t});void 0!==e.symbolLock&&We.setValue(Boolean(e.symbolLock)),void 0!==e.intervalLock&&He.setValue(Boolean(e.intervalLock)),void 0!==e.trackTimeLock&&Ge.setValue(Boolean(e.trackTimeLock)),void 0!==e.dateRangeLock&&Ke.setValue(Boolean(e.dateRangeLock)),void 0!==e.crosshairLock&&Ye.setValue(Boolean(e.crosshairLock))}Ft(xe),"s"===xe||Se.mobileForceChartMaximizeEnabled||ke.setValue(w.Multichart),a.init(),a.tool.subscribe(Ti),a.tool.subscribe(wi),Be=!1,Ne=!1}function wi(){var e=ve.value();Ce.forEach((function(t){t.chartWidget!==e&&t.chartWidget.updateCrossHairPositionIfNeeded()})),e&&e.updateCrossHairPositionIfNeeded()}function Ti(){Ce.forEach((function(e){e.chartWidget.onToolChanged()}))}Object.assign(this,{innerState:Lt,getAll:bi,maximizedChartWidget:()=>at.readonly(),leftBottomChartWidget:()=>yi,activeLinkingGroup:()=>Dt,allLinkingGroups:()=>Bt,linkingGroupsCharts:e=>A.getLinkingGroupCharts(Lt(),e).readonly(),destroy:function(){if(ri.fire(),di(!1),null!==bt&&(bt(),bt=null),z(Lt()),mi.destroy(),gi.destroy(),vi.destroy(),Si.destroy(),qe.destroy(),fi.destroy(),Ie.unsubscribe(oi),Ce.forEach((function(e){void 0!==e.timingsMeter&&e.timingsMeter.destroy(),e.chartWidget.linkingGroupIndex().unsubscribe(xt),e.chartWidget.destroy()})),Se.resizerBridge.remove(),Ae.value().forEach((e=>{e.mouseHandler.destroy(),e.mouseListener.destroy()})),window.removeEventListener("resize",Et),T.off("changeDevice",Ot),Se.mobileForceChartMaximizeEnabled&&!Se.handleMaximizedChartOnResizeDisabled&&T.off("changeDevice",Vt),a.tool.unsubscribe(wi),a.tool.unsubscribe(Ti),ut.remove(),hi.clear(),pi.clear(),$e.destroy(),Je&&Je.destroy(),_i&&_i.destroy(),Qe&&Qe.destroy(),Dt.destroy(),Bt.destroy(),window.TVD){const e=window.TVD.crosshairSyncEnabled;e&&e.unsubscribe(tt),j(Lt())}yi.destroy(),be=!0},onAboutToBeDestroyed:ri,layout:Ue.readonly(),setLayout:Ft,activeChartWidget:ve,viewMode:ke,activeChartStyle:Jt.readonly(),setChartStyleToWidget:A.setChartStyleToWidget.bind(this),selectedSources:Qt.readonly(),metaInfo:dt,state:function(e,i,s,o,r){return A.stateImpl.call(t,{withData:e,skipLineToolsFromOtherSymbols:i,wipeSensitiveData:s,skipLineTools:o,addOnlyActiveChart:r})},lineToolsAndGroupsDTOs:function(){return D(Lt())},resetLineToolsInvalidated:function(e,t){return B(Lt(),e,t)},applyLineToolUpdateNotification:N.bind(null,Ce),readOnly:function(){return fe},onZoom:function(){return mt},onScroll:function(){return gt},resizerBridge:function(){return Se.resizerBridge},lock:{symbol:mi,interval:gi,dateRange:Si,crosshair:fi,trackTime:vi},setSymbol:(e,t,i)=>A.setSymbol(Lt(),e,t,i),setSymbolAll:e=>A.setSymbolAll(Lt(),e),setResolution:(e,t,i)=>A.setResolution(Lt(),e,t,i),setTimeFrame:function(e){De.loadingChart||De.setTimeFrameActive||(De.setTimeFrameActive=!0,
He.value()?Ce.forEach((function(t){t.chartWidget.loadRange(e)})):ve.value().loadRange(e),De.setTimeFrameActive=!1)},updateLayout:Et,setChartLayoutWithUndo:function(e){return A.setChartLayoutWithUndoImpl(Lt(),this,e)},images:A.getSnapshot.bind(this,this,Se.widgetOptions.customerReadableName,lt.onWidget),clientSnapshot:A.getClientSnapshot.bind(this,this,Se.widgetOptions.customerReadableName,lt.onWidget),tags:function(){for(var e=[],t=0;t<Ce.length&&t<Me.value().count;t++)e=e.concat(Ce[t].chartWidget.tags());return e=(e=Array.from(new Set(e))).map((function(e){return e.toLowerCase().replace(/\W+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}))},syncCrosshair:(e,t,i,s)=>G(Lt(),e,t,i,s),syncScroll:function(e,t){return K(Lt(),e,t)},clearChartMetaInfo:function(){dt.id.setValue(null),dt.uid.setValue(void 0),dt.name.setValue(void 0)},takeScreenshot:A.takeScreenshot.bind(this,Se.snapshotUrl,this),takeServerScreenshot:A.takeServerScreenshot.bind(this,Se.snapshotUrl,this),loadContent:Ci,purgeUnusedWidgets:function(){for(var e=r[xe].count;e<Ce.length;e++)Ce[e].chartWidget.destroy();Ce.splice(r[xe].count)},applyOverrides:function(e){for(var t=0;t<Ce.length;t++)Ce[t].chartWidget.applyOverrides(e)},applyStudiesOverrides:pe,switchChart:Zt,startFullscreen:ni,exitFullscreen:ai,fullscreen:ci,fullscreenable:li,chartWidgetCreated:function(){return _t},saveKeysPressed:function(){return Xt},getContainer:function(){return ut},onWidget:lt.onWidget,applyTheme:function(e){return $(Lt(),t,e)},applyIndicatorsToAllCharts:function(e){k(Lt(),e)},applyIndicatorsToAllChartsAvailable:function(){return!fe&&kt()>1},applyIndicatorToAllCharts:async function(e,t,i,s){await E(Lt(),e,t,i,s)},setActive:di,inlineChartsCount:Pe.readonly(),revertToInline:function(){if(!Re.value()||ke.value()!==w.ForceFullscreen){Ht(null);for(var e=0;e<Ce.length;e++)Ce[e].rdState.bridge().attach()}},chartMarketStatuses:function(){return Ce.map((function(e){var t=e.chartWidget.hasModel()?e.chartWidget.model().mainSeries().marketStatusModel():null;return null!==t?I(t.status()):"-"}))},chartSeriesStatuses:function(){return Ce.map((function(e){var t=e.chartWidget.hasModel()?e.chartWidget.model().mainSeries().status():null;return(null===t?"":g.SERIES_STATUS_TEXT[t])+" ("+t+")"}))},undoHistory:ht,lineToolsSynchronizerHasChanges:St,applyPreferencesToAllCharts:function(e){var t=e.model().preferences();Ce.forEach((function(i){i.chartWidget._model!==e&&i.chartWidget._model.applyPreferences(t)}))},getToasts:function(){return wt.getChartToasts()},addCustomSource:function(e,t,i){o(!hi.has(e),"Cannot create the same custom source multiple times"),hi.set(e,{factory:t,layer:i});for(var s=0;s<Ce.length;++s){var r=Ce[s].chartWidget;r.hasModel()&&r.model().model().addCustomSource(e,t,i)}},removeCustomSource:function(e){o(hi.has(e),"Cannot remove not created custom source"),hi.delete(e);for(var t=0;t<Ce.length;++t){var i=Ce[t].chartWidget;i.hasModel()&&i.model().model().removeCustomSource(e)}},addCustomWidgetToLegend:function(e,t){
o(!pi.has(e),"Cannot create the same custom widget in legend multiple times"),pi.set(e,t);for(var i=0;i<Ce.length;++i)Ce[i].chartWidget.addCustomWidgetToLegend(e,t)},addReplayWidget:function(e){o(null===ui,"Cannot create replay container multiple times"),(ui=document.createElement("div")).style.position="absolute",ui.style["min-height"]="51px",ui.style.overflow="hidden",ui.style.left="0px",ui.style.right="0px";var t=null===vt.value()?0:vt.value().offsetHeight;ui.style.bottom=`${t}px`,ui.setAttribute("data-is-chart-toolbar-component","true"),ut.prepend(ui),e(ui,(()=>Et())),Et()},destroyReplayWidget:function(){o(null!==ui,"Cannot remove replay container, container is not created"),ui.remove(),ui=null,Et()},setViewMode:function(e){ke.setValue(e)},moveActiveChartWithUndo:function(e){var t=Ce[we],i=Kt(t,e);i&&ht.pushUndoCommand(new P($t,t.chartWidget,i.chartWidget))},activeChartCanBeMoved:function(){return!(fe||Pe.value()<2||Wt(Ce[we]))},generalPropertiesDefinitions:function(){return ve.value().generalPropertiesDefinitions()},reconnectChartApi:function(e){x(e)},setBroker:function(e){me(Lt(),e)},setSaveChartService:function(e){Xe=e;for(var t=0;t<Ce.length;++t){Ce[t].chartWidget.setSaveChartService(e)}},getCompareDialogRenderer:function(){return Ct},getChartPropertiesDialogRenderer:function(){return yt},clipboard:_i,chartsSymbols:function(){return O(Lt())},resetLayoutSizes:he.bind(null,Lt()),unloadUnusedCharts:ue.bind(null,Lt()),layoutSizesChanged:()=>Ve,clientId:ye,ariaDescribeChart:jt,chartModels:()=>It.readonly()}),A.createChartStorageSubscriptionsIfRequired(this,Lt()),Ci(Se.content,!0),A.createChartWidgetCollectionNewsNotifier(this,Lt()).then((e=>{be||(Qe=e)})),Ue.subscribe((function(){qt()})),Ue.hook=function(e){return e===this.value()?e:Pt(e)},fe&&(Ue.writeLock=!0),window.addEventListener("resize",Et),Se.mobileForceChartMaximizeEnabled&&(T.on("changeDevice",Ot),Se.handleMaximizedChartOnResizeDisabled||T.on("changeDevice",Vt),Ot(),Vt());var Pi=0;function Mi(){0===--Pi&&d.emitOnce("onChartReady")}Ce.forEach((function(e){if(e){Pi++;var t=e.chartWidget;t.withModel(null,(function(){Se.metaInfo&&t.model().model().setChartSaveTime(1e3*Se.metaInfo.lastModified);var e=t.model().mainSeries();if(e.bars().size()>0||e.isFailed())Mi();else{var i=e.dataEvents(),s=function(){Mi(),i.barReceived().unsubscribe(null,s),i.completed().unsubscribe(null,s),i.error().unsubscribe(null,s),i.unsupportedResolutionRequested().unsubscribe(null,s)};i.barReceived().subscribe(null,s),i.completed().subscribe(null,s),i.error().subscribe(null,s),i.unsupportedResolutionRequested().subscribe(null,s)}}))}})),Z(Lt()).then(Y).then((function(){window.saver&&window.is_authenticated&&Se.widgetOptions.justCloned&&window.saver.saveChartSilently()})).catch(_.logError.bind(_))}},33052:(e,t,i)=>{"use strict";var s;i.d(t,{TabNames:()=>s}),function(e){e.background="Background",e.coordinates="Coordinates",e.drawings="Drawings",e.events="Events",e.eventsAndAlerts="Events & Alerts",e.inputs="Inputs",e.properties="Properties",e.scales="Scales",e.legend="Legend",
e.sourceCode="Source Code",e.style="Style",e.symbol="Symbol",e.timezoneSessions="Timezone/Sessions",e.trading="Trading",e.visibility="Visibility",e.text="Text"}(s||(s={}))},109436:(e,t,i)=>{"use strict";i.d(t,{getPriceAxisNameInfo:()=>n});const s=["Z","Y","X","W","V","U","T","S"],o=["A","B","C","D","E","F","G","H"];class r{constructor(e){this.label=e}equals(e){return null!==e&&this.label===e.label}}function n(e,t){const i="left"===e?s:o;return new r(t<i.length?i[t]:"")}},689010:(e,t,i)=>{"use strict";i.d(t,{KineticAnimation:()=>n});var s=i(650151);function o(e,t){return e.position-t.position}function r(e,t,i){const s=(e.position-t.position)/(e.time-t.time);return Math.sign(s)*Math.min(Math.abs(s),i)}class n{constructor(e,t,i,s){this._position1=null,this._position2=null,this._position3=null,this._position4=null,this._animationStartPosition=null,this._durationMsecs=0,this._speedPxPerMsec=0,this._minSpeed=e,this._maxSpeed=t,this._dumpingCoeff=i,this._minMove=s}addPosition(e,t){if(null!==this._position1){if(this._position1.time===t)return void(this._position1.position=e);if(Math.abs(this._position1.position-e)<this._minMove)return}this._position4=this._position3,this._position3=this._position2,this._position2=this._position1,this._position1={time:t,position:e}}start(e,t){if(null===this._position1||null===this._position2)return;if(t-this._position1.time>50)return;let i=0;const s=r(this._position1,this._position2,this._maxSpeed),n=o(this._position1,this._position2),a=[s],l=[n];if(i+=n,null!==this._position3){const e=r(this._position2,this._position3,this._maxSpeed);if(Math.sign(e)===Math.sign(s)){const t=o(this._position2,this._position3);if(a.push(e),l.push(t),i+=t,null!==this._position4){const e=r(this._position3,this._position4,this._maxSpeed);if(Math.sign(e)===Math.sign(s)){const t=o(this._position3,this._position4);a.push(e),l.push(t),i+=t}}}}let c=0;for(let e=0;e<a.length;++e)c+=l[e]/i*a[e];Math.abs(c)<this._minSpeed||(this._animationStartPosition={position:e,time:t},this._speedPxPerMsec=c,this._durationMsecs=function(e,t){const i=Math.log(t);return Math.log(1*i/-e)/i}(Math.abs(c),this._dumpingCoeff))}getStartPosition(){return(0,s.ensureNotNull)(this._animationStartPosition).position}getPosition(e){const t=(0,s.ensureNotNull)(this._animationStartPosition),i=e-t.time;return t.position+this._speedPxPerMsec*(Math.pow(this._dumpingCoeff,i)-1)/Math.log(this._dumpingCoeff)}finished(e){return null===this._animationStartPosition||this._progressDuration(e)===this._durationMsecs}_progressDuration(e){const t=e-(0,s.ensureNotNull)(this._animationStartPosition).time;return Math.min(t,this._durationMsecs)}}},189436:(e,t,i)=>{"use strict";i.d(t,{icons:()=>o});var s=i(195619);const o=[{icon:"🔶",label:s.t(null,void 0,i(132407))},{icon:"🍀",label:s.t(null,void 0,i(820079))},{icon:"💧",label:s.t(null,void 0,i(69608))},{icon:"❤️",label:s.t(null,void 0,i(857618))},{icon:"💩",label:s.t(null,void 0,i(842344))}]},782014:(e,t,i)=>{"use strict";i.d(t,{LayoutChartsSyncContextMenuAction:()=>a})
;var s=i(861814),o=i(444372),r=i(691371),n=i(189436);class a extends r.Action{constructor(e,t){const a={icon:s,statName:"SetLayoutChartsSyncGroup",label:o.t(null,void 0,i(104086))};super({actionId:"Chart.LinkingGroupSync",options:{...a,subItems:n.icons.map((({icon:t},i)=>new r.Action({actionId:"Chart.LinkingGroupSync.ChangeGroup",options:{label:t,checkable:!0,checked:e.value()===i,onExecute:()=>this._setLinkingGroupIndexImpl(i)}})))},customActionOptions:{...a,subItems:[new r.Action({actionId:"Chart.LinkingGroupSync.ChangeGroup",options:{},optionsLoader:async()=>{const[e,{LayoutChartsSyncContextMenuItem:t}]=await Promise.all([i.e(75514).then(i.t.bind(i,50959,19)),Promise.all([i.e(8800),i.e(65857),i.e(36010),i.e(78687),i.e(72610),i.e(10184)]).then(i.bind(i,168880))]);return{doNotCloseOnClick:!1,noInteractive:!0,jsxLabel:e.createElement(t,{active:this._linkingGroupIndex,icons:n.icons,onClick:e=>{this._setLinkingGroupIndexImpl(e)}})}}})]}}),this._setLinkingGroupIndexImpl=e=>{this._setLinkingGroupIndex(this._linkingGroupIndex.value()===e?null:e)},this._linkingGroupIndex=e.spawn(),this._setLinkingGroupIndex=t}}},851063:(e,t,i)=>{"use strict";i.d(t,{createLayout:()=>a,layoutInitialSizingState:()=>c});var s=i(203308),o=i(822914),r=i(650151);function n(e,t,i){const s=new Set;if("number"==typeof e)return s.add(e),{indices:s,smallestIndex:e,sizer:e=>e,splitters:()=>[],resizeApplier:(e,t,i,s,o)=>o,syncSublayoutsBySplitter:(e,t)=>t};const a=e[0],l=e.slice(1).map((e=>n(e,t)));let c=1/0;for(const e of l)for(const t of Array.from(e.indices))t<c&&(c=t),s.add(t);const d=(e,t,i,s,o,r,n,a)=>{const l="h"===n?e.width:e.height;let c,d,h;if(a){const e=t*i+s*l;c=Math.round(e),d=t===r-1?l-c:Math.round(e+o*l)-c}else{const e=(l-(r-1)*i)/r,s=t*(e+i);c=Math.round(s),d=Math.round(s+e)-c}return h="h"===n?{top:e.top,left:e.left+c,height:e.height,width:d}:{top:e.top+c,left:e.left,height:d,width:e.width},h},h=(e,t,i,s,o,r,n)=>{if("number"==typeof i)return[];const a=i[0],l=i.slice(1);return l.reduce(((i,c,u)=>{var p;const _=null==n?void 0:n[u],m=null!==(p=null==_?void 0:_.percent)&&void 0!==p?p:1/l.length,g=d(e,u,t,i.sumOfCoeffsBefore,m,l.length,a,n),S=i.sumOfCoeffsBefore+m;if(u<l.length-1){const e=`${r}-${s}-${u}-${a}`;let t;t="v"===a?{left:g.left,top:g.top+g.height-6+1,width:g.width,height:12}:{left:g.left+g.width-6+1,top:g.top,width:12,height:g.height};const n={level:s,orientation:a,indexes:[...o,u],metrics:t,className:e};i.splitters.push(n)}return Array.isArray(c)?{splitters:i.splitters.concat(h(g,t,c,s+1,[...o,u],r,null==_?void 0:_.substate)),sumOfCoeffsBefore:S}:{splitters:i.splitters,sumOfCoeffsBefore:S}}),{splitters:[],sumOfCoeffsBefore:0}).splitters};function u(e,t,i,s,o,n,l,c){if("number"==typeof s)return n;const h=s.slice(1),p=[0];for(let e=0;e<h.length;e++)p.push(p[p.length-1]+n[e].percent);if(l<o.level)return h.map(((s,_)=>{var m;const g=null==n?void 0:n[_];if("number"==typeof s)return g;if(!c&&_!==o.indexes[l])return g;const S=null!==(m=null==g?void 0:g.percent)&&void 0!==m?m:1/h.length,v=d(e,_,t,p[_],S,h.length,a,n);return{
percent:g.percent,substate:u(v,t,i,s,o,(0,r.ensureDefined)(g.substate),l+1,c)}}));{const t=s[0];if(t!==o.orientation||n.length<2)return n;const r=Math.min(o.indexes[l],n.length-2),a="v"===t?e.height:e.width,c=i/a,d=n[r].percent+n[r+1].percent;return n[r].percent+=c,n[r].percent=Math.min(d-.05,Math.max(.05,n[r].percent)),n[r+1].percent-=c,n[r+1].percent=Math.min(d-.05,Math.max(.05,n[r+1].percent)),n}}function p(e,t){if(1===e.length)return t;{const i=(0,r.ensureDefined)(t[e[0]].substate);return p(e.slice(1),i)}}function _(e,t,i,s,n){if("number"==typeof e)return i;const a=e.slice(1);if(n<t.level)return a.map(((e,o)=>{const a=null==i?void 0:i[o];return"number"==typeof e?a:{percent:a.percent,substate:_(e,t,(0,r.ensureDefined)(a.substate),s,n+1)}}));{const e=t.indexes[n];if(s.length<i.length){const e=(0,o.default)(s),t=e[e.length-1].percent,r=i.length-e.length,n=t/(r+1);e[e.length-1].percent=n;for(let t=0;t<r;t++)e.push({percent:n});s=e}else if(s.length>i.length){const t=(0,o.default)(s);if(e>=i.length-1){const e=s.length-i.length;for(let i=0;i<e;i++)t[e].percent+=t[i].percent;t.splice(0,e)}else{for(let e=i.length;e<s.length;e++)t[i.length-1].percent+=t[e].percent;t.splice(i.length)}s=t}return i.forEach(((e,t)=>e.percent=s[t].percent)),i}}return{indices:s,smallestIndex:c,sizer:(e,t,i,s,o)=>{let r,n,c,h=0,u=0,p=0;for(let e=0;e<l.length;e++){const s=l[e];s.smallestIndex>=i||(s.indices.has(t)&&(r=s,c=null==o?void 0:o[e].substate,o&&(p=o[e].percent),n=h),h++,o&&0===p&&(u+=o[e].percent))}const _=d(e,n,s,u,p,h,a,o);return r.sizer(_,t,i,s,c)},splitters:(t,i,s)=>h(t,i,e,0,[],"",s),resizeApplier:(t,i,s,o,r,n)=>u(t,i,s,e,o,r,0,n),syncSublayoutsBySplitter:function(t,i){const s=p(t.indexes,i);return _(e,t,i,s,0)}}}function a(e,t,i){const s=n(e,t);return{title:i,count:s.indices.size,sizer:s.sizer,splitters:s.splitters,resizeApplier:s.resizeApplier,syncSublayoutsBySplitter:s.syncSublayoutsBySplitter,expression:e,layoutType:t}}function l(e){return e.map((t=>{if((0,s.default)(t))return{percent:1/e.length};{const i=t.slice(1);return{percent:1/e.length,substate:l(i)}}}))}function c(e){return l(e.slice(1))}},442657:(e,t,i)=>{"use strict";i.r(t),i.d(t,{isMultipleLayout:()=>c,isSingleLayout:()=>l,isSupportedLayout:()=>d,layouts:()=>a,tryGuessingTheMostSuitableLayout:()=>h});var s=i(287489),o=i(851063);const r={s:{title:"1 chart",count:1,layoutType:"s",sizer:(e,t)=>{if(0!==t)throw new RangeError("invalid index");return e},splitters:()=>[],resizeApplier:(e,t,i,s,o)=>o,syncSublayoutsBySplitter:(e,t)=>t,expression:["h",0]}};let n;n={"2h":(0,o.createLayout)(s["2h"],"2h","2-up horizontal"),"2v":(0,o.createLayout)(s["2v"],"2v","2-up vertical"),"2-1":(0,o.createLayout)(s["2-1"],"2-1","2 at top and 1 at bottom"),"1-2":(0,o.createLayout)(s["1-2"],"1-2","1 at top and 2 at bottom"),"3s":(0,o.createLayout)(s["3s"],"3s","3-up stacked"),"3r":(0,o.createLayout)(s["3r"],"3r","3-up stacked left"),"3h":(0,o.createLayout)(s["3h"],"3h","3-up horizontal"),"3v":(0,o.createLayout)(s["3v"],"3v","3-up vertical"),4:(0,o.createLayout)(s[4],"4","4-up"),"4h":(0,
o.createLayout)(s["4h"],"4h","4-up horizontal"),"4v":(0,o.createLayout)(s["4v"],"4v","4-up vertical"),"4s":(0,o.createLayout)(s["4s"],"4s","4-up stacked"),"4s-l":(0,o.createLayout)(s["4s-l"],"4s-l","4-up stacked left"),"5h":(0,o.createLayout)(s["5h"],"5h","5-up horizontal"),"5v":(0,o.createLayout)(s["5v"],"5v","5-up vertical"),"6h":(0,o.createLayout)(s["6h"],"6h","6-up horizontal"),"6v":(0,o.createLayout)(s["6v"],"6v","6-up vertical"),"7h":(0,o.createLayout)(s["7h"],"7h","7-up horizontal"),"8h":(0,o.createLayout)(s["8h"],"8h","8-up horizontal"),"8v":(0,o.createLayout)(s["8v"],"8v","8-up vertical"),"2-2":(0,o.createLayout)(s["2-2"],"2-2","2 at top and 2 at bottom"),"2-2-l":(0,o.createLayout)(s["2-2-l"],"2-2-l","2 at left and 2 at right"),"2-3":(0,o.createLayout)(s["2-3"],"2-3","2 at top and 3 at bottom"),"3-2":(0,o.createLayout)(s["3-2"],"3-2","3 at top and 2 at bottom"),"1-3":(0,o.createLayout)(s["1-3"],"1-3","1 at top and 3 at bottom"),"1-4":(0,o.createLayout)(s["1-4"],"1-4","1 at top and 4 at bottom"),"2-4":(0,o.createLayout)(s["2-4"],"2-4","2 at top and 4 at bottom"),"5s":(0,o.createLayout)(s["5s"],"5s","5-up stacked"),6:(0,o.createLayout)(s[6],"6","6-up"),"6c":(0,o.createLayout)(s["6c"],"6c","6-up in two columns"),8:(0,o.createLayout)(s[8],"8","8-up"),"8c":(0,o.createLayout)(s["8c"],"8c","8-up in two columns"),"9s":(0,o.createLayout)(s["9s"],"9s","3x3 square"),"9h":(0,o.createLayout)(s["9h"],"9h","9-up horizontal"),"9v":(0,o.createLayout)(s["9v"],"9v","9-up vertical"),"10h":(0,o.createLayout)(s["10h"],"10h","10-up horizontal"),"10v":(0,o.createLayout)(s["10v"],"10v","10-up vertical"),"10c5":(0,o.createLayout)(s["10c5"],"10c5","2-up in 5 columns"),"12c6":(0,o.createLayout)(s["12c6"],"12c6","2-up in 6 columns"),"12c4":(0,o.createLayout)(s["12c4"],"12c4","3-up in 4 columns"),"14c7":(0,o.createLayout)(s["14c7"],"14c7","2-up in 7 columns"),"16c8":(0,o.createLayout)(s["16c8"],"16c8","2-up in 8 columns"),"16c4":(0,o.createLayout)(s["16c4"],"16c4","4-up in 4 columns")};const a={...r,...n};function l(e){return"s"===e}function c(e){return!l(e)}function d(e){return l(e)||n.hasOwnProperty(e)}function h(e){const t=/(\d)-(\d)/.exec(e);let i=1;for(i=3===(null==t?void 0:t.length)?parseInt(t[1])+parseInt(t[2]):parseInt(e);i>1;){const e=Object.keys(n).find((e=>n[e].count===i));if(e)return e;i--}return"s"}},390675:(e,t,i)=>{"use strict";i.d(t,{lineToolsSelectHotkeys:()=>o});i(466281);var s=i(470316);const o={LineToolFibRetracement:{hash:s.Modifiers.Alt+70,action:"setTool",description:"Draw Fib Retracement"},LineToolHorzLine:{hash:s.Modifiers.Alt+72,action:"drawRightThere",description:"Draw Horizontal Line here"},LineToolHorzRay:{hash:s.Modifiers.Alt+74,action:"drawRightThere",description:"Draw Horizontal Ray here"},LineToolRectangle:{hash:s.Modifiers.Alt+s.Modifiers.Shift+82,action:"setTool",description:"Draw Rectangle"},LineToolTrendLine:{hash:s.Modifiers.Alt+84,action:"setTool",description:"Draw Trend Line"},LineToolVertLine:{hash:s.Modifiers.Alt+86,action:"drawRightThere",description:"Draw Vertical Line here"},
LineToolCrossLine:{hash:s.Modifiers.Alt+67,action:"drawRightThere",description:"Draw Cross Line here"}}},235853:(e,t,i)=>{"use strict";i.d(t,{actualBehavior:()=>a,availableValues:()=>n,navigationButtonsVisibilityKey:()=>o,property:()=>r,restoreNavigationButtonsVisibilitySettingsValue:()=>l});var s=i(154241);const o="NavigationButtons.visibility",{property:r,availableValues:n,actualBehavior:a,restoreDefaultValue:l}=(0,s.createVisibilityController)(o)},836861:(e,t,i)=>{"use strict";i.d(t,{actualBehavior:()=>a,availableValues:()=>n,property:()=>r,restorePaneButtonsVisibilitySettingsValue:()=>l});var s=i(154241),o=i(235853);const{property:r,availableValues:n,actualBehavior:a,restoreDefaultValue:l}=(0,s.createVisibilityController)("PaneButtons.visibility",o.navigationButtonsVisibilityKey)},15144:(e,t,i)=>{"use strict";i.d(t,{performanceTestMode:()=>n});var s=i(125226),o=i(638456),r=i(314802);const n=navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&-1===navigator.userAgent.toLowerCase().indexOf("edge")&&!o.CheckMobile.any()&&!(0,r.isOnMobileAppPage)("any")&&!window.TVD&&!(0,o.onWidget)()&&(0,s.isFeatureEnabled)("performance_test_mode")&&!window.matchMedia("(prefers-reduced-motion)").matches},716761:(e,t,i)=>{"use strict";i.d(t,{isCustomStudy:()=>o});const s={LinearRegression:!0,PivotPointsHighLow:!0,VbPSessions:!0,VbPSessionsRoughDetailed:!0,VbPPeriodic:!0,VbPAutoAnchored:!0,ZigZag:!0,TPOPeriodic:!0,TPOSessions:!0,VbPFixed:!0,PivotPointsStandard:!0,VbPVisible:!0,VbPAnchored:!0};function o(e){return e in s}},598631:(e,t,i)=>{"use strict";i.d(t,{MetaInfoHelper:()=>u});var s=i(650151),o=i(637761),r=i(748947),n=i(124829),a=i(338619),l=i(218049);function c(e){return!e.groupId&&!e.isHidden&&e.id!==l.RangeDependentStudyInputNames.FirstBar&&e.id!==l.RangeDependentStudyInputNames.LastBar}var d=i(716761);const h=(0,a.getLogger)("Platform.GUI.PropertyDialog.Indicators.MetaInfo");class u{constructor(e){this._metaInfo=e}hasUserEditableInputs(){return this._metaInfo.inputs.some(c)}getUserEditableInputs(){return this._metaInfo.inputs.filter(c)}hasUserEditableProperties(){return o.StudyMetaInfo.isScriptStrategy(this._metaInfo)}hasUserEditableStyles(){const e=this._metaInfo;return e.plots.length>0||void 0!==e.bands||void 0!==e.filledAreas||(0,d.isCustomStudy)(e.shortId)||o.StudyMetaInfo.isScriptStrategy(this._metaInfo)||Object.values(e.graphics).some((e=>void 0!==e))}getUserEditablePlots(){const e=new Set,t=this._metaInfo;return t.plots.filter((i=>{if((0,r.isColorerPlot)(i)||(0,r.isTextColorerPlot)(i)||(0,r.isDataOffsetPlot)(i)||(0,r.isOhlcColorerPlot)(i)||(0,r.isAlertConditionPlot)(i)||(0,r.isDataPlot)(i))return!1;if((0,r.isOhlcPlot)(i)){const o=i.target;if(e.has(o))return!1;e.add(o);const r=(0,s.ensureDefined)(t.ohlcPlots);return!(0,s.ensureDefined)(r[o]).isHidden}{const e=t.styles?t.styles[i.id]:void 0;return void 0===e||!e.isHidden}}))}hasUserEditableOptions(){return this.hasUserEditableInputs()||this.hasUserEditableProperties()||this.hasUserEditableStyles()}getStrategyProperties(){const e=this._metaInfo,t=e.inputs.filter(_),i={
...p};for(const s of t){const t=s.internalID;i[t]=s,p.hasOwnProperty(t)||h.logWarn(`Unknown strategy input internal id ${t} in ${e.fullId}`)}return(0,n.clone)(i)}}const p={currency:void 0,backtest_fill_limits_assumption:void 0,calc_on_every_tick:void 0,calc_on_order_fills:void 0,commission_value:void 0,commission_type:void 0,initial_capital:void 0,pyramiding:void 0,slippage:void 0,default_qty_type:void 0,default_qty_value:void 0,margin_long:void 0,margin_short:void 0,use_bar_magnifier:void 0,process_orders_on_close:void 0,fill_orders_on_standard_ohlc:void 0};function _(e){return"strategy_props"===e.groupId}},418638:(e,t,i)=>{"use strict";i.d(t,{showAboutTheStudyHandler:()=>d});var s=i(605244);const o=/^STD;Fund_(.*?)(?:_(?:fy|fq|fh|ttm))?$/;var r=i(637761),n=i(453995),a=i(613122),l=i(137685),c=i(296842);async function d(e){const t=e.metaInfo();if(!t)return null;const{scriptIdPart:d,id:h,pine:u}=t;if((0,c.isFundamentalStudyMetaInfo)(t)){const e=function(e){const t=e.match(o);return t?t[1]:t}(d);if(e){const{default:t}=await i.e(54875).then(i.t.bind(i,384898,19));if(e in t)return()=>(0,s.showSupportDialog)({solutionId:t[e]})}}else if(!u||r.StudyMetaInfo.hasStdSuffix(d)){const{default:e}=await i.e(95937).then(i.t.bind(i,676006,19));if(d in e||h in e)return()=>(0,s.showSupportDialog)({solutionId:e[d]||e[h]})}else if(r.StudyMetaInfo.hasPubSuffix(d))return async()=>{try{const{chartImageUrl:e}=await(0,n.requestScriptInfo)(d);(0,a.openPublicationViewPopup)({uid:e,type:a.PublicationType.Script})}catch(e){(0,l.showScriptInfoErrorNoticeDialog)()}};return null}},137685:(e,t,i)=>{"use strict";i.d(t,{showScriptInfoErrorNoticeDialog:()=>r});var s=i(444372),o=i(927094);function r(){(0,o.showNoticeDialog)({type:"modal",title:s.t(null,void 0,i(782374)),content:s.t(null,void 0,i(444028))})}},875678:(e,t,i)=>{"use strict";i.d(t,{restoreShowMarketOpenStatusProperty:()=>l,showMarketOpenStatusProperty:()=>a});var s=i(998418),o=i(62802);const r="Chart.ShowMarketOpenStatus";function n(){return o.getBool(r,true)}const a=(0,s.createPrimitiveProperty)(n());function l(){a.setValue(true),o.remove(r)}o.onSync.subscribe(null,(()=>a.setValue(n()))),a.subscribe(null,(()=>o.setValue(r,a.value())))},516284:(e,t,i)=>{"use strict";i.d(t,{marketStatusText:()=>o});var s=i(807975);function o(e){const t=e.value();if(null!==t){const e=s.titleMap.get(t);if(void 0!==e)return e}return""}},807975:(e,t,i)=>{"use strict";i.d(t,{actionMap:()=>J,classNameMap:()=>U,countdownFnMap:()=>X,iconMap:()=>z,marketStatusDescription:()=>K,titleColorMap:()=>j,titleMap:()=>q,tooltipMap:()=>G});var s=i(960095),o=i(444372),r=i(553218),n=i(732140),a=i(262998),l=i(725230),c=i(315507),d=i(643401),h=i(85290),u=i(212462),p=i(792263),_=i(24165),m=i(421672),g=i(792845),S=i(109494),v=i(858994)
;const f=o.t(null,void 0,i(241410)),b=o.t(null,void 0,i(236018)),y=o.t(null,void 0,i(673897)),C=o.t(null,void 0,i(762464)),w=o.t(null,void 0,i(987845)),T=o.t(null,void 0,i(753357)),P=o.t(null,void 0,i(765420)),M=o.t(null,void 0,i(23302)),x=o.t(null,void 0,i(452176)),I=o.t(null,void 0,i(741392)),L=o.t(null,void 0,i(59938)),A=o.t(null,void 0,i(451320)),k=o.t(null,void 0,i(283187)),E=o.t(null,void 0,i(605371)),D=o.t(null,void 0,i(18643)),B=o.t(null,void 0,i(681509)),N=o.t(null,void 0,i(758470)),R=new Map([["market",new Map([["small",n],["medium",a],["large",a]])],["pre_market",new Map([["small",h],["medium",u],["large",u]])],["post_market",new Map([["small",c],["medium",d],["large",d]])],["out_of_session",new Map([["small",r],["medium",r],["large",r]])],["holiday",new Map([["small",l],["medium",l],["large",l]])]]),O=new Map([["market",v.marketStatusOpen],["pre_market",v.marketStatusPre],["post_market",v.marketStatusPost],["out_of_session",v.marketStatusClose],["holiday",v.marketStatusHoliday]]),V=new Map([["market",f],["pre_market",b],["post_market",y],["out_of_session",C],["holiday",w]]),W=new Map([["market",f],["pre_market",b],["post_market",y],["out_of_session",C],["holiday",w]]),F=new Map([["market",s.colorsPalette["color-market-open"]],["pre_market",s.colorsPalette["color-pre-market"]],["post_market",s.colorsPalette["color-post-market"]],["out_of_session",s.colorsPalette["color-market-closed"]],["holiday",s.colorsPalette["color-market-holiday"]]]),H=new Map([["market",T],["pre_market",P],["post_market",M],["out_of_session",x],["holiday",I]]);R.set("delisted",new Map([["small",p],["medium",_],["large",m]])),R.set("expired",new Map([["small",g],["medium",S],["large",S]])),O.set("delisted",v.marketStatusDelisted),O.set("expired",v.marketStatusExpired),V.set("delisted",o.t(null,void 0,i(254602))),V.set("expired",o.t(null,void 0,i(260657))),W.set("delisted",o.t(null,void 0,i(331683))),W.set("expired",o.t(null,void 0,i(260657))),F.set("delisted",s.colorsPalette["color-delisted-symbol"]),F.set("expired",s.colorsPalette["color-market-expired"]),H.set("delisted","This is no longer publicly trading so no new data will be added. But you can explore the historicals here."),H.set("expired",o.t(null,void 0,i(639301)));const z=R,U=O,G=V,q=W,j=F,K=H;function Z(e){return o.t(null,{plural:"{number} minutes",count:e},i(532547)).format({number:e.toString()})}function Y(e){return o.t(null,{plural:"{number} hours",count:e},i(844646)).format({number:e.toString()})}function $(e){const t=Math.floor(e/86400),s=Math.floor((e-86400*t)/3600),r=Math.floor((e-86400*t-3600*s)/60);return 0===t&&0===s&&0===r?L:t>0?A.format({days:(n=t,o.t(null,{plural:"{number} days",count:n},i(839501)).format({number:n.toString()})),hours:Y(s)}):s>0?k.format({hours:Y(s),minutes:Z(r)}):Z(r);var n}const X={market:e=>("post_market"===e.status?B:D).format({remainingTime:$(e.remainingSeconds)}),pre_market:e=>E.format({remainingTime:$(e.remainingSeconds)}),post_market:e=>D.format({remainingTime:$(e.remainingSeconds)}),
out_of_session:e=>("pre_market"===e.status?N:E).format({remainingTime:$(e.remainingSeconds)}),holiday:e=>("pre_market"===e.status?N:E).format({remainingTime:$(e.remainingSeconds)}),delisted:e=>"",expired:e=>""},J=new Map([["market",null],["pre_market",null],["post_market",null],["out_of_session",null],["holiday",null],["delisted",null]])},826312:(e,t,i)=>{"use strict";i.d(t,{canShowSpreadActions:()=>o,globalKeypressMatches:()=>r});var s=i(374271);i(764829);function o(){let e=!1;return e="cme"!==window.TradingView.widgetCustomer&&"bovespa"!==window.TradingView.widgetCustomer,e}function r(e){if(e.ctrlKey)return!1;if(e.metaKey)return!1;if(!e.charCode)return!1;if(!e.which||e.which<=32)return!1;const t=e.target;return(!t||!/^(input|textarea)$/i.test(t.tagName)&&"listbox"!==t.getAttribute("role"))&&!(0,s.isOpenedModals)()}},506672:(e,t,i)=>{"use strict";function s(){return Promise.all([i.e(52133),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(46489),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(25480),i.e(58985),i.e(67158),i.e(72197),i.e(88015),i.e(24125),i.e(97384),i.e(3782),i.e(49162),i.e(93523),i.e(98734),i.e(30614),i.e(7001),i.e(94106),i.e(71329),i.e(63168),i.e(51488),i.e(75364),i.e(79412),i.e(42513),i.e(16182),i.e(17762),i.e(10393),i.e(82321),i.e(87473),i.e(16388),i.e(5483),i.e(83147),i.e(75560),i.e(66144),i.e(59490),i.e(13520),i.e(90361),i.e(56926),i.e(21754)]).then(i.bind(i,788048))}i.d(t,{loadNewSymbolSearch:()=>s})},489935:(e,t,i)=>{"use strict";i.d(t,{ToastsFactory:()=>s});class s{constructor(e,t){this._chartToastsPromise=null,this._resizerBridge=e,this._bottomToolbarOffsetHeightProvider=t}async getChartToasts(){return null!==this._chartToastsPromise||(this._chartToastsPromise=async function(){return Promise.all([Promise.all([i.e(45800),i.e(44524),i.e(89407),i.e(7546),i.e(82321),i.e(66193),i.e(53088)]).then(i.bind(i,972897)),Promise.all([i.e(89407),i.e(82321),i.e(66193),i.e(94291)]).then(i.bind(i,13830))]).then((e=>[e[0].ChartToasts,e[1].globalToasts]))}().then((e=>{const t=e[0],i=e[1];return new t(this._resizerBridge,this._resizerBridge.container.value(),i,this._bottomToolbarOffsetHeightProvider())}))),this._chartToastsPromise}}},683833:(e,t,i)=>{"use strict";i.d(t,{createTradeContext:()=>o});var s=i(650151);async function o(e,t){let i=NaN,o=NaN,r="";const n=e.proSymbol(),a=(e.symbolInfo()||{name:null}).name||n,l=e.priceScale();if(t){const s=e.firstValue();i=null!==s?l.coordinateToPrice(t,s):null,r=null!==i?e.formatter().format(i):""}const c=e.bars().last();null!==c&&(o=(0,s.ensure)(c.value[TradingView.CLOSE_PLOT]));return{symbol:n,displaySymbol:a,value:i,formattedValue:r,last:o,symbolInfoTradable:!!(e.symbolInfo()||{is_tradable:!1}).is_tradable}}},84281:(e,t,i)=>{"use strict";i.d(t,{tradingService:()=>r,waitTradingService:()=>n});var s=i(564894);const o={id:"TradingService"};function r(){return(0,s.hasService)(o)?(0,s.service)(o):null}function n(){return(0,s.waitServiceRegistered)(o)}},597655:(e,t,i)=>{"use strict";i.d(t,{
isMobileTradingAvailable:()=>h,isMobileTradingAvailableInApp:()=>u});var s=i(638456),o=i(125226),r=i(314802),n=i(764829);const a=(0,o.isFeatureEnabled)("mobile_trading_ios")&&s.CheckMobile.iOS()&&(0,r.isOnMobileAppPage)("old"),l=(0,o.isFeatureEnabled)("mobile_trading_android")&&s.CheckMobile.Android()&&(0,r.isOnMobileAppPage)("new"),c=(0,o.isFeatureEnabled)("mobile_trading_web")&&s.CheckMobile.any()&&!s.CheckMobile.isIPad()&&(window.matchMedia("screen and (orientation: portrait) and (max-width: 567px)").matches||window.matchMedia("screen and (orientation: landscape) and (max-height: 567px)").matches)&&!(0,r.isOnMobileAppPage)("any"),d=n.enabled("mobile_trading")&&(a||l||c);function h(){return d}function u(){return a||l}},344158:(e,t,i)=>{"use strict";i.d(t,{addPlusButtonProperty:()=>u,restoreAddPlusButtonSettingsValue:()=>p,showPlusButtonOnCursor:()=>d});var s=i(799786),o=(i(764829),i(62802)),r=i(998418),n=i(375397);const a="add_plus_button";function l(){const e=s.keyboardPressedKeysState.value();return void 0!==e&&(Boolean(e.modifiers&s.Modifiers.Alt&&e.modifiers&s.Modifiers.Mod)&&(void 0===e.code||e.altOrOptionCode()||e.controlOrMetaCode()))}const c=new n.WatchedValue(l());s.keyboardPressedKeysState.subscribe((()=>c.setValue(l())));const d=c.readonly();function h(){return o.getBool(a,!0)}const u=(0,r.createPrimitiveProperty)(h());function p(){u.setValue(!0),o.remove(a)}o.onSync.subscribe(null,(()=>u.setValue(h()))),u.subscribe(null,(()=>{o.setValue(a,u.value())}))},995152:(e,t,i)=>{"use strict";i.d(t,{getAlertColorLineByTheme:()=>y,getSettingsProperty:()=>f,restoreSettingsProperty:()=>b});var s=i(650151),o=i(822914),r=i(316230),n=i(852290),a=i(960095),l=i(62802),c=i(61499),d=i(658843),h=i(868594),u=i(211183);const p="alertLabels";let _;const m={visible:!0,showOnlyActive:!0,line:{color:"",visible:!0}},g=new Map([[c.StdTheme.Light,{line:{color:(0,a.getHexColorByName)("color-cold-gray-900")}}],[c.StdTheme.Dark,{line:{color:(0,a.getHexColorByName)("color-cold-gray-200")}}]]);function S(){let e=(0,l.getJSON)(p,null);if(null===e){const t=(0,u.defaults)("chartproperties");t&&t.alertsProperties&&t.alertsProperties.labels&&(e=t.alertsProperties.labels)}null===e&&(e=(0,o.default)(m));const t=(0,h.extractAllPropertiesKeys)(m),i=(0,h.extractAllPropertiesKeys)(e);if(!(0,r.default)(t,i)){const i=(0,h.extractState)(e,t);e=(0,n.default)((0,o.default)(m),i)}return e}function v(){_&&(0,l.setJSON)(p,_.state())}function f(){return _||(_=new d.Property(S()),_.listeners().subscribe(null,v),l.onSync.subscribe(null,(()=>{_.mergeAndFire(S())})),_)}function b(){_&&_.mergeAndFire(m)}function y(e){const t=e.dark().value()?c.StdTheme.Dark:c.StdTheme.Light;return(0,s.ensureDefined)(g.get(t)).line.color}},938614:(e,t,i)=>{"use strict";i.d(t,{ALERT_LABEL_WIDTH:()=>ae,AlertLabel:()=>he,isAlertLabel:()=>le})
;var s,o=i(650151),r=i(960095),n=i(411667),a=i(219849),l=i(903424),c=i(343272),d=i(658843),h=i(95370),u=i(378975),p=i(975179),_=i(169532),m=i(345848),g=i(995152),S=i(86441),v=i(444372),f=i(982949),b=i(509078),y=i(112377),C=i(230844),w=i(922182),T=i(666574),P=i(665798),M=i(286436),x=i(961970);!function(e){e[e.ConnectorOffsetFromIcon=28]="ConnectorOffsetFromIcon",e[e.ConnectorCircleRadius=4]="ConnectorCircleRadius",e[e.IconWidth=21]="IconWidth"}(s||(s={}));class I extends x.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e,t){const i=(0,M.interactionTolerance)().line;for(let s=0;s<this._data.levels.length;s++){const o=this._data.levels[s],[r,n]=this._calculateLeftRight(this._data,o,t.mediaSize.width,1),a=Math.min(r,n),l=Math.max(r,n);if(Math.abs(o.y-e.y)<=i&&e.x>=a&&e.x<=l)return new b.HitTestResult(b.HitTarget.MovePoint,{activeItem:s,hideCrosshairLinesOnHover:!0,areaName:b.AreaName.Line})}const o=this._data.levels.map((e=>e.y)),r=Math.min(...o),n=Math.max(...o),a=this._data.isLeft?Math.round(s.ConnectorOffsetFromIcon+s.IconWidth):Math.round(t.mediaSize.width-(s.ConnectorOffsetFromIcon+s.IconWidth));if(Math.abs(a-e.x)<i&&e.y>=r&&e.y<=n){const t=o.reduce(((t,i,s)=>{const o=Math.abs(t.level-e.y);return Math.abs(i-e.y)<o?{index:s,level:i}:t}),{index:0,level:o[0]});return new b.HitTestResult(b.HitTarget.MovePoint,{activeItem:t.index,hideCrosshairLinesOnHover:!0,areaName:b.AreaName.Line})}return null}_drawImpl(e){const t=e.context;if(t.lineWidth=Math.max(1,Math.floor(e.verticalPixelRatio)),t.strokeStyle=this._data.color,(0,P.setLineStyle)(t,T.LINESTYLE_DASHED),this._data.levels.forEach((i=>{const s=Math.round(i.y*e.verticalPixelRatio),[o,r]=this._calculateLeftRight(this._data,i,e.bitmapSize.width,e.horizontalPixelRatio);(0,P.drawHorizontalLine)(t,s,o,r)})),this._data.levels.length>1){const i=this._data.isLeft?Math.round((s.ConnectorOffsetFromIcon+s.IconWidth)*e.horizontalPixelRatio)+.5:Math.round(e.bitmapSize.width-(s.ConnectorOffsetFromIcon+s.IconWidth)*e.horizontalPixelRatio)+.5,o=this._data.levels.map((e=>e.y)),r=Math.min(...o),n=Math.max(...o);t.beginPath(),t.moveTo(i,r*e.verticalPixelRatio),t.lineTo(i,n*e.verticalPixelRatio),t.stroke();const a=Math.round(s.ConnectorCircleRadius*e.horizontalPixelRatio);(0,P.setLineStyle)(t,T.LINESTYLE_SOLID),t.fillStyle=this._data.connectorsBackColor,[r,n].forEach((s=>{const o=Math.round(s*e.verticalPixelRatio);t.beginPath(),t.arc(i,o,a,0,2*Math.PI,!0),t.fill(),t.stroke()}))}}_calculateLeftRight(e,t,i,o){const r=1===e.levels.length?0:Math.floor(s.ConnectorCircleRadius*o);let n,a;return this._data.isLeft?(a=0,n="full"===t.mode?i:"toConnector"===t.mode?Math.round((s.ConnectorOffsetFromIcon+s.IconWidth-r)*o):Math.round(this._data.distanceToTooltip*o)):(n="full"===t.mode?0:"toConnector"===t.mode?Math.round(i-(s.ConnectorOffsetFromIcon+s.IconWidth-r)*o):Math.round(i-this._data.distanceToTooltip*o),a=i),[n,a]}}var L=i(934026),A=i(631088),k=i(511275),E=i(694852),D=i(5486),B=i(828473),N=i(547777);const R=(0,
E.makeFont)(12,k.CHART_FONT_FAMILY),O=new Path2D("M5 3.06574L10.9014 7L5 10.9343V3.06574ZM6 9.06574L9.09861 7L6 4.93426V9.06574ZM7 13C10.3137 13 13 10.3137 13 7C13 3.68629 10.3137 1 7 1C3.68629 1 1 3.68629 1 7C1 10.3137 3.68629 13 7 13ZM7 14C10.866 14 14 10.866 14 7C14 3.13401 10.866 0 7 0C3.13401 0 0 3.13401 0 7C0 10.866 3.13401 14 7 14Z"),V=" • ";class W extends x.BitmapCoordinatesPaneRenderer{constructor(){super(),this._data=null,this._lastPaintTextWidth=null,this._lastPaintPaneWidth=null,this._widthCache=new D.TextWidthCache}setData(e){this._data=e}hitTest(e){const t=this._data;if(null===this._lastPaintTextWidth||!t||null===this._lastPaintPaneWidth)return null;const i=this._lastPaintTextWidth+16+26,s=this._calculatePoint(t,i,this._lastPaintPaneWidth);{const o=new S.Point(s.x-26+i,s.y-9.5),r=o.add(new S.Point(26,19));if((0,L.pointInBox)(e,(0,S.box)(o,r)))return new b.HitTestResult(b.HitTarget.Custom,{activeItem:t.lineIndex,hideCrosshairLinesOnHover:!0,areaName:b.AreaName.Button,clickHandler:t.buttonAction,tapHandler:t.buttonAction})}{const o=new S.Point(s.x,s.y-9.5),r=o.add(new S.Point(i,19));if((0,L.pointInBox)(e,(0,S.box)(o,r)))return new b.HitTestResult(b.HitTarget.MovePoint,{activeItem:t.lineIndex,hideCrosshairLinesOnHover:!0,areaName:b.AreaName.Tooltip})}return null}_drawImpl(e){const t=this._data;if(!t)return;const i=e.context;this._lastPaintPaneWidth=e.mediaSize.width,i.font=R;const s=t.text,r=t.additionalText;let n=!1,a=null;r&&(this._lastPaintTextWidth=this._widthCache.measureText(i,s+V+r),a=this._tooltipSizes(e),n=a.contentWidth<=a.maxWidth);let l=s;if(!n&&(this._lastPaintTextWidth=this._widthCache.measureText(i,l),a=this._tooltipSizes(e),a.contentWidth>a.maxWidth)){l=function(e,t,i){const s=(0,B.lowerboundExt)((t=>e.substring(0,t)),t,((t,s)=>i(t===e?e:(0,N.appendEllipsis)(t))<s),0,e.length);return s===e.length?e:(0,N.appendEllipsis)(e.substring(0,s))}(l,a.maxWidth-16-26,(e=>this._widthCache.measureText(i,e)))}const c=(0,o.ensureNotNull)(a).maxWidth,d=Math.round(c*e.horizontalPixelRatio),h=Math.round(19*e.verticalPixelRatio),u=this._calculatePoint(t,c,this._lastPaintPaneWidth);this._drawBorderAround(t,e,u,d,h,(e=>e.fill())),this._drawButton(t,e,u,d,h),this._drawText(t,e,u,l),n&&this._drawAdditionalText(t,e,u),this._drawBorderAround(t,e,u,d,h,(e=>e.stroke()))}_drawButton(e,t,i,s,o){const r=t.context;i=i.add(new S.Point(s/t.horizontalPixelRatio,0));{const s=Math.round((i.x-26)*t.horizontalPixelRatio)+.5,n=Math.round(i.y*t.verticalPixelRatio-.5*o)+.5;r.fillStyle=e.buttonBackColor,r.fillRect(s,n,26*t.horizontalPixelRatio,o),r.strokeStyle=e.buttonBorderColor,r.lineWidth=Math.max(1,Math.floor(t.verticalPixelRatio)),r.beginPath(),r.moveTo(s,n),r.lineTo(s,n+o),r.stroke()}0===e.buttonType?this._drawCloseButton(e,t,i):1===e.buttonType&&this._drawRestartButton(e,t,i)}_drawCloseButton(e,t,i){const s=t.context;s.strokeStyle=e.lineColor,s.beginPath()
;const o=Math.round((i.x-13-4+.5)*t.horizontalPixelRatio),r=Math.round((i.y-4+.5)*t.verticalPixelRatio),n=Math.round(8*t.horizontalPixelRatio),a=Math.round(8*t.verticalPixelRatio);s.moveTo(o,r),s.lineTo(o+n,r+a),s.moveTo(o,r+a),s.lineTo(o+n,r),s.stroke()}_drawRestartButton(e,t,i){const s=t.context,r=Math.round((i.x-26+6+.5)*t.horizontalPixelRatio),n=Math.round((i.y-7+.5)*t.verticalPixelRatio);s.save(),s.translate(r,n),s.scale(t.horizontalPixelRatio,t.verticalPixelRatio),s.fillStyle=(0,o.ensureDefined)(e.restartIconColor),s.fill(O,"evenodd"),s.restore()}_tooltipSizes(e){const t=(0,o.ensureNotNull)(this._lastPaintTextWidth)+16+26,i=Math.max(20,.9*(e.mediaSize.width-80));return{contentWidth:t,maxWidth:Math.min(t,i)}}_drawText(e,t,i,s){const o=t.context,r=Math.round((i.x+8)*t.horizontalPixelRatio),n=Math.round((i.y+5)*t.verticalPixelRatio);o.save(),o.translate(r,n),(0,A.drawScaled)(o,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{o.fillStyle=e.textColor,o.fillText(s,0,0)})),o.restore()}_drawAdditionalText(e,t,i){const s=t.context,r=Math.round(this._widthCache.measureText(s,e.text)*t.horizontalPixelRatio),n=Math.round(this._widthCache.measureText(s,V)*t.horizontalPixelRatio),a=Math.round((i.x+8)*t.horizontalPixelRatio)+r,l=Math.round((i.y+5)*t.verticalPixelRatio);s.save(),s.fillStyle=(0,o.ensureDefined)(e.additionalTextColor),s.translate(a,l),(0,A.drawScaled)(s,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{s.fillStyle=(0,o.ensureDefined)(e.textColor),s.fillText(V,0,0)})),s.translate(n,0),(0,A.drawScaled)(s,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{s.fillStyle=(0,o.ensureDefined)(e.additionalTextColor),s.fillText((0,o.ensureDefined)(e.additionalText),0,0)})),s.restore()}_drawBorderAround(e,t,i,s,o,r){const n=t.context,a=Math.round(i.x*t.horizontalPixelRatio)+.5,l=Math.round(i.y*t.verticalPixelRatio-o/2)+.5;n.strokeStyle=e.lineColor,n.lineWidth=Math.max(1,Math.floor(t.verticalPixelRatio));const c=Math.round(4*t.horizontalPixelRatio);n.fillStyle=e.backColor,n.beginPath(),(0,P.drawRoundRect)(n,a,l,s,o,c),r(n)}_calculatePoint(e,t,i){const s=e.point;if(e.center){const o=Math.max(0,.5*(i-t));return e.isLeft?o<s.x?s:new S.Point(o,s.y):o+t<s.x?new S.Point(o,s.y):new S.Point(s.x-t,s.y)}return e.isLeft?s:s.subtract(new S.Point(t,0))}}var F;!function(e){e[e.SelectionPointOffset=35]="SelectionPointOffset",e[e.NoLineModeOffsetSingleLine=47]="NoLineModeOffsetSingleLine",e[e.NoLineModeOffsetMultipleLines=62]="NoLineModeOffsetMultipleLines"}(F||(F={}));const H=" — ",z=v.t(null,{context:"alert_status"},i(730829)),U=z+H+v.t(null,{context:"alert_status"},i(261129)),G=z+H+v.t(null,{context:"alert_status"},i(401732)),q=z+H+v.t(null,{context:"alert_status"},i(660963)),j=new Map([[n.AlertStopReason.Auto,G],[n.AlertStopReason.Manual,U],[n.AlertStopReason.Expired,q]]);function K(e){return void 0!==e?j.get(e):void 0}function Z(e,t){switch(e){case n.AlertStopReason.Auto:return t.inActiveTextTriggeredColor;case n.AlertStopReason.Manual:return t.inActiveTextManualColor;case n.AlertStopReason.Expired:return t.inActiveTextExpiredColor
;default:return}}class Y{constructor(e,t){this._invalidated=!0,this._compositeRenderer=new f.CompositeRenderer,this._tooltipRenderer=new W,this._alertLabel=e,this._model=t}update(){this._invalidated=!0}invalidate(){this._model.lightUpdate()}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._compositeRenderer}_updateImpl(){var e,t;this._compositeRenderer.clear();const i=this._alertLabel,s=i.alert(),r=s.condition();if(null===r)return;const n=(0,o.ensureNotNull)(this._model.paneForSource(i)),a=(0,o.ensureNotNull)(n.mainDataSource()).firstValue();if(null===a||!i.canDrawLabelForAlert())return;const l=(0,o.ensureNotNull)(i.priceScale()),c=e=>l.priceToCoordinate(e,a),d=[];if("channel"===r.type){const e=c(r.upper),t=c(r.lower);d.push(e),d.push(t)}else d.push(c(r.price));const h=i.isSelected(),u=i.isHovered(),p=this._model.lastHittestData(),_=this._model.lastSelectedHittestData();let m=0;u&&(m=null!==(e=null==p?void 0:p.activeItem)&&void 0!==e?e:0),h&&(m=null!==(t=null==_?void 0:_.activeItem)&&void 0!==t?t:0);const g=this._alertLabel.colors(),v=i.labelLineColor(),f=d.map(((e,t)=>({y:e,mode:i.drawHorzLine()?"full":t===m&&1===d.length?"toTooltip":"toConnector"}))),T=n.leftPriceScales().includes(l),P=1===d.length?F.NoLineModeOffsetSingleLine:F.NoLineModeOffsetMultipleLines,M={distanceToTooltip:P,levels:f,color:v,connectorsBackColor:g.connectorBackColor,iconBackgroundWithCorners:h||u,iconColor:g.iconColor,isLeft:T};if((i.drawHorzLine()||h||u)&&this._compositeRenderer.append(new I(M)),h){const e=n.height(),t=d.map((t=>this._model.backgroundColorAtYPercentFromTop(t/e))),i=T?F.SelectionPointOffset:n.width()-F.SelectionPointOffset,s={points:d.map((e=>new S.Point(i,e))),hittestResult:b.HitTarget.MovePoint,bgColors:t,visible:!0,barSpacing:this._model.timeScale().barSpacing()};this._compositeRenderer.append(new y.SelectionRenderer(s))}if((h||u)&&!this._alertLabel.isMoving()){const e=u&&(null==p?void 0:p.areaName)===b.AreaName.Button,t=T?P:n.width()-P,o=s.name()||(i.isMoving()?s.defaultDescription():s.description()),r=this._alertLabel.isInactive()?g.inActiveTextBaseColor:v,a=async()=>{const e=this._alertLabel.alert().id().value(),t=this._alertLabel.alert().isNew();e&&!t&&(await(0,C.getAlertsActionCreators)()).deleteAlert(e,{confirmation:(0,w.selectedRemoveConfirmation)([s]),analytics:{actionLabel:"Alert label source",actionSource:"Chart",event:"restart"}}).execute()},l=async()=>{const e=this._alertLabel.alert().id().value(),t=this._alertLabel.alert().isNew();e&&!t&&(await(0,C.getAlertsActionCreators)()).restartAlert(e,{analytics:{actionLabel:"Alert label source",actionSource:"Chart",event:"restart"}}).execute()},c=i.stopReason(),h=void 0!==c,_={isLeft:T,point:new S.Point(t,d[m]),lineIndex:m,center:i.drawHorzLine(),text:o,textColor:r,additionalText:K(c),additionalTextColor:Z(c,g),lineColor:v,backColor:g.connectorBackColor,buttonType:h?1:0,buttonBorderColor:g.tooltipButtonBorderColor,buttonBackColor:e?g.tooltipButtonBorderColorHovered:g.connectorBackColor,buttonAction:h?l:a,
restartIconColor:h?g.restartIconColor:void 0,themeName:this._model.dark().value()?"dark":"light"};this._tooltipRenderer.setData(_),this._compositeRenderer.append(this._tooltipRenderer)}}}var $=i(432059),X=i(347808);class J{constructor(e){this._renderers=null!=e?e:[]}clear(){this._renderers=[]}add(e){this._renderers.push(e)}draw(e,t,i,s,o){for(const r of this._renderers)r.draw(e,t,i,s,o)}lastDrawnBodyBox(){let e=null;for(const t of this._renderers)if(t.lastDrawnBodyBox){const i=t.lastDrawnBodyBox();if(null!==i){if(null===e){e=i;continue}e=(0,S.box)((0,S.point)(Math.min(e.min.x,i.min.x),Math.min(e.min.y,i.min.y)),(0,S.point)(Math.max(e.max.x,i.max.x),Math.max(e.max.y,i.max.y)))}}return e}hitTest(e,t,i){var s,o;let r=null;for(let n=this._renderers.length-1;n>=0;n-=1){const a=null===(o=(s=this._renderers[n]).hitTest)||void 0===o?void 0:o.call(s,e,t,i);null!=a&&(null===r||a.target()>r.target())&&(r=a)}return r}topBottomTotalHeight(e){const t={top:0,bottom:0,total:0};for(const i of this._renderers){const s=i.topBottomTotalHeight(e);t.top=Math.max(t.top,s.top),t.bottom=Math.max(t.bottom,s.bottom),t.top=t.top+t.bottom}return t}setData(e,t){for(const i of this._renderers)i.setData(e,t)}}var Q=i(968720);const ee=new Path2D("M6.21 5.27 1.68 1.06A1 1 0 0 0 0 1.79v8.42a1 1 0 0 0 1.68.73l4.53-4.2a1 1 0 0 0 0-1.47Z");class te{constructor(){this._data=null,this._commonData=null,this._bodyBox=null}setData(e,t){this._data=e,this._commonData=t}lastDrawnBodyBox(){return this._bodyBox}draw(e,t,i,s,o){var r;const n=this._data,a=this._commonData;if(!n||!a)return;const l="right"===o,{horizontalPixelRatio:c,verticalPixelRatio:d,bitmapSize:h,mediaSize:u}=t,{borderSize:p}=i,_=l?h.width:Math.max(1,Math.floor(p*c));e.save(),e.fillStyle=null!==(r=n.backgroung)&&void 0!==r?r:a.background,e.translate(_,Math.round((a.coordinate-6.5+1)*d)),(0,A.drawScaled)(e,l?-c:c,d,(()=>{e.fill(ee)})),e.restore();{const e=l?u.width-7:0;this._bodyBox=(0,S.box)((0,S.point)(e,a.coordinate-6.5),(0,S.point)(e+7,a.coordinate+6.5))}}topBottomTotalHeight(e){return{top:0,bottom:0,total:0}}hitTest(e,t,i){return this._data?(0,Q.hittestByData)(this._data,e):null}}var ie;!function(e){e[e.IconMinWidth=23]="IconMinWidth"}(ie||(ie={}));class se extends X.PriceAxisView{constructor(e,t){super(),this._collapsedAxisRenderer=new te,this._lastDrawnAxisBox=null,this._lastDrawnPaneBox=null,this._alertLabel=e,this._levelIndex=t,this._collapsedAxisRenderer.setData(this._axisRendererData,this._commonRendererData)}renderer(){return this._updateRendererDataIfNeeded(),this._rendererImpl()}ignoreAlignment(){return!0}_updateRendererData(e,t,i){var s,o,r,n,a,l;if(e.visible=!1,t.visible=!1,!this._alertLabel.labelVisible())return;const c=this._alertLabel.priceScale();if(!c)return;const d=c.mainSource(),h=null!==d?d.firstValue():null;if(c.isEmpty()||null===h)return;const u=this._alertLabel.priceOfLevel(this._levelIndex);if(null===u)return;const p=this._alertLabel.colors(),_=this._alertLabel.labelLineColor();i.background=(0,$.resetTransparency)(_),i.textColor=p.iconColor,
i.coordinate=c.priceToCoordinate(u,h);const m=this._alertLabel.animation();if(null!==m){const e=m.data(performance.now());i.globalAlpha=e.alpha}else i.globalAlpha=void 0;e.text=c.formatPrice(u,h);const g=null!==(r=null===(o=(s=this._rendererImpl()).lastDrawnBodyBox)||void 0===o?void 0:o.call(s))&&void 0!==r?r:this._lastDrawnAxisBox;this._lastDrawnAxisBox=null!=g?g:this._lastDrawnAxisBox,this._lastDrawnAxisBox&&(e.hitTestData={hoverModelFromAxis:!0,itemBox:this._lastDrawnAxisBox,activeItem:this._levelIndex});const S=null!==(l=null===(a=(n=this._paneRenderer).lastDrawnBodyBox)||void 0===a?void 0:a.call(n))&&void 0!==l?l:this._lastDrawnPaneBox;this._lastDrawnPaneBox=null!=S?S:this._lastDrawnPaneBox,this._lastDrawnPaneBox&&(t.hitTestData={hoverModelFromAxis:!0,itemBox:this._lastDrawnPaneBox,activeItem:this._levelIndex}),t.hitTarget=b.HitTarget.MovePoint,e.hitTarget=b.HitTarget.Regular,t.labelIcon=1,t.labelIconMinWidth=ie.IconMinWidth,t.visible=!0,e.visible=!0}_rendererImpl(){return null===this._alertLabel.animation()?this._alertLabel.isHovered()||this._alertLabel.isSelected()?this._axisRenderer:this._collapsedAxisRenderer:new J([this._collapsedAxisRenderer,this._axisRenderer])}}var oe=i(930203);const re=c.sortSourcesPreOrdered.AlertLabel,ne=c.sortSourcesPreOrdered.AlertLabelInactive,ae=5;function le(e){return e instanceof he}const ce={newAlertColor:(0,r.getHexColorByName)("color-cold-gray-450"),inActiveAlertColor:(0,r.getHexColorByName)("color-cold-gray-600"),inActiveTextBaseColor:(0,r.getHexColorByName)("color-cold-gray-450"),inActiveTextManualColor:(0,r.getHexColorByName)("color-cold-gray-450"),inActiveTextTriggeredColor:(0,r.getHexColorByName)("color-tan-orange-500"),inActiveTextExpiredColor:(0,r.getHexColorByName)("color-ripe-red-500"),connectorBackColor:(0,r.getHexColorByName)("color-cold-gray-900"),iconColor:(0,r.getHexColorByName)("color-cold-gray-900"),restartIconColor:(0,r.getHexColorByName)("color-cold-gray-200"),tooltipButtonBorderColor:(0,r.getHexColorByName)("color-cold-gray-800"),tooltipButtonBorderColorHovered:(0,r.getHexColorByName)("color-cold-gray-800")},de={newAlertColor:(0,r.getHexColorByName)("color-cold-gray-450"),inActiveAlertColor:(0,r.getHexColorByName)("color-cold-gray-300"),inActiveTextBaseColor:(0,r.getHexColorByName)("color-cold-gray-550"),inActiveTextManualColor:(0,r.getHexColorByName)("color-cold-gray-550"),inActiveTextTriggeredColor:(0,r.getHexColorByName)("color-tan-orange-500"),inActiveTextExpiredColor:(0,r.getHexColorByName)("color-ripe-red-500"),connectorBackColor:(0,r.getHexColorByName)("color-white"),iconColor:(0,r.getHexColorByName)("color-white"),restartIconColor:(0,r.getHexColorByName)("color-cold-gray-900"),tooltipButtonBorderColor:(0,r.getHexColorByName)("color-cold-gray-100"),tooltipButtonBorderColorHovered:(0,r.getHexColorByName)("color-cold-gray-100")};class he extends l.DataSource{constructor(e,t,i,s){super(),this._priceAxisViews=[],this._paneLabelsPaneViews=[],this._propertyMock=new d.Property,this._startMovingPoint=null,this._currentMovingPoint=null,this._animation=null,
this._onConditionChanged=()=>{const e=this.alert().condition(),t=e?"channel"===e.type?2:1:0;if(this._priceAxisViews.length!==t){for(let e=this._priceAxisViews.length;e<t;e++){const t=new se(this,e);this._priceAxisViews.push(t),this._paneLabelsPaneViews.push(new h.PanePriceAxisView(t,this,this._model))}this._priceAxisViews=this._priceAxisViews.slice(0,t),this._paneLabelsPaneViews=this._paneLabelsPaneViews.slice(0,t)}this._model.lightUpdate()},this._propertyMock.addProperty("visible",!0),this._model=e,this._alert=t,this._alertOwnerSource=i,this._paneView=new Y(this,e),this._invokeAlertEditor=s,this._resetUserEditEnabled(),this._hasAlert.setValue(!0),this._alertSeriesId=(0,o.ensureNotNull)(t.seriesId()),this._alertId=t.id().spawn(),this._alertId.subscribe(this._resetUserEditEnabled.bind(this)),t.onConditionChanged().subscribe(this,this._onConditionChanged),this._onConditionChanged(),this._isBeingEdited=t.isBeingEdited().spawn(),this._isBeingEdited.subscribe(this._resetUserEditEnabled.bind(this)),this._selected=t.selected().spawn(),this._selected.subscribe(this._onAlertSelectedChanged.bind(this)),this._selected.value()&&this.canDrawLabelForAlert()&&this._selectAlertLabel(),this._localFireTime=t.localFireTime().spawn(),this._localFireTime.subscribe(this._onAlertFireTimeChanged.bind(this),{callWithLast:!0}),(0,g.getSettingsProperty)().subscribe(this,(()=>e.updateSource(this))),this._active=t.active().spawn(),this._active.subscribe((()=>e.updateSource(this)))}destroy(){this._alertId.destroy(),this._isBeingEdited.destroy(),this._localFireTime.destroy(),this._active.destroy(),this._selected.destroy(),(0,g.getSettingsProperty)().unsubscribeAll(this),this._alert.onConditionChanged().unsubscribeAll(this),super.destroy()}model(){return this._model}zorder(){return this.isInactive()?ne:re}colors(){return{...this._themedColors(),lineColor:this.labelLineColor()}}alertOwnerSource(){return this._alertOwnerSource}alertSeriesId(){return this._alertSeriesId}alignCrossHairToMovePoint(){return!0}name(){return"AlertLabel"}isSpeciallyZOrderedSource(){return!0}stop(){this._alert.id().unsubscribe(this._resetUserEditEnabled),this._alert.isBeingEdited().unsubscribe(this._resetUserEditEnabled),this._alert.selected().unsubscribe(this._onAlertSelectedChanged)}alert(){return this._alert}isMoving(){return null!==this._startMovingPoint}isHovered(){return this===this._model.hoveredSource()}isSelected(){return this._model.selection().isSelected(this)}alertId(){return this.alert().id().value()}getAlert(){return Promise.resolve(this._alert)}getAlertSync(){return this._alert}priceOfLevel(e){const t=this.alert().condition();return t?"channel"===t.type?[t.upper,t.lower][e]:t.price:null}convertYCoordinateToPriceForMoving(e,t){const i=this.priceScale();if(!t||!i||i.isEmpty())return null;const s=t.firstValue();return null===s?null:i.coordinateToPrice(e,s)}isSynchronizable(){return!1}state(){const e=this.alert().condition(),t=[];return null!==e&&("channel"===e.type?(t.push({price:e.upper}),t.push({price:e.lower})):t.push({price:e.price})),{id:this._id,
type:"AlertLabel",zorder:this.zorder(),points:t}}restorePoints(e){}createServerPoints(){}properties(){return this._propertyMock}paneViews(){return window.TradingView.printing||!this.labelVisible()?null:[this._paneView]}topPaneViews(){const e=performance.now();return null!==this._animation&&this._continueOrFinishAnimation(e),!window.TradingView.printing&&this.labelVisible()&&this._animationActive(e)?(this.updateAllViews((0,_.sourceChangeEvent)(this.id())),this._paneLabelsPaneViews):null}dataWindowView(){return null}priceAxisViews(e,t){return this.labelVisible()&&this.priceScale()===t&&!this._animationActive()&&this.canDrawLabelForAlert()?this._priceAxisViews:[]}topPriceAxisViews(e,t){const i=performance.now();return null!==this._animation&&this._continueOrFinishAnimation(i),this.priceScale()===t&&this._animationActive(i)&&this.canDrawLabelForAlert()?(this.updateAllViews((0,_.sourceChangeEvent)(this.id())),this._priceAxisViews):[]}updateAllViews(e){this._paneView.update(),this._priceAxisViews.forEach((t=>t.update(e))),this._paneLabelsPaneViews.forEach((t=>t.update(e)))}pointsCount(){return 0}title(){return this.alert().title()}movable(){return!this._alert.isBeingEdited().value()&&!this._alert.isNew()}startMoving(e,t,i,s){this._userEditEnabled=!1,this._startMovingPoint=e,this.alert().startEditing()}move(e,t,i,s){if(!e.logical||null===t)return;const r=e.logical.price,n=this.alert(),a=(0,o.ensureNotNull)(n.condition());if(this._currentMovingPoint={...e},"channel"===a.type){let{upper:e,lower:i}=a;const s=this._alertOwnerSource.base()||100;0===t?(0,o.ensureDefined)(this._currentMovingPoint.logical).price=e=Math.max(r,i+1/s):1===t&&((0,o.ensureDefined)(this._currentMovingPoint.logical).price=i=Math.min(r,e-1/s)),n.setCondition({...a,lower:i,upper:e})}else n.setCondition({type:"price",price:r})}endMoving(){const e=this._startMovingPoint,t=this._currentMovingPoint;if(this._userEditEnabled=!0,this._startMovingPoint=null,this._currentMovingPoint=null,!e||!t||e===t)return;(0,m.trackEvent)("chart_alert","edit","move"),this._invokeAlertEditor({dataSourceHub:this._model,alert:this.alert(),type:"edit_alert",onEditCancel:()=>{setTimeout((async()=>{if(this.isInactive()){const e=this.alert().id().value();void 0!==e&&(await(0,C.getAlertsActionCreators)()).restartAlert(e,{analytics:{actionLabel:"Alert label source",actionSource:"Chart",event:"restart"}}).execute()}else this.alert().abortEditing();this._model.lightUpdate()}),0)},silent:!0,actionSource:"alert_label_move",onAborted:()=>this.alert().abortEditing()})}currentMovingPoint(){return this._currentMovingPoint}showInObjectTree(){return!1}isRemovedByStudyTemplates(){return!1}isUserDeletable(){return!1}doesMovingAffectsUndo(){return!1}drawHorzLine(){return this.labelLineVisible()}canDrawLabelForAlert(){const e=this.alert(),t=this._model.mainSeries(),i=t&&t.properties().childs(),s=i&&i.style&&i.style.value(),o=(0,p.isRangeBasedStyle)(s)?s:null,r=e.crossInterval()||u.Interval.isEqual(e.resolution(),t.interval()),n=e.rangeBasedStyle()===o;return e.isPrice()&&r&&n}labelVisible(){
const e=this._alertOwnerSource.symbolSource();if(e&&(e.isConvertedToOtherCurrency()||e.isConvertedToOtherUnit()))return!1;if(this._model.isInReplay().value())return!1;if(!this.isInactive())return(0,g.getSettingsProperty)().childs().visible.value();const t=this.stopReason();return void 0!==t&&(t===n.AlertStopReason.Created||this._animationActive()||!this.showOnlyActive())}labelLineColor(){const e=(0,g.getSettingsProperty)().childs().line.childs().color.value(),t=e||(0,g.getAlertColorLineByTheme)(this.model());if(null!==this._animation)return(0,o.ensureDefined)(t);const i=this._themedColors();return this._alert.isNew()?(0,o.ensureDefined)(i.newAlertColor):this._alert.active().value()||this._alert.stopReason()===n.AlertStopReason.Created?t:(0,o.ensureDefined)(i.inActiveAlertColor)}labelLineVisible(){return(0,g.getSettingsProperty)().childs().line.childs().visible.value()}showOnlyActive(){return(0,g.getSettingsProperty)().childs().showOnlyActive.value()}stopReason(){return this.isInactive()?this._alert.stopReason():void 0}animation(){return this._animation}isInactive(){return!this._alert.active().value()&&!this._alert.isNew()}_themedColors(){return this._model.dark().value()?ce:de}_resetUserEditEnabled(){const e=this._alert;this._userEditEnabled=!(e.isBeingEdited().value()||e.isNew()||!e.isPrice()||null===e.condition())}_onAlertSelectedChanged(e){this.canDrawLabelForAlert()&&(e?this._selectAlertLabel():this._unselectAlertLabel())}_selectAlertLabel(){this._model.selectionMacro((e=>{e.selection().isSelected(this)||(e.clearSelection(),e.addSourceToSelection(this))}))}_unselectAlertLabel(){this._model.selectionMacro((e=>{e.selection().isSelected(this)&&e.removeSourceFromSelection(this)}))}_onAlertFireTimeChanged(e){var t,i;null!==e&&(this._animation=(t=e,i=this.isHovered()||this.isSelected()?1:0,{finished:e=>e-t>=2400,data:e=>{const s=Math.min(e-t,2400)%1200,o=s%600,r=Math.round(s/1200),n=(0,oe.easingFunc.linear)(o/600);return{alpha:0===r==(0===i)?n:1-n}}}),this._model.updateSource(this))}_continueOrFinishAnimation(e){(0,o.ensureNotNull)(this._animation).finished(e)?(this._animation=null,this._model.updateSource(this)):this._model.invalidate(a.InvalidationMask.cursor())}_animationActive(e=performance.now()){return null!==this._animation&&!this._animation.finished(e)}}},436207:(e,t,i)=>{"use strict";i.d(t,{AppliedTimeFrame:()=>o});var s=i(566238);class o{constructor(e){this._appliedTimeFrame=new s.WatchedObject(null),this._appliedTimeFrameInfo=null,this._appliedTimeFrameChangedBound=this._appliedTimeFrameChanged.bind(this),this._model=e,e.mainSeries().dataEvents().seriesTimeFrame().subscribe(this,this._onSeriesTimeFrame),this._appliedTimeFrame.subscribe(this._appliedTimeFrameChangedBound)}destroy(){this._appliedTimeFrame.unsubscribe(this._appliedTimeFrameChangedBound),this._model.timeScale().logicalRangeChanged().unsubscribeAll(this),this._model.mainSeries().dataEvents().seriesTimeFrame().unsubscribeAll(this)}appliedTimeFrame(){return this._appliedTimeFrame}_appliedTimeFrameChanged(){
this._model.timeScale().logicalRangeChanged().unsubscribe(this,this._invalidateAppliedTimeFrame)}_onSeriesTimeFrame(e,t,i,s){if(s){const e=this._model.timeScale();this._appliedTimeFrameInfo={logicalRange:e.logicalRange(),baseIndex:e.baseIndex()},e.logicalRangeChanged().subscribe(this,this._invalidateAppliedTimeFrame)}}_invalidateAppliedTimeFrame(){if(null===this._appliedTimeFrameInfo)return;const e=this._model.timeScale(),t=e.logicalRange(),i=e.baseIndex(),s=this._appliedTimeFrameInfo.logicalRange,o=this._appliedTimeFrameInfo.baseIndex;(null===t||null===s||Math.abs(i-t.left()-(o-s.left()))>=.01||Math.abs(i-t.right()-(o-s.right()))>=.01)&&this._appliedTimeFrame.setValue(null)}}},496416:(e,t,i)=>{"use strict";i.d(t,{defaultsPreferencesByWhiteList:()=>D,preferencesByWhiteList:()=>E});var s=i(124829),o=i(779732),r=i(725356),n=i(338619),a=i(675490),l=i(211183),c=i(707311),d=i(45003),h=i(201871),u=i(960095);const p={visible:!1,lineStyle:i(666574).LINESTYLE_DOTTED,lineWidth:1,bidLineColor:u.colorsPalette["color-tv-blue-500"],askLineColor:u.colorsPalette["color-ripe-red-400"]};var _=i(954384),m=i(255866),g=i(79908);const S={...r.candleStylePreferencesDefault,deltaAdjust:!0,showSummary:!0,type:m.VolumeFootprintTypeValues.BuyAndSell,pointOfControl:!0,bgColors:(0,g.getBgColorsDefaults)(),imbalanceHighlight:{buyColor:(0,u.getHexColorByName)("color-minty-green-500"),sellColor:(0,u.getHexColorByName)("color-ripe-red-500"),visible:!0},inputs:{rowSize:"Auto",atrLength:14,imbalancePercent:300,ticksPerRow:100,showVA:!0,vaPercent:70,calcStackedImbalance:!1,stackedImbalanceCount:3}};var v=i(394954),f=i(548544);const b=(0,n.getLogger)("Chart.ApplyPreferencesToAllCharts"),y={color:"",style:0},C={autoScale:!1,autoScaleDisabled:!1,lockScale:!1,percentage:!1,percentageDisabled:!1,log:!1,logDisabled:!1,alignLabels:!1,isInverted:!1,indexedTo100:!1},w={backgroundType:h.ColorType.Solid,background:"",backgroundGradientStartColor:"",backgroundGradientEndColor:"",topMargin:0,bottomMargin:0,rightOffset:0,gridLinesMode:"both",horzGridProperties:(0,d.deepExtend)({},y),vertGridProperties:(0,d.deepExtend)({},y),crossHairProperties:(0,d.deepExtend)({},{color:"",style:0,transparency:0,width:0}),legendProperties:(0,d.deepExtend)({},{showStudyArguments:!1,showStudyTitles:!1,showStudyValues:!1,showSeriesTitle:!1,showSeriesOHLC:!1,showLegend:!1,showLastDayChange:!1,showBarChange:!0,showVolume:!1,showPriceSource:!1,showBackground:!0,backgroundTransparency:0,showLogo:!0}),axisProperties:(0,d.deepExtend)({},C),separatorColor:""},T={lineColor:"",textColor:"",fontSize:0,scaleSeriesOnly:!1,showSeriesLastValue:!1,seriesLastValueMode:a.PriceAxisLastValueMode.LastValueAccordingToScale,showSeriesPrevCloseValue:!1,showStudyLastValue:!1,showSymbolLabels:!1,showStudyPlotLabels:!1,showBidAskLabels:!1,showPrePostMarketPriceLabel:!0,showFundamentalLastValue:!1,showFundamentalNameLabel:!1,showPriceScaleCrosshairLabel:!0,showTimeScaleCrosshairLabel:!0},P={...T},M={visible:!1,futureOnly:!1,breaks:(0,d.deepExtend)({},{color:"",visible:!1,style:0,width:0})},x={style:0,minTick:"",
showPriceLine:!1,priceLineWidth:0,priceLineColor:"",baseLineColor:"",showPrevClosePriceLine:!1,showCountdown:!0,prevClosePriceLineWidth:0,sessionId:"regular",prevClosePriceLineColor:"",esdShowDividends:!1,esdShowSplits:!1,esdShowEarnings:!1,esdShowBreaks:!1,showContinuousContractSwitches:!1,showContinuousContractSwitchesBreaks:!1,showFuturesContractExpiration:!1,showLastNews:!1,dividendsAdjustment:!1,backAdjustment:!1,settlementAsClose:!0,statusViewStyle:(0,d.deepExtend)({},{fontSize:16,showExchange:!0,showInterval:!0,symbolTextSource:"description"}),priceAxisProperties:(0,d.deepExtend)({},C),bidAsk:(0,d.deepExtend)({},p),prePostMarket:(0,d.deepExtend)({},_.defaultPrePostMarketPreferences),volFootprintStyle:(0,d.deepExtend)({},S),tpoStyle:(0,d.deepExtend)({},v.tpoStylePreferencesDefault),volCandlesStyle:(0,d.deepExtend)({},r.candleStylePreferencesDefault),svpStyle:(0,d.deepExtend)({},f.svpStylePreferencesDefault),highLowAvgPrice:(0,d.deepExtend)({},{highLowPriceLinesVisible:!1,highLowPriceLabelsVisible:!1,averageClosePriceLabelVisible:!1,averageClosePriceLineVisible:!1,highLowPriceLinesColor:"",highLowPriceLinesWidth:0,averagePriceLineColor:"",averagePriceLineWidth:0}),candleStyle:(0,d.deepExtend)({},r.candleStylePreferencesDefault),hollowCandleStyle:(0,d.deepExtend)({},r.hollowCandlePreferencesStyleDefault),barStyle:(0,d.deepExtend)({},r.barStylePreferencesDefault),lineStyle:(0,d.deepExtend)({},r.lineStyleDefault),lineWithMarkersStyle:(0,d.deepExtend)({},r.lineStyleDefault),steplineStyle:(0,d.deepExtend)({},r.lineStyleDefault),areaStyle:(0,d.deepExtend)({},r.areaStylePreferencesDefault),hlcAreaStyle:(0,d.deepExtend)({},r.hlcAreaStylePreferencesDefault),baselineStyle:(0,d.deepExtend)({},r.baselineStylePreferencesDefault),hiloStyle:(0,d.deepExtend)({},r.hiloStylePreferencesDefault),haStyle:(0,d.deepExtend)({},r.haStylePreferencesDefault),renkoStyle:(0,d.deepExtend)({},r.renkoStylePreferencesDefault),pbStyle:(0,d.deepExtend)({},r.pbStylePreferencesDefault),kagiStyle:(0,d.deepExtend)({},r.kagiStylePreferencesDefault),pnfStyle:(0,d.deepExtend)({},r.pnfStylePreferencesDefault),rangeStyle:(0,d.deepExtend)({},r.rangeStylePreferencesDefault),columnStyle:(0,d.deepExtend)({},r.columnStylePreferencesDefault)},I={priceScaleSelectionStrategyName:"auto",timeScale:(0,d.deepExtend)({},{defaultRightOffset:0,defaultRightOffsetPercentage:5,usePercentageRightOffset:!1}),mainSeries:(0,d.deepExtend)({},x),sessions:(0,d.deepExtend)({},c.sessionsPreferencesDefault),paneProperties:(0,d.deepExtend)({},w),chartEventsSourceProperties:(0,d.deepExtend)({},M),tradingProperties:(0,d.deepExtend)({},o.tradingPreferencesDefault)},L={timezone:"",scalesProperties:(0,d.deepExtend)({},P),...I},A={scalesProperties:(0,d.deepExtend)({},T),...I};function k(e,t,i,o,r=!0){if(void 0===t[e])return b.logDebug(`We haven't had this property ${o}.${e} yet, please, remove it from whiteList`),null;if((0,s.isObject)(i[e])){const s=Object.keys(i[e]);let n="";return s.map((s=>({[s]:k(s,t[e],i[e],`${o}.${e}`,r)}))).reduce(((e,t)=>(n=Object.keys(t)[0],e[n]=t[n],e)),{})}
return r?t[e].value():t[e]}function E(e,t,i=L){var s;const o={timezone:"",priceScaleSelectionStrategyName:"auto",timeScale:{defaultRightOffset:e.timeScale().defaultRightOffset().value(),defaultRightOffsetPercentage:e.timeScale().defaultRightOffsetPercentage().value(),usePercentageRightOffset:e.timeScale().usePercentageRightOffset().value()},mainSeries:{},sessions:{},paneProperties:{},scalesProperties:{},chartEventsSourceProperties:{},tradingProperties:{}},r=["timeScale","mainSeries","sessions"],n=i.mainSeries,a=Object.keys(i),l=Object.keys(n),c=t.properties(),d=e.properties(),h=i.sessions,u=Object.keys(h);l.forEach((e=>{o.mainSeries[e]=k(e,c,n,"mainSeries")}));const p=null===(s=e.sessions().state())||void 0===s?void 0:s.properties;return p&&u.forEach((e=>{o.sessions[e]=k(e,p,h,"sessions",!1)})),a.forEach((e=>{r.includes(e)||(o[e]=k(e,d,i,"preferences"))})),o}function D(e,t,i=A,s=!0){const o={timeScale:{defaultRightOffset:e.timeScale().rightOffsetDefaultValue(),defaultRightOffsetPercentage:e.timeScale().defaultRightOffsetPercentage().value(),usePercentageRightOffset:e.timeScale().usePercentageRightOffset().value()},mainSeries:{},sessions:(0,d.deepExtend)({},c.sessionsPreferencesDefault),paneProperties:{},scalesProperties:{},chartEventsSourceProperties:{},tradingProperties:{},priceScaleSelectionStrategyName:"auto"},r=["timeScale","mainSeries","sessions"],n=i.mainSeries,a=Object.keys(i),h=Object.keys(n),u=(0,l.factoryDefaults)("chartproperties.mainSeriesProperties"),p=(0,l.factoryDefaults)("chartproperties");return h.forEach((e=>{s&&"style"===e||(o.mainSeries[e]=k(e,u,n,"mainSeries",!1))})),a.forEach((e=>{r.includes(e)||(o[e]=k(e,p,i,"preferences",!1))})),o}},883188:(e,t,i)=>{"use strict";i.d(t,{actualAutoLogButtonsVisibility:()=>a,autoLogButtonsVisibilityOptions:()=>r,autoLogButtonsVisibilityProperty:()=>o,restoreAutoLogButtonsVisibilitySettingsValue:()=>n});var s=i(154241);const{property:o,availableValues:r,restoreDefaultValue:n,actualBehavior:a}=(0,s.createVisibilityController)("PriceAxisAutoLogButtons.visibility")},443874:(e,t,i)=>{"use strict";i.d(t,{BarsMarksContainer:()=>m});var s=i(650151),o=i(338619),r=i(62802),n=i.n(r),a=i(764829),l=i(378975),c=i(124829),d=i(975179),h=i(903424),u=i(169532);const p=(0,o.getLogger)("Chart.BarsMarksContainer"),_=Math.round(new Date(2037,0,1).getTime()/1e3);class m extends h.DataSource{constructor(e,t,i){const o=e.onWidget();let r;r=o?!e.hideIdeas():!!a.enabled("bars_marks")&&n().getBool("BarsMarksContainer.visibile",!1),t.merge({visible:r}),t.childs().visible.subscribe(null,(t=>{o||e.isSnapshot()||!a.enabled("bars_marks")||n().setValue("BarsMarksContainer.visibile",!!t.value())})),super(i),this._paneViews=[],this._model=e,this._properties=t,this._requests=[],this._marks={},this._loadedRange=null,this._getDataTimeout=null,this._collectedRange=null,this._lastRange=null;const l=this._model.mainSeries();l.onSymbolIntervalChanged().subscribe(this,this.clearMarks),l.dataEvents().symbolResolved().subscribe(this,this.clearMarks),l.dataEvents().completed().subscribe(this,(()=>{var e,t
;const i=l.data();if(0===i.size())return;const o=(0,s.ensureNotNull)(i.first()).index,r=(0,s.ensureNotNull)(i.last()).index,n=this.timeScale();this.getData({start:null!==(e=n.indexToTimePoint(o))&&void 0!==e?e:1/0,end:null!==(t=n.indexToTimePoint(r))&&void 0!==t?t:-1/0})})),this._initialize(),this._pinnedTooltips={}}destroy(){const e=this._model.mainSeries();e.onSymbolIntervalChanged().unsubscribeAll(this),e.dataEvents().symbolResolved().unsubscribeAll(this),e.dataEvents().completed().unsubscribeAll(this),super.destroy()}properties(){return this._properties}marks(){return this._marks}pinTooltip(e,t){this._pinnedTooltips[e]=t}timeScale(){return this._model.timeScale()}getIntervalInTicks(){const e=this._model.mainSeries().properties().childs().interval.value(),t=l.Interval.parse(e);if(!t.isValid())throw new TypeError("Unexpected interval");return t.isRange()?60:t.inMilliseconds()/1e3}getVisibleTickMarksRange(){var e,t;if(this.timeScale().isEmpty())return{start:0,end:0};const i=(0,s.ensureNotNull)(this.timeScale().visibleBarsStrictRange()),{firstIndex:o,lastIndex:r}=(0,s.ensureNotNull)(this.timeScale().points().range().value());if(!(i.lastBar()>o&&i.firstBar()<r))return{start:0,end:0};let n;n=i.lastBar()<r?this.timeScale().indexToTimePoint(i.lastBar()):_;const a={start:this.timeScale().indexToTimePoint(Math.max(i.firstBar(),o)),end:n};return{start:null!==(e=a.start)&&void 0!==e?e:1/0,end:null!==(t=a.end)&&void 0!==t?t:-1/0}}getVisibleRangePlates(){const e=[],t=this.getVisibleTickMarksRange(),i=this.getIntervalInTicks();return Object.keys(this._marks).forEach((s=>{var o,r;const n=this._marks[s],a=n.tickmark;a>=(null!==(o=t.start)&&void 0!==o?o:1/0)&&a<=(null!==(r=t.end)&&void 0!==r?r:-1/0)+i&&e.push(n)})),e}getPublishedPlates(){const e={};return window.is_authenticated?(this.getVisibleRangePlates().forEach((t=>{t.is_public&&(this._pinnedTooltips[t.id]||t.user__id===window.user.id)&&(e[t.id]=t)})),e):e}filterDisplayedPlates(e){const t=e.reduce(((e,t)=>{const i=this._getIndex(t.tickmark);return null!==i&&(e[i]=e[i]||[],e[i].push(t)),e}),{});return Object.keys(t).reduce(((e,i)=>{let s=t[i];return s=s.sort(((e,t)=>t.views_count-e.views_count)),s=s.slice(0,10),e.concat(s)}),[])}getPlatesViewData(){var e,t,i;const o=this._model.mainSeries();if(o.data().isEmpty())return[];const r=(0,d.isPriceSourceStyle)(o.style())?o.barFunction():null,n=this.filterDisplayedPlates(this.getVisibleRangePlates()),a={},l=null!==(e=this._model.lastHittestData())&&void 0!==e?e:this._model.lastSelectedHittestData();let c=null;null!==l&&this._model.hoveredSource()===this&&(c=null!==(t=l.activeItem)&&void 0!==t?t:null);const h=[];for(const e of n){const t=(0,s.ensureNotNull)(this._getIndex(e.tickmark)),i=this._getBar(t);if(null===i)continue;const o=this._layout(e.direction),n=this._theme(e.direction),l=c===e.id,d=this.timeScale().indexToCoordinate(t),u=this._offset(o,i,r),p=(0,s.ensureNotNull)(this.priceScale()).isInverted();let _=0;t in a||(a[t]={up:0,down:0}),_=a[t][o]++,h.push({id:e.id,x:d,y:u,yInverted:p,order:_,direction:o,theme:n,hovered:l,
pinned:!0===this._pinnedTooltips[e.id],user__id:e.user__id,label:e.label,labelFontColor:e.labelFontColor||"#444",minSize:e.minSize||5,...this._plateViewData(e)})}const u=h.filter((e=>!0===e.hovered));for(let e=0;e<n.length;e++)n[e].user__id===(null===(i=u[0])||void 0===i?void 0:i.user__id)&&(n[e].highlightByAuthor=!0);return h.sort(((e,t)=>e.hovered&&!t.hovered?1:0)),h}priceAxisViews(){return null}updateAllViews(e){for(const t of this._paneViews)t.update(e)}updateAllViewsAndRepaint(){this.updateAllViews((0,u.sourceChangeEvent)(this.id())),this._model.updateSource(this)}roundRange(e){return{start:Math.round(e.start),end:Math.round(e.end)}}refreshData(){null!==this._lastRange&&this.getData(this._lastRange)}getData(e){(0,c.isNumber)(e.start)&&(0,c.isNumber)(e.end)?(this._lastRange=e,e.end=_,this._pushGetDataStack(Object.assign({},e))):p.logError("Wrong range")}clearMarks(){this._abortAllRequests(),this._marks={},this._loadedRange=null}isUserDeletable(){return!1}isSavedInChart(e){return!1}isSpeciallyZOrderedSource(){return!0}showInObjectTree(){return!1}_plateViewData(e){return{}}_layout(e){switch(e){default:case 0:case 2:case 3:case 4:case 5:case 6:return"up";case 1:return"down"}}_theme(e){switch(e){default:case 0:return"neutral";case 1:case 5:return"green";case 2:case 6:return"red";case 3:return"yellow";case 4:return"blue"}}_offset(e,t,i){let o;switch(e){default:case"up":o=null===i?t[2]:i(t);break;case"down":o=null===i?t[3]:i(t)}return(0,s.ensureNotNull)(this.priceScale()).priceToCoordinate(o,(0,s.ensureNotNull)((0,s.ensureNotNull)(this.ownerSource()).firstValue()))}_getIndex(e){return this.timeScale().timePointToIndex(e)}_getBar(e){return this._model.mainSeries().data().valueAt(e)}_rangeDifference(e){return e=Object.assign({start:1/0,end:-1/0},e),this._loadedRange&&(e.start<this._loadedRange.start?e.end=this._loadedRange.start:e.end>this._loadedRange.end&&(e.start=this._loadedRange.end)),e}_rangeUnion(e,t){return e=Object.assign({start:1/0,end:-1/0},e),t&&(e.start=Math.min(t.start,e.start),e.end=Math.max(t.end,e.end)),e}_pushGetDataStack(e){(0,c.isNumber)(e.start)&&(0,c.isNumber)(e.end)?(this._getDataTimeout&&clearTimeout(this._getDataTimeout),this._collectedRange=this._rangeUnion(e,this._collectedRange),this._getDataTimeout=setTimeout((()=>{this._getData(this._collectedRange),this._getDataTimeout=this._collectedRange=null}),300)):p.logError("Wrong tickmark range")}_abortAllRequests(){this._requests.forEach((e=>{e.cancel()})),this._requests=[],this._getDataTimeout&&clearTimeout(this._getDataTimeout),this._getDataTimeout=this._collectedRange=null}}},331218:(e,t,i)=>{"use strict";i.d(t,{BarsRange:()=>o});var s=i(650151);class o{constructor(e,t){(0,s.assert)(e<=t,"The last bar in the bars range should be greater than or equal to the first bar"),this._firstBar=e,this._lastBar=t}firstBar(){return this._firstBar}lastBar(){return this._lastBar}count(){return this._lastBar-this._firstBar+1}contains(e){return this._firstBar<=e&&e<=this._lastBar}unite(e){
return null===e?this:new o(Math.min(this._firstBar,e.firstBar()),Math.max(this._lastBar,e.lastBar()))}equals(e){return this._firstBar===e.firstBar()&&this._lastBar===e.lastBar()}static compare(e,t){return null===e||null===t?e===t:e.equals(t)}}},508918:(e,t,i)=>{"use strict";var s;i.d(t,{ChartEventsSourceId:()=>s}),function(e){e.Value="ChartEventsSource"}(s||(s={}))},647042:(e,t,i)=>{"use strict";i.d(t,{ChartModelBase:()=>ro});var s=i(12481),o=i(343370),r=i(822914),n=i(650151),a=i(86441),l=i(724377),c=i(960095),d=i(444372),h=i(331633),u=i(429874),p=i(345848),_=i(955273),m=i(251954),g=i(49437),S=i(120984),v=i(779732),f=i(803279),b=i(828473),y=i(938614),C=i(465836);function w(e){return(0,C.isLineTool)(e)&&e.boundToSymbol()||(0,y.isAlertLabel)(e)}class T{constructor(){this._items=[],this._set=new Set,this._dataSourcesCache=null,this._customSourcesCache=null,this._lineSourcesCache=null}isEmpty(){return 0===this._items.length}add(e){if(this._items.length>0&&!w(this._items[0])&&this.clear(),w(e)){const t=(0,b.lowerbound)(this._items,e,((e,t)=>e.zorder()<t.zorder()));this._items.splice(t,0,e)}else this.clear(),this._items=[e];this._set.add(e),this._invalidateCache()}canBeAddedToSelection(e){return 0===this._items.length||w(this._items[0])&&w(e)}isSelected(e){return this._set.has(e)}allSources(){return this._items.slice(0)}dataSources(){return null===this._dataSourcesCache&&(this._dataSourcesCache=this._items.filter(f.isDataSource)),this._dataSourcesCache}lineDataSources(){return null===this._lineSourcesCache&&(this._lineSourcesCache=this._items.filter(C.isLineTool)),this._lineSourcesCache}customSources(){return null===this._customSourcesCache&&(this._customSourcesCache=this._items.filter((e=>!(0,f.isDataSource)(e)))),this._customSourcesCache}checkLineToolSelection(){this._items.forEach((e=>(0,C.isLineTool)(e)&&e.calcIsActualSymbol())),this._items=this._items.filter((e=>!(0,C.isLineTool)(e)||e.isActualSymbol())),this._invalidateCache()}remove(e){this._items=this._items.filter((t=>t!==e)),this._set.delete(e),this._invalidateCache()}clear(){this._items=[],this._set.clear(),this._invalidateCache()}_invalidateCache(){this._customSourcesCache=null,this._dataSourcesCache=null,this._lineSourcesCache=null}}var P=i(218049),M=i(872842),x=i(971899),I=i(378975),L=i(868594),A=i(658843),k=i(970427),E=i(694852),D=i(511275);class B{constructor(e){this._rendererOptions={borderSize:1,additionalPaddingInner:0,fontSize:NaN,font:"",color:"",paneBackgroundColor:"",paddingBottom:0,paddingInner:0,paddingOuter:0,paddingTop:0,lineSpacing:0},this._chartModel=e}options(){const e=this._rendererOptions,t=this._chartModel.properties().childs(),i=t.scalesProperties.childs().fontSize.value();return e.fontSize!==i&&(e.fontSize=i,e.font=(0,E.makeFont)(i,D.CHART_FONT_FAMILY,""),e.paddingTop=i/12*2.5,e.paddingBottom=i/12*2.5,e.paddingInner=i/12*4,e.additionalPaddingInner=i/12*4,e.paddingOuter=i/12*4,e.lineSpacing=i/12*2),e.color=t.scalesProperties.childs().textColor.value(),e.paneBackgroundColor=t.paneProperties.childs().background.value(),this._rendererOptions}
}var N=i(850723);class R extends S.AsyncResourceWrapper{constructor(e){super(e,(e=>e.destroy())),this._sessionsState=null,e.then((()=>{if(!this._destroyed&&this._sessionsState){const{state:e,includeData:t}=this._sessionsState;this.restoreState(e,t),this._sessionsState=null}}))}state(e){var t,i,s,o;return null!==(o=null!==(i=null===(t=this.get())||void 0===t?void 0:t.state(e))&&void 0!==i?i:null===(s=this._sessionsState)||void 0===s?void 0:s.state)&&void 0!==o?o:null}restoreState(e,t){const i=this.get();i?(e&&i.restoreState(e,t),this._sessionsState=null):this._sessionsState=e?{state:e,includeData:t}:null}}var O=i(434396),V=i(942634),W=i(375397),F=i(566238),H=i(219849),z=i(546821),U=i(883188),G=i(895171),q=i(62802);const j="symbolWatermark",K={visibility:!1,color:"rgba(80, 83, 94, 0.25)"};function Z(){const e=q.getJSON(j);return Object.assign({},K,e)}const Y=(0,G.default)((()=>{const e=new A.Property(Z());return q.onSync.subscribe(null,(()=>e.mergeAndFire(Z()))),e.subscribe(null,(()=>q.setJSON(j,e.state()))),e}));var $=i(211183),X=i(903424),J=i(257288),Q=i(151848),ee=i(367637),te=i(5486);class ie extends ee.MediaCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null,this._widthCache=new te.TextWidthCache}setData(e){this._data=e}hitTest(e){return null}_drawImpl(e){if(!this._data)return;const{lines:t,color:i}=this._data,{context:s,mediaSize:{width:o,height:r}}=e;s.fillStyle=i;let n=0;const a=[];for(const e of t){if(!e.text)continue;s.font=e.font;const t=this._widthCache.measureText(s,e.text),i=t>o?o/t:1;a.push(i),n+=e.lineHeight*i}let l=Math.max((r-n)/2,0),c=-1;for(const e of t){if(!e.text)continue;c+=1;const t=a[c];s.save(),s.translate(o/2,l),s.textBaseline="top",s.textAlign="center",s.font=e.font,s.scale(t,t),s.fillText(e.text,0,e.vertOffset),s.restore(),l+=e.lineHeight*t}}}class se{constructor(e,t){this._renderer=new ie,this._invalidated=!0,this._model=e,this._watermark=t}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){const e=this._watermark.properties().childs(),t=this._model.mainSeries(),i=t.symbolInfo();if(!i||!e.visibility.value())return void this._renderer.setData(null);let s=i.name;if(/QUANDL/.test(i.exchange)){const e=s.split(/\//);e.length&&(s=e[e.length-1])}const o={description:i.description,short_description:i.short_description,pro_name:i.pro_name,short_name:i.name,local_description:i.local_description,language:i.language},r=[{text:s?`${s}, ${(0,Q.translatedIntervalString)(t.interval())}`:"",font:(0,E.makeFont)(96,D.CHART_FONT_FAMILY),lineHeight:117,vertOffset:0},{text:(0,J.getTranslatedSymbolDescription)(o)||"",font:(0,E.makeFont)(48,D.CHART_FONT_FAMILY),lineHeight:58,vertOffset:5}];this._renderer.setData({color:e.color.value(),lines:r})}}const oe="symbolWatermark";class re extends X.DataSource{constructor(e){super(),this._properties=Y(),(0,$.applyDefaultsOverrides)(this._properties,void 0,!1,oe),this._properties.subscribe(this,(()=>e.updateSource(this))),this._paneView=new se(e,this)}destroy(){
this._properties.unsubscribeAll(this),super.destroy()}name(){return"watermark"}properties(){return this._properties}restorePropertiesDefaults(){Y().mergeAndFire(K)}applyOverrides(e){(0,$.applyPropertiesOverrides)(this._properties,void 0,!1,e,oe)}paneViews(){return[this._paneView]}updateAllViews(e){super.updateAllViews(e),this._paneView.update()}}var ne=i(764829),ae=i(338619),le=i(79342),ce=i(79200),de=i(128011),he=i(637761),ue=i(124829),pe=i(949665),_e=i(645468),me=i(283323),ge=i(862954),Se=i(354957),ve=i(322825),fe=i(475892),be=i(343272);function ye(e,t,i){return i.hasDataSource(t)?Te(t,i)===e:!!i.isMainPane()&&Te(i.model().mainSeries(),i)===e}const Ce=new Map([["price",e=>(0,fe.isPriceDataSource)(e)],["trading",e=>(0,C.isTrading)(e)],["drawing",e=>(0,C.isLineTool)(e)&&!(0,C.isTrading)(e)&&!e.isPhantom()],["drawingsForAllSymbols",e=>(0,C.isLineTool)(e)&&!(0,C.isTrading)(e)&&!e.isPhantom()],["phantom",e=>(0,C.isLineTool)(e)&&e.isPhantom()],["restRowSources",e=>!(0,C.isLineTool)(e)&&!(0,C.isTrading)(e)],["legendViewSources",(e,t)=>t.hasDataSource(e)&&((0,fe.isPriceDataSource)(e)||(0,C.isStudyLineTool)(e))],["leftPriceScale",ye.bind(null,"left")],["rightPriceScale",ye.bind(null,"right")],["overlayPriceScale",ye.bind(null,"overlay")],["multipane",(e,t)=>!t.hasDataSource(e)],["allWithoutMultipane",(e,t)=>t.hasDataSource(e)]]),we=new Map([["price","visibleSorted"],["trading","visibleSorted"],["drawing","visibleSorted"],["drawingsForAllSymbols","allSorted"],["phantom","visibleSorted"],["restRowSources","visibleSorted"],["legendViewSources","visibleSorted"],["leftPriceScale","visibleSorted"],["rightPriceScale","visibleSorted"],["overlayPriceScale","visibleSorted"],["multipane","visibleSorted"],["allWithoutMultipane","visibleSorted"]]);function Te(e,t){const i=e.priceScale();return null===i?"overlay":t.priceScalePosition(i)}class Pe{constructor(e){this._groupedSources=new Map,this._sources=null,this._pane=e}clear(){this._groupedSources.clear(),this._sources=null}destroy(){this.clear()}all(){return this._groupedSources.has("visibleSorted")||this._sortSources(),(0,n.ensureDefined)(this._groupedSources.get("visibleSorted"))}allIncludingHidden(){return this._groupedSources.has("allSorted")||this._sortSources(),(0,n.ensureDefined)(this._groupedSources.get("allSorted"))}allWithoutMultipane(){return this._getSourcesByGroupType("allWithoutMultipane")}allExceptSpecialSources(){if(!this._groupedSources.has("exceptSpecial")){const e=this.allIncludingHidden().filter((e=>!e.isSpeciallyZOrderedSource()));this._groupedSources.set("exceptSpecial",e)}return(0,n.ensureDefined)(this._groupedSources.get("exceptSpecial"))}tradingSources(){return this._getSourcesByGroupType("trading")}priceSources(){return this._getSourcesByGroupType("price")}lineSources(){return this._getSourcesByGroupType("drawing")}lineSourcesForAllSymbols(){return this._getSourcesByGroupType("drawingsForAllSymbols")}phantomSources(){return this._getSourcesByGroupType("phantom")}allExceptLineAndTradingSources(){return this._getSourcesByGroupType("restRowSources")}
hitTestSources(){if(!this._groupedSources.has("hitTest")){const e=this.allExceptLineAndTradingSources().concat(this.lineSources());this._groupedSources.set("hitTest",(0,be.sortSources)(e,this._pane))}return(0,n.ensureDefined)(this._groupedSources.get("hitTest"))}generalSources(){if(!this._groupedSources.has("general")){const e=this.allExceptLineAndTradingSources().concat(this.lineSources());this._groupedSources.set("general",(0,be.sortSources)(e,this._pane))}return(0,n.ensureDefined)(this._groupedSources.get("general"))}leftPriceScalesSources(){return this._getSourcesByGroupType("leftPriceScale")}rightPriceScalesSources(){return this._getSourcesByGroupType("rightPriceScale")}overlayPriceScaleSources(){return this._getSourcesByGroupType("overlayPriceScale")}multipaneSources(){return this._getSourcesByGroupType("multipane")}legendViewSources(){return this._getSourcesByGroupType("legendViewSources")}_getSourcesByGroupType(e){const t=(0,n.ensureDefined)(we.get(e));return this._groupedSources.has(t)?this._groupedSources.has(e)||this._groupSources(e):(this._sortSources(),this._groupSources(e)),(0,n.ensureDefined)(this._groupedSources.get(e))}_sortSources(){null===this._sources&&(this._sources=this._pane.dataSources());const e=this._pane.model().multiPaneSources(this._pane),t=(0,be.sortSources)(this._sources.concat(e),this._pane),i=t.filter((e=>!(0,C.isLineTool)(e)||e.isActualSymbol()&&e.isActualCurrency()&&e.isActualUnit()));this._groupedSources.set("allSorted",t),this._groupedSources.set("visibleSorted",i)}_groupSources(e){const t=(0,n.ensureDefined)(we.get(e)),i=Ce.get(e);if(void 0!==i){const s=(0,n.ensureDefined)(this._groupedSources.get(t)).filter((e=>i(e,this._pane)));this._groupedSources.set(e,s)}}}var Me=i(627620),xe=i(704670),Ie=i(613438),Le=i(526910),Ae=i(487945),ke=i(975179),Ee=i(674720),De=i(960521),Be=i(750139);function Ne(e,t,i){const s=e.div(t).toNumber();return Math.abs(Math.round(s)-s)<i}const Re=[2,5],Oe=[5,2];class Ve{constructor(e,t,i){if(this._base=e,this._integralDividers=t,(0,Be.isBaseDecimal)(e))this._fractionalDividers=[2,2.5,2];else{this._fractionalDividers=[];const e=i?Re:Oe;for(let t=this._base;1!==t;){if(t%e[0]==0)this._fractionalDividers.push(e[0]),t/=e[0];else{if(t%e[1]!=0)throw new Error("unexpected base");this._fractionalDividers.push(e[1]),t/=e[1]}if(this._fractionalDividers.length>100)throw new Error("something wrong with base")}}}tickSpan(e,t,i){const s=0===this._base?0:1/this._base,o=Math.min(1e-14,(e-t)/1e3);let r=Math.pow(10,Math.max(0,Math.ceil((0,Be.log10)(e-t))));if(!isFinite(r))return 1e305;let n=0,a=this._integralDividers[0];for(;;){const e=(0,Be.greaterOrEqual)(r,s,o)&&r>s+o,t=(0,Be.greaterOrEqual)(r,i*a,o),l=(0,Be.greaterOrEqual)(r,1,o),c=new De.Big(r).div(a),d=0===s||Ne(c,s,o);if(!(e&&t&&l&&d))break;r=c.toNumber(),a=this._integralDividers[++n%this._integralDividers.length]}if(r<=s+o&&(r=s),r=Math.max(1,r),this._fractionalDividers.length>0&&(0,Be.equal)(r,1,o))for(n=0,a=this._fractionalDividers[0];;){const e=(0,
Be.greaterOrEqual)(r,i*a,o)&&r>s+o,t=new De.Big(r).div(a),l=0===s||Ne(t,s,o);if(!e||!l)break;r=t.toNumber(),a=this._fractionalDividers[++n%this._fractionalDividers.length]}return r}}class We{constructor(e,t,i,s){this._marks=null,this._priceScale=e,this._base=t,this._coordinateToLogicalFunc=i,this._logicalToCoordinateFunc=s}base(){return this._base}setBase(e){if(e<0)throw new Error("base < 0");this._base=e}tickSpan(e,t,i=0){if(e<t)throw new Error("high < low");const s=this._priceScale.height(),o=this._tickMarkHeight(),r=(e-t)*o/s,n=[new Ve(this._base,[2,2.5,2],!0),new Ve(this._base,[2,2,2.5],!0),new Ve(this._base,[2.5,2,2],!0),new Ve(this._base,[2,2.5,2],!1),new Ve(this._base,[2,2,2.5],!1),new Ve(this._base,[2.5,2,2],!1)].reduce(((s,o)=>{const n=o.tickSpan(e,t,r);return n>i?Math.min(n,s):s}),1/0);return n>0&&isFinite(n)?n:e-t}rebuildTickMarks(){this._marks=null}marks(){return null===this._marks&&(this._marks=this._rebuildTickMarksImpl()),this._marks}_fontHeight(){return this._priceScale.fontSize()}_tickMarkHeight(){return Math.ceil(2.5*this._fontHeight())}_rebuildTickMarksImpl(){const e=this._priceScale,t=[],i=e.mainSource();if(e.isEmpty()||!e.hasCalculatedPriceRange()||null===i)return t;let s=i.firstValue();null===s&&(s=0);const o=e.height(),r=this._coordinateToLogicalFunc(o-1,s),n=this._coordinateToLogicalFunc(0,s),a=Math.max(r,n),l=Math.min(r,n);if(a===l)return t;let c=this.tickSpan(a,l),d=a%c;d+=d<0?c:0;const h=a>=l?1:-1;let u=null;const p=e.formatter();let _=NaN;for(let i=a-d;i>l;i-=c){i===_&&(c=this.tickSpan(a,l,c)),_=i;const o=this._logicalToCoordinateFunc(i,s);null!==u&&Math.abs(o-u)<this._tickMarkHeight()||(t.push({coord:o,label:p.format(i)}),u=o,e.isLog()&&(c=this.tickSpan(i*h,l)))}return t}}var Fe=i(419283),He=i(735211),ze=i(627183);ne.enabled("hide_price_scale_if_all_sources_hidden");const Ue=(0,ze.getPercentageFormatter)(),Ge=new He.PriceFormatter({priceScale:100,minMove:1}),qe={autoScale:!0,autoScaleDisabled:!1,lockScale:!1,percentage:!1,percentageDisabled:!1,log:!1,logDisabled:!1,alignLabels:!0,isInverted:!1,indexedTo100:!1};class je{constructor(e,t){this._marksCache=null,this._onMarksChanged=new V.Delegate,this.m_dataSources=[],this._sourcesForAutoscale=null,this._sourcesThatAffectVisibility=[],this._hasSeries=!1,this._studiesCount=0,this._drawingCount=0,this._seriesLikeSources=[],this._priceDataSources=[],this._mainSource=null,this._lastSourceRemoved=new V.Delegate,this._scaleSeriesOnly=!1,this._invalidatedForRange={isValid:!0,visibleBars:null},this._priceRange=null,this._hasCalculatedPriceRange=!1,this._logFormula=(0,Ie.logFormulaForBase)(null),this.m_height=0,this._margins={top:0,bottom:0},this._correctedMarginsCache=null,this._topPixelMargin=0,this._bottomPixelMargin=0,this._internalHeightCache=null,this._internalHeightChanged=new V.Delegate,this._priceRangeSnapshot=null,this._scrollStartPoint=null,this._currencyCache=null,this._unitCache=null,this._measureUnitIdCache=null,this._recalculatePriceRangeOnce=!1,this._cachedOrderedSoruces=null,this._scaleStartPoint=null,
this._twoPointsScaleStartPosition=null,this._maxPriceRange=null,this._minPriceRange=null,this._priceRangeChanged=new V.Delegate,this._modeChanged=new V.Delegate,this._sourcesToUpdateViews=null,this._markBuilder=new We(this,100,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._formatter=null,this._resetScaleAvailable=new W.WatchedValue(!1),this._id="",this._isVisible=new W.WatchedValue(!0),t=Object.assign({},qe,t),this._properties=new A.Property(t),this._boundOnSourceIsActingAsSymbolSourceChanged=this._onSourceIsActingAsSymbolSourceChanged.bind(this),this._scalesProperties=e,this._properties.childs().isInverted.subscribe(this,this._onIsInvertedChanged),this._properties.subscribe(null,(()=>{const e=this.mainSource();if(e&&e.model()){const t=e.model().paneForSource(e);t&&e.model().updatePane(t)}})),this._scalesProperties.subscribe(this,(()=>{this._marksCache=null})),this._properties.childs().lockScale.subscribe(this,this._updateResetAvailableValue),this._properties.childs().autoScale.subscribe(this,this._updateResetAvailableValue),this._updateResetAvailableValue(),this.setId((0,le.randomHash)())}id(){return this._id}setId(e){this._id=e}isLog(){return this._properties.childs().log.value()}isPercentage(){return this._properties.childs().percentage.value()}isInverted(){return this._properties.childs().isInverted.value()}isIndexedTo100(){return this._properties.childs().indexedTo100.value()}isAutoScale(){return this._properties.childs().autoScale.value()&&!this.isLockScale()}isLockScale(){return this._properties.childs().lockScale.value()}isRegular(){return!this.isPercentage()&&!this.isLog()&&!this.isIndexedTo100()}isScaleSeriesOnly(){return this._scaleSeriesOnly}properties(){return this._properties}height(){return this.m_height}setHeight(e){this.m_height!==e&&(this.m_height=e,this._invalidateInternalHeightCache(),this._marksCache=null)}internalHeight(){if(this._internalHeightCache)return this._internalHeightCache;const e=this.height()-this.topPixelMargin()-this.bottomPixelMargin();return this._internalHeightCache=e,e}fontSize(){return this._scalesProperties.childs().fontSize.value()}priceRange(){return this._makeSureItIsValid(),this._priceRange}setPriceRange(e,t,i){if(!(e instanceof xe.PriceRange))throw new TypeError("incorrect price range");const s=this._priceRange;if(!t&&xe.PriceRange.compare(s,e))return;const o=null!==this._maxPriceRange&&this._maxPriceRange.containsStrictly(e),r=null!==this._minPriceRange&&e.containsStrictly(this._minPriceRange);this.isLockScale()&&!t&&(o||r)||(this._marksCache=null,this._priceRange=e,i||this._priceRangeChanged.fire(s,e))}setMinPriceRange(e){this._minPriceRange=e}setMaxPriceRange(e){this._maxPriceRange=e}recalculatePriceRangeOnce(){this._recalculatePriceRangeOnce=!0}priceRangeShouldBeRecalculatedOnce(){if(!this._recalculatePriceRangeOnce||this.isLockScale())return!1;const e=this.mainSource();return null!==e&&e.priceRangeReady()}priceRangeChanged(){return this._priceRangeChanged}mode(){const e=this._properties.childs();return{autoScale:e.autoScale.value(),
lockScale:e.lockScale.value(),percentage:e.percentage.value(),indexedTo100:e.indexedTo100.value(),log:e.log.value()}}setMode(e){const t={},i=this.mode(),s=this._properties.state();let o=null;void 0!==e.autoScale&&e.autoScale!==s.autoScale&&(t.autoScale=e.autoScale,this._setAutoScaleValueWithDependentProperties(e.autoScale)),void 0!==e.lockScale&&e.lockScale!==s.lockScale&&(t.lockScale=e.lockScale,this._setLockScaleValueWithDependentProperties(e.lockScale)),void 0!==e.percentage&&e.percentage!==s.percentage&&(t.percentage=e.percentage,this._setPercentageValueWithDependentProperties(e.percentage),this._invalidatedForRange.isValid=!1),void 0!==e.indexedTo100&&e.indexedTo100!==s.indexedTo100&&(t.indexedTo100=e.indexedTo100,this._setIndexedTo100ValueWithDependentProperties(e.indexedTo100),this._invalidatedForRange.isValid=!1),void 0!==e.log&&e.log!==s.log&&(t.log=e.log,this._setLogValueWithDependentProperties(e.log));const r=this._properties.childs();s.log&&!r.log.value()&&(this._canConvertPriceRangeFromLog(this._priceRange)?(o=this._convertPriceRangeFromLog(this._priceRange),null!==o&&this.setPriceRange(o)):r.autoScale.setValue(!0)),!s.log&&r.log.value()&&(o=this._convertPriceRangeToLog(this._priceRange),null!==o&&this.setPriceRange(o)),s.autoScale!==r.autoScale.value()&&r.autoScale.listeners().fire(r.autoScale,""),s.autoScaleDisabled!==r.autoScaleDisabled.value()&&r.autoScaleDisabled.listeners().fire(r.autoScaleDisabled,""),s.lockScale!==r.lockScale.value()&&r.lockScale.listeners().fire(r.lockScale,""),s.percentage!==r.percentage.value()&&(r.percentage.listeners().fire(r.percentage,""),this.updateFormatter()),s.indexedTo100!==r.indexedTo100.value()&&(r.indexedTo100.listeners().fire(r.indexedTo100,""),this.updateFormatter()),s.percentageDisabled!==r.percentageDisabled.value()&&r.percentageDisabled.listeners().fire(r.percentageDisabled,""),s.log!==r.log.value()&&r.log.listeners().fire(r.log,""),s.logDisabled!==r.logDisabled.value()&&r.logDisabled.listeners().fire(r.logDisabled,""),void 0===t.log&&void 0===t.percentage&&void 0===t.lockScale&&void 0===t.autoScale&&void 0===t.indexedTo100||this._modeChanged.fire(i,this.mode())}modeChanged(){return this._modeChanged}isEmpty(){return this._makeSureItIsValid(),0===this.m_height||!this._priceRange||this._priceRange.isEmpty()}hasCalculatedPriceRange(){return this._hasCalculatedPriceRange}canDetachSource(e){return this.m_dataSources.some((t=>t!==e&&!(0,ge.isLollipopDataSource)(t)&&(0,fe.isPriceDataSource)(t)&&!((0,O.isStudy)(t)&&t.isLinkedToSeries())))}updateAllViews(e){const t=this._getSourcesToUpdateViews();for(const i of t)i.updateAllViews(e)}logFormula(){return this._logFormula}state(){var e;const t=this._properties.childs();return{id:this._id,m_priceRange:this.isAutoScale()?null:(null===(e=this.priceRange())||void 0===e?void 0:e.serialize())||null,m_isAutoScale:this.isAutoScale(),m_isPercentage:t.percentage.value(),m_isIndexedTo100:t.indexedTo100.value(),m_isLog:t.log.value(),m_isLockScale:this.isLockScale(),m_isInverted:this.isInverted(),m_topMargin:this._margins.top,
m_bottomMargin:this._margins.bottom,alignLabels:t.alignLabels.value(),logFormula:(0,ue.clone)(this._logFormula),hasCalculatedPriceRange:this._hasCalculatedPriceRange}}restoreState(e){var t;let i=e.m_priceRange;if(void 0===i)throw new TypeError("invalid state");if(void 0===e.m_isAutoScale)throw new TypeError("invalid state");void 0!==e.id&&(this._id=e.id);const s={autoScale:e.m_isAutoScale};void 0!==e.m_isPercentage&&(s.percentage=e.m_isPercentage),void 0!==e.m_isIndexedTo100&&(s.indexedTo100=e.m_isIndexedTo100),void 0!==e.m_isLog&&(s.log=e.m_isLog),void 0!==e.m_isLockScale&&(s.lockScale=e.m_isLockScale),void 0!==e.m_isInverted&&this._properties.childs().isInverted.setValue(e.m_isInverted),this.setMode(s),this._hasCalculatedPriceRange=null!==(t=e.hasCalculatedPriceRange)&&void 0!==t?t:null!==i,i?(i instanceof xe.PriceRange||(i=new xe.PriceRange(i)),this.setPriceRange(i,!0)):this.clearPriceRange(),e.logFormula&&(this._logFormula=e.logFormula),void 0!==e.m_topMargin&&(this._margins.top=e.m_topMargin),void 0!==e.m_bottomMargin&&(this._margins.bottom=e.m_bottomMargin),void 0!==e.alignLabels&&this._properties.childs().alignLabels.setValue(e.alignLabels),this._mainSource=null,this._scaleSeriesOnly=!1}priceToLogical(e){return this.isLog()&&e?(0,Ie.toLog)(e,this._logFormula):e}logicalToPrice(e){return this.isLog()?(0,Ie.fromLog)(e,this._logFormula):e}priceToCoordinate(e,t){const i=this._priceToPercentOrIndexedTo100IfNeeded(e,t);return this._logicalToCoordinate(i)}coordinateToPrice(e,t){let i=this._coordinateToLogical(e);return this.isPercentage()?i=(0,Ie.fromPercent)(i,t):this.isIndexedTo100()&&(i=(0,Ie.fromIndexedTo100)(i,t)),i}mainSource(){if(null!==this._mainSource)return this._mainSource;let e;for(const t of this._priceDataSources){if(t instanceof Le.Series){e=t;break}e||(e=t)}return this._mainSource=e||null,this._correctedMarginsCache=null,this._mainSource}priceToCoordinateFn(e){this._makeSureItIsValid();const t=this.bottomPixelMargin(),i=(0,n.ensureNotNull)(this.priceRange()),s=i.minValue(),o=i.maxValue(),r=this.internalHeight()-1,a=this.isInverted(),l=r/(o-s),c=this.m_height,d=e=>{const i=t+l*(e-s);return a?i:c-1-i};return this.isPercentage()?t=>d((0,Ie.toPercent)(t,e)):this.isIndexedTo100()?t=>d((0,Ie.toIndexedTo100)(t,e)):this.isLog()?e=>d((0,Ie.toLog)(e,this._logFormula)):e=>d(e)}pricesArrayToCoordinates(e,t,i){this._makeSureItIsValid();const s=this.bottomPixelMargin(),o=(0,n.ensureNotNull)(this.priceRange()),r=o.minValue(),a=o.maxValue(),l=this.internalHeight()-1,c=this.isInverted(),d=l/(a-r);void 0===i&&(i=e.length);const h=this.isPercentage(),u=this.isIndexedTo100(),p=this.isLog(),_=this.m_height;let m,g;for(let o=0;o<i;o++)m=e[o],Number.isFinite(m)&&(h?m=(0,Ie.toPercent)(m,t):u?m=(0,Ie.toIndexedTo100)(m,t):p&&(m=(0,Ie.toLog)(m,this._logFormula)),g=s+d*(m-r),e[o]=c?g:_-1-g)}pointsArrayToCoordinates(e,t,i){var s,o;this._makeSureItIsValid();const r=(0,
n.ensureNotNull)(this.priceRange()),a=this.bottomPixelMargin(),l=r.minValue(),c=r.maxValue(),d=this.internalHeight()-1,h=this.isInverted(),u=d/(c-l),p=e,_=null!==(s=null==i?void 0:i.startItemIndex)&&void 0!==s?s:0,m=null!==(o=null==i?void 0:i.endItemIndex)&&void 0!==o?o:p.length;if(this.isPercentage())for(let e=_;e<m;e++)p[e].y=(0,Ie.toPercent)(p[e].y,t);if(this.isIndexedTo100())for(let e=_;e<m;e++)p[e].y=(0,Ie.toIndexedTo100)(p[e].y,t);if(this.isLog())for(let e=_;e<m;e++)p[e].y=this.priceToLogical(p[e].y);for(let e=_;e<m;e++){const t=p[e].y;if(isNaN(t)||null==t)continue;const i=a+u*(t-l),s=h?i:this.m_height-1-i;p[e].y=s}}barPricesToCoordinates(e,t){this._makeSureItIsValid();const i=(0,n.ensureNotNull)(this.priceRange()),s=e,o=this.bottomPixelMargin(),r=i.minValue(),a=i.maxValue(),l=this.internalHeight()-1;let c=null;if(this.isPercentage()?c=Ie.toPercent:this.isIndexedTo100()?c=Ie.toIndexedTo100:this.isLog()&&(c=(e,t)=>e?(0,Ie.toLog)(e,this._logFormula):e),0===s.length)return;const d="open"in s[0],h="close"in s[0];if(null!==c)for(let e=0;e<s.length;e++){if(!s[e])continue;const i=s[e];d&&(i.open=c(i.open,t)),i.high=c(i.high,t),i.low=c(i.low,t),h&&(i.close=c(i.close,t)),void 0!==i.additionalPrice&&(i.additionalPrice=c(i.additionalPrice,t))}const u=l/(a-r),p=this.isInverted();for(let e=0;e<s.length;e++){const t=s[e];if(!t)continue;if(d){const e=o+u*(t.open-r),i=p?e:this.m_height-1-e;t.open=i}const i=o+u*(t.high-r),n=p?i:this.m_height-1-i;t.high=n;const a=o+u*(t.low-r),l=p?a:this.m_height-1-a;if(t.low=l,h){const e=o+u*(t.close-r),i=p?e:this.m_height-1-e;t.close=i}if(void 0!==t.additionalPrice){const e=o+u*(t.additionalPrice-r);t.additionalPrice=p?e:this.m_height-1-e}}}formatter(){return null===this._formatter&&this.updateFormatter(),(0,n.ensureNotNull)(this._formatter)}updateFormatter(){this._marksCache=null;const e=this.mainSource();let t=100;e&&(t=e.base()),this._formatter=null,this.isPercentage()?(this._formatter=Ue,t=100):this.isIndexedTo100()?(this._formatter=Ge,t=100):this._formatter=e?e.formatter():Ge,this._markBuilder=new We(this,t,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._markBuilder.rebuildTickMarks()}formatPrice(e,t,i){return this.isPercentage()?this.formatPricePercentage(e,t,i):this.isIndexedTo100()?this.formatPriceIndexedTo100(e,t,i):this.formatter().format(e,i)}formatPriceAbsolute(e,t){return this._mainSourceFormatter().format(e,t)}formatPricePercentage(e,t,i){return e=(0,Ie.toPercent)(e,t),Ue.format(e,i)}formatPriceIndexedTo100(e,t,i){const s=(0,Ie.toIndexedTo100)(e,t);return this.formatter().format(s,i)}getFormattedValues(e,t,i,s){null!=s||(s=this.formatPriceAbsolute(e));const o=this.formatPricePercentage(e,t,{signPositive:i}),r=this.formatPriceIndexedTo100(e,t);return{formattedPriceAbsolute:s,formattedPricePercentage:o,formattedPriceIndexedTo100:r,text:(0,Ie.getCurrentModePriceText)(this,{formattedPriceAbsolute:s,formattedPricePercentage:o,formattedPriceIndexedTo100:r})}}resetScale(){this.setMode({autoScale:!0})}resetScaleAvailable(){
return this._resetScaleAvailable.readonly()}dataSources(){return this.m_dataSources}seriesLikeSources(){return this._seriesLikeSources}addDataSource(e,t){this._addDataSourceImpl(e,t)}removeDataSource(e){const t=this.m_dataSources.indexOf(e);if((0,n.assert)(-1!==t,"Source is not attached to scale"),this.m_dataSources.splice(t,1),(0,fe.isPriceDataSource)(e)){const t=this._priceDataSources.indexOf(e);if((0,n.assert)(-1!==t,"Source is not found"),this._priceDataSources.splice(t,1),(0,Ae.isSymbolSource)(e)){const t=this._seriesLikeSources.indexOf(e);(0,n.assert)(-1!==t,"Source is not found"),this._seriesLikeSources.splice(t,1),e.symbolResolved().unsubscribeAll(this),e.isActingAsSymbolSource().unsubscribe(this._boundOnSourceIsActingAsSymbolSourceChanged),e instanceof Le.Series&&(this._hasSeries=!1)}e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this)}this.mainSource()||this.setMode({autoScale:!0}),(0,O.isStudy)(e)&&(e.onIsActualIntervalChange().unsubscribe(this,this._dropScaleCache),e.onHibernationStateChange().unsubscribe(this,this._dropScaleCache),e.properties().childs().styles.listeners().unsubscribe(this,this._dropScaleCache),this._studiesCount--,0===this._studiesCount&&(0,Fe.hideAllIndicators)().unsubscribe(this,this._dropScaleCache)),(0,C.isLineTool)(e)&&(this._drawingCount--,0===this._drawingCount&&(0,Fe.hideAllDrawings)().unsubscribe(this,this._dropScaleCache));const i=this._sourcesThatAffectVisibility.indexOf(e);-1!==i&&(this._sourcesThatAffectVisibility.splice(i,1),e.properties().childs().visible.listeners().unsubscribe(this,this._onSourceVisibilityChanged)),e===this._mainSource&&(this._correctedMarginsCache=null,this._internalHeightCache=null,this._marksCache=null),this._mainSource=null,this._dropScaleCache(),this.updateFormatter(),this.invalidateSourcesCache(),this._updateIsVisible(),this._updateLogFormula(),0===this.m_dataSources.length&&this._lastSourceRemoved.fire()}replaceSource(e,t){const i=(0,fe.isPriceDataSource)(e)?this._priceDataSources.indexOf(e):void 0;return this._addDataSourceImpl(t,void 0,-1===i?void 0:i),this.removeDataSource(e),-1!==i}currency(e){if(null!==this._currencyCache&&e.size()===this._currencyCache.availableCurrenciesCount)return this._currencyCache.value;let t;const i=new Set,s=new Set,o=new Set,r=new Map,a=new Set;let l,c=0===this._seriesLikeSources.length,d=!0,h=0,u=0;const p=this._seriesLikeSources.filter(Ae.isActingAsSymbolSource);for(const u of p){if(!u.isVisible())continue;const p=u.symbolInfo();if(null===p){t=null;break}const _=(0,ke.symbolOriginalCurrency)(p);if(null===_){t=null;break}r.set(_,(0,n.ensureNotNull)((0,ke.symbolOriginalCurrency)(p,!0)));const m=u.currency();if(null===m){t=null;break}r.set(m,(0,n.ensureNotNull)((0,ke.symbolCurrency)(p,!0)));const g=(0,ke.symbolBaseCurrency)(p);null!==g&&s.add(g),d=d&&_===m,o.add(m),i.add(_),void 0===l?l=m:null!==l&&l!==m&&(l=null),c||e.convertible(m)&&(0,ke.symbolCurrencyConvertible)(p)||(c=!0),h+=1,a.add((0,ke.proSymbol)(p,u.symbol()))}if(null!==t)for(const i of this._priceDataSources){
if(p.includes(i))continue;const s=i;if(!s.isCurrencySource()||!s.isVisible())continue;const a=s.currency();if(null===a){t=null;break}o.add(a),u+=1;const d=(0,n.ensureNotNull)(s.symbolSource()),h=s.currencySourceSymbolInfo();if(null===h){t=null;break}if(c||e.convertible(a)&&(0,ke.symbolCurrencyConvertible)(h)||(c=!0),r.set(a,(0,n.ensureNotNull)((0,ke.symbolCurrency)(h,!0))),p.includes(d)||(c=!0),void 0===l)l=a;else if(null!==l&&l!==a){l=null;break}}return void 0===t&&(t=0===h&&0===u?null:{readOnly:c,selectedCurrency:l||null,currencies:o,originalCurrencies:i,baseCurrencies:s,symbolSourceCount:h,allCurrenciesAreOriginal:d,displayedValues:r,symbols:a}),this._currencyCache={value:t,availableCurrenciesCount:e.size()},t}unit(e){if(null!==this._unitCache&&e.size()===this._unitCache.availableUnitsCount)return this._unitCache.value;let t;const i=new Set,s=new Set,o=new Map,r=new Map,a=new Set;let l,c=0===this._seriesLikeSources.length?new Set:e.allGroups(),d=!0,h=0,u=0;const p=this._seriesLikeSources.filter(Ae.isActingAsSymbolSource);for(const n of p){if(!n.isVisible())continue;const u=n.symbolInfo();if(null===u){t=null;break}const p=(0,ke.symbolOriginalUnit)(u,n.model().unitConversionEnabled());if(null===p){t=null;break}o.set(p,e.name(p)),r.set(p,e.description(p));const _=n.unit();if(null===_){t=null;break}if(o.set(_,e.name(_)),r.set(_,e.description(_)),d=d&&p===_,s.add(_),i.add(p),void 0===l?l=_:null!==l&&l!==_&&(l=null),c.size>0){const t=(0,Ee.unitConvertibleGroups)(u,_,e);c=(0,b.intersect)(c,new Set(t))}h+=1,a.add((0,ke.proSymbol)(u,n.symbol()))}if(null!==t)for(const i of this._priceDataSources){if(p.includes(i))continue;const a=i;if(!a.isUnitSource()||!a.isVisible())continue;const d=a.unit();if(null===d){t=null;break}s.add(d),u+=1;const h=(0,n.ensureNotNull)(a.symbolSource()),_=h.symbolInfo();if(null===_){t=null;break}if(c.size>0){const t=(0,Ee.unitConvertibleGroups)(_,d,e);c=(0,b.intersect)(c,new Set(t))}if(o.set(d,e.name(d)),r.set(d,e.description(d)),p.includes(h)||(c=new Set),void 0===l)l=d;else if(null!==l&&l!==d){l=null;break}}if(void 0===t)if(0===h&&0===u)t=null;else{t={availableGroups:c,selectedUnit:l||null,units:s,originalUnits:i,symbolSourceCount:h,allUnitsAreOriginal:d,names:o,descriptions:r,symbols:a}}return this._unitCache={value:t,availableUnitsCount:e.size()},t}measureUnitId(e){if(null!==this._measureUnitIdCache&&e.size()===this._measureUnitIdCache.availableUnitsCount)return this._measureUnitIdCache.value;let t,i;const s=new Map,o=new Map,r=new Set;let n=0;const a=this._seriesLikeSources.filter(Ae.isActingAsSymbolSource);for(const l of a){if(!l.isVisible())continue;const a=l.measureUnitId();if(null===a){t=null;break}r.add(a),s.set(a,e.name(a)),o.set(a,e.description(a)),void 0===i?i=a:null!==i&&i!==a&&(i=null),n+=1}return void 0===t&&(t=0===n?null:{selectedMeasureUnitId:i||null,measureUnitIds:r,names:s,descriptions:o,symbolSourceCount:n}),this._measureUnitIdCache={value:t,availableUnitsCount:e.size()},t}setMargins(e){if(!(0,ue.isNumber)(e.top)||!(0,ue.isNumber)(e.bottom))throw new TypeError("invalid margin")
;if(e.top<0||e.top>30||e.bottom<0||e.bottom>30)throw new RangeError("invalid margin");this._margins.top===e.top&&this._margins.bottom===e.bottom||(this._margins=e,this._correctedMarginsCache=null,this._invalidateInternalHeightCache(),this._marksCache=null)}topMargin(){return this._correctedMargins().top}bottomMargin(){return this._correctedMargins().bottom}invalidateMargins(){this._correctedMarginsCache=null}topPixelMargin(){return this.isInverted()?this.bottomMargin()*this.height()+this._bottomPixelMargin:this.topMargin()*this.height()+this._topPixelMargin}bottomPixelMargin(){return this.isInverted()?this.topMargin()*this.height()+this._topPixelMargin:this.bottomMargin()*this.height()+this._bottomPixelMargin}marks(){return this.isEmpty()?(this._marksCache=null,[]):(null===this._marksCache&&(this._markBuilder.rebuildTickMarks(),this._marksCache=this._markBuilder.marks(),this._onMarksChanged.fire()),this._marksCache)}onMarksChanged(){return this._onMarksChanged}priceRangeInPrice(){if(this.isEmpty())return null;const e=this.mainSource();if(null===e)return null;const t=(0,n.ensureNotNull)(e.firstValue()),i=this.height();return{from:this.coordinateToPrice(i-1,t),to:this.coordinateToPrice(0,t)}}setPriceRangeInPrice(e){if(this.isPercentage()||this.isIndexedTo100())return;const t=this.isInverted(),i=t?this.bottomMargin():this.topMargin(),s=t?this.topMargin():this.bottomMargin(),o=this.isLog();let r=o?(0,Ie.toLog)(e.from,this._logFormula):e.from,n=o?(0,Ie.toLog)(e.to,this._logFormula):e.to;const a=n-r;r+=s*a,n-=i*a,this.setMode({autoScale:!1}),this.setPriceRange(new xe.PriceRange(r,n)),this._marksCache=null,this._onMarksChanged.fire()}hasMainSeries(){return this._hasSeries}getStudies(){return this.dataSources().filter(O.isStudy)}lastSourceRemoved(){return this._lastSourceRemoved}sourcesForAutoscale(){return this._mainSource&&this._scaleSeriesOnly!==this._scalesProperties.childs().scaleSeriesOnly.value()&&(this._sourcesForAutoscale=null),this._sourcesForAutoscale||(this._sourcesForAutoscale=this._recalculateSourcesForAutoscale()),this._sourcesForAutoscale}recalculatePriceRange(e){this._invalidatedForRange={visibleBars:e,isValid:!1}}internalHeightChanged(){return this._internalHeightChanged}orderedSources(){if(this._cachedOrderedSoruces)return this._cachedOrderedSoruces;let e=this.m_dataSources.slice();return e=e.filter((e=>!(0,ge.isLollipopDataSource)(e))),e=(0,be.sortSources)(e),this._cachedOrderedSoruces=e,this._cachedOrderedSoruces}invalidateSourcesCache(){this._cachedOrderedSoruces=null,this._sourcesToUpdateViews=null}startScale(e){var t,i;this.isEmpty()||this.isPercentage()||this.isIndexedTo100()||null!==this._scaleStartPoint||null!==this._priceRangeSnapshot||(this._scaleStartPoint=this.m_height-e,this._priceRangeSnapshot=null!==(i=null===(t=this.priceRange())||void 0===t?void 0:t.clone())&&void 0!==i?i:null)}scaleTo(e){if(this.isPercentage()||this.isIndexedTo100()||null===this._scaleStartPoint)return;this.setMode({autoScale:!1}),(e=this.m_height-e)<0&&(e=0)
;let t=(this._scaleStartPoint+.2*(this.m_height-1))/(e+.2*(this.m_height-1));const i=(0,n.ensureNotNull)(this._priceRangeSnapshot).clone();t=Math.max(t,.1),i.scaleAroundCenter(t),this.setPriceRange(i)}endScale(){this.isPercentage()||this.isIndexedTo100()||null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._priceRangeSnapshot=null)}startTwoPointsScale(e,t){if(this.isEmpty()||this.isPercentage()||this.isIndexedTo100()||null!==this._twoPointsScaleStartPosition)return;const i=Math.min(e,t),s=Math.max(e,t);this._twoPointsScaleStartPosition={topLogical:this._coordinateToLogical(i),bottomLogical:this._coordinateToLogical(s)}}twoPointsScale(e,t){if(this.isPercentage()||this.isIndexedTo100()||null===this._twoPointsScaleStartPosition)return;this.setMode({autoScale:!1});const i=Math.min(e,t),s=Math.max(e,t),{topLogical:o,bottomLogical:r}=this._twoPointsScaleStartPosition,n=this.bottomPixelMargin(),a=this.internalHeight()-1,l=(this._invertedCoordinate(i)-n)/a,c=(r-o)/((this._invertedCoordinate(s)-n)/a-l);if(!Number.isFinite(c))return;const d=o-c*l,h=d+c;this.setPriceRange(new xe.PriceRange(this.priceToLogical(d),this.priceToLogical(h)))}endTwoPointsScale(){this._twoPointsScaleStartPosition=null}startScroll(e){var t,i;this.isAutoScale()||null===this._scrollStartPoint&&null===this._priceRangeSnapshot&&(this.isEmpty()||(this._scrollStartPoint=e,this._priceRangeSnapshot=null!==(i=null===(t=this.priceRange())||void 0===t?void 0:t.clone())&&void 0!==i?i:null))}scrollTo(e){if(this.isAutoScale())return;if(null===this._scrollStartPoint||null===this._priceRangeSnapshot)return;const t=this.priceRange();if(null===t)return;let i=e-this._scrollStartPoint;this.isInverted()&&(i*=-1);const s=i*(t.length()/(this.internalHeight()-1)),o=this._priceRangeSnapshot.clone();o.shift(s),this.setPriceRange(o,!0),this._marksCache=null}endScroll(){this.isAutoScale()||null!==this._scrollStartPoint&&(this._scrollStartPoint=null,this._priceRangeSnapshot=null)}clearPriceRange(){this._priceRange=null,this.recalculatePriceRangeOnce()}isVisible(){return this._isVisible}_addDataSourceImpl(e,t,i){if(t||-1===this.m_dataSources.indexOf(e)){if((0,fe.isPriceDataSource)(e)){if(void 0===i?this._priceDataSources.push(e):this._priceDataSources.splice(i,0,e),e.currencyChanged().subscribe(this,(()=>this._currencyCache=null)),e.unitChanged().subscribe(this,(()=>this._unitCache=null)),(0,Ae.isSymbolSource)(e)&&(this._seriesLikeSources.push(e),e.symbolResolved().subscribe(this,(()=>{this._currencyCache=null,this._unitCache=null,this._measureUnitIdCache=null,this._updateLogFormula()})),e.isActingAsSymbolSource().subscribe(this._boundOnSourceIsActingAsSymbolSourceChanged),e instanceof Le.Series)){const t=e.properties();this._hasSeries||(t.childs().lockScale&&(this.setMode({lockScale:t.childs().lockScale.value()}),t.removeProperty("lockScale")),t.childs().pnfStyle.child("lockScale")&&t.childs().pnfStyle.removeProperty("lockScale")),this._hasSeries=!0}e.isSpeciallyZOrderedSource()||(this._sourcesThatAffectVisibility.push(e),
e.properties().childs().visible.listeners().subscribe(this,this._onSourceVisibilityChanged))}(0,O.isStudy)(e)&&(e.onIsActualIntervalChange().subscribe(this,this._dropScaleCache),e.onHibernationStateChange().subscribe(this,this._dropScaleCache),e.properties().childs().styles.listeners().subscribe(this,this._dropScaleCache),0===this._studiesCount&&(0,Fe.hideAllIndicators)().subscribe(this,this._dropScaleCache),this._studiesCount++),(0,C.isLineTool)(e)&&(0===this._drawingCount&&(0,Fe.hideAllDrawings)().subscribe(this,this._dropScaleCache),this._drawingCount++),this.m_dataSources.push(e),this._mainSource=null,this.mainSource()===e&&(this._correctedMarginsCache=null,this._internalHeightCache=null,this._marksCache=null),this._dropScaleCache(),this.updateFormatter(),this._initScaleProperties(),this.invalidateSourcesCache(),this._updateIsVisible(),this._updateLogFormula()}}_recalculateSourcesForAutoscale(){this._mainSource&&(this._scaleSeriesOnly=this._scalesProperties.childs().scaleSeriesOnly.value());const e=this._scaleSeriesOnly&&this._hasSeries;return this.m_dataSources.filter((t=>!!(t.properties().visible.value()||t instanceof Le.Series)&&(e?t instanceof Le.Series:(0,O.isStudy)(t)?!t.isSourceHidden()&&t.isIncludedInAutoScale():t.isIncludedInAutoScale())))}_updateAutoScaleDisabledProperty(e){const t=this._properties.childs(),i=t.indexedTo100.value()||t.percentage.value()||t.lockScale.value();e?t.autoScaleDisabled.setValueSilently(i):t.autoScaleDisabled.setValue(i)}_setAutoScaleValueWithDependentProperties(e){const t=this._properties.childs();t.autoScale.setValueSilently(e),e&&(t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.logDisabled.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setLockScaleValueWithDependentProperties(e){const t=this._properties.childs();t.lockScale.setValueSilently(e),e&&(t.autoScale.setValueSilently(!1),t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1),t.log.setValueSilently(!1)),t.percentageDisabled.setValueSilently(e),t.logDisabled.setValueSilently(e),this._updateAutoScaleDisabledProperty(!0)}_setPercentageValueWithDependentProperties(e){const t=this._properties.childs();t.percentage.setValueSilently(e),e&&(t.autoScale.setValueSilently(!0),t.log.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.indexedTo100.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setIndexedTo100ValueWithDependentProperties(e){const t=this._properties.childs();t.indexedTo100.setValueSilently(e),e&&(t.autoScale.setValueSilently(!0),t.log.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.percentage.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setLogValueWithDependentProperties(e){const t=this._properties.childs();t.log.setValueSilently(e),e&&(t.lockScale.setValueSilently(!1),t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_recalculatePriceRangeImpl(){const e=this._invalidatedForRange.visibleBars;if(null===e)return
;let t=null;const i=this.sourcesForAutoscale(),s=this.isPercentage(),o=this.isIndexedTo100();let r=0,n=0;const a={targetPriceScale:this,scaleSeriesOnly:this._scaleSeriesOnly};for(const l of i){if(!l.properties().visible.value())continue;const i=l.firstValue();if(null===i||s&&0===i)continue;const c=e.firstBar(),d=e.lastBar(),h=l.autoScaleInfo(c,d,a);let u=h.range;u&&(s?u=(0,Ie.toPercentRange)(u,i):o&&(u=(0,Ie.toIndexedTo100Range)(u,i)),t=null===t?u:t.merge(u)),void 0!==h.topPixelMargin&&(r=Math.max(r,h.topPixelMargin)),void 0!==h.bottomPixelMargin&&(n=Math.max(n,h.bottomPixelMargin))}(Math.abs(r-this._topPixelMargin)>0||Math.abs(n-this._bottomPixelMargin)>0)&&(this._bottomPixelMargin=n,this._topPixelMargin=r,this._marksCache=null,this._invalidateInternalHeightCache()),t?(this._hasCalculatedPriceRange=!0,t.minValue()===t.maxValue()&&(t=new xe.PriceRange(t.minValue()-.5,t.maxValue()+.5)),this.setPriceRange(t)):this._priceRange||this.setPriceRange(new xe.PriceRange(-.5,.5)),this._invalidatedForRange.isValid=!0;const l=this.mainSource();null!==l&&this._recalculatePriceRangeOnce&&(this._recalculatePriceRangeOnce=!l.priceRangeReady())}_makeSureItIsValid(){this._invalidatedForRange.isValid||(this._invalidatedForRange.isValid=!0,this._recalculatePriceRangeImpl())}_invalidateInternalHeightCache(){this._internalHeightCache=null,this._internalHeightChanged.fire()}_coordinateToLogical(e){if(this._makeSureItIsValid(),this.isEmpty())return 0;const t=this._invertedCoordinate(e),i=(0,n.ensureNotNull)(this.priceRange()),s=i.minValue()+(i.maxValue()-i.minValue())*((t-this.bottomPixelMargin())/(this.internalHeight()-1));return this.logicalToPrice(s)}_logicalToCoordinate(e){if(this._makeSureItIsValid(),this.isEmpty())return 0;e=this.priceToLogical(e);const t=(0,n.ensureNotNull)(this.priceRange()),i=this.bottomPixelMargin()+(this.internalHeight()-1)*(e-t.minValue())/(t.maxValue()-t.minValue());return this._invertedCoordinate(i)}_convertPriceRangeFromLog(e){if(null===e)return null;const t=(0,Ie.fromLog)(e.minValue(),this._logFormula),i=(0,Ie.fromLog)(e.maxValue(),this._logFormula);return new xe.PriceRange(t,i)}_convertPriceRangeToLog(e){if(null===e)return null;const t=(0,Ie.toLog)(e.minValue(),this._logFormula),i=(0,Ie.toLog)(e.maxValue(),this._logFormula);return new xe.PriceRange(t,i)}_canConvertPriceRangeFromLog(e){if(null===e)return!1;const t=(0,Ie.fromLog)(e.minValue(),this._logFormula),i=(0,Ie.fromLog)(e.maxValue(),this._logFormula);return isFinite(t)&&isFinite(i)}_onSourceVisibilityChanged(){this._dropScaleCache(),this._updateIsVisible()}_dropScaleCache(){this._sourcesForAutoscale=null,this._currencyCache=null,this._unitCache=null,this._measureUnitIdCache=null}_updateIsVisible(){this._isVisible.setValue(!0)}_updateLogFormula(){const e=this.isLog()?this._convertPriceRangeFromLog(this.priceRange()):null,t=this.mainSource();if(null===t)this._logFormula=(0,Ie.logFormulaForBase)(null);else{const e=t.base()||null,i=(0,Ie.logFormulaForBase)(e);(0,Ie.logFormulasAreSame)(i,this._logFormula)||(this._logFormula=i)}
e&&this.setPriceRange(this._convertPriceRangeToLog(e))}_invertedCoordinate(e){return this.isInverted()?e:this.height()-1-e}_initScaleProperties(){const e=this.isLockScale(),t=this.properties().childs();e&&(t.percentage.setValue(!1),t.indexedTo100.setValue(!1),t.log.setValue(!1),t.autoScale.setValue(!1)),t.percentageDisabled.setValue(e),t.logDisabled.setValue(e),this._updateAutoScaleDisabledProperty(!1),t.percentage.value()&&(t.log.setValue(!1),t.indexedTo100.setValue(!1)),t.indexedTo100.value()&&(t.log.setValue(!1),t.percentage.setValue(!1))}_correctedMargins(){if(null===this._correctedMarginsCache){const e=this.mainSource();this._correctedMarginsCache=null!==e?e.correctScaleMargins(this._margins):this._margins}return this._correctedMarginsCache}_getSourcesToUpdateViews(){return this._sourcesToUpdateViews||(this._sourcesToUpdateViews=this.m_dataSources.filter((e=>!(0,C.isLineTool)(e)||e.isActualSymbol()&&e.isActualCurrency()))),this._sourcesToUpdateViews}_mainSourceFormatter(){const e=this.mainSource();return(null==e?void 0:e.formatter())||Ge}_priceToPercentOrIndexedTo100IfNeeded(e,t){return this.isPercentage()?(0,Ie.toPercent)(e,t):this.isIndexedTo100()?(0,Ie.toIndexedTo100)(e,t):e}_onSourceIsActingAsSymbolSourceChanged(){this._dropScaleCache()}_onIsInvertedChanged(){this._marksCache=null,this._markBuilder.rebuildTickMarks()}_updateResetAvailableValue(){this._resetScaleAvailable.setValue(!this.isLockScale()&&!this.isAutoScale())}}var Ke=i(134392),Ze=i(691246),Ye=i(198930),$e=i(540519),Xe=i(757402),Je=i(336068),Qe=i(487416);var et=i(412788),tt=i(316589),it=i(441788),st=i(221542),ot=i(734493),rt=i(97917),nt=i(169532),at=i(149109),lt=i(500323);const ct=(0,ae.getLogger)("Chart.Pane");function dt(e,t,i){e.setMargins({top:t,bottom:i})}const ht="chart.pane";class ut{constructor(e,t,i,s){this.m_dataSources=[],this._sourceWatchedValuesSubscriptions=new Map,this.m_mainDataSource=null,this._cachedOrderedSources=new Pe(this),this._sourcesById=new Map,this._priceSourcesById=new Map,this._sourcePropertiesChanged=new V.Delegate,this._sourcesZOrderChanged=new V.Delegate,this._tagsChanged=new V.Delegate,this._stretchFactor=1e3,this._isInInsertManyDataSourcesState=!1,this._lastLineDataSourceZOrder=null,this._rightPriceScales=[],this._leftPriceScales=[],this._lockedPriceScale=null,this._currentPriceScaleRatio=null,this._onPriceScalesChanged=new V.Delegate,this._isRecalculatingScales=!1,this._priceDataSources=[],this._symbolSources=[],this._lollipopDataSources=[],this._symbolSourceResolved=new V.Delegate,this._symbolSourceResolvingActive=new W.WatchedValue(!1),this._bulkActions={activeCounter:0},this._height=0,this._width=0,this._sizeChanged=new V.Delegate,this._dataSourcesCollectionChanged=new V.Delegate,this._symbolSourceCollectionChanged=new V.Delegate,this._priceSourcesCollectionChanged=new V.Delegate,this._maximized=new W.WatchedValue(!1),this._collapsed=new W.WatchedValue(!1),this._resetPriceScalesAvailable=new W.WatchedValue(!1),this._destroyed=new V.Delegate,this._executionsPositionController=null,this._seriesDisplayError=null,
this._onPriceScaleIsVisibleChanged=()=>{this._model.fullUpdate()},this._recalcSymbolSourceResolvingActive=()=>{for(const e of this._symbolSources)if(e.symbolResolvingActive().value())return void this._symbolSourceResolvingActive.setValue(!0);this._symbolSourceResolvingActive.setValue(!1)},this._onSymbolSourceCollectionChanged=()=>{0===this._bulkActions.activeCounter?this._symbolSourceCollectionChanged.fire():this._bulkActions.symbolSourceCollectionChanged=!0},this._onSeriesDisplayError=e=>{},this._updateResetPriceScalesAvailableValue=()=>{const e=e=>e.resetScaleAvailable().value(),t=this._leftPriceScales.some(e)||this._rightPriceScales.some(e);this._resetPriceScalesAvailable.setValue(t)},this._priceScaleSelectionStrategy=(0,de.createPriceScaleSelectionStrategy)(i.properties().childs().priceScaleSelectionStrategyName.value()),this._id=null!=s?s:(0,le.randomHashN)(6),this._timeScale=e,this.m_mainDataSource=null,this._properties=t,this._model=i,i.properties().childs().priceScaleSelectionStrategyName.subscribe(null,(e=>{this._priceScaleSelectionStrategy=(0,de.createPriceScaleSelectionStrategy)(e.value()),this._priceScaleSelectionStrategy.apply(this)})),this._timeScale.barSpacingChanged().subscribe(this,(()=>{this.m_mainDataSource===this._model.mainSeries()&&this._recalculatePriceScaleByScaleRatio(this.m_mainDataSource.priceScale())})),i.onMultipaneSourcesCollectionChanged().subscribe(this,this._invalidateSourcesCache),i.panesCollectionChanged().subscribe(this,this._invalidateSourcesCache),t.childs().topMargin.subscribe(this,this._updateMargins),t.childs().bottomMargin.subscribe(this,this._updateMargins),this._updateMargins()}destroy(){var e;this._properties.childs().topMargin.unsubscribeAll(this),this._properties.childs().bottomMargin.unsubscribeAll(this),this._model.properties().childs().priceScaleSelectionStrategyName.unsubscribeAll(this),this._timeScale.barSpacingChanged().unsubscribeAll(this),this._leftPriceScales.concat(this._rightPriceScales).forEach((e=>{e.modeChanged().unsubscribeAll(this),e.priceRangeChanged().unsubscribeAll(this),e.internalHeightChanged().unsubscribeAll(this),e.isVisible().unsubscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().unsubscribe(this._updateResetPriceScalesAvailableValue)}));for(const e of this.m_dataSources)this.removeSourceFromPriceScale(e),e.destroy&&e.destroy();null===(e=this._seriesDisplayError)||void 0===e||e.destroy(),this._model.onMultipaneSourcesCollectionChanged().unsubscribeAll(this),this._model.panesCollectionChanged().unsubscribeAll(this),this._destroyed.fire()}id(){return this._id}bulkActionMacro(e){const t=this._bulkActions;t.activeCounter+=1,e(),t.activeCounter-=1,0===t.activeCounter&&(this._dataSourcesCollectionChanged.fire(),t.symbolSourceCollectionChanged&&(this._symbolSourceCollectionChanged.fire(),t.symbolSourceCollectionChanged=!1),t.priceSourcesCollectionChanged&&(this._priceSourcesCollectionChanged.fire(),t.priceSourcesCollectionChanged=!1))}defaultPriceScale(){var e,t
;const i=null!==(t=null===(e=this.m_mainDataSource)||void 0===e?void 0:e.priceScale())&&void 0!==t?t:null;if(null!==i)return i;const s=this.properties().childs().axisProperties.state();return s.autoScale=!0,new je(this._model.properties().childs().scalesProperties,s)}leftPriceScales(){return this._leftPriceScales}rightPriceScales(){return this._rightPriceScales}visibleLeftPriceScales(){var e;const t=this._model.priceScaleSlotsCount(),i=this._leftPriceScales.filter((e=>e.isVisible().value())),s=null===(e=this.mainDataSource())||void 0===e?void 0:e.priceScale();if(i.length>t.left&&(null==s?void 0:s.isVisible().value())){const e=(0,b.moveToHead)(i,s);return e.splice(t.left),e}return i}visibleRightPriceScales(){var e;const t=this._model.priceScaleSlotsCount(),i=this._rightPriceScales.filter((e=>e.isVisible().value())),s=null===(e=this.mainDataSource())||void 0===e?void 0:e.priceScale();if(i.length>t.right&&(null==s?void 0:s.isVisible().value())){const e=(0,b.moveToHead)(i,s);return e.splice(t.right),e}return i}clearSeries(e){const t=this._model.mainSeries();for(let i=this.m_dataSources.length-1;i>=0;i--)this.m_dataSources[i]===t&&this._removeSourceFromCollections(i,e)}sourcesByGroup(){return this._cachedOrderedSources}dataSourceForId(e){return this._sourcesById.get(e)||null}changeSourceId(e,t){var i;e===this._model.mainSeries()&&(null===(i=(0,ce.getPersistentLogger)())||void 0===i||i.addPersistentLogEntry(`changeSourceId for series from ${e.id()} to ${t}`,ae.LOGLEVEL.INFO,ht)),(0,n.assert)(this.hasDataSource(e));const s=e.id();e.setId(t),this._sourcesById.delete(s),this._sourcesById.set(t,e),(0,fe.isPriceDataSource)(e)&&(this._priceSourcesById.delete(s),this._priceSourcesById.set(t,e))}movePriceScale(e,t,i){const s=this.priceScalePosition(e);if(s!==t)this.removePriceScale(e),this._placePriceScale(e,t,i),e.invalidateMargins(),this._invalidateSourcesCache();else if(void 0!==i&&"overlay"!==s){const t="left"===s?this._leftPriceScales:this._rightPriceScales,o=t.indexOf(e);t.splice(o,1),t.splice(i,0,e)}}mainDataSource(){return this.m_mainDataSource}isEmpty(){return null===this.m_mainDataSource}recalculatePriceScale(e,t){if(!e)return;let i=e.sourcesForAutoscale();if(e===this._model.mainSeries().priceScale()&&(i=[...i,...this._cachedOrderedSources.multipaneSources()]),(e.isAutoScale()||e.priceRangeShouldBeRecalculatedOnce()||null===e.priceRange())&&i.length>0&&!this.timeScale().isEmpty()){const t=this.timeScale().visibleBarsStrictRange();e.recalculatePriceRange(t)}e.updateAllViews(t)}onSourceTagsChanged(){this._tagsChanged.fire()}insertDataSource(e,t,i,s){e.setZorder(i),t||(s=!1,t=this.findSuitableScale(e)),this._addSourceToCollections(e);let o=!1;e===this.model().mainSeries()?(this.m_mainDataSource=this.model().mainSeries(),o=!0):null===this.m_mainDataSource&&(0,fe.isPriceDataSource)(e)&&(this.m_mainDataSource=e,o=!0),s||t.addDataSource(e,this._isInInsertManyDataSourcesState),e.setPriceScale(t),t.invalidateMargins(),e.onTagsChanged&&e.onTagsChanged().subscribe(this,this.onSourceTagsChanged),o&&this._processMainSourceChange(),
this._tagsChanged.fire(),(0,fe.isPriceDataSource)(e)&&this.recalculatePriceScale(t,(0,nt.sourceChangeEvent)(e.id())),this._invalidateSourcesCache(),this._isInInsertManyDataSourcesState||(0,n.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(e)}addDataSource(e,t,i){let s=e.zorder();i||((0,C.isLineTool)(e)&&!e.isSpeciallyZOrderedSource()?(s=null!==this._lastLineDataSourceZOrder?this._lastLineDataSourceZOrder+1:this.newLineToolZOrder(),this._isInInsertManyDataSourcesState&&(this._lastLineDataSourceZOrder=s)):(0,O.isStudy)(e)&&!e.isSpeciallyZOrderedSource()&&(s=this.newStudyZOrder())),this.insertDataSource(e,t,s)}removeDataSource(e,t,i,s){const o=this.m_dataSources.indexOf(e);if(-1===o)return void ct.logDebug("removeDataSource: invalid data source");(0,n.ensureNotNull)(this.model().alertsWatcher()).detachSourceAlertLabels(e),this._removeSourceFromCollections(o,!!i),e!==this.m_mainDataSource||t||(this.m_mainDataSource=null);const r=e.priceScale();s||this.removeSourceFromPriceScale(e),e.onTagsChanged&&e.onTagsChanged().unsubscribe(this,this.onSourceTagsChanged),(0,fe.isPriceDataSource)(e)&&!t&&this._processMainSourceChange(),(0,O.isStudy)(e)&&e.metaInfo().hasForceOverlayPlots()&&this._model.removeMultiPaneSource(e),this._tagsChanged.fire(),r&&(0,fe.isPriceDataSource)(e)&&this.recalculatePriceScale(r,(0,nt.sourceChangeEvent)(e.id())),this._invalidateSourcesCache()}hasDataSource(e){return this._sourcesById.has(e.id())}hasPriceDataSource(e){return this._priceSourcesById.has(e.id())}dataSources(){return this.m_dataSources}priceDataSources(){return this._priceDataSources}lollipopDataSources(){return this._lollipopDataSources}symbolSources(){return this._symbolSources}replaceSource(e,t,i){const s=this.m_mainDataSource===e,o=e.zorder(),r=null==i?void 0:i.replaceSource(e,t);this.removeDataSource(e,s,void 0,r),this.insertDataSource(t,i,o,r),this._sourcesById.set(t.id(),t),(0,fe.isPriceDataSource)(t)&&this._priceSourcesById.set(t.id(),t),s&&(this.m_mainDataSource=t,this._processMainSourceChange())}findSuitableScale(e,t,i){return this._priceScaleSelectionStrategy.findSuitableScale(this,e,t,i)}createNewPriceScaleIfPossible(){return this._priceScaleSelectionStrategy.createNewPriceScaleIfPossible(this)}canCreateNewPriceScale(){return this._priceScaleSelectionStrategy.canCreateNewPriceScale(this)}isOverlay(e){const t=e.priceScale();return null===t||"overlay"===this.priceScalePosition(t)}recalculate(e){this._leftPriceScales.forEach((t=>this.recalculatePriceScale(t,e))),this._rightPriceScales.forEach((t=>this.recalculatePriceScale(t,e)));for(const t of this.m_dataSources)this.isOverlay(t)&&!(0,C.isLineTool)(t)&&this.recalculatePriceScale(t.priceScale(),e);this.updateAllViews(e),this._model.updatePane(this)}updateAllViews(e){const t=this._cachedOrderedSources.all();for(const i of t)i.updateAllViews(e);for(const t of this.model().customSources())t.updateViewsForPane(this,e)}updateLollipopViews(e){for(const t of this._lollipopDataSources)t.updateAllViews(e)}priceScalePosition(e){
return this._leftPriceScales.includes(e)?"left":this._rightPriceScales.includes(e)?"right":"overlay"}createPriceScaleAtPosition(e,t){const i=this.properties().childs().axisProperties.state();i.autoScale=!0;const s=new je(this.model().properties().childs().scalesProperties,i);return s.setHeight(this.height()),dt(s,this._defaultTopMargin(),this._defaultBottomMargin()),this._placePriceScale(s,e,t),s}removePriceScale(e){e.modeChanged().unsubscribeAll(this),e.priceRangeChanged().unsubscribeAll(this),e.internalHeightChanged().unsubscribeAll(this),e.isVisible().unsubscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().unsubscribe(this._updateResetPriceScalesAvailableValue),e===this._lockedPriceScale&&(this._lockedPriceScale=null,this._currentPriceScaleRatio=null);const t=this._leftPriceScales.indexOf(e);-1!==t&&(this._leftPriceScales[t].invalidateMargins(),this._leftPriceScales.splice(t,1));const i=this._rightPriceScales.indexOf(e);if(-1!==i&&(this._rightPriceScales[i].invalidateMargins(),this._rightPriceScales.splice(i,1)),null===e.mainSource()){const t=e.dataSources().length;0!==t&&ct.logError("Invalid priceScale state: empty mainSource but non-empty data sources="+t)}this._onPriceScalesChanged.fire(),this._updateResetPriceScalesAvailableValue()}priceScaleIndex(e,t){switch(t){case"left":return this.leftPriceScales().indexOf(e);case"right":return this.rightPriceScales().indexOf(e)}}move(e,t,i){const s=e.priceScale();this.removeSourceFromPriceScale(e),t.addDataSource(e),e.setPriceScale(t),t.invalidateMargins(),this._processMainSourceChange(),this._invalidateSourcesCache(),e.isIncludedInAutoScale()&&(null!==s&&this.recalculatePriceScale(s,(0,nt.sourceChangeEvent)(e.id())),this.recalculatePriceScale(t,(0,nt.sourceChangeEvent)(e.id()))),this._onPriceScalesChanged.fire()}setZOrders(e){e.forEach(((e,t)=>{t.setZorder(e)})),this._invalidateSourcesCache(),0===this._bulkActions.activeCounter&&this._dataSourcesCollectionChanged.fire(),this.model().fullUpdate()}isMainPane(){return this.hasDataSource(this.model().mainSeries())}isLast(){const e=this.model().panes();return e[e.length-1]===this}newStudyZOrder(){return(0,Ze.newStudyZOrder)(this._priceDataSources)}newLineToolZOrder(e){return(0,Ze.newLineToolZOrder)(this.m_dataSources,e)}model(){return this._model}containsMainSeries(){return this._sourcesById.has(this.model().mainSeries().id())}applyPriceScaleRatio(e,t){var i;null!==this._lockedPriceScale&&this._lockedPriceScale!==e||this._currentPriceScaleRatio===t||!this.isMainPane()||null===this._lockedPriceScale&&e!==(null===(i=this.mainDataSource())||void 0===i?void 0:i.priceScale())||(this._setNewPriceRangeByScaleRatio(e,t,this._mainSourceVisiblePriceRange(e),!0,!0),null!==this._lockedPriceScale?this._tryToApplyNewPriceScaleRatio():e.isLog()||this.model().mainSeriesScaleRatioPropertyOnChanged())}sendToBack(e){const t=this.sourcesByGroup().allExceptSpecialSources();this._batchReorder(e,t[0],Ze.moveBeforeSource)}bringToFront(e){const t=this.sourcesByGroup().allExceptSpecialSources()
;this._batchReorder(e,t[t.length-1],Ze.moveAfterSource)}sendBackward(e){const t=this.sourcesByGroup().allIncludingHidden(),i=t.indexOf(e[0]);if(0===i)this.bringToFront(e);else{const s=t[i-1];this.insertBefore(e,s)}}bringForward(e){const t=this.sourcesByGroup().allExceptSpecialSources(),i=t.indexOf(e[e.length-1]);if(i===t.length-1)this.sendToBack(e);else{const s=t[i+1];this.insertAfter(e,s)}}insertAfter(e,t){this._batchReorder(e,t,Ze.moveAfterSource)}insertBefore(e,t){this._batchReorder(e,t,Ze.moveBeforeSource)}maximized(){return this._maximized}collapsed(){return this._collapsed}getPriceScaleById(e){const t=this.m_dataSources.find((t=>{var i;return(null===(i=t.priceScale())||void 0===i?void 0:i.id())===e}));return void 0===t?null:t.priceScale()}priceScaleSelectionStrategy(){return this._priceScaleSelectionStrategy}setPriceScaleSelectionStrategy(e){this._priceScaleSelectionStrategy=e,e.apply(this)}findTargetPriceAxisViews(e,t,i,s){if((0,f.isDataSource)(e)&&this.model().paneForSource(e)!==this)return[];const o=e.priceScale();if(t===o)return i;if(null===o)return[];if("overlay"===this.priceScalePosition(o))return t===this.defaultPriceScale()?i:[];const r=this.priceScalePosition(t);if(r!==this.priceScalePosition(o))return[];const n="left"===r?this.leftPriceScales():this.rightPriceScales();return n.indexOf(t)<n.indexOf(o)?s:[]}actionNoScaleIsEnabled(e){return!(!this.isOverlay(e)&&(0,fe.isPriceDataSource)(e))||this._nonOverlayPricesSourcesCount()>1}properties(){return this._properties}setPriceAutoScale(e,t){e.setMode({autoScale:t}),this.timeScale().isEmpty()||this.recalculatePriceScale(e,(0,nt.viewportChangeEvent)())}state(e,t,i,s,o,r){var n,a;const l={sources:[],mainSourceId:null===(n=this.m_mainDataSource)||void 0===n?void 0:n.id(),stretchFactor:this._stretchFactor,leftAxisesState:[],rightAxisesState:[],overlayPriceScales:{},priceScaleRatio:this._currentPriceScaleRatio,isCollapsed:this._collapsed.value()},c=new Map,d=e=>{if(c.has(e))return c.get(e);let n=null;const a=i&&!e.isSavedInStudyTemplates()||(0,y.isAlertLabel)(e)||!e.state||(0,C.isLineTool)(e)&&r||!e.isSavedInChart(Boolean(t))||!(n=e.state(t,o))||s&&(0,C.isLineTool)(e)&&e.isActualSymbol&&!e.isActualSymbol()||e.isPhantom()?null:n;return c.set(e,a),a};if(e){l.sources=[];for(let e=0;e<this.m_dataSources.length;e++){const t=d(this.m_dataSources[e]);null!==t&&l.sources.push(t)}}const h=e=>null!==c.get(e),u=e=>!r||!(0,C.isLineTool)(e);l.leftAxisesState=this._leftPriceScales.map((e=>({state:e.state(),sources:e.dataSources().filter(h).filter(u).map((e=>e.id()))}))),l.rightAxisesState=this._rightPriceScales.map((e=>({state:e.state(),sources:e.dataSources().filter(h).filter(u).map((e=>e.id()))}))),l.overlayPriceScales={};for(const e of this.m_dataSources)if(this.isOverlay(e)&&e.isSavedInChart(Boolean(t))){const t=e.priceScale();l.overlayPriceScales[e.id()]=null!==(a=null==t?void 0:t.state())&&void 0!==a?a:null}return l}restoreState(e){var t
;const{state:i,withData:s,version:o,seriesId:r=this._model.mainSeries().id(),settingsMigration:a={},contentOverrides:l,restoreSilently:c,reason:d=0}=e;null===(t=(0,ce.getPersistentLogger)())||void 0===t||t.addPersistentLogEntry(`Restoring pane with seriesId ${r}`,ae.LOGLEVEL.INFO,ht),i.stretchFactor&&(this._stretchFactor=i.stretchFactor);const h={};if(i.sources){const e=i.sources.filter((e=>{var t;return!!e&&("MainSeries"===e.type||(!(null===(t=e.points)||void 0===t?void 0:t.some((e=>null===e.time_t||!isFinite(e.time_t))))||(ct.logNormal("Dropped invalid "+e.type+". Reason: non-numeric point time"),!1)))})),t=e.findIndex(Ye.isMainSeriesState);-1!==t&&this.model().mainSeries().setObsoleteZOrder(e[t].zorder),o<3&&(0,Ze.reorderDataSourcesStateZOrder)(e);const n=-1!==this.m_dataSources.indexOf(this._model.mainSeries());this.clearSeries(Boolean(c)),this.m_mainDataSource=null,n&&this._addSourceToCollections(this._model.mainSeries(),c),(()=>{const t=e.find((e=>e.id===i.mainSourceId));if(void 0===t)return void ct.logWarn("There is no main source with id "+i.mainSourceId+", total sources="+e.length);if(!window.TradingView[t.type]||!(0,Me.isLineToolName)(t.type))return void ct.logNormal("The type of main source is not line tool - fix is unnecessary");let s=null;for(const i of e)if(!window.TradingView[t.type]||!(0,Me.isLineToolName)(i.type)){if(null!==s)return void ct.logWarn("Pane contains more than 1 possibly main sources - auto fix cannot be applied");s=i}if(null===s)return void ct.logWarn("Pane contains only line tools - possible we need to remove this pane?");const o=i.mainSourceId;let r=0;i.mainSourceId=s.id,e.forEach((e=>{e.ownerSource===o&&(e.ownerSource=null==s?void 0:s.id,r+=1)})),ct.logNormal("Auto fix broken pane is applied, changed line tools="+r+", changed from="+o+" to="+s.id)})();for(const t of e)if("study_Sessions"===t.type){const e=t;e.oldState=!0,this.model().sessions().restoreState(e,s);break}for(const t of e)"study_Sessions"!==t.type&&(null===this._model.dataSourceForId(t.id)||"MainSeries"===t.type?(h[t.id]=t.ownerSource,(0,Ye.isMainSeriesState)(t)?this._restoreMainSeries(t,s,n,a,l,c):(0,Ye.isStudyState)(t)?this.restoreStudy(t,s,r,a,c,d):(0,Ye.isLineToolState)(t)?(t.state&&(t.state.zOrderVersion=2),this.restoreLineTool(t,s,void 0,c)):"ChartEventsSource"===t.type&&this._restoreSpecialSource(t,s,c)):ct.logError("Duplicate id while restoring pane: "+t.type+","+t.id))}const u=new Set,p=(e,t)=>{e.priceScale()!==t&&(this.removeSourceFromPriceScale(e),e.setPriceScale(t),t.addDataSource(e))},_=(e,t,i)=>{if(u.has(e))return;u.add(e);const s=i.m_showSymbolLabels;void 0!==s&&e===this.model().mainSeries()&&this.model().properties().childs().scalesProperties.childs().showSymbolLabels.setValue(s),this._model.children(e,!0).forEach((e=>_(e,t,i))),p(e,t)},m=e=>{const t=(0,$.defaults)("chartproperties").paneProperties.axisProperties,i=new je(this.model().properties().childs().scalesProperties,t);return i.restoreState(e.state),i.setHeight(this._height),e.sources.forEach((e=>{const s=this.dataSourceForId(e);s&&_(s,i,t)})),
0===i.dataSources().length?null:i},g=e=>e.map(m).filter((e=>null!==e));let S;if(i.leftAxisesState)S=g(i.leftAxisesState);else{const e=m({state:i.leftAxisState,sources:i.leftAxisSources});S=null!==e?[e]:[]}let v;if(this._leftPriceScales.slice().forEach((e=>this.removePriceScale(e))),this._leftPriceScales=[],S.forEach((e=>this._placePriceScale(e,"left"))),i.rightAxisesState)v=g(i.rightAxisesState);else{const e=m({state:i.rightAxisState,sources:i.rightAxisSources});v=null!==e?[e]:[]}this._rightPriceScales.slice().forEach((e=>this.removePriceScale(e))),this._rightPriceScales=[],v.forEach((e=>this._placePriceScale(e,"right"))),this._currentPriceScaleRatio=i.priceScaleRatio||i.leftPriceScaleRatio||i.rightPriceScaleRatio||null;const f=new Map;for(const e of this.m_dataSources){if(u.has(e))continue;let t;if(i.overlayPriceScales&&i.overlayPriceScales[e.id()]){let s=i.overlayPriceScales[e.id()];f.has(null==s?void 0:s.id)?t=f.get(null==s?void 0:s.id):(s=(0,n.ensure)(s),t=new je(this._model.properties().childs().scalesProperties),t.setHeight(this._height),s.m_isAutoScale=!0,s.m_isLog=!1,s.m_isPercentage=!1,s.m_isLockScale=!1,t.restoreState(s),f.set(s.id,t))}else t=new je(this._model.properties().childs().scalesProperties),t.setHeight(this._height);p(e,t)}for(const e of Object.keys(h)){const t=h[e],i=this.dataSourceForId(e);t&&i&&null===i.ownerSource()&&i.setOwnerSource(this.dataSourceForId(t))}if(i.mainSourceId&&!this.containsMainSeries()&&(this.m_mainDataSource=this.dataSourceForId(i.mainSourceId)),!this.m_mainDataSource)for(const e of this.m_dataSources)if((0,fe.isPriceDataSource)(e)){this.m_mainDataSource=e;break}for(const e of this.m_dataSources)(0,C.isLineTool)(e)?(e.ownerSource()||e.setOwnerSource(this.mainDataSource()),e.isFixed()&&e.restoreFixedPoint()):(0,O.isStudy)(e)&&!e.ownerSource()&&e.isLinkedToSeries()&&e.setOwnerSource(this.model().mainSeries());this._updateMargins(),this._cachedOrderedSources.clear()}onPriceScalesChanged(){return this._onPriceScalesChanged}setPaneSize(e){let t;switch(e){case"large":t=1;break;case"medium":t=.6;break;case"small":t=.3;break;case"tiny":t=.15;break;default:throw new Error("Unknown size enum value: "+e)}this._stretchFactor=1e3*t}stretchFactor(){return this._stretchFactor}setStretchFactor(e){this._stretchFactor=e}customSources(e){return this.model().customSources(e)}createDrawingsCaches(){0}clearDrawingCaches(){0}executionsPositionController(){return null}width(){return this._width}height(){return this._height}setHeight(e){if(this._height!==e){this._height=e,this._leftPriceScales.forEach((t=>t.setHeight(e))),this._rightPriceScales.forEach((t=>t.setHeight(e)));for(let t=0;t<this.m_dataSources.length;t++){const i=this.m_dataSources[t];this.isOverlay(i)&&i.priceScale()&&(0,n.ensureNotNull)(i.priceScale()).setHeight(e)}this.updateAllViews((0,nt.viewportChangeEvent)()),this._sizeChanged.fire()}}setWidth(e){return this._width!==e&&(this._width=e,this.updateAllViews((0,nt.viewportChangeEvent)()),this._sizeChanged.fire(),!0)}onSizeChanged(){return this._sizeChanged}onTagsChanged(){
return this._tagsChanged}onDestroyed(){return this._destroyed}dataSourcesCollectionChanged(){return this._dataSourcesCollectionChanged}symbolSourceCollectionChanged(){return this._symbolSourceCollectionChanged}priceSourcesCollectionChanged(){return this._priceSourcesCollectionChanged}symbolSourceResolved(){return this._symbolSourceResolved}symbolSourceResolvingActive(){return this._symbolSourceResolvingActive}sourcePropertiesChanged(){return this._sourcePropertiesChanged}sourceZOrderChanged(){return this._sourcesZOrderChanged}lineToolsForArea(e,t){const i=this.logicalRectToPixels(e);return[...this.m_dataSources,...this.model().multiPaneSources(this)].filter(C.isLineTool).filter((e=>(e.paneViews(this)||[]).some((e=>{const s=e.renderer(t);return s&&s.doesIntersectWithBox&&s.doesIntersectWithBox(i,t)}))))}logicalRectToPixels(e){const t=this.defaultPriceScale(),i=this.timeScale(),s=(0,n.ensureNotNull)((0,n.ensureNotNull)(t.mainSource()).firstValue()),o=t.priceToCoordinate(e.p1.price,s),r=i.indexToCoordinate(e.p1.index),l=t.priceToCoordinate(e.p2.price,s),c=i.indexToCoordinate(e.p2.index),d=new a.Point(Math.min(r,c),Math.min(o,l)),h=new a.Point(Math.max(r,c),Math.max(o,l));return(0,a.box)(d,h)}timeScale(){return this._timeScale}restoreLineTool(e,t,s,o,r){var a,l,c,h,u,p,_,m,g,S;if((0,Me.isMtpPredictorToolName)(e.type))return ct.logWarn(`No longer supported tool ${e.type} is skipped while restoring state`),null;delete e.state.lastUpdateTime,e.state.intervalsVisibilities=(0,et.mergeIntervalVisibilitiesDefaults)(e.state.intervalsVisibilities),s=void 0===s||s,Qe.LineToolElliott.migrateState(e),"LineToolGannComplex"!==(S=e).type||void 0!==S.version&&1!==S.version||(S.type="LineToolGannFixed"),Array.isArray(e.positionPercents)&&(e.positionPercents=e.positionPercents[0]);const v=e.type,f=e.id,b=e.state,y=s?e.zorder:this.newLineToolZOrder();(0,n.assert)((0,Me.isLineToolName)(v),"invalid data source type:"+v+" (expected to be a Line Tool)");let w,T,P=null;if((0,Ye.isStudyLineToolState)(e)){P=this._model.isSnapshot()?new lt.StudyVersioning([],[]):(0,N.studyMetaInfoRepository)().studyVersioning();const s=lt.StudyVersioning.patchPointsBasedStudyState(e);e=s;const r=new he.StudyMetaInfo(s.metaInfo);if(!t&&r){const t=r.productId;if(!(null===(a=window.pro)||void 0===a?void 0:a.hasPackage(t))){const t=new me.StudyLineToolStub(this._model,e,r.shortDescription);return t.setId(f),this._addSourceToCollections(t,o),void 0!==y&&t.setZorder(y),t.setFailed(d.t(null,void 0,i(432101))),null}}const n=P.updateMetaInfo(r),l=null!=n?n:r;T=(0,C.createStudyLineToolProperties)(v,r,l,b,P),w=(0,C.createLineTool)(v,this._model,T,l,!0)}else T=(0,C.createLineToolProperties)(v,b,this._model,!1),w=(0,C.createLineTool)(v,this._model,T,null,!0);w.setId(f),w.linkKey().setValue(e.linkKey||null);const M=e.alertId;M&&w.canHasAlert()&&Se.alertsAvailable&&!this._model.readOnly()&&!this._model.isJustClonedChart()&&w.restoreAlert(+M);let x=null!==(l=e.indexes)&&void 0!==l?l:[]
;if(x=x.slice(0,null!==(h=null===(c=e.points)||void 0===c?void 0:c.length)&&void 0!==h?h:x.length),w.isFixed()?void 0!==e.positionPercents?w.restorePositionPercents(e.positionPercents):w.restorePositionPercents({x:.5,y:.5}):e.points&&w.restorePoints(e.points,x,t),w instanceof tt.LineToolBarsPattern||w instanceof it.LineToolCallout||w instanceof st.LineToolTrendAngle||w instanceof ot.LineToolGhostFeed||w instanceof rt.LineToolParallelChannel||w instanceof pe.LineToolTweet||w instanceof _e.LineToolIdea)null===(p=(u=w).restoreData)||void 0===p||p.call(u,e);else if(t&&(0,Ye.isStudyLineToolState)(e)&&w.restoreData){const t=e;P&&(t.graphics=lt.StudyVersioning.patchPointsBasedStudyData(new he.StudyMetaInfo(t.metaInfo),t.graphics)),null===(_=w.restoreData)||void 0===_||_.call(w,t)}const I=null==e.version?1:e.version,L=null==w.version?1:w.version;if(I!==L&&(null===(g=(m=w).migrateVersion)||void 0===g||g.call(m,I,L,{pane:this,model:this._model,properties:T})),void 0!==y&&w.setZorder(y),r)(0,C.prepareLineToolPropertiesByOwnerSource)(w.properties(),r),w.setOwnerSource(r);else{const t=e.ownerSource?this.dataSourceForId(e.ownerSource):null;w.setOwnerSource(t)}return w.isFixed()&&w.restoreFixedPoint(),void 0!==e.sharingMode&&w.share(e.sharingMode),this._addSourceToCollections(w,o),this._cachedOrderedSources.clear(),w}restoreStudy(e,t,s,o,r,n){var a,l;if(t&&void 0===e.data&&void 0===e.nonSeriesData&&void 0===e.indexes)return ct.logError("Cannot restore (skipping) study without data "+e.id+", "+e.metaInfo.id),null;const c=e.id,h=e.state,u=e.zorder;s=null!=s?s:this._model.mainSeries().id();const p=(null!==(a=e.parentSources)&&void 0!==a?a:e.ownerSource?[e.ownerSource]:[]).filter((e=>e!==s));let _=new he.StudyMetaInfo(e.metaInfo);if(function(e){return"Script$TV_EARNINGS@tv-scripting"===e||"Script$TV_DIVIDENDS@tv-scripting"===e||"Script$TV_SPLITS@tv-scripting"===e||"ESD$TV_EARNINGS@tv-scripting"===e||"ESD$TV_DIVIDENDS@tv-scripting"===e||"ESD$TV_SPLITS@tv-scripting"===e||"Earnings@tv-basicstudies"===e||"Dividends@tv-basicstudies"===e||"Splits@tv-basicstudies"===e||"BarSetContinuousRollDates@tv-corestudies"===e}(_.id)&&!t)return ct.logNormal("Skipping study "+_.id),null;let g=h;const S=new M.StudyStub(this._model,e,null!==(l=_.shortDescription)&&void 0!==l?l:_.name);S.setId(c),S.setZorder(u);let v=!1;const f=(i,s)=>{if(v&&this._model.dataSourceForId(c)!==S)return;S.setStatus({type:Xe.StudyStatusType.Undefined});const o=null!=i?i:_,r=Je.DeferredStudies.instance(this._model),a=async a=>{var l;const d=(0,x.prepareStudyPropertiesForLoadChart)(_,i,g,s),h=await(0,O.createStudy)(this._model,d,a,o,void 0,n);if(h.setId(c),h.setOwnFirstValue(null!==(l=e.ownFirstValue)&&void 0!==l?l:null),e.customFields&&h.restoreStateCustomFields(e.customFields),t){const t=e,{data:i,nsData:s,indexes:o}=lt.StudyVersioning.patchStudyData(_,t.data,t.nonSeriesData,t.indexes);h.restoreData(i,s,o)}this._model.replaceStudyStub(S,h),r.add(c,h)};if(p.length>0){const e=p.map((e=>r.get(e)));Promise.all(e).then(a)}else a([])};let b;if(t){
const e=lt.StudyVersioning.patchPropsStateAndMetaInfo(h,_,{oldShowStudyLastValueProperty:!(null==o?void 0:o.showStudyLastValueProperty)});b=Promise.resolve(new he.StudyMetaInfo(e.metaInfo))}else{b=(0,N.studyMetaInfoRepository)().requestMetaInfo().then((()=>i.e(37819).then(i.bind(i,749072)).then((e=>{const{pineIdForJavaId:i,migrateJavaStateToPine:s}=e,r=i(_.id);if(r)return(0,N.studyMetaInfoRepository)().findById({pineId:r,pineVersion:"last",type:"pine"}).then((e=>(s(h,_,e),_=e,m.emit("chart_migrated"),e)));{const e=lt.StudyVersioning.patchPropsStateAndMetaInfo(h,_,{oldShowStudyLastValueProperty:t&&!(null==o?void 0:o.showStudyLastValueProperty)});return g=e.propsState,new he.StudyMetaInfo(e.metaInfo)}}))))}b.then((e=>{var t;const i=this._model.isSnapshot()?new lt.StudyVersioning([],[]):(0,N.studyMetaInfoRepository)().studyVersioning();if(null===e||this._model.isSnapshot())return void f(e,i);const s=i.updateMetaInfoAsync(e);s.sync?f(null!==(t=s.result)&&void 0!==t?t:e,i):s.result.then((e=>f(e,i))).catch((e=>S.setFailed("error: "+e)))})).catch((()=>S.setFailed(d.t(null,void 0,i(411768))))),S.setZorder(u);const y=e.metaInfo.linkedToSeries?this._model.mainSeries():p.length?this.dataSourceForId(p[0]):null;return S.setOwnerSource(y),this._addSourceToCollections(S,r),v=!0,this._processMainSourceChange(),this._cachedOrderedSources.clear(),S}clipboardLineToolOwnerSource(e){const t=this.dataSourceForId(e);if(null!==t){const e=t.ownerSource();if(null!==e&&null!==e.firstValue())return e}const i=this.mainDataSource();if(null!==i&&null!==i.firstValue())return i;for(const e of this.dataSources())if((0,fe.isPriceDataSource)(e)&&null!==e.firstValue())return e;return null}realignLineTools(e){var t;let i=!1;for(const s of this.m_dataSources)!(0,C.isLineTool)(s)||void 0!==e&&(null===(t=null==s?void 0:s.ownerSource())||void 0===t?void 0:t.symbolSource())!==e&&(0,Ae.isActingAsSymbolSource)(e)||(s.realign(),s.updateAllViews((0,nt.sourceChangeEvent)(s.id())),i=!0);return i&&this._invalidateSourcesCache(),i}startScalePrice(e,t){e.startScale(t)}scalePriceTo(e,t){e.scaleTo(t),this.updateAllViews((0,nt.viewportChangeEvent)())}endScalePrice(e){e.endScale()}startScrollPrice(e,t){e.startScroll(t)}scrollPriceTo(e,t){e.scrollTo(t),this.updateAllViews((0,nt.viewportChangeEvent)())}endScrollPrice(e){e.endScroll()}resetPriceScale(e){const t=this.timeScale().visibleBarsStrictRange();e.resetScaleAvailable().value()&&e.resetScale(),e.recalculatePriceRange(t),this.updateAllViews((0,nt.viewportChangeEvent)())}resetPriceScalesAvailable(){return this._resetPriceScalesAvailable.readonly()}restorePriceScaleState(e,t){e.restoreState(t),this.updateAllViews((0,nt.viewportChangeEvent)())}beginInsertManyLineDataSources(){this._isInInsertManyDataSourcesState=!0,this._lastLineDataSourceZOrder=null}endInsertManyLineDataSources(){this._isInInsertManyDataSourcesState=!1,this._lastLineDataSourceZOrder=null;{const e=(0,n.ensureNotNull)(this.model().alertsWatcher());for(const t of this.m_dataSources)e.syncSourceAlertLabels(t)}}removeSourceFromPriceScale(e){
const t=e.priceScale();if(null!==t){const i=t.dataSources();i.indexOf(e)>=0&&t.removeDataSource(e),0===i.length&&this.removePriceScale(t)}}_invalidateSourcesCache(){this._cachedOrderedSources.clear(),this._leftPriceScales.forEach((e=>e.invalidateSourcesCache())),this._rightPriceScales.forEach((e=>e.invalidateSourcesCache()))}_processMainSourceChange(){let e=!1;if(null===this.m_mainDataSource)for(const t of this.m_dataSources)if((0,fe.isPriceDataSource)(t)&&!this.isOverlay(t)&&(!(0,O.isStudy)(t)||!t.isLinkedToSeries())){this.m_mainDataSource=t,e=!0;break}if(this.m_mainDataSource&&e){let e=this.m_dataSources.filter(C.isLineTool);e=(0,be.sortSources)(e);for(const t of e)this.move(t,(0,n.ensureNotNull)(this.m_mainDataSource.priceScale()),!0)}else if(!this.m_mainDataSource||this.isOverlay(this.m_mainDataSource)&&0===this._nonOverlayPricesSourcesCount()){let e=null;if(this.m_dataSources.includes(this._model.mainSeries()))e=this._model.mainSeries();else for(const t of this.m_dataSources)if((0,fe.isPriceDataSource)(t)&&this.isOverlay(t)&&t.showInObjectTree()){e=t;break}if(null!==e){const t=this.m_mainDataSource===e;this.m_mainDataSource=e;const i=this.createNewPriceScaleIfPossible();if(t&&e===this._model.mainSeries()){const t=(0,n.ensureNotNull)(e.priceScale());this._model.children(e,!0).forEach((e=>{this.removeSourceFromPriceScale(e),i.addDataSource(e),e.setPriceScale(i)})),this.removePriceScale(t)}this.move(e,i,!0),this.recalculatePriceScale(e.priceScale(),(0,nt.globalChangeEvent)())}}}_addSourceToCollections(e,t){this.m_dataSources.push(e),this._sourcesById.set(e.id(),e),this._invalidateSourcesCache();const i=()=>{this._sourcePropertiesChanged.fire(e)};e.properties().subscribe(this,i),e.zOrderChanged().subscribe(this,(t=>this._sourcesZOrderChanged.fire(e,t))),(0,C.isLineTool)(e)&&(e.normalizedPointsChanged().subscribe(this,i),e.fixedPointChanged().subscribe(this,i),e.hasAlert().subscribe(i),e.sharingMode().subscribe(i),e.linkKey().subscribe(i),this._sourceWatchedValuesSubscriptions.set(e.id(),i));const s=(0,Ae.isSymbolSource)(e)?e:null;if((0,fe.isPriceDataSource)(e)&&(this._priceSourcesById.set(e.id(),e),e.currencyChanged().subscribe(this,(()=>this._invalidateSourcesCache())),e.unitChanged().subscribe(this,(()=>this._invalidateSourcesCache())),this._priceDataSources.push(e),this._onPriceSourcesCollectionChanged(),null!==s&&(this._symbolSources.push(s),s.symbolResolved().subscribe(this,(()=>this._symbolSourceResolved.fire(e))),s.symbolResolvingActive().subscribe(this._recalcSymbolSourceResolvingActive),s.symbolHibernated().subscribe(this._onSymbolSourceCollectionChanged),this._recalcSymbolSourceResolvingActive(),this._onSymbolSourceCollectionChanged()),(0,O.isStudy)(e)||(0,O.isStudyStub)(e))){const t=e.metaInfo();t&&(0,ve.isCountedUserScript)(t)&&(0,ve.addUserScriptOnLayout)(t.scriptIdPart,(0,n.ensureDefined)(t.pine).version)}e.isMultiPaneAvailable()&&this.model().addMultiPaneSource(e),(0,ge.isLollipopDataSource)(e)&&(this._lollipopDataSources.push(e),this.updateLollipopViews((0,nt.sourceChangeEvent)(e.id()))),
t||0!==this._bulkActions.activeCounter||this._dataSourcesCollectionChanged.fire()}_removeSourceFromCollections(e,t){const i=this.m_dataSources[e],s=i.id();if(i.properties().unsubscribeAll(this),i.zOrderChanged().unsubscribeAll(this),this.m_dataSources.splice(e,1),this._sourcesById.delete(i.id()),(0,C.isLineTool)(i)&&(i.normalizedPointsChanged().unsubscribeAll(this),i.fixedPointChanged().unsubscribeAll(this),this._sourceWatchedValuesSubscriptions.has(s))){const e=this._sourceWatchedValuesSubscriptions.get(s);i.hasAlert().unsubscribe(e),i.linkKey().unsubscribe(e)}this._invalidateSourcesCache();const o=(0,Ae.isSymbolSource)(i)?i:null;if((0,fe.isPriceDataSource)(i)&&(this._priceSourcesById.delete(i.id()),i.currencyChanged().unsubscribeAll(this),i.unitChanged().unsubscribeAll(this),(0,b.removeItemFromArray)(this._priceDataSources,i),this._onPriceSourcesCollectionChanged(),null!==o&&((0,b.removeItemFromArray)(this._symbolSources,o),o.symbolResolved().unsubscribeAll(this),o.symbolResolvingActive().unsubscribe(this._recalcSymbolSourceResolvingActive),o.symbolHibernated().unsubscribe(this._onSymbolSourceCollectionChanged),this._recalcSymbolSourceResolvingActive(),this._onSymbolSourceCollectionChanged()),(0,O.isStudy)(i)||(0,O.isStudyStub)(i))){const e=i.metaInfo();e&&(0,ve.isCountedUserScript)(e)&&(0,ve.removeUserScriptFromLayout)(e.scriptIdPart,(0,n.ensureDefined)(e.pine).version)}i.isMultiPaneAvailable()&&this.model().removeMultiPaneSource(i),(0,ge.isLollipopDataSource)(i)&&((0,b.removeItemFromArray)(this._lollipopDataSources,i),this.updateLollipopViews((0,nt.sourceChangeEvent)(i.id()))),t||0!==this._bulkActions.activeCounter||this._dataSourcesCollectionChanged.fire()}_recalculatePriceScaleByScaleRatio(e){this.isMainPane()&&e===this._lockedPriceScale&&(null!==this._currentPriceScaleRatio?this._applyOldScaleRatioToPriceScale():this._tryToApplyNewPriceScaleRatio())}_defaultBottomMargin(){return.01*this.properties().childs().bottomMargin.value()}_defaultTopMargin(){return.01*this.properties().childs().topMargin.value()}_updateMargins(){const e=this._defaultTopMargin(),t=this._defaultBottomMargin();for(const i of this._leftPriceScales)dt(i,e,t);for(const i of this._rightPriceScales)dt(i,e,t);for(const i of this.m_dataSources)if(this.isOverlay(i)){const s=i.priceScale();null!==s&&(dt(s,e,t),this.recalculatePriceScale(s,(0,nt.viewportChangeEvent)()))}for(const e of this._leftPriceScales)this.recalculatePriceScale(e,(0,nt.viewportChangeEvent)());for(const e of this._rightPriceScales)this.recalculatePriceScale(e,(0,nt.viewportChangeEvent)());this.updateAllViews((0,nt.viewportChangeEvent)())}_batchReorder(e,t,i){i(this.sourcesByGroup().allExceptSpecialSources(),e,t),this._invalidateSourcesCache(),this._dataSourcesCollectionChanged.fire(),this.model().fullUpdate()}_placePriceScale(e,t,i){if("overlay"===t)return void e.invalidateMargins();const s="left"===t?this._leftPriceScales:this._rightPriceScales,o=void 0===i?s.length:i;s.splice(o,0,e),e.modeChanged().subscribe(this,this._onPriceScaleModeChanged.bind(this,e)),
e.internalHeightChanged().subscribe(this,this._recalculatePriceScaleByScaleRatio.bind(this,e)),e.priceRangeChanged().subscribe(this,this._recalculateTimeScaleByScaleRatio.bind(this,e)),e.priceRangeChanged().subscribe(this,this._onPriceScaleSetMinMaxPriceRange.bind(this,e)),e.isVisible().subscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().subscribe(this._updateResetPriceScalesAvailableValue),e.isLockScale()&&((0,n.assert)(null===this._lockedPriceScale),this._lockedPriceScale=e,this._currentPriceScaleRatio=null),e.invalidateMargins(),this._onPriceScalesChanged.fire(),this._updateResetPriceScalesAvailableValue()}_onPriceScaleModeChanged(e,t,i){if(i.lockScale&&(this._lockedPriceScale!==e&&null!==this._lockedPriceScale&&this._lockedPriceScale.setMode({lockScale:!1}),this._lockedPriceScale=e,this._currentPriceScaleRatio=(0,Ke.scaleRatio)(this.timeScale(),e)),t.lockScale&&!i.lockScale&&(this._lockedPriceScale=null,this._currentPriceScaleRatio=null),t.percentage===i.percentage&&t.indexedTo100===i.indexedTo100)return;const s=this.timeScale().visibleBarsStrictRange();null!==s&&(e.recalculatePriceRange(s),e.updateAllViews((0,nt.viewportChangeEvent)()))}_applyOldScaleRatioToPriceScale(){this._isRecalculatingScales||null===this._currentPriceScaleRatio||null===this._lockedPriceScale||(this._isRecalculatingScales=!0,this._setNewPriceRangeByScaleRatio(this._lockedPriceScale,this._currentPriceScaleRatio,this._mainSourceVisiblePriceRange(this._lockedPriceScale)),this._isRecalculatingScales=!1)}_setNewPriceRangeByScaleRatio(e,t,i,s,o){const r=(0,Ke.priceRangeByScaleRatio)(e,this.timeScale().barSpacing(),t);e.setPriceRange(null!==r?r:i,s,o)}_applyOldScaleRatioToTimeScale(){this._isRecalculatingScales||null===this._currentPriceScaleRatio||(this._isRecalculatingScales=!0,this._setNewBarSpacingByScaleRatio(),this._isRecalculatingScales=!1)}_tryToApplyNewPriceScaleRatio(){const e=(0,n.ensureNotNull)(this._lockedPriceScale),t=(0,Ke.scaleRatio)(this.timeScale(),e);this._currentPriceScaleRatio===t||e.isLog()||(this._currentPriceScaleRatio=t,this.model().mainSeriesScaleRatioPropertyOnChanged())}_recalculateTimeScaleByScaleRatio(e){e===this._lockedPriceScale&&(null!==this._currentPriceScaleRatio?this._applyOldScaleRatioToTimeScale():this._tryToApplyNewPriceScaleRatio())}_setNewBarSpacingByScaleRatio(){const e=this.timeScale().getValidBarSpacing((0,Ke.barSpacingByScaleRatio)((0,n.ensureNotNull)(this._lockedPriceScale),this._currentPriceScaleRatio));this.timeScale().isValidBarSpacing(e)&&this.timeScale().setBarSpacing(e)}_mainSourceVisiblePriceRange(e){const t=this.timeScale().visibleBarsStrictRange();return null!==t?(0,n.ensureNotNull)((0,n.ensureNotNull)(e.mainSource()).priceRange(t.firstBar(),t.lastBar(),{targetPriceScale:e,scaleSeriesOnly:e.isScaleSeriesOnly()})):new xe.PriceRange(-.5,.5)}_setMinMaxPriceRange(){const e=(0,n.ensureNotNull)(this._lockedPriceScale),t=(0,Ke.priceRangeByScaleRatio)(e,this.timeScale().maxBarSpacing(),this._currentPriceScaleRatio),i=(0,
Ke.priceRangeByScaleRatio)(e,this.timeScale().minBarSpacing(),this._currentPriceScaleRatio);null!==t&&e.setMaxPriceRange(t),null!==i&&e.setMinPriceRange(i)}_onPriceScaleSetMinMaxPriceRange(e){e===this._lockedPriceScale&&this._setMinMaxPriceRange()}_onPriceSourcesCollectionChanged(){0===this._bulkActions.activeCounter?this._priceSourcesCollectionChanged.fire():this._bulkActions.priceSourcesCollectionChanged=!0}_nonOverlayPricesSourcesCount(){return this.m_dataSources.filter((e=>(!(0,O.isStudy)(e)||!e.isLinkedToSeries())&&((0,fe.isPriceDataSource)(e)&&e.showInObjectTree()&&!this.isOverlay(e)))).length}_restoreMainSeries(e,t,i,s,o,r){var a,l,c;const d=e.id,h=e.state;if(h&&o&&(h.style=null!==(a=o.style)&&void 0!==a?a:h.style,h.interval=o.interval||h.interval,o.symbol&&o.symbol!==h.symbol&&(h.symbol=o.symbol,delete h.currencyId,delete h.unitId)),h&&["candleStyle","hollowCandleStyle","haStyle"].forEach((e=>{h[e]&&(h[e].wickUpColor=h[e].wickUpColor||h[e].wickColor,h[e].wickDownColor=h[e].wickDownColor||h[e].wickColor)})),h&&(h.statusViewStyle=h.statusViewStyle||{},!h.statusViewStyle.symbolTextSource)){const e=!!h.statusViewStyle.showSymbolAsDescription;h.statusViewStyle.symbolTextSource=e?"ticker":"description"}if(h){h.extendedHours?h.sessionId="extended":h.sessionId||(h.sessionId="regular"),delete h.extendedHours,(0,at.allChartStyles)().includes(h.style)||(h.style=2);const e=h.lineStyle.styleType;let t;delete h.lineStyle.styleType,0===e&&(t=14,h.lineWithMarkersStyle=(0,ue.clone)(h.lineStyle)),1===e&&(t=15,h.steplineStyle=(0,ue.clone)(h.lineStyle)),void 0!==t&&2===h.style&&(h.style=t)}if(!i){const e=this._model.mainSeries();(0,n.ensureNotNull)(this._model.mainPane()).removeDataSource(e,!1,r),this._addSourceToCollections(e,r)}const u=this.model().mainSeries(),p=u.properties().childs();this.m_mainDataSource=u;const _=h&&h.style?h.style:void 0;6===_&&"ATR"===p.pnfStyle.childs().inputs.childs().style.value()?p.pnfStyle.childs().inputs.childs().style.setValueSilently("Traditional"):4===_&&"ATR"===p.renkoStyle.childs().inputs.childs().style.value()&&p.renkoStyle.childs().inputs.childs().style.setValueSilently("Traditional"),h&&!h.hasOwnProperty("showSessions")&&(h.showSessions=!1),h&&void 0===h.settlementAsClose&&(h.settlementAsClose=!1),h&&t&&(h.showCountdown=!1),h&&(t&&!("showSeriesLastValueProperty"in s)&&"showLastValue"in h&&this._model.properties().childs().scalesProperties.childs().showSeriesLastValue.setValue(h.showLastValue),delete h.showLastValue),h&&this._restoreMainSeriesStudyInputs(e,u.styleStudyInfos());const m=u.sessionId();null===(l=(0,ce.getPersistentLogger)())||void 0===l||l.addPersistentLogEntry(`Restore series. source.id: ${e.id} id: ${d}`,ae.LOGLEVEL.INFO,ht),u.restoreState(e,t),this.changeSourceId(u,d),null===(c=(0,ce.getPersistentLogger)())||void 0===c||c.addPersistentLogEntry(`Series has been successfully restored. id: ${u.id()}`,ae.LOGLEVEL.INFO,ht),u.sessionId()!==m&&p.sessionId.listeners().fire(p.sessionId,"")}async _restoreMainSeriesStudyInputs(e,t){var i;await(0,
N.studyMetaInfoRepository)().requestMetaInfo();const s=(0,N.studyMetaInfoRepository)().studyVersioning(),o={haStyle:(0,ke.chartStyleStudyId)(8,!0),renkoStyle:(0,ke.chartStyleStudyId)(4,!0),pbStyle:(0,ke.chartStyleStudyId)(7,!0),kagiStyle:(0,ke.chartStyleStudyId)(5,!0),pnfStyle:(0,ke.chartStyleStudyId)(6,!0),rangeStyle:(0,ke.chartStyleStudyId)(11,!0),volFootprintStyle:(0,ke.chartStyleStudyId)(17,!0),tpoStyle:(0,ke.chartStyleStudyId)(18,!0),svpStyle:(0,ke.chartStyleStudyId)(20,!0)},r={},a=(0,n.ensureDefined)(e.state);for(const[n]of Object.entries($e.SYMBOL_STRING_DATA)){const l=`${$e.STYLE_SHORT_NAMES[n]}Style`,c=null===(i=a[l])||void 0===i?void 0:i.inputs;if(null==c)continue;const d=l in e?e[l].studyId:o[l],h=he.StudyMetaInfo.parseIdString(d),u=t[l].studyId,p=he.StudyMetaInfo.parseIdString(u),_=s.updateStudyInputs(h.id,h.version,p.version,c.inputs,null);r[l]={inputs:_}}this.model().mainSeries().properties().mergeAndFire(r)}_restoreSpecialSource(e,t,i){"ChartEventsSource"===e.type&&t&&this._model.restoreChartEvents(e)}}var pt=i(930203),_t=i(45003),mt=i(331218),gt=i(764921);const St=(0,ae.getLogger)("Chart.TimePoints");function vt(e,t){return null===e||null===t?e===t:e.firstIndex===t.firstIndex&&e.lastIndex===t.lastIndex}class ft{constructor(){this._zoffset=0,this._items=[],this._range=new F.WatchedObject(null,vt)}clear(){this._zoffset=0,this._items=[],this._range.setValue(null)}size(){return this._items.length}range(){return this._range.readonly()}merge(e,t,i){const s=this._mergeImpl(e,t,i);return this._updateFirstAndLastIndex(),s}addTail(e,t){for(let i=t?1:0;i<e.length;i++)this._items.push(e[i]);this._updateFirstAndLastIndex()}remove(e){const t=this._indexToOffset(e);if(null===t)return[];const i=this._items.splice(t),s=[];for(let t=0;t<i.length;t++)s.push({change:"remove",index:e+t,value:i[t]});return this._updateFirstAndLastIndex(),s}valueAt(e){const t=this._indexToOffset(e);return null!==t?this._items[t]:null}indexOf(e,t){if(this._items.length<1)return null;if(e>this._items[this._items.length-1])return t?this._validOffsetToIndex(this._items.length-1):null;for(let i=0;i<this._items.length;++i){if(e===this._items[i])return this._validOffsetToIndex(i);if(e<this._items[i])return t?this._validOffsetToIndex(i):null}return null}state(e){var t,i;let s=0,o=this._items.length;return null!==e&&(s=null!==(t=this._indexToOffset(e.firstBar()))&&void 0!==t?t:0,o=(null!==(i=this._indexToOffset(e.lastBar()))&&void 0!==i?i:o-1)+1),{items:this._items.slice(s,o),zoffset:this._zoffset-s}}restoreState(e){null!==e&&(this._items=e.items,this._zoffset=e.zoffset,this._updateFirstAndLastIndex())}roughTime(e,t=null){e=Math.round(e);const i=this.valueAt(e);if(null!==i)return i;const s=this._items;if(!s.length||s.length<2)return null;const o=s.length-1,r=this._validOffsetToIndex(0),n=this._validOffsetToIndex(o),a=s[0],l=s[o],c=(l-a)/(n-r);if(e<r){return a-(r-e)*c}if(e>n){const i=e-n;if(i<500&&null!=t)return t(l,i);return l+i*c}return null}roughIndex(e,t=null){const i=this._items;if(!i.length||i.length<2)return null
;const s=i.length-1,o=this._validOffsetToIndex(0),r=this._validOffsetToIndex(s),n=i[0],a=i[s];if(e>=n&&e<=a)return this.closestIndexLeft(e);const l=(a-n)/(r-o);if(e<n){const t=n-e;return o-Math.round(t/l)}if(e>a){const i=e-a;let s=Math.trunc(i/l);if(s<500&&null!==t){const i=t(a,e);i.success&&(s=i.result)}return r+s}return null}closestIndexLeft(e){const t=this._items;if(!t.length)return null;if(Number.isNaN(e))return null;let i=t.length-1;if(e>=t[i])return this._validOffsetToIndex(i);let s=0;const o=t[s];if(e<o)return null;if(e===o)return this._validOffsetToIndex(s);for(;i>s+1;){const o=s+i>>1,r=t[o];if(r>e)i=o;else{if(!(r<e))return r===e?this._validOffsetToIndex(o):null;s=o}}return this._validOffsetToIndex(s)}_mergeImpl(e,t,i){if(0===i.length)return St.logError("merge: 'values' does not contain any time points"),[];if(t>this._zoffset&&e+t>0)return St.logError("merge: when the first time point index is updated, we should fill the time points starting from the first one"),[];if(0===this._items.length)return this._items=i.slice(),this._zoffset=t,[{change:"rebuild",index:this._validOffsetToIndex(0)}];const s=e+this._zoffset;if(s<0){const o=Math.abs(s);if(i.length<o)return St.logError("merge: 'values' does not contain enough time points to fill in the new items. 'index': "+e.toString()+", previous 'zoffset': "+this._zoffset.toString()+", new 'zoffset': "+t.toString()+", 'values.length': "+i.length),[];this._items=new Array(o).concat(this._items),this._zoffset=t;for(let s=0;s<i.length;++s)this._items[e+s+t]=i[s];return[{change:"rebuild",index:this._validOffsetToIndex(0)}]}const o=[];let r=s;for(;r<this._items.length&&r-s<i.length;++r)this._items[r]=i[r-s],o.push({change:"update",index:this._validOffsetToIndex(r),value:i[r-s]});const n=s+i.length;if(n>this._items.length){const e=n-this._items.length;for(let t=r;t<r+e;++t){const e=this._items.length;this._items.push(i[t-s]),o.push({change:"append",index:this._validOffsetToIndex(e),value:i[t-s]})}}else{for(let e=n;e<this._items.length;++e)o.push({change:"remove",index:this._validOffsetToIndex(e),value:this._items[e]});this._items.length=n}return this._zoffset=t,o}_updateFirstAndLastIndex(){const e=this._offsetToIndex(0),t=this._offsetToIndex(this._items.length-1);this._range.setValue(null===e||null===t?null:{firstIndex:e,lastIndex:t})}_validOffsetToIndex(e){return e-this._zoffset}_offsetToIndex(e){return 0<=e&&e<this.size()?this._validOffsetToIndex(e):null}_indexToOffset(e){const t=e+this._zoffset;return 0<=t&&t<this.size()?t:null}}var bt=i(501571);const yt=new Map([[0,.1],[11,.1],[1,.35],[9,.35],[12,.35],[8,.35]]);class Ct{constructor(e,t){this._styleSpecificRanges=new Map,this._logicalRange=e,this._defaultStyle=t}strictRange(e){if(null===this._logicalRange)return null;void 0===e&&(e=this._defaultStyle);let t=this._styleSpecificRanges.get(e);if(void 0===t){const i=(yt.get(e)||0)/2;t=new mt.BarsRange(Math.floor(this._logicalRange.left()+i),Math.ceil(this._logicalRange.right()-i)),this._styleSpecificRanges.set(e,t)}return t}logicalRange(){return this._logicalRange}isValid(){
return null!==this._logicalRange}static invalid(){return new Ct(null,1)}}var wt=i(944843),Tt=i(596673);class Pt{constructor(e,t=50){this._actualSize=0,this._usageTick=1,this._oldestTick=1,this._cache=new Map,this._tick2Labels=new Map,this._format=e,this._maxSize=t}format(e){const t=this._cache.get(e.valueOf());if(void 0!==t)return t.string;if(this._actualSize===this._maxSize){const e=this._tick2Labels.get(this._oldestTick);this._tick2Labels.delete(this._oldestTick),this._cache.delete((0,n.ensureDefined)(e)),this._oldestTick++,this._actualSize--}const i=this._format(e);return this._cache.set(e.valueOf(),{string:i,tick:this._usageTick}),this._tick2Labels.set(this._usageTick,e.valueOf()),this._actualSize++,this._usageTick++,i}}var Mt=i(339709);let xt;var It=i(220003),Lt=i(300484),At=i(69184),kt=i(518439),Et=i(848891);class Dt{constructor(){this._baseIndex=0}setBaseIndex(e){this._baseIndex=e}indexToTotalWeight(e){return e-this._baseIndex}totalWeightToIndex(e){return this._baseIndex+e}indexRangeToWeights(e,t,i){const s=e-this._baseIndex;return[{left:s-.5,center:s,right:s+.5,timePointIndex:e}]}state(e){return{type:"constant",state:{baseIndex:this._baseIndex}}}restoreState(e){this._baseIndex=e.state.baseIndex}needAdjustingOnDataRestoring(){return!1}}var Bt=i(655988);const Nt={preserveBarSpacing:!1,lockVisibleTimeRangeOnResize:!1,rightBarStaysOnScroll:!0,minBarSpacing:.5},Rt=ne.enabled("low_density_bars"),Ot=Rt?1:2,Vt=(0,ae.getLogger)("Chart.TimeScale");class Wt{constructor(e,t){this._width=0,this._widthChanged=new V.Delegate,this._rightOffset=10,this._rightOffsetChanged=new V.Delegate,this._maxRightOffsetChanged=new V.Delegate,this._defaultRightOffset=new W.WatchedValue(10),this._defaultRightOffsetPercentage=new W.WatchedValue(5),this._usePercentageRightOffset=new W.WatchedValue(!1),this._lastDefaultRightOffset=void 0,this._baseIndex=null,this._leftEdgeIndex=null,this._barSpacingChanged=new V.Delegate,this._barSpacing=6,this._snapshotBarSpacing=null,this._visibleBars=Ct.invalid(),this._visibleBarsInvalidated=!0,this._visibleBarsChanged=new V.Delegate,this._logicalRangeChanged=new V.Delegate,this._points=new ft,this._tickMarks=new wt.Tickmarks,this._onScroll=new V.Delegate,this._resetDelegate=new V.Delegate,this._scrollData=null,this._scaleStartPoint=null,this._commonTransitionStartState=null,this._formattedBySpan=new Map,this._requestingMoreData=!1,this._requestedTickmarksCount=0,this._endOfData=!1,this._lockBarsAndLogicalRangeEvents=!1,this._resetAvailable=new W.WatchedValue(!1),this._pointWeights=new Dt,this._weightedPointsCache=[],this._options=(0,_t.deepExtend)({},Nt,t),this._model=e,this._scalesProperties=e.properties().childs().scalesProperties,this._defaultRightOffset.subscribe((()=>{this._usePercentageRightOffset.setValue(!1),this._defaultRightOffsetOptionsUpdated()})),this._defaultRightOffsetPercentage.subscribe((e=>{if(e>=100||e<0){const t=Math.max(0,Math.min(e,99));this._defaultRightOffsetPercentage.setValue(t)}else this._usePercentageRightOffset.setValue(!0),this._defaultRightOffsetOptionsUpdated()})),
this._usePercentageRightOffset.subscribe((()=>{this._defaultRightOffsetOptionsUpdated()})),this._options.preserveBarSpacing&&(this._barSpacing=this._scalesProperties.childs().barSpacing.value()||6),this._barSpacingChanged.subscribe(this,this._maxRightOffsetOnChanged),this._barSpacingChanged.subscribe(this,this._updateResetAvailableValue),this._rightOffsetChanged.subscribe(this,this._updateResetAvailableValue),this._widthChanged.subscribe(this,this._maxRightOffsetOnChanged),this._updateResetAvailableValue()}destroy(){this._barSpacingChanged.unsubscribeAll(this),this._barSpacingChanged.destroy(),this._widthChanged.unsubscribeAll(this),this._widthChanged.destroy()}isEmpty(){return 0===this._width||!this.canNormalize()}canNormalize(){return this._points.size()>0}update(e,t,i,s){this._visibleBarsInvalidated=!0,i.length>0&&this._points.merge(e,t,i),this._tickMarks.merge(s),this.correctOffset()}addTail(e,t,i){this._tickMarks.removeTail(t);const s=e.params,o=(0,n.ensureDefined)(this._tickMarks.maxIndex)+(i?0:1);for(let e=0;e<s.marks.length;e++)s.marks[e].index=o+e;this._tickMarks.addTail(s.marks),this._points.addTail(s.changes,i);const r=this._rightOffset-s.changes.length;this._updateRightOffset(r)}state(e){const t={m_barSpacing:this.barSpacing(),m_rightOffset:this._defaultRightOffset.value(),rightOffsetPercentage:this._defaultRightOffsetPercentage.value(),usePercentageRightOffset:this._usePercentageRightOffset.value()};if(e){t.m_rightOffset=Math.max(0,this._rightOffset);const e=this.visibleBarsStrictRange(),i=this.visibleExtendedDataRange(this._model.mainSeries().data(),0),s=e?e.unite(i):i;t.points=this._points.state(s),t.tickmarks=this._tickMarks.state(s),t.width=this._width,t.weights=this._pointWeights.state(s),t.baseIndex=this._baseIndex}return t}restoreState(e,t){var i;if(void 0===e.m_barSpacing)return void Vt.logDebug("restoreState: invalid state");if(void 0===e.m_rightOffset)return void Vt.logDebug("restoreState: invalid state");e.weights&&(this._pointWeights=function(e){let t;switch(e.type){case"constant":return t=new Dt,t.restoreState(e),t;case"computed":return t=new Bt.ComputedTimePointWeights,t.restoreState(e),t}throw new Error(`Unexpected time point weigths type ${e.type}`)}(e.weights));let s=e.m_barSpacing;this._snapshotBarSpacing=t?s:null;const o=e.m_rightOffset<0&&!t?this.rightOffsetDefaultValue():e.m_rightOffset,r=o<0?this.rightOffsetDefaultValue():Math.round(o);if(this._defaultRightOffset.setValue(r),void 0!==e.rightOffsetPercentage&&Number.isFinite(e.rightOffsetPercentage)&&this._defaultRightOffsetPercentage.setValue(e.rightOffsetPercentage),this._usePercentageRightOffset.setValue(Boolean(e.usePercentageRightOffset)),this._rightOffset=o,this._baseIndex=null!==(i=e.baseIndex)&&void 0!==i?i:this._baseIndex,t&&(this._requestedTickmarksCount=1/0,this._endOfData=!0,this._points.restoreState(e.points||null),this._tickMarks.restoreState(e.tickmarks||null),e.width&&this._width>0&&(s*=this._width/e.width)),t&&this._pointWeights.needAdjustingOnDataRestoring()){this._tryToUpdateBarSpacing(this._barSpacing,s)
;const e=this._points.range().value();if(e){const t=e.firstIndex;let i=s,o=s,r=0;(()=>{r=this.indexToCoordinate(t),r<0?(o=s,i=s/10):(i=s,o=10*s)})();for(let e=0;e<20&&Math.abs(r)>2;e++){const e=(o+i)/2;this._tryToUpdateBarSpacing(this._barSpacing,e),r=this.indexToCoordinate(t),r<0?o=e:i=e}}}else this._tryToUpdateBarSpacing(this._barSpacing,s);this.correctOffset(),this._usePercentageRightOffset.value()&&(this._rightOffset=this.percentsToBarIndexLength(this._defaultRightOffsetPercentage.value())),this._rightOffsetChanged.fire(this._rightOffset)}marks(){if(this.isEmpty())return null;const e=this._barSpacing,t=5*((this._scalesProperties.childs().fontSize.value()||0)+4),i=Math.round(t/e),s=(0,n.ensureNotNull)(this.visibleBarsStrictRange()),o=Math.max(s.firstBar(),s.firstBar()-i),r=Math.max(s.lastBar(),s.lastBar()-i),a=this._tickMarks.build(e,t),l=[];for(const e of a){if(!(o<=e.index&&e.index<=r))continue;const t=this._tickMarks.indexToTime(e.index);null!==t&&l.push({coord:this.indexToCoordinate(e.index),label:this.formatLabel(t,e.span),span:e.span,major:e.label>=Tt.DAY_SPAN})}return l}visibleBarsStrictRange(){return this._visibleBarsInvalidated&&(this._visibleBarsInvalidated=!1,this._updateVisibleBars()),this._visibleBars.strictRange()}visibleBarsStrictRangeChanged(){return this._visibleBarsChanged}visibleStrictDataRange(e){const t=this.visibleBarsStrictRange();if(null===t)return null;const i=e.search(t.firstBar(),kt.PlotRowSearchMode.NearestRight),s=e.search(t.lastBar(),kt.PlotRowSearchMode.NearestLeft);return null===i||null===s?null:new mt.BarsRange(i.index,s.index)}visibleExtendedDataRange(e,t){const i=this.visibleBarsStrictRange();if(null===i)return null;let s=1===t?null:e.search(i.firstBar()-1,kt.PlotRowSearchMode.NearestLeft),o=0===t?null:e.search(i.lastBar()+1,kt.PlotRowSearchMode.NearestRight);return null===s&&(s=e.search(i.firstBar(),kt.PlotRowSearchMode.NearestRight)),null===o&&(o=e.search(i.lastBar(),kt.PlotRowSearchMode.NearestLeft)),null===s||null===o?null:new mt.BarsRange(s.index,o.index)}logicalRangeChanged(){return this._logicalRangeChanged}tickMarks(){return this._tickMarks}points(){return this._points}width(){return this._width}setWidth(e,t){if(!Number.isFinite(e)||e<=0)return void Vt.logWarn(`setWidth: invalid argument: ${e}`);if(this._width===e)return;const i=this._usePercentageRightOffset.value()&&this._rightOffset>0?this.barIndexLengthToPercents(this._rightOffset):-1;if(this._visibleBarsInvalidated=!0,(t||this._options.lockVisibleTimeRangeOnResize)&&this._width){const t=this._barSpacing*e/this._width;this._tryToUpdateBarSpacing(this._barSpacing,t)}else this._width&&this.setBarSpacing(this._barSpacing);if(null!==this._leftEdgeIndex){if((0,n.ensureNotNull)(this.visibleBarsStrictRange()).firstBar()<=this._leftEdgeIndex){const t=this._width-e;this._rightOffset-=Math.round(t/this._barSpacing)+1}}this._width=e,this._widthChanged.fire(e);const s=this._rightOffset;i>0?this._rightOffset=this.percentsToBarIndexLength(i):this.correctOffset(),
this._rightOffset!==s&&this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}setLeftEdgeFix(e){this._leftEdgeIndex=e;const t=this.visibleBarsStrictRange();if(null===t)return;const i=t.firstBar()-e;if(i<0){const e=this._rightOffset-i-1;this.scrollToOffsetAnimated(e,500)}}indexToCoordinate(e){if(this.isEmpty())return 0;const t=this.baseIndex(),i=this._pointWeights.indexToTotalWeight(t+this._rightOffset+.5)-this._pointWeights.indexToTotalWeight(e);return this._width-i*this._barSpacing}indexToUserTime(e){return this._tickMarks.indexToTime(e)}timePointToIndex(e,t){switch(t){case 0:return this._points.indexOf(e,!1);case 1:return this._points.closestIndexLeft(e);default:return this._points.indexOf(e,!0)}}indexToTimePoint(e){return this._points.valueAt(e)}timeToCoordinate(e){const t=this._points.closestIndexLeft(e);if(null===t)return null;const i=(0,n.ensureNotNull)(this._points.valueAt(t)),s=this.indexToCoordinate(t);if(s<=0||s>=this._width)return null;const o=this.barSpacing(),r=this.baseIndex();let a;a=0===r?this._model.mainSeries().intervalObj().inMilliseconds()/1e3:(0,n.ensureNotNull)(this._points.valueAt(r))-(0,n.ensureNotNull)(this._points.valueAt(r-1));const l=s+(e-i)/a*o+1;return l<=0||l>=this._width?null:l}barBorders(e){const t={timePointIndex:e,left:NaN,center:NaN,right:NaN};return this.fillBarBorders([t]),t}fillBarBorders(e,t,i){var s,o;if(0===e.length)return;let r=null!==(s=null==t?void 0:t.startItemIndex)&&void 0!==s?s:0;const a=(null!==(o=null==t?void 0:t.endItemIndex)&&void 0!==o?o:e.length)-1;if(!0===i&&(r=(0,b.upperbound)(e,bt.UNPLOTTABLE_TIME_POINT_INDEX,((e,t)=>e<t.timePointIndex),r,a+1)),r>a)return;const l=this._pointWeights.indexToTotalWeight(this.baseIndex()+this._rightOffset+.5),c=this._pointWeights.indexRangeToWeights(e[r].timePointIndex,e[a].timePointIndex,this._weightedPointsCache);let d=0,h=c[d];const u=h,p=c[c.length-1];let _=NaN,m=NaN,g=NaN,S=!0;for(let t=r;t<=a;t+=1){const i=e[t];if(i.timePointIndex<u.timePointIndex)_=u.left-(u.timePointIndex-i.timePointIndex),m=_+.5,g=_+1;else if(i.timePointIndex>p.timePointIndex)g=p.right+(i.timePointIndex-p.timePointIndex),m=g-.5,_=g-1;else for(S&&(_=h.left,m=h.center,g=h.right,S=!1);h.timePointIndex<i.timePointIndex;)d+=1,(0,n.assert)(d<c.length,"Bar borders coordinates are not correct"),h=c[d],_=h.left,m=h.center,g=h.right;i.left=this._width-(l-_)*this._barSpacing,i.center=this._width-(l-m)*this._barSpacing,i.right=this._width-(l-g)*this._barSpacing}}timedValuesToCoordinates(e,t,i){var s,o;const r=this._pointWeights.indexToTotalWeight(this.baseIndex()+this._rightOffset+.5),n=null!==(s=null==t?void 0:t.startItemIndex)&&void 0!==s?s:0;let a=n;const l=null!==(o=null==t?void 0:t.endItemIndex)&&void 0!==o?o:e.length;!0===i&&(a=(0,b.upperbound)(e,bt.UNPLOTTABLE_TIME_POINT_INDEX,((e,t)=>e<t.x),n,l));for(let t=a;t<l;++t){const i=e[t],s=r-this._pointWeights.indexToTotalWeight(i.x);i.x=this._width-s*this._barSpacing}for(let t=n;t<a;++t)e[t].x=-500}rightOffsetForTimePoint(e){const t=this.timeToCoordinate(e);if(null===t)return null
;const i=(t-this._baseIndexBarCenterCoordinate())/this._barSpacing;return this._pointWeights.totalWeightToIndex(i)}scrollToRealtime(e,t){let i=this.targetDefaultRightOffset();i<0&&(i=this.rightOffsetDefaultValue());const s=()=>{void 0!==t&&t(),this._requestMoreData()};if(e){const e=this.logicalRange(),t=this._model.mainSeries().bars().lastIndex();if(null===e||null===t)return;const i=this.indexToCoordinate(e.right()+.5),o=this.indexToCoordinate(t+this._defaultRightOffset.value()+.5);return this._model.stopTimeScaleAnimation(),void this._model.setTimeScaleAnimation(new Et.Animation({from:0,to:i-o,duration:1e3,easing:pt.easingFunc.easeInOutQuint,onFinish:s}))}this._visibleBarsInvalidated=!0,this._updateRightOffset(i),this._onScroll.fire(),s()}scrollToFirstBar(e=(()=>{})){this._model.gotoTime(new Date("1800-01-01").getTime()).then(e),this._onScroll.fire()}scrollToOffsetAnimated(e,t){if(!isFinite(e))throw new RangeError("offset is required and must be finite number");const i=void 0===t?400:t;if(!isFinite(i)||i<=0)throw new RangeError("animationDuration (optional) must be finite positive number");const s=this._rightOffset,o=Date.now(),r=()=>{this._visibleBarsInvalidated=!0;const t=(Date.now()-o)/i;if(t>=1)return this._updateRightOffset(e),this._visibleBarsInvalidated=!0,this._model.recalculateAllPanes((0,nt.viewportChangeEvent)()),void this._model.lightUpdate();const n=s+(e-s)*t;this._updateRightOffset(n),this._model.recalculateAllPanes((0,nt.viewportChangeEvent)()),setTimeout(r,20)};r()}defaultRightOffset(){return this._defaultRightOffset}rightOffsetDefaultValue(){return 10}defaultRightOffsetPercentage(){return this._defaultRightOffsetPercentage}usePercentageRightOffset(){return this._usePercentageRightOffset}barSpacing(){return this._barSpacing}barSpacingScaleRatio(){return null===this._snapshotBarSpacing?1:this._barSpacing/this._snapshotBarSpacing}setBarSpacing(e){Number.isFinite(e)?(e=this.getValidBarSpacing(e),this._tryToUpdateBarSpacing(this._barSpacing,e)&&(this.correctOffset(),this._options.preserveBarSpacing&&((0,L.allowSavingDefaults)(!0),this._scalesProperties.childs().barSpacing.setValue(this._barSpacing),(0,L.allowSavingDefaults)(!1)),this._model.recalculateAllPanes((0,nt.viewportChangeEvent)()),this._model.lightUpdate())):Vt.logWarn(`setBarSpacing: invalid argument: ${e}`)}barSpacingChanged(){return this._barSpacingChanged}getValidBarSpacing(e){return null==e&&(e=this.barSpacing()),e<this.minBarSpacing()?this.minBarSpacing():e>this.maxBarSpacing()?this.maxBarSpacing():e}isValidBarSpacing(e){return e>=this.minBarSpacing()&&e<=this.maxBarSpacing()}preserveBarSpacing(){return this._options.preserveBarSpacing}normalizeBarIndex(e){let t=0,i=0;const s=this.baseIndex(),o=(0,n.ensureNotNull)(this._points.range().value()).firstIndex;return e<o?(t=(0,n.ensureNotNull)(this._points.valueAt(o)),i=e-o):e>s?(t=(0,n.ensureNotNull)(this._points.valueAt(s)),i=e-s):(t=(0,n.ensureNotNull)(this._points.valueAt(e)),i=0),{time_t:t,offset:i}}denormalizeTimePoint(e){const t=this._points.indexOf(e.time_t,!1)
;if(null!==t)return t+e.offset}rightOffset(){return this._rightOffset}rightOffsetChanged(){return this._rightOffsetChanged}minRightOffset(){var e;const t=null===(e=this.points().range().value())||void 0===e?void 0:e.firstIndex,i=this._baseIndex;if(void 0===t||null===i)return null;if(null!==this._leftEdgeIndex){const e=this.width()/this._barSpacing;return this._leftEdgeIndex-i+e-1}return t-i-1+Ot}maxRightOffset(){return this.width()/this._barSpacing-Ot}maxRightOffsetChanged(){return this._maxRightOffsetChanged}onReset(){return this._resetDelegate}baseIndex(){return this._baseIndex||0}zoom(e,t,i){if(!Number.isFinite(e)||!Number.isFinite(t))return void Vt.logWarn(`zoom: invalid arguments: ${e}, ${t}, ${i}`);const s=this.rightOffset(),o=void 0!==i?!i:this._options.rightBarStaysOnScroll,r=o&&this.usePercentageRightOffset().value()&&s>=0,n=r?this.barIndexLengthToPercents(s):void 0,a=this.coordinateToIndex(e),l=this.barSpacing(),c=l+t*(l/10);this.setBarSpacing(c),o||(this.startScroll(this.indexToCoordinate(a)),this.scrollTo(e),this.endScroll()),r&&void 0!==n&&this.setRightOffset(this.percentsToBarIndexLength(n)),this._requestMoreData()}zoomToBarsRange(e,t){if(null!==this._leftEdgeIndex&&(e=Math.max(e,this._leftEdgeIndex)),t<e)return;const i=this.baseIndex(),s=this._rightOffset;this._rightOffset=t-i;const o=e-.5,r=t+.5,n=Math.max(this._pointWeights.indexToTotalWeight(r)-this._pointWeights.indexToTotalWeight(o),Ot);this.setBarSpacing(this.width()/n),this._visibleBarsInvalidated=!0,this.correctOffset(),this._rightOffset!==s&&this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}coordinateToIndex(e){return Math.round(this.coordinateToFloatIndex(e))}coordinateToFloatIndex(e){const t=(e-this._baseIndexBarCenterCoordinate())/this._barSpacing,i=this._pointWeights.totalWeightToIndex(t);return Math.round(1e6*i)/1e6}coordinateToVisibleIndex(e){let t=this.coordinateToIndex(e);const i=this.visibleBarsStrictRange();return null===i||i.contains(t)||(t=Math.min(Math.max(i.firstBar(),t),i.lastBar())),t}canZoomIn(){return this.barSpacing()<this.maxBarSpacing()}canZoomOut(){return this.barSpacing()>this._options.minBarSpacing}minBarSpacing(){return this._options.minBarSpacing}maxBarSpacing(){const e=this.width();return Rt?e:e/Ot}minVisibleBarCount(){return Ot}resetRightOffset(){this.setRightOffset(this.targetDefaultRightOffset())}reset(){this._visibleBarsInvalidated=!0,this._points.clear(),this._scrollData=null,this._scaleStartPoint=null,this._clearCommonTransitionsStartState(),this._tickMarks.reset(),this._leftEdgeIndex=null,this._resetDelegate.fire(),this.disconnect()}resetAvailable(){return this._resetAvailable.readonly()}disconnect(){this._requestingMoreData=!1,this._requestedTickmarksCount=0,this._endOfData=!1}setBaseIndex(e){Number.isFinite(e)?(this._visibleBarsInvalidated=!0,this._baseIndex=e,this._pointWeights.setBaseIndex(this._baseIndex),this.correctOffset()):Vt.logDebug(`setBaseIndex: invalid argument: ${e}`)}resetBaseIndex(){this._visibleBarsInvalidated=!0,this._baseIndex=null}setRightOffset(e){
Number.isFinite(e)?(this._visibleBarsInvalidated=!0,this._updateRightOffset(e)):Vt.logWarn(`setRightOffset: invalid argument: ${e}`)}correctBarSpacing(){this.isEmpty()||this.points().size()<this.width()/this.barSpacing()&&(this.setRightOffset(this.targetDefaultRightOffset()),this.setBarSpacing(this.width()/(this.points().size()+this.rightOffset())))}setTimePointWeights(e){this._weightedPointsCache=[],this._pointWeights=null!=e?e:new Dt,this._pointWeights.setBaseIndex(this.baseIndex()),this._visibleBarsInvalidated=!0}correctOffset(){const e=this.maxRightOffset();this._rightOffset>e&&(this._rightOffset=e,this._visibleBarsInvalidated=!0);const t=this.minRightOffset();null!==t&&this._rightOffset<t&&(this._rightOffset=t,this._visibleBarsInvalidated=!0)}logicalRange(){return this._visibleBarsInvalidated&&(this._visibleBarsInvalidated=!1,this._updateVisibleBars()),this._visibleBars.logicalRange()}restoreDefault(){this._visibleBarsInvalidated=!0,this._lockBarsAndLogicalRangeEvents=!0;const e=this._visibleBars;this.setBarSpacing(6),this.resetRightOffset(),this._lockBarsAndLogicalRangeEvents=!1,this._fireVisibleBarsChangedIfRequired(e,this._visibleBars),this._requestMoreData()}startScale(e){this._scrollData&&this.endScroll(),null===this._scaleStartPoint&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scaleStartPoint=e,this._saveCommonTransitionsStartState()))}scaleTo(e){if(null===this._commonTransitionStartState)return;const t=(0,Be.clamp)(this._width-e,0,this._width),i=(0,Be.clamp)(this._width-(0,n.ensureNotNull)(this._scaleStartPoint),0,this._width);if(0===t||0===i)return;const s=this.barIndexLengthToPercents(this.rightOffset());this.setBarSpacing(this._commonTransitionStartState.barSpacing*t/i),this.usePercentageRightOffset().value()&&this.rightOffset()>=0&&this.setRightOffset(this.percentsToBarIndexLength(s))}endScale(){null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._clearCommonTransitionsStartState(),this._requestMoreData())}startScroll(e){null===this._scrollData&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scrollData={startCoordinate:e,startRightEdgeLogical:this.baseIndex()+this._rightOffset+.5,startBaseIndex:this.baseIndex()},this._saveCommonTransitionsStartState()))}scrollTo(e){if(this._visibleBarsInvalidated=!0,null===this._scrollData)return;const{startCoordinate:t,startRightEdgeLogical:i,startBaseIndex:s}=this._scrollData,o=e-t,r=i+(this.baseIndex()-s),n=this.indexToCoordinate(r),a=this.coordinateToFloatIndex(n-o)-.5-this.baseIndex();this._updateRightOffset(a),this._onScroll.fire()}endScroll(){null!==this._scrollData&&(this._scrollData=null,this._clearCommonTransitionsStartState(),this._requestMoreData())}formatLabel(e,t){const i="24-hours"===It.timeHoursFormatProperty.value()?t.toString():`${t}_ampm`;let s=this._formattedBySpan.get(i);return void 0===s&&(s=new Pt((e=>this.formatLabelImpl(e,t))),this._formattedBySpan.set(i,s)),s.format(new Date(e))}formatLabelImpl(e,t){if(!(e&&e instanceof Date))return"incorrect time";const s=function(e,t){
if(e===Tt.MILLISECOND_SPAN&&t)return"TimeWithMilliseconds";if(e<Tt.MINUTE_SPAN&&t)return"TimeWithSeconds";if(e<Tt.DAY_SPAN&&t)return"Time";if(e<Tt.WEEK_SPAN)return"DayOfMonth";if(e<Tt.MONTH_SPAN)return"DayOfMonth";if(e<Tt.YEAR_SPAN)return"Month";return"Year"}(t,!this._model.mainSeries().isDWM());return null!==Mt.customFormatters.tickMarkFormatter?Mt.customFormatters.tickMarkFormatter(e,s):function(e,t){switch(t){case"TimeWithMilliseconds":return new Lt.TimeFormatter(Lt.hourMinuteSecondMillisecFormat).format(e);case"TimeWithSeconds":case"Time":const s="TimeWithSeconds"===t?(0,At.getHourMinuteSecondFormat)(It.timeHoursFormatProperty.value()):(0,At.getHourMinuteFormat)(It.timeHoursFormatProperty.value());return new Lt.TimeFormatter(s).format(e);case"DayOfMonth":return e.getUTCDate().toString();case"Month":return(void 0===xt&&(xt=[d.t(null,void 0,i(562310)),d.t(null,void 0,i(302507)),d.t(null,void 0,i(92767)),d.t(null,void 0,i(227072)),d.t(null,{context:"short"},i(13132)),d.t(null,void 0,i(800429)),d.t(null,void 0,i(853786)),d.t(null,void 0,i(546450)),d.t(null,void 0,i(806816)),d.t(null,void 0,i(912179)),d.t(null,void 0,i(526899)),d.t(null,void 0,i(532084))]),xt)[e.getUTCMonth()];case"Year":return e.getUTCFullYear().toString()}}(e,s)}onScroll(){return this._onScroll}invalidateVisibleBars(){this._visibleBarsInvalidated=!0}onTimeScaleCompleted(e){var t;if(this._requestingMoreData=!1,this._endOfData=e,ne.enabled("fix_left_edge")&&this._endOfData){const e=null===(t=this._points.range().value())||void 0===t?void 0:t.firstIndex;void 0!==e&&this.setLeftEdgeFix(e)}this._requestMoreData()}requestMoreHistoryPoints(e){this._model.mainSeries().requestMoreData(e)}targetDefaultRightOffset(){return this.usePercentageRightOffset().value()?this.percentsToBarIndexLength(this._defaultRightOffsetPercentage.value()):this._defaultRightOffset.value()}percentsToBarIndexLength(e){return.01*e*this._width/this._barSpacing}barIndexLengthToPercents(e){return 100*e*this._barSpacing/this._width}requestHistoryPointsIfNeeded(){this._model.mainSeries().requestMoreData()}_requestMoreData(){this._requestFutureTickmarksIfNeeded(),this.requestHistoryPointsIfNeeded()}_requestFutureTickmarksIfNeeded(){this._model.mainSeries().requestMoreData()}_requestHistoryPoints(e){this._model.chartApi().isConnected().value()&&(this._requestingMoreData?Vt.logNormal("Skipping loading more data due active loading"):(this._requestingMoreData=!0,this._model.chartApi().requestMoreData(e)))}_updateVisibleBars(){const e=this._visibleBars;if(this.isEmpty())return void(this._visibleBars.isValid()&&(this._visibleBars=Ct.invalid(),this._visibleBarsChanged.fire(null,e.strictRange()),this._logicalRangeChanged.fire(null,e.logicalRange())));const t=this.width()/this.barSpacing(),i=this.baseIndex(),s=i+this._rightOffset,o=s+.5,r=this._pointWeights.indexToTotalWeight(o)-t,n=Math.min(o-1,this._pointWeights.totalWeightToIndex(r))+.5;Number.isFinite(n)&&Number.isFinite(s)?(this._visibleBars=new Ct(new gt.LogicalRange(n,s),this._model.mainSeries().style()),
this._lockBarsAndLogicalRangeEvents||this._fireVisibleBarsChangedIfRequired(e,this._visibleBars)):Vt.logWarn(`updateVisibleBars error: baseIndex: ${i}, barSpacing: ${this._barSpacing}, rightOffset: ${this._rightOffset}`)}_fireVisibleBarsChangedIfRequired(e,t){mt.BarsRange.compare(e.strictRange(),t.strictRange())||this._visibleBarsChanged.fire(t.strictRange(),e.strictRange()),gt.LogicalRange.compare(e.logicalRange(),t.logicalRange())||this._logicalRangeChanged.fire(t.logicalRange(),e.logicalRange())}_baseIndexBarCenterCoordinate(){const e=this.baseIndex()+this._rightOffset+.5,t=this._pointWeights.indexToTotalWeight(e);return this._width-t*this._barSpacing}_tryToUpdateBarSpacing(e,t){return e!==t&&(this._visibleBarsInvalidated=!0,this._barSpacing=t,this._barSpacingChanged.fire(t),!0)}_saveCommonTransitionsStartState(){this._commonTransitionStartState={barSpacing:this.barSpacing(),rightOffset:this.rightOffset()}}_clearCommonTransitionsStartState(){this._commonTransitionStartState=null}_maxRightOffsetOnChanged(){this._maxRightOffsetChanged.fire(this.maxRightOffset())}_updateRightOffset(e){const t=this._rightOffset;this._rightOffset=e,this.correctOffset(),this._rightOffset!==t&&this._rightOffsetChanged.fire(this._rightOffset),this._model.recalculateAllPanes((0,nt.viewportChangeEvent)()),this._model.lightUpdate()}_defaultRightOffsetOptionsUpdated(){this.rightOffset();this.setRightOffset(this.targetDefaultRightOffset()),this._updateResetAvailableValue(),this._lastDefaultRightOffset=this._defaultRightOffsetPercentage.value()}_updateResetAvailableValue(){this._resetAvailable.setValue(6!==this.barSpacing()||this.rightOffset()!==this.targetDefaultRightOffset())}}var Ft=i(319448),Ht=i(553220),zt=i(590250),Ut=i(684634);class Gt{constructor(e){this._onChanged=new V.Delegate,this._groups=[],this._groups=e||[],this._groups.forEach((e=>{e.onChanged().subscribe(null,(t=>this._onChanged.fire(e.id,t)))}))}groups(){return this._groups.filter((e=>e.isActualSymbol()))}groupsForAllSymbols(){return this._groups}createGroup(e,t,i){t=t||this._generateNextName();const s=new Ut.LineToolsGroup(e,t,i);this._groups.push(s),s.onChanged().subscribe(null,(e=>this._onChanged.fire(s.id,e)));const o={visibilityChanged:!1,lockedChanged:!1,isActualIntervalChanged:!1,affectedLineTools:e.map((e=>e.id()))};return this._onChanged.fire(s.id,o),s}addGroup(e){this._groups.push(e),e.onChanged().subscribe(null,(t=>this._onChanged.fire(e.id,t))),this._onChanged.fire(e.id)}removeGroup(e){const t=this._groups.findIndex((t=>t.id===e.id));this._groups.splice(t,1),this._onChanged.fire(e.id)}groupForId(e){return this._groups.find((t=>t.id===e))||null}groupForLineTool(e){return this._groups.find((t=>t.containsLineTool(e)))||null}removeLineTools(e){const t=new Set;this._groups.forEach((i=>{const s=e.filter(i.containsLineTool.bind(i));s.length&&(i.excludeLineTools(s),t.add(i.id))}));return this._groups.filter((e=>0===e.lineTools().length)).forEach((e=>this.removeGroup(e))),Array.from(t)}state(e){return{
groups:(e?this._groups.filter((e=>e.isActualSymbol())):this._groups).map((e=>e.state()))}}onChanged(){return this._onChanged}fireChangedAll(){this._groups.forEach((e=>{this._onChanged.fire(e.id)}))}static fromState(e,t){const i=[];for(const s of t.groups){const t=Ut.LineToolsGroup.fromState(e,s);null!==t&&i.push(t)}return new Gt(i)}_generateNextName(){const e=new Set(this.groups().map((e=>e.name().value())));for(let t=1;;t++){const i=`Group ${t}`,s=`Group_${t}`;if(!e.has(i)&&!e.has(s))return i}}}var qt=i(870045),jt=i.n(qt),Kt=i(866554);let Zt=null;function Yt(e){return Boolean(e.symbolInfo.timezone)&&Boolean(e.symbolInfo.session)}class $t{constructor(e,t){var i,s;this._sourceTargetBarBuilder=null,this._cache=new Map,this._source=e,this._sourceSession=Kt.SessionInfo.fromState(e.session),this._target=t,this._targetSession=Kt.SessionInfo.fromState(t.session),this._isResolutionTheSame=I.Interval.isEqual(e.resolution,t.resolution)||I.Interval.isTicks(e.resolution)&&I.Interval.isTicks(t.resolution),this._isSessionTheSame=(i=e.symbolInfo,s=t.symbolInfo,i.timezone===s.timezone&&i.session===s.session&&i.session_holidays===s.session_holidays&&i.corrections===s.corrections),this._shouldCorrectTradingDay=I.Interval.isDWM(e.resolution)&&!this._isSessionTheSame}sourceTimeToTargetTime(e){if(this._isSessionTheSame&&this._isResolutionTheSame)return e;if(!Yt(this._source)||!Yt(this._target))return e;let t=this._cache.get(e);if(void 0===t){let i=1e3*e;if(this._shouldCorrectTradingDay){let e=jt().utc_to_cal(this._sourceSession.timezone,i);e=this._sourceSession.spec.correctTradingDay(e);const t=new Date(e);jt().set_hms(t,0,0,0,0,this._sourceSession.timezone),i=t.valueOf()}const s=this._sourceTargetBuilder();s.moveTo(i);const o=s.indexOfBar(i);t=s.startOfBar(Math.max(0,o))/1e3,this._cache.set(e,t)}return t}_sourceTargetBuilder(){if(null===this._sourceTargetBarBuilder){const e=this._isSessionTheSame?this._targetSession:(null===Zt&&(Zt=new Kt.SessionInfo("Etc/UTC","24x7")),Zt);this._sourceTargetBarBuilder=(0,Kt.newBarBuilder)(this._target.resolution,this._targetSession,e)}return this._sourceTargetBarBuilder}}var Xt=i(638456),Jt=i(314802),Qt=i(919346);const ei="#000000";var ti=i(447935);async function ii(e){(await(0,ti.getChartAlertsFacade)()).invokeAlertEditor(e)}class si{constructor(e){this._alertLabelsBySource=new Map,this._alertsByAlertSeriesId=new Map,this._alertSeriesIdByAlert=new Map,this._alertLabelsOwnerSourcesByAlert=new Map,this._chartModel=e}destroy(){this.removeAllAlertLabels()}removeAllAlertLabels(){const e=this._alertLabelsBySource;this._alertLabelsBySource=new Map,this._alertsByAlertSeriesId.clear(),this._alertSeriesIdByAlert.clear(),this._alertLabelsOwnerSourcesByAlert.clear(),e.forEach((e=>{e.forEach((e=>this._chartModel.removeSource(e)))}))}removeSourceAlertLabels(e){for(const t of this._getAlertLabelsBySource(e))this.removeAlertLabel(t)}syncSourceAlertLabels(e){if(!(0,fe.isPriceDataSource)(e)||!e.hasStateForAlert())return
;for(const t of this._getAlertLabelsBySource(e))t.alertOwnerSource().idForAlert()===t.alertSeriesId()||t.alert().isOHLC()||this.removeAlertLabel(t);const t=this._alertsByAlertSeriesId.get(e.idForAlert()),i=this._getAlertLabelsBySource(e);void 0!==t&&t.forEach((e=>{i.some((t=>t.alert()===e))||this._updateAlertLabelsByAlert(e,(0,n.ensureDefined)(this._alertSeriesIdByAlert.get(e)))}));const s=(0,n.ensureNotNull)(this._chartModel.paneForSource(e));for(const t of this._getAlertLabelsBySource(e)){const i=this._chartModel.paneForSource(t);i!==s?(null!==i&&i.removeDataSource(t),s.addDataSource(t,(0,n.ensureNotNull)(e.priceScale()),!1)):e.priceScale()!==t.priceScale()&&s.move(t,(0,n.ensureNotNull)(e.priceScale()))}}detachSourceAlertLabels(e){for(const t of this._getAlertLabelsBySource(e))this._chartModel.detachSource(t)}removeAlertLabel(e){const t=e.alertOwnerSource(),i=this._alertLabelsBySource.get(t);void 0!==i&&(i.delete(e),0===i.size&&this._alertLabelsBySource.delete(t));const s=e.alert(),o=this._alertLabelsOwnerSourcesByAlert.get(s);void 0!==o&&(o.delete(t),0===o.size&&this._alertLabelsOwnerSourcesByAlert.delete(s)),this._chartModel.removeSource(e)}addAlert(e,t){(0,n.assert)(!this._alertSeriesIdByAlert.has(e),"Alert is already added on the chart"),this._alertSeriesIdByAlert.set(e,t);let i=this._alertsByAlertSeriesId.get(t);void 0===i&&(i=new Set,this._alertsByAlertSeriesId.set(t,i)),i.add(e),this._updateAlertLabelsByAlert(e,t)}removeAlert(e){const t=this._alertLabelsOwnerSourcesByAlert.get(e);void 0!==t&&t.forEach((t=>{const i=this._alertLabelsBySource.get(t);void 0!==i&&i.forEach((t=>{t.alert()===e&&this.removeAlertLabel(t)}))}));const i=this._alertSeriesIdByAlert.get(e);if(!i)return;this._alertSeriesIdByAlert.delete(e);const s=this._alertsByAlertSeriesId.get(i);void 0!==s&&s.delete(e)}_findPanes(e){const t=[];for(const i of this._chartModel.panes()){const s=i.priceDataSources(),o=new Set;for(const t of s)t.hasStateForAlert()&&t.idForAlert()===e&&o.add(t);o.size>0&&t.push({pane:i,sources:o})}return t}_addLabelToPane(e,t,i,s){const o=new y.AlertLabel(this._chartModel,e,s,ii);i.addDataSource(o,s.priceScale(),!1);let r=this._alertLabelsBySource.get(s);void 0===r&&(r=new Set,this._alertLabelsBySource.set(s,r)),r.add(o);let n=this._alertLabelsOwnerSourcesByAlert.get(e);void 0===n&&(n=new Set,this._alertLabelsOwnerSourcesByAlert.set(e,n)),n.add(s)}_updateAlertLabelsByAlert(e,t){const i=this._findPanes(t);if(i.length)for(const s of i)s.sources.forEach((i=>this._addLabelToPane(e,t,s.pane,i)));else if(e.isOHLC()){const i=this._chartModel.mainSeries();this._addLabelToPane(e,t,(0,n.ensureNotNull)(this._chartModel.paneForSource(i)),i)}this._chartModel.lightUpdate()}_getAlertLabelsBySource(e){const t=this._alertLabelsBySource.get(e);return void 0===t?[]:Array.from(t)}}var oi=i(954384),ri=i(590508),ni=i(778016),ai=i(893556),li=i(622429),ci=i(640146),di=i(540975),hi=i(509078),ui=i(666574),pi=i(432059),_i=i(443874),mi=i(201871);function gi(e,t){return e.code<t.code?-1:e.code>t.code?1:0}class Si{constructor(e){this._convertibleItems=e,
this._idsToItems=new Map;for(const t of e)this._idsToItems.set(t.id,t)}convertible(e){return void 0!==this._idsToItems.get(e)}item(e){var t;return null!==(t=this._idsToItems.get(e))&&void 0!==t?t:null}size(){return this._convertibleItems.length}filterConvertible(e,t){const i=this._convertibleItems.filter(function(e,t){return i=>!e.has(i.id)&&t(i.id)}(e,t));return i.sort(gi),i}getItems(){return this._convertibleItems.map((e=>e.id))}}class vi{constructor(e){this._allGroups=new Set,this._idToName=new Map,this._idToDescription=new Map,this._groupedUnitIds=new Map,this._groupedUnits=new Map,this._groupById=new Map,this._size=0,this._units=e;for(const t in e)if(e.hasOwnProperty(t)){this._allGroups.add(t),this._groupedUnitIds.set(t,new Set(e[t].map((e=>e.id)))),this._groupedUnits.set(t,e[t]);for(const i of e[t])this._size++,this._idToName.set(i.id,i.name),this._idToDescription.set(i.id,i.description),this._groupById.set(i.id,t)}}unitsChanged(e){return this._units!==e}size(){return this._size}name(e){return this._idToName.get(e)||e}description(e){return this._idToDescription.get(e)||e}unitGroupById(e){return this._groupById.get(e)||null}allGroups(){return new Set(this._allGroups)}unitsByGroups(e){const t=[];return e.forEach((e=>{const i=this._groupedUnits.get(e);void 0!==i&&t.push({name:e,units:i})})),t}convertible(e,t){for(const i of t){const t=this._groupedUnitIds.get(i);if(void 0!==t&&t.has(e))return!0}return!1}}var fi=i(150335);class bi{constructor(e){this._source=null,this._sourcePane=null,this._currentToolSupportsPhantomMode=!1,this._model=e}destroy(){this._source=null,this._sourcePane=null}source(){return this._source}onToolChanged(){this._removeSource();const e=this._model.currentTool();this._currentToolSupportsPhantomMode=(0,Me.isLineToolName)(e)&&(0,C.supportsPhantomMode)(e)}onCursorPositionUpdated(){if(!this._currentToolSupportsPhantomMode)return;const e=this._model.crossHairSource();if(this._sourcePane!==e.pane&&this._removeSource(),null===e.pane||!(0,fi.isNumber)(e.index)||!(0,fi.isNumber)(e.price))return void this._removeSource();const t={index:e.index,price:e.price};null!==this._source?this._source.setPoint(0,t):(this._source=this._model.createLineTool({pane:e.pane,point:t,linetool:this._model.currentTool()}),this._sourcePane=e.pane)}_removeSource(){null!==this._source&&(this._model.removeSource(this._source),this._source=null,this._sourcePane=null)}}var yi=i(570701),Ci=i(205899),wi=i(195121);class Ti{constructor(){this._lastValue=null}align(e,t,i){this._lastValue=null;let s=e;if(!(0,wi.magnetEnabled)().value())return s;const o=i.mainDataSource();if(null===o)return s;const r=o.model().mainSeries();if(o!==r)return s;const a=r.priceScale();if(a.isEmpty())return s;const l=function(e,t){const i=e.bars().valueAt(t);if(null===i)return;let s;if(null!==e.priceSource())s=[e.barFunction()(i)];else switch(e.style()){case 12:s=[i[2],i[3]];break;case 16:s=[i[2],i[4],i[3]];break;default:s=[i[1],i[2],i[3],i[4]]}return s}(r,t);if(!l)return s;const c=(0,n.ensure)(r.firstValue()),d=l.map((e=>({y:a.priceToCoordinate(e,c),price:e
}))),h=a.priceToCoordinate(e,c);d.sort(((e,t)=>Math.abs(e.y-h)-Math.abs(t.y-h)));const u=d[0];return((0,wi.magnetMode)().value()===Ci.MagnetMode.StrongMagnet||Math.abs(u.y-h)<50)&&(s=u.price,this._lastValue=s),s}lastValue(){return this._lastValue}resetLastValue(){this._lastValue=null}}var Pi=i(269665),Mi=i(665798),xi=i(961970);class Ii extends xi.BitmapCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(e){return null}_drawImpl(e){if(null===this._data)return;const{context:t,verticalPixelRatio:i,horizontalPixelRatio:s,bitmapSize:o}=e,r=Math.max(1,Math.floor(s));t.lineWidth=r;const n=Math.ceil(o.height*i),a=Math.ceil(o.width*s);if(t.lineCap="butt",this._data.vertLinesVisible){t.strokeStyle=this._data.vertLinesColor,(0,Mi.setLineStyle)(t,this._data.vertLineStyle);for(const e of this._data.timeMarks){const i=Math.round(e.coord*s);(0,Mi.drawVerticalLine)(t,i,0,n)}}if(this._data.horzLinesVisible){t.strokeStyle=this._data.horzLinesColor,(0,Mi.setLineStyle)(t,this._data.horzLineStyle);for(const e of this._data.priceMarks){const s=Math.round(e.coord*i);(0,Mi.drawHorizontalLine)(t,s,0,a)}}}}class Li{constructor(e){this._renderer=new Ii,this._pane=e}update(){}renderer(){const e=this._pane.defaultPriceScale(),t=this._pane.model().timeScale();if(e.isEmpty()||t.isEmpty())return null;const i=this._pane.model().properties().childs().paneProperties.childs(),s=t.marks(),o=i.gridLinesMode.value(),r={horzLinesVisible:"both"===o||"horz"===o,vertLinesVisible:"both"===o||"vert"===o,horzLinesColor:i.horzGridProperties.childs().color.value(),vertLinesColor:i.vertGridProperties.childs().color.value(),horzLineStyle:i.horzGridProperties.childs().style.value(),vertLineStyle:i.vertGridProperties.childs().style.value(),priceMarks:e.marks(),timeMarks:null!==s?s:[]};return this._renderer.setData(r),this._renderer}}class Ai extends X.DataSource{id(){return"grid"}paneViews(e){return[new Li(e)]}name(){return"Grid"}}var ki=i(347808);class Ei extends ki.PriceAxisView{constructor(e,t,i,s){super(),this._source=e,this._pane=t,this._priceScale=i,this._priceProvider=s,this._properties=e.model().properties().childs().scalesProperties}setHitTestData(e){this._hitTestData=e}setXCoord(e){this._xCoord=e}additionalPadding(e){return 0}_updateRendererData(e,t,i){e.visible=!1,t.visible=!1;const s=this._priceScale,o=s.mainSource(),r=null!==o?o.firstValue():null;if(!this._isVisible()||s.isEmpty()||null===r)return;const n=this._currentPrice(s);if(null===n)return;i.background=(0,pi.resetTransparency)(this._bgColor()),i.textColor=this.generateTextColor(i.background);const a=this.additionalPadding(s.fontSize());i.additionalPaddingTop=a,i.additionalPaddingBottom=a,i.coordinate=s.priceToCoordinate(n,r),e.text=s.formatPrice(n,r),e.visible=!0,t.visible=!0,t.hitTestData=this._hitTestData,t.xCoord=this._xCoord}_currentPrice(e){return this._priceProvider(e)}}class Di extends Ei{additionalPadding(e){return 2/12*e}_isVisible(){const e=this._source.lockedPane()
;return this._properties.childs().showPriceScaleCrosshairLabel.value()&&(this._source.visible||null!==e)&&(null!=e?e:this._source.pane)===this._pane}_currentPrice(e){const t=Fe.crosshairLock.value();return null!==t&&1===t.type?this._pane===this._source.lockedPane()?t.price:null:super._currentPrice(e)}_bgColor(){const e=this._properties.childs();return this._source.model().dark().value()?e.crosshairLabelBgColorDark.value():e.crosshairLabelBgColorLight.value()}_updateRendererData(e,t,i){const s=t.visible;super._updateRendererData(e,t,i),this._source.isHovered()?t.backgroung=this._source.model().dark().value()?c.colorsPalette["color-cold-gray-600"]:c.colorsPalette["color-cold-gray-650"]:t.backgroung=void 0,s||(t.visible=s)}}class Bi extends Ei{_isVisible(){return null!==this._source.measurePane().value()}_bgColor(){return this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}}var Ni=i(95370),Ri=i(84281),Oi=i(683833),Vi=i(691371),Wi=i(716004),Fi=i(457965),Hi=i(310681),zi=i(966837),Ui=i(417947),Gi=i(67326),qi=i(621452),ji=i(287741),Ki=i(344158),Zi=i(314824);function Yi(e){const t=e.priceScale();return null===t?0:t.isPercentage()||t.isIndexedTo100()?2:1}class $i extends Ni.PanePriceAxisView{constructor(e,t,i,s,o){super(e,t,s),this._crossHairMenuCachedState=null,this._hasActions=!1,this._gaOrigin="CH menu",this._crosshairPriceAxisView=e,e.setPaneRendererLabelIcon(0),this._crosshair=t,this._scale=i,this._options=o,this._updateGaOrigin(),(0,Ri.waitTradingService)().then((()=>{this._crossHairMenuCachedState=null}))}_updateImpl(e){const t=this._crosshair.y,i=this._chartModel.properties().childs().scalesProperties.childs().fontSize.value(),s=this._chartModel.timeScale().width(),o=this._crosshair.model().priceAxisRendererOptions(),r=i+2*this._crosshairPriceAxisView.additionalPadding(i)+o.paddingTop+o.paddingBottom,n=r,l=t-r/2,c=this._crosshair.pane,d=this._mainDataSourceOnPane(),h=d&&d.symbolSource(),u=!!h&&(h.isConvertedToOtherCurrency()||h.isConvertedToOtherUnit());if(this._updateGaOrigin(),null!==d){const e=Yi(d),t=d.idForAlert(),i=this._chartModel.isInReplay().value(),s=this._crossHairMenuCachedState,o=ne.enabled("chart_crosshair_menu");null!==s&&s.id===t&&s.priceScale===e&&s.isCurrencyOrUnitConverted===u&&s.isInReplay===i&&s.isMenuEnabled===o||(this._updateTooltipAndActionsAvailability(d,e,u),this._crossHairMenuCachedState={id:t,priceScale:e,isCurrencyOrUnitConverted:u,isInReplay:i,isMenuEnabled:o})}null!==d&&(0,Ae.isActingAsSymbolSource)(d)&&d.symbol();const p=null!==c&&(c.maximized().value()||!c.collapsed().value())&&this._hasActions;this._crosshairPriceAxisView.setPaneLabelVisible(p);const _=this._position();if(null!==_){const e=0,t=s-n,i=Boolean(Ki.showPlusButtonOnCursor.value()),o=i?this._crosshair.x:void 0,c=void 0!==o?o-n/2:"left"===_?e:t,d=void 0!==o?o+n/2:"left"===_?e+n:t+n,h=(0,a.box)(new a.Point(c,l),new a.Point(d,l+r));this._data={itemBox:h,clickHandler:this._handleClick.bind(this,_,i,h)},this._crosshairPriceAxisView.setHitTestData(this._data),this._crosshairPriceAxisView.setXCoord(o)}
super._updateImpl(e)}_priceScale(){return this._scale}_updateGaOrigin(){this._gaOrigin=Boolean(Ki.showPlusButtonOnCursor.value())?"CH menu cursor":"CH menu"}_updateTooltipAndActionsAvailability(e,t,i){this._hasActions=!1;if(!(1===t))return;const s=!this._chartModel.isInReplay().value(),o=!i&&e.alertCreationAvailable().value()&&s,r=!this._options.disableDrawHorizLineMenuAction,n=!i&&e===this._chartModel.mainSeries()&&Boolean((0,Ri.tradingService)())&&s;this._hasActions=n||o||r}_handleClick(e,t,i,s,o){if(ne.enabled("widget")&&ne.enabled("referral_program_for_widget_owners"))return void(0,Hi.showGoToTradingViewReferralDialog)({feature:"plusMenu"});(0,p.trackEvent)(this._gaOrigin,"click");const r=this._mainDataSourceOnPane(),n=null!==r&&(0,Ae.isActingAsSymbolSource)(r)?r.symbol():null,a={pageX:o.pageX,pageY:o.pageY,clientX:o.clientX,clientY:o.clientY,screenX:o.screenX,screenY:o.screenY,price:this._crosshair.price,symbol:n};m.emit("onPlusClick",a),this._getMenuItems(e).then((s=>{s.length>0&&this._showContextMenu(s,t,i,o,e)}))}_getMenuItems(e){const t=this._chartModel.mainSeries(),i=t.symbolInfo(),s=this._options.disableTradingMenuActions?null:(0,Ri.tradingService)(),o=(0,n.ensureNotNull)(this._crosshair.pane).mainDataSource(),r=!this._chartModel.isInReplay().value(),a=r,l=o===t&&!(0,Gi.isNonTradableSymbolType)(null==i?void 0:i.type)&&Boolean(s)&&r,c=a?this._createAlertMenuItems(e):Promise.resolve([]),d=l?this._createTradingMenuItems():Promise.resolve([]);return Promise.all([c,d]).then((([e,t])=>{t.length>0&&(0,n.ensureNotNull)(s).trackEvent(this._gaOrigin,"click");const i=this._createAddHorizontalLineMenuItem(),o=e.length>0&&t.length>0;return[...e,o?new Vi.Separator:null,...t,(e.length>0||t.length>0)&&i.length>0?new Vi.Separator:null,...i].filter((e=>null!==e))}))}_createAlertMenuItems(e){if(null===this._crosshair.pane)return Promise.resolve([]);const t=this._crosshair.pane.mainDataSource();if(null===t)return Promise.resolve([]);const i=t.symbolSource();if(!!i&&(i.isConvertedToOtherCurrency()||i.isConvertedToOtherUnit()))return Promise.resolve([]);const s=this._crosshair.y;if(this._options.menuForMainSourceOnly){if(t.alertCreationAvailable().value()&&t.isVisible()){const e=this._getActionAddAlert({source:t,y:s,isDisabled:!1});return Promise.resolve(null===e?[]:[e])}return Promise.resolve([])}const o=(0,n.ensureNotNull)(this._crosshair.pane).sourcesByGroup();let r=("left"===e?o.leftPriceScalesSources():o.rightPriceScalesSources()).filter((e=>(0,fe.isPriceDataSource)(e)&&e.alertCreationAvailable().value()&&e.isVisible()));return r.reverse(),r=(0,b.moveToHead)(r,this._chartModel.mainSeries()),(0,zi.filterAccessibleDataSources)(r).then((e=>{const t=new Set(e),i=[];for(const e of r){const o=this._getActionAddAlert({source:e,y:s,isDisabled:!t.has(e)});null!==o&&i.push(o)}return i}))}_createTradingMenuItems(){const e=this._crosshair.y,t=(0,Ri.tradingService)();if(null===t||null===this._crosshair.pane)return Promise.resolve([]);const i=this._crosshair.pane.mainDataSource();if(null===i)return Promise.resolve([])
;const s=i.symbolSource(),o=!!s&&(s.isConvertedToOtherCurrency()||s.isConvertedToOtherUnit()),r=Yi(i);return o||1!==r?Promise.resolve([]):(0,Oi.createTradeContext)(i,e).then((e=>t.chartContextMenuActions(e,{onlyMainActions:!0,hideNotExecutableAction:!0,gaOrigin:this._gaOrigin})))}_createAddHorizontalLineMenuItem(){if(null===this._crosshair.pane)return[];const e=this._crosshair.pane.mainDataSource();if(null===e)return[];const t=this._crosshair.y,i=this._getActionAddHorizontalLine({source:e,y:t,pane:this._crosshair.pane});return null===i?[]:[i]}_getActionAddAlert(e){const{source:t,y:s,isDisabled:o}=e,r=this._getValue(t,s),n=this._chartModel.mainSeries().interval();if(null===r||I.Interval.isTicks(n))return null;const a=this._formatValue(r,t),l=function(e){return(0,Ae.isActingAsSymbolSource)(e)?e.symbolTitle(ji.TitleDisplayTarget.StatusLine,!0,!0):(0,Wi.clean)(e.title(ji.TitleDisplayTarget.StatusLine,!0,{},!0),!0)}(t),c={label:(0,Ui.hasUsualAlertPlots)(t)?d.t(null,{replace:{title:l,price:a}},i(989295)):d.t(null,{replace:{title:l}},i(669709)),iconId:"Alert.Add"};return o?c.disabled=!0:c.onExecute=()=>this._addAlert(r,t),new Zi.ActionWithStandardIcon({actionId:"Alert.Add",options:c})}_getActionAddHorizontalLine(e){if(this._options.disableDrawHorizLineMenuAction)return null;const{source:t,y:s,pane:o}=e,r=this._getValue(t,s);if(null===r)return null;const n=this._formatValue(r,t),a={label:d.t(null,void 0,i(196890))+` ${n}`,iconId:"Chart.AddHorzLine"};return a.onExecute=()=>this._addHorizontalLineTool(o,r),new Zi.ActionWithStandardIcon({actionId:"Chart.Crosshair.PlusButton.DrawHorizontalLine",options:a})}_getValue(e,t){const i=e.priceScale(),s=e.firstValue();if(null===i||null===s)return null;return i.isPercentage()||i.isIndexedTo100()?null:i.coordinateToPrice(t,s)}_formatValue(e,t){return t.formatter().format(e)}async _addAlert(e,t){const s=await async function(){const{invokeAlertEditorWithOnlineSeries:e}=await Promise.all([i.e(92030),i.e(22172)]).then(i.bind(i,314898));return e}(),o=async()=>{const i={dataSourceHub:this._chartModel,silent:!0,actionSource:"crosshair_menu"};(0,C.isLineTool)(t)?i.drawing=t:(i.series=t,i.value=e),s(i),(0,p.trackEvent)(this._gaOrigin,"alert")};(0,Fi.runOrSigninWithFeature)((()=>o()),{feature:"alert",source:this._gaOrigin})}_addHorizontalLineTool(e,t){this._chartModel.undoModel().createLineTool({pane:e,point:{price:t,index:0},linetool:"LineToolHorzLine"})}_showContextMenu(e,t,i,s,o){const r="left"===o;setTimeout((()=>{const o=s.clientX-s.localX,a=s.clientY-s.localY,l=i.min.x+o,c=i.max.x+o,d=i.min.y+a,h=c-l,u=i.max.y+a-d,p=t?Fe.crosshairLock.value():void 0;if(void 0!==p){const e=(0,n.ensureNotNull)(this._chartModel.timeScale().points().roughTime(this._crosshair.index));Fe.crosshairLock.setValue({type:1,price:this._crosshair.price,time:e,modelId:this._chartModel.id(),paneId:(0,n.ensureNotNull)(this._crosshair.pane).id()})}qi.ContextMenuManager.showMenu(e,{clientX:s.clientX,clientY:s.clientY,box:{x:l,w:h,y:d,h:u},attachToXBy:t?"auto":r?"left":"right",attachToYBy:"auto-strict",marginX:t?0:-h},void 0,{
menuName:"CrosshairMenuView"},(()=>{void 0!==p&&Fe.crosshairLock.setValue(p)}))}))}_mainDataSourceOnPane(){const e=this._crosshair.pane;return null!==e?e.mainDataSource():null}}var Xi=i(937713);class Ji extends xi.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return void 0===this._data.clickHandler?null:new hi.HitTestResult(hi.HitTarget.Custom,{clickHandler:this._data.clickHandler,tapHandler:this._data.clickHandler})}_drawImpl(e){const t=this._data.vertLinesVisible,i=this._data.horzLinesVisible;if(!t&&!i)return;const{context:s,horizontalPixelRatio:o,verticalPixelRatio:r,bitmapSize:n}=e;s.lineWidth=Math.max(1,Math.floor(this._data.lineWidth*o)),s.strokeStyle=this._data.color,s.fillStyle=this._data.color,s.lineCap="butt",(0,Mi.setLineStyle)(s,this._data.lineStyle);const a=Math.round(this._data.x*o),l=Math.round(this._data.y*r),c=Math.ceil(n.width*o),d=Math.ceil(n.height*r);t&&a>=0&&(0,Mi.drawVerticalLine)(s,a,0,d),i&&l>=0&&(0,Mi.drawHorizontalLine)(s,l,0,c),this._data.drawCenter&&(s.beginPath(),s.arc(a,l,Math.round(3*o),0,2*Math.PI,!0),s.fillStyle=this._data.color,s.fill()),this._data.scissors&&function(e,t,i){const{context:s,bitmapSize:o,horizontalPixelRatio:r,verticalPixelRatio:n}=e,a=24*r,l=Math.round(t-a/2);let c=Math.round(i-a/2);if(c<0)c=0;else{const e=o.height-a;c>e&&(c=e)}s.translate(l,c),s.scale(r,n),s.fillStyle="#131722",s.fill(Qi),s.strokeStyle="#fff",s.lineWidth=1,s.stroke(Qi)}(e,a,l)}}const Qi=new Path2D("m15.68 3.72-3.82 5.52-3.83-5.52-.28-.42-.42.3a2.84 2.84 0 0 0-.68 3.92l3.27 4.73-1.16 1.68a3.34 3.34 0 0 0-4.26 3.22 3.34 3.34 0 0 0 3.32 3.35 3.34 3.34 0 0 0 3.08-4.6l1-1.44 1.13 1.62a3.34 3.34 0 0 0 3.15 4.42c1.84 0 3.32-1.5 3.32-3.35a3.34 3.34 0 0 0-4.42-3.17l-1.23-1.78 3.22-4.65a2.86 2.86 0 0 0-.69-3.96l-.41-.29-.29.42ZM7.82 16.27c.47 0 .86.39.86.88 0 .48-.39.87-.86.87a.87.87 0 0 1-.86-.87c0-.5.4-.88.86-.88Zm8.36 0c.47 0 .86.39.86.88 0 .48-.4.87-.86.87a.87.87 0 0 1-.86-.87c0-.5.39-.88.86-.88Z");const es=c.colorsPalette["color-tv-blue-500"];class ts{constructor(e,t){this._rendererData={},this._renderer=new Ji(this._rendererData),this._source=e,this._pane=t}update(){}renderer(){var e,t;const i=this._source.selectPointMode().value()!==Fe.SelectPointMode.None,s=this._source.lockedPane(),o=(this._source.visible||null!==s)&&(this._source.areLinesVisible||i)&&!this._source.linesShouldBeHidden(),r=this._rendererData;if(!o||null===this._pane)return null;const a=this._source.paneForPointSelect(),l=this._source.isReplaySelection(),c=null!=s?s:this._source.pane,d=this._pane===c,h=l||(null!==a?c===a&&this._pane===a:d);if(r.scissors=!1,i&&(l||this._source.isOnHoveredChartWidget())&&h){const e=(0,n.ensureNotNull)(this._source.pointToSelect());r.color=this._source.lineColor()||es,l?(r.lineWidth=2,r.scissors=d):r.lineWidth=1,r.lineStyle=ui.LINESTYLE_SOLID,r.horzLinesVisible=!0,r.vertLinesVisible=!0,r.drawCenter=!1,"time"===e?r.horzLinesVisible=!1:"price"===e&&(r.vertLinesVisible=!1)}else{const e=this._source.properties(),t=this._source.model().currentTool(),i=(0,
Xi.lastMouseOrTouchEventInfo)(),s=i.isTouch&&!i.stylus&&((0,Me.isLineToolName)(t)||(0,Fe.toolIsMeasure)(t));let o;o=s?es:e.childs().color.value();const n=e.childs().transparency.value();!s&&n>0&&(o=(0,pi.generateColor)(o,n)),r.color=o,r.horzLinesVisible=this._pane===c&&(this._pane.maximized().value()||!this._pane.collapsed().value()),r.vertLinesVisible=!0,r.lineWidth=e.childs().width.value(),r.lineStyle=e.childs().style.value(),r.drawCenter=s&&this._pane===c}return r.x=null!==(e=this._source.lockedX())&&void 0!==e?e:this._source.x,r.y=null!==(t=this._source.lockedY())&&void 0!==t?t:this._source.y,this._renderer}}var is=i(809137);const ss={backgroundColor:(0,pi.generateColor)(c.colorsPalette["color-tv-blue-500"],70),borderColor:(0,pi.generateColor)(c.colorsPalette["color-tv-blue-500"],20)};class os{constructor(e){this._renderer=new is.RectangleRenderer,this._rectangle=null,this._crosshair=e}update(){const e=this._crosshair.selection();null!==e&&null!==this._crosshair.pane?this._rectangle=this._crosshair.pane.logicalRectToPixels(e):this._rectangle=null}renderer(){if(!this._rectangle)return null;const e={backcolor:ss.backgroundColor,color:ss.borderColor,fillBackground:!0,linewidth:1,points:[this._rectangle.min,this._rectangle.max],extendLeft:!1,extendRight:!1};return this._renderer.setData(e),this._renderer}}var rs=i(881025),ns=i(212642),as=i(970011),ls=i(539040),cs=i(982949),ds=i(758910);const hs=d.t(null,void 0,i(841643)),us=d.t(null,{context:"study"},i(424261)),ps=(0,ze.getPercentageFormatter)(),_s=new ns.TimeSpanFormatter,ms=(0,ze.getVolumeFormatter)(),gs=(0,c.getHexColorByName)("color-tv-blue-500"),Ss=(0,c.getHexColorByName)("color-ripe-red-400"),vs={bgColorPositive:(0,pi.generateColor)(gs,80),bgColorNegative:(0,pi.generateColor)(Ss,80),colorPositive:(0,c.getHexColorByName)("color-tv-blue-600"),colorNegative:(0,c.getHexColorByName)("color-ripe-red-400"),labelBgColorPositive:gs,labelBgColorNegative:Ss};class fs{constructor(e,t){this._horzTrenRenderer=new as.TrendLineRenderer,this._vertTrenRenderer=new as.TrendLineRenderer,this._bgRenderer=new is.RectangleRenderer,this._labelRenderer=new ls.TextRenderer,this._p1=null,this._p2=null,this._label=null,this._source=e,this._pane=t}update(e){var t,i;const[s,o]=this._source.measurePoints();if(void 0===o)return this._p1=null,void(this._p2=null);const r=(0,n.ensureNotNull)(this._source.measurePane().value()),l=s.price,c=o.price,d=o.index-s.index,h=(0,rs.forceLTRStr)(""+d),u=(0,n.ensureNotNull)(r.mainDataSource()),p=(0,n.ensureNotNull)(u.formatter()),_=o.price-l;let m=null!==(i=null===(t=p.formatChange)||void 0===t?void 0:t.call(p,o.price,l))&&void 0!==i?i:p.format(_);if(Math.abs(l)>1e-8){const e=_/Math.abs(l);m+=" ("+ps.format(100*e)+")"}const g=(0,rs.forceLTRStr)(m);this._label=g+"\n"+hs.format({count:h});const S=(0,n.ensureNotNull)(u.firstValue()),v=this._source.model().timeScale().indexToCoordinate(s.index),f=this._source.model().timeScale().indexToCoordinate(o.index),b=r.defaultPriceScale().priceToCoordinate(l,S),y=r.defaultPriceScale().priceToCoordinate(c,S)
;this._p1=new a.Point(v,b),this._p2=new a.Point(f,y);const C=this._source.model().timeScale().indexToUserTime(s.index),w=this._source.model().timeScale().indexToUserTime(o.index);let T=null;null!==C&&null!==w&&(T=(w.valueOf()-C.valueOf())/1e3);const P=this._pane.model().mainSeries().symbolInfo(),M=P&&(0,ze.getPipFormatter)(P),x=M?M.format(_):null,I=null!==x?" , "+x:"",L=null!==T?_s.format(T):null,A=null!==L?", "+(0,rs.startWithLTR)(L):"";this._label=(0,rs.forceLTRStr)(g+I)+"\n"+hs.format({count:h})+A;const k=this._source.measureVolume();Number.isNaN(k)||(this._label+=`\n${us} ${ms.format(k)}`);const E=c<l?vs.bgColorNegative:vs.bgColorPositive,B=c<l?vs.colorNegative:vs.colorPositive,N=c<l?vs.labelBgColorNegative:vs.labelBgColorPositive,R={points:[this._p1,this._p2],linewidth:0,fillBackground:!0,color:E,backcolor:E,extendLeft:!1,extendRight:!1};this._bgRenderer.setData(R);const O=this._p1.add(this._p2).scaled(.5);{const e=Math.round(O.y),t=new a.Point(this._p1.x,e),i=new a.Point(this._p2.x,e),s={points:[t,i],color:B,linewidth:1,linestyle:ui.LINESTYLE_SOLID,extendleft:!1,extendright:!1,leftend:ds.LineEnd.Normal,rightend:Math.abs(t.x-i.x)>=50?ds.LineEnd.Arrow:ds.LineEnd.Normal};this._horzTrenRenderer.setData(s)}{const e=Math.round(O.x),t=new a.Point(e,this._p1.y),i=new a.Point(e,this._p2.y),s={points:[t,i],color:B,linewidth:1,linestyle:ui.LINESTYLE_SOLID,extendleft:!1,extendright:!1,leftend:ds.LineEnd.Normal,rightend:Math.abs(t.y-i.y)>=50?ds.LineEnd.Arrow:ds.LineEnd.Normal};this._vertTrenRenderer.setData(s)}const V={x:0,y:10},W=.5*(this._p1.x+this._p2.x),F=this._p2.y,H=new a.Point(W,F),z=(U=(0,n.ensureNotNull)(this._label),{points:[H],text:U,color:"#FFFFFF",horzAlign:"center",vertAlign:"middle",font:D.CHART_FONT_FAMILY,offsetX:V.x,offsetY:V.y,bold:!1,italic:!1,fontsize:12,padding:8,highlightBorder:!1,backgroundColor:N,backgroundTransparency:10,boxPaddingVert:9,boxPaddingHorz:9,backgroundRoundRect:4});var U;this._labelRenderer.setData(z);const G=this._labelRenderer.measure(),q=(0,ls.calculateLabelPosition)(G,this._p1,this._p2,V,this._pane.height());this._labelRenderer.setPoints([q])}renderer(){if(null===this._p1||null===this._p2)return null;const e=new cs.CompositeRenderer;return e.append(this._bgRenderer),e.append(this._horzTrenRenderer),e.append(this._vertTrenRenderer),e.append(this._labelRenderer),e}}var bs=i(463548),ys=i(699875);class Cs extends ee.MediaCoordinatesPaneRenderer{constructor(e){super(),this._svgMap=new Map,this._data=e,this._svgMap.set(e.theme,this._createSvgRenderer(e.theme))}hitTest(){return null}setData(e){this._svgMap.has(e.theme)||this._svgMap.set(e.theme,this._createSvgRenderer(e.theme)),this._data=e}_drawImpl(e){const{context:t,mediaSize:i}=e,{theme:s,x:o}=this._data,r=this._svgMap.get(s);if(!r)return;const n=r.viewBox(),{width:a,height:l}=n,c=a/2;o+c<0||o-c>i.width||(t.translate(o-c,i.height-l),r.render(t,{targetViewBox:n}))}_createSvgRenderer(e){const t=1===e?ys.replace("backgroundColor",(0,c.getHexColorByName)("color-cold-gray-900")).replace("lineColor",(0,
c.getHexColorByName)("color-cold-gray-450")):ys.replace("backgroundColor",(0,c.getHexColorByName)("color-white")).replace("lineColor",(0,c.getHexColorByName)("color-cold-gray-550"));return(0,bs.svgRenderer)(t)}}class ws{constructor(e){this._source=e,this._renderer=new Cs(this._getRenderData(0))}update(){}renderer(){var e;const t=this._source.visible&&this._source.areLinesVisible,i=this._source.lockedX(),s=0===(null===(e=Fe.crosshairLock.value())||void 0===e?void 0:e.type);return t&&s&&null!==i?(this._renderer.setData(this._getRenderData(i+1)),this._renderer):null}_getRenderData(e){return{x:e,theme:this._source.model().dark().value()?1:0}}}const Ts=30;class Ps{constructor(e,t,i){this._renderer=new is.RectangleRenderer,this._invalidated=!0,this._source=e,this._pane=t,this._model=i}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){var e;if(this._renderer.setData(null),!this._pane||!this._source.visible)return;if(!this._source.model().mainSeries().lastValueData(void 0,!0,!0).index)return;const t=new a.Point(null!==(e=this._source.lockedX())&&void 0!==e?e:this._source.x,0),i=new a.Point(this._pane.width(),this._pane.height()),s={backcolor:(0,pi.applyTransparency)(this._model.backgroundColorAtYPercentFromTop(.5),Ts),color:(0,pi.applyTransparency)(this._model.backgroundColorAtYPercentFromTop(.5),Ts),fillBackground:!0,linewidth:0,points:[t,i],nohittest:!0,extendLeft:!1,extendRight:!1};this._renderer.setData(s)}}var Ms=i(907256),xs=i(49839),Is=i(581899);class Ls extends xs.DataWindowView{constructor(e){super(),this._invalidated=!0,this._dateItem=new xs.DataWindowItem("",d.t(null,void 0,i(722677)),""),this._timeItem=new xs.DataWindowItem("",d.t(null,void 0,i(312806)),""),this._model=e,this._items.push(this._dateItem),this._items.push(this._timeItem)}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}_updateImpl(){const e=this._model.mainSeries().isDWM();if(this._timeItem.setVisible(!e),this._timeItem.setValue(Is.notAvailable),this._dateItem.setValue(Is.notAvailable),this._model.timeScale().isEmpty())return;let t=this._model.crossHairSource().appliedIndex();if(!(0,fi.isNumber)(t)){const e=this._model.mainSeries().data().last();if(null===e)return;t=e.index}const i=this._model.timeScale().indexToUserTime(t);null!==i&&(this._dateItem.setValue(this._model.dateFormatter().format(i)),e||this._timeItem.setValue(this._model.timeFormatter().format(i)))}}var As=i(83810);const ks=c.colorsPalette["color-tv-blue-500"],Es=d.t(null,{context:"Replay"},i(753310));class Ds extends As.TimeAxisView{constructor(e,t,i,s=!1){super(e),this._indexProvider=i,this._highlighted=s,this._source=t,this._properties=e.properties().childs().scalesProperties}_getText(e){if(this._source.isReplaySelection()){const t=this._model.timeScale().indexToUserTime(e);return null!==t?`${Es}: ${this._model.dateTimeFormatter().format(t)}`:""}return super._getText(e)}_getBgColor(){
if(this._source.isReplaySelection())return ks;const e=this._properties.childs();return this._highlighted?e.axisLineToolLabelBackgroundColorCommon.value():this._model.dark().value()?e.crosshairLabelBgColorDark.value():e.crosshairLabelBgColorLight.value()}_getIndex(){return this._model.crossHairSource().visible||null!==this._source.lockedPane()?this._indexProvider():null}_isVisible(){return this._properties.childs().showTimeScaleCrosshairLabel.value()}}var Bs=i(259638),Ns=i(395394);const Rs={menuEnabled:!1,menuForMainSourceOnly:!1,disableTradingMenuActions:!1,disableDrawHorizLineMenuAction:!1};let Os=0;const Vs=(0,ae.getLogger)("Chart.Crosshair");class Ws extends X.DataSource{constructor(e,t,i){super(),this.pane=null,this.price=NaN,this.index=NaN,this.visible=!0,this.areLinesVisible=!0,this.x=NaN,this.y=NaN,this._lockData=null,this._measurePane=new W.WatchedValue(null),this._measurePaneViewCache=new WeakMap,this._startMeasurePoint=null,this._endMeasurePoint=null,this._lastValidMeasurePoint=null,this._isOnHoveredChartWidget=!1,this._crossHairSelectPointMode=new W.WatchedValue(Fe.SelectPointMode.None),this._selectionPane=null,this._selectionView=new os(this),this._selectionStartPoint=null,this._timeLockPaneView=null,this._crosshairPaneViewCache=new WeakMap,this._pointSelectionPaneViewCache=new WeakMap,this._priceAxisViews=new Map,this._panePriceAxisViews=new Map,this._startMeasurePriceAxisViews=new Map,this._endMeasurePriceAxisViews=new Map,this._originX=NaN,this._originY=NaN,this._subscribed=!1,this._movedDelegate=new V.Delegate,this._pointSelectedDelegate=new V.Delegate,this._requestedPoint=null,this._paneForRequestedPoint=null,this._selectLineColor=null,this._volumeCalculator=null,this._selectFromAllChartsIfOutOfData=null,this._currentMeasurePointsetAndSymbolId=null,this._model=e,this._options=Object.assign({},Rs,i||{}),this._linesShouldBeHidden=this._model.readOnly(),this._dataWindowView=new Ls(e),this.setSelectionEnabled(!1);const s=e=>t=>t===(0,n.ensureNotNull)(this._measurePane.value()).defaultPriceScale()?e():null;this._currentPosPriceProvider=e=>{const t=(0,n.ensureNotNull)(this.pane);if(e===t.defaultPriceScale())return this.price;const i=(0,n.ensureNotNull)(t.defaultPriceScale().mainSource()).firstValue();if(null===i)return null;const s=t.defaultPriceScale().priceToCoordinate(this.price,i),o=(0,n.ensureNotNull)(e.mainSource()).firstValue();return null===o?null:e.coordinateToPrice(s,o)},this._startMeasurePriceProvider=s((()=>(0,n.ensureNotNull)(this._startMeasurePoint).price)),this._endMeasurePriceProvider=s((()=>(0,n.ensureNotNull)(this._lastMeasurePoint()).price)),this._properties=t;this._timeAxisView=new Ds(e,this,(()=>this.appliedIndex()),!1),this._startMeasureTimeAxisView=new Ds(e,this,(()=>(0,n.ensureNotNull)(this._startMeasurePoint).index),!0),this._endMeasureTimeAxisView=new Ds(e,this,(()=>(0,n.ensureNotNull)(this._lastMeasurePoint()).index),!0),e.readOnly()||Fe.cursorTool.subscribe((e=>this.areLinesVisible="arrow"!==e),{callWithLast:!0}),this._crosshairLock=Fe.crosshairLock.spawn(),
this._showPlusButtonOnCursor=Ki.showPlusButtonOnCursor.spawn();const o=()=>{this.updateAllViews((0,nt.sourceChangeEvent)(this.id())),this._model.lightUpdate()};this._crosshairLock.subscribe(o),this._showPlusButtonOnCursor.subscribe(o)}destroy(){null!==this._volumeCalculator&&this._volumeCalculator.destroy(),this._measurePane.setValue(null),this._crosshairLock.destroy(),this._showPlusButtonOnCursor.destroy(),this._removeMeasurePointset(),super.destroy()}name(){return"Crosshair"}moved(){return this._movedDelegate}originX(){return this._originX}originY(){return this._originY}saveOriginCoords(e,t){this._originX=e,this._originY=t}clearOriginCoords(){this._originX=NaN,this._originY=NaN}currentPoint(){return new a.Point(this.x,this.y)}model(){return this._model}appliedIndex(){var e;return null!==(e=this._getLockData().index)&&void 0!==e?e:this.index}lockedX(){var e;return null!==(e=this._getLockData().xCoord)&&void 0!==e?e:null}lockedY(){var e;return null!==(e=this._getLockData().yCoord)&&void 0!==e?e:null}lockedPane(){const e=Fe.crosshairLock.value();return null===e||1!==e.type?null:this._model.id()===e.modelId?this._model.paneForId(e.paneId):this._model.mainPane()}invalidateLockPosition(){this._lockData=null}startMeasurePoint(){return this._startMeasurePoint||null}endMeasurePoint(){return this._endMeasurePoint||null}measureVolume(){if(null===this._volumeCalculator)return NaN;const[e,t]=this.measurePoints();return void 0===t?NaN:this._volumeCalculator.volume(e.index,t.index)}measurePane(){return this._measurePane.readonly()}startMeasuring(e,t){this._startMeasurePoint=e,this._measurePane.setValue(t),t.containsMainSeries()&&((0,n.assert)(null===this._volumeCalculator),this._volumeCalculator=new Bs.SeriesTimeRangeVolumeCalculator(this.model().mainSeries())),this._model.updatePane(t)}finishMeasure(e){this._endMeasurePoint=e,this._createMeasurePointset((0,n.ensureNotNull)(this._startMeasurePoint),this._endMeasurePoint)}clearMeasure(){this._removeMeasurePointset(),this._measurePane.setValue(null),delete this._startMeasurePoint,delete this._endMeasurePoint,delete this._lastValidMeasurePoint,this._model.lightUpdate(),null!==this._volumeCalculator&&(this._volumeCalculator.destroy(),this._volumeCalculator=null)}measurePoints(){const e=[(0,n.ensureNotNull)(this._startMeasurePoint)],t=this._lastMeasurePoint();return null!==t&&e.push(t),e}startSelection(e){this._selectionStartPoint=this.currentLogicalPoint(),this._selectionPane=e}clearSelection(){this._selectionStartPoint=null,this._selectionPane=null}selection(){return this._selectionStartPoint?{p1:this._selectionStartPoint,p2:this.currentLogicalPoint()}:null}currentLogicalPoint(){return{index:this.appliedIndex(),price:this.price}}selectPointMode(){return this._crossHairSelectPointMode}lineColor(){return this._selectLineColor}cancelRequestSelectPoint(){this._crossHairSelectPointMode.value()!==Fe.SelectPointMode.None&&this._setSelectPointModeState(Fe.SelectPointMode.None),this._selectFromAllChartsIfOutOfData=null}requestSelectPoint(e){(0,
n.assert)(this._crossHairSelectPointMode.value()===Fe.SelectPointMode.None,"Point already requested");const{pointType:t,pane:i,lineColor:s=null,selectFromAllChartsIfOutOfData:o,selectPointMode:r=Fe.SelectPointMode.Study}=e;i&&((0,n.assert)(-1!==this._model.panes().indexOf(i),"Chartmodel doesn't contains specified pane"),this._paneForRequestedPoint=i,this._model.panesCollectionChanged().subscribe(this,this._paneCollectionChanged)),this._selectLineColor=s,this._requestedPoint=t,this._selectFromAllChartsIfOutOfData=null!=o?o:null,this._setSelectPointModeState(r)}onPointSelected(){return this._pointSelectedDelegate}trySelectCurrentPoint(){var e;const t=this.pane;if(!t)return;const i=(0,n.ensureNotNull)(this._requestedPoint);let s=null;if(!this._model.mainSeries().bars().search(this.index,kt.PlotRowSearchMode.Exact)&&"price"!==i&&(this._selectFromAllChartsIfOutOfData&&(s=null!==(e=Math.min(...Array.from(Fe.barTimesUnderCursor.values())))&&void 0!==e?e:null),null===s))return;if(this._paneForRequestedPoint&&this._paneForRequestedPoint!==t)return;let o,r=s;if("price"===i||null!==s||(r=this._model.timeScale().indexToTimePoint(this.index),null!==r)){if("time"!==i){const e=t.mainDataSource();if(null===e)return;const i=e.firstValue(),s=e.priceScale();if(null===i||null===s)return;o=s.coordinateToPrice(this.y,i)}this._setSelectPointModeState(Fe.SelectPointMode.None),this._pointSelectedDelegate.fire({time:null!=r?r:void 0,price:o},t)}}isOnHoveredChartWidget(){return this._isOnHoveredChartWidget}setOnHoveredChartWidget(e){this._isOnHoveredChartWidget=e}isReplaySelection(){return("AllCharts"===Ms.replayModeProperty.value()||this._isOnHoveredChartWidget)&&this._crossHairSelectPointMode.value()===Fe.SelectPointMode.Replay}clearPosition(){this.visible=!1,this.index=NaN,this.price=NaN,this.x=NaN,this.y=NaN,this.pane=null,this.clearOriginCoords(),this._updateVisibilityDependentPaneViews()}setPosition(e,t,i){this._subscribed||(this._model.mainSeries().onRestarted().subscribe(this,this.clearMeasure),this._subscribed=!0),this.visible=!0;const s=this._model.id(),o=this._model.mainSeries().bars().search(this.index,kt.PlotRowSearchMode.NearestRight);return o&&Fe.barTimesUnderCursor.set(s,o.value[0]),this._tryToUpdateViews(e,t,i)}setLinesShouldBeHidden(e){this._linesShouldBeHidden=e}linesShouldBeHidden(){return this._linesShouldBeHidden}handleContextMenuEvent(e){this._crossHairSelectPointMode.value()!==Fe.SelectPointMode.None&&this._setSelectPointModeState(Fe.SelectPointMode.None)}properties(){return this._properties}priceAxisViews(e,t){var i;const s=null===this._requestedPoint||"time"!==this._requestedPoint||!this._isOnHoveredChartWidget,o=[];return(null!==(i=this.lockedPane())&&void 0!==i?i:this.pane)===e&&s&&o.push(this._createPriceAxisViewOnDemand(this._priceAxisViews,this._panePriceAxisViews,e,t,this._currentPosPriceProvider,Di,!0)[0]),this._startMeasurePoint&&o.push(this._createPriceAxisViewOnDemand(this._startMeasurePriceAxisViews,null,e,t,this._startMeasurePriceProvider,Bi)[0]),
this._lastMeasurePoint()&&o.push(this._createPriceAxisViewOnDemand(this._endMeasurePriceAxisViews,null,e,t,this._endMeasurePriceProvider,Bi)[0]),o}timeAxisViews(){const e=[],t=null===this._requestedPoint||"price"!==this._requestedPoint||!this._isOnHoveredChartWidget;return this._linesShouldBeHidden||!this.visible&&null===Fe.crosshairLock.value()||!t||e.push(this._timeAxisView),this._startMeasurePoint&&e.push(this._startMeasureTimeAxisView),this._lastMeasurePoint()&&e.push(this._endMeasureTimeAxisView),e}paneViews(e){var t,i;if(void 0===e)return null;const s=[];if(this.isReplaySelection()){let t=this._pointSelectionPaneViewCache.get(e);t||(t=new Ps(this,e,this._model),this._pointSelectionPaneViewCache.set(e,t)),s.push(t)}let o=this._crosshairPaneViewCache.get(e);if(o||(o=new ts(this,e),this._crosshairPaneViewCache.set(e,o)),s.push(o),e===this._selectionPane&&s.push(this._selectionView),e===this._measurePane.value()){let t=this._measurePaneViewCache.get(e);t||(t=new fs(this,e),this._measurePaneViewCache.set(e,t)),t.update((0,nt.sourceChangeEvent)(this.id())),s.push(t)}if((Ki.addPlusButtonProperty.value()||this._showPlusButtonOnCursor.value())&&1!==(null===(t=Fe.crosshairLock.value())||void 0===t?void 0:t.type)){const t=e===this.pane,i=!Xt.CheckMobile.any()||window.screen.width>=320,o=Fe.tool.value(),r=(0,Me.isLineToolName)(o),n=null!==this._model.lineBeingEdited()||null!==this._model.lineBeingCreated()||this._model.sourcesBeingMoved().length>0||null!==this._model.customSourceBeingMoved()||(0,Fe.toolIsMeasure)(o);if(t&&this._isOnHoveredChartWidget&&this._crossHairSelectPointMode.value()===Fe.SelectPointMode.None&&i&&!r&&!n){const t=e.mainDataSource();if(null!==t){const i=t.priceScale();if(null!==i){const t=this._createPriceAxisViewOnDemand(this._priceAxisViews,this._panePriceAxisViews,e,i,this._currentPosPriceProvider,Di,!0)[1];null!==t&&s.push(t)}}}}return 0===(null===(i=Fe.crosshairLock.value())||void 0===i?void 0:i.type)&&(null===this._timeLockPaneView&&(this._timeLockPaneView=new ws(this)),s.push(this._timeLockPaneView)),s}dataWindowView(){return this._dataWindowView}updateAllViews(e){this._priceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._panePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._startMeasurePoint&&(this._startMeasurePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._startMeasureTimeAxisView.update(e)),this._lastMeasurePoint()&&(this._endMeasurePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._endMeasureTimeAxisView.update(e)),this._timeAxisView.update(e),this._selectionView.update(),this._dataWindowView.update(),this._updateVisibilityDependentPaneViews()}isMenuEnabled(){return this._options.menuEnabled}isHoveredEnabled(){return Ki.addPlusButtonProperty.value()||this._showPlusButtonOnCursor.value()}isHovered(){return this._model.hoveredSource()===this}pointToSelect(){return this._requestedPoint}paneForPointSelect(){return this._paneForRequestedPoint}_lastMeasurePoint(){
return this._endMeasurePoint?this._endMeasurePoint:(null!==this.pane&&this._measurePane.value()===this.pane&&(this._lastValidMeasurePoint={price:this._model.magnet().align(this.price,this.index,this.pane),index:this.index}),this._lastValidMeasurePoint||null)}_createPriceAxisViewOnDemand(e,t,i,s,o,r,a=!1){let l=e.get(i),c=null!==t?t.get(i):void 0;void 0===l&&(l=new Map,e.set(i,l),this.isMenuEnabled()&&null!==t&&(c=new Map,t.set(i,c)),a&&i.onDestroyed().subscribe(this,(()=>this._onPaneDestroyed(i))));let d=l.get(s);if(void 0===d){if(d=new r(this,i,s,o),l.set(s,d),void 0!==c){const e=new $i(d,this,s,this._model,this._options);c.set(s,e)}a&&s.lastSourceRemoved().subscribe(this,(()=>this._onPriceScaleCleared(s)))}let h=null;return void 0!==c&&(h=(0,n.ensureDefined)(c.get(s))),[d,h]}_onPaneDestroyed(e){e.onDestroyed().unsubscribeAll(this),this._priceAxisViews.delete(e),this._panePriceAxisViews.delete(e),this._startMeasurePriceAxisViews.delete(e),this._endMeasurePriceAxisViews.delete(e)}_onPriceScaleCleared(e){e.lastSourceRemoved().unsubscribeAll(this),this._priceAxisViews.forEach((t=>t.delete(e))),this._panePriceAxisViews.forEach((t=>t.delete(e))),this._startMeasurePriceAxisViews.forEach((t=>t.delete(e))),this._endMeasurePriceAxisViews.forEach((t=>t.delete(e)))}_tryToUpdateViews(e,t,i){return!!this._tryToUpdateData(e,t,i)&&(this.updateAllViews((0,nt.sourceChangeEvent)(this.id())),this._movedDelegate.fire({index:this.index,price:this.price}),!0)}_tryToUpdateData(e,t,i){const s=this.x,o=this.y,r=this.price,a=this.index,l=this.pane,c=this._priceScaleByPane(i);if(this.index=e,this.x=isNaN(e)?NaN:this._model.timeScale().indexToCoordinate(e),null!==c&&null!==i){this.pane=i,this.price=t;const e=(0,n.ensureNotNull)(i.mainDataSource()).firstValue();this.y=null===e?NaN:c.priceToCoordinate(t,e)}else this.pane=null,this.price=NaN,this.y=NaN;return s!==this.x||o!==this.y||a!==this.index||r!==this.price||l!==this.pane}_priceScaleByPane(e){return e&&!e.defaultPriceScale().isEmpty()?e.defaultPriceScale():null}_setSelectPointModeState(e){e===Fe.SelectPointMode.None&&(this._requestedPoint=null,this._selectLineColor=null,this._paneForRequestedPoint&&(this._paneForRequestedPoint=null,this._model.panesCollectionChanged().unsubscribe(this,this._paneCollectionChanged))),Fe.activePointSelectionMode.setValue(e),this._crossHairSelectPointMode.setValue(e),this._model.lightUpdate()}_paneCollectionChanged(e){const t=this._paneForRequestedPoint;null!==t&&-1===e.indexOf(t)&&this.cancelRequestSelectPoint()}_updateVisibilityDependentPaneViews(){var e;for(const t of this.model().panes())null===(e=this._pointSelectionPaneViewCache.get(t))||void 0===e||e.update()}_getLockData(){var e;if(null===this._lockData){const t=Fe.crosshairLock.value();if(null===t)this._lockData={};else{const i=this._model.timeScale(),s=null!==(e=i.points().roughIndex(t.time))&&void 0!==e?e:void 0,o=void 0===s?void 0:i.indexToCoordinate(s);switch(t.type){case 0:this._lockData={index:s,xCoord:o};break;case 1:{let e;const i=this.lockedPane();if(null!==i){const s=i.mainDataSource()
;if(null!==s){const i=s.firstValue(),o=s.priceScale();null!==o&&null!==i&&(e=o.priceToCoordinate(t.price,i))}}this._lockData={index:s,xCoord:o,yCoord:e}}}}}return this._lockData}_createMeasurePointset(e,t){const i=this._normalizePoint(e),s=this._normalizePoint(t),o=[[i.time_t,i.offset],[s.time_t,s.offset]];this._removeMeasurePointset(),++Os,this._currentMeasurePointsetAndSymbolId={measurePointsetId:Os,symbolId:(0,n.ensureNotNull)(this._model.mainSeries().seriesSource().symbolInstanceId())};const r=(0,Ns.getServerInterval)(this._model.mainSeries().interval());this._model.chartApi().createPointset(this._currentMeasurePointsetIdWithPrefix(),"turnaround",this._currentMeasurePointsetAndSymbolId.symbolId,r,o,this._onPointsetResponse.bind(this))}_removeMeasurePointset(){null!==this._currentMeasurePointsetAndSymbolId&&this._model.chartApi().isConnected().value()&&this._model.chartApi().removePointset(this._currentMeasurePointsetIdWithPrefix()),this._currentMeasurePointsetAndSymbolId=null}_currentMeasurePointsetIdWithPrefix(){return"pointsetMeasure_"+(0,n.ensureNotNull)(this._currentMeasurePointsetAndSymbolId).measurePointsetId}_normalizePoint(e){return{...this._model.timeScale().normalizeBarIndex(e.index),price:e.price}}_onPointsetResponse(e){if("pointset_error"===e.method)return void Vs.logError(`Error getting pointset: ${e.params[0]} ${e.params[1]}`);if(e.params.customId!==this._currentMeasurePointsetIdWithPrefix())return;if(null===this._startMeasurePoint||null===this._endMeasurePoint)return;const t=e.params.plots;if(2!==t.length)return;const i=t[0].value[0],s=t[1].value[0];this._startMeasurePoint.index=i,this._endMeasurePoint.index=s,this.updateAllViews((0,nt.sourceChangeEvent)(this.id())),this._model.updateSource(this)}}var Fs=i(965402),Hs=i(496416),zs=i(985429),Us=i(370407),Gs=i(615914),qs=i(427047),js=i(348065);class Ks{constructor(e){this._priceSourceNamesById=new Map,e.forEach((e=>this._priceSourceNamesById.set(e.id,e.name)))}name(e){var t;return null!==(t=this._priceSourceNamesById.get(e))&&void 0!==t?t:null}priceSourcesChanged(e){return e.length!==this._priceSourceNamesById.size}}var Zs=i(643322),Ys=i(272933);const $s=new Us.TranslatedString("remove deselected empty line tools",d.t(null,void 0,i(727171))),Xs=ne.enabled("auto_enable_symbol_labels"),Js=(0,ae.getLogger)("Chart.ChartModel");function Qs(e,t){const i=e.indexOf(t);return-1!==i&&(e.splice(i,1),!0)}function eo(e){var t,i;for(let s=e.length;s--;){const o=e[s].dataSources();for(let e=o.length;e--;)null===(t=o[e].dataWindowView())||void 0===t||t.update();const r=e[s].priceDataSources();for(let e=r.length;e--;)null===(i=r[e].legendView())||void 0===i||i.update()}}const to={isSnapshot:!1,readOnly:!1,watermarkEnabled:!0,shiftVisibleRangeOnNewBar:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,countdownEnabled:!0,lastPriceAnimationEnabled:!0,onWidget:!1,hideIdeas:!1},io={throttle:o.default,debounce:s.default},so=new Map([[v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction,{timeout:2e3,adapter:"debounce"
}],[v.RecalcVisibleRangeStudiesReason.DataUpdate,{timeout:5e3,adapter:"throttle"}],[v.RecalcVisibleRangeStudiesReason.SeriesRestart,{timeout:2e3,adapter:"debounce"}],[v.RecalcVisibleRangeStudiesReason.SeriesCompleted,{timeout:2e3,adapter:"debounce"}],[v.RecalcVisibleRangeStudiesReason.StudyCreation,{timeout:2e3,adapter:"debounce"}]]),oo=Array.from(so.values());class ro{constructor(e,t,i,o,r,n,a,l,c,d){this._onRearrangePanes=new V.Delegate,this._lineToolsGroupModel=new Gt,this._sourcesBeingMoved=[],this._activeItemBeingMoved=null,this._lineBeingEdited=null,this._linePointBeingEdited=null,this._linePointBeingChanged=null,this._customSourceBeingMovedHitTestData=null,this._customSourceBeingMoved=null,this._dataSourceCollectionChanged=new V.Delegate,this._sourceProperitesChanged=new V.Delegate,this._sourceZOrderChanged=new V.Delegate,this._symbolSourceResolved=new V.Delegate,this._symbolSourceResolvingActive=new W.WatchedValue(!1),this._adjustForDividendsAvailability=new W.WatchedValue(0),this._adjustForDividendsEnabled=new W.WatchedValue(!1),this._currentTool="",this._lineBeingCreated=null,this._paneBeingCreatedLineOn=null,this._lineCancelled=new V.Delegate,this._phantomSourceContainer=new bi(this),this._destroyed=!1,this._isSettingsExternalPosition=!1,this._isTimeScrolling=!1,this._magnet=new Ti,this._scrollingState=null,this._modelIntervals=[],this._rendererOptionsProvider=new B(this),this._studyInserted=new V.Delegate,this._cachedStudiesMaxOffset=0,this._replayStatus=new W.WatchedValue(0),this._panes=[],this._tagsChanged=new V.Delegate,this._strategySources=[],this._strategySourcesChange=new V.Delegate,this._activeStrategySource=new W.WatchedValue(null),this._symbolIntervalChanged=new V.Delegate,this._paneCollapsingAvailable=new W.WatchedValue(!1),this._panesCollectionChanged=new V.Delegate,this._scrollEnabled=ne.enabled("chart_scroll"),this._zoomEnabled=ne.enabled("chart_zoom"),this._lollipopSourcesWatcher=null,this._alertsWatcher=null,this._hoveredSource=null,this._hoveredSourceChanged=new V.Delegate,this._lastHoveredHittestData=null,this._hoveredSourceOrigin=null,this._lastSelectedHittestData=null,this._topmostCustomSources=[],this._fgCustomSources=[],this._bgCustomSources=[],this._allCustomSources=[],this._customSourcesMap=new Map,this._multiPaneSources=[],this._showLegendProperty=new A.Property,this._id=(0,le.guid)(),this._chartSaveTime=null,this._availableCurrenciesList=null,this._availableCurrencies=new Si([]),this._availablePriceSources=new Ks([]),this._availableUnitsObject=null,this._availableUnits=new vi({}),this._availablePriceSourcesBySymbol=new Map,this._shouldBeSavedEvenIfHidden=!1,this._watchedThemeSpawn=h.watchedTheme.spawn(),this._gradientColorsCache=null,this._studiesWV=new F.WatchedObject([],b.compareTwoCollectionsByIds),this._studiesExcludeInternalWV=new F.WatchedObject([],b.compareTwoCollectionsByIds),this._resetScalesAvailable=new W.WatchedValue(!1),this._recalcVRStudiesParams={reasons:new Set},this._recalcColorStudiesParams={},this._replayStudyStrategy=new W.WatchedValue(null),
this._recalcVisibleRangeStudiesImplDebouncedByAdapter=new Map(Object.keys(io).map((e=>[e,new Map(oo.filter((t=>t.adapter===e)).map((e=>[e.timeout,io[e.adapter](this._recalcVisibleRangeStudiesImpl.bind(this,this._recalcVRStudiesParams),e.timeout)])))]))),this._recalcColorStudiesImplDebounced=(0,s.default)(this._recalcColorStudiesImpl.bind(this,this._recalcColorStudiesParams),250),this._width=0,this._resetScales=new V.Delegate,this._chartThemeLoaded=new V.Delegate,this._selection=new T,this._selectedSourceChanged=new V.Delegate,this._symbolSourceCollectionChanged=new V.Delegate,this._gridSource=new Ai,this._visibleRangeStudiesInputs=new F.WatchedObject(null),this._syncPointCache=new Map,this._lastAppliedGotoTimeRange=null,this._lastGotoTimeRange=null,this._lollipopSourcesWatcherLoader=null,this._sessions=null,this._onMultipaneSourcesCollectionChanged=new V.Delegate,this._replayStudyStrategyInputs=null,this._clearSelection=()=>{this._lastSelectedHittestData=null,this._selection.clear()},this._removeSourceFromSelection=e=>{this._selection.remove(e)},this._addSourceToSelection=(e,t)=>{const i=this._selection.isSelected(e);i&&this._lastSelectedHittestData===t||e&&!e.isSelectionEnabled()||(this._lastSelectedHittestData=t||null,i||this._selection.add(e))},this._recalcSymbolResolvingActive=()=>{for(const e of this._panes)if(e.symbolSourceResolvingActive().value())return void this._symbolSourceResolvingActive.setValue(!0);this._symbolSourceResolvingActive.setValue(!1)},this._recalcAdjustForDividendsAvailability=()=>{var e,t,i,s;if(this._symbolSourceResolvingActive.value())return;const o=this.mainSeries();switch(null!==(t=null===(e=o.symbolInfo())||void 0===e?void 0:e.allowed_adjustment)&&void 0!==t?t:"none"){case"dividends":return void this._adjustForDividendsAvailability.setValue(2);case"splits":return void this._adjustForDividendsAvailability.setValue(1);case"any":return void this._adjustForDividendsAvailability.setValue(3)}for(const e of this.symbolSources().filter(Ae.isActingAsSymbolSource)){if(e.symbolHibernated().value()||e===o)continue;if("any"===(null!==(s=null===(i=e.symbolInfo())||void 0===i?void 0:i.allowed_adjustment)&&void 0!==s?s:"none"))return void this._adjustForDividendsAvailability.setValue(3)}this._adjustForDividendsAvailability.setValue(0)},this._recalcAdjustForDividendsEnabled=()=>{switch(this._adjustForDividendsAvailability.value()){case 2:return void this._adjustForDividendsEnabled.setValue(!0);case 0:case 1:return void this._adjustForDividendsEnabled.setValue(!1)}this._adjustForDividendsEnabled.setValue(this.mainSeries().properties().childs().dividendsAdjustment.value())},this._recalcPaneCollapsingAvailable=e=>{let t=this._panes.filter((e=>!e.collapsed().value())).length;0===t&&e&&this._panes.length>0&&(this._panes[0].collapsed().setValue(!1),t=1),this._paneCollapsingAvailable.setValue(t>1)},this._updateResetScalesAvailableValue=()=>{const e=this._timeScale.resetAvailable().value()||this._panes.some((e=>e.resetPriceScalesAvailable().value()));this._resetScalesAvailable.setValue(e)},this._chartApi=e,
this._invalidateHandler=t,this._undoModel=r,this._properties=i,this._options=(0,ue.merge)((0,ue.clone)(to),a),this._hibernateWV=l,this._linkingGroupIndex=c,this._isAutoSaveEnabled=d,this._readOnly=this._options.readOnly,this._isSnapshot=this._options.isSnapshot,this._alertsWatcher=new si(this),this.onWidget()||ai.withWeekdayProperty.subscribe(this,(()=>this._updateDateTimeFormatter())),this._chartSaveTime=(new Date).valueOf(),this._backgroundColor=new W.WatchedValue(this._getBackgroundColor()),this._backgroundTopColor=new W.WatchedValue(this._getBackgroundColor(!0)),this._properties.childs().paneProperties.childs().background.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundType.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundGradientStartColor.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundGradientEndColor.subscribe(this,this._updateBackgroundColor),this._backgroundColor.subscribe(this.recalcColorStudies.bind(this,!1)),this._backgroundTopColor.subscribe(this.recalcColorStudies.bind(this,!1)),this._backgroundCounterColor=new W.WatchedValue(this._getBackgroundCounterColor()),this._backgroundColor.subscribe((()=>this._backgroundCounterColor.setValue(this._getBackgroundCounterColor()))),this._isDark=(0,Zs.combine)((e=>"white"===e),this._backgroundCounterColor.weakReference()),this._watchedThemeSpawn.subscribe(this._updateBackgroundColor.bind(this)),this._symbolSourceResolvingActive.subscribe(this._recalcAdjustForDividendsAvailability),(0,Fe.init)();const u=this._readOnly?new A.Property((0,$.defaults)("chartproperties.paneProperties.crossHairProperties")):this._properties.childs().paneProperties.childs().crossHairProperties;this.m_crossHairSource=new Ws(this,u,this._options.crossHair),this._crossHairSelectPointMode=this.m_crossHairSource.selectPointMode().spawn(),this._crossHairSelectPointMode.subscribe((e=>{if(e!==Fe.SelectPointMode.None&&this.lineBeingCreated()){const e=Fe.tool.value();this.cancelCreatingLine(),Fe.tool.setValue(e)}})),this._tagsChanged=new V.Delegate;const p=new L.DefaultProperty({defaultName:"chartproperties.mainSeriesProperties",excludedDefaultsKeys:["priceAxisProperties.lockScale","priceAxisProperties.percentage","priceAxisProperties.indexedTo100","priceAxisProperties.isInverted","priceAxisProperties.log","priceAxisProperties.logDisabled","priceAxisProperties.percentageDisabled","priceAxisProperties.autoScaleDisabled"]});p.merge(i.childs().mainSeriesProperties.state()),this._timeScale=new Wt(this,this._options.timeScale),this._timeScale.resetAvailable().subscribe(this._updateResetScalesAvailableValue);const _={countdownEnabled:this._options.countdownEnabled,lastPriceAnimationEnabled:this._options.lastPriceAnimationEnabled};this.m_mainSeries=new Le.Series(this,p,_,o),this.m_mainSeries.onStyleChanged().subscribe(this._timeScale,this._timeScale.invalidateVisibleBars);const m=()=>this.fullUpdate()
;this.m_mainSeries.properties().childs().showCountdown.subscribe(this,(()=>{this.m_mainSeries.updateAllViews((0,nt.sourceChangeEvent)(this.m_mainSeries.id())),m()})),(0,z.currencyUnitVisibilityProperty)().subscribe(this,m),(0,U.autoLogButtonsVisibilityProperty)().subscribe(this,m),this._timeScale.visibleBarsStrictRangeChanged().subscribe(this.m_mainSeries,this.m_mainSeries.clearHighLowPriceCache),this._timeScale.visibleBarsStrictRangeChanged().subscribe(this.m_mainSeries,this.m_mainSeries.clearAveragePriceCache),this.createPane(void 0,{axisProperties:p.childs().priceAxisProperties.state(["autoScale"])}),this._adjustForDividendsAvailability.subscribe(this._recalcAdjustForDividendsEnabled),this.mainSeries().properties().childs().dividendsAdjustment.subscribe(this,this._recalcAdjustForDividendsEnabled),this._recalcAdjustForDividendsEnabled(),this._boundUpdateStudiesMaxOffset=this._updateStudiesMaxOffset.bind(this),this.mainSeries().dataEvents().seriesTimeFrame().subscribe(this,((e,t,i,s)=>{if(null!==this._lastAppliedGotoTimeRange&&null!==i&&s&&(0,yi.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i)){const e=this.appliedTimeFrame().value();null!==e&&!this._lastAppliedGotoTimeRange.actual&&(0,yi.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,e.val)&&this.appliedTimeFrame().setValue(null),this._lastAppliedGotoTimeRange=null}})),this.mainSeries().dataEvents().completed().subscribe(this,(e=>{null===this._lastAppliedGotoTimeRange&&null!==this._lastGotoTimeRange&&(this.gotoTimeRange(this._lastGotoTimeRange.from,this._lastGotoTimeRange.to),this._lastGotoTimeRange=null)}));const g=this._panes[0];g.setStretchFactor(2*g.stretchFactor()),this._properties.listeners().subscribe(this,this.lightUpdate),this._properties.childs().timezone.subscribe(null,(()=>{this._chartApi&&this._chartApi.isConnected().value()&&this._chartApi.switchTimezone(this.timezone())})),g.addDataSource(this.m_mainSeries,g.findSuitableScale(this.m_mainSeries),!1),this._barsMarksSources=n(this);for(const e of this._barsMarksSources)e.setOwnerSource(this.m_mainSeries),g.addDataSource(e,this.m_mainSeries.priceScale(),!0);this.m_mainSeries.symbolResolved().subscribe(this,this._clearAvailablePriceSources),this.m_mainSeries.onSymbolIntervalChanged().subscribe(this,this._onSymbolIntervalChanged),this._createLollipopSourcesWatcher(),this._watermarkSource=this._options.watermarkEnabled?new re(this):null,this._timezoneExceptExchange=(0,Zs.combine)(((e,t)=>"exchange"!==e?e:t),(0,Ys.createWVFromProperty)(this._properties.childs().timezone).ownership(),(0,Ys.createWVFromGetterAndSubscription)((()=>{var e,t;return null!==(t=null===(e=this.mainSeries().symbolInfo())||void 0===e?void 0:e.timezone)&&void 0!==t?t:null}),this.mainSeries().symbolResolved()).ownership())}restart(){var e,t;this._chartApi.switchTimezone(this.timezone()),this._timeScale.reset(),this.m_mainSeries.restart();for(const e of this.dataSources())e.restart&&e!==this.m_mainSeries&&e.restart();null===(t=null===(e=this._sessions)||void 0===e?void 0:e.get())||void 0===t||t.restart()}version(){
return 3}collapsed(){return this._hibernateWV}visibleRangeStudiesInputs(){return this._visibleRangeStudiesInputs.readonly()}chartSaveTime(){return this._chartSaveTime}setChartSaveTime(e){this._chartSaveTime=e}destroy(){var e;this._phantomSourceContainer.destroy(),this._hoveredSourceChanged.destroy(),null!==this._watermarkSource&&(this._watermarkSource.destroy(),this._watermarkSource=null),Array.from(this._customSourcesMap.keys()).forEach(this._removeCustomSource,this),(0,n.assert)(0===this._topmostCustomSources.length),(0,n.assert)(0===this._fgCustomSources.length),(0,n.assert)(0===this._bgCustomSources.length),(0,n.assert)(0===this._allCustomSources.length),(0,n.assert)(0===this._customSourcesMap.size),null!==this._lollipopSourcesWatcher&&(this._lollipopSourcesWatcher.destroy(),this._lollipopSourcesWatcher=null),null!==this._alertsWatcher&&this._alertsWatcher.destroy(),this.onWidget()||ai.withWeekdayProperty.unsubscribeAll(this),this._properties.childs().paneProperties.childs().background.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundType.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundGradientEndColor.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundGradientStartColor.unsubscribeAll(this),this._watchedThemeSpawn.destroy(),this._lastHoveredHittestData=null,this._lastSelectedHittestData=null,(0,z.currencyUnitVisibilityProperty)().unsubscribeAll(this),(0,U.autoLogButtonsVisibilityProperty)().unsubscribeAll(this),this._alertsList&&(this._alertsList.destroy(),this._alertsList=void 0),window.loginStateChange.unsubscribeAll(this),this._crossHairSelectPointMode.destroy(),this.m_mainSeries.symbolResolved().unsubscribe(this,this._clearAvailablePriceSources),this.m_mainSeries.onSymbolIntervalChanged().unsubscribe(this,this._onSymbolIntervalChanged),this._timezoneExceptExchange.destroy(),null===(e=this._lollipopSourcesWatcherLoader)||void 0===e||e.destroy(),this._destroyed=!0}undoModel(){return this._undoModel}onData(e){switch(e.method){case"timescale_update":{const t=e.params;this._updateTimeScale({index:t.index,zoffset:t.zoffset,values:t.changes,indexDiffs:t.index_diff,baseIndex:t.baseIndex,marks:t.marks,clearFlag:t.clear});break}case"timescale_completed":{const t=Boolean(e.params[0]);this._timeScale.onTimeScaleCompleted(t);break}}}addStrategySource(e,t){1!==t&&-1===this._strategySources.indexOf(e)&&(this._strategySources.push(e),this._strategySourcesChange.fire(t),this.setActiveStrategySource(e))}removeStrategySource(e,t){if(1===t)return;const i=this._strategySources.indexOf(e);if(-1!==i){if(this._strategySources.splice(i,1)[0]===this._activeStrategySource.value()&&this.unsetActiveStrategySource(),this._strategySources.length>0){const e=this._strategySources[this._strategySources.length-1];this.setActiveStrategySource(e)}this._strategySourcesChange.fire(t)}}setActiveStrategySource(e){-1!==this._strategySources.indexOf(e)&&this._activeStrategySource.setValue(e)}unsetActiveStrategySource(){
this._activeStrategySource.setValue(null)}activeStrategySource(){return this._activeStrategySource}strategySources(){return this._strategySources}strategySourcesChange(){return this._strategySourcesChange}replayStudyStrategy(){return this._replayStudyStrategy}setReplayStudyStrategy(e){this._replayStudyStrategy.setValue(e)}async replayStudyStrategyProperties(){if(null===this._replayStudyStrategyInputs){const e=await(0,di.getReplayStrategyMetaInfo)();if(null!==this._replayStudyStrategyInputs)return this._replayStudyStrategyInputs;this._replayStudyStrategyInputs=new L.DefaultProperty({defaultName:"replayStudyStrategyInputs",factoryDefaultsSupplier:()=>(0,ue.clone)(e.defaults.inputs)})}return this._replayStudyStrategyInputs}clearReplayStudyStrategyProperties(){this._replayStudyStrategyInputs=null}setScrollEnabled(e){this._scrollEnabled=e}scrollEnabled(){return this._scrollEnabled}setZoomEnabled(e){this._zoomEnabled=e}zoomEnabled(){return this._zoomEnabled}zoomToViewport(e,t,i,s,o){this.setTimeViewport(e,t);let r=Math.min(i,s),n=Math.max(i,s);const a=o.defaultPriceScale();a.isPercentage()||a.setMode({autoScale:!1}),a.isLog()&&(r=a.priceToLogical(r),n=a.priceToLogical(n)),a.setPriceRange(new xe.PriceRange(r,n)),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.invalidate(this._paneInvalidationMask(o,H.InvalidationLevel.Light))}setTimeViewport(e,t){const i=this.appliedTimeFrame().value();null!==this._lastAppliedGotoTimeRange&&null!==i&&(0,yi.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i.val)&&!this._lastAppliedGotoTimeRange.actual||(this.timeScale().zoomToBarsRange(e,t),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction),this.lightUpdate())}onTagsChanged(){return this._tagsChanged}canZoomIn(){return this._timeScale.canZoomIn()&&this._zoomEnabled}canZoomOut(){return this._timeScale.canZoomOut()&&this._zoomEnabled}onPaneTagsChanged(){this._tagsChanged.fire()}panesCollectionChanged(){return this._panesCollectionChanged}dataSourceCollectionChanged(){return this._dataSourceCollectionChanged}symbolSourceCollectionChanged(){return this._symbolSourceCollectionChanged}symbolSourceResolved(){return this._symbolSourceResolved}symbolSourceResolvingActive(){return this._symbolSourceResolvingActive}adjustForDividendsAvailability(){return this._adjustForDividendsAvailability}adjustForDividendsEnabled(){return this._adjustForDividendsEnabled}paneCollapsingAvailable(){return this._paneCollapsingAvailable}sourcePropertiesChanged(){return this._sourceProperitesChanged}sourceZOrderChanged(){return this._sourceZOrderChanged}zoomTime(e,t,i){if(!this._zoomEnabled)return;const s=this.timeScale();if(s.isEmpty()||0===t)return;const o=s.width();e=Math.max(1,Math.min(e,o-2)),s.zoom(e,t,i),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.lightUpdate(),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction)}lineBeingEdited(){return this._lineBeingEdited}linePointBeingEdited(){
return this._linePointBeingEdited}activeItemBeingMoved(){return this._activeItemBeingMoved}linePointBeingChanged(){return this._linePointBeingChanged}mainSeries(){return this.m_mainSeries}updateAllPaneViews(e){var t;for(const t of this._panes)t.updateAllViews(e);null===(t=this._watermarkSource)||void 0===t||t.updateAllViews(e)}dataSources(){const e=[this.crossHairSource()];for(const t of this._panes)for(const i of t.dataSources())e.push(i);return e}priceDataSources(){const e=[];for(const t of this._panes)for(const i of t.priceDataSources())e.push(i);return e}symbolSources(){const e=[];for(const t of this._panes)for(const i of t.symbolSources())e.push(i);return e}orderedDataSources(e){let t=[this.m_crossHairSource];for(let i=0;i<this._panes.length;i++){let s=this._panes[i].sourcesByGroup().all();e&&(s=s.slice().reverse()),t=t.concat(s)}return t}timeScale(){return this._timeScale}selection(){return this._selection}selectionMacro(e,t=!1){const i=this.selection().allSources();e({removeSourceFromSelection:this._removeSourceFromSelection,addSourceToSelection:this._addSourceToSelection,clearSelection:this._clearSelection,selection:this.selection.bind(this)});const s=(0,b.subtract)(i,this.selection().allSources()),o=(0,b.subtract)(this.selection().allSources(),i);o.concat(i).forEach((e=>e.updateAllViews((0,nt.selectionChangeEvent)())));let r=[];if(s.forEach((e=>{if((0,C.isLineTool)(e)){const i=e.hasAlert().value()&&e.getAlertSync();i&&!i.isPrice()&&i.setSelected(!1),!t&&e.shouldBeRemovedOnDeselect()&&r.push(e)}})),o.forEach((e=>{const t=(0,C.isLineTool)(e)&&e.hasAlert&&e.hasAlert().value()&&e.getAlertSync();t&&t.setSelected(!0)})),1===o.length){const[e]=o;(0,C.isLineTool)(e)&&e.hasAlert().value()&&0===e.alertStatus().value()&&e.synchronizeAlert().catch((()=>{}))}r=r.filter((e=>null!==this.dataSourceForId(e.id()))),r.length>0&&this._undoModel.removeSources(r,!1,$s),this.lightUpdate(),(s.length>0||o.length>0)&&this._selectedSourceChanged.fire()}onSelectedSourceChanged(){return this._selectedSourceChanged}checkLineToolSelection(){const e=this.selection().allSources();this._selection.checkLineToolSelection(),e.length!==this.selection().allSources().length&&this._selectedSourceChanged.fire()}lineToolsGroupModel(){return this._lineToolsGroupModel}restoreLineToolsGroups(e){this._lineToolsGroupModel=Gt.fromState(this,e)}realignLineTools(e){for(const t of this._panes)(void 0===e||t.hasDataSource(e))&&t.realignLineTools(e)&&this._dataSourceCollectionChanged.fire(t)}copyToOtherCharts(e,t){const i=this.mainSeries(),s=i.syncModel(),o=this.timeScale();if(s)for(const r of e){if(!r.isSynchronizable())continue;const e=r.linkKey().value()||(0,le.randomHash)();r.linkKey().setValue(e);const a=r.state(!1),l=r.normalizedPoints(),c=r.normalizedPointsForCreating(),d=r.properties().interval.value(),h=i.interval(),u=e=>{if(I.Interval.isEqual(d,h))return e.map((e=>{const t=(0,n.ensureNotNull)(o.timePointToIndex(e.time_t))+e.offset;return{price:e.price,timeStamp:(0,n.ensureNotNull)(this.externalTimeStamp(t))}}));{
const t=s.createNewModelWithResolution(d);return e.map((e=>({price:e.price,timeStamp:0===e.offset?e.time_t:t.projectTime(e.time_t,e.offset)})))}},p=u(l),_=u(c),m={...a,id:r.id(),linkKey:e,points:p,pointsForCreating:_,linetool:r.toolname,model:this,symbol:i.symbol(),withUndo:t,zOrder:r.zorder(),finalState:{points:l,interval:d},pointPositionPercents:r.isFixed()?r.calcPositionPercents():void 0,sharingMode:r.sharingMode().value()};(0,Fe.copyLineTool)(m)}}isSnapshot(){return this._isSnapshot}onWidget(){return this._options.onWidget}hideIdeas(){return this._options.hideIdeas}updateSource(e){const t=this._invalidationMaskForSource(e);null!==t&&this.invalidate(t)}updateSourcePriceScale(e){const t=this._invalidationMaskForSourcePriceScale(e);null!==t&&this.invalidate(t)}updatePane(e){this.invalidate(this._paneInvalidationMask(e))}updateTimeScaleBaseIndex(e){const t=this.mainSeries().bars();t.isEmpty()||this._updateBaseIndex((0,n.ensureNotNull)(t.lastIndex()),!!(e&&e.index>0))}setInterval(e,t){const i=setInterval(e,t);return this._modelIntervals.push(i),i}clearInterval(e){clearInterval(e);const t=this._modelIntervals.indexOf(e);t>-1&&this._modelIntervals.splice(t,1)}clearIntervals(){for(let e=0;e<this._modelIntervals.length;e++)clearInterval(this._modelIntervals[e]);this._modelIntervals=[]}createStudyInserter(e){const t={createStudy:(e,t,i,s,o,r,n,a,l,c,d,h,u)=>this.insertStudyWithParams(e,t,i,o,r,n,a,l,c,d,h,u),storeFailedStub:e=>{}};return new js.StudyInserter(e,t)}insertStudyWithParams(e,t,i,s,o,a,l,c,d,h,u,p){var m;let g=null;if(!o&&void 0!==e.groupingKey){const t=this.findNonOverlayStudyWithGroupingKey(e.groupingKey);null!==t&&(g=t.pane)}null===g&&(o||e.is_price_study?g=(0,n.ensureNotNull)(this.paneForSource(null!==(m=null==a?void 0:a[0])&&void 0!==m?m:this.m_mainSeries)):(g=this.createPane(),void 0!==h&&g.setPaneSize(h))),"Compare@tv-basicstudies"===e.id&&this.m_mainSeries.priceScale().setMode({log:!1,percentage:!0});const S=(0,ue.merge)((0,r.default)(null!=s?s:{}),{inputs:t,parentSources:[]});let f=!1,b=null,y=null;const C=null!=a?a:[],w=(0,x.prepareStudyProperties)(e,S,g,(0,N.studyMetaInfoRepository)().studyVersioning(),C),T=(0,O.createStudy)(this,w,C,e,p),P=(0,_.createDeferredPromise)();return T.then((e=>{var t,s,o;if(f)return e.stop(),void(null===(t=e.destroy)||void 0===t||t.call(e));b=e.id();const r=g.findSuitableScale(e,null!==(s=null==a?void 0:a[0])&&void 0!==s?s:this.mainSeries(),l);if(y=r.mode(),r===this.mainSeries().priceScale()&&(0,Ae.isSymbolSource)(e)){const t=c?(0,Gs.sourceNewCurrencyOnPinningToPriceScale)(e,r,this,!0):null,i=d?(0,Ee.sourceNewUnitOnPinningToPriceScale)(e,r,this,!0):null;null===t&&null===i||e.setSymbolParams({currency:t||void 0,unit:i||void 0})}if((0,Ae.isSymbolSource)(e)&&(0,n.ensureNotNull)(g).hasDataSource(this.mainSeries())&&Xs&&!q.getBool("enable_symbol_labels_on_inserting_compare_once",!1)&&((0,L.allowSavingDefaults)(!0),this.properties().childs().scalesProperties.childs().showSymbolLabels.setValue(!0),(0,L.allowSavingDefaults)(!1),
q.setValue("enable_symbol_labels_on_inserting_compare_once",!0)),P.resolve(e.start()),i&&g.id()===i.paneId)g.insertDataSource(e,r,i.zorder);else{g.addDataSource(e,r,!1);null!==e.preferredZOrder()&&g.insertAfter([e],this.mainSeries())}void 0!==u&&r.setMode(u),e.isLinkedToSeries()&&e.setOwnerSource(this.mainSeries()),this.recalculatePane(g,(0,nt.sourceChangeEvent)(e.id())),this.fullUpdate(),this._invalidateBarColorerCaches(),this._recalcVisibleRangeStudiesImpl({studies:[e],reasons:new Set([v.RecalcVisibleRangeStudiesReason.StudyCreation])}),this._recalcColorStudiesImpl({studies:[e],force:!0}),this._studyInserted.fire(e),null===(o=this.alertsWatcher())||void 0===o||o.syncSourceAlertLabels(e),e.maxOffset().subscribe(this._boundUpdateStudiesMaxOffset,{callWithLast:!0})})),{study:T,startPromise:P.promise,cancel:()=>f=!0,entityId:()=>b,originalScaleMode:()=>y}}replaceStudyStub(e,t){const i=this.paneForSource(e);if(null===i)return!1;const s=e.priceScale(),o=e.zorder(),r=e.ownerSource();return this.paneForSource(e)===i?i.replaceSource(e,t,s):(i.insertDataSource(t,s,o),this.removeSource(e)),t.setOwnerSource(r),this.dataSources().forEach((i=>{i.ownerSource()===e&&i.setOwnerSource(t)})),this._invalidateBarColorerCaches(),t.start(),this.recalculatePane(i,(0,nt.sourceChangeEvent)(t.id())),this.fullUpdate(),!0}insertStudyStub(e,t,i,s){const o=void 0!==t,r=new M.StudyStub(this,null!=i?i:null,e,o,null!=s?s:null);let a;if(t||!o){a=(0,n.ensureNotNull)(this.mainPane());const e=!0===t?this.mainSeries().priceScale():a.createPriceScaleAtPosition("overlay");a.addDataSource(r,e,!1)}else a=this.createPane(),a.addDataSource(r,null,!1);return r.setZorder(a.newStudyZOrder()),this.recalculatePane(a,(0,nt.sourceChangeEvent)(r.id())),this.fullUpdate(),r}removeStudyStub(e){const t=this.dataSourceForId(e);return null===t?(Js.logNormal("StudyStub id="+e+" is not found in chart model"),!1):(this.removeSource(t),!0)}restoreStudyStub(e){var t;const i=this.insertStudyStub(e.title,e.isOverlay,e.descriptor);return null===(t=this.paneForSource(i))||void 0===t||t.changeSourceId(i,e.id),i.setStatus(e.status),i}allLineTools(){return this._getAllSources(C.isLineTool)}setHoveredSource(e,t=null,i){const s=this._hoveredSource!==e;if(this._hoveredSourceOrigin=null!=i?i:null,!s&&(0,hi.hitTestResultDataAreEqual)(this._lastHoveredHittestData,t))return;this._lastHoveredHittestData=t;let o=null;if(this._hoveredSource){this._hoveredSource.updateAllViews((0,nt.selectionChangeEvent)()),o=new H.InvalidationMask(H.InvalidationLevel.Cursor);const e=this._invalidationMaskForSource(this._hoveredSource,H.InvalidationLevel.Light);null!==e&&o.merge(e)}if(this._hoveredSource=e,e){e.updateAllViews((0,nt.selectionChangeEvent)()),o||(o=new H.InvalidationMask(H.InvalidationLevel.Cursor));const t=this._invalidationMaskForSource(e,H.InvalidationLevel.Light);null!==t&&o.merge(t)}o&&this.invalidate(o),s&&this._hoveredSourceChanged.fire(e)}properties(){return this._properties}chartApi(){return this._chartApi}disconnect(){var e,t
;null===(t=null===(e=this._sessions)||void 0===e?void 0:e.get())||void 0===t||t.stop();for(const e of this.dataSources())e.disconnect&&e.disconnect();this._timeScale.disconnect()}crossHairSource(){return this.m_crossHairSource}gridSource(){return this._gridSource}publishedChartsTimelineSource(){for(const e of this._barsMarksSources)if(e instanceof li.PublishedChartsTimeline)return e;return null}hoveredSource(){return this._hoveredSource}hoveredSourceOrigin(){return this._hoveredSourceOrigin}hoveredSourceChanged(){return this._hoveredSourceChanged}lastHittestData(){return this._lastHoveredHittestData}lastSelectedHittestData(){return this._lastSelectedHittestData}lightUpdate(){this.invalidate(H.InvalidationMask.light())}fullUpdate(){this.invalidate(H.InvalidationMask.full())}syncTimeWithModel(e,t){const i=this.mainSeries().syncModel();if(null===i)return;const s=1e3*this.createSyncPoint(e,i.syncSourceTarget()).sourceTimeToTargetTime(t/1e3),o=(0,qt.get_timezone)(this.timezone());let r=(0,qt.utc_to_cal)(o,s);this.mainSeries().isDWM()&&(r=i.getSession().spec.correctTradingDay(r),(0,qt.set_hms)(r,0,0,0,0,(0,qt.get_timezone)("Etc/UTC"))),this._gotoTimeImpl(r.getTime(),{centerIfVisible:!1})}gotoTime(e){return this._gotoTimeImpl(e,{centerIfVisible:!0})}recalculatePane(e,t){null==e||e.recalculate(t)}recalculateAllPanes(e){this._panes.forEach((t=>t.recalculate(e))),this.updateAllPaneViews(e),this.crossHairSource().updateAllViews(e)}gotoTimeRange(e,t){const i=this.timeScale(),s=i.tickMarks(),o=this.mainSeries();if(void 0===s.minIndex)return void(this._lastGotoTimeRange={from:e,to:t});let r=e,a=t;if(null!==o.symbolInfo()){const i=(0,n.ensureNotNull)(this.timezoneExceptExchange().value()),s=(0,qt.get_timezone)(i),l=(0,qt.utc_to_cal)(s,e),c=(0,qt.utc_to_cal)(s,t);if(o.isDWM()){const e=(0,qt.get_timezone)("Etc/UTC");(0,qt.set_hms)(l,0,0,0,0,e),(0,qt.set_hms)(c,0,0,0,0,e)}r=l.getTime(),a=c.getTime()}const l=(0,n.ensureDefined)(s.maxIndex),c=(0,n.ensureDefined)(s.minIndex);if(r>=(0,n.ensureNotNull)(s.indexToTime(c)).valueOf()||o.endOfData()){const e=(e,t)=>e<t,t=e=>(0,n.ensureNotNull)(s.indexToTime(e)).valueOf(),d=(0,b.lowerboundExt)(t,r,e,s.nearestIndex(r),l);let h=r===a?d:(0,b.lowerboundExt)(t,a,e,s.nearestIndex(a),l);this._lastGotoTimeRange=null,null!==this._lastAppliedGotoTimeRange&&(this._lastAppliedGotoTimeRange.actual=!1);const u=i.baseIndex();if(d+Math.max(h-d+1,i.minVisibleBarCount())>u){const e=i.targetDefaultRightOffset();h-u<e&&(h=u+e)}const p=d===h&&d===c&&o.endOfData()?d-1:d;i.zoomToBarsRange(p,h),this.lightUpdate()}else{const i={type:"time-range",from:e/1e3,to:t/1e3};null===this._lastAppliedGotoTimeRange?(this._lastAppliedGotoTimeRange={range:i,actual:!0},o.loadDataTo(i)):(0,yi.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i)||(this._lastGotoTimeRange={from:e,to:t})}}paneForSource(e){if(!(0,f.isDataSource)(e))return Array.from(this._customSourcesMap.values()).includes(e)?this.paneForSource(this.mainSeries()):null;for(let t=this._panes.length-1;t>=0;t--)if(this._panes[t].hasDataSource(e))return this._panes[t]
;return e instanceof _i.BarsMarksContainer?this.paneForSource(this.mainSeries()):null}mainPane(){var e;return null!==(e=this._panes.find((e=>e.isMainPane())))&&void 0!==e?e:null}lastPane(){return this._panes[this._panes.length-1]}removeSource(e,t){this.selectionMacro((t=>t.removeSourceFromSelection(e)),!0),this._hoveredSource===e&&(this._hoveredSource=null,this._lastHoveredHittestData=null),this._sourcesBeingMoved.includes(e)&&(this._sourcesBeingMoved=this._sourcesBeingMoved.filter((t=>t!==e)),this._sourcesBeingMoved.length||(this._activeItemBeingMoved=null)),e===this._lineBeingEdited&&(this._lineBeingEdited=null,Fe.isToolEditingNow.setValue(!1)),e===this.lineBeingCreated()&&(this._lineBeingCreated=null,Fe.isToolCreatingNow.setValue(!1)),!t&&e.stop&&e.stop();(0,n.ensureNotNull)(this.alertsWatcher()).removeSourceAlertLabels(e);const i=this.detachSource(e),s=this.mainSeries().priceScale();return(0,O.isStudy)(e)&&(0,Ae.isActingAsSymbolSource)(e)&&e.priceScale()===s&&s.isPercentage()&&1===s.seriesLikeSources().filter(Ae.isActingAsSymbolSource).length&&s.setMode({percentage:!1}),this.fullUpdate(),this._invalidateBarColorerCaches(),(0,O.isStudy)(e)&&((0,m.emit)("study_event",e.id(),"remove"),e.isChildStudy()&&e.parentSources().forEach((t=>t.unsetChild(e))),e.maxOffset().unsubscribe(this._boundUpdateStudiesMaxOffset)),!t&&e.destroy&&e.destroy(),(0,C.isLineTool)(e)&&(e.removeAlert(),(0,m.emit)("drawing_event",e.id(),"remove")),i}timezone(){return this._properties.childs().timezone.value()}timezoneExceptExchange(){return this._timezoneExceptExchange}allStudies(e){const t=e?e=>(0,O.isStudy)(e)&&!(0,ge.isLollipopDataSource)(e):O.isStudy;return this._getAllSources(t)}studiesWV(e){return e?this._studiesExcludeInternalWV.readonly():this._studiesWV.readonly()}listUserStudies(e){const t=[];for(const i of this._panes)for(const s of i.priceDataSources())if(!(0,O.isFundamentalStudy)(s)&&(0,O.isStudy)(s)&&s.showInObjectTree()){const{id:i,shortDescription:o}=s.metaInfo();if(e.dontCountVolume&&"Volume@tv-basicstudies"===i||e.dontCountCompare&&"Compare@tv-basicstudies"===i||e.dontCountOverlay&&"Overlay@tv-basicstudies"===i)continue;t.push(o)}return t}findNonOverlayStudyWithGroupingKey(e,t){const i=void 0!==t?[t]:this._panes;for(const t of i){const i=t.dataSources().find((i=>(0,O.isStudy)(i)&&i.metaInfo().groupingKey===e&&!t.isOverlay(i)));if(void 0!==i)return{pane:t,study:i}}return null}movePaneUp(e){this.movePane(e,e-1)}movePaneDown(e){this.movePane(e,e+1)}movePane(e,t){const i=this._panes[e];this._panes.splice(e,1),this._panes.splice(t,0,i),this._panesCollectionChanged.fire(this._panes),this._onRearrangePanes.fire(),this.invalidate(H.InvalidationMask.panesOrder())}toggleCollapsedPane(e){const t=this._panes[e];t.collapsed().setValue(!t.collapsed().value()),this.fullUpdate()}backgroundColor(){return this._backgroundColor}backgroundTopColor(){return this._backgroundTopColor}backgroundColorAtYPercentFromTop(e){const t=this.backgroundColor().value(),i=this.backgroundTopColor().value();if(t===i)return t
;if(e=Math.max(0,Math.min(100,Math.round(100*e))),null===this._gradientColorsCache||this._gradientColorsCache.topColor!==i||this._gradientColorsCache.bottomColor!==t)this._gradientColorsCache={topColor:i,bottomColor:t,colors:new Map};else{const t=this._gradientColorsCache.colors.get(e);if(void 0!==t)return t}const s=(0,pi.gradientColorAtPercent)(i,t,e/100);return this._gradientColorsCache.colors.set(e,s),s}backgroundCounterColor(){return this._backgroundCounterColor.readonly()}dark(){return this._isDark}readOnly(){return this._readOnly}defaultResolutions(){return this.chartApi().defaultResolutions()}availableCurrencies(){const e=this._getAvailableCurrencies();return e.length!==this._availableCurrencies.size()&&(this._availableCurrencies=new Si(e)),this._availableCurrencies}currencyConversionEnabled(){return this._options.currencyConversionEnabled}availableUnits(){const e=this._getAvailableUnits();return this._availableUnits.unitsChanged(e)&&(this._availableUnits=new vi(e)),this._availableUnits}unitConversionEnabled(){return this._options.unitConversionEnabled}availablePriceSources(e){const t=this._getAvailablePriceSources(e);return null!==t&&this._availablePriceSources.priceSourcesChanged(t)&&(this._availablePriceSources=new Ks(t)),this._availablePriceSources}resetDeferredStudies(){Je.DeferredStudies.instance(this).reset()}waitForStudy(e){const t=this.dataSourceForId(e);return t&&(0,O.isStudy)(t)?Promise.resolve(t):Je.DeferredStudies.instance(this).get(e)}resetWaitForStudy(e){Je.DeferredStudies.instance(this).delete(e)}isJustClonedChart(){return this._undoModel.isJustClonedChart()}studyTemplate(e,t,i){const s={panes:[],version:this.version()};for(const e of this.panes())s.panes.push(e.state(!0,!1,!0));const o=this.mainSeries();return e&&(s.symbol=o.symbol(),this.currencyConversionEnabled()&&i&&(s.currency=o.currency()),this.unitConversionEnabled()&&i&&(s.unit=o.unit())),t&&(s.interval=o.interval()),s}getStudyById(e){const t=this.dataSourceForId(e);return null!==t&&(0,O.isStudy)(t)?t:null}getLineToolById(e){const t=this.dataSourceForId(e);return null!==t&&(0,C.isLineTool)(t)?t:null}restoreLineToolState(e,t,i){var s;e.restorePoints(t.points,t.indexes||[]),t.state.intervalsVisibilities=(0,et.mergeIntervalVisibilitiesDefaults)(t.state.intervalsVisibilities),e.properties().merge(t.state),e.restoreData&&e.restoreData(t),e.linkKey().setValue(t.linkKey||null),e.createServerPoints(),e.setZorder(null!==(s=t.zorder)&&void 0!==s?s:e.zorder()),this.fullUpdate();const o=e.linkKey().value();null!==o&&i&&(0,Fe.restoreLineToolState)({model:this,linkKey:o,state:t})}restoreFactoryDefaults(e){e.restoreFactoryDefaults(),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction)}preferences(){return(0,Hs.preferencesByWhiteList)(this,this.mainSeries())}applyPreferences(e){for(const[t,i]of Object.entries(e)){const e=this._properties.child(t);void 0!==i&&void 0!==e&&e.mergeAndFire(i)}if(void 0!==e.timeScale){const t=e.timeScale;this._timeScale.defaultRightOffset().setValue(t.defaultRightOffset),
this._timeScale.defaultRightOffsetPercentage().setValue(t.defaultRightOffsetPercentage),this._timeScale.usePercentageRightOffset().setValue(t.usePercentageRightOffset)}this._properties.saveDefaults(),this.m_mainSeries.applyPreferences(e.mainSeries),this.sessions().restoreState({properties:e.sessions},!1),this.recalculateAllPanes((0,nt.globalChangeEvent)()),this.fullUpdate()}restoreTheme(e,t,i){e.mainSourceProperties.hollowCandleStyle||(e.mainSourceProperties.hollowCandleStyle=e.mainSourceProperties.candleStyle),this._undoModel.chartLoadTheme(e,t,i)}onResetScales(){return this._resetScales}startMovingSources(e,t,i,s,o,r){this._sourcesBeingMoved=e,this._activeItemBeingMoved=i;let a=!1;if(this._sourcesBeingMoved.forEach((e=>{!a&&(0,O.isStudy)(e)&&(a=!0);const l=(0,n.ensureNotNull)(this.paneForSource(e)),c=(0,C.isLineTool)(e),d=c&&e.linkKey().value();if(!1!==d&&null!==d&&s.has(d)&&c&&e.isFixed()){const t=(0,n.ensureDefined)(s.get(d)),a={screen:this._percentPositionToPoint(t,l)};e.startMoving(a,i,o,r)}else e.startMoving(t,i,o,r);const h=this._paneInvalidationMask(l,H.InvalidationLevel.Light);this.invalidate(h)})),!r){const s=e.filter(C.isLineTool).filter((e=>e.linkKey().value()&&e.isSynchronizable())).map((e=>e.linkKey().value()));if(s.length&&t.logical){const r=this.externalTimeStamp(t.logical.index),a={linkKeys:s,model:this,symbol:this.mainSeries().symbol(),point:{price:t.logical.price,timeStamp:r},activeItem:null!==i?i:void 0,envState:o,pointPositionPercents:new Map};e.forEach((e=>{if((0,C.isLineTool)(e)){const i=e.linkKey().value();if(i&&e.isSynchronizable()&&e.isFixed()){const s=(0,n.ensureNotNull)(this.paneForSource(e));a.pointPositionPercents.set(i,this._pointToPercentPosition((0,n.ensureDefined)(t.screen),s))}}})),(0,Fe.startMovingLineTool)(a)}}Fe.isToolMovingNow.setValue(!0),a&&Fe.isStudyEditingNow.setValue(!0)}moveSources(e,t,i,s){if(this._sourcesBeingMoved.filter((e=>!e.isLocked||!e.isLocked())).forEach((o=>{const r=(0,C.isLineTool)(o)?o.linkKey().value():null;if(null!==r&&t.has(r)){const e=(0,n.ensureNotNull)(this.paneForSource(o)),a=(0,n.ensureDefined)(t.get(r)),l={screen:this._percentPositionToPoint(a,e)};o.move(l,this._activeItemBeingMoved,i,s)}else o.move(e,this._activeItemBeingMoved,i,s)})),this.lightUpdate(),!s&&e.logical){const t=this._sourcesBeingMoved.filter(C.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey().value())).map((e=>e.linkKey().value())),s=this.externalTimeStamp(e.logical.index),o={linkKeys:t,model:this,point:{price:e.logical.price,timeStamp:s},envState:i,pointPositionPercents:new Map};this._sourcesBeingMoved.filter(C.isLineTool).forEach((t=>{if(t.linkKey().value()&&t.isSynchronizable()&&t.isFixed()){const i=(0,n.ensureNotNull)(this.paneForSource(t));o.pointPositionPercents.set(t.linkKey().value(),this._pointToPercentPosition((0,n.ensureDefined)(e.screen),i))}})),(0,Fe.moveLineTool)(o)}}endMovingSources(e,t,i){const s=this._sourcesBeingMoved.map((s=>{const o=(0,n.ensureNotNull)(this.paneForSource(s)),r=s.endMoving(e,t,i),a=this._paneInvalidationMask(o,H.InvalidationLevel.Light)
;return a.invalidateAll(H.InvalidationLevel.Light),this.invalidate(a),r})),o=this._sourcesBeingMoved.filter(C.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey().value())).map((e=>e.linkKey().value())),r=this._sourcesBeingMoved.filter(C.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey)).map((e=>{const t={points:e.normalizedPoints(),interval:this.mainSeries().interval()};return e.isFixed()&&(t.pointPositionPercents=e.calcPositionPercents()),t}));o.length&&(0,Fe.finishMovingLineTool)({linkKeys:o,model:this,finalStates:r,changes:s}),this._sourcesBeingMoved=[],this._activeItemBeingMoved=null,Fe.isToolMovingNow.setValue(!1),Fe.isStudyEditingNow.setValue(!1)}sourcesBeingMoved(){return this._sourcesBeingMoved}setMovingCustomSource(e,t){this._customSourceBeingMoved=e,this._customSourceBeingMovedHitTestData=null!==t?{beingMoved:!1,cancelled:!1,...t}:null}processingCustomSourceMove(){null!==this._customSourceBeingMovedHitTestData&&(this._customSourceBeingMovedHitTestData.beingMoved=!0)}customSourceMovingHitTestData(){return this._customSourceBeingMovedHitTestData}customSourceBeingMoved(){return null!==this._customSourceBeingMovedHitTestData&&this._customSourceBeingMovedHitTestData.beingMoved?this._customSourceBeingMoved:null}lineToolsSynchronizer(){return this._lineToolsSynchronizer}setLineToolsSynchronizer(e){this._lineToolsSynchronizer=e}width(){return this._width}setWidth(e,t){(this._panes.reduce(((t,i)=>i.setWidth(e)||t),!1)||this._width!==e)&&(this._width=e,this._timeScale.setWidth(e,t),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction))}setPaneHeight(e,t){e.setHeight(t),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.lightUpdate()}resetScalesAvailable(){return this._resetScalesAvailable.readonly()}panes(){return this._panes}paneForId(e){return this._panes.find((t=>t.id()===e))||null}createPane(e,t,i){this._undoModel.hideMaximizedPaneIfRequired();const s=this._properties.childs().paneProperties;t&&s.merge(t);const o=new ut(this._timeScale,s,this,i);return void 0!==e?this._panes.splice(e,0,o):this._panes.push(o),o.onTagsChanged().subscribe(this,ro.prototype.onPaneTagsChanged),o.dataSourcesCollectionChanged().subscribe(this,(()=>this._dataSourceCollectionChanged.fire(o))),o.symbolSourceCollectionChanged().subscribe(this,(()=>this._onSymbolSourceCollectionChanged(o))),o.priceSourcesCollectionChanged().subscribe(this,(()=>this._onPriceSourcesCollectionChanged(o))),o.sourcePropertiesChanged().subscribe(this,(e=>this._sourceProperitesChanged.fire(o,e))),o.sourceZOrderChanged().subscribe(this,(e=>this._sourceZOrderChanged.fire(o,e))),o.symbolSourceResolved().subscribe(this,(e=>this._symbolSourceResolved.fire(o,e))),o.symbolSourceResolvingActive().subscribe(this._recalcSymbolResolvingActive),o.collapsed().subscribe(this._recalcPaneCollapsingAvailable),o.resetPriceScalesAvailable().subscribe(this._updateResetScalesAvailableValue,{callWithLast:!0}),this._recalcPaneCollapsingAvailable(),
this._panesCollectionChanged.fire(this._panes),this.invalidate(H.InvalidationMask.panesOrder()),o}removePane(e){this._undoModel.hideMaximizedPaneIfRequired();const t=e;t.destroy();const i=this._panes.indexOf(t);-1!==i&&(this._panes.splice(i,1),e.dataSourcesCollectionChanged().unsubscribeAll(this),e.symbolSourceCollectionChanged().unsubscribeAll(this),e.priceSourcesCollectionChanged().unsubscribeAll(this),e.sourcePropertiesChanged().unsubscribeAll(this),e.onTagsChanged().unsubscribeAll(this),e.symbolSourceResolved().unsubscribeAll(this),t.symbolSourceResolvingActive().unsubscribe(this._recalcSymbolResolvingActive),e.collapsed().unsubscribe(this._recalcPaneCollapsingAvailable),e.resetPriceScalesAvailable().unsubscribe(this._updateResetScalesAvailableValue),this._recalcPaneCollapsingAvailable(!0)),this._updateResetScalesAvailableValue();this.crossHairSource().pane===e&&this.clearCurrentPosition(),this._panesCollectionChanged.fire(this._panes),this.invalidate(H.InvalidationMask.panesOrder())}changePanesHeight(e,t){if(this._panes.length<2)return;(0,n.assert)(e>=0&&e<this._panes.length,"Invalid pane index");const i=this._panes[e],s=this._panes.reduce(((e,t)=>e+t.stretchFactor()),0),o=this._panes.reduce(((e,t)=>e+t.height()),0),r=o-30*(this._panes.length-1);t=Math.min(r,Math.max(30,t));const a=s/o,l=i.height();i.setStretchFactor(t*a);let c=t-l,d=this._panes.length-1;for(const e of this._panes)if(e!==i){const t=Math.min(r,Math.max(30,e.height()-c/d));c-=e.height()-t,d-=1;const i=t*a;e.setStretchFactor(i)}this.fullUpdate()}clearCurrentPosition(){const e=this.crossHairSource();e.clearPosition(),(0,n.ensureNotNull)(e.dataWindowView()).update(),eo(this._panes),this.invalidate(H.InvalidationMask.cursor()),this._undoModel.syncCrosshair(null),this._phantomSourceContainer.onCursorPositionUpdated()}setAndSaveCurrentPosition(e,t,i,s){this.crossHairSource().saveOriginCoords(e,t),this.setCurrentPosition(e,t,i,s)}setCurrentPosition(e,t,i,s){var o,r,a,l,c,d;let h=NaN;const u=this._timeScale.coordinateToVisibleIndex(e),p=null!==(a=null===(r=null!==(o=this._lineBeingEdited)&&void 0!==o?o:this.lineBeingCreated())||void 0===r?void 0:r.priceScale())&&void 0!==a?a:i.defaultPriceScale();let _=null;!p.isEmpty()&&Number.isFinite(t)&&(_=(0,n.ensureNotNull)(i.mainDataSource()).firstValue(),null!==_&&(h=p.coordinateToPrice(t,_)));const m=this._crossHairSelectPointMode.value()!==Fe.SelectPointMode.None,g=this.currentTool(),S=this.mainSeries(),v=this.crossHairSource(),f=v.index,b=v.price,y=m||Fe.isStudyEditingNow.value(),C=p===this.m_mainSeries.priceScale()&&!(0,Me.isLineDrawnWithPressedButton)(g)&&(this._lineBeingCreated||this._lineBeingEdited||(0,Me.isLineToolName)(g)||(0,Fe.toolIsMeasure)(g)||y);!this._isSettingsExternalPosition&&C?(h=this._magnet.align(h,u,i),null!==_&&this._setCorrectedPositionToCrosshair(u,h,i)):this._magnet.resetLastValue();let w=null;if(isNaN(h)||(w=i),this._isTimeScrolling){if(!this._isSettingsExternalPosition&&m){const e=S.bars().firstIndex(),t=S.bars().lastIndex();if(null!==e&&null!==t){const s=Math.min(Math.max(u,e),t)
;s!==u&&this._setCorrectedPositionToCrosshair(s,h,i)}}else v.setPosition(v.index,h,w);return}v.setOnHoveredChartWidget(!0),v.setPosition(u,h,w),(0,n.ensureNotNull)(v.dataWindowView()).update(),eo(this._panes);const T=S.syncModel();this.crossHairSource().startMeasurePoint()||this._lineBeingCreated?this.lightUpdate():this.invalidate(H.InvalidationMask.cursor());const P=this.lineBeingCreated();if(P){const e=P.linkKey().value();if(!this._isSettingsExternalPosition){const t=P.setLastPoint({index:u,price:h},s);if(P.updateAllViews((0,nt.sourceChangeEvent)(P.id())),t.price===h&&t.index===u||this._setCorrectedPositionToCrosshair(t.index,t.price,i),T&&e){const i=this._timeScale.points().roughTime(t.index,T.projectTime.bind(T));(0,Fe.setLineToolLastPoint)({model:this,linkKey:e,point:{timeStamp:(0,n.ensureNotNull)(i),price:t.price}})}}}if(!this._isSettingsExternalPosition&&null!==this._lineBeingEdited&&null!==this._linePointBeingEdited){const e={index:u,price:h};if(null===(l=this._linePointBeingChanged)||void 0===l?void 0:l.nonDiscreteIndex){const t=this.crossHairSource().originX();Number.isFinite(t)&&(e.index=this._timeScale.coordinateToFloatIndex(t))}this.changeLinePoint(e,s);const t=this._lineBeingEdited.alignCrossHairToAnchor(this._linePointBeingEdited)?this._lineBeingEdited.getPoint(this._linePointBeingEdited):e;null!==t&&this._setCorrectedPositionToCrosshair(t.index,t.price,i)}if(!this._isSettingsExternalPosition&&1===this._sourcesBeingMoved.length){const e=this._sourcesBeingMoved[0];if(null===(c=e.alignCrossHairToMovePoint)||void 0===c?void 0:c.call(e)){const t=null===(d=e.currentMovingPoint)||void 0===d?void 0:d.call(e);t&&t.logical&&this._setCorrectedPositionToCrosshair(t.logical.index,t.logical.price,i)}}if(!this._isSettingsExternalPosition&&y){const e=S.bars().firstIndex(),t=S.bars().lastIndex();if(null!==e&&null!==t){const s=Math.min(Math.max(u,e),t);s!==u&&this._setCorrectedPositionToCrosshair(s,h,i)}}(f!==u||b!==h)&&this._syncCrosshair(s)}setExternalPosition(e,t){let i;const s=this.crossHairSource();if(s.setOnHoveredChartWidget(!1),null!==e&&(0,ue.isNumber)(e.timeStamp)){const t=this.mainSeries().syncModel();if(t){const s=this.createSyncPoint(e.syncSourceTarget,t.syncSourceTarget()).sourceTimeToTargetTime(e.timeStamp);i=this._timeScale.points().roughIndex(s,t.distance.bind(t))}}if(null!==e&&null!=i&&Number.isFinite(i)){this._isSettingsExternalPosition=!0;const o=(0,n.ensureNotNull)(this.paneForSource(this.mainSeries())),r=this._timeScale.indexToCoordinate(i),a=(0,n.ensureNotNull)(o.mainDataSource()).firstValue();if(null!==a){let i=NaN;void 0!==e.price&&Number.isFinite(e.price)&&(i=this.mainSeries().priceScale().priceToCoordinate(e.price,a)),s.clearOriginCoords(),this.setCurrentPosition(r,i,o,t)}return s.setOnHoveredChartWidget(!1),void(this._isSettingsExternalPosition=!1)}s.clearPosition(),(0,n.ensureNotNull)(s.dataWindowView()).update(),eo(this._panes),this.invalidate(H.InvalidationMask.cursor())}startScaleTime(e){this._timeScale.startScale(e)}scaleTimeTo(e){this._timeScale.scaleTo(e),this.recalculateAllPanes((0,
nt.viewportChangeEvent)()),this.lightUpdate()}endScaleTime(){this._timeScale.endScale(),this.lightUpdate(),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction)}resetTimeScale(){this._timeScale.restoreDefault(),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction),this.lightUpdate(),this._resetScales.fire()}startScalePrice(e,t,i){e.startScalePrice(t,i)}scalePriceTo(e,t,i){e.scalePriceTo(t,i),this.mainSeries().priceScale().isLockScale()?this.lightUpdate():this.invalidate(this._paneInvalidationMask(e,H.InvalidationLevel.Light))}endScalePrice(e,t){e.endScalePrice(t),this.invalidate(this._paneInvalidationMask(e,H.InvalidationLevel.Light))}startTwoPointsScalePrice(e,t,i,s){t.startTwoPointsScale(i,s)}twoPointsScalePriceTo(e,t,i,s){t.twoPointsScale(i,s),this.invalidate(this._paneInvalidationMask(e))}endTwoPointsScalePrice(e,t){t.endTwoPointsScale(),this.invalidate(this._paneInvalidationMask(e))}resetPriceScale(e,t){e.resetPriceScale(t),this.invalidate(this._paneInvalidationMask(e,H.InvalidationLevel.Light))}restorePriceScaleState(e,t,i){e.restorePriceScaleState(t,i),this.invalidate(this._paneInvalidationMask(e,H.InvalidationLevel.Light))}currentTool(){return this._currentTool}setCurrentTool(e){this._currentTool!==e&&((0,Me.isLineToolName)(e)&&this.selectionMacro((e=>{e.clearSelection()})),this._currentTool=e,this._phantomSourceContainer.onToolChanged())}detachSource(e){const t=this.paneForSource(e);return!!t&&(t.removeDataSource(e),t.isEmpty()?(this._lineBeingCreated&&t===this._paneBeingCreatedLineOn&&this.cancelCreatingLine(),this.removePane(t),!0):(this.fullUpdate(),!1))}children(e,t){return this.dataSources().filter((i=>(0,O.isStudy)(i)&&!(0,ge.isLollipopDataSource)(i)?!t&&i.parentSources().includes(e):i.ownerSource()===e))}onRearrangePanes(){return this._onRearrangePanes}studyInserted(){return this._studyInserted}finishLineTool(e){const t=e.linkKey().value();(0,Fe.drawOnAllCharts)().value()&&null!==t&&e.isSynchronizable()&&(0,Fe.finishLineTool)({linkKey:t,model:this})}startChangingLinetool(e,t,i,s,o){this._lineBeingEdited=e,this._linePointBeingChanged=t||null,this._linePointBeingEdited=void 0===i?null:i,this._lineBeingEdited.startChanging(i,t,o),Fe.isToolEditingNow.setValue(!0);const r=(0,n.ensureNotNull)(this.paneForSource(e));this._lineBeingEdited.startDragPoint&&void 0!==i&&void 0!==t&&this._lineBeingEdited.startDragPoint(i,t),o||void 0===i||void 0===t||this._lineBeingEdited.setPoint(i,t,s,o),this._lineBeingEdited.updateAllViews((0,nt.sourceChangeEvent)(this._lineBeingEdited.id()));const a=this._paneInvalidationMask(r,H.InvalidationLevel.Light);this.invalidate(a);const l=e.linkKey().value();if(l&&e.isSynchronizable()&&void 0!==i&&void 0!==t){const e=(0,n.ensureNotNull)(this.externalTimeStamp(t.index));(0,Fe.startChangingLineTool)({linkKey:l,model:this,symbol:this.mainSeries().symbol(),point:{price:t.price,timeStamp:e},pointIndex:i,envState:s||null})}}createLineTool(e){
const{pane:t,point:i,linetool:s,linkKey:o=null,sharingMode:r=0,id:l,fromExternalModel:c}=e;let{properties:d,ownerSource:h}=e;if((0,n.assert)((0,Me.isLineToolName)(s),`Cannot create unknown line tool: ${s}`),d){const e={...zs.intervalsVisibilitiesDefaults},t=d.childs().intervalsVisibilities.state();(0,ue.merge)(e,null!=t?t:{});const i=d.state();i.intervalsVisibilities=e,d=(0,C.createLineToolProperties)(s,i,this)}const u=(0,C.createLineTool)(s,this,d,null,void 0,l);if("LineToolExecution"!==s){let e;switch(s){case"LineToolIcon":e=u.properties().childs().icon.value().toString(16).toUpperCase();break;case"LineToolEmoji":e=u.properties().childs().emoji.value();break;case"LineToolSticker":e=u.properties().childs().sticker.value()}(0,p.trackEvent)("drawings","Study_Drawing_"+s,e)}(0,C.isStudyLineTool)(u)&&(0,p.trackEvent)("studies",`Study_${u.metaInfo().id}`);const _=!u.linkKey().value()&&!o;h=(0,n.ensureDefined)(h||(0,n.ensureNotNull)(t.mainDataSource())),d||(0,C.prepareLineToolPropertiesByOwnerSource)(u.properties(),h),u.setOwnerSource(h);const m=h.priceScale();if(u.setPriceScale(m),h===this.mainSeries()&&u.share(r),t.addDataSource(u,m,!1),null!==u.preferredZOrder()&&t.insertAfter([u],this.mainSeries()),(0,Fe.drawOnAllCharts)().value()){const e=u.isSynchronizable()?o||(0,le.randomHash)():null;u.linkKey().setValue(e)}else u.linkKey().setValue(o);let g;if(_&&u.enableCurrentIntervalVisibility(),u.isFixed()){const e=(0,n.ensureNotNull)((0,n.ensureNotNull)(t.mainDataSource()).firstValue()),s=this._timeScale.indexToCoordinate(i.index),o=(0,n.ensureNotNull)(m).priceToCoordinate(i.price,e);g=u.addFixedPoint(new a.Point(s,o))}else g=u.addPoint(i);return g||(this._lineBeingCreated={lineDataSource:u,fromExternal:!!c},this._paneBeingCreatedLineOn=t,Fe.isToolCreatingNow.setValue(!0)),this.fullUpdate(),u}endChangingLinetool(e,t){const i=(0,n.ensureNotNull)(this._lineBeingEdited),s=i.endChanging(!1,e,t);this._lineBeingEdited=null,Fe.isToolEditingNow.setValue(!1),this._linePointBeingEdited=null,this._linePointBeingChanged=null,this.lightUpdate();const o={points:i.normalizedPoints(),interval:this.mainSeries().interval()},r=i.linkKey().value();null!==r&&i.isSynchronizable()&&!t&&(0,Fe.finishChangingLineTool)({model:this,linkKey:r,symbol:this.mainSeries().symbol(),finalState:o,changes:s})}continueCreatingLine(e,t,i,s,o){const r=(0,n.ensureNotNull)(this.lineBeingCreated()),a=r.addPoint(e,t,i,o);r.updateAllViews((0,nt.sourceChangeEvent)(r.id()));const l=new H.InvalidationMask(H.InvalidationLevel.Light);return a&&(this._paneBeingCreatedLineOn=null,this._lineBeingCreated=null,Fe.isToolCreatingNow.setValue(!1)),this.invalidate(l),a}cancelCreatingLine(){const e=this.lineBeingCreated();e&&(this.removeSource(e),this._lineBeingCreated=null,this._lineCancelled.fire(),Fe.isToolCreatingNow.setValue(!1),(0,Fe.drawOnAllCharts)().value()&&e.isSynchronizable()&&(0,Fe.cancelLineTool)({model:this}))}lineBeingCreated(){var e;return(null===(e=this._lineBeingCreated)||void 0===e?void 0:e.lineDataSource)||null}lineBeingCreateFromExternal(){var e
;return(null===(e=this._lineBeingCreated)||void 0===e?void 0:e.fromExternal)||!1}paneBeingCreatedLineOn(){return this._paneBeingCreatedLineOn}lineCancelled(){return this._lineCancelled}isPhantomLine(e){return this._phantomSourceContainer.source()===e}alignTo45Degrees(e,t){const[i,s]=t,o={...s};e.snapPoint45Degree(i,o),this.startChangingLinetool(e,s,s.pointIndex),this.changeLinePoint(o,k.EnvironmentState.create(!0)),this.endChangingLinetool(!1)}changeLinePoint(e,t,i){const s=(0,n.ensureNotNull)(this._lineBeingEdited),o=(0,n.ensureNotNull)(this._linePointBeingEdited);let r=e.price,a=e.index;if(s.setPoint(o,e,t,i),!i){const t=s.alignCrossHairToAnchor(o)?s.getPoint(o):e;null!==t&&(a=t.index,r=t.price)}s.updateAllViews((0,nt.sourceChangeEvent)(s.id())),this.lightUpdate();const l=s.linkKey().value();if(!i&&null!==l&&s.isSynchronizable()){const e=(0,n.ensureNotNull)(this._linePointBeingChanged),i={indexesChanged:a!==e.index,pricesChanged:r!==e.price},c=s.getChangePointForSync(o);if(null!==c){const e=this.externalTimeStamp(a);null!==e&&(r=c.price,(0,Fe.changeLineTool)({linkKey:l,model:this,symbol:this.mainSeries().symbol(),point:{price:r,timeStamp:e},envState:t,changes:i}))}}}changeLinePoints(e,t,i){const s=e.points(),o=e.linkKey().value();!i&&o&&e.isSynchronizable()&&t.forEach(((t,i)=>{const r=s[i],a=r.price!==t.price,l=r.index!==t.index;if(e.getChangePointForSync(i)){const e=(0,n.ensureNotNull)(this.externalTimeStamp(t.index));(0,Fe.changeLineTool)({linkKey:o,model:this,symbol:this.mainSeries().symbol(),point:{price:t.price,timeStamp:e},changes:{pricesChanged:a,indexesChanged:l}})}})),e.setPoints(t),e.updateAllViews((0,nt.sourceChangeEvent)(e.id())),this.lightUpdate()}startScrollTime(e){this._timeScale.startScroll(e),this._isTimeScrolling=!0,this.mainSeries().clearGotoDateResult()}scrollTimeTo(e){this._timeScale.scrollTo(e),this.recalculateAllPanes((0,nt.viewportChangeEvent)()),this.lightUpdate()}endScrollTime(){this._timeScale.endScroll(),this.lightUpdate(),this.recalcVisibleRangeStudies(v.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction),this._isTimeScrolling=!1}startScrollPrice(e,t,i){e.startScrollPrice(t,i)}scrollPriceTo(e,t,i){e.scrollPriceTo(t,i),this.invalidate(this._paneInvalidationMask(e,H.InvalidationLevel.Light))}endScrollPrice(e,t){e.endScrollPrice(t),this.invalidate(this._paneInvalidationMask(e,H.InvalidationLevel.Light))}addCustomSource(e,t,i=v.CustomSourceLayer.Foreground){this._customSourcesMap.has(e)&&Js.logWarn(`Attempt to add the same custom source multiple time "${e}"`),Js.logNormal(`Adding custom source "${e}"`);const s=t(e,this);switch(i){case v.CustomSourceLayer.Background:this._bgCustomSources.push(s);break;case v.CustomSourceLayer.Foreground:this._fgCustomSources.push(s);break;case v.CustomSourceLayer.Topmost:this._topmostCustomSources.push(s);break;default:throw new Error(`Unknown custom sources layer ${i}`)}this._allCustomSources.push(s),this._customSourcesMap.set(e,s),this.lightUpdate()}removeCustomSource(e){this._removeCustomSource(e),this.lightUpdate()}hasCustomSource(e){
return this._customSourcesMap.has(e)}customSourceForName(e){return this._customSourcesMap.get(e)||null}customSourceName(e){let t=null;return this._customSourcesMap.forEach(((i,s)=>{i===e&&(t=s)})),t}customSources(e){switch(e){case v.CustomSourceLayer.Background:return this._bgCustomSources;case v.CustomSourceLayer.Foreground:return this._fgCustomSources;case v.CustomSourceLayer.Topmost:return this._topmostCustomSources;default:return this._allCustomSources}}addMultiPaneSource(e){this._multiPaneSources.push(e),this._onMultipaneSourcesCollectionChanged.fire(),this.lightUpdate()}removeMultiPaneSource(e){const t=this._multiPaneSources.indexOf(e);-1===t?Js.logWarn("Attempt to remove multi-pane source which does not exist in the model"):(this._onMultipaneSourcesCollectionChanged.fire(),this._multiPaneSources.splice(t,1)),this.lightUpdate()}multiPaneSources(e){return this._multiPaneSources.filter((t=>!e.hasDataSource(t)))}onMultipaneSourcesCollectionChanged(){return this._onMultipaneSourcesCollectionChanged}rendererOptionsProvider(){return this._rendererOptionsProvider}magnet(){return this._magnet}priceAxisRendererOptions(){return this._rendererOptionsProvider.options()}dateTimeFormatter(){return this._dateTimeFormatter}dateFormatter(){return this._dateFormatter}timeFormatter(){return this._timeFormatter}isUnmergeAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;return(0,n.ensureNotNull)(this.paneForSource(e)).dataSources().filter(this._unmergeAvailable,this).length>1}isMergeDownAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;const t=this.paneForSource(e),i=this.panes();return t!==i[i.length-1]}isMergeUpAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;return this.paneForSource(e)!==this.panes()[0]}sessions(){return(0,n.ensureNotNull)(this._sessions)}createSessions(e){null===this._sessions&&(this._sessions=new R((async()=>{const t=await Promise.all([i.e(32856),i.e(85785),i.e(32887),i.e(24951),i.e(49645),i.e(92013),i.e(88509),i.e(77916),i.e(89052),i.e(10640),i.e(87),i.e(87465),i.e(6927),i.e(21852),i.e(46896),i.e(57539)]).then(i.bind(i,885953));return this.addCustomSource("sessions",((i,s)=>{const o=new t.Sessions(i,s,e);return o.start(),o}),v.CustomSourceLayer.Background),this.customSourceForName("sessions")})()))}createPrePostMarket(e){this.addCustomSource("prePostMarket",((t,i)=>new oi.PrePostMarket(t,i,e)))}watermarkSource(){return this._watermarkSource}watermarkContentProvider(){return null}replayStatus(){return this._replayStatus}setReplayStatus(e){this._replayStatus.setValue(e)}isInReplay(){return this.m_mainSeries.isInReplay()}getSymbolString(){return this.m_mainSeries.getSymbolString()}interval(){return this.m_mainSeries.interval()}switchToReplay(e,t){this.m_mainSeries.switchToReplay(e,t)}switchToRealtime(){this.m_mainSeries.switchToRealtime(),this._timeScale.resetRightOffset(),this.setReplayStatus(0),this._scrollingState&&(this._scrollingState.deferred.reject(),this._scrollingState=null)}canChangeResolution(e){return this.m_mainSeries.canChangeResolution(e)}canChangeSymbol(e){
return this.m_mainSeries.canChangeSymbol(e)}theme(){var e;const t=this.properties().childs().paneProperties.state(["horzGridProperties.style","vertGridProperties.style"]);delete t.topMargin,delete t.bottomMargin;const i=(0,n.ensureDefined)(this.mainSeries().state().state);delete i.symbol,delete i.interval,delete i.currencyId,delete i.unitId;const s={mainSourceProperties:i,sessions:null===(e=this.sessions().get())||void 0===e?void 0:e.properties().state(),chartProperties:{paneProperties:t,scalesProperties:this.properties().childs().scalesProperties.state()},version:this.version()};return s.version=this.version(),s}onChartThemeLoaded(){return this._chartThemeLoaded}chartThemeLoaded(){this._chartThemeLoaded.fire()}async colorStudiesPropertiesReady(){this._recalcColorStudiesImpl(this._recalcVRStudiesParams);const e=this.allStudies(!0).filter((e=>e.metaInfo().inputs.filter(P.isStudyInputDependsOnChartColors).length>0));await Promise.all(e.map((e=>e.propertiesPatched())))}state(e,t,i,s){var o,r;const n=this.publishedChartsTimelineSource(),a=this.properties().childs(),l=a.tradingProperties.state(),c={panes:this._panes.map((o=>o.state(!0,e,!1,t,i,s))),timeScale:this._timeScale.state(e),chartProperties:{paneProperties:a.paneProperties.state(["horzGridProperties.style","vertGridProperties.style"]),scalesProperties:a.scalesProperties.state(),publishedChartsTimelineProperties:n?n.state(e):void 0,chartEventsSourceProperties:null===(o=a.chartEventsSourceProperties)||void 0===o?void 0:o.state(),tradingProperties:l,priceScaleSelectionStrategyName:a.priceScaleSelectionStrategyName.value()},sessions:null!==(r=this.sessions().state(e))&&void 0!==r?r:void 0,version:this.version(),timezone:this.timezone(),shouldBeSavedEvenIfHidden:this._shouldBeSavedEvenIfHidden,linkingGroup:this._linkingGroupIndex.value()};return s||(c.lineToolsGroups=this.lineToolsGroupModel().state(t)),c}restoreState(e,t,s){var o;Je.DeferredStudies.instance(this).reset();const r={};if(!e.panes)return void Js.logDebug("ChartModel.restoreState: invalid state");if(!Array.isArray(e.panes))return void Js.logDebug("ChartModel.restoreState: invalid state");if(e.panes.length<1)return void Js.logDebug("ChartModel.restoreState: invalid state");for(const e of this._barsMarksSources)this.detachSource(e);if(this._shouldBeSavedEvenIfHidden=void 0===e.shouldBeSavedEvenIfHidden||e.shouldBeSavedEvenIfHidden,e.chartProperties&&!e.chartProperties.timezone&&(e.chartProperties.timezone=e.timezone),e.chartProperties){const i=(0,$.factoryDefaults)("chartproperties").scalesProperties;(0,ue.merge)(i,e.chartProperties.scalesProperties),!("showLastValue"in i)||"showSeriesLastValue"in i||"showStudyLastValue"in i||(i.showSeriesLastValueProperty=i.showLastValue,i.showStudyLastValueProperty=i.showLastValue),"showSeriesLastValue"in i&&(r.showSeriesLastValueProperty=!0),"showStudyLastValue"in i&&(r.showStudyLastValueProperty=!0),(!this.isSnapshot()&&!this.readOnly()&&"showCurrency"in i||"showUnit"in i)&&((0,z.migrateShowCurrencyAndShowUnitProperties)(i.showCurrency,i.showUnit),delete i.showCurrency,
delete i.showUnit);{const{paneProperties:t}=e.chartProperties;t.vertGridProperties=t.vertGridProperties||(0,ue.clone)(t.gridProperties),t.horzGridProperties=t.horzGridProperties||(0,ue.clone)(t.gridProperties),t.horzGridProperties.style=t.vertGridProperties.style=ui.LINESTYLE_SOLID,"backgroundType"in t||(t.backgroundType=mi.ColorType.Solid),"separatorColor"in t||(t.separatorColor=(0,u.getThemedColor)("color-chart-page-bg")),this._properties.childs().paneProperties.mergeAndFire(t)}this._properties.childs().scalesProperties.mergeAndFire(i),e.chartProperties.timezone&&this._properties.childs().timezone.setValue(e.chartProperties.timezone),e.chartProperties.chartEventsSourceProperties&&this._properties.hasChild("chartEventsSourceProperties")&&this._properties.childs().chartEventsSourceProperties.mergeAndFire(e.chartProperties.chartEventsSourceProperties),e.chartProperties.tradingProperties&&this._properties.hasChild("tradingProperties")&&(void 0===e.chartProperties.tradingProperties.horizontalAlignment&&(e.chartProperties.tradingProperties.horizontalAlignment=(a=e.chartProperties.tradingProperties.lineLength)<=40?v.TradedGroupHorizontalAlignment.Right:a>=60?v.TradedGroupHorizontalAlignment.Left:v.TradedGroupHorizontalAlignment.Center),this._properties.childs().tradingProperties.mergeAndFire(e.chartProperties.tradingProperties)),this._timeScale.restoreState(e.timeScale,t),this._updateDateTimeFormatter()}var a;if(e.timeScale&&this._timeScale.restoreState(e.timeScale,t),!this.readOnly()){const t=this._getExceedingChildStudies(e.panes);if(t.length){for(let i=e.panes.length-1;i>=0;--i){const s=e.panes[i];for(let e=s.sources.length-1;e>=0;--e){const i=s.sources[e];~t.indexOf(i)&&s.sources.splice(e,1)}s.sources.length||e.panes.splice(i,1)}{const e=window.user.pro_plan;setTimeout((()=>(0,ri.createGoProDialog)({feature:"studyOnStudy",actions:e&&"pro_premium_expert"===e?[{text:d.t(null,void 0,i(515462)),action:ci.PredefinedAction.Close}]:void 0})),500)}}}const l=e.version||0,c=e.panes;let h="_seriesId";for(const e of c){const t=e.sources.find((e=>"MainSeries"===e.type));if(t){h=t.id;break}}this.panes()[0].restoreState({state:c[0],withData:t,version:l,seriesId:h,settingsMigration:r,contentOverrides:s,restoreSilently:true,reason:2});let p=1;for(let i=1;i<e.panes.length;i++){const o=e.panes[i];if(0===o.sources.length){Js.logWarn("Empty pane detected - restoring is skipped. idx="+i+", state="+JSON.stringify(o));continue}const n=this.panes()[p]||this.createPane();n.restoreState({state:o,withData:t,version:l,seriesId:h,settingsMigration:r,contentOverrides:s,restoreSilently:true,reason:2}),n.mainDataSource()?p+=1:this.removePane(n)}if(this.panes().forEach(((e,t)=>{e.collapsed().value()!==c[t].isCollapsed&&(e.collapsed().setValue(c[t].isCollapsed),this.fullUpdate())})),e.chartProperties&&e.chartProperties.publishedChartsTimelineProperties){const i=this.publishedChartsTimelineSource();i&&i.restoreData(e.chartProperties.publishedChartsTimelineProperties,t)}this._invalidateBarColorerCaches();const _=this.dataSources();let m=0
;for(let e=0;e<_.length;e++){const t=_[e];(0,C.isLineTool)(t)&&(m++,t.calcIsActualSymbol())}this.updateTimeScaleBaseIndex(),this.recalculateAllPanes((0,nt.globalChangeEvent)()),this.fullUpdate(),this.syncLollipopSources();const S=(0,n.ensureNotNull)(this.mainPane());for(const e of this._barsMarksSources)this.detachSource(e),S.addDataSource(e,this.m_mainSeries.priceScale(),!0);let f=g.TVLocalStorage.getItem("linetools_limit")||1e3;return window.is_authenticated&&window.user&&window.user.settings&&(f=window.user.settings.linetools_limit||f),this.sessions().restoreState(e.sessions,t),e.lineToolsGroups&&(this._lineToolsGroupModel=Gt.fromState(this,e.lineToolsGroups)),m>f&&m%100==0?{lines_limit_exceeded:!0,line_tools_count:m}:(this.panes().forEach((e=>this._dataSourceCollectionChanged.fire(e))),this._lineToolsGroupModel.fireChangedAll(),this._linkingGroupIndex.setValue(null!==(o=e.linkingGroup)&&void 0!==o?o:null),{})}shouldBeSavedEvenIfHidden(){return this._shouldBeSavedEvenIfHidden}setShouldBeSavedEvenIfHidden(e){this._shouldBeSavedEvenIfHidden=e}externalTimeStamp(e){const t=this.mainSeries().syncModel();return this.timeScale().points().roughTime(e,t&&t.projectTime.bind(t))}syncLollipopSources(){var e;null===(e=this._lollipopSourcesWatcherLoader)||void 0===e||e.callFunction((()=>{null!==this._lollipopSourcesWatcher&&this._lollipopSourcesWatcher.syncSources()}))}restoreChartEvents(e){var t;null===(t=this._lollipopSourcesWatcherLoader)||void 0===t||t.callFunction((()=>{null!==this._lollipopSourcesWatcher&&this._options.chartEventsEnabled&&this._lollipopSourcesWatcher.restoreChartEvents(e)}))}recalcVisibleRangeStudies(e){var t;if(this._recalcVRStudiesParams.reasons.add(e),this.m_mainSeries.isStarted()&&this.m_mainSeries.isCompleted()){const i=(0,n.ensureDefined)(so.get(e)).adapter,s=Math.min(...Array.from(this._recalcVRStudiesParams.reasons).map((e=>(0,n.ensureDefined)(so.get(e)))).filter((e=>e.adapter===i)).map((e=>e.timeout)));(0,n.ensureDefined)(null===(t=this._recalcVisibleRangeStudiesImplDebouncedByAdapter.get(i))||void 0===t?void 0:t.get(s))()}else this._recalcVisibleRangeStudiesImpl(this._recalcVRStudiesParams)}recalcColorStudies(e){this._recalcColorStudiesParams.force=this._recalcColorStudiesParams.force||Boolean(e),this._recalcColorStudiesImplDebounced()}recalcStudyBasedLineTools(){this.dataSources().forEach((e=>{(0,C.isStudyLineTool)(e)&&e.recalcStudyIfNeeded()}))}alertsWatcher(){return this._alertsWatcher}showLegend(){return this._showLegendProperty}id(){return this._id}selectPointMode(){return this._crossHairSelectPointMode}cancelRequestSelectPoint(){this.m_crossHairSource.cancelRequestSelectPoint()}requestSelectPoint(e){return this.m_crossHairSource.requestSelectPoint(e)}onPointSelected(){return this.m_crossHairSource.onPointSelected()}recalculatePriceRangeOnce(){const e=this.mainSeries();for(const t of this._panes)for(const i of t.priceDataSources())i.symbolSource()===e&&i.disablePriceRangeReady()}invalidate(e){var t;null===(t=this._invalidateHandler)||void 0===t||t.call(this,e)}appliedTimeFrame(){
return this._appliedTimeFrame.appliedTimeFrame()}barsMarksSources(){return this._barsMarksSources}createSyncPoint(e,t){return(0,Fs.getDefault2Lazy)(this._syncPointCache,e.uniqueId,t.uniqueId,(()=>new $t(e,t)))}isAutoSaveEnabled(){return this._isAutoSaveEnabled}linkingGroupIndex(){return this._linkingGroupIndex}studyAwareDefaultRightOffset(){return this._timeScale.usePercentageRightOffset().value()?this._timeScale.percentsToBarIndexLength(this.studyAwareDefaultRightOffsetPercentage()):Math.max(this._timeScale.defaultRightOffset().value(),this._cachedStudiesMaxOffset)}studyAwareDefaultRightOffsetPercentage(){return this._timeScale.usePercentageRightOffset().value()?Math.max(this._timeScale.defaultRightOffsetPercentage().value(),this._timeScale.barIndexLengthToPercents(this._cachedStudiesMaxOffset)):this._timeScale.barIndexLengthToPercents(this.studyAwareDefaultRightOffset())}clearAllStudies(){this.dataSources().forEach((e=>{var t;return null===(t=e.clearData)||void 0===t?void 0:t.call(e)}))}setTimeScaleAnimation(e,t){const i=H.InvalidationMask.light(),s=this._timeScale;i.setTimeScaleAnimation(e,null!=t?t:s.width()-s.indexToCoordinate(s.baseIndex())),this.invalidate(i)}stopTimeScaleAnimation(){this._timeScale.endScroll();const e=H.InvalidationMask.light();e.stopTimeScaleAnimation(),this.invalidate(e)}lollipopSourcesOptions(){const e=this._options;return{chartEventsEnabled:!this._options.isSnapshot&&this._options.chartEventsEnabled,esdEnabled:e.esdEnabled,newsNotificationsEnabled:e.newsNotificationsEnabled,continuousContractSwitchesEnabled:e.continuousContractSwitchesEnabled,futuresContractExpirationEnabled:e.futuresContractExpirationEnabled,latestUpdatesEnabled:e.latestUpdatesEnabled}}onSymbolIntervalChanged(){return this._symbolIntervalChanged}_initAlertsList(){return this._alertsListPromise||(this._alertsListPromise=(0,ti.getChartAlertsFacade)().then((e=>{this._alertsList=e.createCollection((()=>this.mainSeries().interval()),(()=>this.mainSeries().actualSymbol())),this._alertsList.alertAdded().subscribe(this,this._addAlertLabelToChart.bind(this)),this._alertsList.alertRemoved().subscribe(this,this._removeAlertLabelFromChart.bind(this)),this._alertsList.alertChanged().subscribe(this,(e=>{this._removeAlertLabelFromChart(e),this._addAlertLabelToChart(e)})),this._alertsList.sync();const t=e=>{this.mainSeries().dataEvents().symbolResolved()[e](this,i),this.mainSeries().dataEvents().symbolError()[e](this,this._removeAllAlertLabelsFromChart),this.mainSeries().properties().childs().interval[e](this,i)},i=()=>{var e;null===(e=this._alertsList)||void 0===e||e.sync()};return window.loginStateChange.subscribe(this,(()=>{var e;null===(e=this._alertsList)||void 0===e||e.reset(),t(window.is_authenticated?"subscribe":"unsubscribe")})),window.is_authenticated&&t("subscribe"),this._alertsList}))),this._alertsListPromise}_updateStudiesMaxOffset(){const e=Math.max(...this.allStudies().map((e=>e.maxOffset().value())));this._cachedStudiesMaxOffset=e;const t=this._timeScale.rightOffset();if(t<0)return;if(e<=t)return
;const i=this._timeScale.logicalRange();i?this._timeScale.zoomToBarsRange(i.left(),this._timeScale.baseIndex()+Math.max(this._timeScale.rightOffset(),e)):this._timeScale.setRightOffset(Math.max(t,e))}_updateBaseIndex(e,t){const i=this._timeScale,s=i.baseIndex(),o=i.logicalRange();if(null!==o&&t){const t=o.contains(s),r=e-s,n=t?null:i.rightOffset()-r;if(!this._options.shiftVisibleRangeOnNewBar&&t){const e=i.width()/i.barSpacing(),t=e/(e+r),s=Math.max(i.minBarSpacing(),i.barSpacing()*t);i.setBarSpacing(s)}null!==n&&i.setRightOffset(n)}i.setBaseIndex(e)}async _createLollipopSourcesWatcher(){{const e=this.lollipopSourcesOptions(),t=[e.esdEnabled,e.continuousContractSwitchesEnabled,e.futuresContractExpirationEnabled,e.latestUpdatesEnabled.minds,e.latestUpdatesEnabled.news,e.chartEventsEnabled],s=(0,Xt.onWidget)(),o=this.isSnapshot();(t.some(Boolean)||!s||o)&&(await(0,N.studyMetaInfoRepository)().requestMetaInfo(),this._lollipopSourcesWatcherLoader=new S.AsyncResourceWrapper(Promise.all([i.e(86083),i.e(71745)]).then(i.bind(i,247815))),this._lollipopSourcesWatcherLoader.callFunction((e=>{this._lollipopSourcesWatcher=new e.LollipopSourcesWatcher(this)})))}}_updateDateTimeFormatter(){const e=zt.dateFormatProperty.value(),t=this.onWidget()?void 0:ai.withWeekdayProperty.value();if(this._dateFormatter=new Ht.DateFormatter(e,t),this.mainSeries().isDWM())this._dateTimeFormatter=new Ht.DateFormatter(e,t),this._timeFormatter=new Lt.TimeFormatter((0,At.getHourMinuteFormat)(It.timeHoursFormatProperty.value()));else{const i=I.Interval.parse(this.mainSeries().interval()),s=(0,At.getTimeFormatForInterval)(i,It.timeHoursFormatProperty.value());this._dateTimeFormatter=new Ft.DateTimeFormatter({dateFormat:e,withWeekday:t,timeFormat:s,dateTimeSeparator:"   "}),this._timeFormatter=new Lt.TimeFormatter(s)}}_invalidationMaskForSource(e,t=H.InvalidationLevel.Light){if(e===this.crossHairSource())return H.InvalidationMask.cursor();if(this._watermarkSource===e)return this._paneInvalidationMask((0,n.ensureNotNull)(this.paneForSource(this.mainSeries())),t);if(-1!==this._allCustomSources.indexOf(e)){const e=new H.InvalidationMask;return e.invalidateAll(t),e}if(!(0,f.isDataSource)(e))return null;if(e.isMultiPaneEnabled())return new H.InvalidationMask(t);const i=this.paneForSource(e);return null!==i?this._paneInvalidationMask(i,t):null}_paneInvalidationMask(e,t=H.InvalidationLevel.Light){const i=new H.InvalidationMask,s=this._panes.indexOf(e);return i.invalidateAllPane(s,t),i}_invalidationMaskForSourcePriceScale(e,t=H.InvalidationLevel.Light){if(!(0,f.isDataSource)(e))return new H.InvalidationMask(t);const i=this.paneForSource(e);if(null===i)return null;let s=e.priceScale();if(null===s)return null;const o=this._panes.indexOf(i);let r=i.priceScalePosition(s);if("overlay"===r){const e=this._panes[o].defaultPriceScale();s=e,r=i.priceScalePosition(e)}const n=i.priceScaleIndex(s,r);if(void 0===n)return null;const a=new H.InvalidationMask;return a.invalidatePriceScale(o,r,n,t),a}_removeCustomSource(e){const t=this._customSourcesMap.get(e)
;if(void 0===t)return void Js.logWarn(`Attempt to remove custom source which does not exist in the model - "${e}"`);Js.logNormal(`Removing custom source "${e}"`),this.selectionMacro((e=>{e.removeSourceFromSelection(t)})),this._hoveredSource===t&&this.setHoveredSource(null),this._customSourceBeingMoved===t&&this.setMovingCustomSource(null,null);const i=Qs(this._bgCustomSources,t),s=Qs(this._fgCustomSources,t),o=Qs(this._topmostCustomSources,t),r=Qs(this._allCustomSources,t);(0,n.assert)(i||s||o,"Source should be presented in one of the layers"),(0,n.assert)(r,"Source should be presented in the array"),this._customSourcesMap.delete(e),t.destroy()}_updateShowLegendProperty(){const e=this._properties.childs().paneProperties.childs().legendProperties.childs().showLegend,t=this._showLegendProperty;if(e.value())t.setValue(!0);else{for(const e of this._panes){let i=0;for(const s of e.priceDataSources())if(null!==s.statusView()&&(i++,i>=2))return void t.setValue(!1)}t.setValue(!0)}}_pointToPercentPosition(e,t){return{x:e.x/this._timeScale.width(),y:e.y/(0,n.ensureNotNull)((0,n.ensureNotNull)(t.mainDataSource()).priceScale()).height()}}_percentPositionToPoint(e,t){const i=e.x*this._timeScale.width(),s=e.y*(0,n.ensureNotNull)((0,n.ensureNotNull)(t.mainDataSource()).priceScale()).height();return new a.Point(i,s)}_recalcVisibleRangeStudiesImpl(e){var t,i;if(!this.m_mainSeries.isStarted()||!this.m_mainSeries.isCompleted())return void this._visibleRangeStudiesInputs.setValue(null);if(this.timeScale().isEmpty())return;const s=this.timeScale().visibleBarsStrictRange();if(null===s)return;const o=this.m_mainSeries.bars(),r=o.search(s.firstBar(),kt.PlotRowSearchMode.NearestRight),n=o.search(s.lastBar(),kt.PlotRowSearchMode.NearestLeft),a=o.lastIndex(),l=r?r.index:void 0,c=n?n.index:void 0,d=l===e.oldStartVisibleIndex,h=c===e.oldEndVisibleIndex,u=[v.RecalcVisibleRangeStudiesReason.SeriesRestart,v.RecalcVisibleRangeStudiesReason.SeriesCompleted,v.RecalcVisibleRangeStudiesReason.StudyCreation].some((t=>e.reasons.has(t)));d&&h&&!u||(e.reasons.clear(),e.oldStartVisibleIndex=void 0!==l?l:NaN,e.oldEndVisibleIndex=void 0!==c?c:NaN,this._visibleRangeStudiesInputs.setValue({firstVisibleBarTime:1e3*(null!==(t=null==r?void 0:r.value[0])&&void 0!==t?t:0),lastVisibleBarTime:1e3*(null!==(i=null==n?void 0:n.value[0])&&void 0!==i?i:0),subscribeRealtime:(null==n?void 0:n.index)===a}))}_recalcColorStudiesImpl(e){var t;const i=this.backgroundColorAtYPercentFromTop(.5),s=this.dark().value()?c.colorsPalette["color-cold-gray-200"]:c.colorsPalette["color-cold-gray-900"],o=i===e.oldBgColor,r=s===e.oldFgColor;if(o&&r&&!e.force)return;e.force=!1,e.oldBgColor=i,e.oldFgColor=s;const n=null!==(t=e.studies)&&void 0!==t?t:this.priceDataSources();e.studies=void 0;for(const e of n)if((0,O.isStudy)(e)){const t=e.metaInfo().inputs.filter(P.isStudyInputDependsOnChartColors),o=e.properties().childs().inputs;t.forEach((e=>{const t=e.id===P.ChartColorDependentStudyInputNames.FgColor?s:i;o.childs()[e.id].setValueSilently(t)})),t.length>0&&o.listeners().fire(o,"")}}
_getAllSources(e){const t=[];for(const i of this._panes){const s=i.sourcesByGroup().allWithoutMultipane();for(const i of s)e(i)&&t.push(i)}return t}_invalidateBarColorerCaches(){this.mainSeries().invalidateBarColorerCache()}_addAlertLabelToChart(e){{const t=e.seriesId();if(null===t)return;(0,n.ensureNotNull)(this.alertsWatcher()).addAlert(e,t)}}_removeAlertLabelFromChart(e){(0,n.ensureNotNull)(this.alertsWatcher()).removeAlert(e)}_removeAllAlertLabelsFromChart(){(0,n.ensureNotNull)(this.alertsWatcher()).removeAllAlertLabels()}_updateTimeScale(e){var t,i,s,o;const{index:r,zoffset:n,values:a,indexDiffs:l,baseIndex:c,marks:d,clearFlag:h}=e;if(h){this._timeScale.reset();for(const e of this.dataSources())null===(t=e.clearData)||void 0===t||t.call(e)}if(l.length>0)for(const e of this.dataSources())null===(i=e.moveData)||void 0===i||i.call(e,l);const u=this._timeScale.indexToTimePoint(this._timeScale.baseIndex()),p=this._timeScale.canNormalize();this._timeScale.update(r,n,a,d);const _=this._timeScale.points().range().value();let m="ChartModel.prototype._updateTimeScale("+r+","+n+","+a.length+","+l.length+","+d.length+","+h+")";if(m+="TimeScale: {first:"+(null!==(s=null==_?void 0:_.firstIndex)&&void 0!==s?s:null)+",last:"+(null!==(o=null==_?void 0:_.lastIndex)&&void 0!==o?o:null)+"}",null===c){this._timeScale.resetBaseIndex();const e=this._timeScale.rightOffset();this._timeScale.setRightOffset(Math.max(e,this._cachedStudiesMaxOffset))}else if(void 0!==c){const e=this._timeScale.indexToTimePoint(c),t=null!==u&&null!==e&&e>u;this._updateBaseIndex(c,t)}if(Js.logDebug(m),!p&&p!==this._timeScale.canNormalize())for(const e of this.dataSources())!(0,C.isLineTool)(e)||e.isFixed()||e.isSourceHidden()||e.processHibernate();for(const e of this.dataSources())e.updateAllViews({type:"data-source-change",sourceId:e.id(),clearData:!0});this.recalculateAllPanes((0,nt.globalChangeEvent)()),this.lightUpdate()}_getAvailableCurrencies(){return!this.currencyConversionEnabled()||this.isSnapshot()?[]:(0,ue.isArray)(this._availableCurrenciesList)?this._availableCurrenciesList:(null!==this._availableCurrenciesList||(this._availableCurrenciesList=this.chartApi().availableCurrencies(),this._availableCurrenciesList.then((e=>{this._destroyed||(this._availableCurrenciesList=e,this.fullUpdate())})).catch((e=>{Js.logWarn(`An error occurred while getting currencies config: ${e}`)}))),[])}_getAvailableUnits(){return!this.unitConversionEnabled()||this.isSnapshot()?{}:this._availableUnitsObject instanceof Promise||null===this._availableUnitsObject?(null!==this._availableUnitsObject||(this._availableUnitsObject=this.chartApi().availableUnits(),this._availableUnitsObject.then((e=>{this._destroyed||(this._availableUnitsObject=e,this.fullUpdate())})).catch((e=>{Js.logWarn(`An error occurred while getting units config: ${e}`)}))),{}):this._availableUnitsObject}_getAvailablePriceSources(e){const t=this._availablePriceSourcesBySymbol.get(e);if(Array.isArray(t))return t;if((0,ue.isPromise)(t))return[];const i=this.chartApi().availablePriceSources(e)
;return this._availablePriceSourcesBySymbol.set(e,i),i.then((t=>{this._destroyed||(this._availablePriceSourcesBySymbol.set(e,t),this.fullUpdate())})).catch((e=>{Js.logWarn(`An error occurred while getting price sources config: ${e}`)})),[]}_clearAvailablePriceSources(){this._availablePriceSourcesBySymbol.clear()}_onSymbolIntervalChanged(){this._symbolIntervalChanged.fire()}_getBackgroundColor(e){const t=this._properties.childs().paneProperties.childs();if(t.backgroundType.value()===mi.ColorType.Gradient){const i=t.backgroundGradientStartColor.value(),s=t.backgroundGradientEndColor.value();return function(e,t,i){if((0,u.getCurrentTheme)().name===Qt.StdTheme.Dark&&(0,Jt.isOnMobileAppPage)("any")&&(0,u.isStdThemedDefaultValue)("chartProperties.paneProperties.backgroundGradientStartColor",e,Qt.StdTheme.Dark)&&(0,u.isStdThemedDefaultValue)("chartProperties.paneProperties.backgroundGradientEndColor",t,Qt.StdTheme.Dark))return ei;return i?e:t}(i,s,Boolean(e))}const i=t.background.value();return function(e){if((0,u.getCurrentTheme)().name===Qt.StdTheme.Dark&&(0,Jt.isOnMobileAppPage)("any")&&(0,u.isStdThemedDefaultValue)("chartProperties.paneProperties.background",e,Qt.StdTheme.Dark))return ei;return e}(i)}_getBackgroundCounterColor(){const e=this.backgroundColor().value();return"black"===(0,l.rgbToBlackWhiteString)((0,l.parseRgb)(e),150)?"white":"black"}_updateBackgroundColor(){this._backgroundColor.setValue(this._getBackgroundColor()),this._backgroundTopColor.setValue(this._getBackgroundColor(!0))}_syncCrosshair(e){if(!this._isSettingsExternalPosition){const t=this._undoModel.mainSeries(),i=t.syncModel(),s=this._undoModel.crossHairSource(),o=s.pane;if(null!==i&&null!==o){const r={timeStamp:this._timeScale.points().roughTime(s.index,i.projectTime.bind(i)),syncSourceTarget:i.syncSourceTarget()};o.mainDataSource()===t&&(r.price=s.price,r.symbol=t.symbol());let n=this._lineBeingCreated||null!==this._linePointBeingEdited||Boolean(this._sourcesBeingMoved.length);n=n&&(0,Fe.drawOnAllCharts)().value(),this._undoModel.syncCrosshair(r,n,e)}this._phantomSourceContainer.onCursorPositionUpdated()}}_gotoTimeImpl(e,t){const i=this.timeScale(),s=this.mainSeries();let o;if(void 0!==e){if(this._scrollingState&&this._scrollingState.deferred.reject(),o=(0,_.createDeferredPromise)(),o.promise.catch((()=>{})),!s.isDWM()){const t=s.symbolInfo();if(null!==t){const i=(0,n.ensureNotNull)(this.timezoneExceptExchange().value()),o=(0,qt.cal_to_utc)((0,qt.get_timezone)(i),new Date(e)),r=(0,Pi.createTimeToBarTimeAligner)(s.interval(),t)(o);e=(0,qt.utc_to_cal)((0,qt.get_timezone)(i),r).getTime()}}this._scrollingState={targetDate:e,deferred:o,centerIfVisible:t.centerIfVisible}}else{if(!this._scrollingState)return Js.logError("scrollTo called without an argument"),Promise.reject();e=this._scrollingState.targetDate,o=this._scrollingState.deferred}if(void 0===i.tickMarks().minIndex)return o.resolve(void 0),o.promise;this.stopTimeScaleAnimation();let r=((e,t)=>{if((e=>(0,n.ensureNotNull)(i.tickMarks().indexToTime((0,
n.ensureDefined)(i.tickMarks().minIndex))).valueOf()-e)(t)<0){let o=i.tickMarks().nearestIndex(t);const r=s.bars().lastIndex();if(null===r)return null;o=Math.min(o,r);let a=(0,n.ensureNotNull)(i.tickMarks().indexToTime(o)).valueOf();for(;a<t&&o<r;)o++,a=(0,n.ensureNotNull)(i.tickMarks().indexToTime(o)).valueOf();const l=(0,n.ensureNotNull)(i.visibleBarsStrictRange());if(e||!l.contains(o)){const e=i.width(),t=i.indexToCoordinate(o),s=i.coordinateToFloatIndex(t+e/2)-.5,r=Math.min(s,i.coordinateToFloatIndex(t-e/2)+.5);i.zoomToBarsRange(r,s)}return{timestamp:(0,n.ensureNotNull)(i.indexToTimePoint(o))}}return null})(this._scrollingState.centerIfVisible,this._scrollingState.targetDate);if(!r){const t=(0,n.ensureDefined)(i.tickMarks().minIndex),o=(0,n.ensureNotNull)(i.visibleBarsStrictRange()),a=o.lastBar()-o.firstBar();if(s.requestMoreDataAvailable()){const t=i.tickMarks().estimateLeft(e);i.requestMoreHistoryPoints(Math.ceil(t+a/2))}else i.zoomToBarsRange(t-a/2,t+a/2),r={timestamp:(0,n.ensureNotNull)(i.indexToTimePoint(t)),eod:!0}}if(r){if(this._scrollingState.centerIfVisible){const e=(0,n.ensureNotNull)(i.visibleBarsStrictRange());for(const t of this.panes()){for(const i of t.leftPriceScales())i.recalculatePriceRange(e);for(const i of t.rightPriceScales())i.recalculatePriceRange(e)}}this.fullUpdate(),this._scrollingState=null,o.resolve(r)}return o.promise}_setCorrectedPositionToCrosshair(e,t,i){this.crossHairSource().setPosition(e,t,i)}_onSymbolSourceCollectionChanged(e){this._clearAvailablePriceSources(),this._recalcAdjustForDividendsAvailability(),this._symbolSourceCollectionChanged.fire(e)}_onPriceSourcesCollectionChanged(e){this._panes.some((e=>e.hasDataSource(this.m_mainSeries)))&&(this._studiesWV.setValue(this.allStudies()),this._studiesExcludeInternalWV.setValue(this.allStudies(!0)))}_unmergeAvailable(e){return e===this.m_mainSeries||(0,O.isStudy)(e)&&!e.isLinkedToSeries()&&!(0,qs.isNonSeriesStudy)(e)&&e.showInObjectTree()}_getExceedingChildStudies(e){var t,i;let s=[];for(let t=0;t<e.length;++t)s=s.concat(e[t].sources||[]);let o=0,r=1;r=null!==(i=null===(t=(0,ni.getConfig)("STUDY_ON_STUDY"))||void 0===t?void 0:t.child_limit)&&void 0!==i?i:1;const n=[],a={};let l=0,c=1e6;for(;s.length&&--c;){const e=s[l];(e.ownerSource&&a[e.ownerSource]||!e.ownerSource)&&(a[e.id]=e,s.splice(s.indexOf(e),1),e.ownerSource&&(0,Ye.isStudyState)(e)&&e.state&&e.state.isChildStudy&&++o>r&&n.push(e)),l=(l+1)%s.length}return n}}},149109:(e,t,i)=>{"use strict";i.d(t,{allChartStyles:()=>n});var s=i(764829),o=i(125226);const r=(0,i(638456).onWidget)();function n(){return function(){const e=[0,1,9,13,2,14,15,3,16,10];return e.push(12),r||e.push(17),r||e.push(18),(0,o.isFeatureEnabled)("vpsession_chart_type")&&!r&&e.push(20),r||e.push(19),e}().concat(function(){const e=[8];return s.enabled("japanese_chart_styles")&&(e.push(4,7,5,6),e.push(11)),e}())}},7462:(e,t,i)=>{"use strict";var s=i(650151).assert,o=i(647042).ChartModelBase,r=i(465836).isLineTool,n=i(638456).CheckMobile,a=i(219849).InvalidationLevel;i(942634).Delegate
;const{sourceChangeEvent:l}=i(169532);var c=i(434396).isStudy,d=i(419283),h=i(866321).MainSeriesScaleRatioProperty,u=i(134392).scaleRatio,p=i(590250).dateFormatProperty,_=i(220003).timeHoursFormatProperty,m=i(251954),g=i(252767).StudyColorRotatorFactory,S=i(764829),v=i(436207).AppliedTimeFrame,f=S.enabled("fix_left_edge");class b extends o{constructor(e,t,i,s,o,r,n,a,l,c){super(e,t,i,s,o,r,n,a,l,c);var u=this;this._mainSeriesScaleRatioProperty=new h(this),this.m_mainSeries.dataEvents().completed().subscribe(this,function(){if(this._scrollingState&&this.gotoTime(),f&&!this.m_mainSeries.requestMoreDataAvailable()){var e=this.m_mainSeries.bars().first();null!==e&&this._timeScale.setLeftEdgeFix(e.index)}}.bind(this)),this.m_mainSeries.onIntervalChanged().subscribe(this,(function(){this._recalcVRStudiesParams.oldStartVisibleIndex=NaN,this._recalcVRStudiesParams.oldEndVisibleIndex=NaN})),this.m_mainSeries.dataEvents().barReceived().subscribe(this,b.prototype.updateTimeScaleBaseIndex),this._readOnly||(this.m_mainSeries.properties().addChild("priceAxisProperties",this.m_mainSeries.priceScale().properties()),this._properties.paneProperties.legendProperties.showStudyTitles.listeners().subscribe(this,(function(e){e.value()||u._properties.paneProperties.legendProperties.showStudyArguments.setValue(!1)}))),d.hideAllDrawings().subscribe(this,this._onDrawingsVisibilityChanged),d.hideAllIndicators().subscribe(this,this._onIndicatorsVisibilityChanged),this._properties.scalesProperties.listeners().subscribe(this,b.prototype.fullUpdate),this._studyShiftColorStartOffset=void 0,p.subscribe(this,this._updateDateTimeFormatter),_.subscribe(this,this._updateDateTimeFormatter),this.mainSeries().properties().interval.subscribe(this,this._updateDateTimeFormatter),this._updateDateTimeFormatter(),this._studyColorRotatorFactory=new g(this),this._undoModel._chartWidget.onWidget()||this._initAlertsList(),this._dataSourceCollectionChanged.subscribe(this,this._updateShowLegendProperty.bind(this)),this._properties.paneProperties.legendProperties.showLegend.subscribe(this,this._updateShowLegendProperty),this._appliedTimeFrame=new v(this),this.mainSeries().onTimeFrameApplied().subscribe(this,(function(e){var t=null!==e?{res:this.mainSeries().interval(),val:e}:null;this.appliedTimeFrame().setValue(t)}))}startNotStartedStudies(){if(!this.m_mainSeries.isStarted())throw new Error("Cannot start studies: main series is not started");for(var e=this.dataSources(),t=0;t<e.length;t++)c(e[t])&&!e[t].isStarted()&&e[t].restart&&e[t]!==this.m_mainSeries&&e[t].restart()}_onDrawingsVisibilityChanged(e){for(var t=!1===e.value(),i=this.dataSources(),s=0;s<i.length;s++){var o=i[s],n=r(o)&&o.properties().visible.value();t&&n?m.emit("drawing_event",o.id(),"show"):!t&&n&&m.emit("drawing_event",o.id(),"hide")}this.selectionMacro((function(e){e.clearSelection()}))}_onIndicatorsVisibilityChanged(){var e=this.allStudies().filter((function(e){return e.properties().visible.value()&&e.canBeHiddenByGlobalFlag()}));if(0!==e.length){
for(var t=!1,i=0;i<e.length;i++)if(this.selection().isSelected(e[i])){t=!0;break}t?this.selectionMacro((function(e){e.clearSelection()})):this.lightUpdate()}}priceScaleSlotsCount(){var e=0,t=0;this._panes.forEach((function(i){e=Math.max(i.leftPriceScales().length,e),t=Math.max(i.rightPriceScales().length,t)}));var i=e+t;if(n.any()){var s=this.paneForSource(this.mainSeries()),o=s.priceScalePosition(this.mainSeries().priceScale()),r="right"===o;return"overlay"===o&&(r=s.rightPriceScales().length>0),r?{left:0,right:1,totallySlots:i}:{left:1,right:0,totallySlots:i}}return{left:e,right:t,totallySlots:e+t}}setPriceAutoScale(e,t,i){e.setPriceAutoScale(t,i),this.invalidate(this._paneInvalidationMask(e,a.Light))}updateScales(e,t){this._undoModel._chartWidget._updateScalesActions()}mainSeriesScaleRatioProperty(){return this._mainSeriesScaleRatioProperty}mainSeriesScaleRatioPropertyOnChanged(){this._mainSeriesScaleRatioProperty.listeners().fire(this._mainSeriesScaleRatioProperty)}mainSeriesScaleRatio(){return u(this._timeScale,this.m_mainSeries.priceScale())}setMainSeriesScaleRatio(e){this.paneForSource(this.m_mainSeries).applyPriceScaleRatio(this.m_mainSeries.priceScale(),e)}dataSourceForId(e){for(var t,i=0;i<this._panes.length;++i)if(t=this._panes[i].dataSourceForId(e))return t;return null}onSyncScrollNeeded(e){var t=this._undoModel._chartWidget;if(t._chartWidgetCollection){var i=this.mainSeries().syncModel();if(i){var s=1e3*this._timeScale.points().roughTime(e,i.projectTime.bind(i));t._chartWidgetCollection.syncScroll(s,this)}}}calculateDefaultTags(){for(var e=[],t=this.dataSources(),i=0;i<t.length;i++){var s=t[i];s.tags&&(e=e.concat(s.tags()))}return e}_sendTo(e,t){var i={},s=this;for(var o in e.forEach((function(e){var t=s.paneForSource(e),o=s._panes.indexOf(t);i[o]||(i[o]=[]),i[o].push(e)})),i){t(s._panes[o],i[o])}this.fullUpdate()}sendToBack(e){this._sendTo(e,(function(e,t){e.sendToBack(t)}))}bringToFront(e){this._sendTo(e,(function(e,t){e.bringToFront(t)}))}destroy(){this.mainSeries().properties().childs().showCountdown.unsubscribeAll(this),this.mainSeries().onTimeFrameApplied().unsubscribeAll(this),this.mainSeries().onIntervalChanged().unsubscribeAll(this),this._appliedTimeFrame.destroy(),this.clearIntervals(),d.hideAllDrawings().unsubscribe(this,this._onDrawingsVisibilityChanged),d.hideAllIndicators().unsubscribe(this,this._onIndicatorsVisibilityChanged),this.resetDeferredStudies(),this.allStudies().forEach((e=>this.removeSource(e))),Array.from(this._customSourcesMap.keys()).forEach(this._removeCustomSource,this),s(0===this._topmostCustomSources.length),s(0===this._fgCustomSources.length),s(0===this._bgCustomSources.length),s(0===this._allCustomSources.length),s(0===this._customSourcesMap.size);for(var e=0;e<this._panes.length;e++)this._panes[e].destroy();this._panes.length=0,this._sessions=null,this.m_mainSeries.onStyleChanged().unsubscribe(this._timeScale,this._timeScale.invalidateVisibleBars),this._timeScale.visibleBarsStrictRangeChanged().unsubscribe(this.m_mainSeries,this.m_mainSeries.clearHighLowPriceCache),
this._timeScale.visibleBarsStrictRangeChanged().unsubscribe(this.m_mainSeries,this.m_mainSeries.clearAveragePriceCache),this._timeScale.barSpacingChanged().unsubscribeAll(this),this._timeScale.onScroll().unsubscribeAll(this),this._timeScale.destroy(),p.unsubscribe(this,this._updateDateTimeFormatter),_.unsubscribe(this,this._updateDateTimeFormatter),this.mainSeries().properties().interval.unsubscribe(this,this._updateDateTimeFormatter),this._trendLineStatsCache&&this._trendLineStatsCache.destroy(),this._fibRetracementLabelsCache&&this._fibRetracementLabelsCache.destroy(),this._properties.paneProperties.legendProperties.showLegend.unsubscribeAll(this),this._dataSourceCollectionChanged.unsubscribeAll(this),this.m_crossHairSource.destroy(),super.destroy()}restoreSource(e,t,i,s,o){var r,n;r=e?this.createPane(t):this.panes()[t];var a=s.type.toLowerCase().startsWith("study");if(!(n=a?r.restoreStudy(s):r.restoreLineTool(s)))return null;var c=null;if(o?c=r.getPriceScaleById(o.id):n.ownerSource()&&(c=n.ownerSource().priceScale()),c)n.setPriceScale(c),c.addDataSource(n);else{c=r.createPriceScaleAtPosition(o.position,o.priceScaleIndex);o&&o.id&&c.setId(o.id),n.setPriceScale(c),c.addDataSource(n)}if(!e&&i&&i.overlayPriceScales){var d=this.dataSources().filter((function(e){return void 0!==i.overlayPriceScales[e.id()]}));d.forEach(r.removeSourceFromPriceScale.bind(r));var h=new Map;d.forEach((function(e){var t,s=i.overlayPriceScales[e.id()];h.has(s.id)?t=h.get(s.id):((t=r.createPriceScaleAtPosition("overlay")).restoreState(s),h.set(s.id,t)),t.addDataSource(e),e.setPriceScale(t)}))}return n.start(),n.restore&&n.restore(),e&&r.restoreState({state:i,withData:!1,version:this.version()}),a&&(this.recalculateAllPanes(l(n.id())),this.mainSeries().invalidateBarColorerCache(),this.fullUpdate()),a&&this.alertsWatcher().syncSourceAlertLabels(n),n}getStudyShiftColorStartOffset(){return this._studyShiftColorStartOffset}setStudyShiftColorStartOffset(e){this._studyShiftColorStartOffset=e}onInReplayStateChanged(){return this.m_mainSeries.onInReplayStateChanged()}isPriceScaleVisible(e){var t=this.paneForSource(e.mainSource()),i=t.priceScalePosition(e);if("overlay"===i)return!0;var s=this.priceScaleSlotsCount();return t.priceScaleIndex(e,i)<s[i]}studiesColorRotatorFactory(){return this._studyColorRotatorFactory}}e.exports=b},615914:(e,t,i)=>{"use strict";i.d(t,{sourceNewCurrencyOnPinningToPriceScale:()=>o});var s=i(487945);function o(e,t,i,o){let r=null;if(i.currencyConversionEnabled()&&(0,s.isActingAsSymbolSource)(e)){const s=i.availableCurrencies(),n=t.currency(s),a=e.currency();null!==n&&null!==n.selectedCurrency&&!n.allCurrenciesAreOriginal&&n.selectedCurrency!==a&&(o&&null===a||null!==a&&s.convertible(a))&&(r=n.selectedCurrency)}return r}},590250:(e,t,i)=>{"use strict";i.d(t,{dateFormatProperty:()=>l,restoreDateFormatSettingsValue:()=>c});var s=i(62802),o=i(998418),r=i(246125);const n="date_format";function a(){return s.getValue(n,(0,r.defaultDateFormat)())}const l=(0,o.createPrimitiveProperty)(a());function c(){l.setValue((0,
r.defaultDateFormat)()),s.remove(n)}s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())))},336068:(e,t,i)=>{"use strict";i.d(t,{DeferredStudies:()=>n});var s=i(955273);const o=[],r=[];class n{constructor(e){this._studies={},this._deferreds={},this._container=e,o.push(e),r.push(this)}add(e,t){this._deferreds[e]&&(this._deferreds[e].resolve(t),delete this._deferreds[e]),this._studies[e]=t}get(e){return this._studies[e]?Promise.resolve(this._studies[e]):(this._deferreds[e]||(this._deferreds[e]=(0,s.createDeferredPromise)()),this._deferreds[e].promise)}delete(e){delete this._studies[e],delete this._deferreds[e]}reset(){const e=o.indexOf(this._container);~e&&(o.splice(e,1),r.splice(e,1))}static instance(e){const t=o.indexOf(e);return~t?r[t]:new n(e)}static ready(){for(const e of r)if(Object.keys(e._deferreds).length>0)return!1;return!0}}},970427:(e,t,i)=>{"use strict";i.d(t,{EnvironmentState:()=>o});var s=i(638456);class o{constructor(e,t=!1){this._shift=!1,this._mod=!1,this._alt=!1,void 0!==e&&(this._shift=Boolean(e.shiftKey),this._mod=Boolean((0,s.isMac)()?e.metaKey:e.ctrlKey),this._alt=Boolean(e.altKey)),this._isApiEvent=t}shift(){return this._shift}mod(){return this._mod}alt(){return this._alt}shiftOnly(){return this._shift&&!this._mod&&!this._alt}modOnly(){return this._mod&&!this._shift&&!this._alt}altOnly(){return this._alt&&!this._shift&&!this._mod}modShift(){return this._shift&&this._mod&&!this._alt}isApiEvent(){return this._isApiEvent}static create(e=!1,t=!1,i=!1){return new o({shiftKey:e,ctrlKey:t,metaKey:t,altKey:i})}}},212642:(e,t,i)=>{"use strict";i.d(t,{TimeSpanFormatter:()=>n});var s=i(444372),o=i(676323),r=i(96900);class n{format(e,t){const n=e<0;e=Math.abs(e);const a=Math.floor(e/86400);e-=86400*a;const l=Math.floor(e/3600);e-=3600*l;const c=Math.floor(e/60);e-=60*c;let d="";if(a){const e=(0,r.getNumberFormat)(null==t?void 0:t.ignoreLocaleNumberFormat);d+=(0,o.formatNumber)(a,e)+s.t(null,{context:"dates"},i(585886))+" "}return l&&(d+=l+s.t(null,{context:"dates"},i(244634))+" "),c&&(d+=c+s.t(null,{context:"dates"},i(105977))+" "),e&&(d+=e+s.t(null,{context:"dates"},i(21492))+" "),n&&(d="-"+d),d.trim()}}},147117:(e,t,i)=>{"use strict";i.d(t,{FuturesContractExpiration:()=>O,isFuturesContractExpiration:()=>N});var s=i(650151),o=i(903424),r=i(343272),n=i(822914),a=i(960095),l=i(86441),c=i(444372),d=i(432059),h=i(694852),u=i(528474),p=i(666574),_=i(511275),m=i(483445),g=i(509078),S=i(665798),v=i(528390);const f=new Path2D("M.18.24a4.78 4.78 0 0 0 .9 4.36c.15.18.32.34.51.5l.52.4-.52.4a3.8 3.8 0 0 0-.52.5 4.78 4.78 0 0 0-.89 4.36c.04.14.16.24.29.24h6.06c.13 0 .25-.1.29-.24a4.78 4.78 0 0 0-.9-4.36 3.8 3.8 0 0 0-.51-.5l-.52-.4.52-.4c.19-.16.36-.32.52-.5A4.78 4.78 0 0 0 6.82.24C6.78.1 6.66 0 6.53 0H.47C.34 0 .22.1.18.24ZM3.5 4.88l1.23-.97a3 3 0 0 0 1.05-2.48H1.22a3 3 0 0 0 1.05 2.48l1.23.97Z");class b extends v.LollipopRenderer{_drawLollipop(e,t,i){const s=this._data.style;e.save(),e.translate(t.x,t.y),e.scale(i.horizontalPixelRatio,i.verticalPixelRatio),e.beginPath(),
e.strokeStyle=s.outerBorderColor,e.lineWidth=1,e.arc(0,0,11,0,2*Math.PI),e.stroke(),e.fillStyle=s.backgroundColor,e.beginPath(),e.arc(0,0,10.5,0,2*Math.PI),e.fill(),e.translate(-3.5,-5.5),e.fillStyle=s.iconColor,e.fill(f,"evenodd"),e.translate(3.5,5.5),s.borderColor&&(e.strokeStyle=s.borderColor,e.lineWidth=1.5,(0,S.setLineStyle)(e,p.LINESTYLE_SOLID),e.beginPath(),e.arc(0,0,9.75,0,2*Math.PI),e.stroke()),e.restore()}}var y=i(760823);const C=c.t(null,void 0,i(289407)),w=c.t(null,void 0,i(260657)),T={dark:{background:(0,a.getHexColorByName)("color-cold-gray-900"),foreground:(0,a.getHexColorByName)("color-cold-gray-450"),foregroundExpired:(0,a.getHexColorByName)("color-ripe-red-500")},light:{background:(0,a.getHexColorByName)("color-white"),foreground:(0,a.getHexColorByName)("color-cold-gray-550"),foregroundExpired:(0,a.getHexColorByName)("color-ripe-red-500")}},P={barLine:{lineStyle:p.LINESTYLE_DASHED,lineWidth:1,strokeStyle:""},lollipop:{width:21,height:21,bottom:2,lineWidth:1.5,strokeStyle:"",backgroundColor:"",fillCircle:!0,fillStyle:"",text:{label:"",strokeStyle:"",font:(0,h.makeFont)(12,_.CHART_FONT_FAMILY,"bold")}},iconColor:"",backgroundColor:"",outerBorderColor:""};class M extends m.LollipopPaneView{constructor(){super(...arguments),this._style=(0,n.default)(P)}renderer(e){return this._invalidated&&(this._createLollipops(e),this._invalidated=!1),this._renderer}getStyle(e){const t=this._model.dark().value()?T.dark:T.light,i=e.expired?t.foregroundExpired:t.foreground,s=t.background,o=this._style;return e.active?(o.backgroundColor=i,o.iconColor=s,o.borderColor=void 0):(o.iconColor=i,o.borderColor=i,o.backgroundColor=e.hovered?(0,u.blendColors)(s,(0,d.applyAlpha)(i,.15)):s),o.outerBorderColor=s,o.barLine.strokeStyle=i,o}_createTooltipContent(e){const t=this._model.dark().value()?T.dark:T.light,i=e.expired?t.foregroundExpired:t.foreground;return[{type:"common",title:e.expired?w:C,subTitle:e.expiration,tooltipIcon:y.replace(/currentColor/g,i),style:{color:i}}]}_createRendererForLollipop(e,t){return new b(e,new g.HitTestResult(g.HitTarget.Custom,t),this._textWidthCache)}_createLollipops(e){const t=this._source.data();if(null===t||void 0===t.index)return;const i=this._model.timeScale(),s=super._getY(),o=this._model.hoveredSource()===this._source,r=null!==this.getLastClickedLollipopId(),n={id:0,itemIndex:0,basePoint:(0,l.point)(i.indexToCoordinate(t.index),s),hovered:o,active:r,expiration:t.formattedDate,expired:t.expired,visible:!0};this._lollipops[0]=n,super._createRenderers(e)}}var x=i(870045),I=i(395394),L=i(338619),A=i(658843),k=i(850599);const E=(0,L.getLogger)("FutureContractExpiration");let D=0;let B=0;function N(e){return e instanceof O}const R={visible:!0};class O extends o.DataSource{constructor(e){super("futures_contract_expiration"),this._data=null,this._pointsetId=(D+=1,`future_expiration_${D}`),this._pointsetTurnaround=null,this._properties=new A.Property(R),this._onConnectionStateChanged=e=>{e?this._updateData():this._removePointset()},this.setOwnerSource(e.mainSeries()),this._model=e,
this._paneView=new M(e,this,this._showTooltip.bind(this));const t=(0,s.ensureNotNull)(e.mainSeries().marketStatusModel().futuresContractExpirationTime());this._expirationUTCTime=t.utcTime().spawn(),this._expired=t.expired().spawn(),this._sessionSpec=t.sessionSpec().spawn(),this._formattedExpirationDate=()=>e.dateFormatter().format(t.utcDayStart()),this._expirationUTCTime.subscribe((()=>{this._removePointset(),this._updateData(),this._paneView.update(),this._model.updateSource(this)})),this._expired.subscribe((()=>{null!==this._data&&(this._data.expired=this._expired.value(),this._paneView.update(),this._model.updateSource(this))}));const i=()=>{this._removePointset(),this._createPointset()};this._destroyPropertyBinder=(0,k.bindProperties)(e.mainSeries().properties().childs().showFuturesContractExpiration,this._properties.childs().visible),e.mainSeries().onIntervalChanged().subscribe(this,i),this._sessionSpec.subscribe(i),e.chartApi().isConnected().subscribe(this._onConnectionStateChanged),this._updateData()}destroy(){this._removePointset(),this._model.mainSeries().onIntervalChanged().unsubscribeAll(this),this._model.chartApi().isConnected().unsubscribe(this._onConnectionStateChanged),this._paneView.destroy(),this._expirationUTCTime.destroy(),this._expired.destroy(),this._sessionSpec.destroy(),this._destroyPropertyBinder(),super.destroy()}lollipopsAtIndex(e){return null===this._data||this._data.index!==e?0:1}name(){return"FuturesContractExpiration"}properties(){return this._properties}state(e){return null}paneViews(e){return[this._paneView]}updateAllViews(e){this._paneView.update()}data(){return this._data}zorder(){return r.sortSourcesPreOrdered.FutureContractExpiration}onClickOutside(e,t){this._paneView.processClickOutside(e,t)}preferNoScale(){return!0}showInObjectTree(){return!1}isSavedInStudyTemplates(){return!1}isRemovedByStudyTemplates(){return!1}copiable(){return!1}hasStateForAlert(){return!1}isSavedInChart(e){return!1}isSpeciallyZOrderedSource(){return!0}isUserDeletable(){return!1}canHaveChildren(){return!1}isIncludedInAutoScale(){return!1}async _showTooltip(e,t,o){const r=this._model,n=this._model.timeScale(),a=[n.onScroll(),n.barSpacingChanged(),r.mainSeries().onSymbolIntervalChanged(),(0,s.ensureNotNull)(r.paneForSource(this)).onSizeChanged()],l=this._paneView.processClickOutside.bind(this._paneView,e),c=this._paneView.clearLastClicked.bind(this._paneView),d=o();if(null===d)return;const{showLollipopTooltip:h}=await Promise.all([i.e(31141),i.e(46445),i.e(93703),i.e(2520),i.e(53953),i.e(49481),i.e(62564),i.e(75826),i.e(58985),i.e(65857),i.e(22164),i.e(36010),i.e(73399),i.e(16190),i.e(21251),i.e(92115),i.e(87393),i.e(67661),i.e(55057),i.e(52017),i.e(6633),i.e(89259),i.e(68827),i.e(18488),i.e(610),i.e(46879),i.e(65642),i.e(74420),i.e(66764),i.e(83579),i.e(5820),i.e(25326),i.e(32887),i.e(14807),i.e(82321),i.e(13217),i.e(23460),i.e(93516),i.e(49039)]).then(i.bind(i,593247));h({items:d,position:t,customCloseSubscriptions:a,onClickOutside:l,onCustomClose:c,showScrollFades:!0})}_updateData(){
const e=this._expirationUTCTime.value();if(null===e)return this._data=null,void this._removePointset();this._data={time:e,expired:this._expired.value(),formattedDate:this._formattedExpirationDate()},this._createPointset()}_removePointset(){if(null!==this._pointsetTurnaround){const e=this._model.chartApi();e.isConnected().value()&&e.removePointset(this._pointsetId),this._pointsetTurnaround=null}}_createPointset(){if(null!==this._pointsetTurnaround)return;const e=this._model,t=e.chartApi(),i=this._sessionSpec.value();if(null===this._data||null===i||!t.isConnected().value())return;const o=e.mainSeries();if(null===o.symbolInfo())return;const r=(0,s.ensureNotNull)(e.timezoneExceptExchange().value()),n=x.get_timezone(r);this._pointsetTurnaround=(B+=1,`t${B}`);const a=(0,s.ensureNotNull)(o.seriesSource().symbolInstanceId()),l=(0,I.getServerInterval)(o.interval());let c;const d=this._data.time;if(o.isDWM()){const e=new Date(d);i.alignToSessionStart(e),c=[[x.cal_to_utc(n,e)/1e3,0]]}else c=[[d/1e3,0]];t.createPointset(this._pointsetId,this._pointsetTurnaround,a,l,c,this._onPointsetResponse.bind(this))}_onPointsetResponse(e){if("pointset_error"===e.method){const[t,i]=e.params;return void(t===this._pointsetId&&i===this._pointsetTurnaround&&E.logError("Pointset error"))}const t=e.params;t.customId===this._pointsetId&&null!==this._data&&(this._data.index=0===t.plots.length?void 0:t.plots[0].value[0],this._paneView.update(),this._model.updateSource(this))}}},862954:(e,t,i)=>{"use strict";function s(e){return e&&e.lollipopsAtIndex}i.d(t,{isLollipopDataSource:()=>s})},803279:(e,t,i)=>{"use strict";function s(e){return Boolean(e.showInObjectTree)}i.d(t,{isDataSource:()=>s})},599344:(e,t,i)=>{"use strict";i.d(t,{LatestUpdatesSource:()=>j,isLatestUpdatesSource:()=>G});var s=i(650151),o=i(338619),r=i(903424),n=i(343272),a=i(658843),l=i(850599),c=i(203918),d=i(125226),h=i(822914),u=i(960095),p=i(86441),_=i(444372),m=i(887357),g=i(207678),S=i(528474),v=i(638456),f=i(345848),b=i(137674),y=i(432059),C=i(694852),w=i(666574),T=i(511275),P=i(483445),M=i(509078),x=i(665798),I=i(528390);const L=new Path2D("m7.06 0 .87.77-3.4 4.17H9L1.94 11l-.87-.77 3.4-4.17H0L7.06 0Z");class A extends I.LollipopRenderer{_drawLollipop(e,t,i){const s=this._data.style;e.save(),e.translate(t.x,t.y),e.scale(i.horizontalPixelRatio,i.verticalPixelRatio),e.beginPath(),e.strokeStyle=s.outerBorderColor,e.lineWidth=1,e.arc(0,0,11,0,2*Math.PI),e.stroke(),e.fillStyle=s.backgroundColor,e.beginPath(),e.arc(0,0,10.5,0,2*Math.PI),e.fill(),e.translate(-4.5,-5.5),e.fillStyle=s.iconColor,e.fill(L,"evenodd"),e.translate(4.5,5.5),s.borderColor&&(e.strokeStyle=s.borderColor,e.lineWidth=1.5,(0,x.setLineStyle)(e,w.LINESTYLE_SOLID),e.beginPath(),e.arc(0,0,9.75,0,2*Math.PI),e.stroke()),s.hasUpdatesCircle&&(e.fillStyle=s.hasUpdatesCircle.color,e.strokeStyle=s.hasUpdatesCircle.borderColor,e.lineWidth=2,e.beginPath(),e.arc(9.75*Math.cos(Math.PI/4),9.75*-Math.sin(Math.PI/4),3.5,0,2*Math.PI),e.closePath(),e.fill(),e.stroke()),e.restore()}}var k=i(244230);const E=(0,
o.getLogger)("LatestUpdatesProvider"),D={dark:{background:(0,u.getHexColorByName)("color-cold-gray-900"),foreground:(0,u.getHexColorByName)("color-grapes-purple-400"),hasUpdatesCircle:(0,u.getHexColorByName)("color-ripe-red-500"),lightningActiveColor:(0,u.getHexColorByName)("color-deep-blue-50")},light:{background:(0,u.getHexColorByName)("color-white"),foreground:(0,u.getHexColorByName)("color-grapes-purple-500"),hasUpdatesCircle:(0,u.getHexColorByName)("color-ripe-red-500"),lightningActiveColor:(0,u.getHexColorByName)("color-white")}},B={barLine:{lineStyle:w.LINESTYLE_DASHED,lineWidth:1,strokeStyle:""},lollipop:{width:21,height:21,bottom:2,lineWidth:1.5,strokeStyle:"",backgroundColor:"",fillCircle:!0,fillStyle:"",text:{label:"",strokeStyle:"",font:(0,C.makeFont)(12,T.CHART_FONT_FAMILY,"bold")}},iconColor:"",backgroundColor:"",outerBorderColor:""};async function N(e,t,s){const{openMindsPage:o}=await i.e(20603).then(i.bind(i,337860));o(e,t,s)}const R=_.t(null,void 0,i(214312)),O=_.t(null,void 0,i(338333)),V=_.t(null,void 0,i(505393)),W=_.t(null,void 0,i(447251)),F=_.t(null,void 0,i(791937));class H extends P.LollipopPaneView{constructor(){super(...arguments),this._style=(0,h.default)(B)}renderer(e){return this._source.hideLollipop()?null:(this._invalidated&&(this._createLollipops(e),this._invalidated=!1),this._renderer)}getStyle(e){const t=this._model.dark().value()?D.dark:D.light,i=t.foreground,s=t.background,o=this._style;return e.active?(o.backgroundColor=i,o.iconColor=t.lightningActiveColor,o.borderColor=void 0):(o.iconColor=i,o.borderColor=i,o.backgroundColor=e.hovered?(0,S.blendColors)(s,(0,y.applyAlpha)(i,.15)):s),o.outerBorderColor=s,o.barLine.strokeStyle=i,o.lollipop.incHeight=void 0===e.stack?void 0:25*e.stack,o.hasUpdatesCircle=e.data.hasNewItems?{color:t.hasUpdatesCircle,borderColor:s}:void 0,o}_createTooltipContent(e){var t,s,o,r,n;const a=this._model.mainSeries().symbol(),l=(this._model.dark().value()?D.dark:D.light).foreground,c=e.data.newsData,d=e.data.mindsData,h=c&&c.items.length>0,u=d&&d.items.length>0;if(!h&&!u)return null;const p=null!==(t=a.split(":")[1])&&void 0!==t?t:a,S={title:h&&u?R:h&&_.t(null,{replace:{symbol:p}},i(900945))||u&&_.t(null,{replace:{symbol:p}},i(690441))||"",tabs:[],tooltipIcon:k.replace(/currentColor/g,l),style:{color:l}};return h&&S.tabs.push({id:"news",name:O,content:{type:"news",items:c.items,clickHandler:(e,t)=>{v.CheckMobile.any()&&this._source.hideTooltip(),async function(e,t,s){e.isExternal||s.preventDefault();try{const o={...e,analyticsData:t.analyticsData},[{TradingViewNewsProviderFetcher:r},{onNewsCardAction:n}]=await Promise.all([i.e(56370).then(i.bind(i,619008)),i.e(56370).then(i.bind(i,458468))]);n({newsItem:o,newsItems:(await r.instance().fetch({...t.requestProps,client:"web"},3e5)).items,placement:m.NewsWidgetPlacement.Chart})(s)}catch(s){E.logWarn(`An error ocurred while loading news: ${s}`)}}(e,c,t)}},anchor:(null===(o=null===(s=window.widgetbar)||void 0===s?void 0:s.layout)||void 0===o?void 0:o.canOpen())?{text:W,onClick:()=>{var e
;this._source.hideTooltip(),null===(e=window.widgetbar)||void 0===e||e.setPage("base"),(0,b.showSymbolNews)(a)},hideInMobileMode:!0}:void 0}),u&&S.tabs.push({id:"minds",name:V,content:{type:"minds",symbol:a,items:d.items,clickHandler:(e,t,i)=>{this._source.hideTooltip(),function(e,t,i,s){var o;window.innerWidth<g.mobileFirstBreakpoints["media-mf-tablet-vertical"]&&(null===(o=window.widgetbar)||void 0===o||o.resizerBridge.requestFullscreen()),N(i,e[t].uid,s)}(e,t,a,i)}},anchor:(null===(n=null===(r=window.widgetbar)||void 0===r?void 0:r.layout)||void 0===n?void 0:n.canOpen())?{text:F,onClick:()=>{this._source.hideTooltip(),function(e){var t;window.innerWidth<g.mobileFirstBreakpoints["media-mf-tablet-vertical"]&&(null===(t=window.widgetbar)||void 0===t||t.resizerBridge.requestFullscreen()),N(e)}(a)},hideInMobileMode:!0}:void 0}),S}_lollipopMouseClickHandler(e,t,i,s){super._lollipopMouseClickHandler(e,t,i,s),(0,f.trackEvent)("Lollipops","Click on lightning")}_createRendererForLollipop(e,t){return new A(e,new M.HitTestResult(M.HitTarget.Custom,t),this._textWidthCache)}_createLollipops(e){const t=this._source.data();if(null===t||(void 0===t.newsData||0===t.newsData.items.length)&&(void 0===t.mindsData||0===t.mindsData.items.length))return;const i=this._model.mainPane();if(!i)return;const s=this._model.timeScale(),o=super._getY(),r=this._model.hoveredSource()===this._source,n=null!==this.getLastClickedLollipopId(),a=this._source.zorder();let l=0;for(const e of i.lollipopDataSources())e!==this._source&&e.zorder()>a&&e.isVisible()&&(l+=e.lollipopsAtIndex(t.index));const c={id:0,itemIndex:0,basePoint:(0,p.point)(s.indexToCoordinate(t.index),o),hovered:r,active:n,visible:!0,stack:l,data:t};this._lollipops[0]=c,super._createRenderers(e)}}const z=(0,o.getLogger)("Chart.LatestUpdate"),U={visible:!0};function G(e){return e instanceof j}function q(e){return!e.isSeconds()&&!e.isTicks()}class j extends r.DataSource{constructor(e,t){super("latestUpdates"),this._properties=new a.Property(U),this._items={},this._hasNewItems=!1,this._newsThread=null,this._mindsThread=null,this._hideLollipopTooltipFn=null,this._onMindsHistoryReady=this._onMindsItems.bind(this,void 0),this._onNewsHistoryReady=this._onNewsItems.bind(this,void 0),this.setOwnerSource(e.mainSeries()),this._latestUpdatesDataEnabled=t,this._model=e,this._series=e.mainSeries(),this._paneView=new H(e,this,this._showTooltip.bind(this)),this._series.symbolResolved().subscribe(this,this._onSymbolResolved);const i=this._series.intervalObj();this._isAvailableOnCurrentInterval=q(i),this._series.onIntervalChanged().subscribe(this,this._recalculateAvailabilityOnCurrentInterval),this._destroyPropertyBinder=(0,l.bindProperties)(e.mainSeries().properties().childs().showLastNews,this._properties.childs().visible),this._initializeNewsAndMindsThreads(),this._hideLollipop=(0,c.createWVFromGetterAndSubscriptions)((()=>this._model.isInReplay().value()||!q(this._series.intervalObj())),[this._model.onInReplayStateChanged(),this._series.onIntervalChanged()]),
this._hideLollipop.subscribe((()=>this._model.updateSource(this)))}destroy(){this._destroyNewsThread(),this._destroyMindsThread(),this._paneView.destroy(),this._series.symbolResolved().unsubscribeAll(this),this._series.onIntervalChanged().unsubscribeAll(this),this._destroyPropertyBinder(),this._hideLollipop.destroy(),super.destroy()}hideLollipop(){return this._hideLollipop.value()}lollipopsAtIndex(e){var t;return Object.keys(this._items).length>0&&e===(null===(t=this._series.data().last())||void 0===t?void 0:t.index)?1:0}name(){return"LatestUpdatesSource"}data(){const e=this._series.data().last();if(null===e||void 0===Object.keys(this._items).length)return null;const t={index:e.index,hasNewItems:this._hasNewItems};return this._items[0]&&void 0!==this._requestNewsProps&&void 0!==this._newsAnalyticsData&&(t.newsData={items:this._items[0],requestProps:this._requestNewsProps,analyticsData:this._newsAnalyticsData}),this._items[1]&&(t.mindsData={items:this._items[1]}),t}properties(){return this._properties}state(e){return null}paneViews(e){return[this._paneView]}updateAllViews(e){this._paneView.update()}zorder(){return n.sortSourcesPreOrdered.LatestUpdates}onClickOutside(e,t){this._paneView.processClickOutside(e,t)}preferNoScale(){return!0}showInObjectTree(){return!1}isSavedInStudyTemplates(){return!1}isRemovedByStudyTemplates(){return!1}copiable(){return!1}hasStateForAlert(){return!1}isSavedInChart(e){return!1}isSpeciallyZOrderedSource(){return!0}isUserDeletable(){return!1}canHaveChildren(){return!1}isIncludedInAutoScale(){return!1}hideTooltip(){var e;null===(e=this._hideLollipopTooltipFn)||void 0===e||e.call(this),this._hideLollipopTooltipFn=null}async _showTooltip(e,t,o){const r=this._model.timeScale(),n=[r.onScroll(),r.barSpacingChanged(),this._series.onSymbolIntervalChanged(),(0,s.ensureNotNull)(this._model.paneForSource(this)).onSizeChanged()],a=this._paneView.processClickOutside.bind(this._paneView,e),l=this._paneView.clearLastClicked.bind(this._paneView),c=o();if(null===c)return;this._hasNewItems=!1;const{showLollipopTooltipWithTabs:d}=await Promise.all([i.e(31141),i.e(46445),i.e(93703),i.e(2520),i.e(53953),i.e(49481),i.e(62564),i.e(75826),i.e(58985),i.e(65857),i.e(22164),i.e(36010),i.e(73399),i.e(16190),i.e(21251),i.e(92115),i.e(87393),i.e(67661),i.e(55057),i.e(52017),i.e(6633),i.e(89259),i.e(68827),i.e(18488),i.e(610),i.e(46879),i.e(65642),i.e(74420),i.e(66764),i.e(83579),i.e(5820),i.e(25326),i.e(32887),i.e(14807),i.e(82321),i.e(13217),i.e(23460),i.e(93516),i.e(49039)]).then(i.bind(i,395597));this._hideLollipopTooltipFn=d({content:c,position:t,customCloseSubscriptions:n,onClickOutside:a,doNotCloseOn:()=>[document.querySelector('[data-name="news-dialog"]'),document.querySelector('[data-dialog-name="image-dialog"]')].filter((e=>null!==e)),onCustomClose:l,showScrollFades:!0})}async _initializeNewsAndMindsThreads(){if(!this._isAvailableOnCurrentInterval)return void(this._items={});null!==this._series.symbolInfo()&&(this._initializeNewsThread(),this._initializeMindsThread())}async _initializeMindsThread(){
if(!this._latestUpdatesDataEnabled.minds)return;const e=(0,s.ensureNotNull)(this._series.symbolInfo());try{const{popularMindsThread:t}=await i.e(12127).then(i.bind(i,316608));this._mindsThread=t({symbol:e.pro_name,limit:3},3e5,3e5),this._mindsThread.newItems().subscribe(this,this._onMindsItems.bind(this,!0)),this._mindsThread.historyReady().value()?this._onMindsItems():this._mindsThread.historyReady().subscribe(this._onMindsHistoryReady,{once:!0})}catch(e){z.logWarn(`An error ocurred while loading minds: ${e}`)}}async _initializeNewsThread(){if(!this._latestUpdatesDataEnabled.news)return;const e=(0,s.ensureNotNull)(this._series.symbolInfo());try{const[{getIsoLanguageCodeFromLanguage:t},{getCardsAnalyticsData:s},{handleNewsProName:o},{newsThread:r}]=await Promise.all([i.e(56370).then(i.bind(i,39654)),i.e(56370).then(i.bind(i,859409)),i.e(56370).then(i.bind(i,470598)),i.e(56370).then(i.bind(i,603326))]),n=!!(window.is_authenticated&&(0,d.isFeatureEnabled)("move_chart_news_to_streaming")&&(0,d.isFeatureEnabled)("news_enable_streaming"))||void 0;this._requestNewsProps={lang:t(window.language),symbol:o(e.pro_name,e.type),client:"chart",streaming:n},this._newsAnalyticsData=s(this._requestNewsProps),this._newsThread=r(this._requestNewsProps,3e5,3e5),this._newsThread.newItems().subscribe(this,this._onNewsItems.bind(this,!0)),this._newsThread.historyReady().value()?this._onNewsItems():this._newsThread.historyReady().subscribe(this._onNewsHistoryReady,{once:!0})}catch(e){z.logWarn(`An error ocurred while loading news: ${e}`)}}_onNewsItems(e){const t=this._series.symbolInfo();if(this._isDestroyed||null===t)return;let i=(0,s.ensureNotNull)(this._newsThread).history().slice();i.length>0&&Date.now()-i[0].published>=26784e5&&(i=[]),this._items[0]=i,e&&(this._hasNewItems=!0),Object.keys(this._items).length&&(this._paneView.update(),this._model.updateSource(this))}_onMindsItems(e){const t=this._series.symbolInfo();if(this._isDestroyed||null===t)return;const i=(0,s.ensureNotNull)(this._mindsThread).history().slice();this._items[1]=i,e&&(this._hasNewItems=!0),Object.keys(this._items).length&&(this._paneView.update(),this._model.updateSource(this))}_destroyNewsThread(){this._newsThread&&(this._newsThread.historyReady().unsubscribe(this._onNewsHistoryReady),this._newsThread.newItems().unsubscribeAll(this),this._newsThread.destroy(),this._newsThread=null)}_destroyMindsThread(){this._mindsThread&&(this._mindsThread.historyReady().unsubscribe(this._onMindsHistoryReady),this._mindsThread.newItems().unsubscribeAll(this),this._mindsThread.destroy(),this._mindsThread=null)}_onSymbolResolved(){this._items={},this._destroyNewsThread(),this._destroyMindsThread(),this._initializeNewsAndMindsThreads()}_recalculateAvailabilityOnCurrentInterval(){const e=q(this._series.intervalObj());e!==this._isAvailableOnCurrentInterval&&(this._isAvailableOnCurrentInterval=e,e?this._initializeNewsAndMindsThreads():(this._destroyNewsThread(),this._destroyMindsThread(),this._paneView.update(),this._model.updateSource(this)))}}},684634:(e,t,i)=>{"use strict";i.d(t,{
LineToolsGroup:()=>l});var s=i(942634),o=i(375397),r=i(79342);function n(e){return e.properties().visible.value()}function a(e){return!n(e)}class l{constructor(e,t,i){this._instanceId=(0,r.randomHashN)(6),this._onChanged=new s.Delegate,this._lineToolsSet=new Set,this._lineTools=[...e],this._lineToolsSet=new Set(this._lineTools),this._name=new o.WatchedValue(t),this.id=i||(0,r.randomHashN)(6)}instanceId(){return this._instanceId}lineTools(){return this._lineTools}name(){return this._name}setName(e){this._doAndFireOnChange((()=>{this._name.setValue(e)}))}isActualSymbol(){return this._lineTools.length>0&&this._lineTools[0].isActualSymbol()&&this._lineTools[0].isActualCurrency()&&this._lineTools[0].isActualUnit()}symbol(){return this._lineTools[0].symbol()}currencyId(){var e;return null!==(e=this._lineTools[0].properties().childs().currencyId.value())&&void 0!==e?e:null}unitId(){var e;return null!==(e=this._lineTools[0].properties().childs().unitId.value())&&void 0!==e?e:null}sharingMode(){return this._lineTools[0].sharingMode()}share(e){this._lineTools.forEach((t=>t.share(e)))}containsLineTool(e){return this._lineToolsSet.has(e)}addLineTools(e){this._doAndFireOnChange((t=>{e.forEach((e=>this._lineToolsSet.add(e))),this._lineTools.push(...e),t.push(...e.map((e=>e.id())))}))}excludeLineTool(e){this._doAndFireOnChange((t=>{this._lineToolsSet.delete(e);const i=this._lineTools.indexOf(e);this._lineTools.splice(i,1),t.push(e.id())}))}excludeLineTools(e){this._doAndFireOnChange((t=>{const i=new Set(e);e.forEach((e=>this._lineToolsSet.delete(e))),this._lineTools=this._lineTools.filter((e=>!i.has(e))),t.push(...e.map((e=>e.id())))}))}state(){return{id:this.id,name:this._name.value(),tools:this._lineTools.map((e=>e.id()))}}visibility(){const e=this._lineTools.some(n),t=this._lineTools.some(a);return e&&!t?"Visible":t&&!e?"Invisible":"Partial"}locked(){const e=this._lineTools.some((e=>e.properties().frozen.value())),t=this._lineTools.some((e=>!e.properties().frozen.value()));return e&&!t?"Locked":t&&!e?"Unlocked":"Partial"}isActualInterval(){const e=this._lineTools.some((e=>e.isActualInterval())),t=this._lineTools.some((e=>!e.isActualInterval()));return e&&!t?"IsActualInterval":t&&!e?"IsNotActualInterval":"Partial"}onChanged(){return this._onChanged}static fromState(e,t){const i=[];for(const s of t.tools){const t=e.dataSourceForId(s);null!==t&&i.push(t)}return i.length>0?new l(i,t.name,t.id):null}_doAndFireOnChange(e){const t=[],i=this.visibility(),s=this.locked(),o=this.isActualInterval();e(t),this._onChanged.fire({affectedLineTools:t,visibilityChanged:i!==this.visibility(),lockedChanged:s!==this.locked(),isActualIntervalChanged:o!==this.isActualInterval()})}}},55907:(e,t,i)=>{"use strict";i.d(t,{blobImageFilter:()=>a,checkImageSize:()=>u,generateLink:()=>h,imageIsOversized:()=>c,uploadImage:()=>p});var s=i(743068),o=i(702598),r=i(444372),n=i(338619);function a(e){return"image/png"===e.type||"image/jpeg"===e.type}const l=(0,s.size)({width:2e3,height:2e3});function c(e){return e.width>l.width||e.height>l.height}const d=(0,
n.getLogger)("Chart.Uploader");async function h(e){const t=new FormData,i="name"in e?e.name:"image.png";t.append("content_type",e.type),t.append("filename",i),t.append("size",""+e.size);try{const e=await(0,o.fetch)("/charts/uploads/generate-link/",{method:"POST",body:t});if(!e.ok)throw new Error(`Error generating upload link: ${e.status}`);return e.json()}catch(t){throw d.logError(`Error generating upload link: ${t}. blob.type: ${e.type} blob.size: ${e.size} filename: ${i}`),t}}async function u(e){return new Promise(((t,i)=>{const s=new FileReader;s.onload=e=>{var s;const o=new Image;o.src=null===(s=e.target)||void 0===s?void 0:s.result,o.onload=()=>{t(!c(o))},o.onerror=i},s.onerror=i,s.readAsDataURL(e)}))}async function p(e){if(!await u(e))throw new Error(r.t(null,void 0,i(73007)));try{const t=await h(e),i=t.data.fields,s=new FormData;for(const e of Object.keys(i))s.append(e,i[e]);s.append("file",e);const r=await(0,o.fetch)(t.data.url,{method:"POST",body:s});if(r.ok)return t.data.url+t.filepath;throw new Error(`Upload response is not ok: ${r.status}`)}catch(e){throw new Error(`Error uploading image: ${e.message}`)}}},764921:(e,t,i)=>{"use strict";i.d(t,{LogicalRange:()=>o});var s=i(650151);class o{constructor(e,t){(0,s.assert)(e<=t,"The left value should be greater than or equal to the right value"),this._left=e,this._right=t}left(){return this._left}right(){return this._right}length(){return this._right-this._left+1}contains(e,t){return e<this._left-.5?!0===t&&1:e>this._right+.5?!0===t&&2:!0!==t||0}before(e){return e<this._left-.5}after(e){return e>this._right+.5}intersects(e){return!(this.after(e.left())||this.before(e.right()))}equals(e){return this._left===e.left()&&this._right===e.right()}static compare(e,t){return null===e||null===t?e===t:e.equals(t)}}},866321:(e,t,i)=>{"use strict";i.d(t,{MainSeriesScaleRatioProperty:()=>r});var s=i(942634),o=i(805578);class r{constructor(e){this._changed=new s.Delegate,this._model=e}destroy(){this._changed.destroy()}getStepChangeValue(){return.1}getMinValue(){return 1e-7}getMaxValue(){return 99999999}value(){return this._model.mainSeriesScaleRatio()}setValue(e,t){(e!==this.value()||t)&&(this._model.setMainSeriesScaleRatio(e),this._onChanged())}state(){return null}clone(){return new r(this._model)}listeners(){return this._changed}subscribe(e,t){this._changed.subscribe(e,t)}unsubscribe(e,t){this._changed.unsubscribe(e,t)}unsubscribeAll(e){this._changed.unsubscribeAll(e)}storeStateIfUndefined(){return!0}weakReference(){return(0,o.weakReference)(this)}ownership(){return(0,o.ownership)(this)}_onChanged(){this._changed.fire(this,"")}}},809137:(e,t,i)=>{"use strict";i.d(t,{RectangleRenderer:()=>u});var s=i(650151),o=i(86441),r=i(934026),n=i(204652),a=i(432059),l=i(666574),c=i(509078),d=i(665798),h=i(961970);class u extends h.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=null,this._forceOverrideTransparency=Boolean(e)}setData(e){this._data=e}hitTest(e,t){if(null===this._data||this._data.points.length<2||this._data.nohittest)return null
;const i=t.mediaSize.width,s=(0,o.box)(...this._data.points),r=s.min,a=s.max,l=new o.Point(a.x,r.y),d=new o.Point(r.x,a.y),h=this._extendAndHitTestLineSegment(e,r,l,i);if(null!==h)return h;const u=this._extendAndHitTestLineSegment(e,d,a,i);if(null!==u)return u;let p=(0,n.distanceToSegment)(l,a,e);if(p.distance<=3)return new c.HitTestResult(c.HitTarget.MovePoint);if(p=(0,n.distanceToSegment)(r,d,e),p.distance<=3)return new c.HitTestResult(c.HitTarget.MovePoint);if(this._data.middleLine){const t=s.min.add(s.max).scaled(.5),r=this._extendAndHitTestLineSegment(e,new o.Point(s.min.x,t.y),new o.Point(s.max.x,t.y),i);if(null!==r)return r}return this._data.fillBackground?this._hitTestBackground(e,r,a,i):null}getColor(){const e=(0,s.ensure)(this._data);return void 0===e.transparency?e.backcolor:(0,a.generateColor)(e.backcolor,e.transparency,this._forceOverrideTransparency)}_drawImpl(e){if(null===this._data||this._data.points.length<2||this._data.linewidth<=0&&!this._data.fillBackground)return;const{horizontalPixelRatio:t,verticalPixelRatio:i,bitmapSize:s}=e,{extendLeft:r,extendRight:n,linewidth:a,middleLine:c}=this._data,h=(0,o.box)(...this._data.points),u=this._data.linewidth?Math.max(1,Math.floor(this._data.linewidth*t)):0,p=this._data.fillBackground?this.getColor():void 0,_=Math.max(1,Math.floor(t)),m=r?-a:Math.round(h.min.x*t),g=n?s.width+a:Math.round(h.max.x*t),S=Math.round(h.min.y*i),v=Math.round(h.max.y*i);(0,d.fillRectWithBorder)(e,m,S,g,v,_,void 0===p?void 0:{color:p},0===u?void 0:{color:this._data.color,lineStyle:l.LINESTYLE_SOLID,borderWidth:u,borderMode:"center"},c?{...c,lineWidth:Math.max(1,Math.floor(c.lineWidth*i))}:void 0)}_extendAndHitTestLineSegment(e,t,i,s){const o=this._extendAndClipLineSegment(t,i,s);if(null!==o){if((0,n.distanceToSegment)(o[0],o[1],e).distance<=3)return new c.HitTestResult(c.HitTarget.MovePoint)}return null}_extendAndClipLineSegment(e,t,i){const r=(0,s.ensureNotNull)(this._data);if((0,o.equalPoints)(e,t)&&!r.extendLeft&&!r.extendRight)return null;const n=Math.min(e.x,t.x),a=Math.max(e.x,t.x),l=r.extendLeft?0:Math.max(n,0),c=r.extendRight?i:Math.min(a,i);return l>c||c<=0||l>=i?null:[new o.Point(l,e.y),new o.Point(c,t.y)]}_hitTestBackground(e,t,i,s){var n,a;const l=this._extendAndClipLineSegment(t,i,s);return null!==l&&(0,r.pointInBox)(e,(0,o.box)(l[0],l[1]))?new c.HitTestResult(null!==(a=null===(n=this._data)||void 0===n?void 0:n.backgroundHitTarget)&&void 0!==a?a:c.HitTarget.MovePointBackground):null}}},954384:(e,t,i)=>{"use strict";i.d(t,{PrePostMarket:()=>v,defaultPrePostMarketPreferences:()=>S});var s=i(960095),o=i(666574),r=i(95370),n=i(129968),a=i(336928);class l extends a.PriceLineAxisView{constructor(e,t){super(),this._model=e,this._source=t}_value(){const e=this._model.mainSeries(),t=e.priceScale(),i=e.firstValue();if(null===i)return{noData:!0};const s=this._source.price(),o=this._source.currentSession();if(null===s||"pre_market"!==o&&"post_market"!==o)return{noData:!0};const r=t.priceToCoordinate(s,i);return{noData:!1,floatCoordinate:r,coordinate:r,color:"",
formattedPricePercentage:"",formattedPriceAbsolute:"",formattedPriceIndexedTo100:"",text:"",index:0}}_priceLineColor(e){const t=this._source.properties().childs();return"pre_market"===this._source.currentSession()?t.preMarketColor.value():t.postMarketColor.value()}_lineWidth(){return this._source.properties().childs().lineWidth.value()}_lineStyle(){return this._source.properties().childs().lineStyle.value()}_isVisible(){if(!this._source.canBeVisibleOnSymbolAndInterval()||!this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value())return!1;const e=this._source.price(),t=this._source.currentSession();return null!==e&&("pre_market"===t||"post_market"===t)}}var c=i(444372),d=i(347808),h=i(432059);class u extends d.PriceAxisView{constructor(e,t){super(),this._model=e,this._source=t}_updateRendererData(e,t,s){if(e.visible=!1,t.visible=!1,!this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value())return;const o=this._model.mainSeries(),r=o.priceScale(),n=o.firstValue();if(null===n)return;if(!this._source.canBeVisibleOnSymbolAndInterval())return;const a=this._source.price(),l=this._source.currentSession();if(null==a||"pre_market"!==l&&"post_market"!==l)return;const d=this._source.properties().childs(),u="pre_market"===l?(0,h.resetTransparency)(d.preMarketColor.value()):(0,h.resetTransparency)(d.postMarketColor.value());e.visible=!0,t.visible=!0,e.text=r.formatPriceAbsolute(a),t.text="pre_market"===l?c.t(null,{context:"market_status"},i(293866)):c.t(null,{context:"market_status"},i(35359)),s.coordinate=r.priceToCoordinate(a,n),s.background=u,s.textColor=this.generateTextColor(u)}}var p=i(345159),_=i(509078);class m extends p.HorizontalLinePaneView{constructor(e,t,i){super(),this._model=e,this._source=t;const s={doubleClickHandler:i,doubleTapHandler:i};this._lineRenderer.setHitTest(new _.HitTestResult(_.HitTarget.Regular,s))}_updateImpl(){const e=this._lineRendererData;e.visible=!1;const t=this._model.mainSeries(),i=this._source.properties().childs();if(!i.visible.value()||!t.isVisible())return;const s=t.priceScale(),o=t.firstValue();if(null===o)return;if(!this._source.canBeVisibleOnSymbolAndInterval())return;const r=this._source.price(),n=this._source.currentSession();null===r||"pre_market"!==n&&"post_market"!==n||(e.visible=!0,e.y=s.priceToCoordinate(r,o),e.linestyle=i.lineStyle.value(),e.linewidth=i.lineWidth.value(),e.color="pre_market"===n?i.preMarketColor.value():i.postMarketColor.value())}}var g=i(169532);const S={visible:!0,lineStyle:o.LINESTYLE_DOTTED,lineWidth:1,preMarketColor:"#fb8c00",postMarketColor:s.colorsPalette["color-tv-blue-500"]};class v extends n.CustomSourceBase{constructor(e,t,i){super(e,t),this._extraHoursPrice=null,this._currentSession="holiday",this._quotesProvider=t.mainSeries().quotesProvider(),this._prePostMarketLinePaneView=new m(t,this,i),this._prePostPriceAxisView=new u(t,this),this._prePostLabelPaneView=new r.PanePriceAxisView(this._prePostPriceAxisView,t.mainSeries(),t),this._prePostPriceLineAxisView=new l(t,this),
this._quotesProvider.quotesUpdate().subscribe(this,this._updateQuotes),this._updateQuotes()}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this)}paneViews(e){return this._areViewsAvailableForPane(e)?[this._prePostMarketLinePaneView]:[]}labelPaneViews(e){return this._areViewsAvailableForPane(e)?[this._prePostLabelPaneView]:[]}priceAxisViews(e,t){return this._areViewsAvailableForPane(e)?e.findTargetPriceAxisViews(this,t,[this._prePostPriceAxisView],[this._prePostPriceLineAxisView]):[]}priceScale(){return this._model.mainSeries().priceScale()}updateAllViews(e){this._prePostMarketLinePaneView.update(e),this._prePostPriceAxisView.update(e),this._prePostPriceLineAxisView.update(e),this._prePostLabelPaneView.update(e)}price(){return this._extraHoursPrice}currentSession(){return this._currentSession}canBeVisibleOnSymbolAndInterval(){return this._model.mainSeries().isPrePostMarketPricesAvailableProperty().value()}properties(){return this._model.mainSeries().properties().childs().prePostMarket}_updateQuotes(){const e=this._quotesProvider.quotes();null===e?this._extraHoursPrice=null:(this._extraHoursPrice=e.rtc,void 0!==e.current_session&&(this._currentSession=e.current_session));const t=this._model.mainSeries().properties().childs().prePostMarket.childs().visible.value(),i=this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value();this.canBeVisibleOnSymbolAndInterval()&&(t||i)&&(this.updateAllViews((0,g.sourceChangeEvent)(this.id())),this._model.updateSource(this))}_areViewsAvailableForPane(e){return!this._model.isSnapshot()&&this._model.paneForSource(this._model.mainSeries())===e}}},383557:(e,t,i)=>{"use strict";var s;i.d(t,{PublishedChartsFilter:()=>s}),function(e){e.None="all",e.Following="following",e.Private="private"}(s||(s={}))},622429:(e,t,i)=>{"use strict";i.d(t,{PublishedChartsTimeline:()=>R});var s=i(444372),o=i(62802),r=i.n(o),n=i(443874),a=i(501867),l=i(383557),c=i(338619),d=i(345848),h=i(638456),u=i(523863),p=i(702598),_=i(223124),m=i(868594),g=i(650151),S=i(960095),v=i(542682),f=i(934026),b=i(86441),y=i(509078),C=i(631088);function w(e,t){const{horizontalPixelRatio:i,verticalPixelRatio:s}=t,o=Math.max(1,Math.floor(i)),r=Math.round(e.x*i)+o%2/2;let n=Math.round(e.size*i);(r+n/2)%1!=0&&(n+=1);const a=Math.min(Math.max(1,Math.round(i*e.borderWidth)),n/2);let l;const c=("up"===e.direction?-1:1)*(e.yInverted?-1:1),d=c*(Math.round(e.size*s/2)+o%2);if(void 0!==e.fixedSpaceYPosition){const t=Math.round(e.fixedSpaceYPosition.itemSpacing*s),i=e.fixedSpaceYPosition.order,o=c*(n*i+t*(i+1));l=Math.round(e.fixedSpaceYPosition.basePosition*s)+o+d}else l=Math.round(e.y*s)+d;return{x:r,y:l,size:n,borderWidth:a,tickSize:o}}function T(e,t,i,s){var o;if(e.save(),i&&!s.highlightByAuthor&&(e.globalAlpha=.4),s.mine)!function(e,t,i){const{borderColor:s,backgroundColor:o,doNotFill:r,direction:n,yInverted:a}=i,{x:l,y:c,borderWidth:d,size:h,tickSize:u}=w(i,t);e.strokeStyle=s,e.fillStyle=o,e.lineWidth=d;const p="up"===n!==a?-1:1;let _=Math.round(h/2/Math.tan(Math.PI/6))+u%2/2
;(l+_/2)%1!=0&&(_-=1);e.translate(l,c+_/2*p),e.beginPath();const m=d/2;e.moveTo(0,-p*(_-m)),e.lineTo(h/2-m,d/2),e.lineTo(-h/2+m,d/2),e.lineTo(0,-p*(_-d/2)),e.closePath(),r||e.fill();e.stroke()}(e,t,s);else{0,function(e,t,i,s,o){const{borderColor:r,backgroundColor:n,label:a}=i,{x:l,y:c,borderWidth:d,size:h}=w(i,t);e.strokeStyle=r,e.fillStyle=n,e.lineWidth=d,e.beginPath();const u=h/2-d/2;e.arc(l,c,u,0,2*Math.PI,!0),e.closePath(),e.fill(),!1;e.stroke(),!s&&a&&h/2>=7&&(e.textAlign="center",e.textBaseline="middle",e.font=a.font,e.fillStyle=a.fontColor,(0,C.drawScaled)(e,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{e.fillText(a.text,l/t.horizontalPixelRatio,c/t.verticalPixelRatio)})))}(e,t,s,!1,null===(o=s.image)||void 0===o?void 0:o.imageElement)}e.restore()}class P{constructor(e,t,i,s){this._canvas=null,this._clickHandler=e,this._enterHandler=t,this._leaveHandler=i,this._data=null!=s?s:null}setData(e){this._data=e}hitTest(e,t){if(null===this._data)return null;for(let i=this._data.items.length-1;i>=0;--i){const s=this._hitTestDot(this._data.items[i],e,t);if(s)return s}return null}draw(e,t){this._canvas=e.canvas,null!==this._data&&this._data.items.forEach(T.bind(null,e,t,this._data.highlightByAuthor))}_hitTestDot(e,t,i){const s=new b.Point(e.x,w(e,i).y/i.verticalPixelRatio);if((0,f.pointInCircle)(t,s,Math.max(e.size/2,8))){const t=this._canvas,i=null===t?void 0:{mouseEnterHandler:()=>this._enterHandler(e,s.y,t),mouseLeaveHandler:()=>this._leaveHandler(),clickHandler:i=>this._clickHandler(e,s.y,t,i),tapHandler:i=>this._clickHandler(e,s.y,t,i)};return new y.HitTestResult(y.HitTarget.Regular,{activeItem:e.originalItem.id,...i})}return null}}var M=i(694852),x=i(511275),I=i(188035);const L={green:{border:(0,S.getHexColorByName)("color-minty-green-700"),background:(0,S.getHexColorByName)("color-minty-green-a600")},red:{border:(0,S.getHexColorByName)("color-ripe-red-700"),background:(0,S.getHexColorByName)("color-ripe-red-500")},neutral:{border:(0,S.getHexColorByName)("color-tan-orange-700"),background:(0,S.getHexColorByName)("color-tan-orange-500")},yellow:{border:"#EAC300",background:"#FFD400"},blue:{border:"#047ACE",background:"#0496FF"}};function A(e){var t,i,s,o;return e.hovered||e.highlightByAuthor?null!==(i=null===(t=e.overrideBorderWidth)||void 0===t?void 0:t.hoveredWidth)&&void 0!==i?i:4:null!==(o=null===(s=e.overrideBorderWidth)||void 0===s?void 0:s.width)&&void 0!==o?o:2}const k=(0,c.getLogger)("Chart.PublishedChartsTimeline");class E extends class{constructor(e,t){this._tooltip=null,this._hoveredBarsMarkData=null,this._destroyed=!1,this._invalidated=!0,this._originalData=[],this._source=e,this._model=t,this._renderer=new P(this._onItemClicked.bind(this),this._showItem.bind(this),this._hideItem.bind(this)),this._createTooltipRenderer().then((e=>{this._destroyed?null==e||e.destroy():this._tooltip=e})),e.properties().childs().visible.subscribe(null,(()=>{var e;null===(e=this._tooltip)||void 0===e||e.hide(!0)}))}destroy(){var e;this._destroyed=!0,null===(e=this._tooltip)||void 0===e||e.destroy()}source(){
return this._source}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}onClickOutside(e,t){t&&((0,I.isTouchMouseEvent)(t)?t.isTouch:(0,v.isTouchEvent)(t))&&null!==this._tooltip&&!this._tooltip.contains(t.target)&&this._tooltip.hide(!0)}_extractBarMarksRendererItemData(e,t){var i,s;const o=null!==(i=t.overridedTheme)&&void 0!==i?i:L[t.theme],r=this._calculateSize(e,t),n=this._calculateY(e,r,t);return null===this._hoveredBarsMarkData||this._hoveredBarsMarkData.id!==t.id||this._hoveredBarsMarkData.x===t.x&&this._hoveredBarsMarkData.y===Math.round(n)||(null===(s=this._tooltip)||void 0===s||s.hide(!0),this._hoveredBarsMarkData=null),{x:t.x,y:this._calculateY(e,r,t),direction:t.direction,borderColor:o.border,borderWidth:A(t),backgroundColor:o.background,size:r,doNotFill:!t.public,yInverted:t.yInverted,label:void 0===t.label?void 0:{text:t.label,fontColor:t.labelFontColor,font:(0,M.makeFont)(Math.ceil(Math.max(10,Math.min(r/2,20))),x.CHART_FONT_FAMILY,"bold")},originalItem:t}}_onItemClicked(e,t,i,s){s.isTouch&&this._showItem(e,t,i)}async _showItem(e,t,i){var s;const o=await this._tooltipProps(e);if(null===o)return;const r=this._model.timeScale().barSpacing(),n=this._calculateSize(r,e.originalItem);this._hoveredBarsMarkData={x:e.x,y:Math.round(this._calculateY(r,n,e.originalItem)),id:e.originalItem.id},null===(s=this._tooltip)||void 0===s||s.show({itemSize:n,container:(0,g.ensureNotNull)(i.parentElement),x:e.x,y:t,factoryProps:o,onClickOutside:()=>{var e;return null===(e=this._tooltip)||void 0===e?void 0:e.hide(!0)}})}_hideItem(){var e;null===(e=this._tooltip)||void 0===e||e.hide()}_calculateSize(e,t){return Math.min(553,Math.max(7,t.minSize,.8*e))}_updateImpl(){this._originalData=this._source.getPlatesViewData();const e=this._model.timeScale().barSpacing(),t=this._originalData.map(this._extractBarMarksRendererItemData.bind(this,e));this._renderer.setData({items:t,barSpacing:e,highlightByAuthor:!1})}}{constructor(){super(...arguments),this._profileDataCache=new Map}_extractBarMarksRendererItemData(e,t){const i=super._extractBarMarksRendererItemData(e,t);return{...i,fixedSpaceYPosition:{basePosition:t.y,order:t.order,itemSpacing:.2857142857142857*e},mine:t.mine,borderWidth:t.hovered?i.borderWidth:t.public?1:2,doNotFill:!t.public,direction:t.direction}}async _createTooltipRenderer(){const[{TooltipRenderer:e},{PublishedChartsTimelineTooltip:t}]=await Promise.all([Promise.all([i.e(22164),i.e(87393),i.e(58685),i.e(82321),i.e(70354)]).then(i.bind(i,410842)),Promise.all([i.e(22164),i.e(87393),i.e(58685),i.e(82321),i.e(70354)]).then(i.bind(i,319824))]);return new e(t)}_calculateY(e,t,i){const s=("up"===i.direction?-1:1)*(i.yInverted?-1:1),o=s*(t*i.order+.2857142857142857*t*(i.order+1));return i.y+t/2*s+o}_onItemClicked(e,t,i,s){super._onItemClicked(e,t,i,s),s.isTouch||this.source().showIdea(e.originalItem.id,!1)}async _tooltipProps(e){var t;const i=(0,g.ensureDefined)(e.originalItem.username);let s=this._profileDataCache.get(i);if(void 0===s){try{
s=await function(e){return fetch(`/api/v1/user/profile/${e}/?avatars_fallback=true&by=username`).then((e=>e.json()))}(i)}catch(e){return k.logWarn(`An error ocurred while loading profile data: ${e}`),null}this._profileDataCache.set(i,s)}return Promise.resolve({avatarUrl:null===(t=s.avatars)||void 0===t?void 0:t.mid,badges:s.badges,title:(0,g.ensureDefined)(e.originalItem.title),username:i,onTitleClicked:()=>this.source().showIdea(e.originalItem.id,!1)})}}var D=i(343272),B=i(314802);const N=(0,c.getLogger)("Chart.PublishedChartsTimeLine");class R extends n.BarsMarksContainer{constructor(e,t){let i=r().getValue("PublishedChartsTimeline.filter",l.PublishedChartsFilter.None);window.is_authenticated||(i=l.PublishedChartsFilter.None);const s=new m.DefaultProperty({defaultName:"publishedchartstimeline",state:{filter:i}});super(e,s),this.setId("PublishedChartsTimeline"),this._paneView=new E(this,e),this._paneViews=[this._paneView],this._currentRange=null,this._properties.childs().visible.subscribe(this,(()=>{this._getData(this._currentRange)})),s.childs().filter.subscribe(this,(e=>{r().setValue("PublishedChartsTimeline.filter",e.value()),this.clearMarks(),this._getData(this._currentRange)})),this._containsData=e.isSnapshot(),this._containsData&&this._properties.childs().visible.setValue(!0),this.setUserEditEnabled(!1),this._onIdeaClickedHandler=t}destroy(){this._onIdeaClickedHandler=null,this._boundOnMessage&&(a.pushStreamMultiplexer.off("ideas",this._boundOnMessage),a.pushStreamMultiplexer.off("ideas.post",this._boundOnMessage),this._boundOnMessage=null),this._paneView.destroy(),super.destroy()}name(){return"Ideas on chart"}title(){return s.t(null,void 0,i(958757))}zorder(){return D.sortSourcesPreOrdered.BarMarks}paneViews(){return this._model.isInReplay().value()||!this._properties.childs().visible.value()?[]:this._paneViews}showIdea(e,t){var i;const s=this._marks[e];s?((0,d.trackEvent)("GUI","View published idea"),t&&(0,d.trackEvent)("GUI","Ideas navigation arrow"),(0,h.onWidget)()||this._containsData||(0,B.isOnMobileAppPage)("any")?window.open(`${this._getBaseUrl()}${s.published_chart_url||"/v/"+s.image_url+"/"}`):s.image_url&&(null===(i=this._onIdeaClickedHandler)||void 0===i||i.call(this,{uid:s.image_url,url:s.published_chart_url}))):N.logDebug("PublishedChartsTimeline.showIdea: unexpected published chart id")}state(e){const t={type:"BarsMarksContainer",id:this.id(),zorder:this.zorder(),pinnedTooltips:this._pinnedTooltips};return e&&this._properties.childs().visible.value()&&(t.marks=this.getPublishedPlates()),t}restoreData(e,t){null!=e.pinnedTooltips&&(this._pinnedTooltips=e.pinnedTooltips),t&&void 0!==e.marks&&(this._marks=e.marks)}onClickOutside(e,t){this._paneView.onClickOutside(e,t)}_getIndex(e){return this.timeScale().timePointToIndex(e,1)}_initialize(){a.pushStreamMultiplexer&&(this._boundOnMessage=this._onMessage.bind(this),a.pushStreamMultiplexer.on("ideas",this._boundOnMessage),a.pushStreamMultiplexer.on("ideas.post",this._boundOnMessage))}_plateViewData(e){return{title:e.title,user_id:e.user__id,
username:e.username,suggested:e.is_hot,mine:e.user__id===window.user.id,public:e.is_public}}_getData(e,t){const i=this._model.mainSeries().properties().childs(),s=this._model.mainSeries().symbolInfo();if(this._currentRange=e,!s||!this._properties.childs().visible.value()&&!t)return Promise.resolve([]);let o=s.base_name.length>1?s.base_name:[s.pro_name];const r=this.roundRange(this._rangeDifference(e));o=(0,u.uniq)(o),o=o.sort();const n=new FormData;n.append("interval",i.interval.value()),n.append("legs",JSON.stringify(o)),n.append("startTickmark",r.start.toString()),n.append("endTickmark",r.end.toString()),n.append("filter",this.properties().childs().filter.value());const a=(0,_.makeCancelable)(new Promise(((e,t)=>{(0,p.fetch)("/charttimeline/",{method:"POST",body:n,headers:new Headers({acccept:"application/json","X-Requested-With":"XMLHttpRequest"})}).then((i=>{i.ok?i.json().then(e):t()})).catch(t)})));return a.promise.then((t=>{t.forEach((e=>{this._marks[e.id]=e})),this._loadedRange=this._rangeUnion(e,this._loadedRange);const i=this._requests.indexOf(a);~i&&this._requests.splice(i,1),this.updateAllViewsAndRepaint()})),this._requests.push(a),a.promise}_onMessage(e,t,i,s){if(this._containsData)return;const o=this._model.mainSeries(),r=o.symbolInfo(),n=r&&r.base_name;if(!n)return;const a=o.properties().childs();e.interval===a.interval.value()&&~n.indexOf(e.pro_symbol)&&(this._marks[e.id]=e,this.updateAllViewsAndRepaint())}_getBaseUrl(){if((0,h.onWidget)()&&window.locale_domains){const e=window.locale||"en",t=window.locale_domains[e]?window.locale_domains[e]:window.locale_domains.en;return t?document.location.protocol+"//"+t:""}return""}}},907256:(e,t,i)=>{"use strict";i.d(t,{replayModeProperty:()=>l});var s=i(62802),o=i(638456),r=i(998418);const n="replay_mode";function a(){return o.CheckMobile.any()?"ActiveChart":s.getValue(n,"ActiveChart")}const l=(0,r.createPrimitiveProperty)(a());s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())))},128011:(e,t,i)=>{"use strict";i.d(t,{allPriceScaleSelectionStrategyInfo:()=>c,createPriceScaleSelectionStrategy:()=>l});var s=i(650151),o=i(444372),r=i(434396);class n{constructor(e){this._priceScalesLimit=8,this._metaInfo=e}metaInfo(){return this._metaInfo}findSuitableScale(e,t,i,s){if(void 0!==s)return this._tryToGetDesiredPriceScale(e,t,s,i);if((0,r.isStudy)(t)){const s=t.metaInfo();if("Volume"===s.shortId&&e.containsMainSeries())return e.createPriceScaleAtPosition("overlay");const o=t.desiredPriceScalePosition();if(null!==o)return this._tryToGetDesiredPriceScale(e,t,o,i);if(void 0!==i&&((0,r.isStudy)(i)||e.isMainPane())&&s.is_price_study)return this._getPriceScaleTheSameAsForSource(i,e)}let o=!1;if((0,r.isStudy)(t)){const i=t.metaInfo().groupingKey;if(void 0!==i){const t=e.model().findNonOverlayStudyWithGroupingKey(i,e);if(null!==t)return this._getPriceScaleTheSameAsForSource(t.study,t.pane)}o=Boolean(t.metaInfo().is_price_study)}else t===e.model().mainSeries()&&(o=!0);if(o){const t=this._findFirstScaleForPriceStudy(e);if(null!==t)return t}
return this.createNewPriceScaleIfPossible(e)}canCreateNewPriceScale(e){return e.leftPriceScales().length+e.rightPriceScales().length<this._priceScalesLimit}_getPriceScaleTheSameAsForSource(e,t){return t.isOverlay(e)?t.createPriceScaleAtPosition("overlay"):(0,s.ensureNotNull)(e.priceScale())}_priceScaleIsPrice(e,t){const i=e.mainSource();return!!i&&(i===t.mainSeries()||!!(0,r.isStudy)(i)&&Boolean(i.metaInfo().is_price_study))}_findFirstScaleForPriceStudy(e){const t=e.model();for(let i=0;i<this._priceScalesLimit;i++){if(e.rightPriceScales().length>i&&this._priceScaleIsPrice(e.rightPriceScales()[i],t))return e.rightPriceScales()[i];if(e.leftPriceScales().length>i&&this._priceScaleIsPrice(e.leftPriceScales()[i],t))return e.leftPriceScales()[i]}return null}_targetPriceScaleIndex(e,t){if(e.mainSource()===t.mainSeries())return 0}_tryToGetDesiredPriceScale(e,t,i,o){switch(i){case"left":return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("left"):e.createPriceScaleAtPosition("overlay");case"right":return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("right"):e.createPriceScaleAtPosition("overlay");case"as-series":return void 0!==o?(0,s.ensureNotNull)(o.priceScale()):e.isMainPane()?(0,s.ensureNotNull)((0,s.ensureNotNull)(e.mainDataSource()).priceScale()):this.createNewPriceScaleIfPossible(e);case"overlay":return e.createPriceScaleAtPosition("overlay")}}}const a=[{name:"left",title:o.t(null,void 0,i(561507)),ctor:class extends n{constructor(e){super(e)}apply(e){const t=e.model();e.rightPriceScales().slice(0).forEach((i=>e.movePriceScale(i,"left",this._targetPriceScaleIndex(i,t))))}createNewPriceScaleIfPossible(e){return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("left"):e.createPriceScaleAtPosition("overlay")}}},{name:"right",title:o.t(null,void 0,i(597800)),ctor:class extends n{constructor(e){super(e)}apply(e){const t=e.model();e.leftPriceScales().slice(0).forEach((i=>e.movePriceScale(i,"right",this._targetPriceScaleIndex(i,t))))}createNewPriceScaleIfPossible(e){return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("right"):e.createPriceScaleAtPosition("overlay")}}},{name:"auto",title:o.t(null,void 0,i(221469)),ctor:class extends n{constructor(e){super(e)}apply(e){if(e.containsMainSeries()){const t=(0,s.ensureNotNull)((0,s.ensureNotNull)(e.mainDataSource()).priceScale());e.movePriceScale(t,"right",0)}const t=e.model();for(;e.leftPriceScales().length>e.rightPriceScales().length;){const i=e.leftPriceScales()[e.leftPriceScales().length-1];e.movePriceScale(i,"right",this._targetPriceScaleIndex(i,t))}for(;e.rightPriceScales().length-e.leftPriceScales().length>1;){const i=e.rightPriceScales()[e.rightPriceScales().length-1];e.movePriceScale(i,"left",this._targetPriceScaleIndex(i,t))}}createNewPriceScaleIfPossible(e){if(!this.canCreateNewPriceScale(e))return e.createPriceScaleAtPosition("overlay");const t=e.leftPriceScales().length<e.rightPriceScales().length?"left":"right";return e.createPriceScaleAtPosition(t)}}}];function l(e){const t=(0,
s.ensureDefined)(a.find((t=>t.name===e)));return new t.ctor(t)}function c(){return a}},373313:(e,t,i)=>{"use strict";i.d(t,{restoreShowNewsNotificationSettingsValue:()=>l,showNewsNotificationsProperty:()=>a});var s=i(62802),o=i(998418);const r="show_news_upd_notif";function n(){return s.getBool(r,!1)}const a=(0,o.createPrimitiveProperty)(n());function l(){a.setValue(!1),s.remove(r)}a.subscribe(null,(()=>s.setValue(r,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},375308:(e,t,i)=>{"use strict";i.d(t,{sourcesAffectState:()=>r});var s=i(465836),o=i(469805);function r(e){return!o.lineToolsDoNotAffectChartInvalidation||e.some((e=>!(0,s.isLineTool)(e)))}},438036:(e,t,i)=>{"use strict";var s;i.d(t,{InsertionErrorCode:()=>s}),function(e){e.StudyCannotBeChild="cannot_be_child",e.StubWasRemoved="stub_was_removed",e.CannotGetMetainfo="cannot_get_metainfo",e.CannotCompilePub="cannot_compile_pub",e.Cancelled="cancelled",e.Unknown="unknown"}(s||(s={}))},540975:(e,t,i)=>{"use strict";i.d(t,{getReplayStrategyMetaInfo:()=>r});var s=i(625611),o=i(850723);function r(){return(0,o.studyMetaInfoRepository)().findById({type:"java",studyId:s.replayStrategyStudyId})}},252767:(e,t,i)=>{"use strict";i.d(t,{StudyColorRotatorFactory:()=>h});var s=i(960095),o=i(724377),r=i(432059),n=i(434396);const a=["color-sky-blue-400","color-banana-yellow-700","color-deep-blue-500","color-grapes-purple-a700","color-iguana-green-500","color-minty-green-a600","color-ripe-red-a200","color-berry-pink-200","color-tv-blue-a100","color-tan-orange-a200","color-sky-blue-a400","color-deep-blue-a100","color-grapes-purple-400","color-iguana-green-a700","color-minty-green-200","color-ripe-red-200","color-berry-pink-a200","color-ripe-red-500","color-grapes-purple-500","color-deep-blue-400","color-tv-blue-a200","color-sky-blue-500","color-iguana-green-400","color-minty-green-400","color-banana-yellow-600","color-tan-orange-500","color-berry-pink-400","color-ripe-red-300","color-grapes-purple-300","color-deep-blue-300","color-tv-blue-300","color-sky-blue-300","color-iguana-green-300","color-minty-green-300","color-banana-yellow-400","color-tan-orange-300","color-berry-pink-300","color-tan-orange-a700"],l=["color-berry-pink-a700","color-grapes-purple-a700","color-deep-blue-a400","color-iguana-green-a700","color-ripe-red-a400","color-minty-green-a400","color-berry-pink-a200","color-tv-blue-a100","color-tan-orange-a200","color-sky-blue-a400","color-deep-blue-a200","color-grapes-purple-a100","color-iguana-green-a400","color-ripe-red-a100"];class c{constructor(e,t=a,i=!1){this._offset=0,this._offset=e,this._colors=t,this._ignoreBaseColor=i}getColor(e){if(0===this._offset&&!this._ignoreBaseColor)return e;const t=this._colors[(this._offset-(this._ignoreBaseColor?0:1))%this._colors.length],i=s.colorsPalette[t],n=(0,r.isHexColor)(e)?1:(0,o.parseRgba)(e)[3];return(0,r.generateColor)(i,(0,r.alphaToTransparency)(n))}}class d{constructor(e,t){this._offset=e,this._modelStartOffset=t}getColor(e){if((0,r.isHexColor)(e)){const t=(0,o.parseRgb)(e);return(0,o.rgbToHexString)((0,
o.shiftRgb)(t,this._offset,this._modelStartOffset))}{const t=(0,o.parseRgba)(e);return(0,o.rgbaToString)((0,o.shiftRgba)(t,this._offset,this._modelStartOffset))}}}class h{constructor(e){this._chartModel=e}getColorRotator(e){const t=(0,n.studyColorRotationMode)(e);if(null===t)return null;const i=this._calcDefaultColorsOffset(e);switch(t){case"sexyColors":return new c(i,l,!0);case"loop":return new c(i);case"shift":{const e=this._chartModel.getStudyShiftColorStartOffset();return new d(i,e)}}}_calcDefaultColorsOffset(e){let t=0;const i=(0,n.useSameColorRotationComparator)(e);return this._chartModel.dataSources().filter(n.isStudy).forEach((s=>{i(e,s.metaInfo())&&t++})),t}}},348065:(e,t,i)=>{"use strict";i.d(t,{StudyInserter:()=>p});var s=i(827147),o=i(637761),r=i(124829),n=i(850723),a=i(211183),l=i(438036),c=i(338619),d=i(757402);const h=(0,c.getLogger)("Chart.Studies.StudyInserter"),u=/^PUB;.*/;class p{constructor(e,t){this._parentSources=[],this._propsState=void 0,this._preferredPriceScale=void 0,this._allowChangeCurrency=!1,this._allowChangeUnit=!1,this._paneSize=void 0,this._forceOverlay=!1,this._inserterImpl=t,this._studyDescriptor=e}setParentSources(e){this._parentSources=e}setPaneSize(e){this._paneSize=e}setPreferredPriceScale(e){this._preferredPriceScale=e}setAllowChangeCurrency(e){this._allowChangeCurrency=e}setAllowChangeUnit(e){this._allowChangeUnit=e}setForceOverlay(e){this._forceOverlay=e}setPropertiesState(e){this._propsState=e}setTargetPriceScaleMode(e){this._targetPriceScaleMode=e}async insert(e,t,i){var c,p;let _=null;var m;i||(_=void 0!==(m=this._inserterImpl).createStub&&void 0!==m.removeStub?this._inserterImpl.createStub():null);const g=e=>{if(i){const t=(0,s.default)(e)?{error:e}:{error:e.message,editorError:e};i.setStatus({type:d.StudyStatusType.Error,errorDescription:t}),this._inserterImpl.storeFailedStub(i)}};let S,v=!0;try{S=await(0,n.studyMetaInfoRepository)().findById(this._studyDescriptor)}catch(e){h.logWarn(`Cannot get study ${JSON.stringify(this._studyDescriptor)}`);const t=this._studyDescriptor.pineId,i=u.test(t),s=!!(null===(c=null==e?void 0:e.errors)||void 0===c?void 0:c.length);return g(s?{id:t,...e.errors[0]}:"Error: cannot compile script"),i&&s?Promise.reject(l.InsertionErrorCode.CannotCompilePub):Promise.reject(l.InsertionErrorCode.CannotGetMetainfo)}finally{null!==_&&(v=this._inserterImpl.removeStub(_))}if(!v)return Promise.reject(l.InsertionErrorCode.StubWasRemoved);if(void 0!==t&&t.cancelled)return Promise.reject(l.InsertionErrorCode.Cancelled);if(!this._canApplyStudyToParent(S))return g("Error: cannot be child"),Promise.reject(l.InsertionErrorCode.StudyCannotBeChild);const f={...S.defaults.inputs};let b={};if(void 0!==e){const t=o.StudyMetaInfo.getStudyPropertyRootName(S),i=(0,r.clone)((0,a.defaults)(t));(0,r.merge)(f,i.inputs);const s=await e(f,S.inputs,S);b=s.inputs,this._parentSources=null!==(p=s.parentSources)&&void 0!==p?p:[]}if(void 0!==t&&t.cancelled)return Promise.reject(l.InsertionErrorCode.Cancelled);const y=this._insertStudy(S,b,i)
;return null===y?(g("Error: unknown error"),Promise.reject(l.InsertionErrorCode.Unknown)):(await y.startPromise,y.study)}_insertStudy(e,t,i){return this._inserterImpl.createStudy(e,t,null,i,this._propsState,this._forceOverlay,this._parentSources,this._preferredPriceScale,this._allowChangeCurrency,this._allowChangeUnit,this._paneSize,this._targetPriceScaleMode)}_canApplyStudyToParent(e){return 0===this._parentSources.length||o.StudyMetaInfo.canBeChild(e)}}},283323:(e,t,i)=>{"use strict";i.d(t,{StudyLineToolStub:()=>n,isStudyLineToolStub:()=>r});var s=i(375397),o=i(872842);function r(e){return e instanceof n}class n extends o.StudyStub{constructor(e,t,i){var o;super(e,{...t,ownFirstValue:null},i),this._linkKey=new s.WatchedValue(null!==(o=t.linkKey)&&void 0!==o?o:null)}linkKey(){return this._linkKey}}},944843:(e,t,i)=>{"use strict";var s=i(942634).Delegate;function o(){this._marksByIndex=new Map,this._marksBySpan=[],this.changed=new s,this.minIndex=void 0,this.maxIndex=void 0}o.prototype.reset=function(){this._resetImpl(),this.changed.fire()},o.prototype._resetImpl=function(){this._marksByIndex=new Map,this._marksBySpan=[],this.minIndex=void 0,this.maxIndex=void 0,this._cache=void 0},o.prototype.merge=function(e){if(0!==e.length){var t=e[0].index,i=e[e.length-1].index;t<=this.minIndex&&i>=this.maxIndex&&this._resetImpl();for(var s=this._marksBySpan,o=new Set,r=0;r<e.length;r++){var n=(c=e[r]).index,a=c.span,l=this._marksByIndex.get(c.index);if(l){if(l.index===c.index&&l.span===c.span){l.time=c.time;continue}this._removeTickmark(l)}}for(r=0;r<e.length;r++){var c;n=(c=e[r]).index,a=c.span;if(!this._marksByIndex.has(c.index)){this._marksByIndex.set(n,c);var d=s[a];void 0===d&&(d=[],s[a]=d);var h=0===d.length||d[d.length-1].index<c.index;s[a].push(c),h||o.add(a)}}this.minIndex=void 0===this.minIndex?t:Math.min(this.minIndex,t),this.maxIndex=void 0===this.maxIndex?i:Math.max(this.maxIndex,i);for(a=s.length;a--;)s[a]&&(s[a].length||delete s[a],o.has(a)&&s[a].sort(this._sortByIndexAsc));this._cache=void 0,this.changed.fire()}},o.prototype._removeTickmark=function(e){var t=e.index;if(this._marksByIndex.get(t)===e){this._marksByIndex.delete(t),t<=this.minIndex&&this.minIndex++,t>=this.maxIndex&&this.maxIndex--,this.maxIndex<this.minIndex&&(this.minIndex=void 0,this.maxIndex=void 0);var i=this._marksBySpan[e.span],s=i.indexOf(e);-1!==s&&i.splice(s,1)}},o.prototype._sortByIndexAsc=function(e,t){return e.index-t.index},o.prototype.removeTail=function(e){var t=new Map;this.maxIndex=this.minIndex,this._marksByIndex.forEach(function(i,s){i.time<e&&(t.set(s,i),this.maxIndex=Math.max(this.maxIndex,s))}.bind(this)),this._marksByIndex=t},o.prototype.addTail=function(e){for(var t=0;t<e.length;t++)e[t].index=this.maxIndex+t+1;this.merge(e)},o.prototype.indexToTime=function(e){var t=this._marksByIndex.get(e);return t?new Date(1e3*t.time):null},o.prototype.density=function(){var e=this.maxIndex-this.minIndex;if(0!==e)return 1e3*(this._marksByIndex.get(this.maxIndex).time-this._marksByIndex.get(this.minIndex).time)/e},
o.prototype.estimateLeft=function(e){var t=this.density();if(t)return(1e3*this._marksByIndex.get(this.minIndex).time-e)/t},o.prototype.nearestIndex=function(e){for(var t=this.minIndex,i=this.maxIndex;i-t>2;){if(1e3*this._marksByIndex.get(t).time===e)return t;if(1e3*this._marksByIndex.get(i).time===e)return i;var s=Math.round((t+i)/2);1e3*this._marksByIndex.get(s).time>e?i=s:t=s}return t},o.prototype.build=function(e,t){var i=Math.ceil(t/e);if(this._maxbar===i&&this._cache)return this._cache;this._maxbar=i;for(var s=[],o=this._marksBySpan.length;o--;)if(this._marksBySpan[o]){var r=s;s=[];for(var n=r.length,a=0,l=this._marksBySpan[o],c=l.length,d=1/0,h=-1/0,u=0;u<c;u++){for(var p=l[u],_=p.index;a<n;){var m=r[a],g=m.index;if(!(g<_)){d=g;break}a++,s.push(m),h=g,d=1/0}d-_>=i&&_-h>=i&&(s.push(p),h=_)}for(;a<n;a++)s.push(r[a])}return this._cache=s,this._cache},o.prototype.state=function(e){for(var t=[],i=this._marksBySpan.length;i--;)this._marksBySpan[i]&&(t=t.concat(this._marksBySpan[i]));if(null!==e){const i=e.firstBar(),s=e.lastBar();t=t.filter((e=>e.index>=i&&e.index<=s))}return{marks:t=t.map((function(e){return[e.span,e.time,e.index]})),version:2}},o.prototype.restoreState=function(e){if(this._marksByIndex=new Map,this._marksBySpan=[],this.maxIndex=void 0,this.minIndex=void 0,e&&e.marks&&e.marks.length)if(2===e.version){var t=e.marks.map((function(e){return{span:e[0],time:e[1],index:e[2]}}));this.merge(t)}else this.merge(e.marks)},e.exports.Tickmarks=o},220003:(e,t,i)=>{"use strict";i.d(t,{restoreTimeHoursFormatSettingsValue:()=>l,timeHoursFormatProperty:()=>a});var s=i(62802),o=i(998418);const r="time_hours_format";function n(){return s.getValue(r,"24-hours")}const a=(0,o.createPrimitiveProperty)(n());function l(){a.setValue("24-hours"),s.remove(r)}s.onSync.subscribe(null,(()=>a.setValue(n()))),a.subscribe(null,(()=>s.setValue(r,a.value())))},376036:(e,t,i)=>{"use strict";i.d(t,{forceTradingObjVisibilityOnScreenshot:()=>d,restoreShowOnScreenshotSettingsValue:()=>c,showOnScreenshotProperty:()=>l});var s=i(62802),o=i(375397),r=i(998418);const n="trading_drawings_on_screenshot";function a(){return s.getBool(n,!1)}const l=(0,r.createPrimitiveProperty)(a());function c(){l.setValue(!1),s.remove(n)}s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())));const d=new o.WatchedValue(null)},204425:(e,t,i)=>{"use strict";i.d(t,{ExcludeLineToolsFromGroupUndoCommand:()=>d});var s=i(650151),o=(i(466281),i(444372)),r=i(370407),n=i(124829),a=i(669763),l=i(469805);const c=new r.TranslatedString("exclude line tools from group {group}",o.t(null,void 0,i(99395)));class d extends a.UndoCommand{constructor(e,t,i){super(c.format({group:t.name().value()}),void 0,!l.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._groupName=t.name().value(),this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))).filter(n.notNull);e.excludeLineTools(t),
0===e.lineTools().length&&this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=this._model.lineToolsGroupModel().groupForId(this._groupId);null!==t?t.addLineTools(e):this._model.lineToolsGroupModel().createGroup(e,this._groupName,this._groupId)}}},414358:(e,t,i)=>{"use strict";i.d(t,{InsertStudyCommand:()=>h});var s=i(650151),o=i(247001),r=i(788387),n=i(778016),a=i(434396),l=i(487945),c=i(669763),d=i(345848);class h extends c.UndoCommand{constructor(e){const{chartModel:t,studyMetaInfo:i,inputs:s,props:o,addAsOverlay:r,parentSources:n,preferredPriceScale:a,allowChangeCurrency:l,allowChangeUnit:c,paneSize:d,targetZOrder:h,studyId:u,targetScaleMode:p,undoText:_}=e;super(null!=_?_:null),this._paneState=null,this._studyInserResult=null,this._additionalStudiesInsertResults=[],this._chartModel=t,this._studyMetaInfo=i,this._props=o,this._addAsOverlay=r,this._parentIds=n.map((e=>e.id())),this._inputs=s,this._targetZOrder=h,this._preferredPriceScale=a,this._allowChangeCurrency=l,this._allowChangeUnit=c,this._paneSize=d,this._studyId=null!=u?u:null,this._targetScaleMode=null!=p?p:null}redo(){var e,t;const i=this._parentIds.map((e=>this._chartModel.dataSourceForId(e)));this._studyInserResult=this._chartModel.insertStudyWithParams(this._studyMetaInfo,this._inputs,this._targetZOrder,this._props,this._addAsOverlay,i,this._preferredPriceScale,this._allowChangeCurrency,this._allowChangeUnit,this._paneSize,null!==(e=this._targetScaleMode)&&void 0!==e?e:void 0,null!==(t=this._studyId)&&void 0!==t?t:void 0),this._studyInserResult.study.then((e=>{if((0,l.isSymbolSource)(e)){null!==e.symbolInfo()?this._createCopiesOfExistingFundamentalsForNewStock(e):e.symbolResolved().subscribe(this,(()=>this._createCopiesOfExistingFundamentalsForNewStock(e)),!0)}else(0,a.isFundamentalStudy)(e)&&this._createCopiesOfNewFundamentalForAllStocks(e);if(this._studyId=e.id(),e.childStudyByRebind().subscribe(null,(()=>(0,d.trackEvent)("SOS","Apply SOS","Rebind SOS"))),(0,o.trackStudies)(e,"add"),this._chartModel.setShouldBeSavedEvenIfHidden(!0),null!==this._paneState){(0,s.ensureNotNull)(this._chartModel.paneForSource(e)).restoreState({state:this._paneState,withData:!1,version:this._chartModel.version()}),this._paneState=null}}))}undo(){var e,t;const i=(0,s.ensureNotNull)(this._studyInserResult),o=i.entityId();let r=null,n=null;if(null!==o){r=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(o));const t=i.originalScaleMode();null!==t&&(null===(e=r.priceScale())||void 0===e||e.setMode(t)),(0,l.isSymbolSource)(r)&&r.symbolResolved().unsubscribeAll(this),n=(0,s.ensureNotNull)(this._chartModel.paneForSource(r)).state()}else i.cancel();null===(t=this._studyInserResult)||void 0===t||t.cancel();for(const e of this._additionalStudiesInsertResults){const t=e.entityId();null!==t?this._chartModel.removeSource((0,s.ensureNotNull)(this._chartModel.dataSourceForId(t))):e.cancel()}this._additionalStudiesInsertResults=[],null!==r&&this._chartModel.removeSource(r)&&(this._paneState=n)}insertedStudy(){
return(0,s.ensureNotNull)(this._studyInserResult)}_createCopiesOfNewFundamentalForAllStocks(e){let t=(0,s.ensureNotNull)((0,n.getConfig)("FUNDAMENTALS_ON_CHART")).limit-this._chartModel.chartApi().getFundamentalCounter();e.isStarted()||(t-=1);const i=this._studyMetaInfo.symbolInputId(),o=this._chartModel.symbolSources();for(const n of o){if(t<=0)break;if(!n.isVisible()||n===e.symbolSource())continue;const o=n.symbolInfo();if(null!==o&&(0,r.isStockSymbol)(o.type,o.typespecs)){const e={};e[(0,s.ensureNotNull)(i)]=n.symbol();const o=this._chartModel.insertStudyWithParams(this._studyMetaInfo,e,null,this._props,!1);this._additionalStudiesInsertResults.push(o),t-=1}}}_createCopiesOfExistingFundamentalsForNewStock(e){let t=(0,s.ensureNotNull)((0,n.getConfig)("FUNDAMENTALS_ON_CHART")).limit-this._chartModel.chartApi().getFundamentalCounter();const i=e.symbolInfo();if(null!==i&&(0,r.isStockSymbol)(i.type,i.typespecs)){const i=new Set,o=this._chartModel.allStudies(!0).filter((e=>(0,a.isFundamentalStudy)(e)&&e.isVisible()));for(const r of o){if(t<=0)break;const o=r.metaInfo();if(!i.has(o.fullId)){const r={};r[(0,s.ensureNotNull)(o.symbolInputId())]=e.symbol();const n=this._chartModel.insertStudyWithParams(o,r,null,this._props,!1);this._additionalStudiesInsertResults.push(n),t-=1,i.add(o.fullId)}}}}}},121760:(e,t,i)=>{"use strict";i.d(t,{LineToolSynchronizeUndoCommand:()=>o});var s=i(669763);class o extends s.UndoCommand{constructor(e,t,i,s=!0){super(t,i,s),this._invalidateViaSync=!1,this._chartModel=e,this._invalidateViaSync=e.lineToolsSynchronizer().invalidateViaSync()}redo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSyncedAction((()=>this._redo())):this._redo()}undo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSyncedAction((()=>this._undo())):this._undo()}}},479935:(e,t,i)=>{"use strict";i.d(t,{MergeDownUndoCommand:()=>a,MergeToTargetPane:()=>l,MergeUpUndoCommand:()=>n});var s=i(650151),o=i(438266);class r extends o.MoveSourceUndoCommand{constructor(e,t,i,s){super(e,t,i),this._restorePane=!1,this._keepZOrder=null!=s&&s,this._initialZOrder=t.zorder()}redo(){const e=this._chartModel.panes().length,t=this._chartModel.panes()[this._targetPaneIndex()],i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),o=(0,s.ensureNotNull)(this._chartModel.paneForSource(i)),r=this._chartModel.children(i,!0);o.bulkActionMacro((()=>{r.forEach((e=>this._chartModel.detachSource(e))),this._restorePane=this._chartModel.detachSource(i)}));const n="overlay"===this._initialPriceScalePosition?this._initialPriceScalePosition:void 0,a=t.findSuitableScale(i,void 0,n),l=0===a.dataSources().length;if(t.bulkActionMacro((()=>{t.addDataSource(i,a,this._keepZOrder),r.forEach((e=>t.addDataSource(e,a,this._keepZOrder)))})),i===this._chartModel.mainSeries()){const e=t.priceScalePosition(a);t.movePriceScale(a,e,0)}if(l){const e=(0,s.ensureNotNull)(i.priceScale());e.restoreState(this._newPriceScaleState(t.isOverlay(i))),e.setHeight(t.height())}this._chartModel.fullUpdate(),
e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){let e;e=this._restorePane?this._chartModel.createPane(this._initialPaneIndex):this._chartModel.panes()[this._initialPaneIndex];const t=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),i=(0,s.ensureNotNull)(this._chartModel.paneForSource(t)),o=this._chartModel.children(t,!0);i.bulkActionMacro((()=>{o.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(t)}));let r=e.getPriceScaleById(this._initialPriceScaleId);null===r&&(r=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),e.bulkActionMacro((()=>{t.setZorder(this._initialZOrder),e.addDataSource(t,r,!0),o.forEach((t=>e.addDataSource(t,r,!1)))}));const n=(0,s.ensureNotNull)(t.priceScale());n.restoreState(this._originalPriceScaleState()),n.setHeight(e.height()),this._chartModel.fullUpdate()}}class n extends r{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){return this._initialPaneIndex-1}}class a extends r{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){return this._initialPaneIndex+1}}class l extends r{constructor(e,t,i,s,o){super(e,t,s,o),this._targetPane=i}_targetPaneIndex(){return this._targetPane}}},438266:(e,t,i)=>{"use strict";i.d(t,{MoveSourceUndoCommand:()=>r});var s=i(650151),o=i(669763);class r extends o.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._sourceId=t.id();const o=(0,s.ensureNotNull)(t.priceScale());this._initialPriceScaleId=o.id(),this._initialPriceScaleState=(0,s.ensureNotNull)(t.priceScale()).state();const r=(0,s.ensureNotNull)(e.paneForSource(t));this._initialPriceScalePosition=r.priceScalePosition(o),this._initialPriceScaleIndex=r.priceScaleIndex(o,this._initialPriceScalePosition),this._initialPaneIndex=e.panes().indexOf(r)}_newPriceScaleState(e){const t={...this._initialPriceScaleState};return delete t.m_isLockScale,delete t.id,delete t.m_topMargin,delete t.m_bottomMargin,delete t.hasCalculatedPriceRange,t}_originalPriceScaleState(){return this._initialPriceScaleState}}},995625:(e,t,i)=>{"use strict";i.d(t,{MoveToExistingPriceScaleUndoCommand:()=>a,MoveToNewPriceScaleUndoCommand:()=>n});var s=i(650151),o=i(438266);class r extends o.MoveSourceUndoCommand{constructor(e,t,i,s){super(e,t,s),this._sourcePaneRemoved=!1,this._targetPaneIndex=e.panes().indexOf(i)}redo(){const e=this._chartModel.panes()[this._initialPaneIndex],t=this._chartModel.panes()[this._targetPaneIndex],i=e!==t,o=this._targetPriceScale(t),r=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),n=this._chartModel.children(r,!0);for(const e of n)i?(this._chartModel.detachSource(e),t.addDataSource(e,o,!1)):t.move(e,o);i?(this._sourcePaneRemoved=this._chartModel.detachSource(r),t.addDataSource(r,o,!1)):t.move(r,o);const a=t.priceScalePosition(o);t.movePriceScale(o,a,this._targetPriceScaleIndex(r)),this._chartModel.fullUpdate()}undo(){this._sourcePaneRemoved&&this._chartModel.createPane(this._initialPaneIndex)
;const e=this._chartModel.panes()[this._initialPaneIndex],t=e!==this._chartModel.panes()[this._targetPaneIndex],i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId));let o=e.getPriceScaleById(this._initialPriceScaleId);null===o&&(o=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex));const r=this._chartModel.children(i,!0);for(const i of r)t?(this._chartModel.detachSource(i),e.addDataSource(i,o,!1)):e.move(i,o);t?(this._chartModel.detachSource(i),e.addDataSource(i,o,!1)):e.move(i,o);const n=(0,s.ensureNotNull)(i.priceScale());n.restoreState(this._originalPriceScaleState()),n.setHeight(e.height()),this._chartModel.fullUpdate()}}class n extends r{constructor(e,t,i,s,o){super(e,t,i,o),this._targetPriceScalePosition=s}_targetPriceScale(e){const t=e.createPriceScaleAtPosition(this._targetPriceScalePosition);return t.restoreState(this._newPriceScaleState("overlay"===this._targetPriceScalePosition)),t.setHeight(e.height()),t}_targetPriceScaleIndex(e){return e===this._chartModel.mainSeries()?0:void 0}}class a extends r{constructor(e,t,i,s,o){super(e,t,i,o),this._targetPriceScaleId=s.id()}_targetPriceScale(e){return(0,s.ensureNotNull)(e.getPriceScaleById(this._targetPriceScaleId))}_targetPriceScaleIndex(e){}}},661725:(e,t,i)=>{"use strict";i.d(t,{RemoveSourcesUndoCommand:()=>f});var s=i(650151),o=i(444372),r=i(370407),n=i(247001),a=i(121760),l=i(465836),c=i(338619),d=i(632911),h=i(434396),u=i(469805),p=i(204425);class _ extends a.LineToolSynchronizeUndoCommand{constructor({chartModel:e,title:t,lineDataSourceIds:i}){super(e,t,void 0,!u.lineToolsDoNotAffectChartInvalidation),this._excludeLineToolsFromGroupUndoCommands=[],this._undoState=[],this._lineDataSourceIds=i}_redo(){const e=this._lineDataSourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._groupLineToolsByGroups(e).forEach(((e,t)=>{const i=new p.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,t,e);i.redo(),this._excludeLineToolsFromGroupUndoCommands.push(i)})),e.forEach((e=>{this._undoState.push({state:e.state(!1),paneIndex:this._chartModel.panes().indexOf((0,s.ensureNotNull)(this._chartModel.paneForSource(e))),sharingMode:e.sharingMode().value()}),this._chartModel.removeSource(e)}))}_undo(){var e;for(let t=this._undoState.shift();t;t=this._undoState.shift())null===(e=this._chartModel.restoreSource(!1,t.paneIndex,null,t.state,null))||void 0===e||e.share(t.sharingMode);this._excludeLineToolsFromGroupUndoCommands.forEach((e=>e.undo()))}_groupLineToolsByGroups(e){const t=this._chartModel.lineToolsGroupModel();return e.reduce(((e,i)=>{const s=t.groupForLineTool(i);if(null!==s){const t=e.get(s)||[];t.push(i),e.set(s,t)}return e}),new Map)}}var m=i(850723),g=i(375308);const S=(0,c.getLogger)("Chart.RemoveSourcesUndoCommand"),v=new r.TranslatedString("remove line data sources",o.t(null,void 0,i(838199)));class f extends a.LineToolSynchronizeUndoCommand{constructor(e,t,i){super(e,i,void 0,(0,g.sourcesAffectState)(t)),this._removeLineDataSourcesUndoCommand=null,
this._initialPriceScaleMode=null;const[o,r]=(0,d.closeSourcesSet)(e,t).reduce(((e,t)=>((0,l.isLineTool)(t)?e[1].push(t.id()):e[0].push(t.id()),e)),[[],[]]);this._sourceIds=o,this._lineDataSourceIds=r,this._sourceStates=[],this._paneIndexes=[],this._priceScalePositionIds=[],this._paneStates=[],this._restorePanes=[];const n=t[0];1===t.length&&(0,h.isStudy)(n)&&(this._initialPriceScaleMode=(0,s.ensureNotNull)(n.priceScale()).mode())}removedIds(){return[...this._sourceIds,...this._lineDataSourceIds]}_redo(){const e=this._chartModel.panes().length,t=this._sourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._sourceStates=t.map((e=>{const t=e.state(!1);return null===t&&(0,h.isStudyStub)(e)?e.getDescriptor():t}));const i=t.map((e=>(0,s.ensureNotNull)(this._chartModel.paneForSource(e))));this._paneIndexes=i.map((e=>this._chartModel.panes().indexOf(e))),this._lineDataSourceIds.length>0&&(this._removeLineDataSourcesUndoCommand=new _({title:v,chartModel:this._chartModel,lineDataSourceIds:this._lineDataSourceIds}),this._removeLineDataSourcesUndoCommand.redo()),this._priceScalePositionIds=t.map(((e,t)=>{const s=e.priceScale();if(null===s)return null;const o=i[t].priceScalePosition(s);return{id:s.id(),position:o,priceScaleIndex:i[t].priceScaleIndex(s,o)}}));const o=new Set;t.forEach(((e,t)=>{o.add(this._paneIndexes[t])})),this._paneStates=t.map(((e,t)=>{const s=this._paneIndexes[t];return o.has(s)?i[t].state(!1,!0):null})),this._restorePanes=t.map((e=>this._chartModel.removeSource(e))),t.forEach((e=>{(0,h.isStudy)(e)&&(0,n.trackStudies)(e,"remove")})),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}_undo(){const e=[];for(let t=this._sourceStates.length-1;t>=0;t--){const i=this._sourceStates[t];if(null!==i){let s=null;s="descriptor"in i&&(0,m.isStudyDescriptor)(i.descriptor)?this._chartModel.restoreStudyStub(i):this._chartModel.restoreSource(this._restorePanes[t],this._paneIndexes[t],this._paneStates[t],i,this._priceScalePositionIds[t]),s&&e.push(s)}}e.some(((t,i)=>t.id()!==this._sourceIds[e.length-i-1]))&&S.logError("Source was restored improperly - source ids does not match"),null!==this._initialPriceScaleMode&&(0,s.ensureNotNull)(e[0].priceScale()).setMode(this._initialPriceScaleMode),this._removeLineDataSourcesUndoCommand&&this._removeLineDataSourcesUndoCommand.undo()}}},109117:(e,t,i)=>{"use strict";i.d(t,{SetWatchedValueCommand:()=>o});var s=i(669763);class o extends s.UndoCommand{constructor(e,t,i,s=!0){super(i,void 0,s),this._wv=e,this._newValue=t,this._oldValue=e.value()}redo(){this._wv.setValue(this._newValue)}undo(){this._wv.setValue(this._oldValue)}}},632911:(e,t,i)=>{"use strict";function s(e,t){let i=[];const o=e.children(t,!1);for(let t=0;t<o.length;t++)i=i.concat(s(e,o[t]));return i.push(t),i}function o(e,t){const i=new Set,o=t=>{e.children(t,!1).forEach((e=>{i.has(e)||(i.add(e),o(e))}))};return t.forEach(o),t.filter((e=>!i.has(e))).map((t=>s(e,t))).reduce(((e,t)=>e.concat(t)),[])}i.d(t,{closeSourcesSet:()=>o})},778660:(e,t,i)=>{"use strict";i.d(t,{
SwapChartsUndoCommand:()=>a});var s=i(444372),o=i(370407),r=i(669763);const n=new o.TranslatedString("swap charts in the Layout",s.t(null,void 0,i(919209)));class a extends r.UndoCommand{constructor(e,t,i){super(n),this._swapper=e,this._from=t,this._to=i}redo(){this._swapper(this._from,this._to)}undo(){this._swapper(this._from,this._to)}}},405338:(e,t,i)=>{"use strict";i.d(t,{createUndoHistory:()=>d});var s=i(650151),o=i(375727),r=i(571491),n=i(109117),a=i(338619),l=i(942634);const c=(0,a.getLogger)("Common.UndoHistory");function d(){const e=[],t=new o.UndoStack,i=new o.UndoStack,a=new l.Delegate;function d(s){if(e.length>0)e[e.length-1].addCommand(s);else{i.clear();const e=t.head(),o=e&&e.text().originalText();e&&e.canMerge(s)?e.merge(s):t.push(s);const r=s.text().originalText();""!==r&&r!==o&&c.logNormal("DO: "+r)}s.executeOnPush()&&s.redo(),e.length||a.fire(h())}function h(){const e=t.head(),s=i.head(),o=void 0===e?void 0:e.text(),r=void 0===s?void 0:s.text();return{enableUndo:!t.isEmpty(),undoCommandCount:t.size(),undoText:void 0!==o?o.translatedText():o,enableRedo:!i.isEmpty(),redoCommandCount:i.size(),redoText:void 0!==r?r.translatedText():r,originalUndoText:void 0!==o?o.originalText():void 0,originalRedoText:void 0!==r?r.originalText():void 0}}return{beginUndoMacro:function(t){const i=new r.UndoMacroCommand(t);return e.push(i),i},clearStack:function(){t.clear(),i.clear(),a.fire(h())},createUndoCheckpoint:function(){return{lastActualCommand:t.isEmpty()?null:t.head()}},endUndoMacro:function(){const t=(0,s.ensureDefined)(e.pop());t.isEmpty()||d(t)},pushUndoCommand:d,redo:function(){if(i.isEmpty())return!1;const e=i.pop();return!!e&&(e.redo(),t.push(e),c.logNormal("REDO: "+e.text().originalText()),a.fire(h()),!0)},redoStack:function(){return i},setWatchedValue:function(e,t,i,s){if(e.value()!==t){const o=new n.SetWatchedValueCommand(e,t,i,!s);d(o),o.redo()}},undo:function(){if(t.isEmpty())return!1;const e=t.pop();return!!e&&(e.undo(),i.push(e),c.logNormal("UNDO: "+e.text().originalText()),a.fire(h()),!0)},undoStack:function(){return t},undoToCheckpoint:function(e){for(;!t.isEmpty()&&e.lastActualCommand!==t.head();)t.pop().undo();i.clear(),a.fire(h())},state:h,onChange:function(){return a}}}},571491:(e,t,i)=>{"use strict";i.d(t,{UndoMacroCommand:()=>o});var s=i(669763);class o extends s.UndoCommand{constructor(e){super(e,!1),this._subcommands=[]}addCommand(e){this._subcommands.push(e)}isEmpty(){return 0===this._subcommands.length}redo(){for(let e=0;e<this._subcommands.length;e++)this._subcommands[e].redo()}undo(){for(let e=this._subcommands.length-1;e>=0;e--)this._subcommands[e].undo()}commands(){return this._subcommands}affectsState(){return this._subcommands.some((e=>e.affectsState()))}}},375727:(e,t,i)=>{"use strict";i.d(t,{UndoStack:()=>n});var s=i(669763),o=i(942634);const r=(0,i(338619).getLogger)("Common.UndoStack");class n{constructor(){this._commands=[],this._onChange=new o.Delegate}onChange(){return this._onChange}isEmpty(){return 0===this._commands.length}size(){return this._commands.length}clear(){
this.isEmpty()||(this._commands.length=0,this._onChange.fire())}push(e){if(!(e instanceof s.UndoCommand))throw new TypeError("argument must be an instance of UndoCommand");this._commands.push(e),this._onChange.fire(e)}pop(){if(this.isEmpty())return void r.logDebug("pop: undo stack is empty");const e=this._commands.pop();return this._onChange.fire(e),e}head(){if(!this.isEmpty())return this._commands[this._commands.length-1]}}},674720:(e,t,i)=>{"use strict";i.d(t,{sourceNewUnitOnPinningToPriceScale:()=>n,unitConvertibleGroups:()=>r});var s=i(487945),o=i(975179);function r(e,t,i){const s=(0,o.symbolUnitConvertibleGroupsIfExist)(e,!0);if(null!==s)return s;const r=i.unitGroupById(t);return null===r?[]:[r]}function n(e,t,i,o){let n=null;if(i.unitConversionEnabled()&&(0,s.isSymbolSource)(e)){const s=i.availableUnits(),a=t.unit(s),l=e.unit(),c=null===l?[]:r(e.symbolInfo(),l,s);null!==a&&null!==a.selectedUnit&&!a.allUnitsAreOriginal&&a.selectedUnit!==l&&(o&&null===l||null!==l&&s.convertible(l,c))&&(n=a.selectedUnit)}return n}},893556:(e,t,i)=>{"use strict";i.d(t,{restoreWithWeekdaySettingsValue:()=>l,withWeekdayProperty:()=>a});var s=i(62802),o=i(998418);const r="date_format_with_weekday";function n(){return s.getBool(r,!0)}const a=(0,o.createPrimitiveProperty)(n());function l(){a.setValue(!0),s.remove(r)}a.subscribe(null,(()=>s.setValue(r,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},691246:(e,t,i)=>{"use strict";i.d(t,{moveAfterSource:()=>k,moveBeforeSource:()=>E,newLineToolZOrder:()=>C,newStudyZOrder:()=>w,reorderDataSourcesStateZOrder:()=>f});var s=i(465836),o=i(434396),r=i(526910),n=i(198930),a=i(828473);function l(e){return(0,s.isLineTool)(e)&&!e.isSpeciallyZOrderedSource()}function c(e){return(0,o.isStudy)(e)&&!e.isSpeciallyZOrderedSource()||(0,o.isStudyStub)(e)}function d(e,t){return e.zorder-t.zorder}function h(e,t){(0,n.isMainSeriesState)(e)?e.zorder=0:e.zorder=t}function u(e,t){e.setZorder(t)}function p(e){return e.zorder()}function _(e){return Math.round(1e3*e)/1e3}function m(e,t){const i=Math.max(e,t),s=Math.min(e,t);return Math.max(0,Math.ceil(i)-Math.floor(s)-1)}function g(e,t,i){let s=0;const o=function(e,t){const i=1e3;return Math.abs(t*i-e*i)/i}(t,e);var r;return o>i?(e=Math.trunc(e),s=Math.floor(o/(i+1))):(r=o/(i+1),s=Math.floor(1e3*r)/1e3),{startZOrder:e,zOrderStep:s}}function S(e,t,i,s){let o=e.length,r=t;for(let t=e.length-1;t>=-1;t--)if(-1===t||s(e[t])){const s=t;let n=P(r);if(o-1===s)s>=0&&i(e[s],n);else{const t=m(o,s);let a=0;for(;0===a;){const e=g(r,n,t);r=e.startZOrder,a=e.zOrderStep,0===a&&(n-=1e4,0===n&&(n-=1e4))}let l=o-1;for(;l>s;){const t=_(r-a);i(e[l],t),r=t,l--}s>=0&&i(e[s],n)}r=n,o=s}}function v(e,t,i,s){let o=-1,r=t;for(let t=0;t<=e.length;t++)if(t===e.length||s(e[t])){const s=t;let n=T(r);if(o+1===s)s<=e.length-1&&i(e[s],n);else{const t=m(o,s);let a=0;for(;0===a;){const e=g(r,n,t);r=e.startZOrder,a=e.zOrderStep,0===a&&(n+=1e4,0===n&&(n+=1e4))}let l=o+1;for(;l<=s-1;){const t=_(r+a);i(e[l],t),r=t,l++}s<=e.length-1&&i(e[s],n)}r=n,o=s}}function f(e){!function(e,t,i,s,o,r){
let n=null;const a=[];for(const o of e)t(o)?(a.push(o),n=o):(i(o)||s(o))&&a.push(o);a.sort(r),null!==n&&o(n,0);const l=null===n?-1:a.indexOf(n);-1!==l?(S(a.slice(0,l),0,o,i),v(a.slice(l+1),0,o,i)):v(a,0,o,i)}(e,n.isMainSeriesState,n.isStudyState,n.isLineToolState,h,d)}function b(e,t){const i=Math.floor(e/1e4);let s=t.get(i);return void 0===s&&(s=[],t.set(i,s)),s}function y(e,t,i,s,o,r){let n=-1/0,a=1/0,l=-1/0,c=0;const d=new Map;for(let s=0;s<e.length;++s){const r=e[s],h=o(r);t(r)?(n=Math.max(n,h),b(h,d).push(r)):i(r)&&(h<0&&(a=Math.min(a,h),l=Math.max(l,h)),c=Math.max(c,h))}if(r){const e=Math.max(c,n),t=g(e,T(e),1);return _(t.startZOrder+t.zOrderStep)}if(n===-1/0){const e=a===1/0?0:a,t=g(P(e),e,1);return _(t.startZOrder+t.zOrderStep)}const h=g(n,T(n),1);if(0!==h.zOrderStep)return _(h.startZOrder+h.zOrderStep);const u=b(n,d).sort(((e,t)=>o(e)-o(t)));let p=P(o(u[0]));const m=T(p),S=g(p,m,u.length+1).zOrderStep;return 0!==S?(u.forEach((e=>{const t=_(p+S);s(e,t),p=t})),_(p+S)):_(m+5e3)}function C(e,t){return y(e,l,c,u,p,t)}function w(e){let t=-1e4;for(const i of e)c(i)&&(t=Math.min(t,i.zorder()-1e4));return 0===t?-1e4:t}function T(e){const t=1e4*Math.ceil(e/1e4);return t===e?t+1e4:t}function P(e){const t=1e4*Math.floor(e/1e4);return t===e?t-1e4:t}function M(e,t,i,s,o,r,n){const l=t.length,{newItems:c,movedItemsStartIndex:d}=i>0?(0,a.moveAfter)(e,t,i-1):(0,a.moveBefore)(e,t,0);let h=!1;for(let t=d;t<d+l;t++)if(c[t]!==e[t]){h=!0;break}if(!h)return;if(s(t[0]))return void(i<e.length&&n(e[i])<0?v(c.slice(d+1),0,r,o):S(c.slice(0,d),0,r,o));t.some((e=>o(e)))?function(e,t,i,s,o,r){let n,a,l=-1,c=-1;0===i?(c=x(e,i+t,s),a=r(e[c])):i+t===e.length?(l=I(e,i-1,s),n=r(e[l])):(l=I(e,i-1,s),n=r(e[l]),c=x(e,i+t,s),a=r(e[c]));if((void 0===n||n<0)&&void 0!==a&&a<=0)S(e.slice(0,c),a,o,s);else if((void 0===a||a>0)&&void 0!==n&&n>=0)v(e.slice(l+1),n,o,s);else{i+t<e.length-i?S(e.slice(0,i+t),r(e[i+t]),o,s):v(e.slice(i),r(e[i-1]),o,s)}}(c,l,d,o,r,n):function(e,t,i,s,o,r,n){let a,l;0===i?l=n(e[i+t]):i+t===e.length?a=n(e[i-1]):(a=n(e[i-1]),l=n(e[i+t]));let c=0,d=0,h=0,u=0,p=0;if((void 0===a||a<0)&&void 0!==l&&l<=0){c=l;const e=g(c,void 0!==a?a:P(l),t);c=e.startZOrder,p=e.zOrderStep,h=i+t-1,u=h-t,d=-1}else if((void 0===l||l>0)&&void 0!==a&&a>=0){c=a;const e=g(c,void 0!==l?l:T(a),t);c=e.startZOrder,p=e.zOrderStep,h=i,u=h+t,d=1}if(0!==p)for(;h!==u;){const t=_(c+d*p);r(e[h],t),c=t,h+=d}else{const t=e.findIndex((e=>o(e)));-1!==t?(S(e.slice(0,t),0,r,s),v(e.slice(t+1),0,r,s)):v(e,0,r,s)}}(c,l,d,o,s,r,n)}function x(e,t,i){for(;t<e.length&&i(e[t]);)t++;return Math.min(t,e.length-1)}function I(e,t,i){for(;t>=0&&i(e[t]);)t--;return Math.max(0,t)}function L(e,t,i,s,o,r,n){const a=e.indexOf(i)+1;M(e,t,a,s,o,r,n)}function A(e,t,i,s,o,r,n){const a=e.indexOf(i);M(e,t,a,s,o,r,n)}function k(e,t,i){L(e,t,i,r.isSeries,c,u,p)}function E(e,t,i){A(e,t,i,r.isSeries,c,u,p)}},771702:(e,t,i)=>{"use strict";i.d(t,{canPlaceAlertOnResolution:()=>r});var s=i(378975),o=i(778016);function r(e,t){const i=s.Interval.isSeconds(e),r=t?null==t?void 0:t.alertsOnSeconds:(0,
o.enabled)("ALERTS_ON_SECONDS");return!i||r}},558634:(e,t,i)=>{"use strict";i.d(t,{getAlertsChartActionCreators:()=>s});const s=(0,i(895171).default)((async()=>{const{getCreateAlertAction:e}=await Promise.all([i.e(73068),i.e(43853)]).then(i.bind(i,790279)),{getEditAlertOnLineDataSourceAction:t}=await Promise.all([i.e(73068),i.e(43853)]).then(i.bind(i,190151));return{createAlert:e,editAlertOnLineDataSource:t}}))},417947:(e,t,i)=>{"use strict";i.d(t,{hasUsualAlertPlots:()=>a,isFirstAlertPlotUsual:()=>n});var s=i(526910),o=i(434396),r=i(924166);function n(e){if((0,s.isSeries)(e))return!0;if((0,o.isStudy)(e)&&!(0,o.isStudyStrategy)(e)){const t=(0,r.plotsForAlert)(e.metaInfo(),e.offset.bind(e));return!e.metaInfo().hasAlertFunction&&t.every((e=>"alertcondition"!==e.type))}return!1}function a(e){if((0,s.isSeries)(e))return!0;if((0,o.isStudy)(e)&&!(0,o.isStudyStrategy)(e)){return(0,r.plotsForAlert)(e.metaInfo(),e.offset.bind(e)).some((e=>"alertcondition"!==e.type))}return!1}},411667:(e,t,i)=>{"use strict";var s;i.d(t,{AlertStopReason:()=>s}),function(e){e[e.Auto=0]="Auto",e[e.Manual=1]="Manual",e[e.Expired=2]="Expired",e[e.Created=3]="Created"}(s||(s={}))},475365:(e,t,i)=>{"use strict";i.d(t,{confirmDatasourceRemoving:()=>r});var s=i(444372),o=i(779923);function r(){return new Promise((e=>(0,o.showConfirm)({text:s.t(null,void 0,i(577322)),onConfirm:({dialogClose:t})=>{e(!0),t()},onClose:()=>e(!1)})))}},966837:(e,t,i)=>{"use strict";function s(e){return r().then((t=>t.hasUserAccessToDataSource(e)))}function o(e){return r().then((t=>t.filterAccessibleDataSources(e)))}i.d(t,{filterAccessibleDataSources:()=>o,hasUserAccessToDataSource:()=>s});const r=()=>Promise.all([i.e(83477),i.e(56396),i.e(56378),i.e(97525),i.e(91085),i.e(72949),i.e(323),i.e(30798),i.e(8046),i.e(70408),i.e(83441)]).then(i.bind(i,649994))},922182:(e,t,i)=>{"use strict";i.d(t,{bulkRemoveConfirmation:()=>n,bulkRemoveInactiveConfirmation:()=>a,selectedRemoveConfirmation:()=>l});var s=i(444372),o=i(694193),r=i(407781);const n=e=>e?{title:s.t(null,void 0,i(716688)),text:s.t(null,void 0,i(724146))}:{title:s.t(null,void 0,i(862436)),text:s.t(null,void 0,i(444323))},a=()=>({title:s.t(null,void 0,i(408166)),text:s.t(null,void 0,i(554643))}),l=e=>{if(1!==e.length)return{title:s.t(null,void 0,i(423481)),text:s.t(null,void 0,i(955138))};const t=e[0],n=(0,o.getAlertDescription)(t);return{title:s.t(null,void 0,i(2376)),text:s.t(null,void 0,i(332063)).format({alert:(0,r.cutString)(n,100)})}}},716004:(e,t,i)=>{e=i.nmd(e),TradingView.cleanButAmpersand=function(e,t){var i=t?["&amp;"]:["&"];return TradingView.clean(e,t,i)},TradingView.strip_tags=function(e){return e&&e.replace?e.replace(/(<([^>]+)>)/gi,""):e},TradingView.encodeSpread=function(e){return encodeURIComponent(e)},TradingView.clean=function(e,t,i){var s=[["&","&amp;"],["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&#039;"],["'","&#39;"]],o=e;if(!e||!e.replace)return o;for(var r=0;r<s.length;r++){var n=s[r][0],a=s[r][1]
;i&&i.indexOf&&-1!==i.indexOf(t?a:n)||(o=t?o.replace(new RegExp(a,"g"),n):o.replace(new RegExp(n,"g"),a))}return o},e&&e.exports&&(e.exports={clean:TradingView.clean,cleanButAmpersand:TradingView.cleanButAmpersand,stripTags:TradingView.strip_tags})},939656:(e,t,i)=>{"use strict";function s(e,t,i){return e*(1-i)+t*i}i.d(t,{doAnimate:()=>n,lerp:()=>s});const o={from:0,duration:250,easing:i(930203).easingFunc.easeOutCubic};class r{constructor(e){this._doing=!0,this._completed=!1,this._options={...o,...e};const t=performance.now();window.requestAnimationFrame((e=>{this._animation(t,this._options.from,e)}))}stop(){this._doing=!1}completed(){return this._completed}_animation(e,t,i){if(!this._doing)return void this._finishAnimation();const o=(i=!i||i<1e12?performance.now():i)-e,r=o>=this._options.duration||t===this._options.to,n=s(this._options.from,this._options.to,this._options.easing(o/this._options.duration)),a=r?this._options.to:n,l=a-t;this._options.onStep(l,a),r?this._finishAnimation():window.requestAnimationFrame((t=>{this._animation(e,a,t)}))}_finishAnimation(){this._options.onComplete&&this._options.onComplete(),this._completed=!0}}function n(e){return new r(e)}},130841:(e,t,i)=>{"use strict";function s(e,t,i="promise rejected by time-out"){return new Promise(((s,o)=>{const r=setTimeout((()=>o(i)),t);e.then((e=>{clearTimeout(r),s(e)})),e.catch((e=>{clearTimeout(r),o(e)}))}))}i.d(t,{makeTimeLimited:()=>s})},533679:(e,t,i)=>{"use strict";function s(){return Promise.all([i.e(6342),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(53799),i.e(25480),i.e(11390),i.e(82321),i.e(62526),i.e(32077)]).then(i.bind(i,906657))}i.d(t,{loadChangeIntervalDialog:()=>s})},214372:(e,t,i)=>{"use strict";i.d(t,{showChangeIntervalDialogAsync:()=>r});var s=i(533679);let o=null;function r(e){const t=o=(0,s.loadChangeIntervalDialog)().then((i=>{t===o&&i.showChangeIntervalDialog(e)}));return t}},207195:(e,t,i)=>{"use strict";function s(e){return Promise.all([i.e(52170),i.e(75816),i.e(46445),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(53799),i.e(62564),i.e(82421),i.e(59258),i.e(25480),i.e(67158),i.e(29296),i.e(8222),i.e(33828),i.e(80089),i.e(25983),i.e(31085),i.e(50210),i.e(9430),i.e(82321),i.e(62526),i.e(5428),i.e(9238),i.e(13671),i.e(46353),i.e(91859)]).then(i.bind(i,494677)).then((t=>t.showGoToDateDialog(e)))}i.d(t,{showGoToDateDialog:()=>s})},310681:(e,t,i)=>{"use strict";async function s(e){(await Promise.all([i.e(3081),i.e(75816),i.e(46445),i.e(65857),i.e(22164),i.e(36010),i.e(88488),i.e(33253),i.e(34693),i.e(88778),i.e(43311),i.e(35955),i.e(13689),i.e(82321),i.e(23127),i.e(10887),i.e(29147),i.e(24229),i.e(15516),i.e(26066)]).then(i.bind(i,915913))).renderGoToTradingViewReferralDialog(e)}i.d(t,{showGoToTradingViewReferralDialog:()=>s})},374271:(e,t,i)=>{"use strict";i.d(t,{isOpenedModals:()=>o,openedModals:()=>s});const s=[];function o(){return 0!==s.length}},956248:(e,t,i)=>{"use strict";i.d(t,{showDeleteStudyTreeConfirm:()=>r});var s=i(444372),o=i(779923);function r(e){(0,o.showConfirm)({
title:s.t(null,void 0,i(381605)),text:s.t(null,void 0,i(377174)),onConfirm:({dialogClose:t})=>{e(),t()}})}},440075:(e,t,i)=>{"use strict";function s(e){Promise.all([i.e(66613),i.e(75816),i.e(93703),i.e(21356),i.e(62093),i.e(44524),i.e(2520),i.e(53953),i.e(49481),i.e(74600),i.e(75826),i.e(82421),i.e(59258),i.e(67158),i.e(73399),i.e(97384),i.e(49325),i.e(94106),i.e(79753),i.e(6752),i.e(97956),i.e(82321),i.e(62526),i.e(31154),i.e(9374)]).then(i.bind(i,946499)).then((({SymbolInfoDialogImpl:t})=>{t.getInstance().show(e)}))}i.d(t,{showSymbolInfoDialog:()=>s})},625923:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="m19.54 4.5 3.96 4.32-.74.68-3.96-4.32.74-.68ZM7.46 4.5 3.5 8.82l.74.68L8.2 5.18l-.74-.68ZM19.74 10.33A7.5 7.5 0 0 1 21 14.5v.5h1v-.5a8.5 8.5 0 1 0-8.5 8.5h.5v-1h-.5a7.5 7.5 0 1 1 6.24-11.67Z"/><path fill="currentColor" d="M13 9v5h-3v1h4V9h-1ZM19 20v-4h1v4h4v1h-4v4h-1v-4h-4v-1h4Z"/></svg>'},270068:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M20.1 4 25 9.32l-.73.68-4.9-5.32.73-.68ZM7.9 4 3 9.32l.73.68 4.91-5.32L7.91 4ZM14 15v-5h1v6h-4v-1h3Z"/><path fill="currentColor" d="M5 15a9 9 0 1 1 18 0 9 9 0 0 1-18 0Zm9-8a8 8 0 1 0 0 16 8 8 0 0 0 0-16Z"/></svg>'},634369:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="currentColor"><path fill-rule="evenodd" d="M18 14a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-1 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/><path fill-rule="evenodd" d="M8.5 5h11l5 9-5 9h-11l-5-9 5-9Zm-3.86 9L9.1 6h9.82l4.45 8-4.45 8H9.1l-4.45-8Z"/></svg>'},748040:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M16.73 6.56a2.5 2.5 0 0 1 3.54 0l1.17 1.17a2.5 2.5 0 0 1 0 3.54l-.59.58-9 9-1 1-.14.15H6v-4.7l.15-.15 1-1 9-9 .58-.59Zm2.83.7a1.5 1.5 0 0 0-2.12 0l-.23.24 3.29 3.3.23-.24a1.5 1.5 0 0 0 0-2.12l-1.17-1.17Zm.23 4.24L16.5 8.2l-8.3 8.3 3.3 3.3 8.3-8.3Zm-9 9L7.5 17.2l-.5.5V21h3.3l.5-.5Z"/></svg>'},324020:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M15 5H6.5C5.67 5 5 5.67 5 6.5v15c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5V16h1v5.5a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 4 21.5v-15A2.5 2.5 0 0 1 6.5 4H15v1Zm7.41-.3a2 2 0 0 0-2.82 0l-.94.95-7.5 7.5-1 1-.15.14V19h4.7l.15-.15 1-1 7.5-7.5.94-.94a2 2 0 0 0 0-2.82L22.41 4.7Zm-2.12.71a1 1 0 0 1 1.42 0l1.88 1.88a1 1 0 0 1 0 1.42l-.59.58-1.65-1.64L19.71 6l.58-.59Zm.36 2.94L22.29 10l-6.79 6.8-1.65-1.65-1.64-1.65L19 6.7l1.65 1.65Zm-7.5 7.5 1.64 1.65-.5.5H11v-3.3l.5-.5 1.65 1.65Z"/></svg>'},421672:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M14 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm5-9H9v2h10v-2Z"/></svg>'},553218:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><rect width="10" height="4" fill="currentColor" rx="2" x="4" y="7"/></svg>'},24165:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22" width="22" height="22"><path fill="currentColor" d="M6 10h10v3H6v-3Z"/></svg>'},792263:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M5 8h8v2H5V8Z"/></svg>'},262998:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><circle fill="currentColor" cx="9" cy="9" r="5"/></svg>'},732140:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18" fill="none"><circle fill="currentColor" cx="9" cy="9" r="4"/></svg>'},109494:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" d="M4.74 3.26a4.62 4.62 0 0 0 1.8 5.3l.67.44-.66.44a4.63 4.63 0 0 0-1.81 5.3c.05.15.2.26.36.26h7.8c.17 0 .31-.1.37-.26a4.62 4.62 0 0 0-1.82-5.3L10.8 9l.66-.44a4.63 4.63 0 0 0 1.82-5.3.39.39 0 0 0-.37-.26H5.1c-.17 0-.31.1-.36.26ZM9 8.32l1.58-1.06a3.06 3.06 0 0 0 1.36-2.7H6.06a3.06 3.06 0 0 0 1.36 2.7L9 8.32Z"/></svg>'},792845:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" d="M5.45 4.22a3.85 3.85 0 0 0 1.5 4.41l.56.37-.55.37a3.86 3.86 0 0 0-1.51 4.41c.04.13.16.22.3.22h6.5c.14 0 .26-.09.3-.22a3.85 3.85 0 0 0-1.5-4.41L10.48 9l.55-.37a3.86 3.86 0 0 0 1.51-4.41.32.32 0 0 0-.3-.22h-6.5a.32.32 0 0 0-.3.22ZM9 8.44l1.32-.89a2.55 2.55 0 0 0 1.13-2.25h-4.9c-.04.88.37 1.74 1.13 2.25L9 8.44Z"/></svg>'},725230:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M9.3 9l.9-4.53a1.23 1.23 0 1 0-2.4 0L8.7 9l-.9 4.53a1.23 1.23 0 1 0 2.4 0L9.3 9z"/><path fill="currentColor" d="M9.15 9.26l4.38-1.48a1.23 1.23 0 1 0-1.21-2.09L8.85 8.74l-4.38 1.48a1.23 1.23 0 1 0 1.21 2.09l3.47-3.05z"/><path fill="currentColor" d="M9.15 8.74L5.68 5.69a1.23 1.23 0 1 0-1.2 2.09l4.37 1.48 3.47 3.05a1.23 1.23 0 1 0 1.2-2.09L9.16 8.74z"/></svg>'},643401:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M13.29 4.8h-.09a4.2 4.2 0 1 0 .09 8.4 6 6 0 1 1 0-8.4z"/></svg>'},212462:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M12.58 12.1A3.86 3.86 0 0 0 9 6.75a3.87 3.87 0 0 0-3.58 5.33 7.74 7.74 0 0 1 7.16 0zM3.64 9.93l-2.3-.62.37-1.38 2.3.62-.37 1.38zM6.1 6.07L5.07 3.92l1.3-.6 1 2.15-1.29.6zM10.62 5.47l1-2.16 1.3.6-1.01 2.16-1.3-.6zM13.99 8.55l2.3-.62.36 1.38-2.3.62L14 8.55z"/></svg>'},845437:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd"><path stroke="currentColor" d="M13 22.5H5.5a2 2 0 0 1-2-2v-14a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2V14"/><path stroke="currentColor" stroke-linecap="square" d="M18.5 15.5v8m-4-4h8"/><path fill="currentColor" d="M7 8h11v1H7zm0 4h11v1H7zm0 4h5v1H7z"/></g></svg>'},201457:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path d="M13.111 18.5H10.5a1 1 0 0 1-1-1v-11a1 1 0 0 1 1-1h11a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1h-8.389z"/><path d="M18.5 20v1.5a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1v-11a1 1 0 0 1 1-1H8"/></g></svg>'},855824:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 7 5" width="7" height="5" fill="none"><path stroke="currentColor" stroke-width="1.2" d="M1 1.5l2.5 2 2.5-2"/></svg>'},539706:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M5 2H4v3H1v1h3v3h1V6h3V5H5V2Z"/><path fill="currentColor" fill-rule="evenodd" d="M17.5 11h-7a1.5 1.5 0 0 0 0 3h7a1.5 1.5 0 0 0 0-3Zm-7-1a2.5 2.5 0 0 0 0 5h7a2.5 2.5 0 0 0 0-5h-7Z"/><path fill="currentColor" d="M8 18h12v1H8v-1Z"/><path fill="currentColor" d="M21.5 6H10V5h11.5A2.5 2.5 0 0 1 24 7.5v14a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 4 21.5V11h1v10.5c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5v-14c0-.83-.67-1.5-1.5-1.5Z"/></svg>'},760823:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" width="25" height="25"><circle fill="transparent" stroke="currentColor" stroke-width="1.5" cx="12.5" cy="12.5" r="11.75"/><path fill="currentColor" fill-rule="evenodd" d="M8.24 6.29a5.3 5.3 0 0 0 1.8 5.73l.67.48-.66.48a5.3 5.3 0 0 0-1.81 5.73c.05.17.2.29.36.29h7.8c.17 0 .31-.12.36-.29a5.3 5.3 0 0 0-1.8-5.73l-.67-.48.66-.48a5.3 5.3 0 0 0 1.81-5.73.39.39 0 0 0-.36-.29H8.6a.39.39 0 0 0-.36.29Zm4.26 5.48 1.58-1.15a3.41 3.41 0 0 0 1.36-2.93H9.56a3.41 3.41 0 0 0 1.36 2.93l1.58 1.15Z"/></svg>'},244230:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" width="25" height="25"><circle fill="none" stroke="currentColor" stroke-width="1.5" cx="12.5" cy="12.5" r="11.75"/><path fill="currentColor" d="m15.65 6 1.02.9-4.02 4.93h5.29L9.59 19l-1.02-.9 4.02-4.93H7.3L15.65 6Z"/></svg>'},428026:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M17.5 7H17v6h-3v-3H9v6H5v6h17V7h-4.5zm.5 14h3V8h-3v13zm-1 0v-7h-3v7h3zm-4-7.5V21h-3V11h3v2.5zM9 21v-4H6v4h3z"/></svg>'},437924:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" transform="translate(4 5)"><circle stroke="currentColor" cx="9.5" cy="9.5" r="9"/><path stroke="currentColor" d="M7 14.5h2.5v-5H7"/><path stroke="currentColor" stroke-linecap="square" d="M9.5 14.5h2"/><path fill="currentColor" d="M9.5 7a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></g></svg>'},
699875:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="backgroundColor" d="M5 7V6a4 4 0 1 1 8 0v1a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9c0-1.1.9-2 2-2Z"/><path fill="lineColor" fill-rule="evenodd" d="M9 3a3 3 0 0 0-3 3v1h6V6a3 3 0 0 0-3-3ZM5 6v1a2 2 0 0 0-2 2v5c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2V6a4 4 0 0 0-8 0Zm0 2a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1H5Zm4 2a1 1 0 0 0-1 1v1a1 1 0 1 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg>'},902872:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(6 3)"><rect width="15" height="12" rx="2" x=".5" y="8.5"/><path stroke-linecap="round" stroke-width="2" d="M8 15v2"/><path d="M11.5 4a3.5 3.5 0 0 0-7 0v4.5"/></g></svg>'},507983:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 13" width="15" height="13"><path fill="currentColor" fill-rule="evenodd" d="M4.1 1 1.14 6.5 4.1 12h6.8l2.96-5.5L10.9 1H4.1ZM15 6.5 11.5 0h-8L0 6.5 3.5 13h8L15 6.5ZM7.5 8a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm0 1a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/></svg>'},139267:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path d="M6.5 15A8.5 8.5 0 1 0 15 6.5H8.5"/><path d="M12 10L8.5 6.5 12 3"/></g></svg>'},416911:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(3 6)"><path d="M.964 8C3 4 6.679.5 11 .5 15.32.5 19 4 21.036 8 19 12 15.32 15.5 11 15.5 6.679 15.5 3 12 .964 8z"/><circle cx="11" cy="8" r="3.5"/></g></svg>'},198083:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 16.6205C19.7396 16.8955 19.3241 16.9285 19.044 16.6948L14.3924 12.8117L14.072 12.5442L13.7516 12.8117L9.10009 16.6947C8.82008 16.9285 8.40456 16.8955 8.16495 16.6205C7.92467 16.3447 7.94981 15.9272 8.22144 15.6822L14.0721 10.4057L19.9227 15.6822C20.1943 15.9272 20.2195 16.3447 19.9792 16.6205ZM18.4032 17.4624C19.1009 18.0448 20.1362 17.9626 20.7332 17.2774C21.3318 16.5902 21.2692 15.55 20.5924 14.9396L14.407 9.36109L14.0721 9.05908L13.7373 9.36109L7.55171 14.9396C6.87492 15.55 6.81229 16.5902 7.41096 17.2774C8.00796 17.9626 9.04326 18.0448 9.74094 17.4624L14.072 13.8468L18.4032 17.4624Z"/></svg>'},472382:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 12.2892C19.7396 12.0142 19.3241 11.9812 19.044 12.2149L14.3924 16.098L14.072 16.3655L13.7516 16.098L9.10009 12.2149C8.82008 11.9812 8.40456 12.0142 8.16495 12.2892C7.92467 12.565 7.94981 12.9825 8.22144 13.2275L14.0721 18.504L19.9227 13.2275C20.1943 12.9825 20.2195 12.565 19.9792 12.2892ZM18.4032 11.4472C19.1009 10.8648 20.1362 10.9471 20.7332 11.6323C21.3318 12.3195 21.2692 13.3597 20.5924 13.9701L14.407 19.5486L14.0721 19.8506L13.7373 19.5486L7.55171 13.9701C6.87492 13.3597 6.81229 12.3195 7.41096 11.6323C8.00796 10.9471 9.04326 10.8648 9.74094 11.4473L14.072 15.0628L18.4032 11.4472Z"/></svg>'},706862:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path stroke-linecap="square" d="M11.5 21.5v-7m3 7v-5m3 5v-3m-9 3v-5"/><path d="M5.5 22v-3"/><path stroke-linecap="square" d="M5.5 13.5l4.297-4.297a2.406 2.406 0 0 1 3.406 0l2.594 2.594c.94.94 2.463.943 3.406 0L23.5 7.5M22.5 12.5v6m-3-3h6"/></g></svg>'},854190:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="square" d="M6.145 11.968L14 5.5l7.855 6.468a.3.3 0 0 1-.191.532H6.336a.3.3 0 0 1-.19-.532zm0 4.064L14 22.5l7.855-6.468a.3.3 0 0 0-.191-.532H6.336a.3.3 0 0 0-.19.532z"/></svg>'},225191:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" transform="translate(4 5)"><path fill="currentColor" d="M3 1h1v13.5H3z"/><circle stroke="currentColor" cx="3.5" cy="16.5" r="2"/><path fill="currentColor" d="M5.5 16H18v1H5.5z"/><path stroke="currentColor" d="M0 4L3.5.5 7 4m8 9l3.5 3.5L15 20"/></g></svg>'},593379:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><g fill="currentColor" fill-rule="nonzero"><path d="M4 15h8.5v-1h-8.5zM16.5 15h8.5v-1h-8.5z"/><path d="M14.5 16c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm0 1c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5 2.5 1.119 2.5 2.5-1.119 2.5-2.5 2.5z"/></g></svg>'},484959:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="currentColor" d="M18.15 7.02A9.05 9.05 0 0014 6c-3.45 0-6.08 2-7.8 3.92a18.18 18.18 0 00-2.64 3.84v.02h-.01L4 14l-.45-.21-.1.21.1.21L4 14l-.45.21.01.03a5.85 5.85 0 00.16.32c.11.2.28.51.5.87a18.18 18.18 0 002.4 3.12l.71-.71A17.18 17.18 0 014.56 14a10.05 10.05 0 01.52-.91c.41-.69 1.04-1.6 1.85-2.5C8.58 8.75 10.95 7 14 7a8 8 0 013.4.77l.75-.75zm-3.11 3.12a4 4 0 00-4.9 4.9l.86-.87V14a3 3 0 013.17-3l.87-.86zm1.96 3.7l.86-.88a4 4 0 01-4.9 4.9l.87-.86A3 3 0 0017 13.83zm-6.4 6.4A8 8 0 0014 21c3.05 0 5.42-1.76 7.07-3.58A17.18 17.18 0 0023.44 14a9.47 9.47 0 00-.52-.91 17.18 17.18 0 00-2.25-2.93l.7-.7a18.18 18.18 0 013.06 4.3l.02.02L24 14l.45.21-.01.03a7.03 7.03 0 01-.16.32c-.11.2-.28.51-.5.87-.44.72-1.1 1.69-1.97 2.65C20.08 20.01 17.45 22 14 22c-1.55 0-2.94-.4-4.15-1.02l.75-.75zM24 14l.45-.21.1.21-.1.21L24 14zM22.2 6.5L6.5 22.2l-.7-.7L21.5 5.8l.7.7z"/></svg>'},397874:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(6 4)"><rect width="15" height="12" rx="2" x=".5" y="7.5"/><path stroke-linecap="round" stroke-width="2" d="M8 14v2"/><path d="M11.5 7.5V4a3.5 3.5 0 0 0-7 0v3.5"/></g></svg>'},677067:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M13.39 3.84a1 1 0 0 1 1.22 0l8.19 6.37a1 1 0 0 1 0 1.58l-8.19 6.37a1 1 0 0 1-1.22 0L5.2 11.79a1 1 0 0 1 0-1.58l8.19-6.37zm.61.8L5.81 11 14 17.37 22.19 11 14 4.63zM5.3 13.6l8.7 6.76 8.7-6.76.6.78-8.69 6.77a1 1 0 0 1-1.22 0l-8.7-6.77.62-.78zm8.09 10.55l-8.7-6.77.62-.78L14 23.37l8.7-6.76.6.78-8.69 6.77a1 1 0 0 1-1.22 0z"/></svg>'},439970:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M13.5 24a9.5 9.5 0 1 0 0-19 9.5 9.5 0 0 0 0 19zm0 1a10.5 10.5 0 1 0 0-21 10.5 10.5 0 0 0 0 21zM11 10h1v9h-1v-9zm5 0h-1v9h1v-9z"/></svg>'},789795:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M23 14.5a9.5 9.5 0 1 1-19 0 9.5 9.5 0 0 1 19 0zm1 0a10.5 10.5 0 1 1-21 0 10.5 10.5 0 0 1 21 0zM11.3 9.6l-.8-.6v11l.8-.6 6-4.5.53-.4-.53-.4-6-4.5zm4.87 4.9L11.5 18v-7l4.67 3.5z"/></svg>'},133736:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path stroke="currentColor" d="M5.5 16.5c1 3 7 7 11 7 2-4 2-8.5 2-8.5s-1-3.5-2-4-4.5.5-4.5.5-3 3.5-6.5 5z"/><path stroke="currentColor" d="M15.5 11l3-6s.5-1 1.5-.5.5 1.5.5 1.5l-3 6M12 11.5l6.5 3.5M7.5 19c2-.5 4-2.5 4-2.5m0 5.5c2-1 3-3.5 3-3.5"/></svg>'},808757:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path stroke="currentColor" d="M6.5 16v4.5a1 1 0 001 1h14a1 1 0 001-1V16M14.5 18V5.5m-4 4l4-4l4 4"/></svg>'},786559:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><rect width="18" height="18" fill="#EC407A" rx="9" opacity=".15"/><path fill="#C2185B" d="M13.4 5.9c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.45-1.96-.45-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.71.4-.48.86-.72 1.4-.72.56 0 1.31.16 2.27.46.95.3 1.62.45 2.01.45.64 0 1.06-.3 1.27-.9h1.03zm0 3.87c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.46-1.96-.46-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.7.4-.48.86-.72 1.4-.72.56 0 1.31.15 2.27.46.95.3 1.62.44 2.01.44.64 0 1.06-.3 1.27-.9h1.03z"/></svg>'},80465:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M5.5 6C4.67 6 4 6.67 4 7.5V20.5c0 .83.67 1.5 1.5 1.5H16v-1H5.5a.5.5 0 0 1-.5-.5V12h16v1h1V9.5c0-.83-.67-1.5-1.5-1.5h-8.8L9.86 6.15 9.71 6H5.5zM21 11H5V7.5c0-.28.22-.5.5-.5h3.8l1.85 1.85.14.15h9.21c.28 0 .5.22.5.5V11zm1 11v-3h3v-1h-3v-3h-1v3h-3v1h3v3h1z"/></svg>'}}]);