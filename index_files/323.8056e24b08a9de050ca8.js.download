"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[323],{306060:(e,t,i)=>{i.d(t,{Version:()=>s});var n=i(650151);class s{constructor(e,t){this._major=e,this._minor=t}major(){return this._major}minor(){return this._minor}isZero(){return 0===this._major&&0===this._minor}toString(){return this._major+"."+this._minor}compareTo(e){return this._major<e._major?-1:this._major>e._major?1:this._minor<e._minor?-1:this._minor>e._minor?1:0}isLess(e){return this.compareTo(e)<0}isLessOrEqual(e){return this.compareTo(e)<=0}isEqual(e){return 0===this.compareTo(e)}isGreater(e){return this.compareTo(e)>0}isGreaterOrEqual(e){return this.compareTo(e)>=0}static parse(e){if(e instanceof s)return new s(e.major(),e.minor());if("number"==typeof e)return(0,n.assert)(Math.floor(e)===e,"Version should not be a float number"),new s(e,0);if("string"==typeof e){const t=e.split(".");if(1===t.length){const i=parseInt(t[0],10);return(0,n.assert)(!isNaN(i),"Bad version string: "+e),new s(i,0)}if(2===t.length){const i=parseInt(t[0],10);(0,n.assert)(!isNaN(i),"Bad version string: "+e);const r=parseInt(t[1],10);return(0,n.assert)(!isNaN(r),"Bad version string: "+e),new s(i,r)}throw new Error("Bad version string (one dot expected): "+e)}throw new Error("Bad version: "+e)}}s.ZERO=new s(0,0)},923451:(e,t,i)=>{i.d(t,{iterateAndPatchObjectsByMap:()=>f,patchPropertiesAsync:()=>p,processLegacy:()=>h});var n=i(650151),s=i(338619),r=i(79200),o=i(955273),a=i(345848),u=i(603774),l=i(453995),d=i(486393);const c=(0,s.getLogger)("Pine.ScriptLib");function p(e,t,i,n){return c.logNormal("patchPropertiesAsync"),new Promise(((o,u)=>{if(!t.TVScriptMetaInfoExprs)return void o(e);const c=t.TVScriptMetaInfoExprs.tree,p=t.TVScriptMetaInfoExprs.patchMap;(function(e,t){(0,a.trackEvent)("Pine","ScriptLib.evalMetaInfoExprs");const i=d.Deferred(),n={username:window.user&&window.user.username,source:e,inputs:JSON.stringify(t||{})};return(0,l._pineFacadeAjax)("POST","/eval_pine_ex/",n).done(((e,t)=>{e.error?i.reject((0,l._readableError)(e.error,t)):e.success?i.resolve(e.result):i.reject((0,l.safetyGetReason)(e))})).fail((e=>{(0,l._anyRequestAsyncFail)(i,e)})),i.promise()})(c,i).done((i=>{var a;if(!i)return void o(e);const u=e.childs().inputs.childs().text.value(),l=i.rootValues;f([e,t.defaults,t],p,((e,t,i)=>{const s=l[i],r=e[0],o=e[1],a=e[2];(void 0===n||void 0!==n[i]&&n[i]!==s)&&(o.hasOwnProperty(t)?r[t].setValue(s):a[t]=s)})),void 0!==n&&Object.keys(l).forEach((e=>{void 0!==n[e]&&(n[e]=l[e])}));const d=e.childs().inputs.childs().text.value();u&&!d&&(null===(a=(0,r.getPersistentLogger)())||void 0===a||a.addPersistentLogEntry(`Detected invalid meta info evaluation expression result: IL code input value is empty, id: ${t.fullId}`,s.LOGLEVEL.ERROR,"PineMetaInfoValidation")),o(e)})).fail((e=>{u(e)}))}))}function f(e,t,i){const s=Object.keys(t);for(let r=0;r<s.length;r++){const o=s[r],a=t[o],u=o.split(".");"defaults"===u[0]&&u.splice(0,1),(0,n.assert)(u.length>1,"Unexpectedly short json path");let l=[...e];for(let e=0;e<u.length-1;++e){const t=u[e]
;l=l.map((e=>e?e[t]:null))}i(l,u[u.length-1],a)}}function h(e,t){(0,a.trackEvent)("Pine","ScriptLib.processLegacy");const i=(0,o.createDeferredPromise)(),n=window.user&&window.user.username,s="/process_legacy/"+encodeURIComponent(e)+"/?user_name="+encodeURIComponent(n),r=t?{source:t}:{};return(0,l._pineFacadeAjax)("POST",s,r).done((e=>{e.error?i.reject((0,l._readableError)(e.error)):e.success?((0,u.logPineMetaInfoIssues)("ScriptLib.processLegacy",e.result.metaInfo),i.resolve(e.result.metaInfo)):i.reject((0,l.safetyGetReason)(e))})).fail((e=>{(0,l._anyRequestAsyncFail)(i,e)})),i.promise}},453995:(e,t,i)=>{var n=i(486393),s=i(345848).trackEvent,r=i(338619).getLogger("Pine.ScriptLib"),o=i(175203).telemetry,a={fast:["delete","get","is_auth_to_get","is_auth_to_write","parse_title","rename","lib_list"],medium:["list","eval_pine_ex","translate_light"],slow:["process_legacy","publish","save","translate","translate_source","gen_alert"]},u=/[l|L]ines? (\d*)/;function l(e){if("object"==typeof e.reason)return e.reason;if(e.reason2)return e.reason2;const t={errors:[],warnings:[]},i=e.result&&e.result.metaInfo;if(i&&void 0!==i.warnings&&i.warnings.forEach((e=>t.warnings.push({message:e}))),e.reason){(Array.isArray(e.reason)?e.reason:e.reason.split("\n")).forEach((e=>{const i=e.match(u),n=i&&i.length&&Number(i[1]),s={message:e};if("number"==typeof n){s.start={line:n,column:0};const e=s.message.split(": ");e.shift(),s.message=e.join(": ")}t.errors.push(s)}))}return t}var d={getPineFacadeUrl:function(){return window.PINE_URL},PINE_FACADE_URL:function(){return window.PINE_URL}};d.safetyGetReason=l,d._pineFacadeAjax=function(e,t,i,s){r.logNormal("Requesting pine facade scripts, url: "+t);var u=function(e,t){for(var i=Object.keys(a),n=0;n<i.length;n++){var s=a[i[n]].filter((function(t){return-1!==e.indexOf(t)}));if(Boolean(s.length))return i[n]}return!1}(t),l=Date.now(),c=s?void 0:{withCredentials:!0};return n.ajax({url:d.PINE_FACADE_URL()+t,type:e,data:i||{},dataType:"json",xhrFields:c}).done((function(){var e=Date.now()-l;o.sendReport("pine",u+"_group_time_frame",{value:e}),o.sendReport("pine",u+"_group_ok"),r.logNormal("Requesting pine facade scripts finished, url: "+t)})).fail((function(){var e=Date.now()-l;o.sendReport("pine",u+"_group_time_frame",{value:e}),o.sendReport("pine",u+"_group_error"),r.logError("Requesting pine facade scripts failed, url: "+t)}))},d._generateAlertAsyncDone=function(e,t){if(t.error)e.reject(d._readableError(t.error));else if(t.success)e.resolve(t.result.metaInfo,t.result.IL,t.result.inputs||null,t.result.gen_alert_data||null);else{var i=t.result?t.result.metaInfo:null;e.reject(l(t),i)}},d._readableError=function(e,t){return t},d._anyRequestAsyncFail=function(e,t){try{const i=l(JSON.parse(t.responseText));if(i)return e.reject(i)}catch(e){}0===d.PINE_FACADE_URL().indexOf("http")&&r.logError(t.responseText),e.reject(d._readableError(t.status,t.statusText))},d.getPineSourceCode=function(e,t,i){s("Pine","ScriptLib.getPineSourceCode");var r=n.Deferred(),o="?no_4xx="+!!i,a="/get/"+encodeURIComponent(e)+"/"+t+o
;return d._pineFacadeAjax("GET",a).done((function(e,t,i){!1===e.success?r.reject(l(e)):r.resolve(e)})).fail((function(e,t,i){d._anyRequestAsyncFail(r,e)})),r.promise()},d.generateAlert=function(e){s("Pine","ScriptLib.generateAlert");var t=n.Deferred(),i=window.user&&window.user.username,r="/gen_alert/?user_name="+encodeURIComponent(i),a={alert_info:e},u=Date.now();return d._pineFacadeAjax("POST",r,a).done((function(e,i,n){o.sendReport("alerts","compilation_ok"),d._generateAlertAsyncDone(t,e)})).fail((function(e,i,n){o.sendReport("alerts","compilation_error"),d._anyRequestAsyncFail(t,e)})).always((function(){var e=Date.now()-u;o.sendReport("alerts","compilation_time_frame",{value:e})})),t.promise()},d.scriptUpdater=function(){return window.scriptUpdater()},d.requestUserPublishedScripts=function(e,t){if(s("Pine","ScriptLib.requestUserPublishedScripts"),window.is_authenticated){if(t||!d._userPublishedScriptsDfd){d._userPublishedScriptsDfd=n.Deferred();var i=d._userPublishedScriptsDfd;d._pineFacadeAjax("GET","/list?filter=published").done((function(e,t,n){i.resolve(e)})).fail((function(e){d._anyRequestAsyncFail(i,e)}))}i=d._userPublishedScriptsDfd}else i=n.Deferred().resolve([]);return"function"==typeof e&&i.done(e),i.promise()},d.requestInfoForScripts=function(e){return Promise.all([d._pineFacadeAjax("GET","/list?filter=saved"),d._pineFacadeAjax("GET","/list?filter=addon",void 0,!0)]).then((function(t){var i=t[0],n=t[1];return i.concat(n).filter((function(t){return e.includes(t.scriptIdPart)}))}))},d.requestBuiltinAndUserScripts=function(){s("Pine","ScriptLib.requestBuiltinAndUserScripts"),r.logNormal("Request built-in and user scripts");var e,t=window.user&&window.user.username,i={},n=new Promise((function(t,n){e=t,i.reject=n}));return Promise.all([d._pineFacadeAjax("GET","/list?filter=saved&user_name="+encodeURIComponent(t),void 0,!1),d._pineFacadeAjax("GET","/list?filter=standard",void 0,!0)]).then((function(t){r.logNormal("Request built-in and user scripts finished");var i=t[0],n=t[1];e(i.concat(n))})).catch((function(e){r.logWarn("Request built-in and user scripts finished with fail"),d._anyRequestAsyncFail(i,e)})),n},d.requestScriptInfo=function(e){s("Pine","ScriptLib.requestBuiltinAndUserScripts"),r.logNormal("Request public/user script info");var t=n.Deferred();return d._pineFacadeAjax("GET","/get_script_info/?pine_id="+encodeURIComponent(e)).done((function(e){r.logNormal("Request public/user script info finished"),t.resolve(e)})).fail((function(e){r.logWarn("Request public/user script info finished with fail"),d._anyRequestAsyncFail(t,e)})),t.promise()},d.requestCandlestickScripts=function(){var e;s("Pine","ScriptLib.requestCandlestickScripts"),r.logNormal("Request candlestick scripts");var t={},i=new Promise((function(i,n){e=i,t.reject=n}));return d._pineFacadeAjax("GET","/list?filter=candlestick",void 0,!0).done((function(t){r.logNormal("Request candlestick scripts finished"),e(t)})).fail((function(e){r.logWarn("Request candlestick scripts finished with fail"),d._anyRequestAsyncFail(t,e)})),i};var c={
time:-1/0,request:null};d.requestFundamentalScripts=function(){if(c.time+6e5>Date.now()&&null!==c.request)return r.logNormal("Return fundamentals from cache"),c.request;r.logNormal("Request fundamental scripts");var e=d._pineFacadeAjax("GET","/list?filter=fundamental",void 0,!1);return e.then((function(e){r.logNormal("Request fundamental scripts finished")})),e.fail((function(e){r.logWarn("Request fundamental scripts finished with fail, resetting cache"),c.request=null})),c.time=Date.now(),c.request=Promise.resolve(e.promise()),c.request},d.publishNew=function(e,t){s("Pine","ScriptLib.publishNew");var i=n.Deferred(),r=window.user&&window.user.username,o="/publish/new/?access="+encodeURIComponent(t)+"&user_name="+encodeURIComponent(r),a={source:e};return d._pineFacadeAjax("POST",o,a).done((function(e,t,n){e.success?i.resolve(e):i.reject(l(e))})).fail((function(e,t,n){d._anyRequestAsyncFail(i,e)})),i.promise()},d.publishNext=function(e,t){r.logNormal("ScriptLib.publishNext","pine"),s("Pine","ScriptLib.publishNext");var i=n.Deferred(),o=window.user&&window.user.username,a="/publish/next/"+encodeURIComponent(t)+"?user_name="+encodeURIComponent(o),u={source:e};return d._pineFacadeAjax("POST",a,u).done((function(e,t,n){e.success||i.reject(l(e)),i.resolve(e)})).fail((function(e,t,n){d._anyRequestAsyncFail(i,e)})),i.promise()},d.lightTranslate=function(e,t){return r.logNormal("ScriptLib.lightTranslate","pine"),s("Pine","ScriptLib.lightTranslate"),new Promise((function(i,n){var s=window.user&&window.user.username,r=`/translate_light/?user_name=${encodeURIComponent(s)}`;t&&(r+=`&pine_id=${encodeURIComponent(t)}`);var o={source:e};d._pineFacadeAjax("POST",r,o).done((function(e,t,s){if(e.success)i(e.result);else{var r=e.result&&l(e.result)||l(e);n(r)}})).fail((function(e,t,i){d._anyRequestAsyncFail({reject:n},e)}))}))},d.getLibList=function(e,t,i){return r.logNormal("ScriptLib.getLibList","pine"),s("Pine","ScriptLib.getLibList"),new Promise((function(n,s){var r="/lib_list?lib_id_prefix="+encodeURIComponent(e);t&&(r+="&ignore_cache=true"),i&&(r+="&ignore_case=true"),d._pineFacadeAjax("GET",r).done((function(e,t,i){n(e)})).fail((function(e,t,i){d._anyRequestAsyncFail({reject:s},e)}))}))},d.getExistingLibraryInfo=async function(e){try{const t=await d.getLibList(e+"/last",!0,!0);if(!t.length)return null;const i=t[0];return{scriptIdPart:i.scriptIdPart,chartId:i.chartId,version:i.version}}catch(e){return null}},e.exports=d},874546:(e,t,i)=>{i.d(t,{migrateMetaInfoAndPropState:()=>d});var n=i(650151),s=i(637761),r=i(124829);const o=["PennantCP@tv-basicstudies","WedgeCP@tv-basicstudies"],a=["DoubleTopCP@tv-basicstudies","BullishFlagCP@tv-basicstudies","HeadAndShouldersCP@tv-basicstudies","TripleTopCP@tv-basicstudies"];class u{targetMetaInfoVersion(){return 53}migrateMetaInfo(e){const t=e,i=e;if(i._metainfoVersion=53,void 0!==t.defaults&&void 0!==t.defaults.inputs&&(o.includes(t.id)||a.includes(t.id)&&Number(t.version)<156)){const e=t.defaults.inputs["Invert Pattern"];i.id=this._getNewIdStudies(t.id,e)}}migratePropState(e){}
_getNewIdStudies(e,t){return e.startsWith("WedgeCP")?t?"WedgeFallingCP@tv-basicstudies":"WedgeRisingCP@tv-basicstudies":e.startsWith("PennantCP")?t?"PennantBearishCP@tv-basicstudies":"PennantBullishCP@tv-basicstudies":e.startsWith("DoubleTopCP")&&t?"DoubleBottomCP@tv-basicstudies":e.startsWith("BullishFlagCP")&&t?"BearishFlagCP@tv-basicstudies":e.startsWith("HeadAndShouldersCP")&&t?"HeadAndShouldersInverseCP@tv-basicstudies":e.startsWith("TripleTopCP")&&t?"TripleBottomCP@tv-basicstudies":e}}const l=[new class{targetMetaInfoVersion(){return 47}migrateMetaInfo(e){const t=e,i=e;if(i._metainfoVersion=47,!t.defaults||void 0===t.defaults.precision)return void(i.format={type:"inherit"});const n=t.defaults&&t.defaults.precision,s=(0,r.isNumber)(n)?n:parseInt(n);0===s?i.format={type:"volume"}:isFinite(s)?i.format={type:"price",precision:s}:i.format={type:"inherit"},delete t.defaults.precision}migratePropState(e){}},new class{targetMetaInfoVersion(){return 50}migrateMetaInfo(e){const t=e,i=e;if(i._metainfoVersion=50,void 0===t.defaults||void 0===t.defaults.ohlcPlots||void 0===t.ohlcPlots)return;const s=t.ohlcPlots,r=t.defaults.ohlcPlots,o=(0,n.ensureDefined)((0,n.ensureDefined)(i.defaults).ohlcPlots);for(const e of Object.keys(r)){const t=r[e];if("ohlc_candles"===t.plottype){let i=!1;const n=s[e];void 0!==n&&(i=!!n.drawBorder,delete n.drawBorder),o[e]={borderColor:"#000000",drawBorder:i,...t}}}}migratePropState(e){}},new class{targetMetaInfoVersion(){return 53}migrateMetaInfo(e){const t=e,i=e;if(i._metainfoVersion=53,void 0!==t.defaults){if(void 0!==t.defaults.ohlcPlots&&void 0!==t.ohlcPlots){const e=Object.keys(t.ohlcPlots),s=t.defaults.ohlcPlots,r=(0,n.ensureDefined)((0,n.ensureDefined)(i.defaults).ohlcPlots);for(const t of e){const e=s[t];if(void 0===e||void 0===e.visible)continue;const i=e.visible?15:0;delete e.visible,r[t]={display:i,...e}}}if(void 0!==t.defaults.styles&&void 0!==t.plots){const e=t.plots.map((e=>e.id)),s=t.defaults.styles,r=(0,n.ensureDefined)((0,n.ensureDefined)(i.defaults).styles);for(const t of e){const e=s[t];if(void 0===e||void 0===e.visible)continue;const i=e.visible?15:0;delete e.visible,r[t]={display:i,...e}}}}}migratePropState(e){if(e.ohlcPlots)for(const t of Object.keys(e.ohlcPlots)){const i=(0,n.ensureDefined)(e.ohlcPlots[t]);void 0!==i.visible&&(i.display=i.visible?15:0,delete i.visible)}if(e.styles)for(const t of Object.keys(e.styles)){const i=(0,n.ensureDefined)(e.styles[t]);void 0!==i.visible&&(i.display=i.visible?15:0,delete i.visible)}}}];function d(e,t){const i=s.StudyMetaInfo.versionOf(e),r=e;void 0===r._serverMetaInfoVersion&&(r._serverMetaInfoVersion=i);const o=["PennantCP@tv-basicstudies","WedgeCP@tv-basicstudies"].includes(e.id);l.forEach((s=>{(i<0||i>=s.targetMetaInfoVersion())&&!o||(s.migrateMetaInfo(e),void 0!==t&&s.migratePropState(t),(0,n.assert)(e._metainfoVersion===s.targetMetaInfoVersion()))}))}l.push(new u),l.sort((function(e,t){return e.targetMetaInfoVersion()-t.targetMetaInfoVersion()}))},382318:(e,t,i)=>{
var n=i(306060).Version,s=i(338619).getLogger("Chart.StudyMigration");function r(e){this._studyId=e,this._maxToVers=n.ZERO,this._maxFromVers=n.ZERO,this._migrs=[]}r.prototype.addMigration=function(e,t,i){var s=n.parse(e),r=n.parse(t);s.isGreater(this._maxFromVers)&&(this._maxFromVers=s),r.isGreater(this._maxToVers)&&(this._maxToVers=r),this._migrs.push({fromVers:s,toVers:r,rules:i})},r.prototype.updateInputs=function(e,t,i){if(!i)return i;for(var n=TradingView.clone(i),r=e;r.isLess(t);){var o=this._findMigration(r);if(null==o)break;if(s.logNormal("Migrating study inputs from "+o.fromVers+" to "+o.toVers+" version, studyId: "+this._studyId+", migration: "+JSON.stringify(o)+", inputs: "+JSON.stringify(i)),n=this._applyMigration(n,o),!r.isLess(o.toVers))throw new Error("Problems in study migration process... Possible infinite cycle has been detected and stopped.");r=o.toVers}return r>e&&s.logNormal("Study inputs migration is done, studyId: "+this._studyId+", inputs: "+JSON.stringify(n)),n},r.prototype._findMigration=function(e){for(var t=-1,i=this._maxFromVers,n=0;n<this._migrs.length;n++){var s=this._migrs[n];s.fromVers.isLess(e)||s.fromVers.isLessOrEqual(i)&&(i=s.fromVers,t=n)}return t<0?null:this._migrs[t]},r.prototype._applyMigration=function(e,t){for(var i=e,n=0;n<t.rules.length;n++){var s=t.rules[n];i=this._getApplyRuleFun(s.type)(i,s)}return i},r.prototype._getApplyRuleFun=function(e){if("inputRemoved"===e)return r._applyInputRemovedRule;if("inputChangedType"===e)return r._applyInputChangedTypeRule;if("inputChangedMinMax"===e)return r._applyInputChangedMinMaxRule;if("inputChangedOptions"===e)return r._applyInputChangedOptionsRule;throw new Error("Unknown migration rule type: "+e)},r._applyInputRemovedRule=function(e,t){if(!(t.inputId in e))return e;if("removeVal"!==t.action)throw new Error("Unexpected rule.action="+t.action+" in rule.type="+t.type);var i=e[t.inputId];return delete e[t.inputId],s.logNormal("Input "+t.inputId+"="+i+" removed"),e},r._applyInputChangedTypeRule=function(e,t){var i=e[t.inputId];if("resetToDefVal"===t.action)return e[t.inputId]=t.defVal,s.logNormal("Input "+t.inputId+"="+i+" reset to default value "+t.defVal),e;if("convertVal"===t.action){if(null==i)return e;if("float"===t.inputTypeFrom&&"integer"===t.inputType)return e[t.inputId]=Math.round(e[t.inputId]),s.logNormal("Input "+t.inputId+"="+i+" converted to value "+e[t.inputId]),e;if("integer"===t.inputTypeFrom&&"float"===t.inputType)return e;if("text"===t.inputTypeFrom&&"source"===t.inputType)return r._isValidSource(i,t.options)||(e[t.inputId]=t.defVal),e;throw new Error("Cannot convertVal from "+t.inputTypeFrom+" to "+t.inputType)}throw new Error("Unknown action "+t.action+" for rule with type "+t.type)},r._isValidSource=function(e,t){return e.indexOf("$")>=0||t.indexOf(e)>=0},r._applyInputChangedMinMaxRule=function(e,t){if("adjustValIfNeeded"!==t.action)throw new Error("Unknown action "+t.action+" for rule with type "+t.type);var i=e[t.inputId];return i<t.minVal?e[t.inputId]=t.minVal:i>t.maxVal&&(e[t.inputId]=t.maxVal),
s.logNormal("Input "+t.inputId+"="+i+" adjusted to value "+e[t.inputId]),e},r._applyInputChangedOptionsRule=function(e,t){if(!(["text"].indexOf(t.inputType)>=0&&"resetToDefValIfNeeded"===t.action))throw new Error("Unexpected rule.inputType="+t.inputType+" in rule.action="+t.action);var i=e[t.inputId];return t.options.indexOf(i)<0&&(e[t.inputId]=t.defVal,s.logNormal("Input "+t.inputId+"="+i+" reset to default value "+t.defVal)),e},e.exports=r},500323:(e,t,i)=>{i.d(t,{StudyVersioning:()=>_});var n=i(852290),s=i(650151),r=i(637761),o=i(382318),a=i.n(o),u=i(338619),l=i(306060),d=i(874546),c=i(870408),p=i(444372);var f=i(923451),h=i(971417),v=i(66974),m=i(124829);const g=(0,u.getLogger)("Chart.Study.Versioning"),y=1e12;class _{constructor(e,t){if(this._migrations={},!e)throw new Error("No studies metainfo");if(this._studiesMetainfo=e,!t)throw new Error("No studies migrations");this._studiesMigrations=t;for(let e=0;e<this._studiesMigrations.length;e++){const t=this._studiesMigrations[e],i=t.versFrom,n=t.versTo;for(let e=0;e<t.studyMigrations.length;e++){const s=t.studyMigrations[e],r=s.studyId;if(0===s.rules.length){g.logError("Study Migration should have at least one convertion rule");continue}const o=r in this._migrations?this._migrations[r]:new(a())(r);o.addMigration(i,n,s.rules),this._migrations[r]=o}}this._clientMigrations=[(e,t)=>{if(0===this._studiesMetainfo.length||!e.isTVScript||e.version>=22)return t;const i={};let n=0,s=0,r=t[s];for(;void 0!==r;){const e=t[r.id];r.isFake&&(r.id="in_"+n++),i[s]=r,i[r.id]=e,s++,r=t[s]}return i}]}updateMetaInfoAsync(e){const t=r.StudyMetaInfo.versionOf(e);if(e.isTVScript&&!e.pine&&t<43){(0,s.assert)((0,m.isExistent)(e.scriptIdPart),"scriptIdPart is missing, study "+JSON.stringify(e));const t=e.scriptIdPart;return{sync:!1,result:new Promise(((i,n)=>{(0,f.processLegacy)(t,e.TVScriptSourceCode).then((t=>{e.removeDefaults();const n=new r.StudyMetaInfo(t);n.createDefaults();const s=n.state();(0,d.migrateMetaInfoAndPropState)(s),i(new r.StudyMetaInfo(s))})).catch((e=>{n(e)}))}))}}if(e.isTVScript&&e.pine){if((e._serverMetaInfoVersion||t)<52){return{sync:!1,result:(0,c.translateScriptAsync2)(e.scriptIdPart,e.pine.version).then((t=>{e.removeDefaults();const i=new r.StudyMetaInfo(t.metaInfo);i.createDefaults();const n=i.state();return(0,d.migrateMetaInfoAndPropState)(n),new r.StudyMetaInfo(n)}))}}return e.createDefaults(),{sync:!0,result:e}}{let t=null;const i=this._studiesMetainfo;for(let n=0;n<i.length;n++)if(i[n].id===e.id){t=i[n];break}return{sync:!0,result:t?new r.StudyMetaInfo(t.state()):null}}}updateStudyState(e,t,i){if(null==e||null==t||null==i)return e;e=(0,m.clone)(e),this.updateStudyInputsIfNeeded(e,t.version,i);for(const i of this._clientMigrations){const n=i.call(this,t,e.inputs);Object.keys(n).length===Object.keys(e.inputs).length?e.inputs=n:g.logWarn("StudyVersioning._clientMigrations application returned bad result. Skipping it...")}const n=r.StudyMetaInfo.versionOf(t);if(t.isTVScript&&t.TVScriptSourceCode&&n>=12&&n<=26){const n={};for(let e=0;e<t.plots.length;++e){
const s=t.plots[e],r=i.plots[e];n[s.id]=r.id}const s=Object.keys(e.styles);for(let t=0;t<s.length;++t){const i=s[t],r=e.styles[i];delete e.styles[i];const o=n[i];e.styles[o]=r}const r=Object.keys(e.plots);for(let t=0;t<r.length;++t){const i=r[t],s=e.plots[i].id;e.plots[i].id=n[s]}}return e}updateStudyInputsIfNeeded(e,t,i){if(!(i.isTVScript||!!i.pine)&&t!==i.version){const n=i&&i.defaults.inputs;e.inputs=this.updateStudyInputs(i.id,t,i.version,e.inputs,n)}}updateStudyInputs(e,t,i,n,s){let r=(0,m.clone)(n);if(e in this._migrations){const n=l.Version.parse(t);let s;if("last"===i){const t=this.lastVersionOfStudy(e);s=l.Version.parse(t)}else s=l.Version.parse(i);r=this._migrations[e].updateInputs(n,s,r)}if(null==s)return r;for(const e in s)e in r||(r[e]=s[e]);for(const i in r)if(!(i in s)){const n=r[i];g.logWarn(`Extra input detected, studyId='${e}', versionFrom='${t}', inputId='${i}', inputValue='${n}', removing it and continue...`),delete r[i]}return r}lastVersionOfStudy(e){return(0,s.ensureDefined)(this._studiesMetainfo.find((t=>t.id===e))).version}updateMetaInfo(e){if(!e)return e;(0,s.assert)(e instanceof r.StudyMetaInfo),(0,s.assert)(!e.isTVScript,"This method should update only built-in java indicators metaInfo. For Pine indicators use updateMetaInfoAsync");const t=this._studiesMetainfo.find((t=>e.id===t.id));return t?new r.StudyMetaInfo(t.state()):null}static patchPointsBasedStudyState(e){return this._fixInputsMaxValue(e.state,e.metaInfo),"LineToolRegressionTrend"===e.type&&(e=function(e){const t={palettes:{},inputs:[{defval:2,id:"upper diviation",max:500,min:-500,name:p.t(null,void 0,i(591900)),type:"integer"},{defval:-2,id:"lower diviation",max:500,min:-500,name:p.t(null,void 0,i(831736)),type:"integer"},{defval:!0,id:"use upper diviation",name:p.t(null,void 0,i(784451)),type:"bool"},{defval:!0,id:"use lower diviation",name:p.t(null,void 0,i(449299)),type:"bool"},{defval:0,id:"first bar time",max:253370764800,min:0,name:p.t(null,void 0,i(780509)),type:"time"},{defval:0,id:"last bar time",max:253370764800,min:0,name:p.t(null,void 0,i(59933)),type:"time"},{defval:"close",id:"source",name:p.t(null,void 0,i(997751)),options:["open","high","low","close","hl2","hlc3","ohlc4"],type:"text"}],plots:[],graphics:{},defaults:{inputs:{"first bar time":0,"last bar time":0,"lower diviation":-2,source:"close","upper diviation":2,"use lower diviation":!0,"use upper diviation":!0}},_metainfoVersion:6,description:"Regression Trend",id:"RegressionTrend@tv-basicstudies",is_price_study:!0,shortDescription:"Reg Trend",shortId:"RegressionTrend",version:"2",fullId:"RegressionTrend@tv-basicstudies-2",name:"RegressionTrend@tv-basicstudies"};return e.metaInfo||(e.metaInfo=t),e}(e)),e}static patchStudyData(e,t,i,n){if(!(0,v.isProd)())return{data:t,nsData:i,indexes:null!=n?n:void 0};const s=(0,m.clone)(t),o=(0,m.clone)(i),a=(0,m.clone)(n);"VbPVisible@tv-volumebyprice"===e.id&&e.version&&+e.version<=4&&this._patchOldVolumeProfiles(0,null==s?void 0:s.graphics),
"VbPSessions@tv-volumebyprice"===e.id&&e.version&&+e.version<=4&&this._patchOldVolumeProfiles(0,null==s?void 0:s.graphics);const u=r.StudyMetaInfo.versionOf(e);if(s&&e.isTVScript&&e.TVScriptSourceCode&&u>=12&&u<=26){const e=s.columns,t=[];s.columns=t;for(let i=0;i<e.length;++i){const e="plot_"+i;t.push(e)}}return{data:s,nsData:o,indexes:null!=a?a:void 0}}static patchPointsBasedStudyData(e,t){if(!(0,v.isProd)())return t;if(!e||!t)return t;const i=(0,m.clone)(t);return"VbPFixed@tv-volumebyprice"===e.id&&e.version&&+e.version<=4&&this._patchOldVolumeProfiles(0,i),i}static patchPropsStateAndMetaInfo(e,t,i){var s,o;let a=t.state();"Script$BOOKER"!==t.productId||a.alerts||delete e.alerts,this._fixInputsOrder(e,a),this._fixInputsMaxValue(e,a);const u=this.splitInputs(e.inputs);e.inputs=u.obj;const l=r.StudyMetaInfo.versionOf(t);l<42&&a.isChildStudy&&(e.isChildStudy=a.isChildStudy);if(t.isTVScript&&t.version<60&&("Script$TV_EARNINGS@tv-scripting"!==t.id&&"Script$TV_DIVIDENDS@tv-scripting"!==t.id&&"Script$TV_SPLITS@tv-scripting"!==t.id||delete a.TVScriptSourceCode),"Volume"!==t.id&&"Volume@tv-basicstudies"!==t.id||0!==t.inputs.length||(a.inputs=[{id:"length",type:"integer",defval:20,min:1,max:1e3}],a.plots.push({id:"vol_ma",type:"line"})),"Volume@tv-basicstudies"===t.id&&t.version&&t.version<=46&&void 0===e.styles.vol.transparency&&(e.styles.vol.transparency=e.transparency||87),"PivotPointsStandard@tv-basicstudies"===t.id&&(0===a.inputs.length?(e.inputs={kind:"Traditional",showHistoricalPivots:!0},a.inputs=[{defval:"Traditional",id:"kind",type:"text",options:["Traditional","Fibonacci","Woodie","Classic","DeMark","Camarilla"]},{id:"showHistoricalPivots",type:"bool",defval:!0}]):1===a.inputs.length&&(e.inputs={kind:"Traditional"},a.inputs=[{defval:"Traditional",id:"kind",type:"text",options:["Traditional","Fibonacci","Woodie","Classic","DeMark","Camarilla"]},{id:"showHistoricalPivots",type:"bool",defval:!0}]),void 0===e._hardCodedDefaultsVersion)){e._hardCodedDefaultsVersion=1;const t=e.color;delete e.color,e.levelsStyle={colors:{P:t,"S1/R1":t,"S2/R2":t,"S3/R3":t,"S4/R4":t,"S5/R5":t}}}"CMF"===t.shortId&&2===a.inputs.length&&(e.inputs={length:e.inputs["length fast"]},a.inputs=a.inputs.splice(0,1),a.inputs[0].id="length"),a.defaults&&void 0===a.defaults.precision&&l<46&&(-1!==["Volume@tv-basicstudies","VbPVisible@tv-volumebyprice","VbPSessions@tv-volumebyprice"].indexOf(t.id)?a.defaults.precision=0:a.defaults.precision=4);let c=t.id;if(t.version<60){const e=["TV_DIVIDENDS","TV_SPLITS","TV_EARNINGS"],i="Script".length;for(let n=0;n<e.length;n++)t.id.startsWith("Script$"+e[n]+"@tv-scripting")&&(a.fullId="ESD"+a.fullId.substring(i),a.id="ESD"+a.id.substring(i),a.name&&(a.name="ESD"+a.name.substring(i)),a.shortId="ESD"+a.shortId.substring(i),a.productId="ESD"+a.productId.substring(i),c="ESD"+t.id.substring(i))}const p={"ESD$TV_EARNINGS@tv-scripting":{fullId:"Earnings@tv-basicstudies-129!",id:"Earnings@tv-basicstudies",name:"Earnings@tv-basicstudies",shortId:"Earnings",productId:"tv-basicstudies"},"ESD$TV_SPLITS@tv-scripting":{
fullId:"Splits@tv-basicstudies-129!",id:"Splits@tv-basicstudies",name:"Splits@tv-basicstudies",shortId:"Splits",productId:"tv-basicstudies"},"ESD$TV_DIVIDENDS@tv-scripting":{fullId:"Dividends@tv-basicstudies-129!",id:"Dividends@tv-basicstudies",name:"Dividends@tv-basicstudies",shortId:"Dividends",productId:"tv-basicstudies"}};if(c in p&&Object.assign(a,p[c]),l<43){const i={"StrategyScript$STD;Consecutive%1Ups/Downs%1Strategy":{pineId:"STD;Consecutive%1Ups%1Downs%1Strategy",className:"StrategyScript"},Script$EDGR_NET_INCOME_FROM_CONTINUING_OPERATIONS_APPLICABLE_TO_COMMON_V2:{pineId:"Script$EDGR_NET_INCOME_FROM_CONTINUING_OPS_APPLICABLE_TO_COMMON_V2",className:"Script"}};if(t.shortId in i){const r=i[t.shortId].className+"$"+i[t.shortId].pineId,o={scriptIdPart:i[t.shortId].pineId,fullId:a.fullId.replace(a.shortId,r),id:a.id.replace(a.shortId,r),name:null===(s=a.name)||void 0===s?void 0:s.replace(a.shortId,r),shortId:r};(0,n.default)(a,o),(0,n.default)(e,o)}const r=(0,h.extractPineId)(t.fullId),u=r&&r.match(/^(USER)(_\d+)(;)(.*)$/);if(u){const t=u[0],i=u[1]+u[3]+u[2]+u[4],s={scriptIdPart:i,fullId:a.fullId.replace(t,i),id:a.id.replace(t,i),name:null===(o=a.name)||void 0===o?void 0:o.replace(t,i),shortId:a.shortId.replace(t,i)};(0,n.default)(a,s),(0,n.default)(e,s)}}if("MA"===t.id){const t={id:"MAExp",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgExp",type:"line"}],palettes:{}},i={id:"MASimple",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgSimple",type:"line"}],palettes:{}},n={id:"MAVolumeWeighted",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgVolumeWeighted",type:"line"}],palettes:{}},s={id:"MAWeighted",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgWeighted",type:"line"}],palettes:{}};switch(e.inputs.type){case"exp":a=t;break;case"simple":a=i;break;case"weighted":a=s;break;case"volume weighted":a=n}e.styles[a.plots[0].id]=e.styles.MovAvg,delete e.styles.MovAvg,delete e.inputs.type}return i.oldShowStudyLastValueProperty&&(e.oldShowLastValue=e.showLastValue),delete e.showLastValue,delete e.showStudyArguments,(0,d.migrateMetaInfoAndPropState)(a,e),{propsState:e,metaInfo:a}}static splitInputs(e){const t={},i={};for(const[n,s]of Object.entries(e))(0,m.isNumber)(parseInt(n,10))?t[n]=s:i[n]=s;return{arr:t,obj:i}}static verifyInputsMaxValue(e){
if(e.inputs)for(const t of e.inputs)"integer"===t.type&&t.max&&t.max>y&&g.logWarn("Bad integer input max value in metaInfo id="+e.id+" title="+e.description)}static mergeInputsObjPart(e,t){const i=this.splitInputs(t);(0,n.default)(e,i.obj)}static _fixInputsOrder(e,t){const i=this._getOrderedInputIds(t),s=this.splitInputs(e.inputs),r=s.arr,o=s.obj,a=(0,n.default)({},o);for(let e=0;e<i.length;++e){const t=i[e],n=this._findInputKeyById(r,t);null!==n&&(a[e]=r[n])}e.inputs=a}static _fixInputsMaxValue(e,t){if((0,m.isAbsent)(t))return;const i=y;if(t.inputs)for(const e of t.inputs)"integer"===e.type&&e.max&&e.max>i&&(e.max=i);if(!e||!e.inputs)return;const s=this.splitInputs(e.inputs),r=s.arr;for(const[,e]of Object.entries(r))"integer"===e.type&&e.max&&e.max>i&&(e.max=i);e.inputs=(0,n.default)(s.obj,s.arr)}static _findInputKeyById(e,t){let i=null;for(const n in e)if((0,m.isNumber)(parseInt(n,10))&&e[n].id===t){i=n;break}return i}static _getOrderedInputIds(e){const t=[];for(const i of e.inputs)t.push(i.id);return t}static _patchOldVolumeProfiles(e,t){if(!(null==t?void 0:t.hhists))return;const i=t.hhists[e].data,n=[];for(const[,e]of Object.entries(i))n.push(e);t.hhists[0].data=n}}}}]);