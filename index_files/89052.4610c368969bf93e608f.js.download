"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[89052],{242337:(e,t,i)=>{i.d(t,{StudyBaseWindowView:()=>n});var s=i(49839),r=i(287741);class n extends s.DataWindowView{constructor(e,t){super(),this._invalidated=!0,this._study=e,this._model=t,this._valueProvider=this._createValuesProvider(e,t),this._items=this._valueProvider.getItems().map((e=>new s.DataWindowItem(e.id,e.title,""))),this.update()}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}study(){return this._study}_updateImpl(){this._header=this._study.title(r.TitleDisplayTarget.DataWindow,!0),this._title=this._study.title(r.TitleDisplayTarget.DataWindow);const e=this._valueProvider.getValues(this._currentIndex());for(let t=0;t<e.length;++t){const i=e[t],s=this._items[t];s.setValue(i.value),s.setVisible(i.visible),s.setColor(i.color),s.setTitle(i.title)}}_currentIndex(){const e=this._model.crossHairSource().appliedIndex();return isNaN(e)?null:e}}},193938:(e,t,i)=>{i.d(t,{StudyDataWindowView:()=>n});var s=i(242337),r=i(316980);class n extends s.StudyBaseWindowView{_createValuesProvider(e,t){return new r.StudyDataWindowValuesProvider(e,t)}}},181945:(e,t,i)=>{i.d(t,{StudyStatusProvider:()=>a});var s=i(444372),r=i(757402),n=i(971417),o=i(170411);const l=s.t(null,void 0,i(224077));class a extends o.StudyStatusProviderBase{sourceStatusText(){const e=this._source;if(e.status().type===r.StudyStatusType.Error){const t=e.metaInfo(),i=(0,n.extractPineId)(t.fullId);if(t.scriptIdPart&&(0,n.isEdgrPineId)(t.scriptIdPart)||i&&(0,n.isEdgrPineId)(i))return l}return super.sourceStatusText()}}},689052:(e,t,i)=>{i.r(t),i.d(t,{Study:()=>ai});var s=i(316230),r=i(822914),n=i(852290),o=i(650151),l=i(444372),a=i(338619),h=i(879938),u=i(716004),d=i(682170),c=i(799878),p=i(19303),_=i(218049),f=i(230839);function m(e){const t=new Set;("historyCalculationMayChange"in e?e.historyCalculationMayChange():e.metaInfo().historyCalculationMayChange)&&t.add(p.DataSourceDangerReason.PineRepainting);for(const i of Object.values(e.inputs()))if((0,_.isExtendedInput)(i)&&"symbol"===i.t){const s=e.resolvedSymbolInfoBySymbol(i.v);"spread"===(null==s?void 0:s.type)&&t.add(p.DataSourceDangerReason.Spread),"CRYPTOCAP"===(null==s?void 0:s.exchange)&&t.add(p.DataSourceDangerReason.CryptoCap)}for(const i of e.parentSources())(0,f.addToSet)(t,m(i));const i=e.ownerSource();return e.isChildStudy()&&i&&(0,f.addToSet)(t,m(i)),t}function y(e){const[t]=m(e);return null!=t?t:null}var v=i(924166),g=i(923451),S=i(590508),b=i(640146),I=i(545437),P=i(120984),w=i(942634),C=i(432059),V=i(355468),x=i(979351),A=i(475892),R=i(704670),M=i(55243),T=i(637761),D=i(656723),O=i(518439),N=i(497503),F=i(242337),k=i(843563),B=i(748947);class E extends F.StudyBaseWindowView{constructor(e,t){super(e,t),this._showStudyValues=t.properties().childs().paneProperties.childs().legendProperties.childs().showStudyValues,this._showStudyValues.subscribe(this,this.update);const i=this._study.properties()
;i.childs().showLegendValues.subscribe(this,this.update);const s=this._study.metaInfo().plots,r=new Set;s.forEach((e=>{var t;if((0,B.isOhlcPlot)(e)){const t=e.target;if(r.has(t))return;r.add(t),i.childs().ohlcPlots.childs()[t].childs().display.subscribe(this,this.update)}else(0,B.isPlotSupportDisplay)(e)&&(null===(t=i.childs().styles.childs()[e.id])||void 0===t||t.childs().display.subscribe(this,this.update))}))}areValuesVisible(){return this._showStudyValues.value()}additional(){return null}destroy(){this._showStudyValues.unsubscribeAll(this);const e=this._study.properties();e.childs().showLegendValues.unsubscribeAll(this);const t=this._study.metaInfo().plots,i=new Set;t.forEach((t=>{var s;if((0,B.isOhlcPlot)(t)){const s=t.target;if(i.has(s))return;i.add(s),e.childs().ohlcPlots.childs()[s].childs().display.unsubscribe(this,this.update)}else(0,B.isPlotSupportDisplay)(t)&&(null===(s=e.childs().styles.childs()[t.id])||void 0===s||s.childs().display.unsubscribe(this,this.update))}))}_createValuesProvider(e,t){return new k.StudyLegendValuesProvider(e,t)}}var L=i(419283),H=i(903262),U=i(882782),G=i(362805),z=i(124066),j=i(181945),W=i(124829),$=i(287741),K=i(828473),q=i(401809);class Y{constructor(e,t,i=!1){this.price=t,this.index=e,this.useMainSeriesForPriceRange=i}}var J=i(597461);function X(e,t,i,s){if(e.y1===e.y2)return function(e,t,i){return(0,o.assert)(e.y1===e.y2),(0,J.doesItemAffectVisibleRange)(e.x1,e.x2,e.extend,t,i)?[new Y(t,e.y1,!1),new Y(i,e.y2,!1)]:[]}(e,i,s);const r=[];return null!==e.x1&&r.push(new Y(e.x1,e.y1,!1)),null!==e.x2&&r.push(new Y(e.x2,e.y2,!1)),r}function Z(e,t,i,s){return e.points.filter((e=>e.x>=i&&e.x<=s)).map((e=>new Y(e.x,e.y,!1)))}function Q(e,t,i,s){return(0,J.doesItemAffectVisibleRange)(e.left,e.right,e.extend,i,s)?[new Y(i,e.top,!1),new Y(s,e.bottom,!1)]:[]}var ee=i(15141);function te(e,t,i,s){let r;const n=e.yloc!==ee.DwgLabelYloc.Price&&e.yloc!==ee.DwgLabelYloc.Auto;if(n){const i=e.yloc===ee.DwgLabelYloc.AboveBar?2:3,s=t.valueAt(e.x);null!==s&&(r=s[i])}else r=e.y;return null==r?null:[new Y(e.x,r,n)]}function ie(e,t,i,s,r,n){if(!(0,J.doesItemAffectVisibleRange)(e.firstBarTime,e.lastBarTime,J.DwgExtend.None,i,s))return[];let o=1/0,l=-1/0;for(const[t,i]of r.tpoBlockSets())if(n===t)for(const t of i.get(e.id)||[])o=Math.min(o,t.rowIndex*e.priceRange),l=Math.max(l,(t.rowIndex+1)*e.priceRange);return Number.isFinite(o)?[new Y(i,l,!1),new Y(s,o,!1)]:[]}class se{constructor(e,t,i,s,r){this._mapGetter=e,this._study=t,this._bars=t.series().bars(),this._visibilityGetter=i,this._getPoints=s,this._getMargins=r}groupPriceRange(e,t,i){let s=null;const r=this._study.graphics();for(const[n,o]of this._mapGetter(i))if(this._visibilityGetter(n))for(const i of o){const o=this._getPoints(i,this._bars,e,t,r,n);if(null===o)continue;let l=1/0,a=-1/0,h=!1,u=!1,d=!1;for(const i of o){const s=i.index<=t,r=i.index>=e;h=h||s,u=u||r,d=d||s&&r;let n=i.price,o=i.price;if(i.useMainSeriesForPriceRange){const e=this._bars.valueAt(i.index);if(null===e)continue;const t=e[2];if(null==t)continue;const s=e[3]
;if(null==s)continue;n=s,o=t}n<l&&(l=n),o>a&&(a=o)}if(!(d||h&&u))continue;const c=new R.PriceRange(l,a);s=null===s?c:s.merge(c)}return s}firstValue(e,t){let i=1/0,s=1/0,r=-1/0,n=1/0,o=1/0,l=1/0;const a=this._study.graphics();for(const[h,u]of this._mapGetter(!1))if(this._visibilityGetter(h))for(const d of u){const u=this._getPoints(d,this._bars,e,t,a,h);if(null!==u)for(const a of u){const h=a.index;h>=e&&h<=t&&h<i?(i=h,s=a.price):h<e&&h>r?(r=h,n=a.price):h>t&&h<o&&(o=h,l=a.price)}}return{firstVisible:i===1/0?null:new Y(i,s),leftClosest:r===-1/0?null:new Y(r,n),rightClosest:o===1/0?null:new Y(o,l)}}groupPixelMargins(e,t,i){if(!this._getMargins)return re();const s=re();if(null===this._study.priceScale())return s;if(null===this._study.firstValue())return s;const r=this._study.graphics();for(const[n,o]of this._mapGetter(i))if(this._visibilityGetter(n))for(const i of o){const o=this._getPoints(i,this._bars,e,t,r,n);if(null===o)continue;if(0===o.filter((i=>{const s=i.index;return s>=e&&s<=t})).length)continue;const l=this._getMargins(i,this._bars);s.bottomPixelMargin=Math.max(s.bottomPixelMargin,l.bottomPixelMargin),s.topPixelMargin=Math.max(s.topPixelMargin,l.topPixelMargin)}return s}}const re=()=>({bottomPixelMargin:0,topPixelMargin:0});function ne(e){const t=(0,o.ensureDefined)(e.properties().childs().graphics).childs();return[new se((()=>(0,K.mapEntriesGenerator)(e.graphics().tpos())),e,(e=>{const i=(0,o.ensureDefined)(t.tpoBlockSets).childs()[e].childs();return i.showLetters.value()||i.showBlocks.value()||(0,o.ensureDefined)(t.tpoVolumeRows).childs()[e].childs().visible.value()}),ie,re),new se((t=>(0,K.nestedMapGenerator)(e.graphics().dwglabels(),t)),e,(e=>(0,o.ensureDefined)(t.dwglabels).childs()[e].childs().visible.value()),te,q.calculateDwgLabelsMargins.bind(null,e)),new se((t=>(0,K.nestedMapGenerator)(e.graphics().dwglines(),t)),e,(e=>(0,o.ensureDefined)(t.dwglines).childs()[e].childs().visible.value()),X,re),new se((t=>(0,K.nestedMapGenerator)(e.graphics().dwgpolylines(),t)),e,(e=>(0,o.ensureDefined)(t.dwgpolylines).childs()[e].childs().visible.value()),Z,re),new se((t=>(0,K.nestedMapGenerator)(e.graphics().dwgboxes(),t)),e,(e=>(0,o.ensureDefined)(t.dwgboxes).childs()[e].childs().visible.value()),Q,re),new se((t=>function*(e,t){const i=e.dwglines(),s=e.dwglinefills(),r=new Map;i.forEach((e=>{if(void 0===t)e.forEach((e=>{null==e||e.forEach((e=>{r.set(e.id,e)}))}));else{const i=e.get(t);null==i||i.forEach((e=>{r.set(e.id,e)}))}}));for(const[e,t]of s){const i=Array.from(t).filter((e=>r.has(e.line1)));i.length&&(yield[e,new Set(i)])}}(e.graphics(),t)),e,(e=>(0,o.ensureDefined)(t.dwglinefills).childs()[e].childs().visible.value()),((t,i,s,r)=>{const n=new Map;for(const[,t]of e.graphics().dwglines())for(const[,e]of t)for(const t of e)n.set(t.id,t);return function(e,t,i,s,r){const n=e.get(t.line1),o=e.get(t.line2);return void 0!==n&&void 0!==o&&((0,J.doesItemAffectVisibleRange)(n.x1,n.x2,n.extend,s,r)||(0,
J.doesItemAffectVisibleRange)(o.x1,o.x2,o.extend,s,r))?[new Y(s,n.y1,!1),new Y(r,n.y2,!1),new Y(s,o.y1,!1),new Y(r,o.y2,!1)]:[]}(n,t,0,s,r)}),re)]}function oe(e,t,i){return null===t?e:null===e?t:e.index<t.index?i?t:e:i?e:t}class le{constructor(){this.firstVisible=null,this.leftClosest=null,this.rightClosest=null}improve(e){this.firstVisible=oe(this.firstVisible,e.firstVisible,!0),this.leftClosest=oe(this.leftClosest,e.leftClosest,!0),this.rightClosest=oe(this.rightClosest,e.rightClosest,!1)}bestPrice(){return null!==this.firstVisible?this.firstVisible.price:null!==this.leftClosest?this.leftClosest.price:null!==this.rightClosest?this.rightClosest.price:null}}var ae=i(175203),he=i(296842),ue=i(354957),de=i(322825),ce=i(272933);function pe(e,t){return e.studyId.localeCompare(t.studyId)}function _e(e){const t=new Set,i=[];return e.forEach((e=>{t.has(e.studyId)||(t.add(e.studyId),i.push(e))})),i}function fe(e){const t=e.model().mainSeries();return{studyId:(0,o.ensureNotNull)(e.sourceId()),turnaround:e.turnaround(),sourceStudies:e.parentSources().filter((e=>e!==t)).map((e=>fe(e)))}}var me=i(764829),ye=i(982949),ve=i(961970);class ge extends ve.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return null}_drawImpl(e){}_drawBackgroundImpl(e){const{context:t,horizontalPixelRatio:i,bitmapSize:s}=e,r=this._data;for(let e=0;e<r.items.length;++e){const n=r.items[e];if(null==n.color)continue;t.fillStyle=n.color;const o=Math.round(n.left*i)+1,l=Math.round(n.right*i);t.fillRect(o,0,l-o+1,s.height)}}}var Se=i(962973),be=i(249121);class Ie extends be.StudyForceOverlayPlotView{constructor(e,t,i,s){super(t,i,s),this._items=[],this._invalidated=!0,this._isMarkersEnabled=me.enabled("source_selection_markers"),this._study=e;const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];t.id===this._plotName&&(this._plotIndex=e,(0,o.assert)((0,B.isBgColorerPlot)(t),"Plot '"+this._plotName+"' is not a background colorer!"))}this._colorProvider=(0,Se.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),s)}items(){return this._items}update(){this._invalidated=!0}renderer(){if(1!=(1&(0,o.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs().display.value()))return null;if(!this._scalesReady())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={items:this._items},t=new ye.CompositeRenderer;return t.append(new ge(e)),t}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&!e.isEmpty()&&null!==t&&!t.isEmpty()}_getTranspValue(){const e=(0,o.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs();let t=0;return e.transparency&&(t=e.transparency.value(),t=(0,W.isNumber)(t)?t:40),t}_updateImpl(){this._items=[],(0,o.assert)(this._scalesReady(),"Scales must be ready!");const e=this._model.timeScale().visibleBarsStrictRange();if(null===e)return;const t=this._getTranspValue();let i=(0,o.ensureDefined)(this._series.nearestIndex(e.firstBar(),O.PlotRowSearchMode.NearestRight)),s=(0,
o.ensureDefined)(this._series.nearestIndex(e.lastBar(),O.PlotRowSearchMode.NearestLeft));const r=this._study.offset(this._plotName);r>0?(i-=r,s+=r):(i+=r,s-=r);const n=this._study.getMinFirstBarIndexForPlot(this._plotName);if(n>s)return;i=Math.max(n,i);const l=this._study.data();for(const e of l.rangeIterator(i,s)){let i=e.index;const s=e.value;i+=r;const n={timePointIndex:Math.floor(i),left:NaN,center:NaN,right:NaN};let l=(0,W.isNumber)(t)?t:50;l=Math.min(l,100),l=Math.max(l,0);const a=this._colorProvider.getPlotPointStyle(s);void 0!==a.colors[1]&&(n.color=(0,C.generateColor)((0,o.ensureDefined)(a.colors[1]),l)),this._items.push(n)}this._model.timeScale().fillBarBorders(this._items)}}var Pe=i(112377),we=i(359658),Ce=i(750139),Ve=i(836687),xe=i(368628),Ae=i(40563),Re=i(354012),Me=i(381065),Te=i(744688),De=i(743537),Oe=i(754533),Ne=i(819788),Fe=i(311156),ke=i(975696),Be=i(245356),Ee=i(337827);const Le=new Map;Le.set("PaneRendererArrowUp",Re.PaneRendererArrowUp),Le.set("PaneRendererArrowDown",Re.PaneRendererArrowDown),Le.set("PaneRendererCircleShape",Me.PaneRendererCircleShape),Le.set("PaneRendererCrossShape",Te.PaneRendererCrossShape),Le.set("PaneRendererDiamond",De.PaneRendererDiamond),Le.set("PaneRendererFlagShape",Oe.PaneRendererFlagShape),Le.set("PaneRendererLabelUp",Ne.PaneRendererLabelUp),Le.set("PaneRendererLabelDown",Ne.PaneRendererLabelDown),Le.set("PaneRendererSquare",Fe.PaneRendererSquare),Le.set("PaneRendererTriangleApexUp",ke.PaneRendererTriangleApexUp),Le.set("PaneRendererTriangleApexDown",ke.PaneRendererTriangleApexDown),Le.set("PaneRendererXCross",Be.PaneRendererXCross);class He extends Ee.StudyPaneViewInplaceUpdatable{constructor(e,t,i,s){var r;super(t,i,s),this._renderer=null,this._shapesRenderer=null,this._selectionRenderer=null,this._isMarkersEnabled=me.enabled("source_selection_markers"),this._study=e;const n=e.metaInfo().plots;for(let e=0;e<n.length;e++)if(n[e].id===this._plotName){this._plotIndex=e;break}this._plotStyleInfo=(0,o.ensureDefined)(null===(r=e.metaInfo().styles)||void 0===r?void 0:r[this._plotName]),this._colorProvider=(0,Se.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),s),this._selectionIndexer=new Ve.SelectionIndexes(i.timeScale())}items(){return this._items}renderer(){return this._isPlotVisible()&&this._scalesReady()?(this._makeSureRendererIsValid(),this._renderer):null}_isPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&null!==t&&!e.isEmpty()&&!t.isEmpty()}_updateImplFull(e){var t;if((null===(t=this._dataInvalidated)||void 0===t?void 0:t.clearData)&&(this._items=[],this._renderer=null),!this._scalesReady())return!1;const i=this._model.timeScale(),s=this._priceScale(),r=i.visibleBarsStrictRange();if(null===r||null===s)return!1;const n=this._study.plots().plottableRange(!1);if(0===n.size())return!1;const l=this._study.offset(this._plotName),a=this._study.firstValue(void 0,this.isForceOverlay());if(null===a)return!1;this._updateAdditionalPrices(s,a)
;const{hiPlot:h,loPlot:u}=this._hiLoPlots(),d=this._preallocateItems(n,((e,t)=>this._createItem(e,null!=t?t:null,h,u,l)));let c=this._series.nearestIndex(r.firstBar(),O.PlotRowSearchMode.NearestRight),p=this._series.nearestIndex(r.lastBar(),O.PlotRowSearchMode.NearestLeft);if(void 0===c||void 0===p)return!1;l>0?(c-=l,p+=l):(c+=l,p-=l);const _=this._study.getMinFirstBarIndexForPlot(this._plotName);if(_>p)return!0;c=Math.max(_,c);const f=this._getTranspValue(),m=this._study.properties().childs().styles.childs()[this._plotName].childs(),y=m.color.value(),v=m.textColor?m.textColor.value():void 0,g=y,S=y,b=void 0===v?void 0:v,I=(0,o.ensureNotNull)(this._plotIndex),P=(0,Ae.createEmptyStyle)(),w=null!=d?d:(0,o.ensureNotNull)(n.firstIndex()),C=n.rangeIterator(w,(0,o.ensureNotNull)(n.lastIndex())+1);let V=(0,K.lowerbound)(this._items,w+l,((e,t)=>e.timePointIndex<t));for(const e of C){const t=e.value,i=t[I+1];if(null==i){V++;continue}const s=this._items[V];if(!isNaN(s.origPrices.price)){if(this._colorProvider.isColorDefined()){s.style={color:g,borderColor:S,textColor:b};const e=this._colorProvider.getPlotPointStyle(t,P);this._fillItemWithPointStyle(s,e,f)}}V++}return this._updateImplLight(),!0}_fillItemWithPointStyle(e,t,i){const s=(0,o.ensureDefined)(e.style);if(void 0!==t.colors[0]){s.color=(0,C.generateColor)((0,o.ensureDefined)(t.colors[0]),i);const e=i>9?i-10:0;s.borderColor=(0,C.generateColor)(s.color,e)}void 0!==t.colors[2]&&(s.textColor=(0,C.generateColor)((0,o.ensureDefined)(t.colors[2]),i))}_updateRenderer(e,t){this._makeSureRendererIsValid();const i=this._model.timeScale(),s={},r=this._getTranspValue(),n=i.barSpacing(),o=this._calculateShapeHeight(n),l=this._study.properties().childs().styles.childs()[this._plotName].childs(),a=l.location.value(),h=this._calculateVerticalOffset(a,o+o/2);s.barSpacing=n,s.items=this._items,s.color=(0,C.generateColor)(l.color.value(),r),s.height=o,s.vertOffset=h,s.visibleItemsRange={startItemIndex:e,endItemIndex:t};const u=l.plottype.value(),d=we.plotShapesData[u],c=new ye.CompositeRenderer;d&&(this._shapesRenderer?this._shapesRenderer.setData(s):(this._shapesRenderer=this._createRenderer(d.paneRendererClass,s),c.append(this._shapesRenderer))),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=h,c.append(new Pe.SelectionRenderer(this._selectionData))),this._renderer=c}_createRenderer(e,t){const i=Le.get(e);return new((0,o.ensureDefined)(i))(t)}_getSeriesVal(e,t){const i=(0,xe.barFunction)(e),s=this._series.data().valueAt(t);return null===s?null:i(s)}_getTranspValue(){let e=0;const t=this._study.properties().childs();t.transparency&&(e=t.transparency.value(),e=(0,W.isNumber)(e)?e:50);const i=t.styles.childs()[this._plotName].childs();return i.transparency&&(e=i.transparency.value(),e=(0,W.isNumber)(e)?e:50),(0,Ce.clamp)(e,0,100)}_createItem(e,t,i,s,r){const n=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),l={origPrices:{price:NaN},timePointIndex:e+r}
;if((null===t||0===t)&&n!==N.MarkLocation.Absolute)return l;if(null==t)return l;let a=NaN;switch(n){case N.MarkLocation.AboveBar:{const t=this._getLocationPrice(e,i,r);if(null===t)return l;a=t;break}case N.MarkLocation.BelowBar:{const t=this._getLocationPrice(e,s,r);if(null===t)return l;a=t;break}case N.MarkLocation.Absolute:a=(0,o.ensureNotNull)(t);break;case N.MarkLocation.Top:case N.MarkLocation.Bottom:a=0;break;default:throw new Error("Bad value: "+n)}return{y:NaN,origPrices:{price:a},timePointIndex:e+r}}_dependsOnSeriesData(){const e=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();return e===N.MarkLocation.AboveBar||e===N.MarkLocation.BelowBar}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(null==t)return null;const i=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();if(0===t&&i!==N.MarkLocation.Absolute)return null;const s=this._study.offset(this._plotName),{hiPlot:r,loPlot:n}=this._hiLoPlots();switch(i){case N.MarkLocation.AboveBar:return this._getLocationPrice(e.index,r,s);case N.MarkLocation.BelowBar:return this._getLocationPrice(e.index,n,s)}return super._getValueForUpdating(e)}_convertItemsToCoordinates(e,t,i,s){for(let e=i;e<s;e++){const t=this._items[e];t.y=t.origPrices.price}this._model.timeScale().fillBarBorders(this._items);const r=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),n=e.height()*e.topMargin(),o=e.height()*(1-e.bottomMargin()),l=e.isInverted(),a=l?o:n,h=l?n:o,u=e=>{for(let t=i;t<s;t++)isNaN(this._items[t].y)||(this._items[t].y=e)};switch(r){case N.MarkLocation.Top:u(a);break;case N.MarkLocation.Bottom:u(h);break;default:e.pointsArrayToCoordinates(this._items,t,{startItemIndex:i,endItemIndex:s})}}_calculateVerticalOffset(e,t){let i=0;switch(e){case N.MarkLocation.AboveBar:case N.MarkLocation.Bottom:i=-t;break;case N.MarkLocation.BelowBar:case N.MarkLocation.Top:i=t}return(0,o.ensureNotNull)(this._priceScale()).isInverted()&&(i*=-1),i}_calculateShapeHeight(e,t){let i=e;switch(t){case B.PlotSymbolSize.Tiny:i=.3*e;break;case B.PlotSymbolSize.Small:i=.6*e;break;case B.PlotSymbolSize.Normal:i=e;break;case B.PlotSymbolSize.Large:i=1.5*e;break;case B.PlotSymbolSize.Huge:i=2*e}return i}_hiLoPlots(){let e,t;let i=null;switch(this._series.properties().childs().style.value()){case 2:i="lineStyle";break;case 14:i="lineWithMarkersStyle";break;case 15:i="steplineStyle";break;case 3:i="areaStyle"}return i?(e=this._series.properties().childs()[i].childs().priceSource.value(),t=e):(e="high",t="low"),{hiPlot:e,loPlot:t}}_getLocationPrice(e,t,i){const s=Math.min(e+i,(0,o.ensureNotNull)(this._series.data().last()).index);return this._getSeriesVal(t,s)}}class Ue extends He{_updateRenderer(e,t){var i;const s=this._study.properties().childs().styles.childs()[this._plotName].childs(),r=this._model.timeScale(),n={},o=this._getTranspValue(),l=r.barSpacing();let a;a=this._plotStyleInfo.size?this._calculateShapeHeight(25,this._plotStyleInfo.size):Math.round(l/2),
a=Math.max(a,1);const h=s.location.value(),d=(0,C.generateColor)(s.color.value(),o),c=o>19?o-10:0,p=this._calculateVerticalOffset(h,Math.round(1.5*a));n.barSpacing=l,n.items=this.items(),n.color=d,n.borderColor=(0,C.generateColor)(s.color.value(),c),n.height=a,n.vertOffset=p,n.visibleItemsRange={startItemIndex:e,endItemIndex:t};const _=s.plottype.value(),f=we.plotShapesData[_],m=this._plotStyleInfo.text;if(void 0!==m&&""!==m.trim()){let e=m.trim().replace(/\\n/gm,"\n");e=(0,u.cleanButAmpersand)(e,!0),n.text=e,n.fontSize=12;const t=s.textColor?s.textColor.value():void 0;n.textColor=t?(0,C.generateColor)(t,o):d}if(this._renderer&&this._shapesRenderer&&this._selectionRenderer)this._shapesRenderer.setData(n),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?(this._selectionData.vertOffset=p,this._selectionRenderer.setData(this._selectionData)):this._selectionRenderer.setData(null);else{const e=new ye.CompositeRenderer;this._shapesRenderer=super._createRenderer(f.paneRendererClass,n),e.append(this._shapesRenderer),this._selectionRenderer=new Pe.SelectionRenderer(null!==(i=this._selectionData)&&void 0!==i?i:void 0),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?this._selectionData.vertOffset=p:this._selectionRenderer.setData(null),e.append(this._selectionRenderer),this._renderer=e}}}var Ge=i(687795),ze=i.n(Ge),je=i(86441),We=i(916403),$e=i(509078),Ke=i(286436),qe=i(511275),Ye=i(682995);class Je extends We.PaneRendererAbstractShape{constructor(e,t){super(null,t),this._fontSizeEnsured=0,this._ch="",this._fontFamily=qe.CHART_FONT_FAMILY,this._charCache=null,null!==e&&this.setData(e)}setData(e){super.setData(e),this._fontSizeEnsured=(0,o.ensureDefined)(this._height);const t=e.char.slice(0,40);this._ch=ze()(t)[0]||" ",this._fontFamily=e.fontFamily||qe.CHART_FONT_FAMILY}hitTest(e){const t=(0,Ke.interactionTolerance)().series+this._fontSizeEnsured/2;for(const i of this._items){if(new je.Point(i.center,i.y+i.vertOffset).subtract(e).length()<=t)return new $e.HitTestResult($e.HitTarget.Regular)}return null}_drawItemShape(e,t){const i=t.center,s=t.vertOffset>0?1:-1,r=t.y+t.vertOffset-s*Math.round(this._fontSizeEnsured/2);let n;n=t.style&&void 0!==t.style.color?t.style.color:this._color;const o=this._textImageCache(),{context:l,horizontalPixelRatio:a,verticalPixelRatio:h}=e;if(this._fontSizeEnsured<=4/a){l.save();const e=Math.max(1,Math.floor(a));let s=Math.max(1,Math.floor(o.textImageWidth*a));s%2!=e%2&&(s+=s>1?-1:1);const u=Math.round(r*h)+(t.vertOffset>=0?0:-s);return l.fillStyle=n,l.fillRect(Math.round(i*a)+(a%2?.5:0)-s/2,u,s,s),void l.restore()}const u={style:{fillStyle:n},location:{x:i,y:r,horzAlign:Ye.HorizontalAlign.Center,vertAlign:t.vertOffset>0?Ye.VerticalAlign.Top:Ye.VerticalAlign.Bottom}};o.paintTo(e,u)}_startPath(e,t,i){}_endPath(e){}_textImageCache(){return null!==this._charCache&&this._charCache.fontFamily===this._fontFamily&&this._charCache.fontSize===this._fontSizeEnsured||(this._charCache={
fontSize:this._fontSizeEnsured,fontFamily:this._fontFamily,cache:new Ye.TextImageCache(this._ch,!1,!1,this._fontFamily,this._fontSizeEnsured,"center",0)}),this._charCache.cache}}class Xe extends He{constructor(){super(...arguments),this._charRenderer=new Je(null)}_updateRenderer(e,t){var i,s;const r=this._getTranspValue(),n=this._model.timeScale().barSpacing();let l;const a=this._study.properties().childs().styles.childs()[this._plotName].childs();l=this._plotStyleInfo.size?this._calculateShapeHeight(50,this._plotStyleInfo.size):Math.round(n);const h=a.location.value(),d=(0,C.generateColor)(a.color.value(),r),c=this._calculateVerticalOffset(h,l),p={items:this.items(),barSpacing:n,char:(0,o.ensureDefined)(null!==(s=null===(i=a.char)||void 0===i?void 0:i.value())&&void 0!==s?s:this._plotStyleInfo.char),height:l,vertOffset:c,color:d,visibleItemsRange:{startItemIndex:e,endItemIndex:t}},_=this._plotStyleInfo.text;if(void 0!==_&&""!==_.trim()){let e=_.trim().replace(/\\n/gm,"\n");e=(0,u.cleanButAmpersand)(e,!0),p.text=e,p.fontSize=12;const t=a.textColor?a.textColor.value():void 0;p.textColor=t?(0,C.generateColor)(t,r):d}this._charRenderer.setData(p);const f=new ye.CompositeRenderer;f.append(this._charRenderer),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=c,f.append(new Pe.SelectionRenderer(this._selectionData))),this._renderer=f}}var Ze=i(724377);class Qe{constructor(e,t,i,s,r){this.left=NaN,this.right=NaN,this.height=NaN,this.center=e,this.y=t,this.origHeight=i,this.isUp=s,this.origPrices=r,this.timePointIndex=e,this.style={}}}function et(e){return Math.round(e/4)}function tt(e){return Math.round(e/2)}class it extends ve.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){var t,i,s,r;const n=this._data,o=tt(n.barSpacing),l=Math.round(o/2),a=Math.round(o),h=et(n.barSpacing),u=null!==(i=null===(t=n.visibleItemsRange)||void 0===t?void 0:t.startItemIndex)&&void 0!==i?i:0,d=null!==(r=null===(s=n.visibleItemsRange)||void 0===s?void 0:s.endItemIndex)&&void 0!==r?r:n.items.length;if(u>=d)return null;for(const t of n.items.slice(u,d)){if(!t)continue;if(!Number.isFinite(t.center)||!Number.isFinite(t.y))continue;const i=Math.abs(t.height),s=t.isUp?-1:1,r=i+a,n=t.y-s*h,o=n-s*r,u=t.center-l,d=t.center+l;if(u<e.x&&e.x<d&&(t.isUp?n<e.y&&e.y<o:o<e.y&&e.y<n))return new $e.HitTestResult($e.HitTarget.Regular)}return null}_drawImpl(e){var t,i,s,r,n;const{horizontalPixelRatio:o,verticalPixelRatio:l,context:a}=e,h=this._data,u=tt(h.barSpacing),d=et(h.barSpacing),c=u<4,p=Math.max(u/2,1),_=(0,Ce.ceiledEven)(u*o),f=_/2,m=Math.round(u*l);a.lineCap="butt",a.lineWidth=Math.max(1,Math.floor(o));const y=a.lineWidth%2?.5:0,v=null!==(i=null===(t=h.visibleItemsRange)||void 0===t?void 0:t.startItemIndex)&&void 0!==i?i:0,g=null!==(r=null===(s=h.visibleItemsRange)||void 0===s?void 0:s.endItemIndex)&&void 0!==r?r:h.items.length;if(!(v>=g))for(const e of h.items.slice(v,g)){if(!Number.isFinite(e.center)||!Number.isFinite(e.y))continue
;const t=e.isUp?-1:1,i=Math.round(Math.abs(e.height)*l),s=Math.round(e.center*o)+y,r=Math.round((e.y-t*d)*l)+y;a.beginPath(),a.translate(s,r);const u=null!==(n=e.style&&e.style.color)&&void 0!==n?n:e.isUp?h.colorup:h.colordown;c?(a.moveTo(0,0),a.lineTo(-f,-f*t),a.moveTo(0,0),a.lineTo(f,-f*t),a.moveTo(0,0),a.lineTo(0,-i*t),a.moveTo(-f,-i*t),a.lineTo(f,-i*t),a.lineWidth=p,a.strokeStyle=u,a.stroke()):(a.moveTo(0,0),i<m?(a.lineTo(_,-i*t),a.lineTo(-_,-i*t)):(a.lineTo(_,-m*t),a.lineTo(f,-m*t),a.lineTo(f,-i*t),a.lineTo(-f,-i*t),a.lineTo(-f,-m*t),a.lineTo(-_,-m*t)),a.lineTo(0,0),a.strokeStyle=e.isUp?h.colorBorderUp:h.colorBorderDown,a.stroke(),a.fillStyle=u,a.fill()),a.translate(-s,-r)}}}class st extends Pe.SelectionRenderer{_drawMarker(e,t,i,s){const{context:r,horizontalPixelRatio:n,verticalPixelRatio:l}=e,a=(0,o.ensureNotNull)(this._data),h=t.isUp?1:-1;const u=i+h*et(a.barSpacing)+h*tt(a.barSpacing);let d=Math.round(3.5*n*2);d%2!=s%2&&(d+=1);const c=s%2/2,p=Math.round(t.center*n)+c,_=Math.round((t.y+u)*l)+c;r.beginPath(),r.arc(p,_,d/2,0,2*Math.PI,!0),r.closePath(),r.fill(),r.stroke()}}class rt extends He{_updateRenderer(e,t){const i=this._study.properties().childs().styles.childs()[this._plotName].childs(),s=(0,Ce.clamp)(this._getTranspValue(),0,100),r=this._model.timeScale().barSpacing(),n=(0,C.generateColor)(i.colorup.value(),s),o=(0,C.generateColor)(i.colordown.value(),s),l=(0,Ze.parseRgba)(n),a=l?100*(1-l[3]):0,h=(0,Ze.parseRgba)(o),u=h?100*(1-h[3]):0,d={items:this._items,barSpacing:r,colorup:n,colordown:o,colorBorderUp:(0,C.generateColor)("#000000",a),colorBorderDown:(0,C.generateColor)("#000000",u),minHeight:this._plotStyleInfo.minHeight,visibleItemsRange:{startItemIndex:e,endItemIndex:t}};this._updateItemsHeights(d);const c=new ye.CompositeRenderer;if(c.append(new it(d)),this._model.selection().isSelected(this._study)&&null!==this._selectionData){const e=this._selectionData;e.barSpacing=r,c.append(new st(e))}this._renderer=c}_fillItemWithPointStyle(e,t,i){const s=(0,o.ensureDefined)(e.style);e.isUp?void 0!==t.colors[5]?s.color=(0,C.generateColor)((0,o.ensureDefined)(t.colors[5]),i):s.color=(0,C.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colorup.value(),i):void 0!==t.colors[6]?s.color=(0,C.generateColor)((0,o.ensureDefined)(t.colors[6]),i):s.color=(0,C.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colordown.value(),i)}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(!t)return null;const i=e.index,s=t>0,{hiPlot:r,loPlot:n}=this._hiLoPlots(),l=this._study.offset(this._plotName),a=Math.min(i+l,(0,o.ensureNotNull)(this._series.data().last()).index);if(s){const e=this._getSeriesVal(n,a);if(null!==e)return e}else{const e=this._getSeriesVal(r,a);if(null!==e)return e}return null}_updateItem(e,t){const i=this._getValueForUpdating(e),s=e.value[this._plotIndex+1]>0;return this._items[t].origPrices.price=null!=i?i:NaN,this._items[t].isUp=s,t+1}_createItem(e,t,i,s,r){const n={center:NaN,y:NaN,origPrices:{price:NaN,
timePointIndex:NaN},origHeight:NaN};if(n.timePointIndex=e+r,!t)return n;const l=Math.min(e+r,(0,o.ensureNotNull)(this._series.data().last()).index),a=t>0;let h;if(a){const e=this._getSeriesVal(s,l);if(null===e)return n;h=e}else{const e=this._getSeriesVal(i,l);if(null===e)return n;h=e}return new Qe(e+r,h,t,a,{price:h,timePointIndex:e+r})}_dependsOnSeriesData(){return!0}_convertItemsToCoordinates(e,t,i,s){this._convertItemsToCoordinatesImpl(e,t,i,s)}_updateItemsHeights(e){var t,i,s,r,n,l,a,h;const u=this._study.properties().childs().styles.childs();let d=Math.abs((0,o.ensureDefined)(null!==(i=null===(t=u[this._plotName].childs().minHeight)||void 0===t?void 0:t.value())&&void 0!==i?i:this._plotStyleInfo.minHeight)),c=Math.abs((0,o.ensureDefined)(null!==(r=null===(s=u[this._plotName].childs().maxHeight)||void 0===s?void 0:s.value())&&void 0!==r?r:this._plotStyleInfo.maxHeight));if(d>c){const e=d;d=c,c=e}const p=this._items,_=null!==(l=null===(n=e.visibleItemsRange)||void 0===n?void 0:n.startItemIndex)&&void 0!==l?l:0,f=(null!==(h=null===(a=e.visibleItemsRange)||void 0===a?void 0:a.endItemIndex)&&void 0!==h?h:p.length)-1;let m=0;for(let e=_;e<=f;e++){const t=p[e],i=Math.abs(t.origHeight);i>m&&(m=i)}const y=(c-d)/m;for(let e=_;e<=f;e++){const t=p[e],i=Math.abs(t.origHeight);t.height=i*y+d}}}var nt=i(449524);class ot extends be.StudyForceOverlayPlotView{constructor(e,t,i,s){super(t,i,s),this._bars=[],this._invalidated=!1,this._isMarkersEnabled=me.enabled("source_selection_markers"),this._selectionData=null,this._ohlcPlotIndexes=new Map,this._study=e,this._isMarkersEnabled=me.enabled("source_selection_markers"),this._colorProvider=(0,Se.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),s),this._selectionIndexer=new Ve.SelectionIndexes(i.timeScale());const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];"target"in t&&(t.target===this._plotName&&((0,B.isOhlcOpenPlot)(t)&&this._ohlcPlotIndexes.set(1,e),(0,B.isOhlcHighPlot)(t)&&this._ohlcPlotIndexes.set(2,e),(0,B.isOhlcLowPlot)(t)&&this._ohlcPlotIndexes.set(3,e),(0,B.isOhlcClosePlot)(t)&&this._ohlcPlotIndexes.set(4,e)))}}update(){this._invalidated=!0}items(){return this._bars}_updateImpl(){this._bars.length=0;const e=this._priceScale();if(this._model.timeScale().isEmpty()||null===e||e.isEmpty())return;const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return;let i=this._series.nearestIndex(t.firstBar(),O.PlotRowSearchMode.NearestRight);const s=this._series.nearestIndex(t.lastBar(),O.PlotRowSearchMode.NearestLeft);if(void 0===i||void 0===s)return;const r=this._study.getMinFirstBarIndexForPlot(this._plotName);if(r>s)return;i=Math.max(r,i);const n=this._study.data(),l=this._study.firstValue(void 0,this.isForceOverlay());if(null===l)return;const a=n.rangeIterator(i,s),h=(0,o.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),u=new Map,d=(e,t)=>{const i=e+"@"+t;if(!u.has(i)){const s=(0,C.generateColor)(e,t);return u.set(i,s),s}return u.get(i)},c=(0,Ae.createEmptyStyle)();for(const e of a){
let t=e.index;const i=e.value;t=Math.floor(t);let s=!0;const r=new Map;for(let e=1;e<=4;++e){const t=this._ohlcPlotIndexes.get(e);if(void 0===t){s=!1;break}const n=i[t+1];if(null==n){s=!1;break}r.set(e,n)}if(!s)continue;const n=(0,o.ensureDefined)(r.get(1)),l=(0,o.ensureDefined)(r.get(4)),a=(0,o.ensureDefined)(r.get(2)),u=(0,o.ensureDefined)(r.get(3)),p=Math.max(n,a,u,l),_=Math.min(n,a,u,l);let f=(0,o.ensureDefined)(d(h.color.value(),0));const m=this._colorProvider.getPlotPointStyle(i,c);void 0!==m.colors[0]&&(f=(0,o.ensureDefined)(m.colors[0]));const y={open:n,high:p,low:_,close:l,color:f,wickColor:m.colors[4],borderColor:m.colors[3],hollow:null,center:NaN,left:NaN,right:NaN,timePointIndex:Math.round(t)};this._bars.push(y)}if(e.barPricesToCoordinates(this._bars,l),this._model.timeScale().fillBarBorders(this._bars),this._model.selection().isSelected(this._study)){const t=this._selectionIndexer.indexes();this._selectionData={points:[],hittestResult:$e.HitTarget.Regular,bgColors:[],visible:!0,barSpacing:this._model.timeScale().barSpacing()};const i=(0,o.ensureNotNull)(this._model.paneForSource(this._study)).height(),s=(0,o.ensureDefined)(this._ohlcPlotIndexes.get(4));for(let r=0;r<t.length;r++){const n=t[r],o=this._study.data().valueAt(n);if(null===o)continue;const a=o[s+1];if(null==a)continue;const h=this._model.timeScale().indexToCoordinate(Math.floor(n)),u=e.priceToCoordinate(a,l);this._selectionData.points.push(new je.Point(h,u)),this._selectionData.bgColors.push(this._model.backgroundColorAtYPercentFromTop(u/i))}}else this._selectionIndexer.clear()}_isOHLCPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}}class lt extends ot{renderer(){if(!this._isOHLCPlotVisible())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,dontDrawOpen:this._series.properties().childs().barStyle.childs().dontDrawOpen.value(),thinBars:this._series.properties().childs().barStyle.childs().thinBars.value()},t=new ye.CompositeRenderer;return t.append(new nt.PaneRendererBars(e)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&t.append(new Pe.SelectionRenderer(this._selectionData)),t}}var at=i(559327);class ht extends ot{renderer(){if(!this._isOHLCPlotVisible())return null;const e=this._priceScale();if(!e||e.isEmpty())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const t=(0,o.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),i=this._model.timeScale().barSpacing(),s={bars:this._bars,barSpacing:i,wickVisible:t.drawWick.value(),bodyVisible:!0,borderVisible:t.drawBorder.value(),barWidth:(0,Ke.optimalBarWidth)(i),borderColor:t.borderColor.value(),wickColor:t.wickColor.value(),isPriceScaleInverted:e.isInverted()},r=new ye.CompositeRenderer;return r.append(new at.PaneRendererCandles(s)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&r.append(new Pe.SelectionRenderer(this._selectionData)),r}}
var ut=i(95370),dt=i(703614),ct=i(345159),pt=i(666574);class _t extends ct.HorizontalLinePaneView{constructor(e,t){super(),this._lineRendererData.linestyle=pt.LINESTYLE_DOTTED,this._study=e,this._plotName=t}_updateImpl(){this._lineRendererData.visible=!1;const e=this._study.properties().childs().styles.childs()[this._plotName].childs();if(!e.trackPrice.value()||!this._study.isPlotVisibleAt(this._plotName,1))return;const t=this._study.lastValueData(this._plotName,!0);t.noData||(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=t.color,this._lineRendererData.linewidth=e.linewidth.value())}}var ft=i(512230),mt=i(19932),yt=i(781298);const vt={type:0,color:"transparent"};class gt extends yt.AbstractFilledAreaPaneView{constructor(e,t,i,s){var r,n,l;super(e,t,i),this._palettesInfo={},this._gradientPropsStateCache=null,this._rgbaFromInteger=(0,mt.rgbaFromIntegerCached)();const a=this._source.metaInfo();this._isRGB=Boolean(a.isRGB),this._isHlineFill="hline_hline"===i.type,(0,o.assert)(this._isHlineFill||"plot_plot"===i.type,"Wrong filledArea type: "+i.type),this._isHlineFill&&this._initBandIndexes(i.objAId,i.objBId),this._fillMetaInfo=i,this._fillStyleProps=s,this._gradientFillType=s.hasChild("fillType")&&"gradient"===(null===(r=s.childs().fillType)||void 0===r?void 0:r.value()),this._gradientStaticState={color1:i.topColor,color2:i.bottomColor,value1:i.topValue,value2:i.bottomValue},this._hasAllGradientRequiredProps=this._gradientFillType&&(void 0!==this._gradientStaticState.color1||s.hasChild("topColor")||void 0!==this._gradientStaticState.color2||s.hasChild("bottomColor"))&&(void 0!==this._gradientStaticState.value1||s.hasChild("topValue"))&&(void 0!==this._gradientStaticState.value2||s.hasChild("bottomValue"));const h=()=>{var e;return this._colorPlotIndex=null!==(e=this._colorPlotIndex)&&void 0!==e?e:{type:1}};for(let t=0;t<a.plots.length;++t){const s=a.plots[t];if(((0,B.isColorerPlot)(s)||(0,B.isDataPlot)(s))&&s.target===i.id){if((0,B.isColorerPlot)(s)){let i;void 0!==s.targetField?"topColor"===s.targetField?(h().colorIndexOrRgba1=t,i="color1"):"bottomColor"===s.targetField&&(h().colorIndexOrRgba2=t,i="color2"):this._colorPlotIndex={type:0,colorIndexOrRgba:t},(0,B.isPaletteColorerPlot)(s)&&(this._palettesInfo[null!=i?i:"color"]={map:(0,o.ensureDefined)(null===(n=(0,o.ensureDefined)(a.palettes)[s.palette])||void 0===n?void 0:n.valToIndex),values:e.properties().palettes[s.palette].colors})}else(0,B.isDataPlot)(s)&&("topValue"===s.targetField?h().valueIndex1=t:"bottomValue"===s.targetField&&(h().valueIndex2=t));if(0===(null===(l=this._colorPlotIndex)||void 0===l?void 0:l.type))break}}}update(e){super.update(e),this._gradientPropsStateCache=null}isForceOverlay(){return!!this._source.metaInfo().isPlotForceOverlay(this._plotAId())}_firstValue(){const e=this.isForceOverlay();return this._source.firstValue(void 0,e)}_minFirstBarIndex(){return this._source.getMinFirstBarIndexForPlot(this._fillMetaInfo.id)}_getColorByPlotValue(e){var t,i,s;if(0===e.type){let i
;if(null==e.colorIndexOrRgba)return null;if(this._isRGB)i=this._rgbaFromInteger(e.colorIndexOrRgba);else{const s=(0,o.ensureDefined)(this._palettesInfo.color),r=(0,o.ensureDefined)(s.map[e.colorIndexOrRgba]);i=null===(t=s.values[r])||void 0===t?void 0:t.childs().color.value()}return{type:0,color:i}}const r=this._gradientColorPropsState();let n,l;if(this._isRGB)null!=e.colorIndexOrRgba1&&(n=this._rgbaFromInteger(e.colorIndexOrRgba1)),null!=e.colorIndexOrRgba2&&(l=this._rgbaFromInteger(e.colorIndexOrRgba2));else{if(null!=e.colorIndexOrRgba1){const t=(0,o.ensureDefined)(this._palettesInfo.color1);n=t.values[(0,o.ensureDefined)(t.map[e.colorIndexOrRgba1])].childs().color.value()}if(null!=e.colorIndexOrRgba2){const t=(0,o.ensureDefined)(this._palettesInfo.color2);l=t.values[(0,o.ensureDefined)(t.map[e.colorIndexOrRgba2])].childs().color.value()}}const a=null!==(i=e.value1)&&void 0!==i?i:r.value1,h=null!==(s=e.value2)&&void 0!==s?s:r.value2;return n=null!=n?n:r.color1,l=null!=l?l:r.color2,void 0===a||void 0===h||void 0===n&&void 0===l?null:{type:1,color1:n,color2:l,value1:a,value2:h,coordinate1:NaN,coordinate2:NaN}}_plotAId(){return this._fillMetaInfo.objAId}_plotBId(){return this._fillMetaInfo.objBId}_commonColor(){const e=this._fillStyleProps.childs();if(this._gradientFillType){if(!this._hasAllGradientRequiredProps)return vt;const e=this._gradientColorPropsState();return{type:1,color1:e.color1,color2:e.color2,value1:e.value1,value2:e.value2,coordinate1:NaN,coordinate2:NaN}}return{type:0,color:e.color.value()}}_transparency(){var e,t;return null!==(t=null===(e=this._fillStyleProps.childs().transparency)||void 0===e?void 0:e.value())&&void 0!==t?t:0}_visible(){return this._fillStyleProps.childs().visible.value()}_priceScale(){return this.isForceOverlay()?this._model.mainSeries().priceScale():this._source.priceScale()}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;const i=this._source.metaInfo().bands;if(void 0!==i)for(let s=0;s<i.length;++s){const r=i[s];null!==this._bandAKey||r.id!==e?null===this._bandBKey&&r.id===t&&(this._bandBKey=s):this._bandAKey=s}}_gradientColorPropsState(){var e,t,i,s;if(null===this._gradientPropsStateCache){const r=this._fillStyleProps.state();this._gradientPropsStateCache={color1:null!==(e=this._gradientStaticState.color1)&&void 0!==e?e:r.topColor,color2:null!==(t=this._gradientStaticState.color2)&&void 0!==t?t:r.bottomColor,value1:null!==(i=this._gradientStaticState.value1)&&void 0!==i?i:r.topValue,value2:null!==(s=this._gradientStaticState.value2)&&void 0!==s?s:r.bottomValue}}return this._gradientPropsStateCache}}var St=i(193938),bt=i(467841);class It{constructor(e,t){this._invalidated=!0,this._lineRenderer=new bt.HorizontalLineRenderer,this._source=t,this._points=[new je.Point(-1,-1)],this._invalidated=!0,this._properties=e}update(){this._invalidated=!0}renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={y:this._points[0].y,color:this._properties.childs().color.value(),linewidth:this._properties.childs().linewidth.value(),
linestyle:this._properties.childs().linestyle.value()};return this._lineRenderer.setData(e),this._lineRenderer}_updateImpl(){const e=this._source.priceScale();if(!e||e.isEmpty())return void(this._points[0]=new je.Point(-1,-1));const t=this._properties.childs().value.value(),i=this._source.firstValue(),s=(0,W.isNumber)(t)&&null!==i?e.priceToCoordinate(t,i):NaN;this._points[0]=new je.Point(-1,s)}}var Pt=i(367637);class wt extends Pt.MediaCoordinatesPaneRenderer{constructor(){super(),this._data=null,this._data=null}setData(e=null){this._data=e}hitTest(){return null}_drawImpl(e){var t,i;if(null===this._data||0===this._data.points.length)return;const s=e.context,r=e.mediaSize.width;if(this._data.gradient){const e=s.createLinearGradient(0,this._data.coordinate1,0,this._data.coordinate2);e.addColorStop(0,null!==(t=this._data.backColor1)&&void 0!==t?t:"transparent"),e.addColorStop(1,null!==(i=this._data.backColor2)&&void 0!==i?i:"transparent"),s.fillStyle=e}else s.fillStyle=this._data.backcolor;const n=Math.min(this._data.points[0],this._data.points[1]),o=Math.max(this._data.points[0],this._data.points[1]);s.fillRect(0,n,r,o-n)}}class Ct{constructor(e){this._bandBgRenderer=new wt,this._invalidated=!0,this._source=e}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){var e,t;this._bandBgRenderer.setData(null);const i=this._source.properties().childs(),s=i.bands;if(s.childCount()<2)return;const r=i.bandsBackground;if(!(null==r?void 0:r.childs().fillBackground.value()))return;const n=s[0].childs(),l=s[1].childs(),a=this._source.priceScale(),h=this._source.firstValue();if(!a||a.isEmpty()||null===h)return;const u=[a.priceToCoordinate(n.value.value(),h),a.priceToCoordinate(l.value.value(),h)],d=(0,o.ensureDefined)(i.bandsBackground).childs(),c=(0,Ce.clamp)(null!==(t=null===(e=d.transparency)||void 0===e?void 0:e.value())&&void 0!==t?t:0,0,100);this._bandBgRenderer.setData({gradient:!1,points:u,backcolor:(0,C.generateColor)(d.backgroundColor.value(),c)})}}class Vt{constructor(e,t,i){var s;this._bandBgRenderer=new wt,this._bandAKey=null,this._bandBKey=null,this._invalidated=!0,this._source=e,(0,o.assert)("hline_hline"===t.type,"Wrong filledArea type: "+t.type),this._initBandIndexes(t.objAId,t.objBId),this._fillStyleProps=i,this._bandBgRenderer=new wt,this._gradientFillType=i.hasChild("fillType")&&"gradient"===(null===(s=i.childs().fillType)||void 0===s?void 0:s.value()),this._gradientStaticState={color1:t.topColor,color2:t.bottomColor,value1:t.topValue,value2:t.bottomValue}}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){var e,t,i,s,r,n,l,a,h,u;if(this._bandBgRenderer.setData(null),!this._fillStyleProps.childs().visible.value())return;if(null===this._bandAKey||null===this._bandBKey)return;const d=(0,
o.ensureDefined)(this._source.properties().childs().bands),c=d.childs()[this._bandAKey].childs(),p=d.childs()[this._bandBKey].childs(),_=this._source.priceScale(),f=this._source.firstValue();if(!_||_.isEmpty()||null===f)return;const m=[_.priceToCoordinate(c.value.value(),f),_.priceToCoordinate(p.value.value(),f)],y=(0,Ce.clamp)(null!==(t=null===(e=this._fillStyleProps.childs().transparency)||void 0===e?void 0:e.value())&&void 0!==t?t:0,0,100);let v;const g=this._fillStyleProps.childs();if(this._gradientFillType){const e=this._gradientStaticState,t=g,o=null!==(i=e.value1)&&void 0!==i?i:null===(s=t.topValue)||void 0===s?void 0:s.value(),d=null!==(r=e.value2)&&void 0!==r?r:null===(n=t.bottomValue)||void 0===n?void 0:n.value();if(void 0===o||void 0===d)return;const c=null!==(l=e.color1)&&void 0!==l?l:null===(a=t.topColor)||void 0===a?void 0:a.value(),p=null!==(h=e.color2)&&void 0!==h?h:null===(u=t.bottomColor)||void 0===u?void 0:u.value();if(void 0===c&&void 0===p)return;v={gradient:!0,points:m,backColor1:c&&(0,C.generateColor)(c,y),backColor2:p&&(0,C.generateColor)(p,y),coordinate1:_.priceToCoordinate(o,f),coordinate2:_.priceToCoordinate(d,f)}}else v={gradient:!1,points:m,backcolor:(0,C.generateColor)(g.color.value(),y)};this._bandBgRenderer.setData(v)}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;(0,o.ensureDefined)(this._source.metaInfo().bands).forEach(((i,s)=>{null===this._bandAKey&&i.id===e&&(this._bandAKey=s),null===this._bandBKey&&i.id===t&&(this._bandBKey=s)}))}}var xt=i(757402),At=i(412788),Rt=i(219849),Mt=i(169532),Tt=i(375397),Dt=i(643322),Ot=i(975179),Nt=i(546821),Ft=i(125624),kt=i(336928),Bt=i(200441);class Et extends Bt.AbstractBarColorer{constructor(e,t){super(),this._rgbaFromInteger=(0,mt.rgbaFromIntegerCached)(),this._study=e,this._plotIndex=t}applyBarStyle(e,t,i,s){var r;if(t)return i;const n=this._study.properties().childs();if(!n.visible.value())return i;const l=this._study.metaInfo(),a=this._study.data();if(!a||0===a.size())return i;const h=l.plots[this._plotIndex],u=this._getOffset();if(this._study.getMinFirstBarIndexForPlot(h.id)>e+u)return i;if(0===n.styles.childs()[h.id].childs().display.value())return i;const d=a.valueAt(e-u);if(null===d)return i;let c=d[this._plotIndex+1];if(null==c)return i;if(c=Math.round(c),l.isRGB)i.barColor=this._rgbaFromInteger(c),i.upColor=i.barColor,i.downColor=i.barColor;else{const e=l.plots[this._plotIndex];if("palette"in e){const t=e.palette,s=n.palettes.childs()[t],a=(0,o.ensureDefined)(null===(r=l.palettes)||void 0===r?void 0:r[t]),h=a.valToIndex?(0,o.ensureDefined)(a.valToIndex[c]):c,u=s.childs().colors.childs()[h].childs().color.value();i.barColor=u,i.upColor=u,i.downColor=u}}return i}firstColoredBar(e){var t;let i=e;for(const s of this._backColorers)i=Math.min(i,null!==(t=s.firstColoredBar(e))&&void 0!==t?t:1/0);const s=this._getOffset();i=Math.min(i,e+s);const r=this._getBars().firstIndex(),n=Math.max(i,null!=r?r:-1/0),o=this._study.metaInfo().plots[this._plotIndex];return Math.max(this._study.getMinFirstBarIndexForPlot(o.id),n)}_getBars(){
return this._study.series().bars()}_getOffset(){const e=this._study.metaInfo().plots[this._plotIndex];return this._study.offset(e.id)}}var Lt=i(251954),Ht=i(911144),Ut=i(735211),Gt=i(984217);class zt extends ut.PanePriceAxisView{constructor(e,t,i,s){super(e,t,i),this._dataSource=t,this._isForceOverlay=t.metaInfo().isPlotForceOverlay(s)}_position(){const e=this._isForceOverlay?this._chartModel.mainPane():this._chartModel.paneForSource(this._dataSource);if(null===e)return null;const t=this._isForceOverlay?this._chartModel.mainSeries().priceScale():this._dataSource.priceScale();if(null===t)return null;let i=e.priceScalePosition(t);return"overlay"===i&&(i=e.priceScalePosition(e.defaultPriceScale())),"overlay"===i?null:i}}var jt=i(627183);const Wt=(0,a.getLogger)("Chart.Study"),$t=l.t(null,void 0,i(314285));const Kt={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!1,skipFakeInputs:!1,skipBooleanInputs:!1,asObject:!0,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1},qt={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!0,skipFakeInputs:!1,skipBooleanInputs:!1,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1,fakeInputsForDisplay:!1,doNotSkipHiddenWithMigrate:!1,onlyAtomValues:!0,patchSosInputs:!1},Yt=me.enabled("study_symbol_ticker_description"),Jt=me.enabled("hide_main_series_symbol_from_indicator_legend"),Xt=me.enabled("datasource_copypaste"),Zt=me.enabled("hide_unresolved_symbols_in_legend");function Qt(e,t){const i=e.plots[t];if(!i||!(0,B.isOhlcPlot)(i))return!1;const s=i.target,r=e.defaults.styles&&e.defaults.styles[s],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[s],o=e.ohlcPlots&&e.ohlcPlots[s];return r&&(0,B.isOhlcPlotStyleBars)(r)||n&&(0,B.isOhlcPlotStyleBars)(n)||!!o&&(0,B.isOhlcPlotStyleBars)(o)}function ei(e,t){const i=e.plots[t];if(!i||!(0,B.isOhlcPlot)(i))return!1;const s=i.target,r=e.defaults.styles&&e.defaults.styles[s],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[s],o=e.ohlcPlots&&e.ohlcPlots[s];return r&&(0,B.isOhlcPlotStyleCandles)(r)||n&&(0,B.isOhlcPlotStyleCandles)(n)||!!o&&(0,B.isOhlcPlotStyleCandles)(o)}function ti(e,t){(0,o.assert)(void 0!==e,"zOrder must be defined"),(0,o.assert)(!t.has(e),"zOrder must be unique")}function ii(e,t){return e.plots.some((e=>((0,B.isColorerPlot)(e)||(0,B.isDataPlot)(e))&&e.target===t))}function si(e,t,i){let s=0,r=0;return e.inputs.filter((e=>"source"===e.type)).forEach((e=>{(0,_.getInputValue)(i[e.id]).includes("$")&&s++,(0,_.getInputValue)(t[e.id]).includes("$")&&r++})),Math.sign(r)-Math.sign(s)}function ri(e){const t=new Set;for(const i of e.parentSources())for(const e of ri(i))t.add(e);return t.add(e),Array.from(t)}function ni(e){return"inherit"===e.type&&(e.type="price"),e}function oi(e,t,i,s){if(null!==t)switch(e.type){
case"inherit":case"price":return new Ut.PriceFormatter({priceScale:t});case"volume":return(0,jt.getVolumeFormatter)(Math.log10(t));case"percent":return(0,jt.getPercentageFormatter)(Math.log10(t))}if("inherit"===e.type)return null;const r=(0,W.isNumber)(e.precision)?Math.pow(10,e.precision):void 0;switch(e.type){case"price":return new Ut.PriceFormatter({priceScale:r});case"volume":{let t=e.precision;return void 0===t&&(t=i&&(0,W.isNumber)(i.volume_precision)?i.volume_precision:0),(0,jt.getVolumeFormatter)(t)}case"percent":return(0,jt.getPercentageFormatter)(void 0===r?void 0:Math.log10(r));default:return Wt.logWarn(`Unsupported format type: ${e.type}`),null}}const li=new Set(["first_visible_bar_time","last_visible_bar_time","subscribeRealtime"]);class ai extends A.PriceDataSource{constructor(e,t,i,s,r){var n,l,a;super(e),this._onStart=new w.Delegate,this._restarting=!1,this._paneViews=[],this._forceOverlaysPaneViews=[],this._legendView=null,this._priceAxisViews=[],this._forceOverlayPriceAxisViews=[],this._priceAxisViewsBase=[],this._resolvedSymbols={},this._resolvedSymbolsByInput={},this._priceLinesAxisViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[],this._ownFirstValue=null,this._formatter=null,this._defaultFormatter=null,this._dataUpdated=new w.Delegate,this._currencySourceSymbolInputProperty=null,this._onHibernationStateChange=new w.Delegate,this._symbolsResolved=new w.Delegate,this._statusChanged=new w.Delegate,this._inputsAnchorsPaneView=null,this._inputsLinesPaneView=null,this._inputsTimeAxisPaneViews=[],this._inputsPriceAxisPaneViews=[],this._sources=[],this._status={type:xt.StudyStatusType.Undefined},this._recompilationStatus=null,this._wasCompletedBefore=!1,this._studyId=null,this._isSubscribedToSessionId=!1,this._titleStrCache={},this._titleInPartsCache={},this._children=[],this._graphicsPriceAxisViews=[],this._plotOffsets={},this._ongoingDataUpdate=Promise.resolve(),this._studyModified=!1,this._tagsChanged=new w.Delegate,this._studyName="",this._turnaround="st0",this._pendingResolveSymbols=new Map,this._onIsActualIntervalChange=new w.Delegate,this._childStudyByRebind=new w.Delegate,this._lastNonEmptyPlotRowCache={},this._startMovingPoint=null,this._processHibernateBound=this.processHibernate.bind(this,1),this._maxOffset=new Tt.WatchedValue(0),this._currencySourceSymbolInfo=null,this._graphicsPriceRangeGroups=null,this._graphicsViewsReady=!1,this._visibleTimeRangeInputs=null,this._turnaroundCounter=0,this._deferredPinePatchProps=!1,this._propertiesPatched=Promise.resolve(),this._aboutToBeDestroyed=new w.Delegate,this._definitionsViewModel=null,this._plotFormatters=new Map,this._showPineVersionInStatusLine=new Tt.WatchedValue(!1).spawn(),this._pineSourceCodeModel=null,this._onParentSourcesChanges=new w.Delegate,this._statusChangesSubscriber={},this._calculationTime=new Tt.WatchedValue(0),this._chartApi=e.chartApi(),this._properties=t,this._metaInfo=s,this._hideMatches=s.inputs.filter((e=>e.hideWhenPlotsHidden)).map((e=>({id:e.id,plotIds:e.hideWhenPlotsHidden||[]}))),
this._series=this._model.mainSeries(),this._series.onIntervalChanged().subscribe(this,this._calcIsActualInterval),this._series.alertCreationAvailable().subscribe(this._updateAlertCreationAvailable.bind(this)),this._showStudyArgumentsProperty=e.properties().childs().paneProperties.childs().legendProperties.childs().showStudyArguments,e.collapsed().subscribe(this._processHibernateBound),this._sources=i,T.StudyMetaInfo.setChildStudyMetaInfoPropertiesSourceId(s,null===(n=this._sources[0])||void 0===n?void 0:n.id(),t),i.forEach((e=>{e.setChild(this)})),[this._series,...i].forEach((e=>{e.currencyChanged().subscribe(this,this._onSourceCurrencyChanged),e.unitChanged().subscribe(this,this._onSourceUnitChanged),e.priceRangeReadyChanged().subscribe(this,this._onSourcePriceRangeReadyChanged),e.formatterChanged().subscribe(this,this._onSourceFormatterChanged),e.priceStepChanged().subscribe(this,this._onSourcePriceStepChanged)})),Yt&&this._model.mainSeries().properties().childs().statusViewStyle.childs().symbolTextSource.listeners().subscribe(this,(()=>{this.invalidateTitleCache(!0)}));const h=this._properties.childs();for(const e of T.StudyMetaInfo.getSourceInputIds(s))null===(l=h.inputs.childs()[e])||void 0===l||l.subscribe(this,this._onSourceInputChanged);this._properties.subscribe(this,this._onPropertiesChanged),h.visible.subscribe(this,this._visibleChanged),h.visible.subscribe(this,(()=>this.processHibernate())),h.intervalsVisibilities.subscribe(this,this._calcIsActualInterval),h.inputs.listeners().subscribe(this,this._updateMaxOffsetValue),void 0!==h.offsets&&h.offsets.listeners().subscribe(this,this._updateMaxOffsetValue),void 0!==h.offset&&h.offset.listeners().subscribe(this,this._updateMaxOffsetValue),L.hideAllIndicators().subscribe(this,this._visibleChanged);for(let e=0;e<this._metaInfo.plots.length;e++){const t=this._metaInfo.plots[e].id,i=h.styles.childs()[t];null==i||i.childs().display.subscribe(this,(()=>{this.processHibernate(),this.invalidateTitleCache()}))}for(const e of Object.keys(this._metaInfo.graphics))for(const t of Object.keys(this._metaInfo.graphics[e])){const i=null===(a=h.graphics.childs()[e])||void 0===a?void 0:a.childs()[t];i&&i.childs().visible&&(0,o.ensureDefined)(i.childs().visible).subscribe(this,(()=>this.processHibernate()))}this._isActualInterval=(0,At.isActualInterval)(this._series.intervalObj(),h.intervalsVisibilities),this._initializeStudyInputsPaneViews(),this._handler=e=>this._onData(e),this._valuesProvider=new Ht.StudyValuesProvider(this,e),this._graphicsPriceRangeGroups=ne(this),this._graphics=new D.LiveStudyGraphics(s.graphics),this._signlePerformanceValue=(0,ce.createWVFromGetterAndSubscriptions)((()=>{var e;return null!==(e=Array.from((0,o.ensureDefined)(this._graphics.performance().get("performance")))[0])&&void 0!==e?e:null}),[(0,o.ensureDefined)(this._graphics.observablePerformance().get("performance")).changed(),(0,o.ensureDefined)(this._graphics.observablePerformance().get("performance")).cleared()]),this._chartApi=e.chartApi(),this._invalidateLastNonEmptyPlotRowCache(),
this._data=new M.PlotList((0,Gt.studyPlotFunctionMap)(this._metaInfo),Gt.studyEmptyPlotValuePredicate),this._createViews(),this._recreatePriceFormattingDependencies(this._series.symbolInfo()),h.precision.subscribe(this,this._onFormatterPropsChanged),this._showStudyArgumentsProperty.subscribe(this,(()=>this.invalidateTitleCache(!0))),h.inputs.listeners().subscribe(this,(()=>this.invalidateTitleCache(!0))),me.enabled("update_study_formatter_on_symbol_resolve")&&e.mainSeries().dataEvents().symbolResolved().subscribe(this,this._recreatePriceFormattingDependencies),e.mainSeries().dataEvents().symbolResolved().subscribe(this,(()=>this.invalidateTitleCache(!0)));const u=new Set;if(this._simplePlotsCount=s.plots.filter(((e,t)=>{if((0,B.isLinePlot)(e))return!0;if((0,B.isOhlcPlot)(e)){const t=e.target;return!u.has(t)&&(u.add(t),!0)}return!1})).length,this.hasBarColorer()&&h.visible.listeners().subscribe(this,(()=>e.mainSeries().invalidateBarStylesCache)),this._definitionsViewModel=null,this._updateMaxOffsetValue(),s.inputs.some((e=>li.has(e.id)))){this._visibleTimeRangeInputs=e.visibleRangeStudiesInputs().spawn();const t=this._visibleTimeRangeInputs.value();let i=null!==t;this._visibleTimeRangeInputs.subscribe((e=>{const t=()=>{this._onVisibleTimeRangeInputsChanged(e),i!==(null!==e)&&(i=null!==e,!i||this._restarting||this.isStarted()||this.start(!0))};this._statusChanged.unsubscribeAll(this._statusChangesSubscriber),this._status.type===xt.StudyStatusType.Loading?this._statusChanged.subscribe(this._statusChangesSubscriber,t,!0):t()})),t&&this._updateVisibleTimeRangeInputs(t,!1)}(0,de.isCountedUserScript)(s)&&(this._showPineVersionInStatusLine=(0,Dt.combine)((()=>(0,de.userScriptVersionsCount)(s.scriptIdPart)>1),(0,de.userScriptsOnLayout)().weakReference()),this._showPineVersionInStatusLine.subscribe((()=>{this.invalidateTitleCache(),e.updateSource(this)})))}destroy(){var e,t,i,s,r,n;null===(e=this._signlePerformanceValue)||void 0===e||e.destroy(),this._aboutToBeDestroyed.fire(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),this._showStudyArgumentsProperty.unsubscribeAll(this),this._model.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this);this.parentSources().forEach((e=>{e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this),e.priceRangeReadyChanged().unsubscribeAll(this),e.formatterChanged().unsubscribeAll(this),e.priceStepChanged().unsubscribeAll(this)})),this._series.properties().childs().statusViewStyle.childs().symbolTextSource.unsubscribeAll(this),this._series.onIntervalChanged().unsubscribeAll(this),this._series.alertCreationAvailable().unsubscribe(this._updateAlertCreationAvailable),this.formatterChanged().unsubscribe(this,this.invalidateTitleCache),L.hideAllIndicators().unsubscribe(this,this._visibleChanged),this._model.collapsed().unsubscribe(this._processHibernateBound),null!==this._currencySourceSymbolInputProperty&&this._currencySourceSymbolInputProperty.unsubscribeAll(this),
null===(t=this._legendView)||void 0===t||t.destroy(),null===(s=null===(i=this._pineSourceCodeModel)||void 0===i?void 0:i.get())||void 0===s||s.destroy(),null===(r=this._pineSourceCodeModel)||void 0===r||r.destroy(),null===(n=this._visibleTimeRangeInputs)||void 0===n||n.destroy(),this._showPineVersionInStatusLine.destroy(),super.destroy()}properties(){return this._properties}propertiesPatched(){return this._propertiesPatched}isDraggable(){return!this._metaInfo.linkedToSeries}logs(){return this._metaInfo.graphics.logs&&this._graphics instanceof D.LiveStudyGraphics?(0,o.ensureDefined)(this._graphics.observableLogs().get("logs")):null}logLevelMask(){const e=this._properties.childs().inputs.childs().__log_level.value();if(!(0,W.isNumber)(e)||e<0||e>7)throw new Error(`Value of log level is unexpected, current value is ${e}, but expected values from 0 to 7`);return{error:Boolean(1&e),warning:Boolean(2&e),info:Boolean(4&e)}}setLogLevelMask(e){const t=(Number(e.error)&&1)|(Number(e.warning)&&2)|(Number(e.info)&&4);this._properties.childs().inputs.childs().__log_level.setValue(t)}performance(){return this._graphics instanceof D.LiveStudyGraphics?this._signlePerformanceValue:new Tt.WatchedValue(null)}profilingEnabled(){var e;return!!(null===(e=this._properties.childs().inputs.childs().__profile)||void 0===e?void 0:e.value())}enableProfiling(e){var t;null===(t=this._properties.childs().inputs.childs().__profile)||void 0===t||t.setValue(e)}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}priceScale(e){return e?this._model.mainSeries().priceScale():super.priceScale()}lastValueData(e,t,i){const s={noData:!0},r=this.metaInfo().isPlotForceOverlay(e),n=r?this._model.mainSeries().priceScale():this.priceScale();if(this._model.timeScale().isEmpty()||null===n||n.isEmpty()||this.data().isEmpty())return s;const o=this._model.timeScale().visibleBarsStrictRange(),l=this.firstValue(!0,r);if(null===o||null===l)return s;if(!this._properties.childs().visible.value())return s;const a=this._properties.childs().styles,h=this._properties.childs().ohlcPlots;let u,d;if(a&&a.childs()[e]&&(u=a.childs()[e]),h&&h.childs()[e]&&(u=h.childs()[e]),!u||0===u.childs().display.value())return s;const c=this.metaInfo().plots;for(d=0;d<c.length;d++){const t=c[d];if(t.id===e||(0,B.isOhlcClosePlot)(t)&&t.target===e)break}const p=d+1,_=this.offset(e),f=this.nearestIndex(o.lastBar()-_,O.PlotRowSearchMode.NearestLeft,p);if(void 0===f)return s;const m=this._lastNonEmptyPlotRow(p),y=null!==m&&o.contains(m.index),v=null!==m?m.value:null,g=t||y?v:this.data().valueAt(f);if(!g||!(0,W.isNumber)(g[p]))return s;const S=g[p],b=this._valuesProvider.getPlotColor(d,g),I=n.priceToCoordinate(S,l),P=this.plotFormatter(e).format(S),w={...n.getFormattedValues(S,l,void 0,P),noData:!1,color:b,floatCoordinate:I,coordinate:I};return i&&(w.price=S),w}isFailed(){return this.status().type===xt.StudyStatusType.Error}isLoading(){return this.status().type===xt.StudyStatusType.Loading}isCompleted(){return this.status().type===xt.StudyStatusType.Completed}isSymbolInvalid(){
return this._status.type===xt.StudyStatusType.Error&&this._status.errorDescription.error===$t}series(){return this._series}model(){return this._model}state(e,t){var i,s;const r=(0,o.ensureNotNull)((0,h.getStudyClassName)(this.constructor)),n=this.metaInfo(),l={type:r,id:this.id(),state:this.properties().state(),zorder:this.zorder(),ownFirstValue:this.isVisible()?null:this._ownFirstValue,metaInfo:n.state()},a=this._sources.map((e=>e.id()));if(a.length&&(l.parentSources=a),e){let e=this.data();const t=this._model.timeScale(),i=this._seriesDataRangeToSave(e);null!==i&&(e=e.range(i.firstBar(),i.lastBar())),l.data=e.state(),l.data.symbols=this._resolvedSymbols,l.data.graphics=(0,D.saveStudyGraphics)(this.graphics(),t.visibleBarsStrictRange()),l.data.plotOffsets=this._plotOffsets}this.ownerSource()&&(l.ownerSource=null===(i=this.ownerSource())||void 0===i?void 0:i.id());for(let e=0;e<n.inputs.length;e++)if("bar_time"===n.inputs[e].type){const t=n.inputs[e].id,i=l.state.inputs[t];if(i<0){const e=this._rightOffsetToUnixTime(-i);l.state.inputs[t]=e&&e>=0?e:0}}if(null===(s=l.state)||void 0===s?void 0:s.inputs){const e=l.metaInfo.inputs.find((e=>"ILScript"===e.name));e&&delete l.state.inputs[e.id],delete l.state.inputs.__log_level,delete l.state.inputs.__profile}const u=this.stateCustomFields();var d;return u&&(l.customFields=u),t&&(d=l).metaInfo&&d.metaInfo.scriptIdPart&&d.metaInfo.scriptIdPart.startsWith("USER;")&&(function(e){if(!e.metaInfo)return;const t=e.metaInfo.scriptIdPart;if(!t)return;const i=t.split(";")[0],s=e.metaInfo;s.id=(s.id||"").replace(t,i),s.fullId=(s.fullId||"").replace(t,i),s.name=(s.name||"").replace(t,i),s.shortId=(s.shortId||"").replace(t,i),s.scriptIdPart=(s.scriptIdPart||"").replace(t,i),e.state&&(e.state.id=(e.state.id||"").replace(t,i),e.state.name=(e.state.name||"").replace(t,i),e.state.scriptIdPart=(e.state.scriptIdPart||"").replace(t,i))}(d),function(e){const t=(e.metaInfo&&e.metaInfo.inputs||[]).find((e=>"ILScript"===e.name));t&&(t.defval="",e.state&&e.state.inputs&&(e.state.inputs[t.id]=""),e.metaInfo.defaults.inputs&&(e.metaInfo.defaults.inputs[t.id]=""))}(d)),l}stateCustomFields(){}restoreStateCustomFields(e){}restoreData(e){var t,i;this._invalidateLastNonEmptyPlotRowCache(),this.data().restoreState(e),this._resolvedSymbols=null!==(t=e.symbols)&&void 0!==t?t:{},this._graphics=e.graphics?(0,D.loadStudyGraphics)(e.graphics):(0,D.emptyStudyGraphics)(),this._postProcessGraphics(),this._plotOffsets=null!==(i=e.plotOffsets)&&void 0!==i?i:{},this._setStatus({type:xt.StudyStatusType.Completed},!0)}hasStateForAlert(){return ue.alertsAvailable&&!this.isFailed()&&!this._metaInfo.isTVLibrary&&this._series.alertCreationAvailable().value()&&(this._hasAlertConditions()||this._hasAvailableAlertPlots()||this._hasAlertFunction())}stateForAlert(){const e=(0,
o.ensureNotNull)(this._alertMetaInfo()),t=this._plotsForAlert(),i=this._collectDepsForAlert(),s=i.idForAlert,r=i.studyDependencies,n=i.inputsForAlert,l=(this.priceScale()||this.model().mainSeries().priceScale()).formatter(),a=l?c.FormattersSerializer.serialize(l):null,d={id:s,uniqueId:s,type:(0,o.ensureNotNull)((0,h.getStudyClassName)(this.constructor)),title:(0,u.clean)(this._title($.TitleDisplayTarget.StatusLine,!1,{},!1,!1,!0),!0),shortTitle:(0,u.clean)(this._title($.TitleDisplayTarget.StatusLine,!0,{},!1,!1,!0),!0),shortDescription:(0,u.clean)(e.shortDescription||"Study",!0),fullId:e.fullId,isTVScript:Boolean(e.isTVScript),isTVScriptStrategy:Boolean(e.isTVScriptStrategy),isTVLibrary:Boolean(e.isTVLibrary),hasAlertFunction:Boolean(e.hasAlertFunction),plots:t,inputs:n,alerts:e.alerts,scriptIdPart:e.scriptIdPart,scriptVersion:e.pine?e.pine.version:"-1",studyDependencies:r,formatter:a},p=y(this);p&&(d.dangerReason=p);const _=e.defaultStrategyAlertMessage;return _&&(d.defaultStrategyAlertMessage=(0,u.clean)(_,!0)),d}idForAlert(){return this._collectDepsForAlert().idForAlert}hasBarColorer(){return(0,o.ensureNotNull)(this._metaInfo).plots.some(B.isBarColorerPlot)}barColorer(){const e=this._metaInfo.plots;let t=null;for(let i=0;i<e.length;++i)if((0,B.isBarColorerPlot)(e[i])){const e=new Et(this,i);null===t?t=e:t.pushBackBarColorer(e)}return t}isSavedInStudyTemplates(){return this._metaInfo.inputs.every((e=>"bar_time"!==e.type))}restart(e){this._restarting=!0,this.clearData(),(e||me.enabled("stop_study_on_restart"))&&this.stop(),setTimeout(this.start.bind(this),0)}stop(e,t){if(!0===e&&this._children)for(const e of this._children)e.stop(!0);this._stopStudyOnServer(),this.clearData(),this._unsubscribeToSessionId(),this.recalculate()}disconnect(){this._studyId=null,this._model.isSnapshot()||(this._resolvedSymbols={},this._resolvedSymbolsByInput={})}sourceId(){return this._studyId}parentSources(){return this._sources}symbolSource(){return this._firstSourceOrSeries().symbolSource()}valueAt(e,t){return this.symbolSource().valueAt(e,t)}barsProvider(){return this._firstSourceOrSeries().barsProvider()}ownerSource(){return this.isChildStudy()?this._sources[0]:super.ownerSource()}isChildStudy(){return this._sources.length>0}hasChildren(){return this._children.length>0}isStarted(){return Boolean(this._studyId)}isRestarting(){return this._restarting}isActualInterval(){return this._isActualInterval}onIsActualIntervalChange(){return this._onIsActualIntervalChange}isVisible(){var e,t,i;const s=this._properties.childs();if(this._model.collapsed().value()||!s.visible.value()||!this.isActualInterval())return!1;const r=this.metaInfo();if(r.plots.length>0)for(let e=0;e<r.plots.length;e++){const t=r.plots[e].id,i=s.styles.childs()[t];if(void 0===i)continue;if(0!==i.childs().display.value())return!0}if(r.bands)for(let e=0;e<r.bands.length;e++)if(s.bands.childs()[e].childs().visible.value())return!0;for(const n of Object.keys(r.graphics))for(const o of Object.keys(r.graphics[n])){
const r=null===(e=s.graphics.childs()[n])||void 0===e?void 0:e.childs()[o];if(void 0!==r&&(null===(i=null===(t=r.child("visible"))||void 0===t?void 0:t.value())||void 0===i||i))return!0}if(r.filledAreas)for(let e=0;e<r.filledAreas.length;e++)if(s.filledAreasStyle.childs()[r.filledAreas[e].id].childs().visible.value())return!0;return!(!r.isTVScriptStrategy&&!r.hasAlertFunction)}async start(e,t,i){const s=this._model.mainSeries();await s.seriesCreated(),await Promise.all(this._sources.filter((e=>e.isHibernated())).map((e=>e.start())));const r=!(this.isHibernationAllowed()&&!this.isVisible())||!0===t;if(this._chartApi&&this._chartApi.isConnected().value()&&r)try{await this._allSymbolsAreResolved(),await this._startAfterSymbolsResolved(e,t)}catch(e){const t=`ERROR: ${this._debugId()} start failed, ${e}`;Wt.logError(t),this._restarting=!1,"TooManyStudies"===(null==e?void 0:e.cause)&&(0,I.showTooManyStudiesNotice)(this._chartApi.getStudyCounter())}}replaceData(e,t,i){this._invalidateLastNonEmptyPlotRowCache(),this.data().remove(e+1),this.data().addTail(i,t)}inputs(e){const t=(0,n.default)((0,W.clone)(Kt),e||{});t.skipOptionalEmptySymbolInputs&&(t.keepOptionalSymbolsEmpty=!0);const i=(0,r.default)(this._buildInputs(t));return t.patchSosInputs&&T.StudyMetaInfo.patchSoSInputs(i,(e=>{var t,i;return null!==(i=null===(t=this._sources.find((t=>t.id()===e)))||void 0===t?void 0:t.sourceId())&&void 0!==i?i:null})),i}data(){return this._data}moveData(e){this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._invalidateLastNonEmptyPlotRowCache(),this.data().move(e)}))}plots(){return this.data()}metaInfo(){return this._metaInfo}status(){var e;return null!==(e=this._recompilationStatus)&&void 0!==e?e:this._status}name(e){return e?this.metaInfo().shortDescription||"Study":this.metaInfo().description||"Study"}title(e,t,i,s,r,n){s=void 0===s?!this._showStudyArgumentsProperty.value():s;const o=JSON.stringify([e,t,i,s,r,n]);if(this._titleStrCache[o])return this._titleStrCache[o];if(this._titleInPartsCache[o])return this._joinTitlesParts(this._titleInPartsCache[o]);const l=this._title(e,t,i,s,r,n);return this._titleStrCache[o]=l,l}titleInParts(e,t,i,s,r){s=void 0===s?!this._showStudyArgumentsProperty.value():s;const n=JSON.stringify([e,t,i,s,r]);if(this._titleInPartsCache[n])return this._titleInPartsCache[n];const o=this._titleInParts(e,t,i,s,r);return this._titleInPartsCache[n]=o,o}invalidateTitleCache(e){if(this._titleStrCache={},this._titleInPartsCache={},!0===e&&this._children)for(let t=0;t<this._children.length;++t)this._children[t].invalidateTitleCache(e)}graphics(){return this._graphics}graphicsInfo(){return this._metaInfo.graphics}priceLabelText(e){const t=this._metaInfo.styles,i=this._metaInfo.ohlcPlots;let s;t&&t[e]&&(s=t[e]),i&&i[e]&&(s=i[e]);const r=(0,o.ensureDefined)(s).title;return 1!==this._simplePlotsCount||(0,B.isPlotTitleDefined)(r)?this._metaInfo.is_price_study&&r!==this._metaInfo.shortDescription?""===r?this._metaInfo.shortDescription:this._metaInfo.shortDescription+":"+r:r:this._metaInfo.shortDescription}
setOwnFirstValue(e){this._ownFirstValue=e}firstValue(e,t){if(t)return this._series.firstValue();if(!this.isChildStudy()&&"Compare@tv-basicstudies"===this._metaInfo.id||!this._metaInfo.is_price_study){const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return null;const i=this.properties().childs();if(!i.visible.value()||!this.isActualInterval()||null!==this._startMovingPoint)return this._ownFirstValue;const s=t.firstBar(),r=t.lastBar();let n=this._graphicsPriceRangeGroups?function(e,t){const i=e.model().timeScale();if(i.isEmpty())return null;const s=i.visibleBarsStrictRange();if(null===s)return null;const r=s.firstBar(),n=s.lastBar(),o=new le;for(const e of t){const t=e.firstValue(r,n);o.improve(t)}return o.bestPrice()}(this,this._graphicsPriceRangeGroups):null;const l=(this._metaInfo.plots||[]).filter((e=>!this._metaInfo.isPlotForceOverlay(e.id)));if(null===n){const t=new Set,a=this._metaInfo.filledAreas||[];for(let e=0;e<a.length;e++){const s=a[e];i.filledAreasStyle.childs()[s.id].childs().visible.value()&&(t.add(s.objAId),t.add(s.objBId))}for(const a of this.data().rangeIterator(s,r)){const s=a.value;for(let r=0;r<l.length;++r){if((0,B.isColorerPlot)(l[r]))continue;const a=s[r+1];if(null==a)continue;const h=l[r].id;if((0!==(0,o.ensureDefined)(i.styles.childs()[h]).childs().display.value()||t.has(h))&&!(e&&Math.abs(a)<1e-10)){n=a;break}}if(null!==n)break}}return this._ownFirstValue=n,null!==n?n:this._bandsFirstValue(e)}if(this.isChildStudy()){const e=this._getNonPriceParent();if(e&&this.priceScale()===e.priceScale())return null!==e._ownFirstValue?e._ownFirstValue:e.firstValue()}return this._series.firstValue()}desiredPriceScalePosition(){if(this.metaInfo().isTVScriptStub)return"overlay";if(this.metaInfo().linkedToSeries)return"as-series";switch(this.metaInfo().priceScale){case 1:return"left";case 0:return"right";case 2:return"overlay";default:return null}}offset(e){var t;let i=0;this._plotOffsets&&void 0!==this._plotOffsets[e]&&(i+=this._plotOffsets[e]);const s=this.properties().childs(),r=null===(t=s.offsets)||void 0===t?void 0:t.childs()[e];return r&&(i+=r.childs().val.value()),s.offset&&(i+=s.offset.childs().val.value()),i}tags(){return!this._metaInfo||!this._metaInfo.description||this._metaInfo.isTVScriptStub||this._metaInfo.is_hidden_study||this._metaInfo.isTVScript&&"tv-scripting"===this._metaInfo.productId?[]:[this._metaInfo.description]}copiable(){return Xt&&!this.isChildStudy()}setPriceScale(e){super.setPriceScale(e),(0,Lt.emit)("study_event",this.id(),"price_scale_changed")}priceRange(e,t,i){let s=null;const r=this._metaInfo,n=this._fillPrecalculatedAutoscaleInfo(e,t,i);let l=this.data().minMaxOnRangeCached(e,t,n.fields);if(l=(0,M.mergeMinMax)(n.baseValueMinMax,l),n.useMainSeriesRange){const i=[{name:"low",offset:0},{name:"high",offset:0}],s=this.series().data().bars().minMaxOnRangeCached(e,t,i);l=(0,M.mergeMinMax)(l,s)}if(null!==l&&(s=new R.PriceRange(l.min,l.max)),r.bands&&i.targetPriceScale===this.priceScale())for(let e=0;e<r.bands.length;e++){const t=(0,
o.ensureDefined)(this._properties.childs().bands.childs()[e]).childs();if(t.visible.value()){const e=t.value.value();if(!(0,W.isNumber)(e))continue;s?s.apply(e,e):s=new R.PriceRange(e,e)}}if(this._graphicsPriceRangeGroups){const r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==i.targetPriceScale,n=function(e,t,i,s){let r=null;for(const n of e){const e=n.groupPriceRange(t,i,s);null!==e&&(r=null===r?e:r.merge(e))}return r}(this._graphicsPriceRangeGroups,e,t,!!i.forceOverlayOnly||r);n&&(s=s?s.merge(n):n)}return this._postProcessPriceRange(s,i)}autoScaleInfo(e,t,i){const s=this.priceRange(e,t,i),r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==i.targetPriceScale,n=this._graphicsPriceRangeGroups?function(e,t,i,s){const r=re();for(const n of e){const e=n.groupPixelMargins(t,i,s);r.bottomPixelMargin=Math.max(r.bottomPixelMargin,e.bottomPixelMargin),r.topPixelMargin=Math.max(r.topPixelMargin,e.topPixelMargin)}return r}(this._graphicsPriceRangeGroups,e,t,!!i.forceOverlayOnly||r):{topPixelMargin:0,bottomPixelMargin:0};return{range:s,topPixelMargin:n.topPixelMargin,bottomPixelMargin:n.bottomPixelMargin}}formatter(e){var t;return null!==(t=this._formatter)&&void 0!==t?t:this._firstSourceOrSeries().formatter(!1)}defaultFormatter(){var e,t,i;const s=this._firstSourceOrSeries();return null!==(i=null!==(e=this._defaultFormatter)&&void 0!==e?e:null===(t=s.defaultFormatter)||void 0===t?void 0:t.call(s))&&void 0!==i?i:s.formatter()}plotFormatter(e){var t;return null!==(t=this._plotFormatters.get(e))&&void 0!==t?t:this.formatter()}isMultiPaneAvailable(){return this._metaInfo.hasForceOverlayPlots()||(0,V.hasForceOverlayPrimitives)(this._metaInfo)}isMultiPaneEnabled(){return this._metaInfo.hasForceOverlayPlots()}updateAllViews(e){var t,i,s,r,n;const o=this._model.paneForSource(this),l=this._model.mainPane(),a="viewport-change"===e.type&&e.pane&&e.pane!==l;"viewport-change"===e.type&&e.pane&&e.pane!==o||(this._paneViews.forEach((t=>t.update(e))),this._labelPaneViews.forEach((t=>t.update(e))),null===(t=this._dataWindowView)||void 0===t||t.update(),null===(i=this._legendView)||void 0===i||i.update(),null===(s=this._statusView)||void 0===s||s.update(),this._priceAxisViews.forEach((t=>t.update(e))),this._priceLinesAxisViews.forEach((t=>t.update(e))),null===(r=this._inputsLinesPaneView)||void 0===r||r.update(e),null===(n=this._inputsAnchorsPaneView)||void 0===n||n.update(e),this._inputsTimeAxisPaneViews.forEach((t=>t.update(e))),this._inputsPriceAxisPaneViews.forEach((t=>t.update(e)))),a||(this._forceOverlaysPaneViews.forEach((t=>t.update(e))),this._forceOverlayLabelPaneViews.forEach((t=>t.update(e))),this._forceOverlayPriceAxisViews.forEach((t=>t.update(e)))),"data-source-change"===e.type&&e.sourceId===this.id()&&e.clearData&&this._children.forEach((e=>e.updateAllViews({type:"data-source-change",sourceId:e.id(),clearData:!0})))}removeByRemoveAllStudies(){return!0}getStudyName(){return this._studyName}nearestIndex(e,t,i){var s
;return null===(s=this.data().search(e,t,i))||void 0===s?void 0:s.index}getMinFirstBarIndexForPlot(e){var t,i,s,r,n,o,l,a,h,u,d,c,p,_,f;const m=this._properties.childs(),y=this._metaInfo,v=null!==(f=null!==(c=null!==(h=null!==(o=null!==(s=null===(i=null===(t=m.styles.childs()[e])||void 0===t?void 0:t.child("showLast"))||void 0===i?void 0:i.value())&&void 0!==s?s:null===(n=null===(r=m.filledAreasStyle.childs()[e])||void 0===r?void 0:r.child("showLast"))||void 0===n?void 0:n.value())&&void 0!==o?o:null===(a=null===(l=y.styles)||void 0===l?void 0:l[e])||void 0===a?void 0:a.showLast)&&void 0!==h?h:null===(d=null===(u=m.ohlcPlots.childs()[e])||void 0===u?void 0:u.child("showLast"))||void 0===d?void 0:d.value())&&void 0!==c?c:null===(_=null===(p=y.ohlcPlots)||void 0===p?void 0:p[e])||void 0===_?void 0:_.showLast)&&void 0!==f?f:null;if(null===v)return-1/0;const g=this.data().lastIndex();return null===g?-1/0:g-v+1}guiPlotName(e,t){var i,s,r;return null!==(r=null===(s=null===(i=this._metaInfo.styles)||void 0===i?void 0:i[t])||void 0===s?void 0:s.title)&&void 0!==r?r:this.title(e)}childStudyByRebind(){return this._childStudyByRebind}isPine(){return void 0!==this._metaInfo.pine}isStandardPine(){return this.isPine()&&T.StudyMetaInfo.isStandardPine(this._metaInfo.id)}isLinkedToSeries(){return!0===this._metaInfo.linkedToSeries}defaultPlotIdForAlert(){return this._metaInfo.plots.length?this._metaInfo.plots[0].id:null}resolvedSymbolInfoBySymbol(e){return this._resolvedSymbols&&e&&this._resolvedSymbols[this._getSymbolForResolve(e)]||null}hasPendingUnresolvedSymbols(){return this._pendingResolveSymbols.size>0}hasSymbolInputs(){return this._metaInfo.inputs.some((e=>"symbol"===e.type))}currency(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().currency():null}currencySourceSymbolInfo(){var e,t,i;return null!==(e=this._currencySourceSymbolInfo)&&void 0!==e?e:null!==(i=null===(t=this.symbolSource())||void 0===t?void 0:t.symbolInfo())&&void 0!==i?i:null}unit(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().unit():null}canOverrideMinTick(){return!1}dataWindowView(){return this._dataWindowView}statusView(){return this._statusView}legendView(){return this._legendView}pineSourceCodeModel(){return this.metaInfo().pine?(this._pineSourceCodeModel||(this._pineSourceCodeModel=new P.AsyncResourceWrapper(Promise.all([i.e(98410),i.e(87),i.e(6927),i.e(65836),i.e(89199)]).then(i.bind(i,38447)).then((e=>this._isDestroyed?null:new e.PineSourceCodeModel(this))))),this._pineSourceCodeModel.promise()):Promise.resolve(null)}inputsForAlertState(){return this.inputs()}sessionId(){return this._firstSourceOrSeries().sessionId()}sessionIdChanged(){return this._firstSourceOrSeries().sessionIdChanged()}getSymbolString(e){return""===e?"":(0,U.encodeExtendedSymbolOrGetSimpleSymbolString)(this._getSymbolObject(e))}onStatusChanged(){return this._statusChanged}symbolsResolved(){return this._symbolsResolved}onHibernationStateChange(){return this._onHibernationStateChange}
legendValuesProvider(){return new k.StudyLegendValuesProvider(this,this.model())}statusProvider(e){return new j.StudyStatusProvider(this)}correctScaleMargins(e){if("Volume"===this.metaInfo().shortId){const t=this.model().paneForSource(this);return null!==t&&t.isOverlay(this)&&t.containsMainSeries()?{top:.75,bottom:0}:{top:e.top,bottom:0}}return e}canBeHiddenByGlobalFlag(){return!0}isSourceHidden(){return!this.isVisible()||this.canBeHiddenByGlobalFlag()&&L.hideAllIndicators().value()}wasCompletedBefore(){return this._wasCompletedBefore}paneViews(e){const t=this._model.mainPane();if(this.isSourceHidden())return null;if(!e.hasPriceDataSource(this))return e!==t?null:this._forceOverlaysPaneViews;const i=[];return!this._startMovingPoint&&this._wasCompletedBefore&&i.push(...this._paneViews.filter((e=>{var t;return!(null===(t=e.isForceOverlay)||void 0===t?void 0:t.call(e))}))),this._inputsLinesPaneView&&(this._startMovingPoint||this._model.selection().isSelected(this))&&i.push(this._inputsLinesPaneView),this._inputsAnchorsPaneView&&i.push(this._inputsAnchorsPaneView),e===t&&i.push(...this._forceOverlaysPaneViews),i}labelPaneViews(e){const t=this._model.mainPane();if(this.isSourceHidden()||!e.hasPriceDataSource(this))return this._metaInfo.hasForceOverlayPlots()?e!==t?null:this._forceOverlayLabelPaneViews:null;const i=[...this._labelPaneViews];return e===t&&i.push(...this._forceOverlayLabelPaneViews),i}timeAxisViews(){return this._model.selection().isSelected(this)?this._inputsTimeAxisPaneViews:null}priceAxisViews(e,t){if(t!==this.priceScale()&&t===this._model.mainSeries().priceScale()&&!e.hasDataSource(this))return this._forceOverlayPriceAxisViews;const i=this._properties.childs().oldShowLastValue;if(i&&!i.value())return null;let s=this._priceAxisViews.slice();return this._model.selection().isSelected(this)&&(s=s.concat(this._inputsPriceAxisPaneViews)),t===this._model.mainSeries().priceScale()&&(s=s.concat(this._forceOverlayPriceAxisViews)),e.findTargetPriceAxisViews(this,t,s,this._priceLinesAxisViews)}movable(){return null!==this._inputsAnchorsPaneView}startMoving(e,t,i,s){this._startMovingPoint=e}move(e,t,i,s){if(void 0!==e.logical&&null!==this._startMovingPoint){if(Array.isArray(t)){const i=t;this._updateInputValue(e.logical,i[0]),this._updateInputValue(e.logical,i[1])}else this._updateInputValue(e.logical,t);this.updateAllViews((0,Mt.sourceChangeEvent)(this.id()))}}endMoving(e,t){return this._startMovingPoint=null,{indexesChanged:!1,pricesChanged:!1}}clearData(){var e;this._invalidateLastNonEmptyPlotRowCache(),this.data().clear(),this._graphics instanceof D.LiveStudyGraphics&&(null===(e=this._graphics)||void 0===e||e.clear()),this._plotOffsets={},this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this.updateAllViews((0,Mt.sourceChangeEvent)({sourceId:this.id(),clearData:!0}))}convertYCoordinateToPriceForMoving(e,t){const i=this.priceScale();if(!t||!i||i.isEmpty())return null;const s=t.firstValue();return null===s?null:i.coordinateToPrice(e,s)}processHibernate(e){const t=this.isVisible()
;if(!this.isStarted()&&t&&(this._sources.forEach((e=>{e.processHibernate()})),this.start(void 0,void 0,e),this._onHibernationStateChange.fire(!1)),this.isHibernationAllowed()&&this.isStarted()&&!t){for(const e of this._children)e.processHibernate();this.stop(void 0,e),this._onHibernationStateChange.fire(!0)}}isHibernationAllowed(){return!this.metaInfo().historyCalculationMayChange&&(!this.hasChildren()||!!this._model.collapsed().value()&&this._children.every((e=>e.isHibernationAllowed())))}isPlotVisibleAt(e,t){let i;const s=this.metaInfo().plots.find((t=>t.id===e));if(i=void 0!==s?(0,B.isOhlcPlot)(s)?this._properties.childs().ohlcPlots.childs()[s.target]:this._properties.childs().styles.childs()[e]:this._properties.childs().ohlcPlots.childs()[e],void 0===i)throw new Error(`Study does not contain ${e} plot`);const r=i.childs().display.value();return null!==r&&(r&t)===t}recalculate(){const e=this._model.paneForSource(this);this._model.recalculatePane(e,(0,Mt.sourceChangeEvent)(this.id())),this._model.updateSource(this)}maxOffset(){return this._maxOffset}onStart(){return this._onStart}onParentSourcesChanges(){return this._onParentSourcesChanges}isHibernated(){return!this.isVisible()&&!this.isStarted()}graphicsViewsReady(){return this._graphicsViewsReady}setRecompilationActive(e){var t;e!==Boolean(this._recompilationStatus)&&(this._recompilationStatus=e?{type:xt.StudyStatusType.Loading,startTime:Date.now()}:null,null===(t=this._statusView)||void 0===t||t.update(),this._model.updateSource(this),this._statusChanged.fire(this.status()))}turnaround(e){if(!e)return this._turnaround;return function(e,t){let i=t.turnaround,s=[t];for(;s.length>0;){let e=[];const t=[];s.forEach((i=>{const s=_e(i.sourceStudies).sort(pe);if(s.length>0){e=e.concat(s);const i=s.map((e=>e.turnaround)).join("_");t.push(i)}})),t.length&&(i=t.join("_")+"_"+i),s=e}return e+"_"+i}(this._series.seriesSource().turnaround(),fe(this))}canHaveChildren(){var e;return this._canHaveChildren=null!==(e=this._canHaveChildren)&&void 0!==e?e:T.StudyMetaInfo.canHaveChildren(this._metaInfo),this._canHaveChildren}setChild(e){-1===this._children.indexOf(e)&&this._children.push(e)}unsetChild(e){const t=this._children.indexOf(e);~t&&this._children.splice(t,1)}getAllChildren(){const e=this._children.slice();for(let t=0;t<e.length;++t){const i=e[t].getAllChildren();for(let t=0;t<i.length;++t)~e.indexOf(i[t])||e.push(i[t])}return e}parentSourceForInput(e){var t;if(e.includes("$")){const i=e.split("$")[0];return null!==(t=this._sources.find((e=>e.id()===i)))&&void 0!==t?t:null}return this._series}priceStep(){return this._priceStep||this._firstSourceOrSeries().priceStep(!1)}recreatePriceFormatter(){this._recreatePriceFormattingDependencies()}setOwnerSource(e){super.setOwnerSource(e),this._recreatePriceFormattingDependencies()}onTagsChanged(){return this._tagsChanged}getPropertyDefinitionsViewModel(){
return null===this._definitionsViewModel?this._getPropertyDefinitionsViewModelClass().then((e=>null===e||this._isDestroyed?null:(null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this._model.undoModel(),this)),this._definitionsViewModel))):Promise.resolve(this._definitionsViewModel)}calculationTime(){return this._calculationTime.readonly()}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_alertMetaInfo(){return this.metaInfo()}_createStudyOnServer(){if(this._isDestroyed)return!1;const e=this._metaInfo.useVersionFromMetaInfo?(0,T.getStudyIdWithVersion)(this._metaInfo):this._getStudyIdWithLatestVersion();this._studyId=(0,G.makeNextStudyId)(),this._incrementTurnaround(),this._studyName=e;const t=(0,W.clone)((0,o.ensureDefined)(this._inputs));let i;if(T.StudyMetaInfo.patchSoSInputs(t,(e=>{var t,i;return null!==(i=null===(t=this._sources.find((t=>t.id()===e)))||void 0===t?void 0:t.sourceId())&&void 0!==i?i:null})),i=this._chartApi.createStudy(this._studyId,this._turnaround,(0,o.ensureNotNull)(this._series.seriesSource().instanceId()),this._studyName,t,this._handler,this._studySpec()),!i)return this._studyId=null,i;if(performance.mark(`calculate_study_${this._studyId}`),void 0===this._oldStudyInputs){if(this._metaInfo.TVScriptMetaInfoExprs){this._previousPatchMap={};const e=this._metaInfo.TVScriptMetaInfoExprs.patchMap;(0,g.iterateAndPatchObjectsByMap)([this._properties,this._metaInfo.defaults,this._metaInfo],e,((e,t,i)=>{const s=e[0],r=e[1],n=e[2];r.hasOwnProperty(t)?(0,o.ensureDefined)(this._previousPatchMap)[i]=s[t].value():(0,o.ensureDefined)(this._previousPatchMap)[i]=n[t]}))}const e=this._prepareInputs(qt);Object.keys(e).some((e=>(0,_.isStudyInputDependsOnChart)({id:e})))||(this._oldStudyInputs=e)}return this._deferredPinePatchProps&&!this._restarting&&this._pinePatchProps(),!0}_stopStudyOnServer(){this._chartApi&&this._chartApi.isConnected().value()&&this.isStarted()&&(this._chartApi.removeStudy((0,o.ensureNotNull)(this._studyId)),this._setStatus({type:xt.StudyStatusType.Undefined})),performance.clearMarks(`calculate_study_${this._studyId}`),this._studyId=null}_modifyStudyOnServer(e,t){const i=(0,W.clone)((0,o.ensureDefined)(e));T.StudyMetaInfo.patchSoSInputs(i,(e=>{var t,i;return null!==(i=null===(t=this._sources.find((t=>t.id()===e)))||void 0===t?void 0:t.sourceId())&&void 0!==i?i:null})),this._chartApi.modifyStudy((0,o.ensureNotNull)(this._studyId),this._turnaround,i,this._handler,t),performance.mark(`calculate_study_${this._studyId}`)}_sendNotifyCommand(e,t){this._chartApi.notifyStudy((0,o.ensureNotNull)(this._studyId),e,t)}_transformData(e){}_invalidateLastNonEmptyPlotRowCache(){this._lastNonEmptyPlotRowCache={}}_collectDepsForAlert(){const e=[this,...this._getAllOwnerSources().filter((e=>e instanceof ai))];return(0,v.collectDepsForAlert)(e)}_allInputsAreValid(){var e;if(null===(null===(e=this._visibleTimeRangeInputs)||void 0===e?void 0:e.value()))return!1;for(const e of this._metaInfo.inputs)if("bar_time"===e.type){const t=e.id
;if(null==this._properties.childs().inputs.childs()[t].value())return!1}return!0}async _startAfterSymbolsResolved(e,t){await Promise.all(this._sources.map((e=>!e.isStarted()||e.isRestarting()?new Promise((t=>{e.onStart().subscribe(this,t,!0)})):Promise.resolve()))),this.isStarted()&&!this._restarting||(this._restarting=!1,this._allInputsAreValid()&&!this.metaInfo().isTVScriptStub&&(this._inputs=this._apiInputs(),this._createStudyOnServer()&&(this._subscribeToSessionId(),this._onStart.fire(),!0===e&&this._children&&await this._children.map((e=>e.start(!0,t))))))}async _changeInputsImpl(e,t){const s=this._calcSources(),r=si(this._metaInfo,e,t),n=()=>{for(const i of this._metaInfo.inputs){if("source"!==i.type)continue;const s=e[i.id].v,r=t[i.id].v;if(s!==r){(0,o.ensureDefined)(this._properties.childs().inputs.child(i.id)).setValue(r)}}};if(this.isStarted()&&this._chartApi.isConnected().value()&&r>0&&!this._chartApi.canCreateStudy(this._studySpec(!0),!0).success){const e=window.user.pro_plan;return(0,S.createGoProDialog)({feature:"studyOnStudy",actions:e&&"pro_premium_expert"===e?[{text:l.t(null,void 0,i(515462)),action:b.PredefinedAction.Close}]:void 0}),void n()}this._inputs=e;let a=!1;const h=Object.values(_.RangeDependentStudyInputNames);for(const i of Object.keys(e))if(JSON.stringify(e[i])!==JSON.stringify(t[i])&&!h.includes(i)){a=!0;break}this._incrementTurnaround(),a&&this.disablePriceRangeReady();try{await this._updateParentSources(s,r,!0),this._modifyStudyOnServer(e,r),this._studyModified=!0}catch(e){Wt.logError(`Error applying parent sources: ${e}`),n()}this.invalidateTitleCache()}_createPriceAxisView(e){return new Ft.StudyPriceAxisView(this,{plotIndex:e})}_createPriceLineAxisView(e){return new kt.StudyPriceLineAxisView(this,e)}_createStudyPlotPaneView(e){return new dt.StudyPlotPaneView(this,this._series,this._model,e)}_createViews(){var e,t,i,s;this._priceAxisViewsBase=[],this._forceOverlayPriceAxisViews=[],this._priceLinesAxisViews=[],this._paneViews=[],this._forceOverlaysPaneViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[];const r=new Set,n=this.metaInfo(),l=Boolean(n.usePlotsZOrder),a=new Map,h=this._properties.childs();if(h.filledAreasStyle&&n.filledAreas)for(let e=0;e<n.filledAreas.length;++e){const t=n.filledAreas[e],i=(0,o.ensureDefined)(h.filledAreasStyle.childs()[t.id]),s=ii(n,t.id);let r;if("plot_plot"===t.type||s?r=new gt(this,this.model(),t,i):"hline_hline"===t.type?r=new Vt(this,t,i):Wt.logWarn("Unsupported filledArea type: "+t.type),void 0!==r){let e=!1;if("plot_plot"===t.type&&(e=n.isPlotForceOverlay(t.objAId)),e)this._forceOverlaysPaneViews.push(r);else{const e=l?(0,o.ensureDefined)(t.zorder):a.size;ti(e,a),a.set(e,{paneViews:[r]})}}}{let s=-1e5;for(let h=0;h<n.plots.length;h++){const u=n.plots[h];let d,c,p,_,f,m=n.isPlotForceOverlay(u.id);if((0,B.isNonVisualPlot)(u))continue;let y=u.id,v=n.styles;const g=(0,B.isBgColorerPlot)(u);if(g)d=new Ie(this,this._series,this._model,y);else if((0,B.isShapesPlot)(u))d=new Ue(this,this._series,this._model,y);else if((0,
B.isCharsPlot)(u))d=new Xe(this,this._series,this._model,y);else if((0,B.isArrowsPlot)(u))d=new rt(this,this._series,this._model,y);else if((0,B.isOhlcPlot)(u)){const e=u.target;if(r.has(e))continue;if(m=n.isPlotForceOverlay(e),r.add(e),Qt(n,h))d=new lt(this,this._series,this._model,e);else{if(!ei(n,h)){Wt.logError(`plot ${u.id} looks to be invalid`);continue}d=new ht(this,this._series,this._model,e)}_=this._createPriceAxisView(e),p=new ut.PanePriceAxisView(_,this,this._model),y=e,v=n.ohlcPlots}else(0,B.isDataPlot)(u)||(_=this._createPriceAxisView(y),f=this._createPriceLineAxisView(y),d=this._createStudyPlotPaneView(y),(null===(t=null===(e=this._properties.childs().styles.childs()[y])||void 0===e?void 0:e.child("trackPrice"))||void 0===t?void 0:t.value())&&(c=new _t(this,y)),p=new zt(_,this,this._model,y));const S=l?g?s++:(0,o.ensureDefined)(null===(i=null==v?void 0:v[y])||void 0===i?void 0:i.zorder):a.size;if(ti(S,a),m)_&&this._forceOverlayPriceAxisViews.push(_),d&&this._forceOverlaysPaneViews.push(d),p&&this._forceOverlayLabelPaneViews.push(p);else{const e={paneViews:void 0!==d?[d]:[],labelView:p,priceAxisView:_,priceLineAxisView:f};void 0!==c&&e.paneViews.push(c),a.set(S,e)}}}(null!==(s=this._metaInfo.bands)&&void 0!==s?s:[]).forEach(((e,t)=>{const i=h.bands.childs()[t];if(i&&i.childs().visible.value()){const t=new It(i,this),s=l?(0,o.ensureDefined)(e.zorder):a.size;ti(s,a),a.set(s,{paneViews:[t]})}})),h.bandsBackground&&((0,o.assert)(!l,"'usePlotsZOrder' flag does not supported"),a.set(a.size,{paneViews:[new Ct(this)]}));const u=this._paneViews,d=this._forceOverlaysPaneViews;this._createGraphicsPaneViews().then((e=>{for(let t=0;t<e.regularPaneViews.length;t++)u.push(e.regularPaneViews[t]);for(let t=0;t<e.forceOverlayPaneViews.length;t++)d.push(e.forceOverlayPaneViews[t]);this._model.lightUpdate(),this._graphicsViewsReady=!0})),h.areaBackground&&((0,o.assert)(!l,"'usePlotsZOrder' flag does not supported"),a.set(a.size,{paneViews:[new ft.AreaBackgroundPaneView(this,this.model())]}));const c=Array.from(a.keys()).sort(((e,t)=>e-t));for(let e=0;e<c.length;e++){const t=(0,o.ensureDefined)(a.get(c[e]));this._paneViews.push(...t.paneViews),t.labelView&&this._labelPaneViews.push(t.labelView),t.priceAxisView&&this._priceAxisViewsBase.push(t.priceAxisView),t.priceLineAxisView&&this._priceLinesAxisViews.push(t.priceLineAxisView)}this._dataWindowView||(this._dataWindowView=new St.StudyDataWindowView(this,this._model)),this._legendView||(this._legendView=new E(this,this._model)),this._statusView||(this._statusView=new H.StudyStatusView(this)),this._concatPriceAxisViews()}_onData(e){switch(e.method){case"study_loading":this._onStudyLoading();break;case"study_error":this._onStudyError(e.params[2]);break;case"study_completed":if(!this._checkTurnaround(e.params[1]))return;this._onStudyCompleted(e.params[e.params.length-1]);break;case"data_update":if(e.params.customId!==this.sourceId()||!this._checkTurnaround(e.params.turnaround))return;(0,o.assert)(!!e.params.nonseries,"data.params.nonseries is missing"),
this._onDataUpdate(e.params.plots,(0,o.ensureDefined)(e.params.nonseries),e.params.lastBar);break;case"clear_data":this._checkTurnaround(e.params.turnaround)&&this.clearData()}}_getTelemetryObjectName(){return"study"}_onDataUpdated(e,t,i,s){if(this.hasBarColorer()&&e.length>0){const t=(0,o.ensureNotNull)(this.barColorer()).firstColoredBar(e[0].index);null!==t&&this._model.mainSeries().invalidateBarStylesCache(t)}null!==t&&this._postProcessGraphics();const r=this._model.paneForSource(this);this._model.recalculatePane(r,(0,Mt.sourceChangeEvent)({sourceId:this.id(),firstUpdatedTimePointIndex:null!=s?s:void 0,nonSeriesOnly:0===e.length})),this._updateSources()}_titleInputs(e,t,i){return this.inputs(this._titleInputsOptions(e,t,i))}_titleInputsOptions(e,t,i){return{symbolsForDisplay:!0,skipHiddenInputs:!0,skipFakeInputs:!1,fakeInputsForDisplay:!0,asObject:!0,skippedGroups:[],skippedInputs:this._skippedTitleInputs(),noExchanges:t,noResolution:i,priceInputsForDisplay:!0,skipOptionalEmptySymbolInputs:Jt,displayMask:e}}_postProcessGraphics(){this._graphicsPriceAxisViews=this._createGraphicsPriceAxisViews(),this._concatPriceAxisViews()}async _createGraphicsPaneViews(){return(0,D.createGraphicsPaneViews)(this,this.model())}_createGraphicsPriceAxisViews(){return(0,D.createGraphicsPriceAxisViews)(this)}_subscribeToSessionId(){!this._isSubscribedToSessionId&&this.hasSymbolInputs()&&(this.sessionIdChanged().subscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!0)}_recreateFormatter(e){this._recreatePlotsFormatters(e),this._formatter=this._tryCreateFormatter(e),this._defaultFormatter=this._tryCreateDefaultFormatter(e),this._formatterChanged.fire();const t=this.priceScale();null!==t&&t.updateFormatter(),this.getAllChildren().forEach((e=>{e.recreatePriceFormatter()})),this._model.fullUpdate()}_recreatePriceFormattingDependencies(e){this._recreateFormatter(e),this._recreatePriceStep()}_title(e,t,i,s,r,n){const o=this._titleInParts(e,t,i,s,r,n);return this._joinTitlesParts(o)}_postProcessPriceRange(e,t){if(e&&e.minValue()===e.maxValue()&&!this.metaInfo().is_price_study){const t=.005*e.minValue();e=new R.PriceRange(e.minValue()-t,e.maxValue()+t)}const i=t.targetPriceScale;return i&&i.isLog()&&e?new R.PriceRange(i.priceToLogical(e.minValue()),i.priceToLogical(e.maxValue())):e}_titleInParts(e,t,s,r,n,a){var h;const u=this.name(t);s=s||{};const d=[l.t(u,{context:"study"},i(783477))];let c=[];if(!r){const i=this._getMTFResolutionInputTitle();null!==i&&i.length>0&&d.push(i);const r=this.metaInfo(),l=this._titleInputs(e,n,!0),u=r.inputs.filter((e=>l.hasOwnProperty(e.id))).map((e=>({meta:e,value:l[e.id]})));if(u.length>0){const i={};if(this.isChildStudy())for(let s=0;s<r.inputs.length;++s){const l=r.inputs[s];if(!T.StudyMetaInfo.isSourceInput(l))continue;const u=l.id,d=(0,o.ensureDefined)(this._properties.childs().inputs.child(u)).value();if(d.indexOf("$")>=0){const s=this.parentSourceForInput(d);if(s instanceof ai){const r=s.metaInfo(),o=s.title(e,t,{},!0,n,a);if(1===r.plots.length)i[d]=o;else{
const e=d.split("$")[1],t=null===(h=r.plots[parseInt(e)])||void 0===h?void 0:h.id,s=r.styles&&r.styles[t],n=s&&s.title||t;i[d]=o+": "+n}}}}c=u.map((({meta:e,value:t})=>{if("time"===e.type)return new Date(t).toISOString();let r=(0,W.isNumber)(t)?(0,jt.getNumericFormatter)().format(t):i&&i[t.toString()]||t.toString();return s&&s[r.toString()]&&(r=s[r.toString()]),r}))}}return e===$.TitleDisplayTarget.StatusLine&&this._showPineVersionInStatusLine.value()&&d.push((0,o.ensureDefined)(this._metaInfo.pine).version),[d.join(" · "),c]}_seriesDataRangeToSave(e){return this._model.timeScale().visibleExtendedDataRange(e,0)}_getSymbolForResolve(e){return this.getSymbolString(this._getSymbolForApi(e))}_getSymbolForApi(e){return e}_getSymbolObject(e){const t={symbol:e},i=this.currency();return null!==this._currencySourceSymbolInputProperty&&null!==this._currencySourceSymbolInfo&&this._getSymbolForApi(this._currencySourceSymbolInputProperty.value())===e&&(t["currency-id"]=i),t.session=this.sessionId(),t}_onSymbolResolved(e,t,i){{const e=(0,o.ensureNotNull)(this._model.alertsWatcher());e.syncSourceAlertLabels(this);const t=this.getAllChildren();for(const i of t)e.syncSourceAlertLabels(i)}this._onCurrencyMayChange()}_onSymbolResolvingStart(e,t){}_onSymbolError(){}_setStatus(e,t){var i;const s=this.isFailed();this._status=e,e.type===xt.StudyStatusType.Completed?this._wasCompletedBefore=!0:e.type!==xt.StudyStatusType.Error&&e.type!==xt.StudyStatusType.Undefined||(this._wasCompletedBefore=!1),t||(null===(i=this._statusView)||void 0===i||i.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())),s!==this.isFailed()&&this._updateAlertCreationAvailable()}_onPropertiesChanged(){this._restarting||(this._inputs?this._tryChangeInputs():this._chartApi&&this._chartApi.isConnected().value()&&this.restart()),this._metaInfo.isTVScript&&this._metaInfo.TVScriptMetaInfoExprs&&(this._restarting?this._deferredPinePatchProps=!0:this._pinePatchProps()),this._recreatePaneViews(),(0,Lt.emit)("study_properties_changed",this._id)}_lastNonEmptyPlotRow(e){var t;if(!(0,W.isInteger)(e))return Wt.logDebug("_lastNonEmptyPlotRow: incorrect plotIndex"),null;let i=null!==(t=this._lastNonEmptyPlotRowCache[e])&&void 0!==t?t:null;if(null!==i)return i;return i=this.data().findLast(((t,i)=>void 0!==i[e]),1e3),null===i?null:(this._lastNonEmptyPlotRowCache[e]=i,i)}_onCurrencyChanged(){"alwaysOff"!==(0,Nt.currencyUnitVisibilityProperty)().value()&&this._model.fullUpdate(),this.isStarted()&&this._tryChangeInputs(),this._currencyChanged.fire()}_apiInputs(){return this.inputs({keepOptionalSymbolsEmpty:!0})}async _tryChangeInputs(){const e=this.isStarted()&&this._chartApi.isConnected().value(),t=this._allInputsAreValid(),i=(0,o.ensureDefined)((0,W.clone)(this._inputs)),s=this._apiInputs(),r=JSON.stringify(s),n=r!==JSON.stringify(this._inputs);if(e&&t)try{if(await this._allSymbolsAreResolved(),r!==JSON.stringify(this._apiInputs()))return this._tryChangeInputs();if(this._isStopped())return void(n&&this.disablePriceRangeReady())
;n&&(await this._changeInputsImpl(s,(0,o.ensureDefined)((0,W.clone)(this._inputs))),(0,o.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(this))}catch(e){Wt.logError(`ERROR: ${this._debugId()} _tryChangeInputs: cannot modify study, ${e}`)}else if(e&&!t&&this.stop(!0),!e&&t&&this.start(!0),n){const e=this._calcSources(),t=si(this._metaInfo,s,i);this._updateParentSources(e,t,!0),this._inputs=s}this._tagsChanged.fire()}_onCurrencyMayChange(){if(null!==this._currencySourceSymbolInputProperty){const e=this.currency();this._updateCurrencySourceSymbolInfo(),e!==this.currency()&&this._onCurrencyChanged()}}_fillPrecalculatedAutoscaleInfo(e,t,i){const s=this._metaInfo,r=this.properties().childs(),n=new Set,o=this._metaInfo.filledAreas||[];for(let e=0;e<o.length;e++){const t=o[e];r.filledAreasStyle.childs()[t.id].childs().visible.value()&&(n.add(t.objAId),n.add(t.objBId))}return s.plots.filter((e=>!(0,B.isPlotWithTechnicalValues)(e))).filter((e=>this._metaInfo.isPlotForceOverlay(e.id)?i.targetPriceScale===this._model.mainSeries().priceScale():i.targetPriceScale===this.priceScale()&&!i.forceOverlayOnly)).filter((e=>n.has(e.id)||this.isPlotVisibleAt(e.id,1))).reduce(((i,s)=>this._applyPlotToPrecalculatedAutoscaleInfo(e,t,i,s)),{fields:[],useMainSeriesRange:!1,baseValueMinMax:null})}_firstSourceOrSeries(){var e;return null!==(e=this._sources[0])&&void 0!==e?e:this._series}_skipHistogramBaseOnAutoScale(){return!1}_tryCreateFormatter(e){const t=void 0===e?this.symbolSource().symbolInfo():e;return oi(this._metaInfo.format,this._priceScaleByProperties(),t,this.properties().childs().precision.value())}_tryCreateDefaultFormatter(e){return this._tryCreateFormatter(e)}_mergeData(e){return this._invalidateLastNonEmptyPlotRowCache(),this.data().merge(e)}_skippedTitleInputs(){return this._hideMatches.filter((e=>e.plotIds.every((e=>0===this._getPlotDisplayValue(e))))).map((e=>e.id))}_getPlotDisplayValue(e){var t,i,s,r,n,o,l;return null===(l=null===(o=null===(n=null===(r=null===(s=null===(i=null===(t=this.properties())||void 0===t?void 0:t.childs())||void 0===i?void 0:i.styles)||void 0===s?void 0:s.childs())||void 0===r?void 0:r[e])||void 0===n?void 0:n.childs())||void 0===o?void 0:o.display)||void 0===l?void 0:l.value()}_onStudyError(e){performance.clearMarks(`calculate_study_${this._studyId}`),this._handleStudyError(this._createStudyError(e)),this._enablePriceRangeReady()}_onStudyCompleted(e){var t;if(performance.getEntriesByName(`calculate_study_${this._studyId}`).length){try{const e=performance.measure(`measure_study_${this._studyId}`,`calculate_study_${this._studyId}`);this._calculationTime.setValue(e.duration)}catch(e){Wt.logError("Error during measuring study calculation time")}performance.clearMarks(`calculate_study_${this._studyId}`),performance.clearMeasures(`measure_study_${this._studyId}`)}this._studyModified&&(this.clearData(),this._studyModified=!1),this._sendTelemetryCounter(this._getTelemetryObjectName()+"_loaded"),this._setStatus({type:xt.StudyStatusType.Completed}),
null===(t=this._statusView)||void 0===t||t.update();const i=this._model.paneForSource(this);this._model.recalculatePane(i,(0,Mt.sourceChangeEvent)(this.id())),this._updateSources();const s=Rt.InvalidationMask.full();null!==this._model.appliedTimeFrame().value()&&s.lockVisibleTimeRangeOnResize(),this._model.invalidate(s)}_incrementTurnaround(){this._turnaround="st"+ ++this._turnaroundCounter}_checkTurnaround(e){return e===this._turnaround||e===this._model.mainSeries().seriesSource().turnaround()||e===this.turnaround(!0)}_updateMaxOffsetValue(){let e=-1/0;for(const t of this._metaInfo.plots)e=Math.max(this.offset(t.id),e);this._maxOffset.setValue(e)}_rightOffsetToUnixTime(e){if(this._series.bars().size()>=e){const t=(0,o.ensureNotNull)(this._series.bars().lastIndex())-e;return(0,o.ensureNotNull)(this._series.bars().valueAt(t))[0]}return null}_concatPriceAxisViews(){this._priceAxisViews=[...this._priceAxisViewsBase,...this._graphicsPriceAxisViews]}_onStudyLoading(){var e;this._setStatus({type:xt.StudyStatusType.Loading,startTime:Date.now()}),null===(e=this._statusView)||void 0===e||e.update(),this._model.updateSource(this)}_handleStudyError(e){var t,i,s;this.clearData(),this._setStatus(e);{const s=(0,xt.convertStudyStatusToString)(e),r=this._getTelemetryAdditionalData(),n=s.indexOf("Command info");r.reason=n>=0?s.slice(0,n).trim():s;if(!/study in error state|the data vendor doesn\'t provide volume data for this symbol.|error in series|unsupported resolution/gi.test(null!==(i=null===(t=r.reason)||void 0===t?void 0:t.toLowerCase())&&void 0!==i?i:"")){const e=this._getTelemetryObjectName();this._sendTelemetryCounter(e+"_error",r)}}null===(s=this._statusView)||void 0===s||s.update(),this._model.updateSource(this)}_createStudyError(e){var t,i;let s;return s=(0,W.isString)(e)?{error:this._getStudyErrorText(e),title:e.includes("study_not_auth")?"Access error":"Runtime error"}:{...e,title:null!==(t=e.title)&&void 0!==t?t:"Runtime error"},(0,xt.createStudyError)(s,null===(i=this.symbolSource().symbolInfo())||void 0===i?void 0:i.exchange)}_updateSources(){this._model.updateSource(this),this.hasBarColorer()&&this._model.updateSource(this._model.mainSeries())}_unsubscribeToSessionId(){this._isSubscribedToSessionId&&(this.sessionIdChanged().unsubscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!1)}_onSessionIdChanged(){this.restart(!0)}_recreatePriceStep(){var e;let t=null;const i=null!==(e=this._priceScaleByProperties())&&void 0!==e?e:this._priceScaleByMetaInfo();null!==i&&(t=1/i),this._priceStep!==t&&(this._priceStep=t,this._priceStepChanged.fire())}_recreatePlotsFormatters(e){var t,i;this._plotFormatters.clear();const s=this._metaInfo.format,r=this._priceScaleByProperties(),n=void 0===e?this.symbolSource().symbolInfo():e;for(const[e,i]of Object.entries(null!==(t=this._metaInfo.ohlcPlots)&&void 0!==t?t:{}))if(null==i?void 0:i.format){const t=oi(ni({...s,...null==i?void 0:i.format}),r,n,this.properties().childs().precision.value());t&&this._plotFormatters.set(e,t)}
for(const[e,t]of Object.entries(null!==(i=this._metaInfo.styles)&&void 0!==i?i:{}))if(null==t?void 0:t.format){const i=oi(ni({...s,...null==t?void 0:t.format}),r,n,this.properties().childs().precision.value());i&&this._plotFormatters.set(e,i)}for(const e of this._metaInfo.plots)if((0,B.isOhlcPlot)(e)){const t=this._plotFormatters.get(e.target);t&&this._plotFormatters.set(e.id,t)}}_joinTitlesParts(e){const t=e[1]?e[1].join(", "):"";return e[0]+(t.length>0?" ("+t+")":"")}_getMTFResolutionInputTitle(){const e=this.metaInfo();for(let t=0;t<e.inputs.length;t++){const i=e.inputs[t];if("resolution"===i.type&&i.isMTFResolution)return(0,o.ensureDefined)(this._properties.childs().inputs.child(i.id)).value()}return null}_onDataUpdate(e,t,i){this._studyModified&&(this.clearData(),this._studyModified=!1);const s=(0,x.unpackNonSeriesData)(t.d);return this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>s),(()=>s)).then(this._onDataUnpacked.bind(this,e,t.indexes,i)),this._ongoingDataUpdate}_allSymbolsAreResolved(){const e=this._inputSymbols(),t=[];let i=!1;for(const s of e){const e=this._getSymbolForResolve(s);if(""!==e)if(this._resolvedSymbols[e])i=!0;else{const i=this._resolveSymbol(e,s);t.push(i)}}if(0===t.length){const e=Promise.resolve();return i?e.then((()=>this._symbolsResolved.fire())):e}return Promise.all(t).catch((e=>(this._inputSymbols().includes(e)&&this.stop(!0),this._setStatus({type:xt.StudyStatusType.Error,errorDescription:{error:$t}}),this._model.updateSource(this),Promise.reject("Invalid symbol, "+e)))).then((()=>{this._symbolsResolved.fire(),this._recheckLineToolsActuality()}))}_resolveSymbol(e,t){if(""===e)return Promise.resolve();let i=this._pendingResolveSymbols.get(e);return void 0!==i||(i=new Promise(((i,s)=>{this._onSymbolResolvingStart(e,t),this._chartApi.resolveSymbol((0,G.makeNextSymbolId)(),e,(r=>{switch(this._pendingResolveSymbols.delete(e),r.method){case"symbol_resolved":{this._setStatus({type:xt.StudyStatusType.Undefined});const s=r.params[1];this._resolvedSymbols[e]=s,this._resolvedSymbolsByInput[t]=s,this._onSymbolResolved(e,t,s),this.invalidateTitleCache(!0),i();break}case"symbol_error":if(this._setStatus({type:xt.StudyStatusType.Error,errorDescription:{error:r.params[1]}}),this._onSymbolError(),r.params[1]===z.permissionDenied&&r.params[2]){if(r.params[2]!==z.SymbolErrorPermissionDeniedReason.Symbol)return void this._resolveSymbol(r.params[2],t).then(i);if(r.params[3])return void this._resolveSymbol(r.params[3],t).then(i)}this._sendTelemetryCounter("symbol_error",Object.assign(this._getTelemetryAdditionalData(),{symbol:e,reason:r.params[1]})),s(t)}}))})),this._pendingResolveSymbols.set(e,i)),i}_recheckLineToolsActuality(){const e=this._model.paneForSource(this);null!==e&&e.sourcesByGroup().lineSourcesForAllSymbols().forEach((e=>{e.ownerSource()===this&&e.calcIsActualSymbol()}))}_sendTelemetryCounter(e,t){void 0===t&&(t=this._getTelemetryAdditionalData());const i={count:1,additional:t};ae.telemetry.sendChartReport(e,i)}_getTelemetryAdditionalData(){let e=""
;return this._metaInfo.pine&&this._metaInfo.pine.version&&this._metaInfo.shortId.indexOf("USER")>=0&&(e="_v"+this._metaInfo.pine.version),{symbol:this.series().actualSymbol(),resolution:this.series().interval(),study:this._metaInfo.shortId+e}}_onSourceFormatterChanged(){null===this._formatter&&(null!==this._priceScale&&this._priceScale.updateFormatter(),this._formatterChanged.fire())}_onSourcePriceStepChanged(){null===this._priceStep&&this._priceStepChanged.fire()}_bandsFirstValue(e){const t=this._metaInfo;if(!t.bands)return null;for(let i=0;i<t.bands.length;i++){const t=(0,o.ensureDefined)(this._properties.childs().bands).childs()[i];if(t.childs().visible.value()){const i=t.childs().value.value();if(e&&0===i)continue;return i}}return null}_prepareInputs(e){(0,o.assert)(!!e,"options not set");const t=this.metaInfo(),i={},s=e.allowedInputTypes?new Set(e.allowedInputTypes):null;for(let r=0;r<t.inputs.length;r++){const n=t.inputs[r];if(null!==s&&!s.has(n.type))continue;if(n.isFake&&e.skipFakeInputs)continue;if(n.isMTFResolution&&e.noResolution)continue;if(void 0!==e.displayMask&&!((0,o.ensureDefined)(n.display)&e.displayMask))continue;if(e.skipHiddenInputs&&(!e.doNotSkipHiddenWithMigrate||!n.migrate)){let t=!1;switch(n.type){case"bool":t=e.skipBooleanInputs;break;case"color":t=e.skipColorInputs;break;case"time":t=e.skipTimeInputs;break;case"text_area":t=e.skipTextareaInputs;break;default:t=Boolean(n.isHidden)}if(t)continue}if(void 0!==n.groupId&&-1!==e.skippedGroups.indexOf(n.groupId))continue;if(-1!==e.skippedInputs.indexOf(n.id))continue;const l=this._prepareInput(n,e);"symbol"===n.type&&e.skipOptionalEmptySymbolInputs&&""===l||(i[n.id]=(0,W.clone)(l))}return i}_prepareInputValue(e,t){var i,s,r,n;const o=e.id,l=this._properties.childs();if(t.valuesAsIsFromProperties)return l.inputs.childs()[o].value();if("symbol"===e.type){const r=t&&t.symbolsForDisplay,n=l.inputs.childs()[o].value();let a=r?n:this._getSymbolForApi(n),h=null!==(s=null===(i=this._resolvedSymbols)||void 0===i?void 0:i[this._getSymbolForResolve(a)])&&void 0!==s?s:null;if(""===a&&e.optional){if(t&&t.keepOptionalSymbolsEmpty)return a;a=this._model.mainSeries().symbol(),h=this._model.mainSeries().symbolInfo()}if(r)if(h)if(Yt){switch(this._model.mainSeries().symbolTextSourceProxyProperty().value()){case"description":a=h.description;break;case"ticker-and-description":a=`${h.name}, ${h.description}`;break;case"ticker":a=h.name}}else a=(0,Ot.symbolTitle)(h,t.noExchanges);else Zt&&(a="");else h&&(a=h.ticker||h.full_name),!this.isPine()&&t&&t.symbolsForChartApi&&(a=this.getSymbolString(a));return a}if("bar_time"===e.type){let e=l.inputs.childs()[o].value();if(e<0){const t=this._rightOffsetToUnixTime(-e);e=t&&t>=0?t:e}return e}if(this._metaInfo.isTVScript||this._metaInfo.pine){if("text"===o)return null!==(n=null===(r=this._metaInfo.defaults.inputs)||void 0===r?void 0:r.text)&&void 0!==n?n:"";if("pineId"===o)return this._metaInfo.scriptIdPart;if("pineVersion"===o)return this._metaInfo.pine?this._metaInfo.pine.version:"-1";if("color"===e.type&&this._metaInfo.isRGB){
const e=l.inputs.childs()[o].value();return(0,C.colorToInteger)(e)}if("price"===e.type){const e=l.inputs.childs()[o].value();return t.priceInputsForDisplay?this.formatter().format(e):e}}return l.inputs.childs()[o].value()}_getAllOwnerSources(){return ri(this).reverse().slice(1)}_getStudyIdWithLatestVersion(){return T.StudyMetaInfo.getStudyIdWithLatestVersion(this.metaInfo())}_debugId(){const e=[];return this._studyId&&e.push(this._studyId),e.push(this._metaInfo.fullId),e.push(this._metaInfo.description),JSON.stringify({study:e})}_hasAvailableAlertPlots(){if(null===this._alertMetaInfo())return!1;const e=this.stateForAlert(),t=d.alertBandFactory.create(e).getPlots();return null!=t&&t.length>0}_hasAlertConditions(){const e=this._alertMetaInfo();if(null===e)return!1;if(e.plots.some(B.isAlertConditionPlot))return!0;const t=this.stateForAlert();return Boolean(t.alerts&&t.alerts.conditions)}_hasAlertFunction(){const e=this._alertMetaInfo();return Boolean(null!==e&&e.hasAlertFunction)}async _updateParentSources(e,t,i){if(this._sources.forEach((e=>e.unsetChild(this))),i&&await Promise.all(e.map((e=>e.isStarted()?Promise.resolve():e.start(!1,!0)))),e.forEach((e=>e.setChild(this))),this._setSources(e),this._recreatePriceFormattingDependencies(),0!==t&&this._sources.length<=1){const e=this._firstSourceOrSeries(),t=this._priceScale,i=(0,o.ensureNotNull)(e.priceScale());if(t!==i){const t=this._model.paneForSource(this),s=(0,o.ensureNotNull)(this._model.paneForSource(e));t===s&&s.move(this,i,!0)}}}_calcSources(){const e=this._properties.childs().inputs.state();return T.StudyMetaInfo.getSourceIdsByInputs(this._metaInfo.inputs,e).map((e=>{if("high"===e||"open"===e||"low"===e||"close"===e||"hl2"===e||"ohl3"===e||"ohlc4"===e)return null;{const t=this._model.allStudies().find((t=>t.canHaveChildren()&&t.id()===e));return null!=t?t:null}})).filter(W.notNull)}_isStopped(){return!this.isStarted()}_onDataUnpacked(e,t,i,s){if(this._isDestroyed)return;"nochange"!==t&&this._processPlotOffsets(s),this._transformData(e);const r=this._mergeData(e);null!==s&&(s.indexes_replace?((0,o.assert)("nochange"!==t),this._graphics.replaceIndexesTo(t)):("nochange"!==t&&this._graphics.replaceIndexesTo(t),void 0!==s.graphicsCmds&&this._graphics.processCommands(s.graphicsCmds))),this._onDataUpdated(e,s,t,r&&r.index),this.priceRangeReady()||this._enablePriceRangeReady(),this._dataUpdated.fire(i,!1,r)}_processPlotOffsets(e){if(e&&e.indexes_replace)return;const t=this._plotOffsets;this._plotOffsets=e&&e.offsets||{},(0,s.default)(t,this._plotOffsets)||this.updateAllViews((0,Mt.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),this._updateMaxOffsetValue()}_applyPlotToPrecalculatedAutoscaleInfo(e,t,i,s){var r,n,l;const a=s.id,h=this._properties.childs().styles.childs()[a],u=(0,B.isShapesPlot)(s)||(0,B.isCharsPlot)(s);i.useMainSeriesRange=i.useMainSeriesRange||(0,B.isArrowsPlot)(s);let d=(0,B.isLinePlot)(s)||(0,B.isOhlcPlot)(s);if(u){const e=(0,
o.ensureDefined)(h).childs().location.value(),t=[N.MarkLocation.Absolute,N.MarkLocation.Top,N.MarkLocation.Bottom].indexOf(e)<0;i.useMainSeriesRange=i.useMainSeriesRange||u&&t,d=d||e===N.MarkLocation.Absolute}if(!d)return i;const c={name:a,offset:this.offset(a)},p=h.childs().plottype.value();if(!this._skipHistogramBaseOnAutoScale()&&[B.LineStudyPlotStyle.Histogram,B.LineStudyPlotStyle.Columns,B.LineStudyPlotStyle.Area].indexOf(p)>=0){const s=null===(l=null===(n=null!==(r=this._metaInfo.styles)&&void 0!==r?r:{})||void 0===n?void 0:n[a])||void 0===l?void 0:l.histogramBase;if(void 0===s)return i;const o=this.data().minMaxOnRangeCached(e,t,[c]);return(0,W.isNumber)(s)&&null!==o&&(i.baseValueMinMax=(0,M.mergeMinMax)(i.baseValueMinMax,{min:s,max:s}),i.baseValueMinMax=(0,M.mergeMinMax)(i.baseValueMinMax,o)),i}return i.fields.push(c),i}async _onSourceInputChanged(){if(!this.isStarted()){const e=this._calcSources();{const t=1===e.length&&e[0]!==this._sources[0]?1:0;this._updateParentSources(e,t,!1)}}}_buildInputs(e){(0,o.assert)(!!e,"options not set");let t={};try{t=this._prepareInputs(e)}catch(e){Wt.logWarn("Failed to prepare study inputs: "+e)}if(e.asObject){const e={};return Object.keys(t).forEach((i=>{null!=t[i]&&(e[i]=t[i])})),e}{const e=[];return Object.keys(t).forEach((i=>{null!=t[i]&&e.push(t[i])})),e}}_prepareInput(e,t){const i=this._prepareInputValue(e,t);return!e.isFake||t.fakeInputsForDisplay||t.onlyAtomValues?i:{v:i,f:!0,t:e.type}}_plotsForAlert(){return(0,v.plotsForAlert)(this.metaInfo(),this.offset.bind(this))}_calcIsActualInterval(){const e=this._isActualInterval;this._isActualInterval=(0,At.isActualInterval)(this._series.intervalObj(),this._properties.childs().intervalsVisibilities),e!==this._isActualInterval&&(this._onIsActualIntervalChange.fire(),this._visibleChanged(),this.processHibernate())}_visibleChanged(){this._series.invalidateBarColorerCache()}_getNonPriceParent(){const e=this._sources;for(const t of e)if(t instanceof ai){const e=t.metaInfo();return e.is_price_study&&"Compare@tv-basicstudies"!==e.id?t._getNonPriceParent():t}return null}_updateInputValue(e,t){const i=this._properties.childs().inputs.childs();if(i[t.id])if("price"===t.type)i[t.id].setValue(e.price);else if("time"===t.type){const s=this._model.timeScale().indexToTimePoint(e.index);null!==s&&i[t.id].setValue(1e3*s)}}_initializeStudyInputsPaneViews(){const e=(0,_.editableStudyInputs)(this._metaInfo.inputs);if(0===e.length)return;const t={convertPriceToCoordinate:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const i=this.firstValue();if(null!==i)return t.priceToCoordinate(e,i)}return null},formatPrice:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const i=this.firstValue();if(null!==i)return t.formatPrice(e,i)}return""},getInputValue:e=>{var t,i;return null!==(i=null===(t=this._properties.childs().inputs.child(e))||void 0===t?void 0:t.value())&&void 0!==i?i:null},isSelected:()=>this._model.selection().isSelected(this),isHovered:()=>this===this._model.hoveredSource()}
;Promise.all([i.e(62183).then(i.bind(i,566195)),i.e(62183).then(i.bind(i,384892)),i.e(62183).then(i.bind(i,373109)),i.e(62183).then(i.bind(i,745642))]).then((i=>{const[s,r,n,o]=i;this._inputsAnchorsPaneView=new s.StudyInputsAnchorsPaneView(e,this._model,t);const l=e.filter((e=>!Array.isArray(e)));this._inputsLinesPaneView=new r.StudyInputsLinesPaneView(l,this._model,t);let a=!1;e.forEach((e=>{if(Array.isArray(e)){const i="time"===e[0].type?e[0]:e[1],s="price"===e[0].type?e[0]:e[1];this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(i,this._model,t.getInputValue)),this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(s,t)),a=!0}else"time"===e.type?this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(e,this._model,t.getInputValue)):(this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(e,t)),a=!0)})),a&&this.formatterChanged().subscribe(this,this.invalidateTitleCache)}))}_updateCurrencySourceSymbolInfo(){}_initializeCurrencySource(){var e,t;const i=this.metaInfo(),s="symbolInputSymbolSource"===(null===(e=i.symbolSource)||void 0===e?void 0:e.type)&&(null===(t=i.symbolSource)||void 0===t?void 0:t.inputId),r=i.inputs.find((e=>e.id===s)),n="symbol"===(null==r?void 0:r.type);if("string"==typeof s&&n&&i.is_price_study){const e=this._properties.childs().inputs.childs()[s];void 0!==e&&(e.subscribe(this,this._onCurrencyMayChange),this._currencySourceSymbolInputProperty=e)}}_recreatePaneViews(){this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this._createViews(),this.recalculate(),this.updateAllViews((0,Mt.sourceChangeEvent)(this.id()))}_pinePatchProps(){this._deferredPinePatchProps=!1;const e=this._prepareInputs(qt);if(!this._areStudyInputsModified(e))return;this._oldStudyInputs=e;const t=(0,g.patchPropertiesAsync)(this._properties,this._metaInfo,e,this._previousPatchMap),i=this._allSymbolsAreResolved(),s=this._propertiesPatched=new Promise((e=>{const r=()=>{s===this._propertiesPatched?e():this._propertiesPatched.then(e)};Promise.all([t,i]).then((()=>{r(),this._isDestroyed||(this._createViews(),this.recalculate(),this.updateAllViews((0,Mt.sourceChangeEvent)(this.id())),this.invalidateTitleCache())})).catch((e=>{r(),Wt.logError(`ERROR: ${this._debugId()} pine inputs patching failed, reason: ${e}`)}))}))}_areStudyInputsModified(e){if(0===Object.keys(e).length)return!1;if(void 0===this._oldStudyInputs)return!0;const t=Object.keys(this._oldStudyInputs);(0,o.assert)(t.length===Object.keys(e).length,"keys quantity should be equal");for(const i of t)if((0,o.assert)(e.hasOwnProperty(i),`key '${i}' should exist in study inputs`),(0,o.ensureDefined)(this._oldStudyInputs)[i]!==e[i])return!0;return!1}_onVisibleTimeRangeInputsChanged(e){null!==e?this._updateVisibleTimeRangeInputs(e):this.isStarted()&&this._chartApi.isConnected().value()&&this.stop(!0)}_updateVisibleTimeRangeInputs(e,t=!0){const i={first_visible_bar_time:e.firstVisibleBarTime,last_visible_bar_time:e.lastVisibleBarTime,subscribeRealtime:e.subscribeRealtime},s=this.metaInfo().inputs,r=[]
;for(const e of s)i.hasOwnProperty(e.id)&&r.push(e.id);const n=this.properties().childs().inputs;for(const e of r)n.childs()[e].setValueSilently(i[e]);t&&r.length>0&&n.listeners().fire(n,"")}_getStudyErrorText(e){var t;switch(null===(t=e.match(/^study_not_auth:(.*)?@.*/))||void 0===t?void 0:t[1]){case"Script":case"StrategyScript":return"This script is invite-only. To request access, please contact its author.";case"VbPSessions":case"VbPPeriodic":case"VbPVisible":return"Volume Profile indicator available only on our upgraded plans."}return e.split(":",2)[0]}_priceScaleByProperties(){if("default"===this.properties().childs().precision.value())return null;const e=parseInt(this.properties().childs().precision.value());return isFinite(e)?Math.pow(10,e):null}_priceScaleByMetaInfo(){const e=this.metaInfo().format,t="inherit"!==e.type?e.precision:void 0,i=(0,W.isNumber)(t)?Math.pow(10,t):void 0;if("price"===e.type||"percent"===e.type)return i||100;if("volume"===e.type){if(void 0===e.precision){const e=this.series().symbolInfo();if(null!==e&&(0,W.isNumber)(e.volume_precision))return Math.pow(10,e.volume_precision)}return 1}return"inherit"===e.type||Wt.logWarn("Unsupported format type: "+e.type),null}_inputSymbols(){return this.metaInfo().inputs.filter((e=>"symbol"===e.type)).map((e=>(0,o.ensureDefined)(this._properties.childs().inputs.child(e.id)).value()))}_studySpec(e){return{id:this._metaInfo.id,child:null!=e?e:this.isChildStudy(),fundamental:(0,he.isFundamentalStudyMetaInfo)(this._metaInfo)}}_onFormatterPropsChanged(){this._recreatePriceFormattingDependencies()}_setSources(e){this.invalidateTitleCache(),this._sources=e,this._onParentSourcesChanges.fire()}}},359658:(e,t,i)=>{i.d(t,{plotShapesData:()=>r});var s=i(444372);const r={shape_arrow_down:{guiName:s.t(null,void 0,i(734247)),id:"shape_arrow_down",paneRendererClass:"PaneRendererArrowDown",pineName:"shape.arrowdown",icon:"arrow_down"},shape_arrow_up:{guiName:s.t(null,void 0,i(777231)),id:"shape_arrow_up",paneRendererClass:"PaneRendererArrowUp",pineName:"shape.arrowup",icon:"arrow_up"},shape_circle:{guiName:s.t(null,void 0,i(191944)),id:"shape_circle",paneRendererClass:"PaneRendererCircleShape",pineName:"shape.circle",icon:"circle"},shape_cross:{guiName:s.t(null,void 0,i(506969)),id:"shape_cross",paneRendererClass:"PaneRendererCrossShape",pineName:"shape.cross",icon:"cross"},shape_diamond:{guiName:s.t(null,void 0,i(415179)),id:"shape_diamond",paneRendererClass:"PaneRendererDiamond",pineName:"shape.diamond",icon:"diamond"},shape_flag:{guiName:s.t(null,void 0,i(333885)),id:"shape_flag",paneRendererClass:"PaneRendererFlagShape",pineName:"shape.flag",icon:"flag"},shape_label_down:{guiName:s.t(null,void 0,i(785924)),id:"shape_label_down",paneRendererClass:"PaneRendererLabelDown",pineName:"shape.labeldown",icon:"label_down"},shape_label_up:{guiName:s.t(null,void 0,i(649857)),id:"shape_label_up",paneRendererClass:"PaneRendererLabelUp",pineName:"shape.labelup",icon:"label_up"},shape_square:{guiName:s.t(null,void 0,i(66205)),id:"shape_square",
paneRendererClass:"PaneRendererSquare",pineName:"shape.square",icon:"square"},shape_triangle_down:{guiName:s.t(null,void 0,i(676152)),id:"shape_triangle_down",paneRendererClass:"PaneRendererTriangleApexDown",pineName:"shape.triangledown",icon:"triangle_down"},shape_triangle_up:{guiName:s.t(null,void 0,i(21236)),id:"shape_triangle_up",paneRendererClass:"PaneRendererTriangleApexUp",pineName:"shape.triangleup",icon:"triangle_up"},shape_xcross:{guiName:s.t(null,void 0,i(211316)),id:"shape_xcross",paneRendererClass:"PaneRendererXCross",pineName:"shape.xcross",icon:"x_cross"}}},682170:(e,t,i)=>{var s=i(474150).isStudyStateForAlertType,r=i(748947),n=i(745397).generateTitleForGui,o=i(338619).getLogger("Alerts.Band"),l=i(975179),a=i(881025),h=i(889301).lineToolsLocalizedNames;TradingView="object"==typeof i.g?i.g.TradingView:TradingView||{};var u={create:function(e){var t,i=e||{},r=i.type;if("MainSeries"===r)t=c;else if(s(r,!0))t=p;else if("Value"===r)t=_;else{if(!/^LineTool.*/i.test(r))return o.logError("Unknown alert band type "+r),null;t=f}return new t(i)}};function d(e){this._band=e||{}}function c(){d.apply(this,arguments)}function p(){d.apply(this,arguments)}function _(){d.apply(this,arguments)}function f(){d.apply(this,arguments)}d.prototype.id=function(){return this._band.id},d.prototype.type=function(){return this._band.type},d.prototype.title=function(){return this._band.title},d.prototype.isTVScript=function(){return this._band.isTVScript},d.prototype.scriptVersion=function(){return this._band.scriptVersion},d.prototype.hasPlots=function(){return this._band.plots&&this._band.plots.length},d.prototype.getActualSymbol=function(){return this._band.actualSymbol},d.prototype.getSymbolString=function(){return this._band.symbolString},d.prototype.getPlotTitle=function(e){return e.title?e.title:r.isOhlcOpenPlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(16610)):r.isOhlcHighPlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(778254)):r.isOhlcLowPlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(165318)):r.isOhlcClosePlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(862578)):"vol"===e.id?i.i18next(null,void 0,i(937644)):"vol_ma"===e.id?i.i18next(null,void 0,i(609373)):"open"===e.id?i.i18next(null,void 0,i(16610)):"high"===e.id?i.i18next(null,void 0,i(778254)):"low"===e.id?i.i18next(null,void 0,i(165318)):"close"===e.id?i.i18next(null,void 0,i(862578)):e.id},d.prototype.getPlots=function(e){var t=e||{};if(!this._band.plots||!this._band.plots.length)return this._band.plots;if("inputSelect"===t.format){var i=-1;return this._band.plots.map((function(e){return{value:++i,title:this.getPlotTitle(e)}}),this)}return this._band.plots},d.prototype.hasUsualPlots=function(){var e=this._band.plots;return!e||e.filter(r.isAlertConditionPlot).length<e.length},d.prototype.getInputs=function(){return{}},inherit(c,d),c.prototype.title=function(e){var t=i(268552),s=e||{},r=!!s.withInterval,o=this._band.actualSymbol;return t&&(o=t.shortName(o)),n({symbol:o,interval:r?this._band.interval:void 0,style:this._band.style,inputs:this._band.styleInputs||{},
boxSize:this._band.boxSize,reversalAmount:this._band.reversalAmount,sessionDescription:s.sessionDescription})},c.prototype.getInterval=function(){return this._band.interval},c.prototype.getStyle=function(){return this._band.style},c.prototype.getStyleInputs=function(){return this._band.styleInputs},c.prototype.isRangeBasedStyle=function(){return l.isRangeBasedStyle(this._band.style)},c.prototype.isSpread=function(){return this._band.isSpread},c.prototype.sessionId=function(){return this._band.sessionId},c.prototype.sessionDescription=function(){return this._band.sessionDescription},c.prototype.getDividendsAdjustment=function(){return this._band.dividendsAdjustment},c.prototype.getBackAdjustment=function(){return this._band.backAdjustment},c.prototype.getSettlementAsClose=function(){return this._band.settlementAsClose},inherit(p,d),p.prototype.title=function(e){var t,s,r,n=e||{},o=n.withPlotTitle,l=this._band;return n.short&&l.shortTitle?t=l.shortTitle:l.title?t=l.title:(t=l.shortDescription||"Study",s=[],Object.keys(l.inputs).forEach((function(e){var t=l.inputs[e]&&l.inputs[e].id;t&&!l.inputs[e].isHidden&&void 0!==l.inputs[t]&&s.push(l.inputs[t])})),s.length&&(t+=" ("+s.join(", ")+")")),o&&(r=this.selectedPlot())&&(t+=" "+(r.title||i.i18next(null,void 0,i(370589)))),a.isRtl()&&(t=a.forceLTRStr(t)),t},p.prototype.selectedPlot=function(){var e=this._band;return void 0===e.plotIndex?null:this.getPlots().filter((function(t){return t.value===e.plotIndex}))[0]||null},p.prototype.getInputs=function(){return this._band.inputs||{}},p.prototype.isTVLibrary=function(){return this._band.isTVLibrary||!1},p.prototype.scriptIdPart=function(){return this._band.scriptIdPart},inherit(_,d),_.prototype.title=function(e){var t=this._band.value||0;return e.formatter?e.formatter.format(parseFloat(t)):parseFloat(t).toString()},inherit(f,d),f.prototype.title=function(){return h[this._band.type]||this.title()},e.exports.alertBandFactory=u},545437:(e,t,i)=>{i.d(t,{showTooManyStudiesNotice:()=>n});var s=i(444372),r=i(779923);function n(e){(0,r.showWarning)({title:s.t(null,void 0,i(966719)),text:s.t(null,{replace:{number:`${e}`}},i(586146))})}}}]);